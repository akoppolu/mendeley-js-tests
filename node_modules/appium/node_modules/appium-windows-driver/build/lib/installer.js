'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _appiumSupport = require('appium-support');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _teen_process = require('teen_process');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var WAD_VER = "0.9-beta";
var WAD_DL = 'https://github.com/Microsoft/WinAppDriver/releases/download/v' + WAD_VER + '/WindowsApplicationDriver.msi';
var WAD_DL_MD5 = "17b9b4728782f5a58c72f6d3a4b2494f";

var WAD_INSTALL_PATH = process.env["ProgramFiles(x86)"] || process.env.ProgramFiles || "C:\\Program Files";
exports.WAD_INSTALL_PATH = WAD_INSTALL_PATH = _path2['default'].resolve(WAD_INSTALL_PATH, "Windows Application Driver", "WinAppDriver.exe");
var WAD_EXE_MD5 = "3136b9c09ea287e897d8cc4278c9b601";
var WAD_GUID = "DDCD58BF-37CF-4758-A15E-A60E7CF20E41";

function downloadWAD() {
  var tempFile, body, downloadedMd5;
  return _regeneratorRuntime.async(function downloadWAD$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info('Opening temp file to write WinAppDriver to...');
        tempFile = _path2['default'].resolve(process.env.TEMP, "WinAppDriver.msi");

        _logger2['default'].info('Will write to ' + tempFile);

        // actually download the msi file
        _logger2['default'].info('Downloading ' + WAD_DL + '...');
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: WAD_DL, encoding: 'binary' }));

      case 6:
        body = context$1$0.sent;

        _logger2['default'].info('Writing binary content to ' + tempFile + '...');
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(tempFile, body, { encoding: 'binary' }));

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.md5(tempFile));

      case 12:
        downloadedMd5 = context$1$0.sent;

        if (!(downloadedMd5 !== WAD_DL_MD5)) {
          context$1$0.next = 15;
          break;
        }

        throw new Error('Checksum validation error: expected ' + WAD_DL_MD5 + ' but ' + ('got ' + downloadedMd5));

      case 15:
        return context$1$0.abrupt('return', tempFile);

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function installWAD(msiPath) {
  return _regeneratorRuntime.async(function installWAD$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info("Running MSI installer...");
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('msiexec', ['/i', msiPath, '/qn']));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function verifyWAD() {
  return _regeneratorRuntime.async(function verifyWAD$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info("Verifying WinAppDriver is installed with correct checksum");
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(WAD_INSTALL_PATH));

      case 3:
        context$1$0.t0 = context$1$0.sent;

        if (!context$1$0.t0) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.md5(WAD_INSTALL_PATH));

      case 7:
        context$1$0.t1 = context$1$0.sent;
        context$1$0.t2 = WAD_EXE_MD5;
        context$1$0.t0 = context$1$0.t1 === context$1$0.t2;

      case 10:
        return context$1$0.abrupt('return', context$1$0.t0);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function isAdmin() {
  var testFilePath;
  return _regeneratorRuntime.async(function isAdmin$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        testFilePath = _path2['default'].resolve("/", "Windows", "System32", "wad-test.txt");
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(testFilePath));

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(testFilePath, "foo"));

      case 6:
        return context$1$0.abrupt('return', true);

      case 9:
        context$1$0.prev = 9;
        context$1$0.t0 = context$1$0['catch'](1);
        return context$1$0.abrupt('return', false);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 9]]);
}

function setupWAD() {
  var msiPath;
  return _regeneratorRuntime.async(function setupWAD$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (_appiumSupport.system.isWindows()) {
          context$1$0.next = 2;
          break;
        }

        throw new Error("Can only download WinAppDriver on Windows!");

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(verifyWAD());

      case 4:
        if (!context$1$0.sent) {
          context$1$0.next = 7;
          break;
        }

        _logger2['default'].info("WinAppDriver.exe already exists at correct checksum, " + "not re-downloading");
        return context$1$0.abrupt('return');

      case 7:

        _logger2['default'].info("WinAppDriver.exe doesn't exist at the correct version, setting up");

        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(isAdmin());

      case 10:
        if (context$1$0.sent) {
          context$1$0.next = 12;
          break;
        }

        throw new Error("You are not an administrator; please reinstall as admin");

      case 12:
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(downloadWAD());

      case 14:
        msiPath = context$1$0.sent;
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(installWAD(msiPath));

      case 17:
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(verifyWAD());

      case 19:
        if (context$1$0.sent) {
          context$1$0.next = 21;
          break;
        }

        throw new Error("Installed version of WinAppDriver failed checksum check");

      case 21:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.downloadWAD = downloadWAD;
exports.setupWAD = setupWAD;
exports.verifyWAD = verifyWAD;
exports.installWAD = installWAD;
exports.WAD_INSTALL_PATH = WAD_INSTALL_PATH;
exports.WAD_GUID = WAD_GUID;
exports['default'] = setupWAD;

// validate checksum
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs4QkFBb0IsaUJBQWlCOzs7OzZCQUNWLGdCQUFnQjs7b0JBQzFCLE1BQU07Ozs7NEJBQ0YsY0FBYzs7c0JBQ25CLFVBQVU7Ozs7QUFFMUIsSUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDO0FBQzNCLElBQU0sTUFBTSxxRUFBbUUsT0FBTyxrQ0FBK0IsQ0FBQztBQUN0SCxJQUFNLFVBQVUsR0FBRyxrQ0FBa0MsQ0FBQzs7QUFFdEQsSUFBSSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLElBQUksbUJBQW1CLENBQUM7QUFDM0csUUF3RXVELGdCQUFnQixHQXhFdkUsZ0JBQWdCLEdBQUcsa0JBQUssT0FBTyxDQUFDLGdCQUFnQixFQUFFLDRCQUE0QixFQUM5QyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ3BELElBQU0sV0FBVyxHQUFHLGtDQUFrQyxDQUFDO0FBQ3ZELElBQU0sUUFBUSxHQUFHLHNDQUFzQyxDQUFDOztBQUV4RCxTQUFlLFdBQVc7TUFFcEIsUUFBUSxFQUtSLElBQUksRUFLSixhQUFhOzs7O0FBWGpCLDRCQUFJLElBQUksaURBQWlELENBQUM7QUFDdEQsZ0JBQVEsR0FBRyxrQkFBSyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsa0JBQWtCLENBQUM7O0FBQ2pFLDRCQUFJLElBQUksb0JBQWtCLFFBQVEsQ0FBRyxDQUFDOzs7QUFHdEMsNEJBQUksSUFBSSxrQkFBZ0IsTUFBTSxTQUFNLENBQUM7O3lDQUNwQiw0QkFBUSxHQUFHLENBQUMsRUFBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUMsQ0FBQzs7O0FBQTNELFlBQUk7O0FBQ1IsNEJBQUksSUFBSSxnQ0FBOEIsUUFBUSxTQUFNLENBQUM7O3lDQUMvQyxrQkFBRyxTQUFTLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxFQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUMsQ0FBQzs7Ozt5Q0FHOUIsa0JBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQzs7O0FBQXRDLHFCQUFhOztjQUNiLGFBQWEsS0FBSyxVQUFVLENBQUE7Ozs7O2NBQ3hCLElBQUksS0FBSyxDQUFDLHlDQUF1QyxVQUFVLHVCQUMxQyxhQUFhLENBQUUsQ0FBQzs7OzRDQUdsQyxRQUFROzs7Ozs7O0NBQ2hCOztBQUVELFNBQWUsVUFBVSxDQUFFLE9BQU87Ozs7QUFDaEMsNEJBQUksSUFBSSxDQUFDLDBCQUEwQixDQUFDLENBQUM7O3lDQUMvQix3QkFBSyxTQUFTLEVBQUUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDOzs7Ozs7O0NBQzlDOztBQUVELFNBQWUsU0FBUzs7OztBQUN0Qiw0QkFBSSxJQUFJLENBQUMsMkRBQTJELENBQUMsQ0FBQzs7eUNBQ3pELGtCQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQzs7Ozs7Ozs7Ozs7eUNBQzNCLGtCQUFHLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQzs7Ozt5QkFBSyxXQUFXOzs7Ozs7Ozs7OztDQUN0RDs7QUFFRCxTQUFlLE9BQU87TUFDaEIsWUFBWTs7OztBQUFaLG9CQUFZLEdBQUcsa0JBQUssT0FBTyxDQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLGNBQWMsQ0FBQzs7O3lDQUVuRSxrQkFBRyxNQUFNLENBQUMsWUFBWSxDQUFDOzs7O3lDQUN2QixrQkFBRyxTQUFTLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQzs7OzRDQUNoQyxJQUFJOzs7Ozs0Q0FFSixLQUFLOzs7Ozs7O0NBRWY7O0FBRUQsU0FBZSxRQUFRO01BaUJmLE9BQU87Ozs7WUFoQlIsc0JBQU8sU0FBUyxFQUFFOzs7OztjQUNmLElBQUksS0FBSyxDQUFDLDRDQUE0QyxDQUFDOzs7O3lDQUdyRCxTQUFTLEVBQUU7Ozs7Ozs7O0FBQ25CLDRCQUFJLElBQUksQ0FBQyx1REFBdUQsR0FDcEQsb0JBQW9CLENBQUMsQ0FBQzs7Ozs7QUFJcEMsNEJBQUksSUFBSSxDQUFDLG1FQUFtRSxDQUFDLENBQUM7Ozt5Q0FFbkUsT0FBTyxFQUFFOzs7Ozs7OztjQUNaLElBQUksS0FBSyxDQUFDLHlEQUF5RCxDQUFDOzs7O3lDQUd0RCxXQUFXLEVBQUU7OztBQUE3QixlQUFPOzt5Q0FDUCxVQUFVLENBQUMsT0FBTyxDQUFDOzs7O3lDQUNkLFNBQVMsRUFBRTs7Ozs7Ozs7Y0FDZCxJQUFJLEtBQUssQ0FBQyx5REFBeUQsQ0FBQzs7Ozs7OztDQUU3RTs7UUFFUSxXQUFXLEdBQVgsV0FBVztRQUFFLFFBQVEsR0FBUixRQUFRO1FBQUUsU0FBUyxHQUFULFNBQVM7UUFBRSxVQUFVLEdBQVYsVUFBVTtRQUFFLGdCQUFnQixHQUFoQixnQkFBZ0I7UUFDOUQsUUFBUSxHQUFSLFFBQVE7cUJBQ0YsUUFBUSIsImZpbGUiOiJsaWIvaW5zdGFsbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCB7IHN5c3RlbSwgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5cbmNvbnN0IFdBRF9WRVIgPSBcIjAuOS1iZXRhXCI7XG5jb25zdCBXQURfREwgPSBgaHR0cHM6Ly9naXRodWIuY29tL01pY3Jvc29mdC9XaW5BcHBEcml2ZXIvcmVsZWFzZXMvZG93bmxvYWQvdiR7V0FEX1ZFUn0vV2luZG93c0FwcGxpY2F0aW9uRHJpdmVyLm1zaWA7XG5jb25zdCBXQURfRExfTUQ1ID0gXCIxN2I5YjQ3Mjg3ODJmNWE1OGM3MmY2ZDNhNGIyNDk0ZlwiO1xuXG5sZXQgV0FEX0lOU1RBTExfUEFUSCA9IHByb2Nlc3MuZW52W1wiUHJvZ3JhbUZpbGVzKHg4NilcIl0gfHwgcHJvY2Vzcy5lbnYuUHJvZ3JhbUZpbGVzIHx8IFwiQzpcXFxcUHJvZ3JhbSBGaWxlc1wiO1xuV0FEX0lOU1RBTExfUEFUSCA9IHBhdGgucmVzb2x2ZShXQURfSU5TVEFMTF9QQVRILCBcIldpbmRvd3MgQXBwbGljYXRpb24gRHJpdmVyXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiV2luQXBwRHJpdmVyLmV4ZVwiKTtcbmNvbnN0IFdBRF9FWEVfTUQ1ID0gXCIzMTM2YjljMDllYTI4N2U4OTdkOGNjNDI3OGM5YjYwMVwiO1xuY29uc3QgV0FEX0dVSUQgPSBcIkREQ0Q1OEJGLTM3Q0YtNDc1OC1BMTVFLUE2MEU3Q0YyMEU0MVwiO1xuXG5hc3luYyBmdW5jdGlvbiBkb3dubG9hZFdBRCAoKSB7XG4gIGxvZy5pbmZvKGBPcGVuaW5nIHRlbXAgZmlsZSB0byB3cml0ZSBXaW5BcHBEcml2ZXIgdG8uLi5gKTtcbiAgbGV0IHRlbXBGaWxlID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuZW52LlRFTVAsIFwiV2luQXBwRHJpdmVyLm1zaVwiKTtcbiAgbG9nLmluZm8oYFdpbGwgd3JpdGUgdG8gJHt0ZW1wRmlsZX1gKTtcblxuICAvLyBhY3R1YWxseSBkb3dubG9hZCB0aGUgbXNpIGZpbGVcbiAgbG9nLmluZm8oYERvd25sb2FkaW5nICR7V0FEX0RMfS4uLmApO1xuICBsZXQgYm9keSA9IGF3YWl0IHJlcXVlc3QuZ2V0KHt1cmw6IFdBRF9ETCwgZW5jb2Rpbmc6ICdiaW5hcnknfSk7XG4gIGxvZy5pbmZvKGBXcml0aW5nIGJpbmFyeSBjb250ZW50IHRvICR7dGVtcEZpbGV9Li4uYCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZSh0ZW1wRmlsZSwgYm9keSwge2VuY29kaW5nOiAnYmluYXJ5J30pO1xuXG4gIC8vIHZhbGlkYXRlIGNoZWNrc3VtXG4gIGxldCBkb3dubG9hZGVkTWQ1ID0gYXdhaXQgZnMubWQ1KHRlbXBGaWxlKTtcbiAgaWYgKGRvd25sb2FkZWRNZDUgIT09IFdBRF9ETF9NRDUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENoZWNrc3VtIHZhbGlkYXRpb24gZXJyb3I6IGV4cGVjdGVkICR7V0FEX0RMX01ENX0gYnV0IGAgK1xuICAgICAgICAgICAgICAgICAgICBgZ290ICR7ZG93bmxvYWRlZE1kNX1gKTtcbiAgfVxuXG4gIHJldHVybiB0ZW1wRmlsZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbFdBRCAobXNpUGF0aCkge1xuICBsb2cuaW5mbyhcIlJ1bm5pbmcgTVNJIGluc3RhbGxlci4uLlwiKTtcbiAgYXdhaXQgZXhlYygnbXNpZXhlYycsIFsnL2knLCBtc2lQYXRoLCAnL3FuJ10pO1xufVxuXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlXQUQgKCkge1xuICBsb2cuaW5mbyhcIlZlcmlmeWluZyBXaW5BcHBEcml2ZXIgaXMgaW5zdGFsbGVkIHdpdGggY29ycmVjdCBjaGVja3N1bVwiKTtcbiAgcmV0dXJuIGF3YWl0IGZzLmV4aXN0cyhXQURfSU5TVEFMTF9QQVRIKSAmJlxuICAgICAgICAgYXdhaXQgZnMubWQ1KFdBRF9JTlNUQUxMX1BBVEgpID09PSBXQURfRVhFX01ENTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaXNBZG1pbiAoKSB7XG4gIGxldCB0ZXN0RmlsZVBhdGggPSBwYXRoLnJlc29sdmUoXCIvXCIsIFwiV2luZG93c1wiLCBcIlN5c3RlbTMyXCIsIFwid2FkLXRlc3QudHh0XCIpO1xuICB0cnkge1xuICAgIGF3YWl0IGZzLnJpbXJhZih0ZXN0RmlsZVBhdGgpO1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZSh0ZXN0RmlsZVBhdGgsIFwiZm9vXCIpO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChpZ24pIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0dXBXQUQgKCkge1xuICBpZiAoIXN5c3RlbS5pc1dpbmRvd3MoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkNhbiBvbmx5IGRvd25sb2FkIFdpbkFwcERyaXZlciBvbiBXaW5kb3dzIVwiKTtcbiAgfVxuXG4gIGlmIChhd2FpdCB2ZXJpZnlXQUQoKSkge1xuICAgIGxvZy5pbmZvKFwiV2luQXBwRHJpdmVyLmV4ZSBhbHJlYWR5IGV4aXN0cyBhdCBjb3JyZWN0IGNoZWNrc3VtLCBcIiArXG4gICAgICAgICAgICAgICAgXCJub3QgcmUtZG93bmxvYWRpbmdcIik7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nLmluZm8oXCJXaW5BcHBEcml2ZXIuZXhlIGRvZXNuJ3QgZXhpc3QgYXQgdGhlIGNvcnJlY3QgdmVyc2lvbiwgc2V0dGluZyB1cFwiKTtcblxuICBpZiAoIWF3YWl0IGlzQWRtaW4oKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIllvdSBhcmUgbm90IGFuIGFkbWluaXN0cmF0b3I7IHBsZWFzZSByZWluc3RhbGwgYXMgYWRtaW5cIik7XG4gIH1cblxuICBjb25zdCBtc2lQYXRoID0gYXdhaXQgZG93bmxvYWRXQUQoKTtcbiAgYXdhaXQgaW5zdGFsbFdBRChtc2lQYXRoKTtcbiAgaWYgKCFhd2FpdCB2ZXJpZnlXQUQoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkluc3RhbGxlZCB2ZXJzaW9uIG9mIFdpbkFwcERyaXZlciBmYWlsZWQgY2hlY2tzdW0gY2hlY2tcIik7XG4gIH1cbn1cblxuZXhwb3J0IHsgZG93bmxvYWRXQUQsIHNldHVwV0FELCB2ZXJpZnlXQUQsIGluc3RhbGxXQUQsIFdBRF9JTlNUQUxMX1BBVEgsXG4gICAgICAgICBXQURfR1VJRCB9O1xuZXhwb3J0IGRlZmF1bHQgc2V0dXBXQUQ7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
