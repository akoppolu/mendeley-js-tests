'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _atoms = require('./atoms');

var _atoms2 = _interopRequireDefault(_atoms);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _assert = require('assert');

var _assert2 = _interopRequireDefault(_assert);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var WEB_CONTENT_BUNDLE_ID = 'com.apple.WebKit.WebContent';

/*
 * Takes a dictionary from the remote debugger and makes a more manageable
 * dictionary whose keys are understandable
 */
function appInfoFromDict(dict) {
  var id = dict.WIRApplicationIdentifierKey;
  var isProxy = _lodash2['default'].isString(dict.WIRIsApplicationProxyKey) ? dict.WIRIsApplicationProxyKey.toLowerCase() === 'true' : dict.WIRIsApplicationProxyKey;
  var entry = {
    id: id,
    isProxy: isProxy,
    name: dict.WIRApplicationNameKey,
    bundleId: dict.WIRApplicationBundleIdentifierKey,
    hostId: dict.WIRHostApplicationIdentifierKey,
    isActive: dict.WIRIsApplicationActiveKey,
    isAutomationEnabled: !!dict.WIRRemoteAutomationEnabledKey
  };

  return [id, entry];
}

/*
 * Take a dictionary from the remote debugger and makes a more manageable
 * dictionary of pages available.
 */
function pageArrayFromDict(pageDict) {
  if (pageDict.id) {
    // the page is already translated, so wrap in an array and pass back
    return [pageDict];
  }
  var newPageArray = [];
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(_lodash2['default'].values(pageDict)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var dict = _step.value;

      // count only WIRTypeWeb pages and ignore all others (WIRTypeJavaScript etc)
      if (_lodash2['default'].isUndefined(dict.WIRTypeKey) || dict.WIRTypeKey === 'WIRTypeWeb') {
        newPageArray.push({
          id: dict.WIRPageIdentifierKey,
          title: dict.WIRTitleKey,
          url: dict.WIRURLKey,
          isKey: !_lodash2['default'].isUndefined(dict.WIRConnectionIdentifierKey)
        });
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return newPageArray;
}

/*
 * Given a bundle id, finds the correct remote debugger app that is
 * connected.
 */
function getDebuggerAppKey(bundleId, platformVersion, appDict) {
  var appId = undefined;
  if (parseFloat(platformVersion) >= 8) {
    var _iteratorNormalCompletion2 = true;
    var _didIteratorError2 = false;
    var _iteratorError2 = undefined;

    try {
      for (var _iterator2 = _getIterator(_lodash2['default'].toPairs(appDict)), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
        var _step2$value = _slicedToArray(_step2.value, 2);

        var key = _step2$value[0];
        var data = _step2$value[1];

        if (data.bundleId === bundleId) {
          appId = key;
          break;
        }
      }
      // now we need to determine if we should pick a proxy for this instead
    } catch (err) {
      _didIteratorError2 = true;
      _iteratorError2 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }
      } finally {
        if (_didIteratorError2) {
          throw _iteratorError2;
        }
      }
    }

    if (appId) {
      _logger2['default'].debug('Found app id key \'' + appId + '\' for bundle \'' + bundleId + '\'');
      var proxiedAppIds = [];
      var _iteratorNormalCompletion3 = true;
      var _didIteratorError3 = false;
      var _iteratorError3 = undefined;

      try {
        for (var _iterator3 = _getIterator(_lodash2['default'].toPairs(appDict)), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
          var _step3$value = _slicedToArray(_step3.value, 2);

          var key = _step3$value[0];
          var data = _step3$value[1];

          if (data.isProxy && data.hostId === appId) {
            _logger2['default'].debug('Found separate bundleId \'' + data.bundleId + '\' ' + ('acting as proxy for \'' + bundleId + '\', with app id \'' + key + '\''));
            proxiedAppIds.push(key);
          }
        }
      } catch (err) {
        _didIteratorError3 = true;
        _iteratorError3 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion3 && _iterator3['return']) {
            _iterator3['return']();
          }
        } finally {
          if (_didIteratorError3) {
            throw _iteratorError3;
          }
        }
      }

      if (proxiedAppIds.length) {
        // use the last app being proxied
        appId = _lodash2['default'].last(proxiedAppIds);
        _logger2['default'].debug('Using proxied app id \'' + appId + '\'');
      }
    }
  } else {
    if (_lodash2['default'].has(appDict, bundleId)) {
      appId = bundleId;
    }
  }

  return appId;
}

function appIdForBundle(_x2, _x3) {
  var _again = true;

  _function: while (_again) {
    var bundleId = _x2,
        appDict = _x3;
    _again = false;

    var appId = undefined;
    var _iteratorNormalCompletion4 = true;
    var _didIteratorError4 = false;
    var _iteratorError4 = undefined;

    try {
      for (var _iterator4 = _getIterator(_lodash2['default'].toPairs(appDict)), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
        var _step4$value = _slicedToArray(_step4.value, 2);

        var key = _step4$value[0];
        var data = _step4$value[1];

        if (data.bundleId === bundleId) {
          appId = key;
          break;
        }
      }

      // if nothing is found, try to get the generic app
    } catch (err) {
      _didIteratorError4 = true;
      _iteratorError4 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion4 && _iterator4['return']) {
          _iterator4['return']();
        }
      } finally {
        if (_didIteratorError4) {
          throw _iteratorError4;
        }
      }
    }

    if (!appId && bundleId !== WEB_CONTENT_BUNDLE_ID) {
      _x2 = WEB_CONTENT_BUNDLE_ID;
      _x3 = appDict;
      _again = true;
      appId = _iteratorNormalCompletion4 = _didIteratorError4 = _iteratorError4 = undefined;
      continue _function;
    }

    return appId;
  }
}

function getPossibleDebuggerAppKeys(bundleId, platformVersion, appDict) {
  var proxiedAppIds = [];
  if (parseFloat(platformVersion) >= 8) {
    var appId = appIdForBundle(bundleId, appDict);

    // now we need to determine if we should pick a proxy for this instead
    if (appId) {
      _logger2['default'].debug('Found app id key \'' + appId + '\' for bundle \'' + bundleId + '\'');
      var _iteratorNormalCompletion5 = true;
      var _didIteratorError5 = false;
      var _iteratorError5 = undefined;

      try {
        for (var _iterator5 = _getIterator(_lodash2['default'].toPairs(appDict)), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
          var _step5$value = _slicedToArray(_step5.value, 2);

          var key = _step5$value[0];
          var data = _step5$value[1];

          if (data.isProxy && data.hostId === appId) {
            _logger2['default'].debug('Found separate bundleId \'' + data.bundleId + '\' ' + ('acting as proxy for \'' + bundleId + '\', with app id \'' + key + '\''));
            proxiedAppIds.push(key);
          }
        }
      } catch (err) {
        _didIteratorError5 = true;
        _iteratorError5 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion5 && _iterator5['return']) {
            _iterator5['return']();
          }
        } finally {
          if (_didIteratorError5) {
            throw _iteratorError5;
          }
        }
      }

      if (proxiedAppIds.length === 0) {
        proxiedAppIds = [appId];
      }
    }
  } else {
    if (_lodash2['default'].has(appDict, bundleId)) {
      proxiedAppIds = [bundleId];
    }
  }

  return proxiedAppIds;
}

function checkParams(params) {
  var errors = [];
  var _iteratorNormalCompletion6 = true;
  var _didIteratorError6 = false;
  var _iteratorError6 = undefined;

  try {
    for (var _iterator6 = _getIterator(_lodash2['default'].toPairs(params)), _step6; !(_iteratorNormalCompletion6 = (_step6 = _iterator6.next()).done); _iteratorNormalCompletion6 = true) {
      var _step6$value = _slicedToArray(_step6.value, 2);

      var param = _step6$value[0];
      var value = _step6$value[1];

      try {
        _assert2['default'].ok(value);
      } catch (err) {
        errors.push(param);
      }
    }
  } catch (err) {
    _didIteratorError6 = true;
    _iteratorError6 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion6 && _iterator6['return']) {
        _iterator6['return']();
      }
    } finally {
      if (_didIteratorError6) {
        throw _iteratorError6;
      }
    }
  }

  if (errors.length) {
    return errors;
  }
}

function wrapScriptForFrame(script, frame) {
  var elFromCache;
  return _regeneratorRuntime.async(function wrapScriptForFrame$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Wrapping script for frame \'' + frame + '\'');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap((0, _atoms2['default'])('get_element_from_cache'));

      case 3:
        elFromCache = context$1$0.sent;
        return context$1$0.abrupt('return', '(function (window) { var document = window.document; ' + ('return (' + script + '); })((' + elFromCache.toString('utf8') + ')(' + JSON.stringify(frame) + '))'));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getScriptForAtom(atom, args, frames) {
  var asyncCallBack = arguments.length <= 3 || arguments[3] === undefined ? null : arguments[3];

  var atomSrc, script, _iteratorNormalCompletion7, _didIteratorError7, _iteratorError7, _iterator7, _step7, frame;

  return _regeneratorRuntime.async(function getScriptForAtom$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap((0, _atoms2['default'])(atom));

      case 2:
        atomSrc = context$1$0.sent;
        script = undefined;

        if (!(frames.length > 0)) {
          context$1$0.next = 35;
          break;
        }

        script = atomSrc;
        _iteratorNormalCompletion7 = true;
        _didIteratorError7 = false;
        _iteratorError7 = undefined;
        context$1$0.prev = 9;
        _iterator7 = _getIterator(frames);

      case 11:
        if (_iteratorNormalCompletion7 = (_step7 = _iterator7.next()).done) {
          context$1$0.next = 19;
          break;
        }

        frame = _step7.value;
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(wrapScriptForFrame(script, frame));

      case 15:
        script = context$1$0.sent;

      case 16:
        _iteratorNormalCompletion7 = true;
        context$1$0.next = 11;
        break;

      case 19:
        context$1$0.next = 25;
        break;

      case 21:
        context$1$0.prev = 21;
        context$1$0.t0 = context$1$0['catch'](9);
        _didIteratorError7 = true;
        _iteratorError7 = context$1$0.t0;

      case 25:
        context$1$0.prev = 25;
        context$1$0.prev = 26;

        if (!_iteratorNormalCompletion7 && _iterator7['return']) {
          _iterator7['return']();
        }

      case 28:
        context$1$0.prev = 28;

        if (!_didIteratorError7) {
          context$1$0.next = 31;
          break;
        }

        throw _iteratorError7;

      case 31:
        return context$1$0.finish(28);

      case 32:
        return context$1$0.finish(25);

      case 33:
        context$1$0.next = 37;
        break;

      case 35:
        _logger2['default'].debug('Executing \'' + atom + '\' atom in default context');
        script = '(' + atomSrc + ')';

      case 37:

        // add the arguments, as strings
        args = args.map(JSON.stringify);
        if (asyncCallBack) {
          script += '(' + args.join(',') + ', ' + asyncCallBack + ', true )';
        } else {
          script += '(' + args.join(',') + ')';
        }

        return context$1$0.abrupt('return', script);

      case 40:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[9, 21, 25, 33], [26,, 28, 32]]);
}

function simpleStringify(value) {
  if (!value) return JSON.stringify(value);

  // we get back objects sometimes with string versions of functions
  // which muddy the logs
  var cleanValue = _lodash2['default'].clone(value);
  var _arr = ['ceil', 'clone', 'floor', 'round', 'scale', 'toString'];
  for (var _i = 0; _i < _arr.length; _i++) {
    var property = _arr[_i];
    delete cleanValue[property];
  }
  return JSON.stringify(cleanValue);
}

function deferredPromise() {
  // http://bluebirdjs.com/docs/api/deferred-migration.html
  var resolve = undefined;
  var reject = undefined;
  var promise = new _bluebird2['default'](function (res, rej) {
    resolve = res;
    reject = rej;
  });
  return {
    promise: promise,
    resolve: resolve,
    reject: reject
  };
}

exports.appInfoFromDict = appInfoFromDict;
exports.pageArrayFromDict = pageArrayFromDict;
exports.getDebuggerAppKey = getDebuggerAppKey;
exports.getPossibleDebuggerAppKeys = getPossibleDebuggerAppKeys;
exports.checkParams = checkParams;
exports.wrapScriptForFrame = wrapScriptForFrame;
exports.getScriptForAtom = getScriptForAtom;
exports.simpleStringify = simpleStringify;
exports.deferredPromise = deferredPromise;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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LCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBnZXRBdG9tIGZyb20gJy4vYXRvbXMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBhc3NlcnQgZnJvbSAnYXNzZXJ0JztcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcblxuXG5jb25zdCBXRUJfQ09OVEVOVF9CVU5ETEVfSUQgPSAnY29tLmFwcGxlLldlYktpdC5XZWJDb250ZW50JztcblxuLypcbiAqIFRha2VzIGEgZGljdGlvbmFyeSBmcm9tIHRoZSByZW1vdGUgZGVidWdnZXIgYW5kIG1ha2VzIGEgbW9yZSBtYW5hZ2VhYmxlXG4gKiBkaWN0aW9uYXJ5IHdob3NlIGtleXMgYXJlIHVuZGVyc3RhbmRhYmxlXG4gKi9cbmZ1bmN0aW9uIGFwcEluZm9Gcm9tRGljdCAoZGljdCkge1xuICBsZXQgaWQgPSBkaWN0LldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTtcbiAgbGV0IGlzUHJveHkgPSBfLmlzU3RyaW5nKGRpY3QuV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5KSA/XG4gICAgICAgICAgICAgICAgICBkaWN0LldJUklzQXBwbGljYXRpb25Qcm94eUtleS50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZScgOiBkaWN0LldJUklzQXBwbGljYXRpb25Qcm94eUtleTtcbiAgbGV0IGVudHJ5ID0ge1xuICAgIGlkLFxuICAgIGlzUHJveHksXG4gICAgbmFtZTogZGljdC5XSVJBcHBsaWNhdGlvbk5hbWVLZXksXG4gICAgYnVuZGxlSWQ6IGRpY3QuV0lSQXBwbGljYXRpb25CdW5kbGVJZGVudGlmaWVyS2V5LFxuICAgIGhvc3RJZDogZGljdC5XSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5LFxuICAgIGlzQWN0aXZlOiBkaWN0LldJUklzQXBwbGljYXRpb25BY3RpdmVLZXksXG4gICAgaXNBdXRvbWF0aW9uRW5hYmxlZDogISFkaWN0LldJUlJlbW90ZUF1dG9tYXRpb25FbmFibGVkS2V5LFxuICB9O1xuXG4gIHJldHVybiBbaWQsIGVudHJ5XTtcbn1cblxuLypcbiAqIFRha2UgYSBkaWN0aW9uYXJ5IGZyb20gdGhlIHJlbW90ZSBkZWJ1Z2dlciBhbmQgbWFrZXMgYSBtb3JlIG1hbmFnZWFibGVcbiAqIGRpY3Rpb25hcnkgb2YgcGFnZXMgYXZhaWxhYmxlLlxuICovXG5mdW5jdGlvbiBwYWdlQXJyYXlGcm9tRGljdCAocGFnZURpY3QpIHtcbiAgaWYgKHBhZ2VEaWN0LmlkKSB7XG4gICAgLy8gdGhlIHBhZ2UgaXMgYWxyZWFkeSB0cmFuc2xhdGVkLCBzbyB3cmFwIGluIGFuIGFycmF5IGFuZCBwYXNzIGJhY2tcbiAgICByZXR1cm4gW3BhZ2VEaWN0XTtcbiAgfVxuICBsZXQgbmV3UGFnZUFycmF5ID0gW107XG4gIGZvciAobGV0IGRpY3Qgb2YgXy52YWx1ZXMocGFnZURpY3QpKSB7XG4gICAgLy8gY291bnQgb25seSBXSVJUeXBlV2ViIHBhZ2VzIGFuZCBpZ25vcmUgYWxsIG90aGVycyAoV0lSVHlwZUphdmFTY3JpcHQgZXRjKVxuICAgIGlmIChfLmlzVW5kZWZpbmVkKGRpY3QuV0lSVHlwZUtleSkgfHwgZGljdC5XSVJUeXBlS2V5ID09PSAnV0lSVHlwZVdlYicpIHtcbiAgICAgIG5ld1BhZ2VBcnJheS5wdXNoKHtcbiAgICAgICAgaWQ6IGRpY3QuV0lSUGFnZUlkZW50aWZpZXJLZXksXG4gICAgICAgIHRpdGxlOiBkaWN0LldJUlRpdGxlS2V5LFxuICAgICAgICB1cmw6IGRpY3QuV0lSVVJMS2V5LFxuICAgICAgICBpc0tleTogIV8uaXNVbmRlZmluZWQoZGljdC5XSVJDb25uZWN0aW9uSWRlbnRpZmllcktleSksXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG5ld1BhZ2VBcnJheTtcbn1cblxuLypcbiAqIEdpdmVuIGEgYnVuZGxlIGlkLCBmaW5kcyB0aGUgY29ycmVjdCByZW1vdGUgZGVidWdnZXIgYXBwIHRoYXQgaXNcbiAqIGNvbm5lY3RlZC5cbiAqL1xuZnVuY3Rpb24gZ2V0RGVidWdnZXJBcHBLZXkgKGJ1bmRsZUlkLCBwbGF0Zm9ybVZlcnNpb24sIGFwcERpY3QpIHtcbiAgbGV0IGFwcElkO1xuICBpZiAocGFyc2VGbG9hdChwbGF0Zm9ybVZlcnNpb24pID49IDgpIHtcbiAgICBmb3IgKGxldCBba2V5LCBkYXRhXSBvZiBfLnRvUGFpcnMoYXBwRGljdCkpIHtcbiAgICAgIGlmIChkYXRhLmJ1bmRsZUlkID09PSBidW5kbGVJZCkge1xuICAgICAgICBhcHBJZCA9IGtleTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIG5vdyB3ZSBuZWVkIHRvIGRldGVybWluZSBpZiB3ZSBzaG91bGQgcGljayBhIHByb3h5IGZvciB0aGlzIGluc3RlYWRcbiAgICBpZiAoYXBwSWQpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgYXBwIGlkIGtleSAnJHthcHBJZH0nIGZvciBidW5kbGUgJyR7YnVuZGxlSWR9J2ApO1xuICAgICAgbGV0IHByb3hpZWRBcHBJZHMgPSBbXTtcbiAgICAgIGZvciAobGV0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgICAgICBpZiAoZGF0YS5pc1Byb3h5ICYmIGRhdGEuaG9zdElkID09PSBhcHBJZCkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgc2VwYXJhdGUgYnVuZGxlSWQgJyR7ZGF0YS5idW5kbGVJZH0nIGAgK1xuICAgICAgICAgICAgICAgICAgICBgYWN0aW5nIGFzIHByb3h5IGZvciAnJHtidW5kbGVJZH0nLCB3aXRoIGFwcCBpZCAnJHtrZXl9J2ApO1xuICAgICAgICAgIHByb3hpZWRBcHBJZHMucHVzaChrZXkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAocHJveGllZEFwcElkcy5sZW5ndGgpIHtcbiAgICAgICAgLy8gdXNlIHRoZSBsYXN0IGFwcCBiZWluZyBwcm94aWVkXG4gICAgICAgIGFwcElkID0gXy5sYXN0KHByb3hpZWRBcHBJZHMpO1xuICAgICAgICBsb2cuZGVidWcoYFVzaW5nIHByb3hpZWQgYXBwIGlkICcke2FwcElkfSdgKTtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYgKF8uaGFzKGFwcERpY3QsIGJ1bmRsZUlkKSkge1xuICAgICAgYXBwSWQgPSBidW5kbGVJZDtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gYXBwSWQ7XG59XG5cbmZ1bmN0aW9uIGFwcElkRm9yQnVuZGxlIChidW5kbGVJZCwgYXBwRGljdCkge1xuICBsZXQgYXBwSWQ7XG4gIGZvciAobGV0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgIGlmIChkYXRhLmJ1bmRsZUlkID09PSBidW5kbGVJZCkge1xuICAgICAgYXBwSWQgPSBrZXk7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICAvLyBpZiBub3RoaW5nIGlzIGZvdW5kLCB0cnkgdG8gZ2V0IHRoZSBnZW5lcmljIGFwcFxuICBpZiAoIWFwcElkICYmIGJ1bmRsZUlkICE9PSBXRUJfQ09OVEVOVF9CVU5ETEVfSUQpIHtcbiAgICByZXR1cm4gYXBwSWRGb3JCdW5kbGUoV0VCX0NPTlRFTlRfQlVORExFX0lELCBhcHBEaWN0KTtcbiAgfVxuXG4gIHJldHVybiBhcHBJZDtcbn1cblxuZnVuY3Rpb24gZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMgKGJ1bmRsZUlkLCBwbGF0Zm9ybVZlcnNpb24sIGFwcERpY3QpIHtcbiAgbGV0IHByb3hpZWRBcHBJZHMgPSBbXTtcbiAgaWYgKHBhcnNlRmxvYXQocGxhdGZvcm1WZXJzaW9uKSA+PSA4KSB7XG4gICAgbGV0IGFwcElkID0gYXBwSWRGb3JCdW5kbGUoYnVuZGxlSWQsIGFwcERpY3QpO1xuXG4gICAgLy8gbm93IHdlIG5lZWQgdG8gZGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBwaWNrIGEgcHJveHkgZm9yIHRoaXMgaW5zdGVhZFxuICAgIGlmIChhcHBJZCkge1xuICAgICAgbG9nLmRlYnVnKGBGb3VuZCBhcHAgaWQga2V5ICcke2FwcElkfScgZm9yIGJ1bmRsZSAnJHtidW5kbGVJZH0nYCk7XG4gICAgICBmb3IgKGxldCBba2V5LCBkYXRhXSBvZiBfLnRvUGFpcnMoYXBwRGljdCkpIHtcbiAgICAgICAgaWYgKGRhdGEuaXNQcm94eSAmJiBkYXRhLmhvc3RJZCA9PT0gYXBwSWQpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYEZvdW5kIHNlcGFyYXRlIGJ1bmRsZUlkICcke2RhdGEuYnVuZGxlSWR9JyBgICtcbiAgICAgICAgICAgICAgICAgICAgYGFjdGluZyBhcyBwcm94eSBmb3IgJyR7YnVuZGxlSWR9Jywgd2l0aCBhcHAgaWQgJyR7a2V5fSdgKTtcbiAgICAgICAgICBwcm94aWVkQXBwSWRzLnB1c2goa2V5KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHByb3hpZWRBcHBJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHByb3hpZWRBcHBJZHMgPSBbYXBwSWRdO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAoXy5oYXMoYXBwRGljdCwgYnVuZGxlSWQpKSB7XG4gICAgICBwcm94aWVkQXBwSWRzID0gW2J1bmRsZUlkXTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcHJveGllZEFwcElkcztcbn1cblxuZnVuY3Rpb24gY2hlY2tQYXJhbXMgKHBhcmFtcykge1xuICBsZXQgZXJyb3JzID0gW107XG4gIGZvciAobGV0IFtwYXJhbSwgdmFsdWVdIG9mIF8udG9QYWlycyhwYXJhbXMpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGFzc2VydC5vayh2YWx1ZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBlcnJvcnMucHVzaChwYXJhbSk7XG4gICAgfVxuICB9XG4gIGlmIChlcnJvcnMubGVuZ3RoKSB7XG4gICAgcmV0dXJuIGVycm9ycztcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB3cmFwU2NyaXB0Rm9yRnJhbWUgKHNjcmlwdCwgZnJhbWUpIHtcbiAgbG9nLmRlYnVnKGBXcmFwcGluZyBzY3JpcHQgZm9yIGZyYW1lICcke2ZyYW1lfSdgKTtcbiAgbGV0IGVsRnJvbUNhY2hlID0gYXdhaXQgZ2V0QXRvbSgnZ2V0X2VsZW1lbnRfZnJvbV9jYWNoZScpO1xuICByZXR1cm4gYChmdW5jdGlvbiAod2luZG93KSB7IHZhciBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDsgYCArXG4gICAgICAgICBgcmV0dXJuICgke3NjcmlwdH0pOyB9KSgoJHtlbEZyb21DYWNoZS50b1N0cmluZygndXRmOCcpfSkoJHtKU09OLnN0cmluZ2lmeShmcmFtZSl9KSlgO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTY3JpcHRGb3JBdG9tIChhdG9tLCBhcmdzLCBmcmFtZXMsIGFzeW5jQ2FsbEJhY2sgPSBudWxsKSB7XG4gIGxldCBhdG9tU3JjID0gYXdhaXQgZ2V0QXRvbShhdG9tKTtcbiAgbGV0IHNjcmlwdDtcbiAgaWYgKGZyYW1lcy5sZW5ndGggPiAwKSB7XG4gICAgc2NyaXB0ID0gYXRvbVNyYztcbiAgICBmb3IgKGxldCBmcmFtZSBvZiBmcmFtZXMpIHtcbiAgICAgIHNjcmlwdCA9IGF3YWl0IHdyYXBTY3JpcHRGb3JGcmFtZShzY3JpcHQsIGZyYW1lKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nLmRlYnVnKGBFeGVjdXRpbmcgJyR7YXRvbX0nIGF0b20gaW4gZGVmYXVsdCBjb250ZXh0YCk7XG4gICAgc2NyaXB0ID0gYCgke2F0b21TcmN9KWA7XG4gIH1cblxuICAvLyBhZGQgdGhlIGFyZ3VtZW50cywgYXMgc3RyaW5nc1xuICBhcmdzID0gYXJncy5tYXAoSlNPTi5zdHJpbmdpZnkpO1xuICBpZiAoYXN5bmNDYWxsQmFjaykge1xuICAgIHNjcmlwdCArPSBgKCR7YXJncy5qb2luKCcsJyl9LCAke2FzeW5jQ2FsbEJhY2t9LCB0cnVlIClgO1xuICB9IGVsc2Uge1xuICAgIHNjcmlwdCArPSBgKCR7YXJncy5qb2luKCcsJyl9KWA7XG4gIH1cblxuICByZXR1cm4gc2NyaXB0O1xufVxuXG5mdW5jdGlvbiBzaW1wbGVTdHJpbmdpZnkgKHZhbHVlKSB7XG4gIGlmICghdmFsdWUpIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG5cbiAgLy8gd2UgZ2V0IGJhY2sgb2JqZWN0cyBzb21ldGltZXMgd2l0aCBzdHJpbmcgdmVyc2lvbnMgb2YgZnVuY3Rpb25zXG4gIC8vIHdoaWNoIG11ZGR5IHRoZSBsb2dzXG4gIGxldCBjbGVhblZhbHVlID0gXy5jbG9uZSh2YWx1ZSk7XG4gIGZvciAobGV0IHByb3BlcnR5IG9mIFsnY2VpbCcsICdjbG9uZScsICdmbG9vcicsICdyb3VuZCcsICdzY2FsZScsICd0b1N0cmluZyddKSB7XG4gICAgZGVsZXRlIGNsZWFuVmFsdWVbcHJvcGVydHldO1xuICB9XG4gIHJldHVybiBKU09OLnN0cmluZ2lmeShjbGVhblZhbHVlKTtcbn1cblxuZnVuY3Rpb24gZGVmZXJyZWRQcm9taXNlICgpIHtcbiAgLy8gaHR0cDovL2JsdWViaXJkanMuY29tL2RvY3MvYXBpL2RlZmVycmVkLW1pZ3JhdGlvbi5odG1sXG4gIGxldCByZXNvbHZlO1xuICBsZXQgcmVqZWN0O1xuICBsZXQgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXMsIHJlaikgPT4ge1xuICAgIHJlc29sdmUgPSByZXM7XG4gICAgcmVqZWN0ID0gcmVqO1xuICB9KTtcbiAgcmV0dXJuIHtcbiAgICBwcm9taXNlLFxuICAgIHJlc29sdmUsXG4gICAgcmVqZWN0XG4gIH07XG59XG5cbmV4cG9ydCB7IGFwcEluZm9Gcm9tRGljdCwgcGFnZUFycmF5RnJvbURpY3QsIGdldERlYnVnZ2VyQXBwS2V5LCBnZXRQb3NzaWJsZURlYnVnZ2VyQXBwS2V5cywgY2hlY2tQYXJhbXMsXG4gICAgICAgICB3cmFwU2NyaXB0Rm9yRnJhbWUsIGdldFNjcmlwdEZvckF0b20sIHNpbXBsZVN0cmluZ2lmeSwgZGVmZXJyZWRQcm9taXNlIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
