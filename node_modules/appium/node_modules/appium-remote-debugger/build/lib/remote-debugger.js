require('source-map-support').install();

// jshint ignore: start
'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$values = require('babel-runtime/core-js/object/values')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumBaseDriver = require('appium-base-driver');

var _remoteDebuggerRpcClient = require('./remote-debugger-rpc-client');

var _remoteDebuggerRpcClient2 = _interopRequireDefault(_remoteDebuggerRpcClient);

var _messageHandlers = require('./message-handlers');

var _messageHandlers2 = _interopRequireDefault(_messageHandlers);

var _helpers = require('./helpers');

var _appiumSupport = require('appium-support');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var DEBUGGER_TYPES = {
  webkit: 1,
  webinspector: 2
};
var SELECT_APP_RETRIES = 20;
var REMOTE_DEBUGGER_PORT = 27753;

/* How many milliseconds to wait for webkit to return a response before timing out */
var RPC_RESPONSE_TIMEOUT_MS = 5000;

var RemoteDebugger = (function (_events$EventEmitter) {
  _inherits(RemoteDebugger, _events$EventEmitter);

  /*
   * The constructor takes an opts hash with the following properties:
   *   - bundleId - id of the app being connected to
   *   - platformVersion - version of iOS
   *   - debuggerType - one of the DEBUGGER_TYPES
   *   - useNewSafari - for web inspector, whether this is a new Safari instance
   *   - pageLoadMs - the time, in ms, that should be waited for page loading
   *   - host - the remote debugger's host address
   *   - port - the remote debugger port through which to communicate
   */

  function RemoteDebugger() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, RemoteDebugger);

    _get(Object.getPrototypeOf(RemoteDebugger.prototype), 'constructor', this).call(this);

    var bundleId = opts.bundleId;
    var platformVersion = opts.platformVersion;
    var debuggerType = opts.debuggerType;
    var useNewSafari = opts.useNewSafari;
    var pageLoadMs = opts.pageLoadMs;
    var host = opts.host;
    var port = opts.port;

    this.bundleId = bundleId;
    this.platformVersion = platformVersion;
    this.debuggerType = debuggerType || DEBUGGER_TYPES.webinspector;
    if (this.debuggerType === DEBUGGER_TYPES.webinspector) {
      this.useNewSafari = useNewSafari || false;
      this.pageLoadMs = pageLoadMs;
      _logger2['default'].debug('useNewSafari --> ' + this.useNewSafari);
    }

    this.host = host || 'localhost';
    this.port = port || REMOTE_DEBUGGER_PORT;
  }

  // event emitted publically

  _createClass(RemoteDebugger, [{
    key: 'setup',
    value: function setup() {
      // app handling configuration
      this.appDict = {};
      this.appIdKey = null;
      this.pageIdKey = null;
      this.pageLoading = false;

      // set up the special callbacks for handling rd events
      this.specialCbs = {
        '_rpc_reportIdentifier:': _lodash2['default'].noop,
        '_rpc_forwardGetListing:': this.onPageChange.bind(this),
        '_rpc_reportConnectedApplicationList:': _lodash2['default'].noop,
        '_rpc_applicationConnected:': this.onAppConnect.bind(this),
        '_rpc_applicationDisconnected:': this.onAppDisconnect.bind(this),
        '_rpc_applicationUpdated:': this.onAppUpdate.bind(this),
        '_rpc_reportConnectedDriverList:': this.onReportDriverList.bind(this),
        'pageLoad': this.pageLoad.bind(this)
      };

      this.rpcClient = null;
    }
  }, {
    key: 'teardown',
    value: function teardown() {
      _logger2['default'].debug('Cleaning up listeners');

      this.appDict = {};
      this.appIdKey = null;
      this.pageIdKey = null;
      this.pageLoading = false;

      this.specialCbs = {};

      this.rpcClient = null;
    }
  }, {
    key: 'connect',
    value: function connect() {
      var appInfo;
      return _regeneratorRuntime.async(function connect$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.setup();

            // initialize the rpc client for
            this.rpcClient = new _remoteDebuggerRpcClient2['default'](this.host, this.port, this.specialCbs);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.rpcClient.connect());

          case 4:
            context$2$0.prev = 4;
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.setConnectionKey());

          case 7:
            appInfo = context$2$0.sent;

            _logger2['default'].debug('Connected to application');
            return context$2$0.abrupt('return', appInfo);

          case 12:
            context$2$0.prev = 12;
            context$2$0.t0 = context$2$0['catch'](4);
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.disconnect());

          case 16:
            return context$2$0.abrupt('return', null);

          case 17:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[4, 12]]);
    }
  }, {
    key: 'disconnect',
    value: function disconnect() {
      return _regeneratorRuntime.async(function disconnect$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.rpcClient.disconnect());

          case 2:
            this.teardown();
            this.emit(RemoteDebugger.EVENT_DISCONNECT, true);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'isConnected',
    value: function isConnected() {
      return !!(this.rpcClient && this.rpcClient.isConnected());
    }
  }, {
    key: 'logApplicationDictionary',
    value: function logApplicationDictionary(apps) {
      function getValueString(key, value) {
        if (_lodash2['default'].isFunction(value)) {
          return '[Function]';
        }
        if (key === 'pageDict' && !_lodash2['default'].isArray(value)) {
          return '"Waiting for data"';
        }
        return JSON.stringify(value);
      }
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = _getIterator(_lodash2['default'].toPairs(apps)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var _step$value = _slicedToArray(_step.value, 2);

          var app = _step$value[0];
          var info = _step$value[1];

          _logger2['default'].debug('Application: \'' + app + '\'');
          var _iteratorNormalCompletion2 = true;
          var _didIteratorError2 = false;
          var _iteratorError2 = undefined;

          try {
            for (var _iterator2 = _getIterator(_lodash2['default'].toPairs(info)), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              var _step2$value = _slicedToArray(_step2.value, 2);

              var key = _step2$value[0];
              var value = _step2$value[1];

              var valueString = getValueString(key, value);
              _logger2['default'].debug('    ' + key + ': ' + valueString);
            }
          } catch (err) {
            _didIteratorError2 = true;
            _iteratorError2 = err;
          } finally {
            try {
              if (!_iteratorNormalCompletion2 && _iterator2['return']) {
                _iterator2['return']();
              }
            } finally {
              if (_didIteratorError2) {
                throw _iteratorError2;
              }
            }
          }
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }
    }
  }, {
    key: 'setConnectionKey',
    value: function setConnectionKey() {
      return _regeneratorRuntime.async(function setConnectionKey$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
              // local callback, called when the remote debugger has established
              // a connection to the app under test
              // `app` will be an array of dictionaries of app information
              var connectCb = function connectCb(apps) {
                if (_lodash2['default'].isUndefined(apps) || _lodash2['default'].keys(apps).length === 0) {
                  _logger2['default'].debug('Received no apps from remote debugger. Unable to connect.');
                  return resolve(_this.appDict);
                }
                var newDict = {};

                // translate the received information into an easier-to-manage
                // hash with app id as key, and app info as value
                var _iteratorNormalCompletion3 = true;
                var _didIteratorError3 = false;
                var _iteratorError3 = undefined;

                try {
                  for (var _iterator3 = _getIterator(_lodash2['default'].values(apps)), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
                    var dict = _step3.value;

                    var _appInfoFromDict = (0, _helpers.appInfoFromDict)(dict);

                    var _appInfoFromDict2 = _slicedToArray(_appInfoFromDict, 2);

                    var id = _appInfoFromDict2[0];
                    var entry = _appInfoFromDict2[1];

                    newDict[id] = entry;
                  }
                  // update the object's list of apps, and return it through the promise
                } catch (err) {
                  _didIteratorError3 = true;
                  _iteratorError3 = err;
                } finally {
                  try {
                    if (!_iteratorNormalCompletion3 && _iterator3['return']) {
                      _iterator3['return']();
                    }
                  } finally {
                    if (_didIteratorError3) {
                      throw _iteratorError3;
                    }
                  }
                }

                _lodash2['default'].defaults(_this.appDict, newDict);
                resolve(newDict);
              };
              _this.rpcClient.setSpecialMessageHandler('_rpc_reportConnectedApplicationList:', reject, connectCb);

              _logger2['default'].debug('Sending connection key request');
              return (function callee$3$0() {
                var _ref, _ref2, simNameKey, simBuildKey, simPlatformVersion;

                return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                  while (1) switch (context$4$0.prev = context$4$0.next) {
                    case 0:
                      context$4$0.next = 2;
                      return _regeneratorRuntime.awrap(this.rpcClient.send('setConnectionKey'));

                    case 2:
                      _ref = context$4$0.sent;
                      _ref2 = _slicedToArray(_ref, 3);
                      simNameKey = _ref2[0];
                      simBuildKey = _ref2[1];
                      simPlatformVersion = _ref2[2];

                      _logger2['default'].debug('Sim name: ' + simNameKey);
                      _logger2['default'].debug('Sim build: ' + simBuildKey);
                      _logger2['default'].debug('Sim platform version: ' + simPlatformVersion);

                    case 10:
                    case 'end':
                      return context$4$0.stop();
                  }
                }, null, _this);
              })();
            }));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'updateAppsWithDict',
    value: function updateAppsWithDict(dict) {
      // get the dictionary entry into a nice form, and add it to the
      // application dictionary
      this.appDict = this.appDict || {};

      var _appInfoFromDict3 = (0, _helpers.appInfoFromDict)(dict);

      var _appInfoFromDict32 = _slicedToArray(_appInfoFromDict3, 2);

      var id = _appInfoFromDict32[0];
      var entry = _appInfoFromDict32[1];

      if (this.appDict[id]) {
        // preserve the page dictionary for this entry
        entry.pageDict = this.appDict[id].pageDict;
      }
      this.appDict[id] = entry;

      // add a promise to get the page dictionary
      if (_lodash2['default'].isUndefined(entry.pageDict)) {
        entry.pageDict = (0, _helpers.deferredPromise)();
      }

      _logger2['default'].debug('Current applications available:');
      this.logApplicationDictionary(this.appDict);

      // try to get the app id from our connected apps
      if (!this.appIdKey) {
        this.appIdKey = (0, _helpers.getDebuggerAppKey)(this.bundleId, this.platformVersion, this.appDict);
      }
    }
  }, {
    key: 'selectApp',
    value: function selectApp() {
      var currentUrl = arguments.length <= 0 || arguments[0] === undefined ? null : arguments[0];
      var maxTries = arguments.length <= 1 || arguments[1] === undefined ? SELECT_APP_RETRIES : arguments[1];
      var ignoreAboutBlankUrl = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];

      var pageDict, appIdKey, i, possibleAppIds, _iteratorNormalCompletion4, _didIteratorError4, _iteratorError4, _iterator4, _step4, attemptedAppIdKey, _ref3, _ref32, found, _iteratorNormalCompletion5, _didIteratorError5, _iteratorError5, _iterator5, _step5, appDict, _iteratorNormalCompletion6, _didIteratorError6, _iteratorError6, _iterator6, _step6, dict, pagePromises, pageArray, fullPageArray, _iteratorNormalCompletion7, _didIteratorError7, _iteratorError7, _iterator7, _step7, _step7$value, app, info, id, _iteratorNormalCompletion8, _didIteratorError8, _iteratorError8, _iterator8, _step8, page, _pageDict;

      return _regeneratorRuntime.async(function selectApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Selecting application');

            if (!(!this.appDict || _lodash2['default'].keys(this.appDict).length === 0)) {
              context$2$0.next = 4;
              break;
            }

            _logger2['default'].debug('No applications currently connected.');
            return context$2$0.abrupt('return', []);

          case 4:
            pageDict = undefined, appIdKey = undefined;
            i = 0;

          case 6:
            if (!(i < maxTries)) {
              context$2$0.next = 114;
              break;
            }

            possibleAppIds = (0, _helpers.getPossibleDebuggerAppKeys)(this.bundleId, this.platformVersion, this.appDict);

            _logger2['default'].debug('Trying out the possible app ids: ' + possibleAppIds.join(', '));
            _iteratorNormalCompletion4 = true;
            _didIteratorError4 = false;
            _iteratorError4 = undefined;
            context$2$0.prev = 12;
            _iterator4 = _getIterator(possibleAppIds);

          case 14:
            if (_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done) {
              context$2$0.next = 97;
              break;
            }

            attemptedAppIdKey = _step4.value;
            context$2$0.prev = 16;

            _logger2['default'].debug('Selecting app ' + attemptedAppIdKey + ' (try #' + (i + 1) + ' of ' + maxTries + ')');
            context$2$0.next = 20;
            return _regeneratorRuntime.awrap(this.rpcClient.selectApp(attemptedAppIdKey, this.onAppConnect.bind(this)));

          case 20:
            _ref3 = context$2$0.sent;
            _ref32 = _slicedToArray(_ref3, 2);
            appIdKey = _ref32[0];
            pageDict = _ref32[1];

            if (!_lodash2['default'].isEmpty(pageDict)) {
              context$2$0.next = 27;
              break;
            }

            _logger2['default'].debug('Empty page dictionary received. Trying again.');
            return context$2$0.abrupt('continue', 94);

          case 27:

            // save the page array for this app
            this.appDict[appIdKey].pageDict = (0, _helpers.pageArrayFromDict)(pageDict);

            // if we are looking for a particular url, make sure we have the right page. Ignore empty or undefined urls. Ignore about:blank if requested.
            found = false;
            _iteratorNormalCompletion5 = true;
            _didIteratorError5 = false;
            _iteratorError5 = undefined;
            context$2$0.prev = 32;
            _iterator5 = _getIterator(_lodash2['default'].values(this.appDict));

          case 34:
            if (_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done) {
              context$2$0.next = 70;
              break;
            }

            appDict = _step5.value;

            if (!found) {
              context$2$0.next = 38;
              break;
            }

            return context$2$0.abrupt('break', 70);

          case 38:
            _iteratorNormalCompletion6 = true;
            _didIteratorError6 = false;
            _iteratorError6 = undefined;
            context$2$0.prev = 41;
            _iterator6 = _getIterator(appDict.pageDict || []);

          case 43:
            if (_iteratorNormalCompletion6 = (_step6 = _iterator6.next()).done) {
              context$2$0.next = 53;
              break;
            }

            dict = _step6.value;

            if (!((!ignoreAboutBlankUrl || dict.url !== 'about:blank') && (!currentUrl || dict.url === currentUrl))) {
              context$2$0.next = 50;
              break;
            }

            // save where we found the right page
            appIdKey = appDict.id;
            pageDict = dict;
            found = true;
            return context$2$0.abrupt('break', 70);

          case 50:
            _iteratorNormalCompletion6 = true;
            context$2$0.next = 43;
            break;

          case 53:
            context$2$0.next = 59;
            break;

          case 55:
            context$2$0.prev = 55;
            context$2$0.t0 = context$2$0['catch'](41);
            _didIteratorError6 = true;
            _iteratorError6 = context$2$0.t0;

          case 59:
            context$2$0.prev = 59;
            context$2$0.prev = 60;

            if (!_iteratorNormalCompletion6 && _iterator6['return']) {
              _iterator6['return']();
            }

          case 62:
            context$2$0.prev = 62;

            if (!_didIteratorError6) {
              context$2$0.next = 65;
              break;
            }

            throw _iteratorError6;

          case 65:
            return context$2$0.finish(62);

          case 66:
            return context$2$0.finish(59);

          case 67:
            _iteratorNormalCompletion5 = true;
            context$2$0.next = 34;
            break;

          case 70:
            context$2$0.next = 76;
            break;

          case 72:
            context$2$0.prev = 72;
            context$2$0.t1 = context$2$0['catch'](32);
            _didIteratorError5 = true;
            _iteratorError5 = context$2$0.t1;

          case 76:
            context$2$0.prev = 76;
            context$2$0.prev = 77;

            if (!_iteratorNormalCompletion5 && _iterator5['return']) {
              _iterator5['return']();
            }

          case 79:
            context$2$0.prev = 79;

            if (!_didIteratorError5) {
              context$2$0.next = 82;
              break;
            }

            throw _iteratorError5;

          case 82:
            return context$2$0.finish(79);

          case 83:
            return context$2$0.finish(76);

          case 84:
            if (found) {
              context$2$0.next = 88;
              break;
            }

            _logger2['default'].debug('Received app, but expected url (\'' + currentUrl + '\') was not found. Trying again.');
            pageDict = null;
            return context$2$0.abrupt('continue', 94);

          case 88:
            return context$2$0.abrupt('break', 114);

          case 91:
            context$2$0.prev = 91;
            context$2$0.t2 = context$2$0['catch'](16);

            _logger2['default'].debug('Error checking application: \'' + context$2$0.t2 + '\'. Retrying connection');

          case 94:
            _iteratorNormalCompletion4 = true;
            context$2$0.next = 14;
            break;

          case 97:
            context$2$0.next = 103;
            break;

          case 99:
            context$2$0.prev = 99;
            context$2$0.t3 = context$2$0['catch'](12);
            _didIteratorError4 = true;
            _iteratorError4 = context$2$0.t3;

          case 103:
            context$2$0.prev = 103;
            context$2$0.prev = 104;

            if (!_iteratorNormalCompletion4 && _iterator4['return']) {
              _iterator4['return']();
            }

          case 106:
            context$2$0.prev = 106;

            if (!_didIteratorError4) {
              context$2$0.next = 109;
              break;
            }

            throw _iteratorError4;

          case 109:
            return context$2$0.finish(106);

          case 110:
            return context$2$0.finish(103);

          case 111:
            i++;
            context$2$0.next = 6;
            break;

          case 114:

            // if, after all this, we have no dictionary, we have failed
            if (!pageDict) {
              _logger2['default'].errorAndThrow('Could not connect to a valid app after ' + maxTries + ' tries.');
            }

            if (this.appIdKey !== appIdKey) {
              _logger2['default'].debug('Received altered app id, updating from \'' + this.appIdKey + '\' to \'' + appIdKey + '\'');
              this.appIdKey = appIdKey;
            }

            // set the callback for getting a listing to the page change callback
            this.rpcClient.setSpecialMessageHandler('_rpc_forwardGetListing:', null, this.onPageChange.bind(this));

            // wait for all the promises are back, or 30s passes
            pagePromises = _Object$values(this.appDict).filter(function (app) {
              return !!app.pageDict && !!app.pageDict.promise;
            }).map(function (app) {
              return app.pageDict.promise;
            });

            if (!pagePromises.length) {
              context$2$0.next = 122;
              break;
            }

            _logger2['default'].debug('Waiting for ' + pagePromises.length + ' pages to be fulfilled');
            context$2$0.next = 122;
            return _regeneratorRuntime.awrap(_bluebird2['default'].any([_bluebird2['default'].delay(30000), _bluebird2['default'].all(pagePromises)]));

          case 122:
            pageArray = (0, _helpers.pageArrayFromDict)(pageDict);

            _logger2['default'].debug('Finally selecting app ' + this.appIdKey + ': ' + (0, _helpers.simpleStringify)(pageArray));

            fullPageArray = [];
            _iteratorNormalCompletion7 = true;
            _didIteratorError7 = false;
            _iteratorError7 = undefined;
            context$2$0.prev = 128;
            _iterator7 = _getIterator(_lodash2['default'].toPairs(this.appDict));

          case 130:
            if (_iteratorNormalCompletion7 = (_step7 = _iterator7.next()).done) {
              context$2$0.next = 159;
              break;
            }

            _step7$value = _slicedToArray(_step7.value, 2);
            app = _step7$value[0];
            info = _step7$value[1];

            if (_lodash2['default'].isArray(info.pageDict)) {
              context$2$0.next = 136;
              break;
            }

            return context$2$0.abrupt('continue', 156);

          case 136:
            id = app.replace('PID:', '');
            _iteratorNormalCompletion8 = true;
            _didIteratorError8 = false;
            _iteratorError8 = undefined;
            context$2$0.prev = 140;

            for (_iterator8 = _getIterator(info.pageDict); !(_iteratorNormalCompletion8 = (_step8 = _iterator8.next()).done); _iteratorNormalCompletion8 = true) {
              page = _step8.value;

              if (page.url && (!ignoreAboutBlankUrl || page.url !== 'about:blank') && (!currentUrl || page.url === currentUrl)) {
                _pageDict = _lodash2['default'].clone(page);

                _pageDict.id = id + '.' + _pageDict.id;
                fullPageArray.push(_pageDict);
              }
            }
            context$2$0.next = 148;
            break;

          case 144:
            context$2$0.prev = 144;
            context$2$0.t4 = context$2$0['catch'](140);
            _didIteratorError8 = true;
            _iteratorError8 = context$2$0.t4;

          case 148:
            context$2$0.prev = 148;
            context$2$0.prev = 149;

            if (!_iteratorNormalCompletion8 && _iterator8['return']) {
              _iterator8['return']();
            }

          case 151:
            context$2$0.prev = 151;

            if (!_didIteratorError8) {
              context$2$0.next = 154;
              break;
            }

            throw _iteratorError8;

          case 154:
            return context$2$0.finish(151);

          case 155:
            return context$2$0.finish(148);

          case 156:
            _iteratorNormalCompletion7 = true;
            context$2$0.next = 130;
            break;

          case 159:
            context$2$0.next = 165;
            break;

          case 161:
            context$2$0.prev = 161;
            context$2$0.t5 = context$2$0['catch'](128);
            _didIteratorError7 = true;
            _iteratorError7 = context$2$0.t5;

          case 165:
            context$2$0.prev = 165;
            context$2$0.prev = 166;

            if (!_iteratorNormalCompletion7 && _iterator7['return']) {
              _iterator7['return']();
            }

          case 168:
            context$2$0.prev = 168;

            if (!_didIteratorError7) {
              context$2$0.next = 171;
              break;
            }

            throw _iteratorError7;

          case 171:
            return context$2$0.finish(168);

          case 172:
            return context$2$0.finish(165);

          case 173:
            return context$2$0.abrupt('return', fullPageArray);

          case 174:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[12, 99, 103, 111], [16, 91], [32, 72, 76, 84], [41, 55, 59, 67], [60,, 62, 66], [77,, 79, 83], [104,, 106, 110], [128, 161, 165, 173], [140, 144, 148, 156], [149,, 151, 155], [166,, 168, 172]]);
    }
  }, {
    key: 'selectPage',
    value: function selectPage(appIdKey, pageIdKey) {
      var skipReadyCheck = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
      var ready;
      return _regeneratorRuntime.async(function selectPage$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.appIdKey = 'PID:' + appIdKey;
            this.pageIdKey = pageIdKey;

            _logger2['default'].debug('Selecting page \'' + pageIdKey + '\' on app \'' + this.appIdKey + '\' and forwarding socket setup');

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.rpcClient.send('setSenderKey', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey
            }));

          case 5:
            _logger2['default'].debug('Sender key set');

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.rpcClient.send('enablePage', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 8:
            _logger2['default'].debug('Enabled activity on page');

            // make sure everything is ready to go
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.checkPageIsReady());

          case 11:
            ready = context$2$0.sent;

            if (!(!skipReadyCheck && !ready)) {
              context$2$0.next = 15;
              break;
            }

            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.pageUnload());

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'executeAtom',
    value: function executeAtom(atom, args, frames) {
      var script, value;
      return _regeneratorRuntime.async(function executeAtom$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.rpcClient.connected) {
              context$2$0.next = 2;
              break;
            }

            throw new Error('Remote debugger is not connected');

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((0, _helpers.getScriptForAtom)(atom, args, frames));

          case 4:
            script = context$2$0.sent;
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.execute(script, true));

          case 7:
            value = context$2$0.sent;

            _logger2['default'].debug('Received result for atom \'' + atom + '\' execution: ' + (0, _helpers.simpleStringify)(value));
            return context$2$0.abrupt('return', value);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'executeAtomAsync',
    value: function executeAtomAsync(atom, args, frames, responseUrl) {
      var asyncCallBack, script;
      return _regeneratorRuntime.async(function executeAtomAsync$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            asyncCallBack = 'function (res) { xmlHttp = new XMLHttpRequest(); ' + ('xmlHttp.open(\'POST\', \'' + responseUrl + '\', true);') + 'xmlHttp.setRequestHeader(\'Content-type\',\'application/json\'); ' + 'xmlHttp.send(res); }';
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _helpers.getScriptForAtom)(atom, args, frames, asyncCallBack));

          case 3:
            script = context$2$0.sent;
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.execute(script));

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'pageLoad',
    value: function pageLoad(startPageLoadMs) {
      var timeoutMs, start, verify;
      return _regeneratorRuntime.async(function pageLoad$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            timeoutMs = 500;
            start = startPageLoadMs || Date.now();

            _logger2['default'].debug('Page loaded, verifying whether ready');

            verify = function verify() {
              var ready;
              return _regeneratorRuntime.async(function verify$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    this.pageLoadDelay = _appiumSupport.util.cancellableDelay(timeoutMs);
                    context$3$0.prev = 1;
                    context$3$0.next = 4;
                    return _regeneratorRuntime.awrap(this.pageLoadDelay);

                  case 4:
                    context$3$0.next = 10;
                    break;

                  case 6:
                    context$3$0.prev = 6;
                    context$3$0.t0 = context$3$0['catch'](1);

                    if (!(context$3$0.t0 instanceof _bluebird2['default'].CancellationError)) {
                      context$3$0.next = 10;
                      break;
                    }

                    return context$3$0.abrupt('return');

                  case 10:
                    if (this.appIdKey) {
                      context$3$0.next = 13;
                      break;
                    }

                    _logger2['default'].debug('Not connected to an application. Ignoring page load');
                    return context$3$0.abrupt('return');

                  case 13:
                    context$3$0.next = 15;
                    return _regeneratorRuntime.awrap(this.checkPageIsReady());

                  case 15:
                    ready = context$3$0.sent;

                    if (!(ready || this.pageLoadMs > 0 && start + this.pageLoadMs < Date.now())) {
                      context$3$0.next = 21;
                      break;
                    }

                    _logger2['default'].debug('Page is ready');
                    this.pageLoading = false;
                    context$3$0.next = 24;
                    break;

                  case 21:
                    _logger2['default'].debug('Page was not ready, retrying');
                    context$3$0.next = 24;
                    return _regeneratorRuntime.awrap(verify());

                  case 24:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2, [[1, 6]]);
            };

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(verify());

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'cancelPageLoad',
    value: function cancelPageLoad() {
      return _regeneratorRuntime.async(function cancelPageLoad$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Unregistering from page readiness notifications');
            this.pageLoading = false;
            if (this.pageLoadDelay) {
              this.pageLoadDelay.cancel();
            }

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'pageUnload',
    value: function pageUnload() {
      return _regeneratorRuntime.async(function pageUnload$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Page unloading');
            this.pageLoading = true;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.waitForDom());

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForDom',
    value: function waitForDom(startPageLoadMs) {
      return _regeneratorRuntime.async(function waitForDom$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Waiting for dom...');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.pageLoad(startPageLoadMs));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'checkPageIsReady',
    value: function checkPageIsReady() {
      var errors, readyCmd, readyState;
      return _regeneratorRuntime.async(function checkPageIsReady$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            errors = (0, _helpers.checkParams)({ appIdKey: this.appIdKey });

            if (!errors) {
              context$2$0.next = 3;
              break;
            }

            throw new Error(errors);

          case 3:

            _logger2['default'].debug('Checking document readyState');
            readyCmd = '(function (){ return document.readyState; })()';
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.execute(readyCmd, true));

          case 7:
            readyState = context$2$0.sent;

            _logger2['default'].debug('readyState was ' + (0, _helpers.simpleStringify)(readyState));

            return context$2$0.abrupt('return', readyState === 'complete');

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'navToUrl',
    value: function navToUrl(url) {
      var _errors;

      return _regeneratorRuntime.async(function navToUrl$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(this.debuggerType === DEBUGGER_TYPES.webinspector)) {
              context$2$0.next = 4;
              break;
            }

            _errors = (0, _helpers.checkParams)({ appIdKey: this.appIdKey, pageIdKey: this.pageIdKey });

            if (!_errors) {
              context$2$0.next = 4;
              break;
            }

            throw new Error(_errors);

          case 4:

            _logger2['default'].debug('Navigating to new URL: ' + url);
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.rpcClient.send('setUrl', {
              url: url,
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 7:
            if (this.useNewSafari) {
              context$2$0.next = 10;
              break;
            }

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(1000));

          case 10:
            if (!(this.debuggerType === DEBUGGER_TYPES.webinspector)) {
              context$2$0.next = 13;
              break;
            }

            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.waitForFrameNavigated());

          case 13:
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.waitForDom(Date.now()));

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForFrameNavigated',
    value: function waitForFrameNavigated() {
      return _regeneratorRuntime.async(function waitForFrameNavigated$(context$2$0) {
        var _this4 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function callee$2$0(resolve, reject) {
              var startMs, navEventListener, timeout;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this3 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    _logger2['default'].debug('Waiting for frame navigated message...');
                    startMs = Date.now();

                    navEventListener = function navEventListener(value) {
                      _logger2['default'].debug('Frame navigated in ' + (Date.now() - startMs) / 1000 + ' sec from source: ' + value);
                      if (_this3.navigationDelay) {
                        _this3.navigationDelay.cancel();
                      }
                      resolve(value);
                    };

                    this.rpcClient.setSpecialMessageHandler('Page.frameNavigated', reject, navEventListener);

                    // timeout, in case remote debugger doesn't respond,
                    // or takes a long time

                    if (!(!this.useNewSafari || this.pageLoadMs >= 0)) {
                      context$3$0.next = 15;
                      break;
                    }

                    timeout = this.useNewSafari ? this.pageLoadMs : 500;

                    this.navigationDelay = _appiumSupport.util.cancellableDelay(timeout);
                    context$3$0.prev = 7;
                    context$3$0.next = 10;
                    return _regeneratorRuntime.awrap(this.navigationDelay);

                  case 10:
                    navEventListener('timeout');
                    context$3$0.next = 15;
                    break;

                  case 13:
                    context$3$0.prev = 13;
                    context$3$0.t0 = context$3$0['catch'](7);

                  case 15:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this4, [[7, 13]]);
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startTimeline',

    // nothing to do: we only get here if the remote debugger
    // already notified of frame navigation, and the delay
    // was cancelled
    value: function startTimeline(fn) {
      return _regeneratorRuntime.async(function startTimeline$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Starting to record the timeline');
            this.rpcClient.setTimelineEventHandler(fn);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.rpcClient.send('startTimeline', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stopTimeline',
    value: function stopTimeline() {
      return _regeneratorRuntime.async(function stopTimeline$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Stopping to record the timeline');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.rpcClient.send('stopTimeline', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'execute',
    value: function execute(command, override) {
      var _errors2, res;

      return _regeneratorRuntime.async(function execute$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(this.pageLoading && !override)) {
              context$2$0.next = 4;
              break;
            }

            _logger2['default'].debug('Trying to execute but page is not loaded.');
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.waitForDom());

          case 4:
            if (!(this.debuggerType === DEBUGGER_TYPES.webinspector)) {
              context$2$0.next = 8;
              break;
            }

            _errors2 = (0, _helpers.checkParams)({ appIdKey: this.appIdKey, pageIdKey: this.pageIdKey });

            if (!_errors2) {
              context$2$0.next = 8;
              break;
            }

            throw new Error(_errors2);

          case 8:

            _logger2['default'].debug('Sending javascript command ' + _lodash2['default'].truncate(command, { length: 50 }));
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.rpcClient.send('sendJSCommand', {
              command: command,
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 11:
            res = context$2$0.sent;
            return context$2$0.abrupt('return', this.convertResult(res));

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'callFunction',
    value: function callFunction(objId, fn, args) {
      var errors, res;
      return _regeneratorRuntime.async(function callFunction$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            errors = (0, _helpers.checkParams)({ appIdKey: this.appIdKey, pageIdKey: this.pageIdKey });

            if (!errors) {
              context$2$0.next = 3;
              break;
            }

            throw new Error(errors);

          case 3:

            _logger2['default'].debug('Calling javascript function');
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.rpcClient.send('callJSFunction', {
              objId: objId,
              fn: fn,
              args: args,
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 6:
            res = context$2$0.sent;
            return context$2$0.abrupt('return', this.convertResult(res));

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'convertResult',
    value: function convertResult(res) {
      if (_lodash2['default'].isUndefined(res)) {
        throw new Error('Did not get OK result from remote debugger. Result was: ' + (0, _helpers.simpleStringify)(res));
      } else if (_lodash2['default'].isString(res)) {
        try {
          res = JSON.parse(res);
        } catch (err) {
          // we might get a serialized object, but we might not
          // if we get here, it is just a value
        }
      } else if (!_lodash2['default'].isObject(res)) {
          throw new Error('Result has unexpected type: (' + typeof res + ').');
        }

      if (res.status && res.status !== 0) {
        // we got some form of error.
        var message = res.value.message || res.value;
        throw new _appiumBaseDriver.errors.JavaScriptError(message + ' (status: ' + res.status + ')');
      }

      // with either have an object with a `value` property (even if `null`),
      // or a plain object
      return res.hasOwnProperty('value') ? res.value : res;
    }
  }, {
    key: 'allowNavigationWithoutReload',
    value: function allowNavigationWithoutReload() {
      var allow = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
      return _regeneratorRuntime.async(function allowNavigationWithoutReload$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.rpcClient.allowNavigationWithoutReload(allow);

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return RemoteDebugger;
})(_events2['default'].EventEmitter);

RemoteDebugger.EVENT_PAGE_CHANGE = 'remote_debugger_page_change';
RemoteDebugger.EVENT_DISCONNECT = 'remote_debugger_disconnect';

// add generic callbacks
var _iteratorNormalCompletion9 = true;
var _didIteratorError9 = false;
var _iteratorError9 = undefined;

try {
  for (var _iterator9 = _getIterator(_lodash2['default'].toPairs(_messageHandlers2['default'])), _step9; !(_iteratorNormalCompletion9 = (_step9 = _iterator9.next()).done); _iteratorNormalCompletion9 = true) {
    var _step9$value = _slicedToArray(_step9.value, 2);

    var _name = _step9$value[0];
    var handler = _step9$value[1];

    RemoteDebugger.prototype[_name] = handler;
  }
} catch (err) {
  _didIteratorError9 = true;
  _iteratorError9 = err;
} finally {
  try {
    if (!_iteratorNormalCompletion9 && _iterator9['return']) {
      _iterator9['return']();
    }
  } finally {
    if (_didIteratorError9) {
      throw _iteratorError9;
    }
  }
}

exports.RemoteDebugger = RemoteDebugger;
exports.DEBUGGER_TYPES = DEBUGGER_TYPES;
exports.REMOTE_DEBUGGER_PORT = REMOTE_DEBUGGER_PORT;
exports.RPC_RESPONSE_TIMEOUT_MS = RPC_RESPONSE_TIMEOUT_MS;

// get the connection information about the app

// only resolve when the connection response is received

// iterative solution, as recursion was swallowing the promise at some point

// in iOS 8.2 the connect logic happens, but with an empty dictionary
// which leads to the remote debugger getting disconnected, and into a loop

// we have gotten the correct application by this point, so short circuit everything

// translate the dictionary into a useful form, and return to sender

// if the promise has been cancelled
// we want to skip checking the readiness

// we can get this called in the middle of trying to find a new app

// if we are ready, or we've spend too much time on this

// no need to do this check when using webkit

// a small pause for the browser to catch up

// add a handler for the `Page.frameNavigated` message
// from the remote debugger

// use pageLoadMs, or a small amount of time

// if the page is not loaded yet, wait for it

// no need to check errors if it is webkit
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtZGVidWdnZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBRW1CLFFBQVE7Ozs7c0JBQ1gsVUFBVTs7OztnQ0FDSCxvQkFBb0I7O3VDQUNQLDhCQUE4Qjs7OzsrQkFDdEMsb0JBQW9COzs7O3VCQUVtQixXQUFXOzs2QkFDekQsZ0JBQWdCOztzQkFDdkIsUUFBUTs7Ozt3QkFDRixVQUFVOzs7O0FBRzlCLElBQU0sY0FBYyxHQUFHO0FBQ3JCLFFBQU0sRUFBRSxDQUFDO0FBQ1QsY0FBWSxFQUFFLENBQUM7Q0FDaEIsQ0FBQztBQUNGLElBQU0sa0JBQWtCLEdBQUcsRUFBRSxDQUFDO0FBQzlCLElBQU0sb0JBQW9CLEdBQUcsS0FBSyxDQUFDOzs7QUFHbkMsSUFBTSx1QkFBdUIsR0FBRyxJQUFJLENBQUM7O0lBRy9CLGNBQWM7WUFBZCxjQUFjOzs7Ozs7Ozs7Ozs7O0FBV04sV0FYUixjQUFjLEdBV007UUFBWCxJQUFJLHlEQUFHLEVBQUU7OzBCQVhsQixjQUFjOztBQVloQiwrQkFaRSxjQUFjLDZDQVlSOztRQUVILFFBQVEsR0FDTSxJQUFJLENBRGxCLFFBQVE7UUFBRSxlQUFlLEdBQ1gsSUFBSSxDQURSLGVBQWU7UUFBRSxZQUFZLEdBQ3pCLElBQUksQ0FEUyxZQUFZO1FBQUUsWUFBWSxHQUN2QyxJQUFJLENBRHVCLFlBQVk7UUFBRSxVQUFVLEdBQ25ELElBQUksQ0FEcUMsVUFBVTtRQUNqRSxJQUFJLEdBQVUsSUFBSSxDQUFsQixJQUFJO1FBQUUsSUFBSSxHQUFJLElBQUksQ0FBWixJQUFJOztBQUVmLFFBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0FBQ3pCLFFBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO0FBQ3ZDLFFBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxJQUFJLGNBQWMsQ0FBQyxZQUFZLENBQUM7QUFDaEUsUUFBSSxJQUFJLENBQUMsWUFBWSxLQUFLLGNBQWMsQ0FBQyxZQUFZLEVBQUU7QUFDckQsVUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLElBQUksS0FBSyxDQUFDO0FBQzFDLFVBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0FBQzdCLDBCQUFJLEtBQUssdUJBQXFCLElBQUksQ0FBQyxZQUFZLENBQUcsQ0FBQztLQUNwRDs7QUFFRCxRQUFJLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxXQUFXLENBQUM7QUFDaEMsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLElBQUksb0JBQW9CLENBQUM7R0FDMUM7Ozs7ZUE1QkcsY0FBYzs7V0E4QlosaUJBQUc7O0FBRVAsVUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7QUFDbEIsVUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7QUFDckIsVUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7QUFDdEIsVUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7OztBQUd6QixVQUFJLENBQUMsVUFBVSxHQUFHO0FBQ2hCLGdDQUF3QixFQUFFLG9CQUFFLElBQUk7QUFDaEMsaUNBQXlCLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO0FBQ3ZELDhDQUFzQyxFQUFFLG9CQUFFLElBQUk7QUFDOUMsb0NBQTRCLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO0FBQzFELHVDQUErQixFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztBQUNoRSxrQ0FBMEIsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7QUFDdkQseUNBQWlDLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7QUFDckUsa0JBQVUsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7T0FDckMsQ0FBQzs7QUFFRixVQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztLQUN2Qjs7O1dBRVEsb0JBQUc7QUFDViwwQkFBSSxLQUFLLENBQUMsdUJBQXVCLENBQUMsQ0FBQzs7QUFFbkMsVUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7QUFDbEIsVUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7QUFDckIsVUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7QUFDdEIsVUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7O0FBRXpCLFVBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDOztBQUVyQixVQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztLQUN2Qjs7O1dBRWE7VUFTTixPQUFPOzs7O0FBUmIsZ0JBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQzs7O0FBR2IsZ0JBQUksQ0FBQyxTQUFTLEdBQUcseUNBQTRCLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7OzZDQUM5RSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRTs7Ozs7NkNBSVIsSUFBSSxDQUFDLGdCQUFnQixFQUFFOzs7QUFBdkMsbUJBQU87O0FBQ1gsZ0NBQUksS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUM7Z0RBQy9CLE9BQU87Ozs7Ozs2Q0FFUixJQUFJLENBQUMsVUFBVSxFQUFFOzs7Z0RBQ2hCLElBQUk7Ozs7Ozs7S0FFZDs7O1dBRWdCOzs7Ozs2Q0FDVCxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRTs7O0FBQ2pDLGdCQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7QUFDaEIsZ0JBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxDQUFDOzs7Ozs7O0tBQ2xEOzs7V0FFVyx1QkFBRztBQUNiLGFBQU8sQ0FBQyxFQUFFLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQSxBQUFDLENBQUM7S0FDM0Q7OztXQUV3QixrQ0FBQyxJQUFJLEVBQUU7QUFDOUIsZUFBUyxjQUFjLENBQUUsR0FBRyxFQUFFLEtBQUssRUFBRTtBQUNuQyxZQUFJLG9CQUFFLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUN2QixpQkFBTyxZQUFZLENBQUM7U0FDckI7QUFDRCxZQUFJLEdBQUcsS0FBSyxVQUFVLElBQUksQ0FBQyxvQkFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7QUFDM0MsaUJBQU8sb0JBQW9CLENBQUM7U0FDN0I7QUFDRCxlQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7T0FDOUI7Ozs7OztBQUNELDBDQUF3QixvQkFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLDRHQUFFOzs7Y0FBL0IsR0FBRztjQUFFLElBQUk7O0FBQ2pCLDhCQUFJLEtBQUsscUJBQWtCLEdBQUcsUUFBSSxDQUFDOzs7Ozs7QUFDbkMsK0NBQXlCLG9CQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsaUhBQUU7OztrQkFBaEMsR0FBRztrQkFBRSxLQUFLOztBQUNsQixrQkFBSSxXQUFXLEdBQUcsY0FBYyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM3QyxrQ0FBSSxLQUFLLFVBQVEsR0FBRyxVQUFLLFdBQVcsQ0FBRyxDQUFDO2FBQ3pDOzs7Ozs7Ozs7Ozs7Ozs7U0FDRjs7Ozs7Ozs7Ozs7Ozs7O0tBQ0Y7OztXQUVzQjs7Ozs7Ozs2Q0FFUiwwQkFBWSxVQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUs7Ozs7QUFJNUMsa0JBQUksU0FBUyxHQUFHLFNBQVosU0FBUyxDQUFJLElBQUksRUFBSztBQUN4QixvQkFBSSxvQkFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksb0JBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7QUFDcEQsc0NBQUksS0FBSyxDQUFDLDJEQUEyRCxDQUFDLENBQUM7QUFDdkUseUJBQU8sT0FBTyxDQUFDLE1BQUssT0FBTyxDQUFDLENBQUM7aUJBQzlCO0FBQ0Qsb0JBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQzs7Ozs7Ozs7O0FBSWpCLHFEQUFpQixvQkFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLGlIQUFFO3dCQUF4QixJQUFJOzsyQ0FDTyw4QkFBZ0IsSUFBSSxDQUFDOzs7O3dCQUFsQyxFQUFFO3dCQUFFLEtBQUs7O0FBQ2QsMkJBQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUM7bUJBQ3JCOzs7Ozs7Ozs7Ozs7Ozs7OztBQUVELG9DQUFFLFFBQVEsQ0FBQyxNQUFLLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztBQUNsQyx1QkFBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2VBQ2xCLENBQUM7QUFDRixvQkFBSyxTQUFTLENBQUMsd0JBQXdCLENBQUMsc0NBQXNDLEVBQUUsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDOztBQUVuRyxrQ0FBSSxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztBQUM1QyxxQkFBTyxDQUFDO2lDQUNELFVBQVUsRUFBRSxXQUFXLEVBQUUsa0JBQWtCOzs7Ozs7dURBQVUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUM7Ozs7O0FBQTVGLGdDQUFVO0FBQUUsaUNBQVc7QUFBRSx3Q0FBa0I7O0FBQ2hELDBDQUFJLEtBQUssZ0JBQWMsVUFBVSxDQUFHLENBQUM7QUFDckMsMENBQUksS0FBSyxpQkFBZSxXQUFXLENBQUcsQ0FBQztBQUN2QywwQ0FBSSxLQUFLLDRCQUEwQixrQkFBa0IsQ0FBRyxDQUFDOzs7Ozs7O2dCQUMxRCxFQUFHLENBQUM7YUFDTixDQUFDOzs7Ozs7Ozs7O0tBQ0g7OztXQUVrQiw0QkFBQyxJQUFJLEVBQUU7OztBQUd4QixVQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDOzs4QkFDaEIsOEJBQWdCLElBQUksQ0FBQzs7OztVQUFsQyxFQUFFO1VBQUUsS0FBSzs7QUFDZCxVQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUU7O0FBRXBCLGFBQUssQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUM7T0FDNUM7QUFDRCxVQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQzs7O0FBR3pCLFVBQUksb0JBQUUsV0FBVyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRTtBQUNqQyxhQUFLLENBQUMsUUFBUSxHQUFHLCtCQUFpQixDQUFDO09BQ3BDOztBQUVELDBCQUFJLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0FBQzdDLFVBQUksQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7OztBQUc1QyxVQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtBQUNsQixZQUFJLENBQUMsUUFBUSxHQUFHLGdDQUFrQixJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO09BQ3RGO0tBQ0Y7OztXQUVlO1VBQUMsVUFBVSx5REFBRyxJQUFJO1VBQUUsUUFBUSx5REFBRyxrQkFBa0I7VUFBRSxtQkFBbUIseURBQUcsS0FBSzs7VUFReEYsUUFBUSxFQUFFLFFBQVEsRUFDSixDQUFDLEVBQ2IsY0FBYyx1RkFFVCxpQkFBaUIsaUJBZWxCLEtBQUssdUZBQ1UsT0FBTyx1RkFFZixJQUFJLEVBdUNqQixZQUFZLEVBU1osU0FBUyxFQUdULGFBQWEscUdBQ1AsR0FBRyxFQUFFLElBQUksRUFFYixFQUFFLHVGQUNHLElBQUksRUFFTCxTQUFROzs7OztBQXRGbEIsZ0NBQUksS0FBSyxDQUFDLHVCQUF1QixDQUFDLENBQUM7O2tCQUMvQixDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksb0JBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFBOzs7OztBQUNwRCxnQ0FBSSxLQUFLLENBQUMsc0NBQXNDLENBQUMsQ0FBQztnREFDM0MsRUFBRTs7O0FBSVAsb0JBQVEsY0FBRSxRQUFRO0FBQ0osYUFBQyxHQUFHLENBQUM7OztrQkFBRSxDQUFDLEdBQUcsUUFBUSxDQUFBOzs7OztBQUMvQiwwQkFBYyxHQUFHLHlDQUEyQixJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQzs7QUFDbEcsZ0NBQUksS0FBSyx1Q0FBcUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBRyxDQUFDOzs7OztzQ0FDN0MsY0FBYzs7Ozs7Ozs7QUFBbkMsNkJBQWlCOzs7QUFFdEIsZ0NBQUksS0FBSyxvQkFBa0IsaUJBQWlCLGdCQUFVLENBQUMsR0FBQyxDQUFDLENBQUEsWUFBTyxRQUFRLE9BQUksQ0FBQzs7NkNBQ2hELElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDOzs7OztBQUFyRyxvQkFBUTtBQUFFLG9CQUFROztpQkFHZixvQkFBRSxPQUFPLENBQUMsUUFBUSxDQUFDOzs7OztBQUNyQixnQ0FBSSxLQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQzs7Ozs7O0FBSzdELGdCQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsR0FBRyxnQ0FBa0IsUUFBUSxDQUFDLENBQUM7OztBQUcxRCxpQkFBSyxHQUFHLEtBQUs7Ozs7O3NDQUNhLG9CQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDOzs7Ozs7OztBQUFqQyxtQkFBTzs7aUJBQ3BCLEtBQUs7Ozs7Ozs7Ozs7OztzQ0FDUyxPQUFPLENBQUMsUUFBUSxJQUFJLEVBQUU7Ozs7Ozs7O0FBQS9CLGdCQUFJOztrQkFDUCxDQUFDLENBQUMsbUJBQW1CLElBQUksSUFBSSxDQUFDLEdBQUcsS0FBSyxhQUFhLENBQUEsS0FBTSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsR0FBRyxLQUFLLFVBQVUsQ0FBQSxDQUFDOzs7Ozs7QUFFbEcsb0JBQVEsR0FBRyxPQUFPLENBQUMsRUFBRSxDQUFDO0FBQ3RCLG9CQUFRLEdBQUcsSUFBSSxDQUFDO0FBQ2hCLGlCQUFLLEdBQUcsSUFBSSxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2dCQUtkLEtBQUs7Ozs7O0FBQ1IsZ0NBQUksS0FBSyx3Q0FBcUMsVUFBVSxzQ0FBa0MsQ0FBQztBQUMzRixvQkFBUSxHQUFHLElBQUksQ0FBQzs7Ozs7Ozs7OztBQU9sQixnQ0FBSSxLQUFLLCtFQUE2RCxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUF4Q3RDLGFBQUMsRUFBRTs7Ozs7OztBQThDMUMsZ0JBQUksQ0FBQyxRQUFRLEVBQUU7QUFDYixrQ0FBSSxhQUFhLDZDQUEyQyxRQUFRLGFBQVUsQ0FBQzthQUNoRjs7QUFFRCxnQkFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRTtBQUM5QixrQ0FBSSxLQUFLLCtDQUE0QyxJQUFJLENBQUMsUUFBUSxnQkFBUyxRQUFRLFFBQUksQ0FBQztBQUN4RixrQkFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7YUFDMUI7OztBQUdELGdCQUFJLENBQUMsU0FBUyxDQUFDLHdCQUF3QixDQUFDLHlCQUF5QixFQUFFLElBQUksRUFDaEUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzs7O0FBR2pDLHdCQUFZLEdBQUcsZUFBYyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQzNDLE1BQU0sQ0FBQyxVQUFDLEdBQUc7cUJBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTzthQUFBLENBQUMsQ0FDekQsR0FBRyxDQUFDLFVBQUMsR0FBRztxQkFBSyxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU87YUFBQSxDQUFDOztpQkFDakMsWUFBWSxDQUFDLE1BQU07Ozs7O0FBQ3JCLGdDQUFJLEtBQUssa0JBQWdCLFlBQVksQ0FBQyxNQUFNLDRCQUF5QixDQUFDOzs2Q0FDaEUsc0JBQVEsR0FBRyxDQUFDLENBQUMsc0JBQVEsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLHNCQUFRLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDOzs7QUFJbEUscUJBQVMsR0FBRyxnQ0FBa0IsUUFBUSxDQUFDOztBQUMzQyxnQ0FBSSxLQUFLLDRCQUEwQixJQUFJLENBQUMsUUFBUSxVQUFLLDhCQUFnQixTQUFTLENBQUMsQ0FBRyxDQUFDOztBQUUvRSx5QkFBYSxHQUFHLEVBQUU7Ozs7O3NDQUNFLG9CQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDOzs7Ozs7Ozs7QUFBckMsZUFBRztBQUFFLGdCQUFJOztnQkFDWixvQkFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQzs7Ozs7Ozs7QUFDekIsY0FBRSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQzs7Ozs7O0FBQ2hDLDJDQUFpQixJQUFJLENBQUMsUUFBUSx5R0FBRTtBQUF2QixrQkFBSTs7QUFDWCxrQkFBSSxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsbUJBQW1CLElBQUksSUFBSSxDQUFDLEdBQUcsS0FBSyxhQUFhLENBQUEsQUFBQyxLQUFLLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxHQUFHLEtBQUssVUFBVSxDQUFBLEFBQUMsRUFBRTtBQUM1Ryx5QkFBUSxHQUFHLG9CQUFFLEtBQUssQ0FBQyxJQUFJLENBQUM7O0FBQzVCLHlCQUFRLENBQUMsRUFBRSxHQUFNLEVBQUUsU0FBSSxTQUFRLENBQUMsRUFBRSxBQUFFLENBQUM7QUFDckMsNkJBQWEsQ0FBQyxJQUFJLENBQUMsU0FBUSxDQUFDLENBQUM7ZUFDOUI7YUFDRjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Z0RBR0ksYUFBYTs7Ozs7OztLQUNyQjs7O1dBRWdCLG9CQUFDLFFBQVEsRUFBRSxTQUFTO1VBQUUsY0FBYyx5REFBRyxLQUFLO1VBb0J2RCxLQUFLOzs7O0FBbkJULGdCQUFJLENBQUMsUUFBUSxZQUFVLFFBQVEsQUFBRSxDQUFDO0FBQ2xDLGdCQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQzs7QUFFM0IsZ0NBQUksS0FBSyx1QkFBb0IsU0FBUyxvQkFBYSxJQUFJLENBQUMsUUFBUSxvQ0FBZ0MsQ0FBQzs7OzZDQUUzRixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUU7QUFDeEMsc0JBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtBQUN2Qix1QkFBUyxFQUFFLElBQUksQ0FBQyxTQUFTO2FBQzFCLENBQUM7OztBQUNGLGdDQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDOzs7NkNBRXRCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtBQUN0QyxzQkFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO0FBQ3ZCLHVCQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7QUFDekIsMEJBQVksRUFBRSxJQUFJLENBQUMsWUFBWTthQUNoQyxDQUFDOzs7QUFDRixnQ0FBSSxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQzs7Ozs2Q0FHcEIsSUFBSSxDQUFDLGdCQUFnQixFQUFFOzs7QUFBckMsaUJBQUs7O2tCQUNMLENBQUMsY0FBYyxJQUFJLENBQUMsS0FBSyxDQUFBOzs7Ozs7NkNBQ3JCLElBQUksQ0FBQyxVQUFVLEVBQUU7Ozs7Ozs7S0FFMUI7OztXQUVpQixxQkFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU07VUFHL0IsTUFBTSxFQUVOLEtBQUs7Ozs7Z0JBSkosSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTOzs7OztrQkFBUSxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQzs7Ozs2Q0FFL0QsK0JBQWlCLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDOzs7QUFBbkQsa0JBQU07OzZDQUVRLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQzs7O0FBQXhDLGlCQUFLOztBQUNULGdDQUFJLEtBQUssaUNBQThCLElBQUksc0JBQWdCLDhCQUFnQixLQUFLLENBQUMsQ0FBRyxDQUFDO2dEQUM5RSxLQUFLOzs7Ozs7O0tBQ2I7OztXQUVzQiwwQkFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxXQUFXO1VBQ2pELGFBQWEsRUFJYixNQUFNOzs7O0FBSk4seUJBQWEsR0FBRyxxRkFDeUIsV0FBVyxnQkFBVyxzRUFDZ0IseUJBQ3pDOzs2Q0FDdkIsK0JBQWlCLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLGFBQWEsQ0FBQzs7O0FBQWxFLGtCQUFNOzs2Q0FDSixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQzs7Ozs7OztLQUMzQjs7O1dBRWMsa0JBQUMsZUFBZTtVQUN6QixTQUFTLEVBQ1QsS0FBSyxFQUdMLE1BQU07Ozs7OztBQUpOLHFCQUFTLEdBQUcsR0FBRztBQUNmLGlCQUFLLEdBQUcsZUFBZSxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUU7O0FBQ3pDLGdDQUFJLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDOztBQUU5QyxrQkFBTSxHQUFHLFNBQVQsTUFBTTtrQkFrQkosS0FBSzs7OztBQWpCVCx3QkFBSSxDQUFDLGFBQWEsR0FBRyxvQkFBSyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQzs7O3FEQUU5QyxJQUFJLENBQUMsYUFBYTs7Ozs7Ozs7OzswQkFFcEIsMEJBQWUsc0JBQVEsaUJBQWlCLENBQUE7Ozs7Ozs7O3dCQVF6QyxJQUFJLENBQUMsUUFBUTs7Ozs7QUFDaEIsd0NBQUksS0FBSyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7Ozs7O3FEQUlqRCxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7OztBQUFyQyx5QkFBSzs7MEJBR0wsS0FBSyxJQUFLLElBQUksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxJQUFJLEFBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLEdBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDOzs7OztBQUMxRSx3Q0FBSSxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDM0Isd0JBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDOzs7OztBQUV6Qix3Q0FBSSxLQUFLLENBQUMsOEJBQThCLENBQUMsQ0FBQzs7cURBQ3BDLE1BQU0sRUFBRTs7Ozs7OzthQUVqQjs7OzZDQUNLLE1BQU0sRUFBRTs7Ozs7OztLQUNmOzs7V0FFb0I7Ozs7QUFDbkIsZ0NBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7QUFDN0QsZ0JBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO0FBQ3pCLGdCQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7QUFDdEIsa0JBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUM7YUFDN0I7Ozs7Ozs7S0FDRjs7O1dBRWdCOzs7O0FBQ2YsZ0NBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDNUIsZ0JBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDOzs2Q0FDbEIsSUFBSSxDQUFDLFVBQVUsRUFBRTs7Ozs7OztLQUN4Qjs7O1dBRWdCLG9CQUFDLGVBQWU7Ozs7QUFDL0IsZ0NBQUksS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7OzZDQUMxQixJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQzs7Ozs7OztLQUNyQzs7O1dBRXNCO1VBQ2pCLE1BQU0sRUFJTixRQUFRLEVBQ1IsVUFBVTs7OztBQUxWLGtCQUFNLEdBQUcsMEJBQVksRUFBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBQyxDQUFDOztpQkFDL0MsTUFBTTs7Ozs7a0JBQVEsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDOzs7O0FBRW5DLGdDQUFJLEtBQUssQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0FBQ3RDLG9CQUFRLEdBQUcsZ0RBQWdEOzs2Q0FDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDOzs7QUFBL0Msc0JBQVU7O0FBQ2QsZ0NBQUksS0FBSyxxQkFBbUIsOEJBQWdCLFVBQVUsQ0FBQyxDQUFHLENBQUM7O2dEQUVwRCxVQUFVLEtBQUssVUFBVTs7Ozs7OztLQUNqQzs7O1dBRWMsa0JBQUMsR0FBRztVQUdYLE9BQU07Ozs7O2tCQURSLElBQUksQ0FBQyxZQUFZLEtBQUssY0FBYyxDQUFDLFlBQVksQ0FBQTs7Ozs7QUFDL0MsbUJBQU0sR0FBRywwQkFBWSxFQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFDLENBQUM7O2lCQUMxRSxPQUFNOzs7OztrQkFBUSxJQUFJLEtBQUssQ0FBQyxPQUFNLENBQUM7Ozs7QUFHckMsZ0NBQUksS0FBSyw2QkFBMkIsR0FBRyxDQUFHLENBQUM7OzZDQUNyQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7QUFDbEMsaUJBQUcsRUFBSCxHQUFHO0FBQ0gsc0JBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtBQUN2Qix1QkFBUyxFQUFFLElBQUksQ0FBQyxTQUFTO0FBQ3pCLDBCQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVk7YUFDaEMsQ0FBQzs7O2dCQUVHLElBQUksQ0FBQyxZQUFZOzs7Ozs7NkNBRWQsc0JBQVEsS0FBSyxDQUFDLElBQUksQ0FBQzs7O2tCQUd2QixJQUFJLENBQUMsWUFBWSxLQUFLLGNBQWMsQ0FBQyxZQUFZLENBQUE7Ozs7Ozs2Q0FDN0MsSUFBSSxDQUFDLHFCQUFxQixFQUFFOzs7OzZDQUU5QixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQzs7Ozs7OztLQUNsQzs7O1dBRTJCOzs7Ozs7Z0RBQ25CLDBCQUFZLG9CQUFPLE9BQU8sRUFBRSxNQUFNO2tCQUVuQyxPQUFPLEVBSVAsZ0JBQWdCLEVBYWQsT0FBTzs7Ozs7O0FBbEJiLHdDQUFJLEtBQUssQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDO0FBQ2hELDJCQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRTs7QUFJcEIsb0NBQWdCLEdBQUcsU0FBbkIsZ0JBQWdCLENBQUksS0FBSyxFQUFLO0FBQ2hDLDBDQUFJLEtBQUsseUJBQXdCLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLE9BQU8sQ0FBQSxHQUFFLElBQUksMEJBQXNCLEtBQUssQ0FBRyxDQUFDO0FBQzNGLDBCQUFJLE9BQUssZUFBZSxFQUFFO0FBQ3hCLCtCQUFLLGVBQWUsQ0FBQyxNQUFNLEVBQUUsQ0FBQzt1QkFDL0I7QUFDRCw2QkFBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO3FCQUNoQjs7QUFDRCx3QkFBSSxDQUFDLFNBQVMsQ0FBQyx3QkFBd0IsQ0FBQyxxQkFBcUIsRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQzs7Ozs7MEJBSXJGLENBQUMsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsQ0FBQTs7Ozs7QUFFeEMsMkJBQU8sR0FBRyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxVQUFVLEdBQUcsR0FBRzs7QUFDdkQsd0JBQUksQ0FBQyxlQUFlLEdBQUcsb0JBQUssZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7OztxREFFOUMsSUFBSSxDQUFDLGVBQWU7OztBQUMxQixvQ0FBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQzs7Ozs7Ozs7Ozs7OzthQU9qQyxDQUFDOzs7Ozs7O0tBQ0g7Ozs7Ozs7V0FFbUIsdUJBQUMsRUFBRTs7OztBQUNyQixnQ0FBSSxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQztBQUM3QyxnQkFBSSxDQUFDLFNBQVMsQ0FBQyx1QkFBdUIsQ0FBQyxFQUFFLENBQUMsQ0FBQzs7NkNBQzlCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRTtBQUNoRCxzQkFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO0FBQ3ZCLHVCQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7QUFDekIsMEJBQVksRUFBRSxJQUFJLENBQUMsWUFBWTthQUNoQyxDQUFDOzs7Ozs7Ozs7O0tBQ0g7OztXQUVrQjs7OztBQUNqQixnQ0FBSSxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQzs7NkNBQ3ZDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtBQUN4QyxzQkFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO0FBQ3ZCLHVCQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7QUFDekIsMEJBQVksRUFBRSxJQUFJLENBQUMsWUFBWTthQUNoQyxDQUFDOzs7Ozs7O0tBQ0g7OztXQUVhLGlCQUFDLE9BQU8sRUFBRSxRQUFRO1VBU3hCLFFBQU0sRUFLUixHQUFHOzs7OztrQkFaSCxJQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsUUFBUSxDQUFBOzs7OztBQUMvQixnQ0FBSSxLQUFLLENBQUMsMkNBQTJDLENBQUMsQ0FBQzs7NkNBQ2pELElBQUksQ0FBQyxVQUFVLEVBQUU7OztrQkFJckIsSUFBSSxDQUFDLFlBQVksS0FBSyxjQUFjLENBQUMsWUFBWSxDQUFBOzs7OztBQUMvQyxvQkFBTSxHQUFHLDBCQUFZLEVBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUMsQ0FBQzs7aUJBQzFFLFFBQU07Ozs7O2tCQUFRLElBQUksS0FBSyxDQUFDLFFBQU0sQ0FBQzs7OztBQUdyQyxnQ0FBSSxLQUFLLGlDQUErQixvQkFBRSxRQUFRLENBQUMsT0FBTyxFQUFFLEVBQUMsTUFBTSxFQUFFLEVBQUUsRUFBQyxDQUFDLENBQUcsQ0FBQzs7NkNBQzdELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRTtBQUNuRCxxQkFBTyxFQUFQLE9BQU87QUFDUCxzQkFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO0FBQ3ZCLHVCQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7QUFDekIsMEJBQVksRUFBRSxJQUFJLENBQUMsWUFBWTthQUNoQyxDQUFDOzs7QUFMRSxlQUFHO2dEQU9BLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDOzs7Ozs7O0tBQy9COzs7V0FFa0Isc0JBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxJQUFJO1VBQzdCLE1BQU0sRUFJTixHQUFHOzs7O0FBSkgsa0JBQU0sR0FBRywwQkFBWSxFQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFDLENBQUM7O2lCQUMxRSxNQUFNOzs7OztrQkFBUSxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUM7Ozs7QUFFbkMsZ0NBQUksS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7OzZDQUN6QixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtBQUNwRCxtQkFBSyxFQUFMLEtBQUs7QUFDTCxnQkFBRSxFQUFGLEVBQUU7QUFDRixrQkFBSSxFQUFKLElBQUk7QUFDSixzQkFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO0FBQ3ZCLHVCQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7QUFDekIsMEJBQVksRUFBRSxJQUFJLENBQUMsWUFBWTthQUNoQyxDQUFDOzs7QUFQRSxlQUFHO2dEQVNBLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDOzs7Ozs7O0tBQy9COzs7V0FFYSx1QkFBQyxHQUFHLEVBQUU7QUFDbEIsVUFBSSxvQkFBRSxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDdEIsY0FBTSxJQUFJLEtBQUssOERBQTRELDhCQUFnQixHQUFHLENBQUMsQ0FBRyxDQUFDO09BQ3BHLE1BQU0sSUFBSSxvQkFBRSxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDMUIsWUFBSTtBQUNGLGFBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3ZCLENBQUMsT0FBTyxHQUFHLEVBQUU7OztTQUdiO09BQ0YsTUFBTSxJQUFJLENBQUMsb0JBQUUsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQzNCLGdCQUFNLElBQUksS0FBSyxtQ0FBaUMsT0FBTyxHQUFHLFFBQUssQ0FBQztTQUNqRTs7QUFFRCxVQUFJLEdBQUcsQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7O0FBRWxDLFlBQUksT0FBTyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUM7QUFDN0MsY0FBTSxJQUFJLHlCQUFPLGVBQWUsQ0FBSSxPQUFPLGtCQUFhLEdBQUcsQ0FBQyxNQUFNLE9BQUksQ0FBQztPQUN4RTs7OztBQUlELGFBQU8sR0FBRyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQztLQUN0RDs7O1dBRWtDO1VBQUMsS0FBSyx5REFBRyxJQUFJOzs7O0FBQzlDLGdCQUFJLENBQUMsU0FBUyxDQUFDLDRCQUE0QixDQUFDLEtBQUssQ0FBQyxDQUFDOzs7Ozs7O0tBQ3BEOzs7U0FqaEJHLGNBQWM7R0FBUyxvQkFBTyxZQUFZOztBQXFoQmhELGNBQWMsQ0FBQyxpQkFBaUIsR0FBRyw2QkFBNkIsQ0FBQztBQUNqRSxjQUFjLENBQUMsZ0JBQWdCLEdBQUcsNEJBQTRCLENBQUM7Ozs7Ozs7O0FBRy9ELHFDQUE0QixvQkFBRSxPQUFPLDhCQUFpQixpSEFBRTs7O1FBQTlDLEtBQUk7UUFBRSxPQUFPOztBQUNyQixrQkFBYyxDQUFDLFNBQVMsQ0FBQyxLQUFJLENBQUMsR0FBRyxPQUFPLENBQUM7R0FDMUM7Ozs7Ozs7Ozs7Ozs7Ozs7UUFFUSxjQUFjLEdBQWQsY0FBYztRQUFFLGNBQWMsR0FBZCxjQUFjO1FBQUUsb0JBQW9CLEdBQXBCLG9CQUFvQjtRQUFFLHVCQUF1QixHQUF2Qix1QkFBdUIiLCJmaWxlIjoibGliL3JlbW90ZS1kZWJ1Z2dlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptYWluXG4vLyBqc2hpbnQgaWdub3JlOiBzdGFydFxuaW1wb3J0IGV2ZW50cyBmcm9tICdldmVudHMnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IFJlbW90ZURlYnVnZ2VyUnBjQ2xpZW50IGZyb20gJy4vcmVtb3RlLWRlYnVnZ2VyLXJwYy1jbGllbnQnO1xuaW1wb3J0IG1lc3NhZ2VIYW5kbGVycyBmcm9tICcuL21lc3NhZ2UtaGFuZGxlcnMnO1xuaW1wb3J0IHsgYXBwSW5mb0Zyb21EaWN0LCBwYWdlQXJyYXlGcm9tRGljdCwgZ2V0RGVidWdnZXJBcHBLZXksIGdldFBvc3NpYmxlRGVidWdnZXJBcHBLZXlzLCBjaGVja1BhcmFtcyxcbiAgICAgICAgIGdldFNjcmlwdEZvckF0b20sIHNpbXBsZVN0cmluZ2lmeSwgZGVmZXJyZWRQcm9taXNlIH0gZnJvbSAnLi9oZWxwZXJzJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbmNvbnN0IERFQlVHR0VSX1RZUEVTID0ge1xuICB3ZWJraXQ6IDEsXG4gIHdlYmluc3BlY3RvcjogMlxufTtcbmNvbnN0IFNFTEVDVF9BUFBfUkVUUklFUyA9IDIwO1xuY29uc3QgUkVNT1RFX0RFQlVHR0VSX1BPUlQgPSAyNzc1MztcblxuLyogSG93IG1hbnkgbWlsbGlzZWNvbmRzIHRvIHdhaXQgZm9yIHdlYmtpdCB0byByZXR1cm4gYSByZXNwb25zZSBiZWZvcmUgdGltaW5nIG91dCAqL1xuY29uc3QgUlBDX1JFU1BPTlNFX1RJTUVPVVRfTVMgPSA1MDAwO1xuXG5cbmNsYXNzIFJlbW90ZURlYnVnZ2VyIGV4dGVuZHMgZXZlbnRzLkV2ZW50RW1pdHRlciB7XG4gIC8qXG4gICAqIFRoZSBjb25zdHJ1Y3RvciB0YWtlcyBhbiBvcHRzIGhhc2ggd2l0aCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6XG4gICAqICAgLSBidW5kbGVJZCAtIGlkIG9mIHRoZSBhcHAgYmVpbmcgY29ubmVjdGVkIHRvXG4gICAqICAgLSBwbGF0Zm9ybVZlcnNpb24gLSB2ZXJzaW9uIG9mIGlPU1xuICAgKiAgIC0gZGVidWdnZXJUeXBlIC0gb25lIG9mIHRoZSBERUJVR0dFUl9UWVBFU1xuICAgKiAgIC0gdXNlTmV3U2FmYXJpIC0gZm9yIHdlYiBpbnNwZWN0b3IsIHdoZXRoZXIgdGhpcyBpcyBhIG5ldyBTYWZhcmkgaW5zdGFuY2VcbiAgICogICAtIHBhZ2VMb2FkTXMgLSB0aGUgdGltZSwgaW4gbXMsIHRoYXQgc2hvdWxkIGJlIHdhaXRlZCBmb3IgcGFnZSBsb2FkaW5nXG4gICAqICAgLSBob3N0IC0gdGhlIHJlbW90ZSBkZWJ1Z2dlcidzIGhvc3QgYWRkcmVzc1xuICAgKiAgIC0gcG9ydCAtIHRoZSByZW1vdGUgZGVidWdnZXIgcG9ydCB0aHJvdWdoIHdoaWNoIHRvIGNvbW11bmljYXRlXG4gICAqL1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgc3VwZXIoKTtcblxuICAgIGxldCB7YnVuZGxlSWQsIHBsYXRmb3JtVmVyc2lvbiwgZGVidWdnZXJUeXBlLCB1c2VOZXdTYWZhcmksIHBhZ2VMb2FkTXMsXG4gICAgICAgICBob3N0LCBwb3J0fSA9IG9wdHM7XG5cbiAgICB0aGlzLmJ1bmRsZUlkID0gYnVuZGxlSWQ7XG4gICAgdGhpcy5wbGF0Zm9ybVZlcnNpb24gPSBwbGF0Zm9ybVZlcnNpb247XG4gICAgdGhpcy5kZWJ1Z2dlclR5cGUgPSBkZWJ1Z2dlclR5cGUgfHwgREVCVUdHRVJfVFlQRVMud2ViaW5zcGVjdG9yO1xuICAgIGlmICh0aGlzLmRlYnVnZ2VyVHlwZSA9PT0gREVCVUdHRVJfVFlQRVMud2ViaW5zcGVjdG9yKSB7XG4gICAgICB0aGlzLnVzZU5ld1NhZmFyaSA9IHVzZU5ld1NhZmFyaSB8fCBmYWxzZTtcbiAgICAgIHRoaXMucGFnZUxvYWRNcyA9IHBhZ2VMb2FkTXM7XG4gICAgICBsb2cuZGVidWcoYHVzZU5ld1NhZmFyaSAtLT4gJHt0aGlzLnVzZU5ld1NhZmFyaX1gKTtcbiAgICB9XG5cbiAgICB0aGlzLmhvc3QgPSBob3N0IHx8ICdsb2NhbGhvc3QnO1xuICAgIHRoaXMucG9ydCA9IHBvcnQgfHwgUkVNT1RFX0RFQlVHR0VSX1BPUlQ7XG4gIH1cblxuICBzZXR1cCAoKSB7XG4gICAgLy8gYXBwIGhhbmRsaW5nIGNvbmZpZ3VyYXRpb25cbiAgICB0aGlzLmFwcERpY3QgPSB7fTtcbiAgICB0aGlzLmFwcElkS2V5ID0gbnVsbDtcbiAgICB0aGlzLnBhZ2VJZEtleSA9IG51bGw7XG4gICAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuXG4gICAgLy8gc2V0IHVwIHRoZSBzcGVjaWFsIGNhbGxiYWNrcyBmb3IgaGFuZGxpbmcgcmQgZXZlbnRzXG4gICAgdGhpcy5zcGVjaWFsQ2JzID0ge1xuICAgICAgJ19ycGNfcmVwb3J0SWRlbnRpZmllcjonOiBfLm5vb3AsXG4gICAgICAnX3JwY19mb3J3YXJkR2V0TGlzdGluZzonOiB0aGlzLm9uUGFnZUNoYW5nZS5iaW5kKHRoaXMpLFxuICAgICAgJ19ycGNfcmVwb3J0Q29ubmVjdGVkQXBwbGljYXRpb25MaXN0Oic6IF8ubm9vcCxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOic6IHRoaXMub25BcHBDb25uZWN0LmJpbmQodGhpcyksXG4gICAgICAnX3JwY19hcHBsaWNhdGlvbkRpc2Nvbm5lY3RlZDonOiB0aGlzLm9uQXBwRGlzY29ubmVjdC5iaW5kKHRoaXMpLFxuICAgICAgJ19ycGNfYXBwbGljYXRpb25VcGRhdGVkOic6IHRoaXMub25BcHBVcGRhdGUuYmluZCh0aGlzKSxcbiAgICAgICdfcnBjX3JlcG9ydENvbm5lY3RlZERyaXZlckxpc3Q6JzogdGhpcy5vblJlcG9ydERyaXZlckxpc3QuYmluZCh0aGlzKSxcbiAgICAgICdwYWdlTG9hZCc6IHRoaXMucGFnZUxvYWQuYmluZCh0aGlzKSxcbiAgICB9O1xuXG4gICAgdGhpcy5ycGNDbGllbnQgPSBudWxsO1xuICB9XG5cbiAgdGVhcmRvd24gKCkge1xuICAgIGxvZy5kZWJ1ZygnQ2xlYW5pbmcgdXAgbGlzdGVuZXJzJyk7XG5cbiAgICB0aGlzLmFwcERpY3QgPSB7fTtcbiAgICB0aGlzLmFwcElkS2V5ID0gbnVsbDtcbiAgICB0aGlzLnBhZ2VJZEtleSA9IG51bGw7XG4gICAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuXG4gICAgdGhpcy5zcGVjaWFsQ2JzID0ge307XG5cbiAgICB0aGlzLnJwY0NsaWVudCA9IG51bGw7XG4gIH1cblxuICBhc3luYyBjb25uZWN0ICgpIHtcbiAgICB0aGlzLnNldHVwKCk7XG5cbiAgICAvLyBpbml0aWFsaXplIHRoZSBycGMgY2xpZW50IGZvclxuICAgIHRoaXMucnBjQ2xpZW50ID0gbmV3IFJlbW90ZURlYnVnZ2VyUnBjQ2xpZW50KHRoaXMuaG9zdCwgdGhpcy5wb3J0LCB0aGlzLnNwZWNpYWxDYnMpO1xuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LmNvbm5lY3QoKTtcblxuICAgIC8vIGdldCB0aGUgY29ubmVjdGlvbiBpbmZvcm1hdGlvbiBhYm91dCB0aGUgYXBwXG4gICAgdHJ5IHtcbiAgICAgIGxldCBhcHBJbmZvID0gYXdhaXQgdGhpcy5zZXRDb25uZWN0aW9uS2V5KCk7XG4gICAgICBsb2cuZGVidWcoJ0Nvbm5lY3RlZCB0byBhcHBsaWNhdGlvbicpO1xuICAgICAgcmV0dXJuIGFwcEluZm87XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBhd2FpdCB0aGlzLmRpc2Nvbm5lY3QoKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRpc2Nvbm5lY3QgKCkge1xuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LmRpc2Nvbm5lY3QoKTtcbiAgICB0aGlzLnRlYXJkb3duKCk7XG4gICAgdGhpcy5lbWl0KFJlbW90ZURlYnVnZ2VyLkVWRU5UX0RJU0NPTk5FQ1QsIHRydWUpO1xuICB9XG5cbiAgaXNDb25uZWN0ZWQgKCkge1xuICAgIHJldHVybiAhISh0aGlzLnJwY0NsaWVudCAmJiB0aGlzLnJwY0NsaWVudC5pc0Nvbm5lY3RlZCgpKTtcbiAgfVxuXG4gIGxvZ0FwcGxpY2F0aW9uRGljdGlvbmFyeSAoYXBwcykge1xuICAgIGZ1bmN0aW9uIGdldFZhbHVlU3RyaW5nIChrZXksIHZhbHVlKSB7XG4gICAgICBpZiAoXy5pc0Z1bmN0aW9uKHZhbHVlKSkge1xuICAgICAgICByZXR1cm4gJ1tGdW5jdGlvbl0nO1xuICAgICAgfVxuICAgICAgaWYgKGtleSA9PT0gJ3BhZ2VEaWN0JyAmJiAhXy5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgICByZXR1cm4gJ1wiV2FpdGluZyBmb3IgZGF0YVwiJztcbiAgICAgIH1cbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gICAgfVxuICAgIGZvciAobGV0IFthcHAsIGluZm9dIG9mIF8udG9QYWlycyhhcHBzKSkge1xuICAgICAgbG9nLmRlYnVnKGBBcHBsaWNhdGlvbjogJyR7YXBwfSdgKTtcbiAgICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBfLnRvUGFpcnMoaW5mbykpIHtcbiAgICAgICAgbGV0IHZhbHVlU3RyaW5nID0gZ2V0VmFsdWVTdHJpbmcoa2V5LCB2YWx1ZSk7XG4gICAgICAgIGxvZy5kZWJ1ZyhgICAgICR7a2V5fTogJHt2YWx1ZVN0cmluZ31gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBzZXRDb25uZWN0aW9uS2V5ICgpIHtcbiAgICAvLyBvbmx5IHJlc29sdmUgd2hlbiB0aGUgY29ubmVjdGlvbiByZXNwb25zZSBpcyByZWNlaXZlZFxuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBsb2NhbCBjYWxsYmFjaywgY2FsbGVkIHdoZW4gdGhlIHJlbW90ZSBkZWJ1Z2dlciBoYXMgZXN0YWJsaXNoZWRcbiAgICAgIC8vIGEgY29ubmVjdGlvbiB0byB0aGUgYXBwIHVuZGVyIHRlc3RcbiAgICAgIC8vIGBhcHBgIHdpbGwgYmUgYW4gYXJyYXkgb2YgZGljdGlvbmFyaWVzIG9mIGFwcCBpbmZvcm1hdGlvblxuICAgICAgbGV0IGNvbm5lY3RDYiA9IChhcHBzKSA9PiB7XG4gICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKGFwcHMpIHx8IF8ua2V5cyhhcHBzKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBsb2cuZGVidWcoJ1JlY2VpdmVkIG5vIGFwcHMgZnJvbSByZW1vdGUgZGVidWdnZXIuIFVuYWJsZSB0byBjb25uZWN0LicpO1xuICAgICAgICAgIHJldHVybiByZXNvbHZlKHRoaXMuYXBwRGljdCk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IG5ld0RpY3QgPSB7fTtcblxuICAgICAgICAvLyB0cmFuc2xhdGUgdGhlIHJlY2VpdmVkIGluZm9ybWF0aW9uIGludG8gYW4gZWFzaWVyLXRvLW1hbmFnZVxuICAgICAgICAvLyBoYXNoIHdpdGggYXBwIGlkIGFzIGtleSwgYW5kIGFwcCBpbmZvIGFzIHZhbHVlXG4gICAgICAgIGZvciAobGV0IGRpY3Qgb2YgXy52YWx1ZXMoYXBwcykpIHtcbiAgICAgICAgICBsZXQgW2lkLCBlbnRyeV0gPSBhcHBJbmZvRnJvbURpY3QoZGljdCk7XG4gICAgICAgICAgbmV3RGljdFtpZF0gPSBlbnRyeTtcbiAgICAgICAgfVxuICAgICAgICAvLyB1cGRhdGUgdGhlIG9iamVjdCdzIGxpc3Qgb2YgYXBwcywgYW5kIHJldHVybiBpdCB0aHJvdWdoIHRoZSBwcm9taXNlXG4gICAgICAgIF8uZGVmYXVsdHModGhpcy5hcHBEaWN0LCBuZXdEaWN0KTtcbiAgICAgICAgcmVzb2x2ZShuZXdEaWN0KTtcbiAgICAgIH07XG4gICAgICB0aGlzLnJwY0NsaWVudC5zZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoJ19ycGNfcmVwb3J0Q29ubmVjdGVkQXBwbGljYXRpb25MaXN0OicsIHJlamVjdCwgY29ubmVjdENiKTtcblxuICAgICAgbG9nLmRlYnVnKCdTZW5kaW5nIGNvbm5lY3Rpb24ga2V5IHJlcXVlc3QnKTtcbiAgICAgIHJldHVybiAoYXN5bmMgKCkgPT4ge1xuICAgICAgICBsZXQgW3NpbU5hbWVLZXksIHNpbUJ1aWxkS2V5LCBzaW1QbGF0Zm9ybVZlcnNpb25dID0gYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnc2V0Q29ubmVjdGlvbktleScpO1xuICAgICAgICBsb2cuZGVidWcoYFNpbSBuYW1lOiAke3NpbU5hbWVLZXl9YCk7XG4gICAgICAgIGxvZy5kZWJ1ZyhgU2ltIGJ1aWxkOiAke3NpbUJ1aWxkS2V5fWApO1xuICAgICAgICBsb2cuZGVidWcoYFNpbSBwbGF0Zm9ybSB2ZXJzaW9uOiAke3NpbVBsYXRmb3JtVmVyc2lvbn1gKTtcbiAgICAgIH0pKCk7XG4gICAgfSk7XG4gIH1cblxuICB1cGRhdGVBcHBzV2l0aERpY3QgKGRpY3QpIHtcbiAgICAvLyBnZXQgdGhlIGRpY3Rpb25hcnkgZW50cnkgaW50byBhIG5pY2UgZm9ybSwgYW5kIGFkZCBpdCB0byB0aGVcbiAgICAvLyBhcHBsaWNhdGlvbiBkaWN0aW9uYXJ5XG4gICAgdGhpcy5hcHBEaWN0ID0gdGhpcy5hcHBEaWN0IHx8IHt9O1xuICAgIGxldCBbaWQsIGVudHJ5XSA9IGFwcEluZm9Gcm9tRGljdChkaWN0KTtcbiAgICBpZiAodGhpcy5hcHBEaWN0W2lkXSkge1xuICAgICAgLy8gcHJlc2VydmUgdGhlIHBhZ2UgZGljdGlvbmFyeSBmb3IgdGhpcyBlbnRyeVxuICAgICAgZW50cnkucGFnZURpY3QgPSB0aGlzLmFwcERpY3RbaWRdLnBhZ2VEaWN0O1xuICAgIH1cbiAgICB0aGlzLmFwcERpY3RbaWRdID0gZW50cnk7XG5cbiAgICAvLyBhZGQgYSBwcm9taXNlIHRvIGdldCB0aGUgcGFnZSBkaWN0aW9uYXJ5XG4gICAgaWYgKF8uaXNVbmRlZmluZWQoZW50cnkucGFnZURpY3QpKSB7XG4gICAgICBlbnRyeS5wYWdlRGljdCA9IGRlZmVycmVkUHJvbWlzZSgpO1xuICAgIH1cblxuICAgIGxvZy5kZWJ1ZygnQ3VycmVudCBhcHBsaWNhdGlvbnMgYXZhaWxhYmxlOicpO1xuICAgIHRoaXMubG9nQXBwbGljYXRpb25EaWN0aW9uYXJ5KHRoaXMuYXBwRGljdCk7XG5cbiAgICAvLyB0cnkgdG8gZ2V0IHRoZSBhcHAgaWQgZnJvbSBvdXIgY29ubmVjdGVkIGFwcHNcbiAgICBpZiAoIXRoaXMuYXBwSWRLZXkpIHtcbiAgICAgIHRoaXMuYXBwSWRLZXkgPSBnZXREZWJ1Z2dlckFwcEtleSh0aGlzLmJ1bmRsZUlkLCB0aGlzLnBsYXRmb3JtVmVyc2lvbiwgdGhpcy5hcHBEaWN0KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZWxlY3RBcHAgKGN1cnJlbnRVcmwgPSBudWxsLCBtYXhUcmllcyA9IFNFTEVDVF9BUFBfUkVUUklFUywgaWdub3JlQWJvdXRCbGFua1VybCA9IGZhbHNlKSB7XG4gICAgbG9nLmRlYnVnKCdTZWxlY3RpbmcgYXBwbGljYXRpb24nKTtcbiAgICBpZiAoIXRoaXMuYXBwRGljdCB8fCBfLmtleXModGhpcy5hcHBEaWN0KS5sZW5ndGggPT09IDApIHtcbiAgICAgIGxvZy5kZWJ1ZygnTm8gYXBwbGljYXRpb25zIGN1cnJlbnRseSBjb25uZWN0ZWQuJyk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgLy8gaXRlcmF0aXZlIHNvbHV0aW9uLCBhcyByZWN1cnNpb24gd2FzIHN3YWxsb3dpbmcgdGhlIHByb21pc2UgYXQgc29tZSBwb2ludFxuICAgIGxldCBwYWdlRGljdCwgYXBwSWRLZXk7XG4gICAgYXBwTG9vcDogZm9yIChsZXQgaSA9IDA7IGkgPCBtYXhUcmllczsgaSsrKSB7XG4gICAgICBsZXQgcG9zc2libGVBcHBJZHMgPSBnZXRQb3NzaWJsZURlYnVnZ2VyQXBwS2V5cyh0aGlzLmJ1bmRsZUlkLCB0aGlzLnBsYXRmb3JtVmVyc2lvbiwgdGhpcy5hcHBEaWN0KTtcbiAgICAgIGxvZy5kZWJ1ZyhgVHJ5aW5nIG91dCB0aGUgcG9zc2libGUgYXBwIGlkczogJHtwb3NzaWJsZUFwcElkcy5qb2luKCcsICcpfWApO1xuICAgICAgZm9yIChsZXQgYXR0ZW1wdGVkQXBwSWRLZXkgb2YgcG9zc2libGVBcHBJZHMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBsb2cuZGVidWcoYFNlbGVjdGluZyBhcHAgJHthdHRlbXB0ZWRBcHBJZEtleX0gKHRyeSAjJHtpKzF9IG9mICR7bWF4VHJpZXN9KWApO1xuICAgICAgICAgIFthcHBJZEtleSwgcGFnZURpY3RdID0gYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VsZWN0QXBwKGF0dGVtcHRlZEFwcElkS2V5LCB0aGlzLm9uQXBwQ29ubmVjdC5iaW5kKHRoaXMpKTtcbiAgICAgICAgICAvLyBpbiBpT1MgOC4yIHRoZSBjb25uZWN0IGxvZ2ljIGhhcHBlbnMsIGJ1dCB3aXRoIGFuIGVtcHR5IGRpY3Rpb25hcnlcbiAgICAgICAgICAvLyB3aGljaCBsZWFkcyB0byB0aGUgcmVtb3RlIGRlYnVnZ2VyIGdldHRpbmcgZGlzY29ubmVjdGVkLCBhbmQgaW50byBhIGxvb3BcbiAgICAgICAgICBpZiAoXy5pc0VtcHR5KHBhZ2VEaWN0KSkge1xuICAgICAgICAgICAgbG9nLmRlYnVnKCdFbXB0eSBwYWdlIGRpY3Rpb25hcnkgcmVjZWl2ZWQuIFRyeWluZyBhZ2Fpbi4nKTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIHNhdmUgdGhlIHBhZ2UgYXJyYXkgZm9yIHRoaXMgYXBwXG4gICAgICAgICAgdGhpcy5hcHBEaWN0W2FwcElkS2V5XS5wYWdlRGljdCA9IHBhZ2VBcnJheUZyb21EaWN0KHBhZ2VEaWN0KTtcblxuICAgICAgICAgIC8vIGlmIHdlIGFyZSBsb29raW5nIGZvciBhIHBhcnRpY3VsYXIgdXJsLCBtYWtlIHN1cmUgd2UgaGF2ZSB0aGUgcmlnaHQgcGFnZS4gSWdub3JlIGVtcHR5IG9yIHVuZGVmaW5lZCB1cmxzLiBJZ25vcmUgYWJvdXQ6YmxhbmsgaWYgcmVxdWVzdGVkLlxuICAgICAgICAgIGxldCBmb3VuZCA9IGZhbHNlO1xuICAgICAgICAgIGRpY3RMb29wOiBmb3IgKGxldCBhcHBEaWN0IG9mIF8udmFsdWVzKHRoaXMuYXBwRGljdCkpIHtcbiAgICAgICAgICAgIGlmIChmb3VuZCkgYnJlYWs7XG4gICAgICAgICAgICBmb3IgKGxldCBkaWN0IG9mIChhcHBEaWN0LnBhZ2VEaWN0IHx8IFtdKSkge1xuICAgICAgICAgICAgICBpZiAoKCFpZ25vcmVBYm91dEJsYW5rVXJsIHx8IGRpY3QudXJsICE9PSAnYWJvdXQ6YmxhbmsnKSAmJiAoIWN1cnJlbnRVcmwgfHwgZGljdC51cmwgPT09IGN1cnJlbnRVcmwpKSB7XG4gICAgICAgICAgICAgICAgLy8gc2F2ZSB3aGVyZSB3ZSBmb3VuZCB0aGUgcmlnaHQgcGFnZVxuICAgICAgICAgICAgICAgIGFwcElkS2V5ID0gYXBwRGljdC5pZDtcbiAgICAgICAgICAgICAgICBwYWdlRGljdCA9IGRpY3Q7XG4gICAgICAgICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGJyZWFrIGRpY3RMb29wO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghZm91bmQpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgYXBwLCBidXQgZXhwZWN0ZWQgdXJsICgnJHtjdXJyZW50VXJsfScpIHdhcyBub3QgZm91bmQuIFRyeWluZyBhZ2Fpbi5gKTtcbiAgICAgICAgICAgIHBhZ2VEaWN0ID0gbnVsbDtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIHdlIGhhdmUgZ290dGVuIHRoZSBjb3JyZWN0IGFwcGxpY2F0aW9uIGJ5IHRoaXMgcG9pbnQsIHNvIHNob3J0IGNpcmN1aXQgZXZlcnl0aGluZ1xuICAgICAgICAgIGJyZWFrIGFwcExvb3A7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgRXJyb3IgY2hlY2tpbmcgYXBwbGljYXRpb246ICcke2Vycn0nLiBSZXRyeWluZyBjb25uZWN0aW9uYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBpZiwgYWZ0ZXIgYWxsIHRoaXMsIHdlIGhhdmUgbm8gZGljdGlvbmFyeSwgd2UgaGF2ZSBmYWlsZWRcbiAgICBpZiAoIXBhZ2VEaWN0KSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ291bGQgbm90IGNvbm5lY3QgdG8gYSB2YWxpZCBhcHAgYWZ0ZXIgJHttYXhUcmllc30gdHJpZXMuYCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuYXBwSWRLZXkgIT09IGFwcElkS2V5KSB7XG4gICAgICBsb2cuZGVidWcoYFJlY2VpdmVkIGFsdGVyZWQgYXBwIGlkLCB1cGRhdGluZyBmcm9tICcke3RoaXMuYXBwSWRLZXl9JyB0byAnJHthcHBJZEtleX0nYCk7XG4gICAgICB0aGlzLmFwcElkS2V5ID0gYXBwSWRLZXk7XG4gICAgfVxuXG4gICAgLy8gc2V0IHRoZSBjYWxsYmFjayBmb3IgZ2V0dGluZyBhIGxpc3RpbmcgdG8gdGhlIHBhZ2UgY2hhbmdlIGNhbGxiYWNrXG4gICAgdGhpcy5ycGNDbGllbnQuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKCdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOicsIG51bGwsXG4gICAgICAgICAgIHRoaXMub25QYWdlQ2hhbmdlLmJpbmQodGhpcykpO1xuXG4gICAgLy8gd2FpdCBmb3IgYWxsIHRoZSBwcm9taXNlcyBhcmUgYmFjaywgb3IgMzBzIHBhc3Nlc1xuICAgIGxldCBwYWdlUHJvbWlzZXMgPSBPYmplY3QudmFsdWVzKHRoaXMuYXBwRGljdClcbiAgICAgIC5maWx0ZXIoKGFwcCkgPT4gISFhcHAucGFnZURpY3QgJiYgISFhcHAucGFnZURpY3QucHJvbWlzZSlcbiAgICAgIC5tYXAoKGFwcCkgPT4gYXBwLnBhZ2VEaWN0LnByb21pc2UpO1xuICAgIGlmIChwYWdlUHJvbWlzZXMubGVuZ3RoKSB7XG4gICAgICBsb2cuZGVidWcoYFdhaXRpbmcgZm9yICR7cGFnZVByb21pc2VzLmxlbmd0aH0gcGFnZXMgdG8gYmUgZnVsZmlsbGVkYCk7XG4gICAgICBhd2FpdCBQcm9taXNlLmFueShbUHJvbWlzZS5kZWxheSgzMDAwMCksIFByb21pc2UuYWxsKHBhZ2VQcm9taXNlcyldKTtcbiAgICB9XG5cbiAgICAvLyB0cmFuc2xhdGUgdGhlIGRpY3Rpb25hcnkgaW50byBhIHVzZWZ1bCBmb3JtLCBhbmQgcmV0dXJuIHRvIHNlbmRlclxuICAgIGxldCBwYWdlQXJyYXkgPSBwYWdlQXJyYXlGcm9tRGljdChwYWdlRGljdCk7XG4gICAgbG9nLmRlYnVnKGBGaW5hbGx5IHNlbGVjdGluZyBhcHAgJHt0aGlzLmFwcElkS2V5fTogJHtzaW1wbGVTdHJpbmdpZnkocGFnZUFycmF5KX1gKTtcblxuICAgIGxldCBmdWxsUGFnZUFycmF5ID0gW107XG4gICAgZm9yIChsZXQgW2FwcCwgaW5mb10gb2YgXy50b1BhaXJzKHRoaXMuYXBwRGljdCkpIHtcbiAgICAgIGlmICghXy5pc0FycmF5KGluZm8ucGFnZURpY3QpKSBjb250aW51ZTtcbiAgICAgIGxldCBpZCA9IGFwcC5yZXBsYWNlKCdQSUQ6JywgJycpO1xuICAgICAgZm9yIChsZXQgcGFnZSBvZiBpbmZvLnBhZ2VEaWN0KSB7XG4gICAgICAgIGlmIChwYWdlLnVybCAmJiAoIWlnbm9yZUFib3V0QmxhbmtVcmwgfHwgcGFnZS51cmwgIT09ICdhYm91dDpibGFuaycpICYmICghY3VycmVudFVybCB8fCBwYWdlLnVybCA9PT0gY3VycmVudFVybCkpIHtcbiAgICAgICAgICBsZXQgcGFnZURpY3QgPSBfLmNsb25lKHBhZ2UpO1xuICAgICAgICAgIHBhZ2VEaWN0LmlkID0gYCR7aWR9LiR7cGFnZURpY3QuaWR9YDtcbiAgICAgICAgICBmdWxsUGFnZUFycmF5LnB1c2gocGFnZURpY3QpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZ1bGxQYWdlQXJyYXk7XG4gIH1cblxuICBhc3luYyBzZWxlY3RQYWdlIChhcHBJZEtleSwgcGFnZUlkS2V5LCBza2lwUmVhZHlDaGVjayA9IGZhbHNlKSB7XG4gICAgdGhpcy5hcHBJZEtleSA9IGBQSUQ6JHthcHBJZEtleX1gO1xuICAgIHRoaXMucGFnZUlkS2V5ID0gcGFnZUlkS2V5O1xuXG4gICAgbG9nLmRlYnVnKGBTZWxlY3RpbmcgcGFnZSAnJHtwYWdlSWRLZXl9JyBvbiBhcHAgJyR7dGhpcy5hcHBJZEtleX0nIGFuZCBmb3J3YXJkaW5nIHNvY2tldCBzZXR1cGApO1xuXG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnc2V0U2VuZGVyS2V5Jywge1xuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5XG4gICAgfSk7XG4gICAgbG9nLmRlYnVnKCdTZW5kZXIga2V5IHNldCcpO1xuXG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnZW5hYmxlUGFnZScsIHtcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICAgIGRlYnVnZ2VyVHlwZTogdGhpcy5kZWJ1Z2dlclR5cGVcbiAgICB9KTtcbiAgICBsb2cuZGVidWcoJ0VuYWJsZWQgYWN0aXZpdHkgb24gcGFnZScpO1xuXG4gICAgLy8gbWFrZSBzdXJlIGV2ZXJ5dGhpbmcgaXMgcmVhZHkgdG8gZ29cbiAgICBsZXQgcmVhZHkgPSBhd2FpdCB0aGlzLmNoZWNrUGFnZUlzUmVhZHkoKTtcbiAgICBpZiAoIXNraXBSZWFkeUNoZWNrICYmICFyZWFkeSkge1xuICAgICAgYXdhaXQgdGhpcy5wYWdlVW5sb2FkKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZUF0b20gKGF0b20sIGFyZ3MsIGZyYW1lcykge1xuICAgIGlmICghdGhpcy5ycGNDbGllbnQuY29ubmVjdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ1JlbW90ZSBkZWJ1Z2dlciBpcyBub3QgY29ubmVjdGVkJyk7XG5cbiAgICBsZXQgc2NyaXB0ID0gYXdhaXQgZ2V0U2NyaXB0Rm9yQXRvbShhdG9tLCBhcmdzLCBmcmFtZXMpO1xuXG4gICAgbGV0IHZhbHVlID0gYXdhaXQgdGhpcy5leGVjdXRlKHNjcmlwdCwgdHJ1ZSk7XG4gICAgbG9nLmRlYnVnKGBSZWNlaXZlZCByZXN1bHQgZm9yIGF0b20gJyR7YXRvbX0nIGV4ZWN1dGlvbjogJHtzaW1wbGVTdHJpbmdpZnkodmFsdWUpfWApO1xuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGVBdG9tQXN5bmMgKGF0b20sIGFyZ3MsIGZyYW1lcywgcmVzcG9uc2VVcmwpIHtcbiAgICBsZXQgYXN5bmNDYWxsQmFjayA9IGBmdW5jdGlvbiAocmVzKSB7IHhtbEh0dHAgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgeG1sSHR0cC5vcGVuKCdQT1NUJywgJyR7cmVzcG9uc2VVcmx9JywgdHJ1ZSk7YCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgeG1sSHR0cC5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LXR5cGUnLCdhcHBsaWNhdGlvbi9qc29uJyk7IGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYHhtbEh0dHAuc2VuZChyZXMpOyB9YDtcbiAgICBsZXQgc2NyaXB0ID0gYXdhaXQgZ2V0U2NyaXB0Rm9yQXRvbShhdG9tLCBhcmdzLCBmcmFtZXMsIGFzeW5jQ2FsbEJhY2spO1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZShzY3JpcHQpO1xuICB9XG5cbiAgYXN5bmMgcGFnZUxvYWQgKHN0YXJ0UGFnZUxvYWRNcykge1xuICAgIGxldCB0aW1lb3V0TXMgPSA1MDA7XG4gICAgbGV0IHN0YXJ0ID0gc3RhcnRQYWdlTG9hZE1zIHx8IERhdGUubm93KCk7XG4gICAgbG9nLmRlYnVnKCdQYWdlIGxvYWRlZCwgdmVyaWZ5aW5nIHdoZXRoZXIgcmVhZHknKTtcblxuICAgIGxldCB2ZXJpZnkgPSBhc3luYyAoKSA9PiB7XG4gICAgICB0aGlzLnBhZ2VMb2FkRGVsYXkgPSB1dGlsLmNhbmNlbGxhYmxlRGVsYXkodGltZW91dE1zKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucGFnZUxvYWREZWxheTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgUHJvbWlzZS5DYW5jZWxsYXRpb25FcnJvcikge1xuICAgICAgICAgIC8vIGlmIHRoZSBwcm9taXNlIGhhcyBiZWVuIGNhbmNlbGxlZFxuICAgICAgICAgIC8vIHdlIHdhbnQgdG8gc2tpcCBjaGVja2luZyB0aGUgcmVhZGluZXNzXG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIHdlIGNhbiBnZXQgdGhpcyBjYWxsZWQgaW4gdGhlIG1pZGRsZSBvZiB0cnlpbmcgdG8gZmluZCBhIG5ldyBhcHBcbiAgICAgIGlmICghdGhpcy5hcHBJZEtleSkge1xuICAgICAgICBsb2cuZGVidWcoJ05vdCBjb25uZWN0ZWQgdG8gYW4gYXBwbGljYXRpb24uIElnbm9yaW5nIHBhZ2UgbG9hZCcpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGxldCByZWFkeSA9IGF3YWl0IHRoaXMuY2hlY2tQYWdlSXNSZWFkeSgpO1xuXG4gICAgICAvLyBpZiB3ZSBhcmUgcmVhZHksIG9yIHdlJ3ZlIHNwZW5kIHRvbyBtdWNoIHRpbWUgb24gdGhpc1xuICAgICAgaWYgKHJlYWR5IHx8ICh0aGlzLnBhZ2VMb2FkTXMgPiAwICYmIChzdGFydCArIHRoaXMucGFnZUxvYWRNcykgPCBEYXRlLm5vdygpKSkge1xuICAgICAgICBsb2cuZGVidWcoJ1BhZ2UgaXMgcmVhZHknKTtcbiAgICAgICAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmRlYnVnKCdQYWdlIHdhcyBub3QgcmVhZHksIHJldHJ5aW5nJyk7XG4gICAgICAgIGF3YWl0IHZlcmlmeSgpO1xuICAgICAgfVxuICAgIH07XG4gICAgYXdhaXQgdmVyaWZ5KCk7XG4gIH1cblxuICBhc3luYyBjYW5jZWxQYWdlTG9hZCAoKSB7XG4gICAgbG9nLmRlYnVnKCdVbnJlZ2lzdGVyaW5nIGZyb20gcGFnZSByZWFkaW5lc3Mgbm90aWZpY2F0aW9ucycpO1xuICAgIHRoaXMucGFnZUxvYWRpbmcgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5wYWdlTG9hZERlbGF5KSB7XG4gICAgICB0aGlzLnBhZ2VMb2FkRGVsYXkuY2FuY2VsKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcGFnZVVubG9hZCAoKSB7XG4gICAgbG9nLmRlYnVnKCdQYWdlIHVubG9hZGluZycpO1xuICAgIHRoaXMucGFnZUxvYWRpbmcgPSB0cnVlO1xuICAgIGF3YWl0IHRoaXMud2FpdEZvckRvbSgpO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvckRvbSAoc3RhcnRQYWdlTG9hZE1zKSB7XG4gICAgbG9nLmRlYnVnKCdXYWl0aW5nIGZvciBkb20uLi4nKTtcbiAgICBhd2FpdCB0aGlzLnBhZ2VMb2FkKHN0YXJ0UGFnZUxvYWRNcyk7XG4gIH1cblxuICBhc3luYyBjaGVja1BhZ2VJc1JlYWR5ICgpIHtcbiAgICBsZXQgZXJyb3JzID0gY2hlY2tQYXJhbXMoe2FwcElkS2V5OiB0aGlzLmFwcElkS2V5fSk7XG4gICAgaWYgKGVycm9ycykgdGhyb3cgbmV3IEVycm9yKGVycm9ycyk7XG5cbiAgICBsb2cuZGVidWcoJ0NoZWNraW5nIGRvY3VtZW50IHJlYWR5U3RhdGUnKTtcbiAgICBsZXQgcmVhZHlDbWQgPSAnKGZ1bmN0aW9uICgpeyByZXR1cm4gZG9jdW1lbnQucmVhZHlTdGF0ZTsgfSkoKSc7XG4gICAgbGV0IHJlYWR5U3RhdGUgPSBhd2FpdCB0aGlzLmV4ZWN1dGUocmVhZHlDbWQsIHRydWUpO1xuICAgIGxvZy5kZWJ1ZyhgcmVhZHlTdGF0ZSB3YXMgJHtzaW1wbGVTdHJpbmdpZnkocmVhZHlTdGF0ZSl9YCk7XG5cbiAgICByZXR1cm4gcmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJztcbiAgfVxuXG4gIGFzeW5jIG5hdlRvVXJsICh1cmwpIHtcbiAgICAvLyBubyBuZWVkIHRvIGRvIHRoaXMgY2hlY2sgd2hlbiB1c2luZyB3ZWJraXRcbiAgICBpZiAodGhpcy5kZWJ1Z2dlclR5cGUgPT09IERFQlVHR0VSX1RZUEVTLndlYmluc3BlY3Rvcikge1xuICAgICAgbGV0IGVycm9ycyA9IGNoZWNrUGFyYW1zKHthcHBJZEtleTogdGhpcy5hcHBJZEtleSwgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleX0pO1xuICAgICAgaWYgKGVycm9ycykgdGhyb3cgbmV3IEVycm9yKGVycm9ycyk7XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKGBOYXZpZ2F0aW5nIHRvIG5ldyBVUkw6ICR7dXJsfWApO1xuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ3NldFVybCcsIHtcbiAgICAgIHVybCxcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICAgIGRlYnVnZ2VyVHlwZTogdGhpcy5kZWJ1Z2dlclR5cGVcbiAgICB9KTtcblxuICAgIGlmICghdGhpcy51c2VOZXdTYWZhcmkpIHtcbiAgICAgIC8vIGEgc21hbGwgcGF1c2UgZm9yIHRoZSBicm93c2VyIHRvIGNhdGNoIHVwXG4gICAgICBhd2FpdCBQcm9taXNlLmRlbGF5KDEwMDApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmRlYnVnZ2VyVHlwZSA9PT0gREVCVUdHRVJfVFlQRVMud2ViaW5zcGVjdG9yKSB7XG4gICAgICBhd2FpdCB0aGlzLndhaXRGb3JGcmFtZU5hdmlnYXRlZCgpO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLndhaXRGb3JEb20oRGF0ZS5ub3coKSk7XG4gIH1cblxuICBhc3luYyB3YWl0Rm9yRnJhbWVOYXZpZ2F0ZWQgKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBsb2cuZGVidWcoJ1dhaXRpbmcgZm9yIGZyYW1lIG5hdmlnYXRlZCBtZXNzYWdlLi4uJyk7XG4gICAgICB2YXIgc3RhcnRNcyA9IERhdGUubm93KCk7XG5cbiAgICAgIC8vIGFkZCBhIGhhbmRsZXIgZm9yIHRoZSBgUGFnZS5mcmFtZU5hdmlnYXRlZGAgbWVzc2FnZVxuICAgICAgLy8gZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyXG4gICAgICBsZXQgbmF2RXZlbnRMaXN0ZW5lciA9ICh2YWx1ZSkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoYEZyYW1lIG5hdmlnYXRlZCBpbiAkeygoRGF0ZS5ub3coKSAtIHN0YXJ0TXMpLzEwMDApfSBzZWMgZnJvbSBzb3VyY2U6ICR7dmFsdWV9YCk7XG4gICAgICAgIGlmICh0aGlzLm5hdmlnYXRpb25EZWxheSkge1xuICAgICAgICAgIHRoaXMubmF2aWdhdGlvbkRlbGF5LmNhbmNlbCgpO1xuICAgICAgICB9XG4gICAgICAgIHJlc29sdmUodmFsdWUpO1xuICAgICAgfTtcbiAgICAgIHRoaXMucnBjQ2xpZW50LnNldFNwZWNpYWxNZXNzYWdlSGFuZGxlcignUGFnZS5mcmFtZU5hdmlnYXRlZCcsIHJlamVjdCwgbmF2RXZlbnRMaXN0ZW5lcik7XG5cbiAgICAgIC8vIHRpbWVvdXQsIGluIGNhc2UgcmVtb3RlIGRlYnVnZ2VyIGRvZXNuJ3QgcmVzcG9uZCxcbiAgICAgIC8vIG9yIHRha2VzIGEgbG9uZyB0aW1lXG4gICAgICBpZiAoIXRoaXMudXNlTmV3U2FmYXJpIHx8IHRoaXMucGFnZUxvYWRNcyA+PSAwKSB7XG4gICAgICAgIC8vIHVzZSBwYWdlTG9hZE1zLCBvciBhIHNtYWxsIGFtb3VudCBvZiB0aW1lXG4gICAgICAgIGxldCB0aW1lb3V0ID0gdGhpcy51c2VOZXdTYWZhcmkgPyB0aGlzLnBhZ2VMb2FkTXMgOiA1MDA7XG4gICAgICAgIHRoaXMubmF2aWdhdGlvbkRlbGF5ID0gdXRpbC5jYW5jZWxsYWJsZURlbGF5KHRpbWVvdXQpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHRoaXMubmF2aWdhdGlvbkRlbGF5O1xuICAgICAgICAgIG5hdkV2ZW50TGlzdGVuZXIoJ3RpbWVvdXQnKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgLy8gbm90aGluZyB0byBkbzogd2Ugb25seSBnZXQgaGVyZSBpZiB0aGUgcmVtb3RlIGRlYnVnZ2VyXG4gICAgICAgICAgLy8gYWxyZWFkeSBub3RpZmllZCBvZiBmcmFtZSBuYXZpZ2F0aW9uLCBhbmQgdGhlIGRlbGF5XG4gICAgICAgICAgLy8gd2FzIGNhbmNlbGxlZFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBzdGFydFRpbWVsaW5lIChmbikge1xuICAgIGxvZy5kZWJ1ZygnU3RhcnRpbmcgdG8gcmVjb3JkIHRoZSB0aW1lbGluZScpO1xuICAgIHRoaXMucnBjQ2xpZW50LnNldFRpbWVsaW5lRXZlbnRIYW5kbGVyKGZuKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnc3RhcnRUaW1lbGluZScsIHtcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICAgIGRlYnVnZ2VyVHlwZTogdGhpcy5kZWJ1Z2dlclR5cGVcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHN0b3BUaW1lbGluZSAoKSB7XG4gICAgbG9nLmRlYnVnKCdTdG9wcGluZyB0byByZWNvcmQgdGhlIHRpbWVsaW5lJyk7XG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnc3RvcFRpbWVsaW5lJywge1xuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgICAgZGVidWdnZXJUeXBlOiB0aGlzLmRlYnVnZ2VyVHlwZVxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZSAoY29tbWFuZCwgb3ZlcnJpZGUpIHtcbiAgICAvLyBpZiB0aGUgcGFnZSBpcyBub3QgbG9hZGVkIHlldCwgd2FpdCBmb3IgaXRcbiAgICBpZiAodGhpcy5wYWdlTG9hZGluZyAmJiAhb3ZlcnJpZGUpIHtcbiAgICAgIGxvZy5kZWJ1ZygnVHJ5aW5nIHRvIGV4ZWN1dGUgYnV0IHBhZ2UgaXMgbm90IGxvYWRlZC4nKTtcbiAgICAgIGF3YWl0IHRoaXMud2FpdEZvckRvbSgpO1xuICAgIH1cblxuICAgIC8vIG5vIG5lZWQgdG8gY2hlY2sgZXJyb3JzIGlmIGl0IGlzIHdlYmtpdFxuICAgIGlmICh0aGlzLmRlYnVnZ2VyVHlwZSA9PT0gREVCVUdHRVJfVFlQRVMud2ViaW5zcGVjdG9yKSB7XG4gICAgICBsZXQgZXJyb3JzID0gY2hlY2tQYXJhbXMoe2FwcElkS2V5OiB0aGlzLmFwcElkS2V5LCBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5fSk7XG4gICAgICBpZiAoZXJyb3JzKSB0aHJvdyBuZXcgRXJyb3IoZXJyb3JzKTtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYFNlbmRpbmcgamF2YXNjcmlwdCBjb21tYW5kICR7Xy50cnVuY2F0ZShjb21tYW5kLCB7bGVuZ3RoOiA1MH0pfWApO1xuICAgIGxldCByZXMgPSBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdzZW5kSlNDb21tYW5kJywge1xuICAgICAgY29tbWFuZCxcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICAgIGRlYnVnZ2VyVHlwZTogdGhpcy5kZWJ1Z2dlclR5cGVcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLmNvbnZlcnRSZXN1bHQocmVzKTtcbiAgfVxuXG4gIGFzeW5jIGNhbGxGdW5jdGlvbiAob2JqSWQsIGZuLCBhcmdzKSB7XG4gICAgbGV0IGVycm9ycyA9IGNoZWNrUGFyYW1zKHthcHBJZEtleTogdGhpcy5hcHBJZEtleSwgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleX0pO1xuICAgIGlmIChlcnJvcnMpIHRocm93IG5ldyBFcnJvcihlcnJvcnMpO1xuXG4gICAgbG9nLmRlYnVnKCdDYWxsaW5nIGphdmFzY3JpcHQgZnVuY3Rpb24nKTtcbiAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnY2FsbEpTRnVuY3Rpb24nLCB7XG4gICAgICBvYmpJZCxcbiAgICAgIGZuLFxuICAgICAgYXJncyxcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICAgIGRlYnVnZ2VyVHlwZTogdGhpcy5kZWJ1Z2dlclR5cGVcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLmNvbnZlcnRSZXN1bHQocmVzKTtcbiAgfVxuXG4gIGNvbnZlcnRSZXN1bHQgKHJlcykge1xuICAgIGlmIChfLmlzVW5kZWZpbmVkKHJlcykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRGlkIG5vdCBnZXQgT0sgcmVzdWx0IGZyb20gcmVtb3RlIGRlYnVnZ2VyLiBSZXN1bHQgd2FzOiAke3NpbXBsZVN0cmluZ2lmeShyZXMpfWApO1xuICAgIH0gZWxzZSBpZiAoXy5pc1N0cmluZyhyZXMpKSB7XG4gICAgICB0cnkge1xuICAgICAgICByZXMgPSBKU09OLnBhcnNlKHJlcyk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy8gd2UgbWlnaHQgZ2V0IGEgc2VyaWFsaXplZCBvYmplY3QsIGJ1dCB3ZSBtaWdodCBub3RcbiAgICAgICAgLy8gaWYgd2UgZ2V0IGhlcmUsIGl0IGlzIGp1c3QgYSB2YWx1ZVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoIV8uaXNPYmplY3QocmVzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZXN1bHQgaGFzIHVuZXhwZWN0ZWQgdHlwZTogKCR7dHlwZW9mIHJlc30pLmApO1xuICAgIH1cblxuICAgIGlmIChyZXMuc3RhdHVzICYmIHJlcy5zdGF0dXMgIT09IDApIHtcbiAgICAgIC8vIHdlIGdvdCBzb21lIGZvcm0gb2YgZXJyb3IuXG4gICAgICBsZXQgbWVzc2FnZSA9IHJlcy52YWx1ZS5tZXNzYWdlIHx8IHJlcy52YWx1ZTtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSmF2YVNjcmlwdEVycm9yKGAke21lc3NhZ2V9IChzdGF0dXM6ICR7cmVzLnN0YXR1c30pYCk7XG4gICAgfVxuXG4gICAgLy8gd2l0aCBlaXRoZXIgaGF2ZSBhbiBvYmplY3Qgd2l0aCBhIGB2YWx1ZWAgcHJvcGVydHkgKGV2ZW4gaWYgYG51bGxgKSxcbiAgICAvLyBvciBhIHBsYWluIG9iamVjdFxuICAgIHJldHVybiByZXMuaGFzT3duUHJvcGVydHkoJ3ZhbHVlJykgPyByZXMudmFsdWUgOiByZXM7XG4gIH1cblxuICBhc3luYyBhbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkIChhbGxvdyA9IHRydWUpIHtcbiAgICB0aGlzLnJwY0NsaWVudC5hbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkKGFsbG93KTtcbiAgfVxufVxuXG4vLyBldmVudCBlbWl0dGVkIHB1YmxpY2FsbHlcblJlbW90ZURlYnVnZ2VyLkVWRU5UX1BBR0VfQ0hBTkdFID0gJ3JlbW90ZV9kZWJ1Z2dlcl9wYWdlX2NoYW5nZSc7XG5SZW1vdGVEZWJ1Z2dlci5FVkVOVF9ESVNDT05ORUNUID0gJ3JlbW90ZV9kZWJ1Z2dlcl9kaXNjb25uZWN0JztcblxuLy8gYWRkIGdlbmVyaWMgY2FsbGJhY2tzXG5mb3IgKGxldCBbbmFtZSwgaGFuZGxlcl0gb2YgXy50b1BhaXJzKG1lc3NhZ2VIYW5kbGVycykpIHtcbiAgUmVtb3RlRGVidWdnZXIucHJvdG90eXBlW25hbWVdID0gaGFuZGxlcjtcbn1cblxuZXhwb3J0IHsgUmVtb3RlRGVidWdnZXIsIERFQlVHR0VSX1RZUEVTLCBSRU1PVEVfREVCVUdHRVJfUE9SVCwgUlBDX1JFU1BPTlNFX1RJTUVPVVRfTVMgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
