require('source-map-support').install();

'use strict';

var _toConsumableArray = require('babel-runtime/helpers/to-consumable-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this5 = this;

var _indexJs = require('../../index.js');

var _helpersRemoteDebuggerServer = require('../helpers/remote-debugger-server');

var _helpersServerSetup = require('../helpers/server-setup');

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('RemoteDebugger', function () {
  var rd = undefined;
  var rds = [];
  beforeEach(function () {
    var opts = {
      bundleId: _helpersRemoteDebuggerServer.APP_INFO['PID:42'].bundleId,
      platformVersion: '8.3',
      useNewSafari: true,
      pageLoadMs: 5000,
      port: 27754,
      debuggerType: _indexJs.DEBUGGER_TYPES.webinspector };
    rd = new _indexJs.RemoteDebugger(opts);
    rds[0] = rd;
  });

  function requireAppIdKey(fn, args) {
    var _this = this;

    it('should fail if no app selected', function callee$2$0() {
      var _rd;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            // make sure there is no app id key (set during selectApp)
            rd.appIdKey = null;

            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((_rd = rd)[fn].apply(_rd, _toConsumableArray(args)).should.be.rejectedWith('appIdKey'));

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  }
  function requirePageIdKey(fn, args) {
    var _this2 = this;

    it('should fail if no page selected', function callee$2$0() {
      var _rd2;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            // make sure there is no page id key (set during selectPage)
            rd.pageIdKey = null;

            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((_rd2 = rd)[fn].apply(_rd2, _toConsumableArray(args)).should.be.rejectedWith('pageIdKey'));

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this2);
    });
  }
  function confirmRpcSend(fn, args) {
    var _this3 = this;

    var num = arguments.length <= 2 || arguments[2] === undefined ? 1 : arguments[2];

    it('should send an rpc message', function callee$2$0() {
      var _rd3;

      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            spy = _sinon2['default'].spy(rd.rpcClient, 'send');
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((_rd3 = rd)[fn].apply(_rd3, _toConsumableArray(args)));

          case 3:
            spy.callCount.should.equal(num);

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this3);
    });
  }
  function confirmRemoteDebuggerErrorHandling(server, fn, args) {
    var _this4 = this;

    var errText = arguments.length <= 3 || arguments[3] === undefined ? 'remote debugger error' : arguments[3];

    it('should handle error from remote debugger', function callee$2$0() {
      var _rd4;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            server.setDataResponseError(errText);
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((_rd4 = rd)[fn].apply(_rd4, _toConsumableArray(args)).should.be.rejectedWith(errText));

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this4);
    });
  }

  describe('#connect', function () {
    var server = new _helpersRemoteDebuggerServer.RemoteDebuggerServer();

    beforeEach(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(server.start());

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    afterEach(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(server.stop());

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });

    it('should return application information', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(rd.connect());

          case 2:
            context$3$0.t0 = _helpersRemoteDebuggerServer.APP_INFO;
            context$3$0.sent.should.eql(context$3$0.t0);

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should set the connection key', function callee$2$0() {
      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            spy = _sinon2['default'].spy(rd, 'setConnectionKey');
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(rd.connect());

          case 3:
            spy.calledOnce.should.be['true'];

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
  });

  describe('#disconnect', (0, _helpersServerSetup.withConnectedServer)(rds, function () {
    it('should disconnect from the rpc client', function callee$2$0() {
      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            spy = _sinon2['default'].spy(rd.rpcClient, 'disconnect');
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(rd.disconnect());

          case 3:
            spy.calledOnce.should.be['true'];
            spy.restore();

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should emit an appropriate event', function callee$2$0() {
      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            spy = _sinon2['default'].spy();

            rd.on(_indexJs.RemoteDebugger.EVENT_DISCONNECT, spy);
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(rd.disconnect());

          case 4:
            spy.calledOnce.should.be['true'];

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
  }));

  describe('#selectApp', (0, _helpersServerSetup.withConnectedServer)(rds, function (server) {
    confirmRpcSend('selectApp', []);
    it('should be able to handle an app change event before selection', function callee$2$0() {
      var initialIdKey, timeout, start, spy, selectPromise;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            initialIdKey = rd.appIdKey;

            // change the app immediately
            server.changeApp(1, true);

            // need to wait for the change to have been received
            // wait up to 2 seconds
            timeout = 2000;
            start = Date.now();

          case 4:
            if (!(Date.now() <= start + timeout)) {
              context$3$0.next = 11;
              break;
            }

            if (!(rd.appIdKey !== initialIdKey)) {
              context$3$0.next = 7;
              break;
            }

            return context$3$0.abrupt('break', 11);

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(100));

          case 9:
            context$3$0.next = 4;
            break;

          case 11:
            spy = _sinon2['default'].spy(rd.rpcClient, 'selectApp');
            selectPromise = rd.selectApp();

            server.sendPageInfoMessage('PID:42');
            server.sendPageInfoMessage('PID:44');

            context$3$0.next = 17;
            return _regeneratorRuntime.awrap(selectPromise);

          case 17:

            rd.appIdKey.should.equal('PID:42');
            spy.calledOnce.should.be['true'];

          case 19:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should be able to handle an app change event during selection', function callee$2$0() {
      var spy, selectPromise;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            // change the app when the selectApp call gets in
            server.changeApp(1, false);

            spy = _sinon2['default'].spy(rd.rpcClient, 'selectApp');
            selectPromise = rd.selectApp();
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(1000));

          case 5:
            server.sendPageInfoMessage('PID:44');
            server.sendPageInfoMessage('PID:42');
            server.sendPageInfoMessage('PID:46');

            context$3$0.next = 10;
            return _regeneratorRuntime.awrap(selectPromise);

          case 10:

            spy.calledTwice.should.be['true'];

          case 11:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should not connect to app if url is about:blank and ignoreAboutBlankUrl is passed true to selectApp', function callee$2$0() {
      var selectPromise;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            selectPromise = rd.selectApp({ ignoreAboutBlankUrl: true });
            context$3$0.prev = 1;
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(selectPromise);

          case 4:
            context$3$0.next = 9;
            break;

          case 6:
            context$3$0.prev = 6;
            context$3$0.t0 = context$3$0['catch'](1);

            context$3$0.t0.message.should.include('Could not connect to a valid app');

          case 9:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5, [[1, 6]]);
    });
  }));

  describe('#selectPage', (0, _helpersServerSetup.withConnectedServer)(rds, function (server) {
    confirmRpcSend('selectPage', [1, 2, true], 3);
    confirmRpcSend('selectPage', [1, 2, false], 4);
    confirmRemoteDebuggerErrorHandling(server, 'selectPage', [1, 2]);
  }));

  describe('#execute', (0, _helpersServerSetup.withConnectedServer)(rds, function () {
    requireAppIdKey('execute', []);
    requirePageIdKey('execute', []);
    confirmRpcSend('execute', ['document.getElementsByTagName("html")[0].outerHTML']);
  }));

  describe('#checkPageIsReady', (0, _helpersServerSetup.withConnectedServer)(rds, function (server) {
    requireAppIdKey('checkPageIsReady', []);
    confirmRpcSend('checkPageIsReady', []);
    it('should return true when server responds with complete', function callee$2$0() {
      var ready;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            server.setDataResponseValue('complete');
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(rd.checkPageIsReady());

          case 3:
            ready = context$3$0.sent;

            ready.should.be['true'];

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should return false when server responds with loading', function callee$2$0() {
      var ready;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            server.setDataResponseValue('loading');
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(rd.checkPageIsReady());

          case 3:
            ready = context$3$0.sent;

            ready.should.be['false'];

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    confirmRemoteDebuggerErrorHandling(server, 'checkPageIsReady', []);
  }));

  describe('#executeAtom', (0, _helpersServerSetup.withConnectedServer)(rds, function (server) {
    confirmRpcSend('executeAtom', ['find_element', [], []]);
    it('should execute the atom', function callee$2$0() {
      var sentElement, element;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            sentElement = { ELEMENT: ':wdc:1435784377545' };

            server.setDataResponseValue(sentElement);
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(rd.executeAtom('find_element', [], []));

          case 4:
            element = context$3$0.sent;

            element.should.eql(sentElement);

          case 6:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    confirmRemoteDebuggerErrorHandling(server, 'executeAtom', ['find_element', [], []]);
  }));

  describe('timeline', (0, _helpersServerSetup.withConnectedServer)(rds, function () {
    describe('#startTimeline', function () {
      var timelineCallback = _sinon2['default'].spy();
      confirmRpcSend('startTimeline', [timelineCallback]);
    });

    describe('#stopTimeline', function () {
      confirmRpcSend('stopTimeline', []);
    });
  }));

  describe('#waitForFrameNavigated', (0, _helpersServerSetup.withConnectedServer)(rds, function (server) {
    it('should work when the delay is cancelled but the server sends message', function callee$2$0() {
      var p, source;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            p = rd.waitForFrameNavigated();

            rd.navigationDelay.cancel();

            // make the server send the navigation message
            server.sendFrameNavigationMessage();

            // wait for rd.waitForFrameNavigated() to finish
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(p);

          case 5:
            source = context$3$0.sent;

            source.should.equal('remote-debugger');

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should timeout and finish when server does not send message', function callee$2$0() {
      var source;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(rd.waitForFrameNavigated());

          case 2:
            source = context$3$0.sent;

            source.should.equal('timeout');

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
  }));

  describe('#navToUrl', (0, _helpersServerSetup.withConnectedServer)(rds, function () {
    var url = 'http://appium.io';

    requireAppIdKey('navToUrl', [url]);
    requirePageIdKey('navToUrl', [url]);
    confirmRpcSend('navToUrl', [url], 2);
  }));

  describe('#callFunction', (0, _helpersServerSetup.withConnectedServer)(rds, function () {
    requireAppIdKey('callFunction', []);
    requirePageIdKey('callFunction', []);
    confirmRpcSend('callFunction', []);
  }));

  describe('#pageLoad', (0, _helpersServerSetup.withConnectedServer)(rds, function (server) {
    it('should call #checkPageIsReady', function callee$2$0() {
      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            spy = _sinon2['default'].spy(rd, 'checkPageIsReady');
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(rd.pageLoad());

          case 3:
            spy.calledOnce.should.be['true'];

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should not call #checkPageIsReady if delay is cancelled', function callee$2$0() {
      var spy, p;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            spy = _sinon2['default'].spy(rd, 'checkPageIsReady');
            p = rd.pageLoad();

            rd.pageLoadDelay.cancel();
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(p);

          case 5:
            spy.called.should.be['false'];

          case 6:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should retry if page is not ready', function callee$2$0() {
      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            // give a long timeout so we can get the response from the server
            rd.pageLoadMs = 10000;

            // make the server respond first with random status, then with complete
            server.setDataResponseValue('loading');
            server.setDataResponseValue('complete');

            spy = _sinon2['default'].spy(rd, 'checkPageIsReady');
            context$3$0.next = 6;
            return _regeneratorRuntime.awrap(rd.pageLoad());

          case 6:
            spy.calledTwice.should.be['true'];

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
  }));

  describe('socket errors', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      var _this6 = this;

      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          it('should handle socket connect error', function callee$2$0() {
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  context$3$0.next = 2;
                  return _regeneratorRuntime.awrap(rd.connect().should.be.rejected);

                case 2:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, _this6);
          });

        case 1:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this5);
  });
});

// once the appIdKey has changed, we are good to go
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9yZW1vdGUtZGVidWdnZXItc3BlY3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O3VCQUUrQyxnQkFBZ0I7OzJDQUNoQixtQ0FBbUM7O2tDQUM5Qyx5QkFBeUI7O29CQUM1QyxNQUFNOzs7OzhCQUNJLGtCQUFrQjs7OztxQkFDM0IsT0FBTzs7Ozt3QkFDTCxVQUFVOzs7O0FBRzlCLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQ2Qsa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQzs7QUFHekIsUUFBUSxDQUFDLGdCQUFnQixFQUFFLFlBQU07QUFDL0IsTUFBSSxFQUFFLFlBQUEsQ0FBQztBQUNQLE1BQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztBQUNiLFlBQVUsQ0FBQyxZQUFNO0FBQ2YsUUFBSSxJQUFJLEdBQUc7QUFDVCxjQUFRLEVBQUUsc0NBQVMsUUFBUSxDQUFDLENBQUMsUUFBUTtBQUNyQyxxQkFBZSxFQUFFLEtBQUs7QUFDdEIsa0JBQVksRUFBRSxJQUFJO0FBQ2xCLGdCQUFVLEVBQUUsSUFBSTtBQUNoQixVQUFJLEVBQUUsS0FBSztBQUNYLGtCQUFZLEVBQUUsd0JBQWUsWUFBWSxFQUFDLENBQUM7QUFDN0MsTUFBRSxHQUFHLDRCQUFtQixJQUFJLENBQUMsQ0FBQztBQUM5QixPQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO0dBQ2IsQ0FBQyxDQUFDOztBQUVILFdBQVMsZUFBZSxDQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUU7OztBQUNsQyxNQUFFLENBQUMsZ0NBQWdDLEVBQUU7Ozs7Ozs7QUFFbkMsY0FBRSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7Ozs2Q0FFYixPQUFBLEVBQUUsRUFBQyxFQUFFLE9BQUMseUJBQUksSUFBSSxFQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDOzs7Ozs7O0tBQ3pELENBQUMsQ0FBQztHQUNKO0FBQ0QsV0FBUyxnQkFBZ0IsQ0FB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QUFFLENBQUMsb0NBQW9DLEVBQUU7Ozs7O21EQUNqQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxRQUFROzs7Ozs7O1dBQ3RDLENBQUMsQ0FBQzs7Ozs7OztHQUNKLENBQUMsQ0FBQztDQUNKLENBQUMsQ0FBQyIsImZpbGUiOiJ0ZXN0L3VuaXQvcmVtb3RlLWRlYnVnZ2VyLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlOm1vY2hhXG5cbmltcG9ydCB7IFJlbW90ZURlYnVnZ2VyLCBERUJVR0dFUl9UWVBFUyB9IGZyb20gJy4uLy4uL2luZGV4LmpzJztcbmltcG9ydCB7IFJlbW90ZURlYnVnZ2VyU2VydmVyLCBBUFBfSU5GTyB9IGZyb20gJy4uL2hlbHBlcnMvcmVtb3RlLWRlYnVnZ2VyLXNlcnZlcic7XG5pbXBvcnQgeyB3aXRoQ29ubmVjdGVkU2VydmVyIH0gZnJvbSAnLi4vaGVscGVycy9zZXJ2ZXItc2V0dXAnO1xuaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgc2lub24gZnJvbSAnc2lub24nO1xuaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cblxuZGVzY3JpYmUoJ1JlbW90ZURlYnVnZ2VyJywgKCkgPT4ge1xuICBsZXQgcmQ7XG4gIGxldCByZHMgPSBbXTtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbGV0IG9wdHMgPSB7XG4gICAgICBidW5kbGVJZDogQVBQX0lORk9bJ1BJRDo0MiddLmJ1bmRsZUlkLFxuICAgICAgcGxhdGZvcm1WZXJzaW9uOiAnOC4zJyxcbiAgICAgIHVzZU5ld1NhZmFyaTogdHJ1ZSxcbiAgICAgIHBhZ2VMb2FkTXM6IDUwMDAsXG4gICAgICBwb3J0OiAyNzc1NCxcbiAgICAgIGRlYnVnZ2VyVHlwZTogREVCVUdHRVJfVFlQRVMud2ViaW5zcGVjdG9yfTtcbiAgICByZCA9IG5ldyBSZW1vdGVEZWJ1Z2dlcihvcHRzKTtcbiAgICByZHNbMF0gPSByZDtcbiAgfSk7XG5cbiAgZnVuY3Rpb24gcmVxdWlyZUFwcElkS2V5IChmbiwgYXJncykge1xuICAgIGl0KCdzaG91bGQgZmFpbCBpZiBubyBhcHAgc2VsZWN0ZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBtYWtlIHN1cmUgdGhlcmUgaXMgbm8gYXBwIGlkIGtleSAoc2V0IGR1cmluZyBzZWxlY3RBcHApXG4gICAgICByZC5hcHBJZEtleSA9IG51bGw7XG5cbiAgICAgIGF3YWl0IHJkW2ZuXSguLi5hcmdzKS5zaG91bGQuYmUucmVqZWN0ZWRXaXRoKCdhcHBJZEtleScpO1xuICAgIH0pO1xuICB9XG4gIGZ1bmN0aW9uIHJlcXVpcmVQYWdlSWRLZXkgKGZuLCBhcmdzKSB7XG4gICAgaXQoJ3Nob3VsZCBmYWlsIGlmIG5vIHBhZ2Ugc2VsZWN0ZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBtYWtlIHN1cmUgdGhlcmUgaXMgbm8gcGFnZSBpZCBrZXkgKHNldCBkdXJpbmcgc2VsZWN0UGFnZSlcbiAgICAgIHJkLnBhZ2VJZEtleSA9IG51bGw7XG5cbiAgICAgIGF3YWl0IHJkW2ZuXSguLi5hcmdzKS5zaG91bGQuYmUucmVqZWN0ZWRXaXRoKCdwYWdlSWRLZXknKTtcbiAgICB9KTtcbiAgfVxuICBmdW5jdGlvbiBjb25maXJtUnBjU2VuZCAoZm4sIGFyZ3MsIG51bSA9IDEpIHtcbiAgICBpdCgnc2hvdWxkIHNlbmQgYW4gcnBjIG1lc3NhZ2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc3B5ID0gc2lub24uc3B5KHJkLnJwY0NsaWVudCwgJ3NlbmQnKTtcbiAgICAgIGF3YWl0IHJkW2ZuXSguLi5hcmdzKTtcbiAgICAgIHNweS5jYWxsQ291bnQuc2hvdWxkLmVxdWFsKG51bSk7XG4gICAgfSk7XG4gIH1cbiAgZnVuY3Rpb24gY29uZmlybVJlbW90ZURlYnVnZ2VyRXJyb3JIYW5kbGluZyAoc2VydmVyLCBmbiwgYXJncywgZXJyVGV4dCA9ICdyZW1vdGUgZGVidWdnZXIgZXJyb3InKSB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgZXJyb3IgZnJvbSByZW1vdGUgZGVidWdnZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICBzZXJ2ZXIuc2V0RGF0YVJlc3BvbnNlRXJyb3IoZXJyVGV4dCk7XG4gICAgICBhd2FpdCByZFtmbl0oLi4uYXJncykuc2hvdWxkLmJlLnJlamVjdGVkV2l0aChlcnJUZXh0KTtcbiAgICB9KTtcbiAgfVxuXG4gIGRlc2NyaWJlKCcjY29ubmVjdCcsICgpID0+IHtcbiAgICBsZXQgc2VydmVyID0gbmV3IFJlbW90ZURlYnVnZ2VyU2VydmVyKCk7XG5cbiAgICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHNlcnZlci5zdGFydCgpO1xuICAgIH0pO1xuICAgIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBzZXJ2ZXIuc3RvcCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gYXBwbGljYXRpb24gaW5mb3JtYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICAoYXdhaXQgcmQuY29ubmVjdCgpKS5zaG91bGQuZXFsKEFQUF9JTkZPKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHNldCB0aGUgY29ubmVjdGlvbiBrZXknLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc3B5ID0gc2lub24uc3B5KHJkLCAnc2V0Q29ubmVjdGlvbktleScpO1xuICAgICAgYXdhaXQgcmQuY29ubmVjdCgpO1xuICAgICAgc3B5LmNhbGxlZE9uY2Uuc2hvdWxkLmJlLnRydWU7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCcjZGlzY29ubmVjdCcsIHdpdGhDb25uZWN0ZWRTZXJ2ZXIocmRzLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBkaXNjb25uZWN0IGZyb20gdGhlIHJwYyBjbGllbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc3B5ID0gc2lub24uc3B5KHJkLnJwY0NsaWVudCwgJ2Rpc2Nvbm5lY3QnKTtcbiAgICAgIGF3YWl0IHJkLmRpc2Nvbm5lY3QoKTtcbiAgICAgIHNweS5jYWxsZWRPbmNlLnNob3VsZC5iZS50cnVlO1xuICAgICAgc3B5LnJlc3RvcmUoKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGVtaXQgYW4gYXBwcm9wcmlhdGUgZXZlbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc3B5ID0gc2lub24uc3B5KCk7XG4gICAgICByZC5vbihSZW1vdGVEZWJ1Z2dlci5FVkVOVF9ESVNDT05ORUNULCBzcHkpO1xuICAgICAgYXdhaXQgcmQuZGlzY29ubmVjdCgpO1xuICAgICAgc3B5LmNhbGxlZE9uY2Uuc2hvdWxkLmJlLnRydWU7XG4gICAgfSk7XG4gIH0pKTtcblxuICBkZXNjcmliZSgnI3NlbGVjdEFwcCcsIHdpdGhDb25uZWN0ZWRTZXJ2ZXIocmRzLCAoc2VydmVyKSA9PiB7XG4gICAgY29uZmlybVJwY1NlbmQoJ3NlbGVjdEFwcCcsIFtdKTtcbiAgICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gaGFuZGxlIGFuIGFwcCBjaGFuZ2UgZXZlbnQgYmVmb3JlIHNlbGVjdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBpbml0aWFsSWRLZXkgPSByZC5hcHBJZEtleTtcbiAgICAgIC8vIGNoYW5nZSB0aGUgYXBwIGltbWVkaWF0ZWx5XG4gICAgICBzZXJ2ZXIuY2hhbmdlQXBwKDEsIHRydWUpO1xuXG4gICAgICAvLyBuZWVkIHRvIHdhaXQgZm9yIHRoZSBjaGFuZ2UgdG8gaGF2ZSBiZWVuIHJlY2VpdmVkXG4gICAgICAvLyB3YWl0IHVwIHRvIDIgc2Vjb25kc1xuICAgICAgbGV0IHRpbWVvdXQgPSAyMDAwO1xuICAgICAgbGV0IHN0YXJ0ID0gRGF0ZS5ub3coKTtcbiAgICAgIHdoaWxlIChEYXRlLm5vdygpIDw9IChzdGFydCArIHRpbWVvdXQpKSB7XG4gICAgICAgIC8vIG9uY2UgdGhlIGFwcElkS2V5IGhhcyBjaGFuZ2VkLCB3ZSBhcmUgZ29vZCB0byBnb1xuICAgICAgICBpZiAocmQuYXBwSWRLZXkgIT09IGluaXRpYWxJZEtleSkge1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGF3YWl0IFByb21pc2UuZGVsYXkoMTAwKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHNweSA9IHNpbm9uLnNweShyZC5ycGNDbGllbnQsICdzZWxlY3RBcHAnKTtcbiAgICAgIGxldCBzZWxlY3RQcm9taXNlID0gcmQuc2VsZWN0QXBwKCk7XG5cbiAgICAgIHNlcnZlci5zZW5kUGFnZUluZm9NZXNzYWdlKCdQSUQ6NDInKTtcbiAgICAgIHNlcnZlci5zZW5kUGFnZUluZm9NZXNzYWdlKCdQSUQ6NDQnKTtcblxuICAgICAgYXdhaXQgc2VsZWN0UHJvbWlzZTtcblxuICAgICAgcmQuYXBwSWRLZXkuc2hvdWxkLmVxdWFsKCdQSUQ6NDInKTtcbiAgICAgIHNweS5jYWxsZWRPbmNlLnNob3VsZC5iZS50cnVlO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgYmUgYWJsZSB0byBoYW5kbGUgYW4gYXBwIGNoYW5nZSBldmVudCBkdXJpbmcgc2VsZWN0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gY2hhbmdlIHRoZSBhcHAgd2hlbiB0aGUgc2VsZWN0QXBwIGNhbGwgZ2V0cyBpblxuICAgICAgc2VydmVyLmNoYW5nZUFwcCgxLCBmYWxzZSk7XG5cbiAgICAgIGxldCBzcHkgPSBzaW5vbi5zcHkocmQucnBjQ2xpZW50LCAnc2VsZWN0QXBwJyk7XG4gICAgICBsZXQgc2VsZWN0UHJvbWlzZSA9IHJkLnNlbGVjdEFwcCgpO1xuXG4gICAgICBhd2FpdCBQcm9taXNlLmRlbGF5KDEwMDApO1xuICAgICAgc2VydmVyLnNlbmRQYWdlSW5mb01lc3NhZ2UoJ1BJRDo0NCcpO1xuICAgICAgc2VydmVyLnNlbmRQYWdlSW5mb01lc3NhZ2UoJ1BJRDo0MicpO1xuICAgICAgc2VydmVyLnNlbmRQYWdlSW5mb01lc3NhZ2UoJ1BJRDo0NicpO1xuXG4gICAgICBhd2FpdCBzZWxlY3RQcm9taXNlO1xuXG4gICAgICBzcHkuY2FsbGVkVHdpY2Uuc2hvdWxkLmJlLnRydWU7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBub3QgY29ubmVjdCB0byBhcHAgaWYgdXJsIGlzIGFib3V0OmJsYW5rIGFuZCBpZ25vcmVBYm91dEJsYW5rVXJsIGlzIHBhc3NlZCB0cnVlIHRvIHNlbGVjdEFwcCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBzZWxlY3RQcm9taXNlID0gcmQuc2VsZWN0QXBwKHtpZ25vcmVBYm91dEJsYW5rVXJsOiB0cnVlfSk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHNlbGVjdFByb21pc2U7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgZXJyLm1lc3NhZ2Uuc2hvdWxkLmluY2x1ZGUoJ0NvdWxkIG5vdCBjb25uZWN0IHRvIGEgdmFsaWQgYXBwJyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pKTtcblxuICBkZXNjcmliZSgnI3NlbGVjdFBhZ2UnLCB3aXRoQ29ubmVjdGVkU2VydmVyKHJkcywgKHNlcnZlcikgPT4ge1xuICAgIGNvbmZpcm1ScGNTZW5kKCdzZWxlY3RQYWdlJywgWzEsIDIsIHRydWVdLCAzKTtcbiAgICBjb25maXJtUnBjU2VuZCgnc2VsZWN0UGFnZScsIFsxLCAyLCBmYWxzZV0sIDQpO1xuICAgIGNvbmZpcm1SZW1vdGVEZWJ1Z2dlckVycm9ySGFuZGxpbmcoc2VydmVyLCAnc2VsZWN0UGFnZScsIFsxLCAyXSk7XG4gIH0pKTtcblxuICBkZXNjcmliZSgnI2V4ZWN1dGUnLCB3aXRoQ29ubmVjdGVkU2VydmVyKHJkcywgKCkgPT4ge1xuICAgIHJlcXVpcmVBcHBJZEtleSgnZXhlY3V0ZScsIFtdKTtcbiAgICByZXF1aXJlUGFnZUlkS2V5KCdleGVjdXRlJywgW10pO1xuICAgIGNvbmZpcm1ScGNTZW5kKCdleGVjdXRlJywgWydkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImh0bWxcIilbMF0ub3V0ZXJIVE1MJ10pO1xuICB9KSk7XG5cbiAgZGVzY3JpYmUoJyNjaGVja1BhZ2VJc1JlYWR5Jywgd2l0aENvbm5lY3RlZFNlcnZlcihyZHMsIChzZXJ2ZXIpID0+IHtcbiAgICByZXF1aXJlQXBwSWRLZXkoJ2NoZWNrUGFnZUlzUmVhZHknLCBbXSk7XG4gICAgY29uZmlybVJwY1NlbmQoJ2NoZWNrUGFnZUlzUmVhZHknLCBbXSk7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdHJ1ZSB3aGVuIHNlcnZlciByZXNwb25kcyB3aXRoIGNvbXBsZXRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgc2VydmVyLnNldERhdGFSZXNwb25zZVZhbHVlKCdjb21wbGV0ZScpO1xuICAgICAgbGV0IHJlYWR5ID0gYXdhaXQgcmQuY2hlY2tQYWdlSXNSZWFkeSgpO1xuICAgICAgcmVhZHkuc2hvdWxkLmJlLnRydWU7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZmFsc2Ugd2hlbiBzZXJ2ZXIgcmVzcG9uZHMgd2l0aCBsb2FkaW5nJywgYXN5bmMgKCkgPT4ge1xuICAgICAgc2VydmVyLnNldERhdGFSZXNwb25zZVZhbHVlKCdsb2FkaW5nJyk7XG4gICAgICBsZXQgcmVhZHkgPSBhd2FpdCByZC5jaGVja1BhZ2VJc1JlYWR5KCk7XG4gICAgICByZWFkeS5zaG91bGQuYmUuZmFsc2U7XG4gICAgfSk7XG4gICAgY29uZmlybVJlbW90ZURlYnVnZ2VyRXJyb3JIYW5kbGluZyhzZXJ2ZXIsICdjaGVja1BhZ2VJc1JlYWR5JywgW10pO1xuICB9KSk7XG5cbiAgZGVzY3JpYmUoJyNleGVjdXRlQXRvbScsIHdpdGhDb25uZWN0ZWRTZXJ2ZXIocmRzLCAoc2VydmVyKSA9PiB7XG4gICAgY29uZmlybVJwY1NlbmQoJ2V4ZWN1dGVBdG9tJywgWydmaW5kX2VsZW1lbnQnLCBbXSwgW11dKTtcbiAgICBpdCgnc2hvdWxkIGV4ZWN1dGUgdGhlIGF0b20nLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc2VudEVsZW1lbnQgPSB7RUxFTUVOVDogJzp3ZGM6MTQzNTc4NDM3NzU0NSd9O1xuICAgICAgc2VydmVyLnNldERhdGFSZXNwb25zZVZhbHVlKHNlbnRFbGVtZW50KTtcbiAgICAgIGxldCBlbGVtZW50ID0gYXdhaXQgcmQuZXhlY3V0ZUF0b20oJ2ZpbmRfZWxlbWVudCcsIFtdLCBbXSk7XG4gICAgICBlbGVtZW50LnNob3VsZC5lcWwoc2VudEVsZW1lbnQpO1xuICAgIH0pO1xuICAgIGNvbmZpcm1SZW1vdGVEZWJ1Z2dlckVycm9ySGFuZGxpbmcoc2VydmVyLCAnZXhlY3V0ZUF0b20nLCBbJ2ZpbmRfZWxlbWVudCcsIFtdLCBbXV0pO1xuICB9KSk7XG5cbiAgZGVzY3JpYmUoJ3RpbWVsaW5lJywgd2l0aENvbm5lY3RlZFNlcnZlcihyZHMsICgpID0+IHtcbiAgICBkZXNjcmliZSgnI3N0YXJ0VGltZWxpbmUnLCAoKSA9PiB7XG4gICAgICBsZXQgdGltZWxpbmVDYWxsYmFjayA9IHNpbm9uLnNweSgpO1xuICAgICAgY29uZmlybVJwY1NlbmQoJ3N0YXJ0VGltZWxpbmUnLCBbdGltZWxpbmVDYWxsYmFja10pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJyNzdG9wVGltZWxpbmUnLCAoKSA9PiB7XG4gICAgICBjb25maXJtUnBjU2VuZCgnc3RvcFRpbWVsaW5lJywgW10pO1xuICAgIH0pO1xuICB9KSk7XG5cbiAgZGVzY3JpYmUoJyN3YWl0Rm9yRnJhbWVOYXZpZ2F0ZWQnLCB3aXRoQ29ubmVjdGVkU2VydmVyKHJkcywgKHNlcnZlcikgPT4ge1xuICAgIGl0KCdzaG91bGQgd29yayB3aGVuIHRoZSBkZWxheSBpcyBjYW5jZWxsZWQgYnV0IHRoZSBzZXJ2ZXIgc2VuZHMgbWVzc2FnZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBwID0gcmQud2FpdEZvckZyYW1lTmF2aWdhdGVkKCk7XG4gICAgICByZC5uYXZpZ2F0aW9uRGVsYXkuY2FuY2VsKCk7XG5cbiAgICAgIC8vIG1ha2UgdGhlIHNlcnZlciBzZW5kIHRoZSBuYXZpZ2F0aW9uIG1lc3NhZ2VcbiAgICAgIHNlcnZlci5zZW5kRnJhbWVOYXZpZ2F0aW9uTWVzc2FnZSgpO1xuXG4gICAgICAvLyB3YWl0IGZvciByZC53YWl0Rm9yRnJhbWVOYXZpZ2F0ZWQoKSB0byBmaW5pc2hcbiAgICAgIGxldCBzb3VyY2UgPSBhd2FpdCBwO1xuICAgICAgc291cmNlLnNob3VsZC5lcXVhbCgncmVtb3RlLWRlYnVnZ2VyJyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCB0aW1lb3V0IGFuZCBmaW5pc2ggd2hlbiBzZXJ2ZXIgZG9lcyBub3Qgc2VuZCBtZXNzYWdlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHNvdXJjZSA9IGF3YWl0IHJkLndhaXRGb3JGcmFtZU5hdmlnYXRlZCgpO1xuICAgICAgc291cmNlLnNob3VsZC5lcXVhbCgndGltZW91dCcpO1xuICAgIH0pO1xuICB9KSk7XG5cbiAgZGVzY3JpYmUoJyNuYXZUb1VybCcsIHdpdGhDb25uZWN0ZWRTZXJ2ZXIocmRzLCAoKSA9PiB7XG4gICAgbGV0IHVybCA9ICdodHRwOi8vYXBwaXVtLmlvJztcblxuICAgIHJlcXVpcmVBcHBJZEtleSgnbmF2VG9VcmwnLCBbdXJsXSk7XG4gICAgcmVxdWlyZVBhZ2VJZEtleSgnbmF2VG9VcmwnLCBbdXJsXSk7XG4gICAgY29uZmlybVJwY1NlbmQoJ25hdlRvVXJsJywgW3VybF0sIDIpO1xuICB9KSk7XG5cbiAgZGVzY3JpYmUoJyNjYWxsRnVuY3Rpb24nLCB3aXRoQ29ubmVjdGVkU2VydmVyKHJkcywgKCkgPT4ge1xuICAgIHJlcXVpcmVBcHBJZEtleSgnY2FsbEZ1bmN0aW9uJywgW10pO1xuICAgIHJlcXVpcmVQYWdlSWRLZXkoJ2NhbGxGdW5jdGlvbicsIFtdKTtcbiAgICBjb25maXJtUnBjU2VuZCgnY2FsbEZ1bmN0aW9uJywgW10pO1xuICB9KSk7XG5cbiAgZGVzY3JpYmUoJyNwYWdlTG9hZCcsIHdpdGhDb25uZWN0ZWRTZXJ2ZXIocmRzLCAoc2VydmVyKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjYWxsICNjaGVja1BhZ2VJc1JlYWR5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHNweSA9IHNpbm9uLnNweShyZCwgJ2NoZWNrUGFnZUlzUmVhZHknKTtcbiAgICAgIGF3YWl0IHJkLnBhZ2VMb2FkKCk7XG4gICAgICBzcHkuY2FsbGVkT25jZS5zaG91bGQuYmUudHJ1ZTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIG5vdCBjYWxsICNjaGVja1BhZ2VJc1JlYWR5IGlmIGRlbGF5IGlzIGNhbmNlbGxlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBzcHkgPSBzaW5vbi5zcHkocmQsICdjaGVja1BhZ2VJc1JlYWR5Jyk7XG4gICAgICBsZXQgcCA9IHJkLnBhZ2VMb2FkKCk7XG4gICAgICByZC5wYWdlTG9hZERlbGF5LmNhbmNlbCgpO1xuICAgICAgYXdhaXQgcDtcbiAgICAgIHNweS5jYWxsZWQuc2hvdWxkLmJlLmZhbHNlO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcmV0cnkgaWYgcGFnZSBpcyBub3QgcmVhZHknLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBnaXZlIGEgbG9uZyB0aW1lb3V0IHNvIHdlIGNhbiBnZXQgdGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlclxuICAgICAgcmQucGFnZUxvYWRNcyA9IDEwMDAwO1xuXG4gICAgICAvLyBtYWtlIHRoZSBzZXJ2ZXIgcmVzcG9uZCBmaXJzdCB3aXRoIHJhbmRvbSBzdGF0dXMsIHRoZW4gd2l0aCBjb21wbGV0ZVxuICAgICAgc2VydmVyLnNldERhdGFSZXNwb25zZVZhbHVlKCdsb2FkaW5nJyk7XG4gICAgICBzZXJ2ZXIuc2V0RGF0YVJlc3BvbnNlVmFsdWUoJ2NvbXBsZXRlJyk7XG5cbiAgICAgIGxldCBzcHkgPSBzaW5vbi5zcHkocmQsICdjaGVja1BhZ2VJc1JlYWR5Jyk7XG4gICAgICBhd2FpdCByZC5wYWdlTG9hZCgpO1xuICAgICAgc3B5LmNhbGxlZFR3aWNlLnNob3VsZC5iZS50cnVlO1xuICAgIH0pO1xuICB9KSk7XG5cbiAgZGVzY3JpYmUoJ3NvY2tldCBlcnJvcnMnLCBhc3luYyAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgc29ja2V0IGNvbm5lY3QgZXJyb3InLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCByZC5jb25uZWN0KCkuc2hvdWxkLmJlLnJlamVjdGVkO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
