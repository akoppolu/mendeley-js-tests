require('source-map-support').install();

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _defineProperty = require('babel-runtime/helpers/define-property')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _bplistCreator = require('bplist-creator');

var _bplistCreator2 = _interopRequireDefault(_bplistCreator);

var _bplistParser = require('bplist-parser');

var _bplistParser2 = _interopRequireDefault(_bplistParser);

var _bufferpack = require('bufferpack');

var _bufferpack2 = _interopRequireDefault(_bufferpack);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumSupport = require('appium-support');

var log = _appiumSupport.logger.getLogger('RemoteDebugger');

var DEVICE_INFO = {
  name: 'iPhone Simulator',
  build: 'WP42FJ'
};

var APP_INFO = {
  'PID:42': {
    id: 'PID:42',
    name: 'app',
    bundleId: 'io.appium.bundle',
    isProxy: false,
    hostId: '',
    isActive: '1',
    isAutomationEnabled: false
  }
};

// a bunch of new app info structures to simulate
// the app getting proxied through other apps
var UPDATED_APP_INFO = [{
  id: 'PID:44',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:42',
  isActive: '1'
}, {
  id: 'PID:46',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:44',
  isActive: '1'
}, {
  id: 'PID:48',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:46',
  isActive: '1'
}, {
  id: 'PID:50',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:48',
  isActive: '1'
}];

/*
 * A fake remote debugger server that can be told to send certain
 * messages back to the client, and to return certain values.
 * Used for testing the client.
 */

var RemoteDebuggerServer = (function () {
  function RemoteDebuggerServer() {
    _classCallCheck(this, RemoteDebuggerServer);

    this.server = null;
    this.client = null;
    this.pendingAppChange = false;
    this.appIdKey = 'PID:42';
    this.destinationKey = '2';
    this.app = 1;
    this.dataResponseValue = [];
  }

  _createClass(RemoteDebuggerServer, [{
    key: '_getConnectedApplicationList',
    value: function _getConnectedApplicationList(num) {
      var data = {
        __selector: '_rpc_reportConnectedApplicationList:',
        __argument: {
          WIRApplicationDictionaryKey: [{
            WIRApplicationIdentifierKey: APP_INFO['PID:42'].id,
            WIRApplicationNameKey: APP_INFO['PID:42'].name,
            WIRApplicationBundleIdentifierKey: APP_INFO['PID:42'].bundleId,
            WIRIsApplicationProxyKey: APP_INFO['PID:42'].isProxy,
            WIRHostApplicationIdentifierKey: APP_INFO['PID:42'].hostId,
            WIRIsApplicationActiveKey: APP_INFO['PID:42'].isActive
          }]
        }
      };

      // add more
      if (num > UPDATED_APP_INFO + 1) {
        // we only have so many to give!
        num = UPDATED_APP_INFO + 1;
      }
      for (var i = 0; i < num - 1; i++) {
        var entry = UPDATED_APP_INFO[i];
        data.__argument.WIRApplicationDictionaryKey.push(_defineProperty({}, entry.id, entry));
      }

      return data;
    }
  }, {
    key: 'handleReportIdentifier',
    value: function handleReportIdentifier() {
      var data = {
        __selector: '_rpc_reportSetup:',
        __argument: {
          WIRSimulatorNameKey: DEVICE_INFO.name,
          WIRSimulatorBuildKey: DEVICE_INFO.build
        }
      };
      this.send(data);

      if (this.dataResponseError) {
        data = {
          __selector: '_rpc_reportConnectedApplicationList:',
          __argument: {
            type: 'string',
            value: this.dataResponseError
          },
          wasThrown: true
        };
        this.dataResponseError = null;
      } else {
        data = this._getConnectedApplicationList(1);
      }
      this.send(data);
    }
  }, {
    key: 'handleGetListing',
    value: function handleGetListing() {
      // if we have pending app change events, send them
      if (this.pendingAppChange) {
        this.changeApp(this.pendingAppChange, true);
        this.pendingAppChange = 0;
      }

      // need to send an app dictionary back
      var data = {
        __selector: '_rpc_applicationSentListing:',
        __argument: {
          WIRApplicationIdentifierKey: 'PID:42',
          WIRListingKey: {
            '1': {
              WIRTypeKey: 'WIRTypeWeb',
              WIRPageIdentifierKey: 1,
              WIRTitleKey: '',
              WIRURLKey: 'about:blank'
            }
          }
        }
      };
      this.send(data);
    }
  }, {
    key: 'handleSocketData',
    value: function handleSocketData(plist) {
      var plistData = JSON.parse(plist.__argument.WIRSocketDataKey.toString('utf8'));

      var result = {};
      if (this.dataResponseError) {
        result = {
          result: {
            type: 'string',
            value: this.dataResponseError
          },
          wasThrown: true
        };
        this.dataResponseError = null;
      } else if (this.dataResponseValue.length > 0) {
        // add the response value
        result = {
          result: {
            type: 'string',
            value: this.dataResponseValue.shift()
          },
          wasThrown: false
        };
      }

      var dataKey = {
        result: result,
        id: plistData.id
      };
      dataKey = new Buffer(JSON.stringify(dataKey));
      var data = {
        __selector: '_rpc_applicationSentData:',
        __argument: {
          WIRDestinationKey: plist.__argument.WIRSenderKey,
          WIRApplicationIdentifierKey: plist.__argument.WIRApplicationIdentifierKey,
          WIRMessageDataKey: dataKey
        }
      };
      this.send(data);
    }
  }, {
    key: 'changeApp',
    value: function changeApp() {
      var num = arguments.length <= 0 || arguments[0] === undefined ? 1 : arguments[0];
      var immediate = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

      if (immediate) {
        if (num > UPDATED_APP_INFO.length - 1) {
          // we only have a certain number of info to send
          num = UPDATED_APP_INFO.length - 1;
        }
        for (var i = 0; i < num; i++) {
          var data = {
            __selector: '_rpc_applicationConnected:',
            __argument: {
              WIRApplicationIdentifierKey: UPDATED_APP_INFO[this.app - 1].id,
              WIRApplicationNameKey: UPDATED_APP_INFO[this.app - 1].name,
              WIRApplicationBundleIdentifierKey: UPDATED_APP_INFO[this.app - 1].bundleId,
              WIRIsApplicationProxyKey: UPDATED_APP_INFO[this.app - 1].isProxy,
              WIRHostApplicationIdentifierKey: UPDATED_APP_INFO[this.app - 1].hostId,
              WIRIsApplicationActiveKey: UPDATED_APP_INFO[this.app - 1].isActive
            }
          };
          this.send(data);

          this.app++;
        }
      } else {
        this.pendingAppChange = num;
      }
    }
  }, {
    key: 'sendPageInfoMessage',
    value: function sendPageInfoMessage(appIdKey) {
      var data = {
        __selector: '_rpc_applicationSentListing:',
        __argument: {
          WIRApplicationIdentifierKey: appIdKey,
          WIRListingKey: {
            '1': {
              WIRTypeKey: 'WIRTypeWeb',
              WIRPageIdentifierKey: 1,
              WIRTitleKey: '',
              WIRURLKey: 'about:blank'
            }
          }
        }
      };
      this.send(data);
    }
  }, {
    key: 'sendFrameNavigationMessage',
    value: function sendFrameNavigationMessage() {
      var dataKey = {
        method: 'Page.frameNavigated',
        result: {},
        id: 1
      };
      dataKey = new Buffer(JSON.stringify(dataKey));
      var data = {
        __selector: '_rpc_applicationSentData:',
        __argument: {
          WIRDestinationKey: this.destinationKey,
          WIRApplicationIdentifierKey: this.appIdKey,
          WIRMessageDataKey: dataKey
        }
      };
      this.send(data);
    }
  }, {
    key: 'setDataResponseError',
    value: function setDataResponseError(error) {
      this.dataResponseError = error;
    }
  }, {
    key: 'setDataResponseValue',
    value: function setDataResponseValue(value) {
      this.dataResponseValue.push(value);
    }
  }, {
    key: 'start',
    value: function start() {
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve, reject) {
              _this.server = _net2['default'].createServer(function (c) {
                _this.client = c;
                c.on('end', function () {
                  log.debug('client disconnected');
                });
                c.on('data', function (data) {
                  var plist = _bplistParser2['default'].parseBuffer(data.slice(4));

                  if (!plist[0].__selector) {
                    reject(new Error('Unable to decipher plist: ' + plist));
                    return;
                  }

                  switch (plist[0].__selector) {
                    case '_rpc_reportIdentifier:':
                      _this.handleReportIdentifier(plist[0]);
                      break;
                    case '_rpc_forwardGetListing:':
                      _this.handleGetListing(plist[0]);
                      break;
                    case '_rpc_forwardSocketSetup:':
                      // do nothing
                      break;
                    case '_rpc_forwardSocketData:':
                      _this.handleSocketData(plist[0]);
                      break;
                    case '_rpc_forwardIndicateWebView:':
                      reject(new Error('NOT YET IMPLEMENTED: ' + plist[0].__selector));
                      break;
                    default:
                      _this.client.write('do not compute');
                  }
                });
              });

              // don't use the real port, or any open sims will break the tests
              _this.server.listen(27754, '::1', function () {
                log.info('server bound: ' + JSON.stringify(_this.server.address()));
                resolve();
              });
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve) {
              if (_this2.server) {
                if (_this2.client) {
                  _this2.client.end();
                }
                _this2.server.close(function (err) {
                  resolve('Stopped listening: ' + err);
                });
              } else {
                resolve('Not listening.');
              }
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'send',
    value: function send(data) {
      var buf = (0, _bplistCreator2['default'])(data);
      var length = _bufferpack2['default'].pack('L', [buf.length]);
      this.client.write(Buffer.concat([length, buf]));
    }
  }]);

  return RemoteDebuggerServer;
})();

exports.RemoteDebuggerServer = RemoteDebuggerServer;
exports.APP_INFO = APP_INFO;
exports.DEVICE_INFO = DEVICE_INFO;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvaGVscGVycy9yZW1vdGUtZGVidWdnZXItc2VydmVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7OzttQkFFZ0IsS0FBSzs7Ozs2QkFDSSxnQkFBZ0I7Ozs7NEJBQ2pCLGVBQWU7Ozs7MEJBQ2hCLFlBQVk7Ozs7d0JBQ2YsVUFBVTs7Ozs2QkFDUCxnQkFBZ0I7O0FBRXZDLElBQU0sR0FBRyxHQUFHLHNCQUFPLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDOztBQUcvQyxJQUFNLFdBQVcsR0FBRztBQUNsQixNQUFJLEVBQUUsa0JBQWtCO0FBQ3hCLE9BQUssRUFBRSxRQUFRO0NBQ2hCLENBQUM7O0FBRUYsSUFBTSxRQUFRLEdBQUc7QUFDZixVQUFRLEVBQUU7QUFDUixNQUFFLEVBQUUsUUFBUTtBQUNaLFFBQUksRUFBRSxLQUFLO0FBQ1gsWUFBUSxFQUFFLGtCQUFrQjtBQUM1QixXQUFPLEVBQUUsS0FBSztBQUNkLFVBQU0sRUFBRSxFQUFFO0FBQ1YsWUFBUSxFQUFFLEdBQUc7QUFDYix1QkFBbUIsRUFBRSxLQUFLO0dBQzNCO0NBQ0YsQ0FBQzs7OztBQUlGLElBQU0sZ0JBQWdCLEdBQUcsQ0FDdkI7QUFDRSxJQUFFLEVBQUUsUUFBUTtBQUNaLE1BQUksRUFBRSxhQUFhO0FBQ25CLFVBQVEsRUFBRSx5QkFBeUI7QUFDbkMsU0FBTyxFQUFFLElBQUk7QUFDYixRQUFNLEVBQUUsUUFBUTtBQUNoQixVQUFRLEVBQUUsR0FBRztDQUNkLEVBQ0Q7QUFDRSxJQUFFLEVBQUUsUUFBUTtBQUNaLE1BQUksRUFBRSxhQUFhO0FBQ25CLFVBQVEsRUFBRSx5QkFBeUI7QUFDbkMsU0FBTyxFQUFFLElBQUk7QUFDYixRQUFNLEVBQUUsUUFBUTtBQUNoQixVQUFRLEVBQUUsR0FBRztDQUNkLEVBQ0Q7QUFDRSxJQUFFLEVBQUUsUUFBUTtBQUNaLE1BQUksRUFBRSxhQUFhO0FBQ25CLFVBQVEsRUFBRSx5QkFBeUI7QUFDbkMsU0FBTyxF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QkFBSyxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQUMsR0FBRyxFQUFLO0FBQ3pCLHlCQUFPLHlCQUF1QixHQUFHLENBQUcsQ0FBQztpQkFDdEMsQ0FBQyxDQUFDO2VBQ0osTUFBTTtBQUNMLHVCQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztlQUMzQjthQUNGLENBQUM7Ozs7Ozs7S0FDSDs7O1dBRUksY0FBQyxJQUFJLEVBQUU7QUFDVixVQUFJLEdBQUcsR0FBRyxnQ0FBYSxJQUFJLENBQUMsQ0FBQztBQUM3QixVQUFJLE1BQU0sR0FBRyx3QkFBVyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7QUFDaEQsVUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDakQ7OztTQXpRRyxvQkFBb0I7OztRQTRRakIsb0JBQW9CLEdBQXBCLG9CQUFvQjtRQUFFLFFBQVEsR0FBUixRQUFRO1FBQUUsV0FBVyxHQUFYLFdBQVciLCJmaWxlIjoidGVzdC9oZWxwZXJzL3JlbW90ZS1kZWJ1Z2dlci1zZXJ2ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0cmFuc3BpbGU6bWFpblxuXG5pbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgYnBsaXN0Q3JlYXRlIGZyb20gJ2JwbGlzdC1jcmVhdG9yJztcbmltcG9ydCBicGxpc3RQYXJzZSBmcm9tICdicGxpc3QtcGFyc2VyJztcbmltcG9ydCBidWZmZXJwYWNrIGZyb20gJ2J1ZmZlcnBhY2snO1xuaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuXG5jb25zdCBsb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdSZW1vdGVEZWJ1Z2dlcicpO1xuXG5cbmNvbnN0IERFVklDRV9JTkZPID0ge1xuICBuYW1lOiAnaVBob25lIFNpbXVsYXRvcicsXG4gIGJ1aWxkOiAnV1A0MkZKJ1xufTtcblxuY29uc3QgQVBQX0lORk8gPSB7XG4gICdQSUQ6NDInOiB7XG4gICAgaWQ6ICdQSUQ6NDInLFxuICAgIG5hbWU6ICdhcHAnLFxuICAgIGJ1bmRsZUlkOiAnaW8uYXBwaXVtLmJ1bmRsZScsXG4gICAgaXNQcm94eTogZmFsc2UsXG4gICAgaG9zdElkOiAnJyxcbiAgICBpc0FjdGl2ZTogJzEnLFxuICAgIGlzQXV0b21hdGlvbkVuYWJsZWQ6IGZhbHNlXG4gIH1cbn07XG5cbi8vIGEgYnVuY2ggb2YgbmV3IGFwcCBpbmZvIHN0cnVjdHVyZXMgdG8gc2ltdWxhdGVcbi8vIHRoZSBhcHAgZ2V0dGluZyBwcm94aWVkIHRocm91Z2ggb3RoZXIgYXBwc1xuY29uc3QgVVBEQVRFRF9BUFBfSU5GTyA9IFtcbiAge1xuICAgIGlkOiAnUElEOjQ0JyxcbiAgICBuYW1lOiAncHJveHkgYXBwIDEnLFxuICAgIGJ1bmRsZUlkOiAnaW8uYXBwaXVtLmJ1bmRsZS5wcm94eTEnLFxuICAgIGlzUHJveHk6IHRydWUsXG4gICAgaG9zdElkOiAnUElEOjQyJyxcbiAgICBpc0FjdGl2ZTogJzEnXG4gIH0sXG4gIHtcbiAgICBpZDogJ1BJRDo0NicsXG4gICAgbmFtZTogJ3Byb3h5IGFwcCAxJyxcbiAgICBidW5kbGVJZDogJ2lvLmFwcGl1bS5idW5kbGUucHJveHkxJyxcbiAgICBpc1Byb3h5OiB0cnVlLFxuICAgIGhvc3RJZDogJ1BJRDo0NCcsXG4gICAgaXNBY3RpdmU6ICcxJ1xuICB9LFxuICB7XG4gICAgaWQ6ICdQSUQ6NDgnLFxuICAgIG5hbWU6ICdwcm94eSBhcHAgMScsXG4gICAgYnVuZGxlSWQ6ICdpby5hcHBpdW0uYnVuZGxlLnByb3h5MScsXG4gICAgaXNQcm94eTogdHJ1ZSxcbiAgICBob3N0SWQ6ICdQSUQ6NDYnLFxuICAgIGlzQWN0aXZlOiAnMSdcbiAgfSxcbiAge1xuICAgIGlkOiAnUElEOjUwJyxcbiAgICBuYW1lOiAncHJveHkgYXBwIDEnLFxuICAgIGJ1bmRsZUlkOiAnaW8uYXBwaXVtLmJ1bmRsZS5wcm94eTEnLFxuICAgIGlzUHJveHk6IHRydWUsXG4gICAgaG9zdElkOiAnUElEOjQ4JyxcbiAgICBpc0FjdGl2ZTogJzEnXG4gIH1cbl07XG5cblxuLypcbiAqIEEgZmFrZSByZW1vdGUgZGVidWdnZXIgc2VydmVyIHRoYXQgY2FuIGJlIHRvbGQgdG8gc2VuZCBjZXJ0YWluXG4gKiBtZXNzYWdlcyBiYWNrIHRvIHRoZSBjbGllbnQsIGFuZCB0byByZXR1cm4gY2VydGFpbiB2YWx1ZXMuXG4gKiBVc2VkIGZvciB0ZXN0aW5nIHRoZSBjbGllbnQuXG4gKi9cbmNsYXNzIFJlbW90ZURlYnVnZ2VyU2VydmVyIHtcbiAgY29uc3RydWN0b3IgKCkge1xuICAgIHRoaXMuc2VydmVyID0gbnVsbDtcbiAgICB0aGlzLmNsaWVudCA9IG51bGw7XG4gICAgdGhpcy5wZW5kaW5nQXBwQ2hhbmdlID0gZmFsc2U7XG4gICAgdGhpcy5hcHBJZEtleSA9ICdQSUQ6NDInO1xuICAgIHRoaXMuZGVzdGluYXRpb25LZXkgPSAnMic7XG4gICAgdGhpcy5hcHAgPSAxO1xuICAgIHRoaXMuZGF0YVJlc3BvbnNlVmFsdWUgPSBbXTtcbiAgfVxuXG4gIF9nZXRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3QgKG51bSkge1xuICAgIGxldCBkYXRhID0ge1xuICAgICAgX19zZWxlY3RvcjogJ19ycGNfcmVwb3J0Q29ubmVjdGVkQXBwbGljYXRpb25MaXN0OicsXG4gICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgIFdJUkFwcGxpY2F0aW9uRGljdGlvbmFyeUtleTogW3tcbiAgICAgICAgICBXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6IEFQUF9JTkZPWydQSUQ6NDInXS5pZCxcbiAgICAgICAgICBXSVJBcHBsaWNhdGlvbk5hbWVLZXk6IEFQUF9JTkZPWydQSUQ6NDInXS5uYW1lLFxuICAgICAgICAgIFdJUkFwcGxpY2F0aW9uQnVuZGxlSWRlbnRpZmllcktleTogQVBQX0lORk9bJ1BJRDo0MiddLmJ1bmRsZUlkLFxuICAgICAgICAgIFdJUklzQXBwbGljYXRpb25Qcm94eUtleTogQVBQX0lORk9bJ1BJRDo0MiddLmlzUHJveHksXG4gICAgICAgICAgV0lSSG9zdEFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogQVBQX0lORk9bJ1BJRDo0MiddLmhvc3RJZCxcbiAgICAgICAgICBXSVJJc0FwcGxpY2F0aW9uQWN0aXZlS2V5OiBBUFBfSU5GT1snUElEOjQyJ10uaXNBY3RpdmVcbiAgICAgICAgfV1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgLy8gYWRkIG1vcmVcbiAgICBpZiAobnVtID4gVVBEQVRFRF9BUFBfSU5GTysxKSB7XG4gICAgICAvLyB3ZSBvbmx5IGhhdmUgc28gbWFueSB0byBnaXZlIVxuICAgICAgbnVtID0gVVBEQVRFRF9BUFBfSU5GTyArIDE7XG4gICAgfVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtLTE7IGkrKykge1xuICAgICAgbGV0IGVudHJ5ID0gVVBEQVRFRF9BUFBfSU5GT1tpXTtcbiAgICAgIGRhdGEuX19hcmd1bWVudC5XSVJBcHBsaWNhdGlvbkRpY3Rpb25hcnlLZXkucHVzaCh7W2VudHJ5LmlkXTogZW50cnl9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuXG4gIGhhbmRsZVJlcG9ydElkZW50aWZpZXIgKCkge1xuICAgIGxldCBkYXRhID0ge1xuICAgICAgX19zZWxlY3RvcjogJ19ycGNfcmVwb3J0U2V0dXA6JyxcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSU2ltdWxhdG9yTmFtZUtleTogREVWSUNFX0lORk8ubmFtZSxcbiAgICAgICAgV0lSU2ltdWxhdG9yQnVpbGRLZXk6IERFVklDRV9JTkZPLmJ1aWxkXG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLnNlbmQoZGF0YSk7XG5cbiAgICBpZiAodGhpcy5kYXRhUmVzcG9uc2VFcnJvcikge1xuICAgICAgZGF0YSA9IHtcbiAgICAgICAgX19zZWxlY3RvcjogJ19ycGNfcmVwb3J0Q29ubmVjdGVkQXBwbGljYXRpb25MaXN0OicsXG4gICAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICB2YWx1ZTogdGhpcy5kYXRhUmVzcG9uc2VFcnJvclxuICAgICAgICB9LFxuICAgICAgICB3YXNUaHJvd246IHRydWVcbiAgICAgIH07XG4gICAgICB0aGlzLmRhdGFSZXNwb25zZUVycm9yID0gbnVsbDtcbiAgICB9IGVsc2Uge1xuICAgICAgZGF0YSA9IHRoaXMuX2dldENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdCgxKTtcbiAgICB9XG4gICAgdGhpcy5zZW5kKGRhdGEpO1xuICB9XG5cbiAgaGFuZGxlR2V0TGlzdGluZyAoKSB7XG4gICAgLy8gaWYgd2UgaGF2ZSBwZW5kaW5nIGFwcCBjaGFuZ2UgZXZlbnRzLCBzZW5kIHRoZW1cbiAgICBpZiAodGhpcy5wZW5kaW5nQXBwQ2hhbmdlKSB7XG4gICAgICB0aGlzLmNoYW5nZUFwcCh0aGlzLnBlbmRpbmdBcHBDaGFuZ2UsIHRydWUpO1xuICAgICAgdGhpcy5wZW5kaW5nQXBwQ2hhbmdlID0gMDtcbiAgICB9XG5cbiAgICAvLyBuZWVkIHRvIHNlbmQgYW4gYXBwIGRpY3Rpb25hcnkgYmFja1xuICAgIGxldCBkYXRhID0ge1xuICAgICAgX19zZWxlY3RvcjogJ19ycGNfYXBwbGljYXRpb25TZW50TGlzdGluZzonLFxuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6ICdQSUQ6NDInLFxuICAgICAgICBXSVJMaXN0aW5nS2V5OiB7XG4gICAgICAgICAgJzEnOiB7XG4gICAgICAgICAgICBXSVJUeXBlS2V5OiAnV0lSVHlwZVdlYicsXG4gICAgICAgICAgICBXSVJQYWdlSWRlbnRpZmllcktleTogMSxcbiAgICAgICAgICAgIFdJUlRpdGxlS2V5OiAnJyxcbiAgICAgICAgICAgIFdJUlVSTEtleTogJ2Fib3V0OmJsYW5rJ1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5zZW5kKGRhdGEpO1xuICB9XG5cbiAgaGFuZGxlU29ja2V0RGF0YSAocGxpc3QpIHtcbiAgICBsZXQgcGxpc3REYXRhID0gSlNPTi5wYXJzZShwbGlzdC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkudG9TdHJpbmcoJ3V0ZjgnKSk7XG5cbiAgICBsZXQgcmVzdWx0ID0ge307XG4gICAgaWYgKHRoaXMuZGF0YVJlc3BvbnNlRXJyb3IpIHtcbiAgICAgIHJlc3VsdCA9IHtcbiAgICAgICAgcmVzdWx0OiB7XG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgdmFsdWU6IHRoaXMuZGF0YVJlc3BvbnNlRXJyb3JcbiAgICAgICAgfSxcbiAgICAgICAgd2FzVGhyb3duOiB0cnVlXG4gICAgICB9O1xuICAgICAgdGhpcy5kYXRhUmVzcG9uc2VFcnJvciA9IG51bGw7XG4gICAgfSBlbHNlIGlmICh0aGlzLmRhdGFSZXNwb25zZVZhbHVlLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIGFkZCB0aGUgcmVzcG9uc2UgdmFsdWVcbiAgICAgIHJlc3VsdCA9IHtcbiAgICAgICAgcmVzdWx0OiB7XG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgdmFsdWU6IHRoaXMuZGF0YVJlc3BvbnNlVmFsdWUuc2hpZnQoKVxuICAgICAgICB9LFxuICAgICAgICB3YXNUaHJvd246IGZhbHNlXG4gICAgICB9O1xuICAgIH1cblxuICAgIGxldCBkYXRhS2V5ID0ge1xuICAgICAgcmVzdWx0LFxuICAgICAgaWQ6IHBsaXN0RGF0YS5pZFxuICAgIH07XG4gICAgZGF0YUtleSA9IG5ldyBCdWZmZXIoSlNPTi5zdHJpbmdpZnkoZGF0YUtleSkpO1xuICAgIGxldCBkYXRhID0ge1xuICAgICAgX19zZWxlY3RvcjogJ19ycGNfYXBwbGljYXRpb25TZW50RGF0YTonLFxuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJEZXN0aW5hdGlvbktleTogcGxpc3QuX19hcmd1bWVudC5XSVJTZW5kZXJLZXksXG4gICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogcGxpc3QuX19hcmd1bWVudC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXksXG4gICAgICAgIFdJUk1lc3NhZ2VEYXRhS2V5OiBkYXRhS2V5XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLnNlbmQoZGF0YSk7XG4gIH1cblxuICBjaGFuZ2VBcHAgKG51bSA9IDEsIGltbWVkaWF0ZSA9IHRydWUpIHtcbiAgICBpZiAoaW1tZWRpYXRlKSB7XG4gICAgICBpZiAobnVtID4gVVBEQVRFRF9BUFBfSU5GTy5sZW5ndGgtMSkge1xuICAgICAgICAvLyB3ZSBvbmx5IGhhdmUgYSBjZXJ0YWluIG51bWJlciBvZiBpbmZvIHRvIHNlbmRcbiAgICAgICAgbnVtID0gVVBEQVRFRF9BUFBfSU5GTy5sZW5ndGggLSAxO1xuICAgICAgfVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW07IGkrKykge1xuICAgICAgICBsZXQgZGF0YSA9IHtcbiAgICAgICAgICBfX3NlbGVjdG9yOiAnX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDonLFxuICAgICAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogVVBEQVRFRF9BUFBfSU5GT1t0aGlzLmFwcC0xXS5pZCxcbiAgICAgICAgICAgIFdJUkFwcGxpY2F0aW9uTmFtZUtleTogVVBEQVRFRF9BUFBfSU5GT1t0aGlzLmFwcC0xXS5uYW1lLFxuICAgICAgICAgICAgV0lSQXBwbGljYXRpb25CdW5kbGVJZGVudGlmaWVyS2V5OiBVUERBVEVEX0FQUF9JTkZPW3RoaXMuYXBwLTFdLmJ1bmRsZUlkLFxuICAgICAgICAgICAgV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5OiBVUERBVEVEX0FQUF9JTkZPW3RoaXMuYXBwLTFdLmlzUHJveHksXG4gICAgICAgICAgICBXSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBVUERBVEVEX0FQUF9JTkZPW3RoaXMuYXBwLTFdLmhvc3RJZCxcbiAgICAgICAgICAgIFdJUklzQXBwbGljYXRpb25BY3RpdmVLZXk6IFVQREFURURfQVBQX0lORk9bdGhpcy5hcHAtMV0uaXNBY3RpdmVcbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuc2VuZChkYXRhKTtcblxuICAgICAgICB0aGlzLmFwcCsrO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnBlbmRpbmdBcHBDaGFuZ2UgPSBudW07XG4gICAgfVxuICB9XG5cbiAgc2VuZFBhZ2VJbmZvTWVzc2FnZSAoYXBwSWRLZXkpIHtcbiAgICBsZXQgZGF0YSA9IHtcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX2FwcGxpY2F0aW9uU2VudExpc3Rpbmc6JyxcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBhcHBJZEtleSxcbiAgICAgICAgV0lSTGlzdGluZ0tleToge1xuICAgICAgICAgICcxJzoge1xuICAgICAgICAgICAgV0lSVHlwZUtleTogJ1dJUlR5cGVXZWInLFxuICAgICAgICAgICAgV0lSUGFnZUlkZW50aWZpZXJLZXk6IDEsXG4gICAgICAgICAgICBXSVJUaXRsZUtleTogJycsXG4gICAgICAgICAgICBXSVJVUkxLZXk6ICdhYm91dDpibGFuaydcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuc2VuZChkYXRhKTtcbiAgfVxuXG4gIHNlbmRGcmFtZU5hdmlnYXRpb25NZXNzYWdlICgpIHtcbiAgICBsZXQgZGF0YUtleSA9IHtcbiAgICAgIG1ldGhvZDogJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnLFxuICAgICAgcmVzdWx0OiB7fSxcbiAgICAgIGlkOiAxXG4gICAgfTtcbiAgICBkYXRhS2V5ID0gbmV3IEJ1ZmZlcihKU09OLnN0cmluZ2lmeShkYXRhS2V5KSk7XG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19hcHBsaWNhdGlvblNlbnREYXRhOicsXG4gICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgIFdJUkRlc3RpbmF0aW9uS2V5OiB0aGlzLmRlc3RpbmF0aW9uS2V5LFxuICAgICAgICBXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICAgIFdJUk1lc3NhZ2VEYXRhS2V5OiBkYXRhS2V5XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLnNlbmQoZGF0YSk7XG4gIH1cblxuICBzZXREYXRhUmVzcG9uc2VFcnJvciAoZXJyb3IpIHtcbiAgICB0aGlzLmRhdGFSZXNwb25zZUVycm9yID0gZXJyb3I7XG4gIH1cblxuICBzZXREYXRhUmVzcG9uc2VWYWx1ZSAodmFsdWUpIHtcbiAgICB0aGlzLmRhdGFSZXNwb25zZVZhbHVlLnB1c2godmFsdWUpO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnNlcnZlciA9IG5ldC5jcmVhdGVTZXJ2ZXIoKGMpID0+IHtcbiAgICAgICAgdGhpcy5jbGllbnQgPSBjO1xuICAgICAgICBjLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgbG9nLmRlYnVnKCdjbGllbnQgZGlzY29ubmVjdGVkJyk7XG4gICAgICAgIH0pO1xuICAgICAgICBjLm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgICBsZXQgcGxpc3QgPSBicGxpc3RQYXJzZS5wYXJzZUJ1ZmZlcihkYXRhLnNsaWNlKDQpKTtcblxuICAgICAgICAgIGlmICghcGxpc3RbMF0uX19zZWxlY3Rvcikge1xuICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgVW5hYmxlIHRvIGRlY2lwaGVyIHBsaXN0OiAke3BsaXN0fWApKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBzd2l0Y2ggKHBsaXN0WzBdLl9fc2VsZWN0b3IpIHtcbiAgICAgICAgICAgIGNhc2UgJ19ycGNfcmVwb3J0SWRlbnRpZmllcjonOlxuICAgICAgICAgICAgICB0aGlzLmhhbmRsZVJlcG9ydElkZW50aWZpZXIocGxpc3RbMF0pO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ19ycGNfZm9yd2FyZEdldExpc3Rpbmc6JzpcbiAgICAgICAgICAgICAgdGhpcy5oYW5kbGVHZXRMaXN0aW5nKHBsaXN0WzBdKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdfcnBjX2ZvcndhcmRTb2NrZXRTZXR1cDonOlxuICAgICAgICAgICAgICAvLyBkbyBub3RoaW5nXG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnX3JwY19mb3J3YXJkU29ja2V0RGF0YTonOlxuICAgICAgICAgICAgICB0aGlzLmhhbmRsZVNvY2tldERhdGEocGxpc3RbMF0pO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ19ycGNfZm9yd2FyZEluZGljYXRlV2ViVmlldzonOlxuICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBOT1QgWUVUIElNUExFTUVOVEVEOiAke3BsaXN0WzBdLl9fc2VsZWN0b3J9YCkpO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgIHRoaXMuY2xpZW50LndyaXRlKCdkbyBub3QgY29tcHV0ZScpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgLy8gZG9uJ3QgdXNlIHRoZSByZWFsIHBvcnQsIG9yIGFueSBvcGVuIHNpbXMgd2lsbCBicmVhayB0aGUgdGVzdHNcbiAgICAgIHRoaXMuc2VydmVyLmxpc3RlbigyNzc1NCwgJzo6MScsICgpID0+IHtcbiAgICAgICAgbG9nLmluZm8oYHNlcnZlciBib3VuZDogJHtKU09OLnN0cmluZ2lmeSh0aGlzLnNlcnZlci5hZGRyZXNzKCkpfWApO1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHN0b3AgKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgaWYgKHRoaXMuc2VydmVyKSB7XG4gICAgICAgIGlmICh0aGlzLmNsaWVudCkge1xuICAgICAgICAgIHRoaXMuY2xpZW50LmVuZCgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2VydmVyLmNsb3NlKChlcnIpID0+IHtcbiAgICAgICAgICByZXNvbHZlKGBTdG9wcGVkIGxpc3RlbmluZzogJHtlcnJ9YCk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzb2x2ZSgnTm90IGxpc3RlbmluZy4nKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHNlbmQgKGRhdGEpIHtcbiAgICBsZXQgYnVmID0gYnBsaXN0Q3JlYXRlKGRhdGEpO1xuICAgIGxldCBsZW5ndGggPSBidWZmZXJwYWNrLnBhY2soJ0wnLCBbYnVmLmxlbmd0aF0pO1xuICAgIHRoaXMuY2xpZW50LndyaXRlKEJ1ZmZlci5jb25jYXQoW2xlbmd0aCwgYnVmXSkpO1xuICB9XG59XG5cbmV4cG9ydCB7IFJlbW90ZURlYnVnZ2VyU2VydmVyLCBBUFBfSU5GTywgREVWSUNFX0lORk8gfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
