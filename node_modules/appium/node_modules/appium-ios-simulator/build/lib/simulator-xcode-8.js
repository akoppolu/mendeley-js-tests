'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _simulatorXcode6 = require('./simulator-xcode-6');

var _simulatorXcode7 = require('./simulator-xcode-7');

var _simulatorXcode72 = _interopRequireDefault(_simulatorXcode7);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _asyncbox = require('asyncbox');

var _teen_process = require('teen_process');

var _nodeSimctl = require('node-simctl');

// these sims are sloooooooow
var STARTUP_TIMEOUT = 120 * 1000;

var SimulatorXcode8 = (function (_SimulatorXcode7) {
  _inherits(SimulatorXcode8, _SimulatorXcode7);

  function SimulatorXcode8(udid, xcodeVersion) {
    _classCallCheck(this, SimulatorXcode8);

    _get(Object.getPrototypeOf(SimulatorXcode8.prototype), 'constructor', this).call(this, udid, xcodeVersion);

    // list of files to check for when seeing if a simulator is "fresh"
    // (meaning it has never been booted).
    // If these files are present, we assume it's been successfully booted
    this.isFreshFiles = ['Library/Cookies', 'Library/Preferences/.GlobalPreferences.plist', 'Library/Preferences/com.apple.springboard.plist', 'var/run/syslog.pid'];
  }

  _createClass(SimulatorXcode8, [{
    key: 'isAppInstalled',
    value: function isAppInstalled(bundleId) {
      var appContainer;
      return _regeneratorRuntime.async(function isAppInstalled$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.getAppContainer)(this.udid, bundleId, false));

          case 3:
            appContainer = context$2$0.sent;
            return context$2$0.abrupt('return', appContainer.endsWith('.app'));

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](0);
            return context$2$0.abrupt('return', false);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 7]]);
    }
  }, {
    key: 'waitForBoot',
    value: function waitForBoot(startupTimeout) {
      var startupTimestamp;
      return _regeneratorRuntime.async(function waitForBoot$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            startupTimestamp = process.hrtime();
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((function callee$2$0() {
              var isOnBootCompletedEmitted;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    isOnBootCompletedEmitted = false;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(function callee$3$0() {
                      var _ref, stdout;

                      return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                        while (1) switch (context$4$0.prev = context$4$0.next) {
                          case 0:
                            context$4$0.prev = 0;
                            context$4$0.next = 3;
                            return _regeneratorRuntime.awrap((0, _teen_process.exec)('bash', ['-c', 'ps axo command | grep Simulator | grep nsurlstoraged | grep -v bash | grep -v grep']));

                          case 3:
                            _ref = context$4$0.sent;
                            stdout = _ref.stdout;

                            if (!(stdout.trim().length > 0)) {
                              context$4$0.next = 10;
                              break;
                            }

                            if (!isOnBootCompletedEmitted) {
                              isOnBootCompletedEmitted = true;
                              this.emit(_simulatorXcode6.BOOT_COMPLETED_EVENT);
                            }
                            // 'springboard' process should be the last one to start after boot
                            // 'simctl launch' will block until this process is running
                            context$4$0.next = 9;
                            return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', ['simctl', 'launch', this.udid, 'com.apple.springboard']));

                          case 9:
                            return context$4$0.abrupt('return', true);

                          case 10:
                            context$4$0.next = 14;
                            break;

                          case 12:
                            context$4$0.prev = 12;
                            context$4$0.t0 = context$4$0['catch'](0);

                          case 14:
                            return context$4$0.abrupt('return', false);

                          case 15:
                          case 'end':
                            return context$4$0.stop();
                        }
                      }, null, _this, [[0, 12]]);
                    }, { waitMs: startupTimeout, intervalMs: 500 }));

                  case 3:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            })());

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].errorAndThrow('Simulator is not booted after ' + process.hrtime(startupTimestamp)[0] + ' seconds');

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }, {
    key: 'openUrl',
    value: function openUrl(url) {
      var SAFARI_STARTUP_TIMEOUT, launchTimestamp;
      return _regeneratorRuntime.async(function openUrl$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            SAFARI_STARTUP_TIMEOUT = 15 * 1000;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.isRunning());

          case 3:
            if (context$2$0.sent) {
              context$2$0.next = 5;
              break;
            }

            throw new Error('Tried to open ' + url + ', but Simulator is not in Booted state');

          case 5:
            launchTimestamp = process.hrtime();
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(function callee$2$0() {
              var stdout, _ref2, _ref2$stdout;

              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    stdout = undefined;
                    context$3$0.prev = 2;
                    context$3$0.next = 5;
                    return _regeneratorRuntime.awrap((0, _teen_process.exec)('bash', ['-c', 'ps axo command | grep Simulator | grep MobileSafari | grep -v bash | grep -v grep']));

                  case 5:
                    _ref2 = context$3$0.sent;
                    _ref2$stdout = _ref2.stdout;

                    // jshint ignore:start
                    stdout = _ref2$stdout === undefined ? '' : _ref2$stdout;
                    context$3$0.next = 15;
                    break;

                  case 10:
                    context$3$0.prev = 10;
                    context$3$0.t0 = context$3$0['catch'](2);

                    if (!(context$3$0.t0.code !== 1)) {
                      context$3$0.next = 14;
                      break;
                    }

                    throw context$3$0.t0;

                  case 14:
                    stdout = '';

                  case 15:
                    if (!(stdout.trim().length > 0)) {
                      context$3$0.next = 20;
                      break;
                    }

                    context$3$0.next = 18;
                    return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', ['simctl', 'openurl', this.udid, url]));

                  case 18:
                    context$3$0.next = 22;
                    break;

                  case 20:
                    context$3$0.next = 22;
                    return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', ['simctl', 'launch', this.udid, 'com.apple.mobilesafari', url]));

                  case 22:
                    return context$3$0.abrupt('return', true);

                  case 25:
                    context$3$0.prev = 25;
                    context$3$0.t1 = context$3$0['catch'](0);

                    _logger2['default'].error('Failed to open \'' + url + '\' in Safari. Retrying...');

                  case 28:
                    return context$3$0.abrupt('return', false);

                  case 29:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3, [[0, 25], [2, 10]]);
            }, { waitMs: SAFARI_STARTUP_TIMEOUT, intervalMs: 500 }));

          case 9:
            context$2$0.next = 14;
            break;

          case 11:
            context$2$0.prev = 11;
            context$2$0.t0 = context$2$0['catch'](6);

            _logger2['default'].errorAndThrow('Safari cannot open \'' + url + '\' after ' + process.hrtime(launchTimestamp)[0] + ' seconds');

          case 14:
            _logger2['default'].debug('Safari has successfully opened \'' + url + '\' in ' + process.hrtime(launchTimestamp)[0] + ' seconds');

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 11]]);
    }
  }, {
    key: 'startupTimeout',
    get: function get() {
      return STARTUP_TIMEOUT;
    }
  }]);

  return SimulatorXcode8;
})(_simulatorXcode72['default']);

exports['default'] = SimulatorXcode8;
module.exports = exports['default'];

// wait for the simulator to boot
// waiting for the simulator status to be 'booted' isn't good enough
// it claims to be booted way before finishing loading
// let's wait for the magic nsurlstoraged process, which signals the booting has been completed

// Continue iteration in case of error

// jshint ignore:end

// error code 1 can be thrown in normal situations when nothing is found

// Safari is already running. Open the url in the other tab

// Execute new Safari instance and open the url immediately
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7K0JBQXFDLHFCQUFxQjs7K0JBQzlCLHFCQUFxQjs7OztzQkFDakMsVUFBVTs7Ozt3QkFDTyxVQUFVOzs0QkFDdEIsY0FBYzs7MEJBQ0gsYUFBYTs7O0FBSTdDLElBQU0sZUFBZSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUM7O0lBRTdCLGVBQWU7WUFBZixlQUFlOztBQUNQLFdBRFIsZUFBZSxDQUNOLElBQUksRUFBRSxZQUFZLEVBQUU7MEJBRDdCLGVBQWU7O0FBRWpCLCtCQUZFLGVBQWUsNkNBRVgsSUFBSSxFQUFFLFlBQVksRUFBRTs7Ozs7QUFLMUIsUUFBSSxDQUFDLFlBQVksR0FBRyxDQUNsQixpQkFBaUIsRUFDakIsOENBQThDLEVBQzlDLGlEQUFpRCxFQUNqRCxvQkFBb0IsQ0FDckIsQ0FBQztHQUNIOztlQWJHLGVBQWU7O1dBZUUsd0JBQUMsUUFBUTtVQUV0QixZQUFZOzs7Ozs7NkNBQVMsaUNBQWdCLElBQUksQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQzs7O0FBQWhFLHdCQUFZO2dEQUNULFlBQVksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDOzs7OztnREFFN0IsS0FBSzs7Ozs7OztLQUVmOzs7V0FNaUIscUJBQUMsY0FBYztVQUt6QixnQkFBZ0I7Ozs7OztBQUFoQiw0QkFBZ0IsR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFOzs7O2tCQUVuQyx3QkFBd0I7Ozs7OztBQUF4Qiw0Q0FBd0IsR0FBRyxLQUFLOztxREFDOUIsZ0NBQWlCO2dDQUVkLE1BQU07Ozs7Ozs7NkRBQVUsd0JBQUssTUFBTSxFQUFFLENBQUMsSUFBSSxFQUNyQyxvRkFBb0YsQ0FBQyxDQUFDOzs7O0FBRG5GLGtDQUFNLFFBQU4sTUFBTTs7a0NBRVAsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUE7Ozs7O0FBQzFCLGdDQUFJLENBQUMsd0JBQXdCLEVBQUU7QUFDN0Isc0RBQXdCLEdBQUcsSUFBSSxDQUFDO0FBQ2hDLGtDQUFJLENBQUMsSUFBSSx1Q0FBc0IsQ0FBQzs2QkFDakM7Ozs7NkRBR0ssd0JBQUssT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLHVCQUF1QixDQUFDLENBQUM7OztnRUFDdEUsSUFBSTs7Ozs7Ozs7Ozs7Z0VBS1IsS0FBSzs7Ozs7OztxQkFDYixFQUFFLEVBQUMsTUFBTSxFQUFFLGNBQWMsRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFDLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRTdDLGdDQUFJLGFBQWEsb0NBQWtDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBVyxDQUFDOzs7Ozs7O0tBRXJHOzs7V0FFYSxpQkFBQyxHQUFHO1VBQ1Ysc0JBQXNCLEVBS3RCLGVBQWU7Ozs7OztBQUxmLGtDQUFzQixHQUFHLEVBQUUsR0FBRyxJQUFJOzs2Q0FFN0IsSUFBSSxDQUFDLFNBQVMsRUFBRTs7Ozs7Ozs7a0JBQ25CLElBQUksS0FBSyxvQkFBa0IsR0FBRyw0Q0FBeUM7OztBQUV6RSwyQkFBZSxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUU7Ozs2Q0FFaEMsZ0NBQWlCO2tCQUVmLE1BQU07Ozs7OztBQUFOLDBCQUFNOzs7cURBR2Usd0JBQUssTUFBTSxFQUNoQyxDQUFDLElBQUksRUFBRSxtRkFBbUYsQ0FBQyxDQUFDOzs7O3lDQUQ1RixNQUFNOzs7QUFBTiwwQkFBTSxnQ0FBRyxFQUFFOzs7Ozs7OzswQkFLVCxlQUFJLElBQUksS0FBSyxDQUFDLENBQUE7Ozs7Ozs7O0FBR2xCLDBCQUFNLEdBQUcsRUFBRSxDQUFDOzs7MEJBRVYsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUE7Ozs7OztxREFFcEIsd0JBQUssT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDOzs7Ozs7OztxREFHcEQsd0JBQUssT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLHdCQUF3QixFQUFFLEdBQUcsQ0FBQyxDQUFDOzs7d0RBRTlFLElBQUk7Ozs7OztBQUVYLHdDQUFJLEtBQUssdUJBQW9CLEdBQUcsK0JBQTJCLENBQUM7Ozt3REFFdkQsS0FBSzs7Ozs7OzthQUNiLEVBQUUsRUFBQyxNQUFNLEVBQUUsc0JBQXNCLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBQyxDQUFDOzs7Ozs7Ozs7O0FBRXJELGdDQUFJLGFBQWEsMkJBQXdCLEdBQUcsaUJBQVcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBVyxDQUFDOzs7QUFFdkcsZ0NBQUksS0FBSyx1Q0FBb0MsR0FBRyxjQUFRLE9BQU8sQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQVcsQ0FBQzs7Ozs7OztLQUN2Rzs7O1NBNUVrQixlQUFHO0FBQ3BCLGFBQU8sZUFBZSxDQUFDO0tBQ3hCOzs7U0ExQkcsZUFBZTs7O3FCQXdHTixlQUFlIiwiZmlsZSI6ImxpYi9zaW11bGF0b3IteGNvZGUtOC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJPT1RfQ09NUExFVEVEX0VWRU5UIH0gZnJvbSAnLi9zaW11bGF0b3IteGNvZGUtNic7XG5pbXBvcnQgU2ltdWxhdG9yWGNvZGU3IGZyb20gJy4vc2ltdWxhdG9yLXhjb2RlLTcnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBnZXRBcHBDb250YWluZXIgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5cblxuLy8gdGhlc2Ugc2ltcyBhcmUgc2xvb29vb29vb3dcbmNvbnN0IFNUQVJUVVBfVElNRU9VVCA9IDEyMCAqIDEwMDA7XG5cbmNsYXNzIFNpbXVsYXRvclhjb2RlOCBleHRlbmRzIFNpbXVsYXRvclhjb2RlNyB7XG4gIGNvbnN0cnVjdG9yICh1ZGlkLCB4Y29kZVZlcnNpb24pIHtcbiAgICBzdXBlcih1ZGlkLCB4Y29kZVZlcnNpb24pO1xuXG4gICAgLy8gbGlzdCBvZiBmaWxlcyB0byBjaGVjayBmb3Igd2hlbiBzZWVpbmcgaWYgYSBzaW11bGF0b3IgaXMgXCJmcmVzaFwiXG4gICAgLy8gKG1lYW5pbmcgaXQgaGFzIG5ldmVyIGJlZW4gYm9vdGVkKS5cbiAgICAvLyBJZiB0aGVzZSBmaWxlcyBhcmUgcHJlc2VudCwgd2UgYXNzdW1lIGl0J3MgYmVlbiBzdWNjZXNzZnVsbHkgYm9vdGVkXG4gICAgdGhpcy5pc0ZyZXNoRmlsZXMgPSBbXG4gICAgICAnTGlicmFyeS9Db29raWVzJyxcbiAgICAgICdMaWJyYXJ5L1ByZWZlcmVuY2VzLy5HbG9iYWxQcmVmZXJlbmNlcy5wbGlzdCcsXG4gICAgICAnTGlicmFyeS9QcmVmZXJlbmNlcy9jb20uYXBwbGUuc3ByaW5nYm9hcmQucGxpc3QnLFxuICAgICAgJ3Zhci9ydW4vc3lzbG9nLnBpZCdcbiAgICBdO1xuICB9XG5cbiAgYXN5bmMgaXNBcHBJbnN0YWxsZWQgKGJ1bmRsZUlkKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBhcHBDb250YWluZXIgPSBhd2FpdCBnZXRBcHBDb250YWluZXIodGhpcy51ZGlkLCBidW5kbGVJZCwgZmFsc2UpO1xuICAgICAgcmV0dXJuIGFwcENvbnRhaW5lci5lbmRzV2l0aCgnLmFwcCcpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGdldCBzdGFydHVwVGltZW91dCAoKSB7XG4gICAgcmV0dXJuIFNUQVJUVVBfVElNRU9VVDtcbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JCb290IChzdGFydHVwVGltZW91dCkge1xuICAgIC8vIHdhaXQgZm9yIHRoZSBzaW11bGF0b3IgdG8gYm9vdFxuICAgIC8vIHdhaXRpbmcgZm9yIHRoZSBzaW11bGF0b3Igc3RhdHVzIHRvIGJlICdib290ZWQnIGlzbid0IGdvb2QgZW5vdWdoXG4gICAgLy8gaXQgY2xhaW1zIHRvIGJlIGJvb3RlZCB3YXkgYmVmb3JlIGZpbmlzaGluZyBsb2FkaW5nXG4gICAgLy8gbGV0J3Mgd2FpdCBmb3IgdGhlIG1hZ2ljIG5zdXJsc3RvcmFnZWQgcHJvY2Vzcywgd2hpY2ggc2lnbmFscyB0aGUgYm9vdGluZyBoYXMgYmVlbiBjb21wbGV0ZWRcbiAgICBjb25zdCBzdGFydHVwVGltZXN0YW1wID0gcHJvY2Vzcy5ocnRpbWUoKTtcbiAgICB0cnkge1xuICAgICAgbGV0IGlzT25Cb290Q29tcGxldGVkRW1pdHRlZCA9IGZhbHNlO1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnYmFzaCcsIFsnLWMnLFxuICAgICAgICAgICAgJ3BzIGF4byBjb21tYW5kIHwgZ3JlcCBTaW11bGF0b3IgfCBncmVwIG5zdXJsc3RvcmFnZWQgfCBncmVwIC12IGJhc2ggfCBncmVwIC12IGdyZXAnXSk7XG4gICAgICAgICAgaWYgKHN0ZG91dC50cmltKCkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgaWYgKCFpc09uQm9vdENvbXBsZXRlZEVtaXR0ZWQpIHtcbiAgICAgICAgICAgICAgaXNPbkJvb3RDb21wbGV0ZWRFbWl0dGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgdGhpcy5lbWl0KEJPT1RfQ09NUExFVEVEX0VWRU5UKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vICdzcHJpbmdib2FyZCcgcHJvY2VzcyBzaG91bGQgYmUgdGhlIGxhc3Qgb25lIHRvIHN0YXJ0IGFmdGVyIGJvb3RcbiAgICAgICAgICAgIC8vICdzaW1jdGwgbGF1bmNoJyB3aWxsIGJsb2NrIHVudGlsIHRoaXMgcHJvY2VzcyBpcyBydW5uaW5nXG4gICAgICAgICAgICBhd2FpdCBleGVjKCd4Y3J1bicsIFsnc2ltY3RsJywgJ2xhdW5jaCcsIHRoaXMudWRpZCwgJ2NvbS5hcHBsZS5zcHJpbmdib2FyZCddKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAgICAgLy8gQ29udGludWUgaXRlcmF0aW9uIGluIGNhc2Ugb2YgZXJyb3JcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9LCB7d2FpdE1zOiBzdGFydHVwVGltZW91dCwgaW50ZXJ2YWxNczogNTAwfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgU2ltdWxhdG9yIGlzIG5vdCBib290ZWQgYWZ0ZXIgJHtwcm9jZXNzLmhydGltZShzdGFydHVwVGltZXN0YW1wKVswXX0gc2Vjb25kc2ApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIG9wZW5VcmwgKHVybCkge1xuICAgIGNvbnN0IFNBRkFSSV9TVEFSVFVQX1RJTUVPVVQgPSAxNSAqIDEwMDA7XG5cbiAgICBpZiAoIWF3YWl0IHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJpZWQgdG8gb3BlbiAke3VybH0sIGJ1dCBTaW11bGF0b3IgaXMgbm90IGluIEJvb3RlZCBzdGF0ZWApO1xuICAgIH1cbiAgICBjb25zdCBsYXVuY2hUaW1lc3RhbXAgPSBwcm9jZXNzLmhydGltZSgpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBsZXQgc3Rkb3V0O1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBqc2hpbnQgaWdub3JlOnN0YXJ0XG4gICAgICAgICAgICAoe3N0ZG91dCA9ICcnfSA9IGF3YWl0IGV4ZWMoJ2Jhc2gnLFxuICAgICAgICAgICAgICBbJy1jJywgJ3BzIGF4byBjb21tYW5kIHwgZ3JlcCBTaW11bGF0b3IgfCBncmVwIE1vYmlsZVNhZmFyaSB8IGdyZXAgLXYgYmFzaCB8IGdyZXAgLXYgZ3JlcCddKSk7XG4gICAgICAgICAgICAvLyBqc2hpbnQgaWdub3JlOmVuZFxuICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgLy8gZXJyb3IgY29kZSAxIGNhbiBiZSB0aHJvd24gaW4gbm9ybWFsIHNpdHVhdGlvbnMgd2hlbiBub3RoaW5nIGlzIGZvdW5kXG4gICAgICAgICAgICBpZiAoZXJyLmNvZGUgIT09IDEpIHtcbiAgICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3Rkb3V0ID0gJyc7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChzdGRvdXQudHJpbSgpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIC8vIFNhZmFyaSBpcyBhbHJlYWR5IHJ1bm5pbmcuIE9wZW4gdGhlIHVybCBpbiB0aGUgb3RoZXIgdGFiXG4gICAgICAgICAgICBhd2FpdCBleGVjKCd4Y3J1bicsIFsnc2ltY3RsJywgJ29wZW51cmwnLCB0aGlzLnVkaWQsIHVybF0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBFeGVjdXRlIG5ldyBTYWZhcmkgaW5zdGFuY2UgYW5kIG9wZW4gdGhlIHVybCBpbW1lZGlhdGVseVxuICAgICAgICAgICAgYXdhaXQgZXhlYygneGNydW4nLCBbJ3NpbWN0bCcsICdsYXVuY2gnLCB0aGlzLnVkaWQsICdjb20uYXBwbGUubW9iaWxlc2FmYXJpJywgdXJsXSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGBGYWlsZWQgdG8gb3BlbiAnJHt1cmx9JyBpbiBTYWZhcmkuIFJldHJ5aW5nLi4uYCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSwge3dhaXRNczogU0FGQVJJX1NUQVJUVVBfVElNRU9VVCwgaW50ZXJ2YWxNczogNTAwfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgU2FmYXJpIGNhbm5vdCBvcGVuICcke3VybH0nIGFmdGVyICR7cHJvY2Vzcy5ocnRpbWUobGF1bmNoVGltZXN0YW1wKVswXX0gc2Vjb25kc2ApO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFNhZmFyaSBoYXMgc3VjY2Vzc2Z1bGx5IG9wZW5lZCAnJHt1cmx9JyBpbiAke3Byb2Nlc3MuaHJ0aW1lKGxhdW5jaFRpbWVzdGFtcClbMF19IHNlY29uZHNgKTtcbiAgfVxuXG59XG5cbmV4cG9ydCBkZWZhdWx0IFNpbXVsYXRvclhjb2RlODtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
