'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _interopRequireWildcard = require('babel-runtime/helpers/interop-require-wildcard')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _nodeSimctl = require('node-simctl');

var simctl = _interopRequireWildcard(_nodeSimctl);

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _utilsJs = require('./utils.js');

var _touchEnrollJs = require('./touch-enroll.js');

var _asyncbox = require('asyncbox');

var _settings = require('./settings');

var settings = _interopRequireWildcard(_settings);

var _teen_process = require('teen_process');

var _tailUntilJs = require('./tail-until.js');

var _extensionsIndex = require('./extensions/index');

var _extensionsIndex2 = _interopRequireDefault(_extensionsIndex);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _calendar = require('./calendar');

var _calendar2 = _interopRequireDefault(_calendar);

var EventEmitter = _events2['default'].EventEmitter;

var OPEN_TIMEOUT = 3000;
var STARTUP_TIMEOUT = 60 * 1000;
var EXTRA_STARTUP_TIME = 2000;
/*
 * This event is emitted as soon as iOS Simulator
 * has finished booting and it is ready to accept xcrun commands.
 * The event handler is called after 'run' method is completed
 * for Xcode 7 and older and is only useful in Xcode 8+,
 * since one can start doing stuff (for example install/uninstall an app) in parallel
 * with Simulator UI startup, which shortens session startup time.
 */
var BOOT_COMPLETED_EVENT = 'bootCompleted';

var SimulatorXcode6 = (function (_EventEmitter) {
  _inherits(SimulatorXcode6, _EventEmitter);

  function SimulatorXcode6(udid, xcodeVersion) {
    _classCallCheck(this, SimulatorXcode6);

    _get(Object.getPrototypeOf(SimulatorXcode6.prototype), 'constructor', this).call(this);
    this.udid = String(udid);
    this.xcodeVersion = xcodeVersion;

    // platformVersion cannot be found initially, since getting it has side effects for
    // our logic for figuring out if a sim has been run
    // it will be set when it is needed
    this._platformVersion = null;

    this.keychainPath = _path2['default'].resolve(this.getDir(), 'Library', 'Keychains');
    this.simulatorApp = 'iOS Simulator.app';

    this.scaleFactor = null;
    this.connectHardwareKeyboard = null;

    this.appDataBundlePaths = {};

    // list of files to check for when seeing if a simulator is "fresh"
    // (meaning it has never been booted).
    // If these files are present, we assume it's been successfully booted
    this.isFreshFiles = ['Library/ConfigurationProfiles', 'Library/Cookies', 'Library/Preferences/.GlobalPreferences.plist', 'Library/Preferences/com.apple.springboard.plist', 'var/run/syslog.pid'];

    // extra time to wait for simulator to be deemed booted
    this.extraStartupTime = EXTRA_STARTUP_TIME;

    this.calendar = new _calendar2['default'](this.getDir());
  }

  _createClass(SimulatorXcode6, [{
    key: 'setScaleFactor',
    value: function setScaleFactor(newScaleFactor) {
      var supportedScales = ['1.0', '0.75', '0.5', '0.33', '0.25'];
      if (supportedScales.indexOf(newScaleFactor) < 0) {
        var msg = 'Only "' + supportedScales + '" values are supported as scale factors. "' + newScaleFactor + '" is passed instead.';
        _logger2['default'].errorAndThrow(msg);
      }
      this.scaleFactor = newScaleFactor;
    }
  }, {
    key: 'setConnectHardwareKeyboard',
    value: function setConnectHardwareKeyboard(newValue) {
      this.connectHardwareKeyboard = newValue;
    }
  }, {
    key: 'getPlatformVersion',
    value: function getPlatformVersion() {
      var _ref, sdk;

      return _regeneratorRuntime.async(function getPlatformVersion$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this._platformVersion) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.stat());

          case 3:
            _ref = context$2$0.sent;
            sdk = _ref.sdk;

            this._platformVersion = sdk;

          case 6:
            return context$2$0.abrupt('return', this._platformVersion);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getRootDir',
    value: function getRootDir() {
      var home = process.env.HOME;
      return _path2['default'].resolve(home, 'Library', 'Developer', 'CoreSimulator', 'Devices');
    }
  }, {
    key: 'getDir',
    value: function getDir() {
      return _path2['default'].resolve(this.getRootDir(), this.udid, 'data');
    }
  }, {
    key: 'getLogDir',
    value: function getLogDir() {
      var home = process.env.HOME;
      return _path2['default'].resolve(home, 'Library', 'Logs', 'CoreSimulator', this.udid);
    }
  }, {
    key: 'installApp',
    value: function installApp(app) {
      return _regeneratorRuntime.async(function installApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(simctl.installApp(this.udid, app));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'isAppInstalled',
    value: function isAppInstalled(bundleId) {
      var appFile = arguments.length <= 1 || arguments[1] === undefined ? null : arguments[1];
      var appDirs;
      return _regeneratorRuntime.async(function isAppInstalled$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getAppDirs(appFile, bundleId));

          case 2:
            appDirs = context$2$0.sent;
            return context$2$0.abrupt('return', appDirs.length !== 0);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /*
     * takes an `id`, which is either a bundleId (e.g., com.apple.mobilesafari)
     * or, for iOS 7.1, the app name without `.app` (e.g., MobileSafari)
     */
  }, {
    key: 'getAppDir',
    value: function getAppDir(id) {
      var subDir = arguments.length <= 1 || arguments[1] === undefined ? 'Data' : arguments[1];
      return _regeneratorRuntime.async(function getAppDir$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.appDataBundlePaths[subDir] = this.appDataBundlePaths[subDir] || {};
            context$2$0.t0 = _lodash2['default'].isEmpty(this.appDataBundlePaths[subDir]);

            if (!context$2$0.t0) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.isFresh());

          case 5:
            context$2$0.t0 = !context$2$0.sent;

          case 6:
            if (!context$2$0.t0) {
              context$2$0.next = 10;
              break;
            }

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.buildBundlePathMap(subDir));

          case 9:
            this.appDataBundlePaths[subDir] = context$2$0.sent;

          case 10:
            return context$2$0.abrupt('return', this.appDataBundlePaths[subDir][id]);

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /*
     * the xcode 6 simulators are really annoying, and bury the main app
     * directories inside directories just named with Hashes.
     * This function finds the proper directory by traversing all of them
     * and reading a metadata plist (Mobile Container Manager) to get the
     * bundle id.
     */
  }, {
    key: 'buildBundlePathMap',
    value: function buildBundlePathMap() {
      var subDir = arguments.length <= 0 || arguments[0] === undefined ? 'Data' : arguments[0];
      var applicationList, pathBundlePair, bundlePathDirs, bundlePathPairs;
      return _regeneratorRuntime.async(function buildBundlePathMap$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Building bundle path map');
            applicationList = undefined;
            pathBundlePair = undefined;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.getPlatformVersion());

          case 5:
            context$2$0.t0 = context$2$0.sent;

            if (!(context$2$0.t0 === '7.1')) {
              context$2$0.next = 11;
              break;
            }

            // apps available
            //   Web.app,
            //   WebViewService.app,
            //   MobileSafari.app,
            //   WebContentAnalysisUI.app,
            //   DDActionsService.app,
            //   StoreKitUIService.app
            applicationList = _path2['default'].resolve(this.getDir(), 'Applications');
            pathBundlePair = function callee$2$0(dir) {
              var appFiles, bundleId;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    dir = _path2['default'].resolve(applicationList, dir);
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap(_appiumSupport.fs.glob(dir + '/*.app'));

                  case 3:
                    appFiles = context$3$0.sent;
                    bundleId = appFiles[0].match(/.*\/(.*)\.app/)[1];
                    return context$3$0.abrupt('return', { path: dir, bundleId: bundleId });

                  case 6:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            };
            context$2$0.next = 12;
            break;

          case 11:
            (function () {
              applicationList = _path2['default'].resolve(_this.getDir(), 'Containers', subDir, 'Application');
              // given a directory, find the plist file and pull the bundle id from it
              var readBundleId = function readBundleId(dir) {
                var plist, metadata;
                return _regeneratorRuntime.async(function readBundleId$(context$4$0) {
                  while (1) switch (context$4$0.prev = context$4$0.next) {
                    case 0:
                      plist = _path2['default'].resolve(dir, '.com.apple.mobile_container_manager.metadata.plist');
                      context$4$0.next = 3;
                      return _regeneratorRuntime.awrap(settings.read(plist));

                    case 3:
                      metadata = context$4$0.sent;
                      return context$4$0.abrupt('return', metadata.MCMMetadataIdentifier);

                    case 5:
                    case 'end':
                      return context$4$0.stop();
                  }
                }, null, _this);
              };
              // given a directory, return the path and bundle id associated with it
              pathBundlePair = function callee$3$0(dir) {
                var bundleId;
                return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                  while (1) switch (context$4$0.prev = context$4$0.next) {
                    case 0:
                      dir = _path2['default'].resolve(applicationList, dir);
                      context$4$0.next = 3;
                      return _regeneratorRuntime.awrap(readBundleId(dir));

                    case 3:
                      bundleId = context$4$0.sent;
                      return context$4$0.abrupt('return', { path: dir, bundleId: bundleId });

                    case 5:
                    case 'end':
                      return context$4$0.stop();
                  }
                }, null, _this);
              };
            })();

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.readdir(applicationList));

          case 14:
            bundlePathDirs = context$2$0.sent;
            context$2$0.next = 17;
            return _regeneratorRuntime.awrap((0, _asyncbox.asyncmap)(bundlePathDirs, function callee$2$0(dir) {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(pathBundlePair(dir));

                  case 2:
                    return context$3$0.abrupt('return', context$3$0.sent);

                  case 3:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            }, false));

          case 17:
            bundlePathPairs = context$2$0.sent;
            return context$2$0.abrupt('return', bundlePathPairs.reduce(function (bundleMap, bundlePath) {
              bundleMap[bundlePath.bundleId] = bundlePath.path;
              return bundleMap;
            }, {}));

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // returns state and specifics of this sim.
    // { name: 'iPhone 4s',
    //   udid: 'C09B34E5-7DCB-442E-B79C-AB6BC0357417',
    //   state: 'Shutdown',
    //   sdk: '8.3'
    // }
  }, {
    key: 'stat',
    value: function stat() {
      var devices, normalizedDevices, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _loop, _iterator, _step;

      return _regeneratorRuntime.async(function stat$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(simctl.getDevices());

          case 2:
            devices = context$2$0.sent;
            normalizedDevices = [];
            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            context$2$0.prev = 7;

            _loop = function () {
              var _step$value = _slicedToArray(_step.value, 2);

              var sdk = _step$value[0];
              var deviceArr = _step$value[1];

              deviceArr = deviceArr.map(function (device) {
                device.sdk = sdk;
                return device;
              });
              normalizedDevices = normalizedDevices.concat(deviceArr);
            };

            // add sdk attribute to all entries, add to normalizedDevices
            for (_iterator = _getIterator(_lodash2['default'].toPairs(devices)); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
              _loop();
            }

            context$2$0.next = 16;
            break;

          case 12:
            context$2$0.prev = 12;
            context$2$0.t0 = context$2$0['catch'](7);
            _didIteratorError = true;
            _iteratorError = context$2$0.t0;

          case 16:
            context$2$0.prev = 16;
            context$2$0.prev = 17;

            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }

          case 19:
            context$2$0.prev = 19;

            if (!_didIteratorError) {
              context$2$0.next = 22;
              break;
            }

            throw _iteratorError;

          case 22:
            return context$2$0.finish(19);

          case 23:
            return context$2$0.finish(16);

          case 24:
            return context$2$0.abrupt('return', _lodash2['default'].find(normalizedDevices, { udid: this.udid }));

          case 25:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[7, 12, 16, 24], [17,, 19, 23]]);
    }
  }, {
    key: 'isFresh',
    value: function isFresh() {
      var files, pv, existences, fresh;
      return _regeneratorRuntime.async(function isFresh$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // this is a best-bet heuristic for whether or not a sim has been booted
            // before. We usually want to start a simulator to "warm" it up, have
            // Xcode populate it with plists for us to manipulate before a real
            // test run.

            // if the following files don't exist, it hasn't been booted.
            // THIS IS NOT AN EXHAUSTIVE LIST
            _logger2['default'].debug('Checking whether simulator has been run before');
            files = this.isFreshFiles;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.getPlatformVersion());

          case 4:
            pv = context$2$0.sent;

            if (pv !== '7.1') {
              files.push('Library/Preferences/com.apple.Preferences.plist');
            } else {
              files.push('Applications');
            }

            files = files.map(function (s) {
              return _path2['default'].resolve(_this2.getDir(), s);
            });

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _asyncbox.asyncmap)(files, function callee$2$0(f) {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(f));

                  case 2:
                    return context$3$0.abrupt('return', context$3$0.sent);

                  case 3:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            }));

          case 9:
            existences = context$2$0.sent;
            fresh = _lodash2['default'].compact(existences).length !== files.length;

            _logger2['default'].debug('Simulator ' + (fresh ? 'has not' : 'has') + ' been run before');
            return context$2$0.abrupt('return', fresh);

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'isRunning',
    value: function isRunning() {
      var stat;
      return _regeneratorRuntime.async(function isRunning$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.stat());

          case 2:
            stat = context$2$0.sent;
            return context$2$0.abrupt('return', stat.state === 'Booted');

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForBoot',
    value: function waitForBoot(startupTimeout) {
      var bootedIndicator;
      return _regeneratorRuntime.async(function waitForBoot$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getBootedIndicatorString());

          case 2:
            bootedIndicator = context$2$0.sent;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.tailLogsUntil(bootedIndicator, startupTimeout));

          case 5:

            // so sorry, but we should wait another two seconds, just to make sure we've really started
            // we can't look for another magic log line, because they seem to be app-dependent (not system dependent)
            _logger2['default'].debug('Waiting an extra ' + this.extraStartupTime + 'ms for the simulator to really finish booting');
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(this.extraStartupTime));

          case 8:
            _logger2['default'].debug('Done waiting extra time for simulator');

            this.emit(BOOT_COMPLETED_EVENT);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getBootedIndicatorString',
    value: function getBootedIndicatorString() {
      var indicator, platformVersion;
      return _regeneratorRuntime.async(function getBootedIndicatorString$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            indicator = undefined;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getPlatformVersion());

          case 3:
            platformVersion = context$2$0.sent;
            context$2$0.t0 = platformVersion;
            context$2$0.next = context$2$0.t0 === '7.1' ? 7 : context$2$0.t0 === '8.1' ? 7 : context$2$0.t0 === '8.2' ? 7 : context$2$0.t0 === '8.3' ? 7 : context$2$0.t0 === '8.4' ? 7 : context$2$0.t0 === '9.0' ? 9 : context$2$0.t0 === '9.1' ? 9 : context$2$0.t0 === '9.2' ? 9 : context$2$0.t0 === '9.3' ? 9 : context$2$0.t0 === '10.0' ? 11 : 13;
            break;

          case 7:
            indicator = 'profiled: Service starting...';
            return context$2$0.abrupt('break', 15);

          case 9:
            indicator = 'System app "com.apple.springboard" finished startup';
            return context$2$0.abrupt('break', 15);

          case 11:
            indicator = 'Switching to keyboard';
            return context$2$0.abrupt('break', 15);

          case 13:
            _logger2['default'].warn('No boot indicator case for platform version \'' + platformVersion + '\'');
            indicator = 'no boot indicator string available';

          case 15:
            return context$2$0.abrupt('return', indicator);

          case 16:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'run',
    value: function run() {
      var startupTimeout = arguments.length <= 0 || arguments[0] === undefined ? this.startupTimeout : arguments[0];
      var allowTouchEnroll = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];
      var simulatorApp, args, stat, formattedDeviceName, argumentName, startTime;
      return _regeneratorRuntime.async(function run$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.t0 = _path2['default'];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _appiumXcode.getPath)());

          case 3:
            context$2$0.t1 = context$2$0.sent;
            context$2$0.t2 = this.simulatorApp;
            simulatorApp = context$2$0.t0.resolve.call(context$2$0.t0, context$2$0.t1, 'Applications', context$2$0.t2);
            args = ['-Fn', simulatorApp, '--args', '-CurrentDeviceUDID', this.udid];

            if (!this.scaleFactor) {
              context$2$0.next = 14;
              break;
            }

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.stat());

          case 10:
            stat = context$2$0.sent;
            formattedDeviceName = stat.name.replace(/\s+/g, '-');
            argumentName = '-SimulatorWindowLastScale-com.apple.CoreSimulator.SimDeviceType.' + formattedDeviceName;

            args.push(argumentName, this.scaleFactor);

          case 14:
            if (!this.connectHardwareKeyboard) {
              args.push('-ConnectHardwareKeyboard', '0');
            }

            // Set the 'Touch ID Enroll' key bindings before the Simulator starts

            if (!allowTouchEnroll) {
              context$2$0.next = 18;
              break;
            }

            context$2$0.next = 18;
            return _regeneratorRuntime.awrap((0, _touchEnrollJs.setTouchEnrollKey)());

          case 18:

            _logger2['default'].info('Starting simulator with command: open ' + args.join(' '));
            startTime = Date.now();
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('open', args, { timeout: OPEN_TIMEOUT }));

          case 22:
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(this.waitForBoot(startupTimeout));

          case 24:

            _logger2['default'].info('Simulator booted in ' + (Date.now() - startTime) + 'ms');

          case 25:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // TODO keep keychains
  }, {
    key: 'clean',
    value: function clean() {
      return _regeneratorRuntime.async(function clean$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.endSimulatorDaemon());

          case 2:
            _logger2['default'].info('Cleaning simulator ' + this.udid);
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(simctl.eraseDevice(this.udid, 10000));

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'scrubCustomApp',
    value: function scrubCustomApp(appFile, appBundleId) {
      return _regeneratorRuntime.async(function scrubCustomApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.cleanCustomApp(appFile, appBundleId, true));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'cleanCustomApp',
    value: function cleanCustomApp(appFile, appBundleId) {
      var scrub = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];

      var appDirs, deletePromises, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, dir, relRmPath, rmPath;

      return _regeneratorRuntime.async(function cleanCustomApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // if `scrub` is false, we want to clean by deleting the app and all
            // files associated with it
            // if `scrub` is true, we just want to delete the preferences and changed
            // files

            _logger2['default'].debug('Cleaning app data files for \'' + appFile + '\', \'' + appBundleId + '\'');
            if (!scrub) {
              _logger2['default'].debug('Deleting app altogether');
            }

            // get the directories to be deleted
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.getAppDirs(appFile, appBundleId, scrub));

          case 4:
            appDirs = context$2$0.sent;

            if (!(appDirs.length === 0)) {
              context$2$0.next = 8;
              break;
            }

            _logger2['default'].debug("Could not find app directories to delete. It is probably not installed");
            return context$2$0.abrupt('return');

          case 8:
            deletePromises = [];
            _iteratorNormalCompletion2 = true;
            _didIteratorError2 = false;
            _iteratorError2 = undefined;
            context$2$0.prev = 12;

            for (_iterator2 = _getIterator(appDirs); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              dir = _step2.value;

              _logger2['default'].debug('Deleting directory: \'' + dir + '\'');
              deletePromises.push(_appiumSupport.fs.rimraf(dir));
            }

            context$2$0.next = 20;
            break;

          case 16:
            context$2$0.prev = 16;
            context$2$0.t0 = context$2$0['catch'](12);
            _didIteratorError2 = true;
            _iteratorError2 = context$2$0.t0;

          case 20:
            context$2$0.prev = 20;
            context$2$0.prev = 21;

            if (!_iteratorNormalCompletion2 && _iterator2['return']) {
              _iterator2['return']();
            }

          case 23:
            context$2$0.prev = 23;

            if (!_didIteratorError2) {
              context$2$0.next = 26;
              break;
            }

            throw _iteratorError2;

          case 26:
            return context$2$0.finish(23);

          case 27:
            return context$2$0.finish(20);

          case 28:
            context$2$0.next = 30;
            return _regeneratorRuntime.awrap(this.getPlatformVersion());

          case 30:
            context$2$0.t1 = context$2$0.sent;

            if (!(context$2$0.t1 >= 8)) {
              context$2$0.next = 36;
              break;
            }

            relRmPath = 'Library/Preferences/' + appBundleId + '.plist';
            rmPath = _path2['default'].resolve(this.getRootDir(), relRmPath);

            _logger2['default'].debug('Deleting file: \'' + rmPath + '\'');
            deletePromises.push(_appiumSupport.fs.rimraf(rmPath));

          case 36:
            context$2$0.next = 38;
            return _regeneratorRuntime.awrap(_bluebird2['default'].all(deletePromises));

          case 38:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[12, 16, 20, 28], [21,, 23, 27]]);
    }
  }, {
    key: 'getAppDirs',
    value: function getAppDirs(appFile, appBundleId) {
      var scrub = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];

      var dirs, data, bundle, _arr, _i, src;

      return _regeneratorRuntime.async(function getAppDirs$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            dirs = [];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getPlatformVersion());

          case 3:
            context$2$0.t0 = context$2$0.sent;

            if (!(context$2$0.t0 >= 8)) {
              context$2$0.next = 22;
              break;
            }

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.getAppDir(appBundleId));

          case 7:
            data = context$2$0.sent;

            if (data) {
              context$2$0.next = 10;
              break;
            }

            return context$2$0.abrupt('return', dirs);

          case 10:
            if (scrub) {
              context$2$0.next = 16;
              break;
            }

            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.getAppDir(appBundleId, 'Bundle'));

          case 13:
            context$2$0.t1 = context$2$0.sent;
            context$2$0.next = 17;
            break;

          case 16:
            context$2$0.t1 = undefined;

          case 17:
            bundle = context$2$0.t1;
            _arr = [data, bundle];

            for (_i = 0; _i < _arr.length; _i++) {
              src = _arr[_i];

              if (src) {
                dirs.push(src);
              }
            }
            context$2$0.next = 26;
            break;

          case 22:
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(this.getAppDir(appFile));

          case 24:
            data = context$2$0.sent;

            if (data) {
              dirs.push(data);
            }

          case 26:
            return context$2$0.abrupt('return', dirs);

          case 27:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'launchAndQuit',
    value: function launchAndQuit() {
      var safari = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];
      var startupTimeout = arguments.length <= 1 || arguments[1] === undefined ? this.startupTimeout : arguments[1];
      return _regeneratorRuntime.async(function launchAndQuit$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Attempting to launch and quit the simulator, to create directory structure');
            _logger2['default'].debug('Will launch with Safari? ' + safari);

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.run(startupTimeout));

          case 4:
            if (!safari) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.openUrl('http://www.appium.io'));

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(20, 250, function callee$2$0() {
              var msg;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.isFresh());

                  case 2:
                    if (!context$3$0.sent) {
                      context$3$0.next = 6;
                      break;
                    }

                    msg = 'Simulator files not fully created. Waiting a bit';

                    _logger2['default'].debug(msg);
                    throw new Error(msg);

                  case 6:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3);
            }));

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.shutdown());

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'endSimulatorDaemon',
    value: function endSimulatorDaemon() {
      var launchctlCmd, stopCmd, removeCmd;
      return _regeneratorRuntime.async(function endSimulatorDaemon$(context$2$0) {
        var _this4 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // Looks for launchd daemons corresponding to the sim udid and tries to stop them cleanly
            // This prevents xcrun simctl erase hangs.
            _logger2['default'].debug('Killing any simulator daemons for ' + this.udid);

            launchctlCmd = 'launchctl list | grep ' + this.udid + ' | cut -f 3 | xargs -n 1 launchctl';
            context$2$0.prev = 2;
            stopCmd = launchctlCmd + ' stop';
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('bash', ['-c', stopCmd]));

          case 6:
            context$2$0.next = 12;
            break;

          case 8:
            context$2$0.prev = 8;
            context$2$0.t0 = context$2$0['catch'](2);

            _logger2['default'].warn('Could not stop simulator daemons: ' + context$2$0.t0.message);
            _logger2['default'].debug('Carrying on anyway!');

          case 12:
            context$2$0.prev = 12;
            removeCmd = launchctlCmd + ' remove';
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('bash', ['-c', removeCmd]));

          case 16:
            context$2$0.next = 22;
            break;

          case 18:
            context$2$0.prev = 18;
            context$2$0.t1 = context$2$0['catch'](12);

            _logger2['default'].warn('Could not remove simulator daemons: ' + context$2$0.t1.message);
            _logger2['default'].debug('Carrying on anyway!');

          case 22:
            context$2$0.prev = 22;
            context$2$0.next = 25;
            return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(function callee$2$0() {
              var _ref2, stdout;

              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap((0, _teen_process.exec)('bash', ['-c', 'ps -e  | grep ' + this.udid + ' | grep launchd_sim | grep -v bash | grep -v grep | awk {\'print$1\'}']));

                  case 2:
                    _ref2 = context$3$0.sent;
                    stdout = _ref2.stdout;
                    return context$3$0.abrupt('return', stdout.trim().length === 0);

                  case 5:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this4);
            }, { waitMs: 10000, intervalMs: 500 }));

          case 25:
            context$2$0.next = 31;
            break;

          case 27:
            context$2$0.prev = 27;
            context$2$0.t2 = context$2$0['catch'](22);

            _logger2['default'].warn('Could not end simulator daemon for ' + this.udid + ': ' + context$2$0.t2.message);
            _logger2['default'].debug('Carrying on anyway!');

          case 31:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[2, 8], [12, 18], [22, 27]]);
    }
  }, {
    key: 'shutdown',
    value: function shutdown() {
      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _utilsJs.killAllSimulators)());

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'delete',
    value: function _delete() {
      return _regeneratorRuntime.async(function _delete$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(simctl.deleteDevice(this.udid));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'updateSettings',
    value: function updateSettings(plist, updates) {
      return _regeneratorRuntime.async(function updateSettings$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(settings.updateSettings(this, plist, updates));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'updateLocationSettings',
    value: function updateLocationSettings(bundleId, authorized) {
      return _regeneratorRuntime.async(function updateLocationSettings$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(settings.updateLocationSettings(this, bundleId, authorized));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'updateSafariSettings',
    value: function updateSafariSettings(updates) {
      return _regeneratorRuntime.async(function updateSafariSettings$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(settings.updateSafariUserSettings(this, updates));

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(settings.updateSettings(this, 'mobileSafari', updates));

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'updateLocale',
    value: function updateLocale(language, locale, calendarFormat) {
      return _regeneratorRuntime.async(function updateLocale$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(settings.updateLocale(this, language, locale, calendarFormat));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSafari',
    value: function deleteSafari() {
      var dirs, pv, deletePromises, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, dir;

      return _regeneratorRuntime.async(function deleteSafari$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Deleting Safari apps from simulator');

            dirs = [];
            context$2$0.t0 = dirs;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.getAppDir('com.apple.mobilesafari'));

          case 5:
            context$2$0.t1 = context$2$0.sent;
            context$2$0.t0.push.call(context$2$0.t0, context$2$0.t1);
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.getPlatformVersion());

          case 9:
            pv = context$2$0.sent;

            if (!(pv >= 8)) {
              context$2$0.next = 16;
              break;
            }

            context$2$0.t2 = dirs;
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.getAppDir('com.apple.mobilesafari', 'Bundle'));

          case 14:
            context$2$0.t3 = context$2$0.sent;
            context$2$0.t2.push.call(context$2$0.t2, context$2$0.t3);

          case 16:
            deletePromises = [];
            _iteratorNormalCompletion3 = true;
            _didIteratorError3 = false;
            _iteratorError3 = undefined;
            context$2$0.prev = 20;

            for (_iterator3 = _getIterator(_lodash2['default'].compact(dirs)); !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
              dir = _step3.value;

              _logger2['default'].debug('Deleting directory: \'' + dir + '\'');
              deletePromises.push(_appiumSupport.fs.rimraf(dir));
            }
            context$2$0.next = 28;
            break;

          case 24:
            context$2$0.prev = 24;
            context$2$0.t4 = context$2$0['catch'](20);
            _didIteratorError3 = true;
            _iteratorError3 = context$2$0.t4;

          case 28:
            context$2$0.prev = 28;
            context$2$0.prev = 29;

            if (!_iteratorNormalCompletion3 && _iterator3['return']) {
              _iterator3['return']();
            }

          case 31:
            context$2$0.prev = 31;

            if (!_didIteratorError3) {
              context$2$0.next = 34;
              break;
            }

            throw _iteratorError3;

          case 34:
            return context$2$0.finish(31);

          case 35:
            return context$2$0.finish(28);

          case 36:
            context$2$0.next = 38;
            return _regeneratorRuntime.awrap(_bluebird2['default'].all(deletePromises));

          case 38:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[20, 24, 28, 36], [29,, 31, 35]]);
    }
  }, {
    key: 'cleanSafari',
    value: function cleanSafari() {
      var keepPrefs = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];

      var libraryDir, safariRoot, safariLibraryDir, filesToDelete, deletePromises, _iteratorNormalCompletion4, _didIteratorError4, _iteratorError4, _iterator4, _step4, file;

      return _regeneratorRuntime.async(function cleanSafari$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Cleaning mobile safari data files');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.isFresh());

          case 3:
            if (!context$2$0.sent) {
              context$2$0.next = 6;
              break;
            }

            _logger2['default'].info('Could not find Safari support directories to clean out old ' + 'data. Probably there is nothing to clean out');
            return context$2$0.abrupt('return');

          case 6:
            libraryDir = _path2['default'].resolve(this.getDir(), 'Library');
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.getAppDir('com.apple.mobilesafari'));

          case 9:
            safariRoot = context$2$0.sent;

            if (safariRoot) {
              context$2$0.next = 13;
              break;
            }

            _logger2['default'].info('Could not find Safari support directories to clean out old ' + 'data. Probably there is nothing to clean out');
            return context$2$0.abrupt('return');

          case 13:
            safariLibraryDir = _path2['default'].resolve(safariRoot, 'Library');
            filesToDelete = ['Caches/Snapshots/com.apple.mobilesafari', 'Caches/com.apple.mobilesafari/*', 'Caches/com.apple.WebAppCache/*', 'Caches/com.apple.WebKit.Networking/*', 'Caches/com.apple.WebKit.WebContent/*', 'Image Cache/*', 'WebKit/com.apple.mobilesafari/*', 'WebKit/GeolocationSites.plist', 'WebKit/LocalStorage/*.*', 'Safari/*', 'Cookies/*.binarycookies', 'Caches/com.apple.UIStatusBar/*', 'Caches/com.apple.keyboards/images/*', 'Caches/com.apple.Safari.SafeBrowsing/*', '../tmp/com.apple.mobilesafari/*'];
            deletePromises = [];
            _iteratorNormalCompletion4 = true;
            _didIteratorError4 = false;
            _iteratorError4 = undefined;
            context$2$0.prev = 19;

            for (_iterator4 = _getIterator(filesToDelete); !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
              file = _step4.value;

              deletePromises.push(_appiumSupport.fs.rimraf(_path2['default'].resolve(libraryDir, file)));
              deletePromises.push(_appiumSupport.fs.rimraf(_path2['default'].resolve(safariLibraryDir, file)));
            }

            context$2$0.next = 27;
            break;

          case 23:
            context$2$0.prev = 23;
            context$2$0.t0 = context$2$0['catch'](19);
            _didIteratorError4 = true;
            _iteratorError4 = context$2$0.t0;

          case 27:
            context$2$0.prev = 27;
            context$2$0.prev = 28;

            if (!_iteratorNormalCompletion4 && _iterator4['return']) {
              _iterator4['return']();
            }

          case 30:
            context$2$0.prev = 30;

            if (!_didIteratorError4) {
              context$2$0.next = 33;
              break;
            }

            throw _iteratorError4;

          case 33:
            return context$2$0.finish(30);

          case 34:
            return context$2$0.finish(27);

          case 35:
            if (!keepPrefs) {
              deletePromises.push(_appiumSupport.fs.rimraf(_path2['default'].resolve(safariLibraryDir, 'Preferences/*.plist')));
            }

            context$2$0.next = 38;
            return _regeneratorRuntime.awrap(_bluebird2['default'].all(deletePromises));

          case 38:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[19, 23, 27, 35], [28,, 30, 34]]);
    }
  }, {
    key: 'removeApp',
    value: function removeApp(bundleId) {
      return _regeneratorRuntime.async(function removeApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(simctl.removeApp(this.udid, bundleId));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'moveBuiltInApp',
    value: function moveBuiltInApp(appName, appPath, newAppPath) {
      return _regeneratorRuntime.async(function moveBuiltInApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _utilsJs.safeRimRaf)(newAppPath));

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(appPath, newAppPath));

          case 4:
            _logger2['default'].debug('Copied \'' + appName + '\' to \'' + newAppPath + '\'');

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(appPath));

          case 7:
            _logger2['default'].debug('Temporarily deleted original app at \'' + appPath + '\'');

            return context$2$0.abrupt('return', [newAppPath, appPath]);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'openUrl',
    value: function openUrl(url) {
      var SAFARI_BOOTED_INDICATOR, SAFARI_STARTUP_TIMEOUT, EXTRA_STARTUP_TIME;
      return _regeneratorRuntime.async(function openUrl$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            SAFARI_BOOTED_INDICATOR = 'MobileSafari[';
            SAFARI_STARTUP_TIMEOUT = 15 * 1000;
            EXTRA_STARTUP_TIME = 3 * 1000;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.isRunning());

          case 5:
            if (!context$2$0.sent) {
              context$2$0.next = 17;
              break;
            }

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _asyncbox.retry)(5000, simctl.openUrl, this.udid, url));

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.tailLogsUntil(SAFARI_BOOTED_INDICATOR, SAFARI_STARTUP_TIMEOUT));

          case 10:
            // So sorry, but the logs have nothing else for Safari starting.. just delay a little bit
            _logger2['default'].debug('Safari started, waiting ' + EXTRA_STARTUP_TIME + 'ms for it to fully start');
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(EXTRA_STARTUP_TIME));

          case 13:
            _logger2['default'].debug('Done waiting for Safari');
            return context$2$0.abrupt('return');

          case 17:
            throw new Error('Tried to open a url, but the Simulator is not Booted');

          case 18:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // returns a promise that resolves when the ios simulator logs output a line matching `bootedIndicator`
    // times out after timeoutMs
  }, {
    key: 'tailLogsUntil',
    value: function tailLogsUntil(bootedIndicator, timeoutMs) {
      var simLog;
      return _regeneratorRuntime.async(function tailLogsUntil$(context$2$0) {
        var _this5 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            simLog = _path2['default'].resolve(this.getLogDir(), 'system.log');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(200, 200, function callee$2$0() {
              var exists;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(simLog));

                  case 2:
                    exists = context$3$0.sent;

                    if (exists) {
                      context$3$0.next = 5;
                      break;
                    }

                    throw new Error('Could not find Simulator log: \'' + simLog + '\'');

                  case 5:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this5);
            }));

          case 3:

            _logger2['default'].info('Simulator log at \'' + simLog + '\'');
            _logger2['default'].info('Tailing simulator logs until we encounter the string "' + bootedIndicator + '"');
            _logger2['default'].info('We will time out after ' + timeoutMs + 'ms');
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _tailUntilJs.tailUntil)(simLog, bootedIndicator, timeoutMs));

          case 9:
            context$2$0.next = 14;
            break;

          case 11:
            context$2$0.prev = 11;
            context$2$0.t0 = context$2$0['catch'](6);

            _logger2['default'].debug('Simulator startup timed out. Continuing anyway.');

          case 14:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 11]]);
    }
  }, {
    key: 'enableCalendarAccess',
    value: function enableCalendarAccess(bundleID) {
      return _regeneratorRuntime.async(function enableCalendarAccess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.calendar.enableCalendarAccess(bundleID));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'disableCalendarAccess',
    value: function disableCalendarAccess(bundleID) {
      return _regeneratorRuntime.async(function disableCalendarAccess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.calendar.disableCalendarAccess(bundleID));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'hasCalendarAccess',
    value: function hasCalendarAccess(bundleID) {
      return _regeneratorRuntime.async(function hasCalendarAccess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.calendar.hasCalendarAccess(bundleID));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'enrollTouchID',
    value: function enrollTouchID() {
      return _regeneratorRuntime.async(function enrollTouchID$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('osascript', ['-e', '\n      activate application "Simulator"\n      tell application "System Events"\n        key code 17 using {control down, shift down, option down, command down}\n      end tell\n    ']));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startupTimeout',
    get: function get() {
      return STARTUP_TIMEOUT;
    }
  }], [{
    key: '_getDeviceStringPlatformVersion',
    value: function _getDeviceStringPlatformVersion(platformVersion) {
      var reqVersion;
      return _regeneratorRuntime.async(function _getDeviceStringPlatformVersion$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            reqVersion = platformVersion;

            if (reqVersion) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_appiumXcode2['default'].getMaxIOSSDK());

          case 4:
            reqVersion = context$2$0.sent;

            _logger2['default'].warn('No platform version set. Using max SDK version: ' + reqVersion);
            // this will be a number, and possibly an integer (e.g., if max iOS SDK is 9)
            // so turn it into a string and add a .0 if necessary
            if (!_lodash2['default'].isString(reqVersion)) {
              reqVersion = reqVersion % 1 ? String(reqVersion) : reqVersion + '.0';
            }

          case 7:
            return context$2$0.abrupt('return', reqVersion);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // change the format in subclasses, as necessary
  }, {
    key: '_getDeviceStringVersionString',
    value: function _getDeviceStringVersionString(platformVersion) {
      var reqVersion;
      return _regeneratorRuntime.async(function _getDeviceStringVersionString$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this._getDeviceStringPlatformVersion(platformVersion));

          case 2:
            reqVersion = context$2$0.sent;
            return context$2$0.abrupt('return', '(' + reqVersion + ' Simulator)');

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // change the format in subclasses, as necessary
  }, {
    key: '_getDeviceStringConfigFix',
    value: function _getDeviceStringConfigFix() {
      // some devices need to be updated
      return {
        'iPad Simulator (7.1 Simulator)': 'iPad 2 (7.1 Simulator)',
        'iPad Simulator (8.0 Simulator)': 'iPad 2 (8.0 Simulator)',
        'iPad Simulator (8.1 Simulator)': 'iPad 2 (8.1 Simulator)',
        'iPad Simulator (8.2 Simulator)': 'iPad 2 (8.2 Simulator)',
        'iPad Simulator (8.3 Simulator)': 'iPad 2 (8.3 Simulator)',
        'iPad Simulator (8.4 Simulator)': 'iPad 2 (8.4 Simulator)',
        'iPhone Simulator (7.1 Simulator)': 'iPhone 5s (7.1 Simulator)',
        'iPhone Simulator (8.4 Simulator)': 'iPhone 6 (8.4 Simulator)',
        'iPhone Simulator (8.3 Simulator)': 'iPhone 6 (8.3 Simulator)',
        'iPhone Simulator (8.2 Simulator)': 'iPhone 6 (8.2 Simulator)',
        'iPhone Simulator (8.1 Simulator)': 'iPhone 6 (8.1 Simulator)',
        'iPhone Simulator (8.0 Simulator)': 'iPhone 6 (8.0 Simulator)'
      };
    }
  }, {
    key: 'getDeviceString',
    value: function getDeviceString(opts) {
      var logOpts, isiPhone, device, iosDeviceString, CONFIG_FIX, configFix;
      return _regeneratorRuntime.async(function getDeviceString$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            opts = _Object$assign({}, {
              deviceName: null,
              platformVersion: null,
              forceIphone: false,
              forceIpad: false
            }, opts);
            logOpts = {
              deviceName: opts.deviceName,
              platformVersion: opts.platformVersion,
              forceIphone: opts.forceIphone,
              forceIpad: opts.forceIpad
            };

            _logger2['default'].debug('Getting device string from options: ' + JSON.stringify(logOpts));

            // short circuit if we already have a device name

            if (!((opts.deviceName || '')[0] === '=')) {
              context$2$0.next = 5;
              break;
            }

            return context$2$0.abrupt('return', opts.deviceName.substring(1));

          case 5:
            isiPhone = !!opts.forceIphone || !opts.forceIpad;

            if (opts.deviceName) {
              device = opts.deviceName.toLowerCase();

              if (device.indexOf('iphone') !== -1) {
                isiPhone = true;
              } else if (device.indexOf('ipad') !== -1) {
                isiPhone = false;
              }
            }

            iosDeviceString = opts.deviceName || (isiPhone ? 'iPhone Simulator' : 'iPad Simulator');

            // if someone passes in just "iPhone", make that "iPhone Simulator" to
            // conform to all the logic below
            if (/^(iPhone|iPad)$/.test(iosDeviceString)) {
              iosDeviceString += " Simulator";
            }

            // we support deviceName: "iPhone Simulator", and also want to support
            // "iPhone XYZ Simulator", but these strings aren't in the device list.
            // So, if someone sent in "iPhone XYZ Simulator", strip off " Simulator"
            // in order to allow the default "iPhone XYZ" match
            if (/[^(iPhone|iPad)] Simulator/.test(iosDeviceString)) {
              iosDeviceString = iosDeviceString.replace(" Simulator", "");
            }
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this._getDeviceStringVersionString(opts.platformVersion));

          case 12:
            context$2$0.t0 = context$2$0.sent;
            iosDeviceString += ' ' + context$2$0.t0;
            CONFIG_FIX = this._getDeviceStringConfigFix();
            configFix = CONFIG_FIX;

            if (configFix[iosDeviceString]) {
              iosDeviceString = configFix[iosDeviceString];
              _logger2['default'].debug('Fixing device. Changed from \'' + opts.deviceName + '\' ' + ('to \'' + iosDeviceString + '\''));
            }

            _logger2['default'].debug('Final device string is \'' + iosDeviceString + '\'');
            return context$2$0.abrupt('return', iosDeviceString);

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return SimulatorXcode6;
})(EventEmitter);

var _iteratorNormalCompletion5 = true;
var _didIteratorError5 = false;
var _iteratorError5 = undefined;

try {

  for (var _iterator5 = _getIterator(_lodash2['default'].toPairs(_extensionsIndex2['default'])), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
    var _step5$value = _slicedToArray(_step5.value, 2);

    var cmd = _step5$value[0];
    var fn = _step5$value[1];

    SimulatorXcode6.prototype[cmd] = fn;
  }
} catch (err) {
  _didIteratorError5 = true;
  _iteratorError5 = err;
} finally {
  try {
    if (!_iteratorNormalCompletion5 && _iterator5['return']) {
      _iterator5['return']();
    }
  } finally {
    if (_didIteratorError5) {
      throw _iteratorError5;
    }
  }
}

exports['default'] = SimulatorXcode6;
exports.SimulatorXcode6 = SimulatorXcode6;
exports.BOOT_COMPLETED_EVENT = BOOT_COMPLETED_EVENT;

// `appFile` argument only necessary for iOS below version 8

// reduce the list of path-bundle pairs to an object where bundleIds are mapped to paths

// wait for the simulator to boot
// waiting for the simulator status to be 'booted' isn't good enough
// it claims to be booted way before finishing loading
// let's tail the simulator system log until we see a magic line (this.bootedIndicator)

// iOS 8+ stores app data in two places,
// iOS 7.1 has only one directory

// the `Bundle` directory has the actual app in it. If we are just scrubbing,
// we want this to stay. If we are cleaning we delete

// wait for the system to create the files we will manipulate
// need quite a high retry number, in order to accommodate iOS 7.1
// locally, 7.1 averages 8.5 retries (from 6 - 12)
//          8 averages 0.6 retries (from 0 - 2)
//          9 averages 14 retries

// and quit

// Waits 10 sec for the simulator launchd services to stop.

// get the data directory

// get the bundle directory

// we need to make sure log file exists before we can tail it
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtNi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFBaUIsTUFBTTs7OzswQkFDQyxhQUFhOztJQUF6QixNQUFNOzsyQkFDd0MsY0FBYzs7OztzQkFDeEQsVUFBVTs7Ozs2QkFDUCxnQkFBZ0I7O3dCQUNyQixVQUFVOzs7O3NCQUNWLFFBQVE7Ozs7dUJBQ3dCLFlBQVk7OzZCQUN4QixtQkFBbUI7O3dCQUNZLFVBQVU7O3dCQUNqRCxZQUFZOztJQUExQixRQUFROzs0QkFDQyxjQUFjOzsyQkFDVCxpQkFBaUI7OytCQUNwQixvQkFBb0I7Ozs7c0JBQ3hCLFFBQVE7Ozs7d0JBQ04sWUFBWTs7OztJQUN6QixZQUFZLHVCQUFaLFlBQVk7O0FBRXBCLElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQztBQUMxQixJQUFNLGVBQWUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO0FBQ2xDLElBQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDOzs7Ozs7Ozs7QUFTaEMsSUFBTSxvQkFBb0IsR0FBRyxlQUFlLENBQUM7O0lBRXZDLGVBQWU7WUFBZixlQUFlOztBQUNQLFdBRFIsZUFBZSxDQUNOLElBQUksRUFBRSxZQUFZLEVBQUU7MEJBRDdCLGVBQWU7O0FBRWpCLCtCQUZFLGVBQWUsNkNBRVQ7QUFDUixRQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN6QixRQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQzs7Ozs7QUFLakMsUUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQzs7QUFFN0IsUUFBSSxDQUFDLFlBQVksR0FBRyxrQkFBSyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztBQUN4RSxRQUFJLENBQUMsWUFBWSxHQUFHLG1CQUFtQixDQUFDOztBQUV4QyxRQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztBQUN4QixRQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDOztBQUVwQyxRQUFJLENBQUMsa0JBQWtCLEdBQUcsRUFBRSxDQUFDOzs7OztBQUs3QixRQUFJLENBQUMsWUFBWSxHQUFHLENBQ2xCLCtCQUErQixFQUMvQixpQkFBaUIsRUFDakIsOENBQThDLEVBQzlDLGlEQUFpRCxFQUNqRCxvQkFBb0IsQ0FDckIsQ0FBQzs7O0FBR0YsUUFBSSxDQUFDLGdCQUFnQixHQUFHLGtCQUFrQixDQUFDOztBQUUzQyxRQUFJLENBQUMsUUFBUSxHQUFHLDBCQUFhLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0dBQzdDOztlQWxDRyxlQUFlOztXQXdDSix3QkFBQyxjQUFjLEVBQUU7QUFDOUIsVUFBSSxlQUFlLEdBQUcsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDN0QsVUFBSSxlQUFlLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUMvQyxZQUFJLEdBQUcsY0FBWSxlQUFlLGtEQUE2QyxjQUFjLHlCQUFzQixDQUFDO0FBQ3BILDRCQUFJLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztPQUN4QjtBQUNELFVBQUksQ0FBQyxXQUFXLEdBQUcsY0FBYyxDQUFDO0tBQ25DOzs7V0FFMEIsb0NBQUMsUUFBUSxFQUFFO0FBQ3BDLFVBQUksQ0FBQyx1QkFBdUIsR0FBRyxRQUFRLENBQUM7S0FDekM7OztXQUV3QjtnQkFFaEIsR0FBRzs7Ozs7Z0JBREwsSUFBSSxDQUFDLGdCQUFnQjs7Ozs7OzZDQUNOLElBQUksQ0FBQyxJQUFJLEVBQUU7Ozs7QUFBeEIsZUFBRyxRQUFILEdBQUc7O0FBQ1IsZ0JBQUksQ0FBQyxnQkFBZ0IsR0FBRyxHQUFHLENBQUM7OztnREFFdkIsSUFBSSxDQUFDLGdCQUFnQjs7Ozs7OztLQUM3Qjs7O1dBRVUsc0JBQUc7QUFDWixVQUFJLElBQUksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQztBQUM1QixhQUFPLGtCQUFLLE9BQU8sQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxlQUFlLEVBQUUsU0FBUyxDQUFDLENBQUM7S0FDL0U7OztXQUVNLGtCQUFHO0FBQ1IsYUFBTyxrQkFBSyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDM0Q7OztXQUVTLHFCQUFHO0FBQ1gsVUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7QUFDNUIsYUFBTyxrQkFBSyxPQUFPLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsZUFBZSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUMxRTs7O1dBRWdCLG9CQUFDLEdBQUc7Ozs7OzZDQUNOLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUM7Ozs7Ozs7Ozs7S0FDL0M7OztXQUVvQix3QkFBQyxRQUFRO1VBQUUsT0FBTyx5REFBRyxJQUFJO1VBRXhDLE9BQU87Ozs7OzZDQUFTLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQzs7O0FBQWxELG1CQUFPO2dEQUNKLE9BQU8sQ0FBQyxNQUFNLEtBQUssQ0FBQzs7Ozs7OztLQUM1Qjs7Ozs7Ozs7V0FNZSxtQkFBQyxFQUFFO1VBQUUsTUFBTSx5REFBRyxNQUFNOzs7O0FBQ2xDLGdCQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQzs2QkFDcEUsb0JBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQzs7Ozs7Ozs7NkNBQVcsSUFBSSxDQUFDLE9BQU8sRUFBRTs7Ozs7Ozs7Ozs7OzZDQUM3QixJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDOzs7QUFBdkUsZ0JBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUM7OztnREFFMUIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQzs7Ozs7OztLQUMzQzs7Ozs7Ozs7Ozs7V0FTd0I7VUFBQyxNQUFNLHlEQUFHLE1BQU07VUFFbkMsZUFBZSxFQUNmLGNBQWMsRUFnQ2QsY0FBYyxFQUNkLGVBQWU7Ozs7OztBQW5DbkIsZ0NBQUksS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDbEMsMkJBQWU7QUFDZiwwQkFBYzs7NkNBQ1IsSUFBSSxDQUFDLGtCQUFrQixFQUFFOzs7OztxQ0FBSyxLQUFLOzs7Ozs7Ozs7Ozs7QUFRM0MsMkJBQWUsR0FBRyxrQkFBSyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0FBQzlELDBCQUFjLEdBQUcsb0JBQU8sR0FBRztrQkFFckIsUUFBUSxFQUNSLFFBQVE7Ozs7QUFGWix1QkFBRyxHQUFHLGtCQUFLLE9BQU8sQ0FBQyxlQUFlLEVBQUUsR0FBRyxDQUFDLENBQUM7O3FEQUNwQixrQkFBRyxJQUFJLENBQUksR0FBRyxZQUFTOzs7QUFBeEMsNEJBQVE7QUFDUiw0QkFBUSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO3dEQUM3QyxFQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFSLFFBQVEsRUFBQzs7Ozs7OzthQUM3QixDQUFDOzs7Ozs7QUFFRiw2QkFBZSxHQUFHLGtCQUFLLE9BQU8sQ0FBQyxNQUFLLE1BQU0sRUFBRSxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsYUFBYSxDQUFDLENBQUM7O0FBRW5GLGtCQUFJLFlBQVksR0FBRyxTQUFmLFlBQVksQ0FBVSxHQUFHO29CQUN2QixLQUFLLEVBQ0wsUUFBUTs7OztBQURSLDJCQUFLLEdBQUcsa0JBQUssT0FBTyxDQUFDLEdBQUcsRUFBRSxvREFBb0QsQ0FBQzs7dURBQzlELFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDOzs7QUFBckMsOEJBQVE7MERBQ0wsUUFBUSxDQUFDLHFCQUFxQjs7Ozs7OztlQUN0QyxDQUFDOztBQUVGLDRCQUFjLEdBQUcsb0JBQU8sR0FBRztvQkFFckIsUUFBUTs7OztBQURaLHlCQUFHLEdBQUcsa0JBQUssT0FBTyxDQUFDLGVBQWUsRUFBRSxHQUFHLENBQUMsQ0FBQzs7dURBQ3BCLFlBQVksQ0FBQyxHQUFHLENBQUM7OztBQUFsQyw4QkFBUTswREFDTCxFQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFSLFFBQVEsRUFBQzs7Ozs7OztlQUM3QixDQUFDOzs7Ozs2Q0FHdUIsa0JBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQzs7O0FBQWxELDBCQUFjOzs2Q0FDVSx3QkFBUyxjQUFjLEVBQUUsb0JBQU8sR0FBRzs7Ozs7cURBQ2hELGNBQWMsQ0FBQyxHQUFHLENBQUM7Ozs7Ozs7Ozs7YUFDakMsRUFBRSxLQUFLLENBQUM7OztBQUZMLDJCQUFlO2dEQUtaLGVBQWUsQ0FBQyxNQUFNLENBQUMsVUFBQyxTQUFTLEVBQUUsVUFBVSxFQUFLO0FBQ3ZELHVCQUFTLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUM7QUFDakQscUJBQU8sU0FBUyxDQUFDO2FBQ2xCLEVBQUUsRUFBRSxDQUFDOzs7Ozs7O0tBQ1A7Ozs7Ozs7Ozs7V0FRVTtVQUNMLE9BQU8sRUFDUCxpQkFBaUI7Ozs7Ozs2Q0FERCxNQUFNLENBQUMsVUFBVSxFQUFFOzs7QUFBbkMsbUJBQU87QUFDUCw2QkFBaUIsR0FBRyxFQUFFOzs7Ozs7Ozs7a0JBR2hCLEdBQUc7a0JBQUUsU0FBUzs7QUFDdEIsdUJBQVMsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLFVBQUMsTUFBTSxFQUFLO0FBQ3BDLHNCQUFNLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztBQUNqQix1QkFBTyxNQUFNLENBQUM7ZUFDZixDQUFDLENBQUM7QUFDSCwrQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7Ozs7QUFMMUQsMENBQTZCLG9CQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMscUdBQUU7O2FBTWhEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Z0RBRU0sb0JBQUUsSUFBSSxDQUFDLGlCQUFpQixFQUFFLEVBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUMsQ0FBQzs7Ozs7OztLQUNwRDs7O1dBRWE7VUFTUixLQUFLLEVBRUwsRUFBRSxFQVdGLFVBQVUsRUFDVixLQUFLOzs7Ozs7Ozs7Ozs7O0FBZlQsZ0NBQUksS0FBSyxDQUFDLGdEQUFnRCxDQUFDLENBQUM7QUFDeEQsaUJBQUssR0FBRyxJQUFJLENBQUMsWUFBWTs7NkNBRWQsSUFBSSxDQUFDLGtCQUFrQixFQUFFOzs7QUFBcEMsY0FBRTs7QUFDTixnQkFBSSxFQUFFLEtBQUssS0FBSyxFQUFFO0FBQ2hCLG1CQUFLLENBQUMsSUFBSSxDQUFDLGlEQUFpRCxDQUFDLENBQUM7YUFDL0QsTUFBTTtBQUNMLG1CQUFLLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO2FBQzVCOztBQUVELGlCQUFLLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFDLENBQUMsRUFBSztBQUN2QixxQkFBTyxrQkFBSyxPQUFPLENBQUMsT0FBSyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUN2QyxDQUFDLENBQUM7Ozs2Q0FFb0Isd0JBQVMsS0FBSyxFQUFFLG9CQUFPLENBQUM7Ozs7O3FEQUFvQixrQkFBRyxTQUFTLENBQUMsQ0FBQyxDQUFDOzs7Ozs7Ozs7O2FBQUcsQ0FBQzs7O0FBQWxGLHNCQUFVO0FBQ1YsaUJBQUssR0FBRyxvQkFBRSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxLQUFLLEtBQUssQ0FBQyxNQUFNOztBQUN6RCxnQ0FBSSxLQUFLLGlCQUFjLEtBQUssR0FBRyxTQUFTLEdBQUcsS0FBSyxDQUFBLHNCQUFtQixDQUFDO2dEQUM3RCxLQUFLOzs7Ozs7O0tBQ2I7OztXQUVlO1VBQ1YsSUFBSTs7Ozs7NkNBQVMsSUFBSSxDQUFDLElBQUksRUFBRTs7O0FBQXhCLGdCQUFJO2dEQUNELElBQUksQ0FBQyxLQUFLLEtBQUssUUFBUTs7Ozs7OztLQUMvQjs7O1dBRWlCLHFCQUFDLGNBQWM7VUFLM0IsZUFBZTs7Ozs7NkNBQVMsSUFBSSxDQUFDLHdCQUF3QixFQUFFOzs7QUFBdkQsMkJBQWU7OzZDQUNiLElBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxFQUFFLGNBQWMsQ0FBQzs7Ozs7O0FBSXpELGdDQUFJLEtBQUssdUJBQXFCLElBQUksQ0FBQyxnQkFBZ0IsbURBQWdELENBQUM7OzZDQUM5RixzQkFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDOzs7QUFDcEMsZ0NBQUksS0FBSyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7O0FBRW5ELGdCQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7Ozs7Ozs7S0FDakM7OztXQUU4QjtVQUN6QixTQUFTLEVBQ1QsZUFBZTs7OztBQURmLHFCQUFTOzs2Q0FDZSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7OztBQUFqRCwyQkFBZTs2QkFDWCxlQUFlO2tEQUNoQixLQUFLLDBCQUNMLEtBQUssMEJBQ0wsS0FBSywwQkFDTCxLQUFLLDBCQUNMLEtBQUssMEJBR0wsS0FBSywwQkFDTCxLQUFLLDBCQUNMLEtBQUssMEJBQ0wsS0FBSywwQkFHTCxNQUFNOzs7O0FBUlQscUJBQVMsR0FBRywrQkFBK0IsQ0FBQzs7OztBQU01QyxxQkFBUyxHQUFHLHFEQUFxRCxDQUFDOzs7O0FBR2xFLHFCQUFTLEdBQUcsdUJBQXVCLENBQUM7Ozs7QUFHcEMsZ0NBQUksSUFBSSxvREFBaUQsZUFBZSxRQUFJLENBQUM7QUFDN0UscUJBQVMsR0FBRyxvQ0FBb0MsQ0FBQzs7O2dEQUU5QyxTQUFTOzs7Ozs7O0tBQ2pCOzs7V0FFUztVQUFDLGNBQWMseURBQUcsSUFBSSxDQUFDLGNBQWM7VUFBRSxnQkFBZ0IseURBQUcsS0FBSztVQUNuRSxZQUFZLEVBQ1osSUFBSSxFQUVGLElBQUksRUFDSixtQkFBbUIsRUFDbkIsWUFBWSxFQWFkLFNBQVM7Ozs7Ozs2Q0FsQnlCLDJCQUFjOzs7OzZCQUFrQixJQUFJLENBQUMsWUFBWTtBQUFuRix3QkFBWSxrQkFBUSxPQUFPLHNDQUF1QixjQUFjO0FBQ2hFLGdCQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDOztpQkFDdkUsSUFBSSxDQUFDLFdBQVc7Ozs7Ozs2Q0FDRCxJQUFJLENBQUMsSUFBSSxFQUFFOzs7QUFBeEIsZ0JBQUk7QUFDSiwrQkFBbUIsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDO0FBQ3BELHdCQUFZLHdFQUFzRSxtQkFBbUI7O0FBQ3pHLGdCQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7OztBQUU1QyxnQkFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRTtBQUNqQyxrQkFBSSxDQUFDLElBQUksQ0FBQywwQkFBMEIsRUFBRSxHQUFHLENBQUMsQ0FBQzthQUM1Qzs7OztpQkFHRyxnQkFBZ0I7Ozs7Ozs2Q0FDWix1Q0FBbUI7Ozs7QUFHM0IsZ0NBQUksSUFBSSw0Q0FBMEMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBRyxDQUFDO0FBQ2hFLHFCQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRTs7NkNBQ3BCLHdCQUFLLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBQyxPQUFPLEVBQUUsWUFBWSxFQUFDLENBQUM7Ozs7NkNBRTNDLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDOzs7O0FBRXRDLGdDQUFJLElBQUksMkJBQXdCLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxTQUFTLENBQUEsUUFBSyxDQUFDOzs7Ozs7O0tBQzdEOzs7OztXQUdXOzs7Ozs2Q0FDSixJQUFJLENBQUMsa0JBQWtCLEVBQUU7OztBQUMvQixnQ0FBSSxJQUFJLHlCQUF1QixJQUFJLENBQUMsSUFBSSxDQUFHLENBQUM7OzZDQUN0QyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDOzs7Ozs7O0tBQzNDOzs7V0FFb0Isd0JBQUMsT0FBTyxFQUFFLFdBQVc7Ozs7OzZDQUMzQixJQUFJLENBQUMsY0FBYyxDQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsSUFBSSxDQUFDOzs7Ozs7Ozs7O0tBQzlEOzs7V0FFb0Isd0JBQUMsT0FBTyxFQUFFLFdBQVc7VUFBRSxLQUFLLHlEQUFHLEtBQUs7O1VBWW5ELE9BQU8sRUFPUCxjQUFjLHVGQUVULEdBQUcsRUFNTixTQUFTLEVBQ1QsTUFBTTs7Ozs7Ozs7OztBQXRCWixnQ0FBSSxLQUFLLG9DQUFpQyxPQUFPLGNBQU8sV0FBVyxRQUFJLENBQUM7QUFDeEUsZ0JBQUksQ0FBQyxLQUFLLEVBQUU7QUFDVixrQ0FBSSxLQUFLLDJCQUEyQixDQUFDO2FBQ3RDOzs7OzZDQUdtQixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxXQUFXLEVBQUUsS0FBSyxDQUFDOzs7QUFBNUQsbUJBQU87O2tCQUVQLE9BQU8sQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFBOzs7OztBQUN0QixnQ0FBSSxLQUFLLENBQUMsd0VBQXdFLENBQUMsQ0FBQzs7OztBQUlsRiwwQkFBYyxHQUFHLEVBQUU7Ozs7OztBQUV2QiwyQ0FBZ0IsT0FBTyx5R0FBRTtBQUFoQixpQkFBRzs7QUFDVixrQ0FBSSxLQUFLLDRCQUF5QixHQUFHLFFBQUksQ0FBQztBQUMxQyw0QkFBYyxDQUFDLElBQUksQ0FBQyxrQkFBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQzthQUNyQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs2Q0FFUyxJQUFJLENBQUMsa0JBQWtCLEVBQUU7Ozs7O29DQUFJLENBQUM7Ozs7O0FBQ2xDLHFCQUFTLDRCQUEwQixXQUFXO0FBQzlDLGtCQUFNLEdBQUcsa0JBQUssT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsRUFBRSxTQUFTLENBQUM7O0FBQ3ZELGdDQUFJLEtBQUssdUJBQW9CLE1BQU0sUUFBSSxDQUFDO0FBQ3hDLDBCQUFjLENBQUMsSUFBSSxDQUFDLGtCQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDOzs7OzZDQUduQyxzQkFBRSxHQUFHLENBQUMsY0FBYyxDQUFDOzs7Ozs7O0tBQzVCOzs7V0FFZ0Isb0JBQUMsT0FBTyxFQUFFLFdBQVc7VUFBRSxLQUFLLHlEQUFHLEtBQUs7O1VBQy9DLElBQUksRUFpQkYsSUFBSSxFQVJKLE1BQU0sWUFFRCxHQUFHOzs7OztBQVhWLGdCQUFJLEdBQUcsRUFBRTs7NkNBR0gsSUFBSSxDQUFDLGtCQUFrQixFQUFFOzs7OztvQ0FBSSxDQUFDOzs7Ozs7NkNBQ3JCLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDOzs7QUFBeEMsZ0JBQUk7O2dCQUNILElBQUk7Ozs7O2dEQUFTLElBQUk7OztnQkFJUixLQUFLOzs7Ozs7NkNBQVMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDOzs7Ozs7Ozs2QkFBRyxTQUFTOzs7QUFBekUsa0JBQU07bUJBRU0sQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDOztBQUE5QixpREFBZ0M7QUFBdkIsaUJBQUc7O0FBQ1Ysa0JBQUksR0FBRyxFQUFFO0FBQ1Asb0JBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7ZUFDaEI7YUFDRjs7Ozs7OzZDQUVnQixJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQzs7O0FBQXBDLGdCQUFJOztBQUNSLGdCQUFJLElBQUksRUFBRTtBQUNSLGtCQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2pCOzs7Z0RBRUksSUFBSTs7Ozs7OztLQUNaOzs7V0FFbUI7VUFBQyxNQUFNLHlEQUFHLEtBQUs7VUFBRSxjQUFjLHlEQUFHLElBQUksQ0FBQyxjQUFjOzs7Ozs7QUFDdkUsZ0NBQUksS0FBSyxDQUFDLDRFQUE0RSxDQUFDLENBQUM7QUFDeEYsZ0NBQUksS0FBSywrQkFBNkIsTUFBTSxDQUFHLENBQUM7Ozs2Q0FFMUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7OztpQkFFMUIsTUFBTTs7Ozs7OzZDQUNGLElBQUksQ0FBQyxPQUFPLENBQUMsc0JBQXNCLENBQUM7Ozs7NkNBUXRDLDZCQUFjLEVBQUUsRUFBRSxHQUFHLEVBQUU7a0JBRXJCLEdBQUc7Ozs7O3FEQURDLElBQUksQ0FBQyxPQUFPLEVBQUU7Ozs7Ozs7O0FBQ2xCLHVCQUFHLEdBQUcsa0RBQWtEOztBQUM1RCx3Q0FBSSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7MEJBQ1QsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDOzs7Ozs7O2FBRXZCLENBQUM7Ozs7NkNBR0ksSUFBSSxDQUFDLFFBQVEsRUFBRTs7Ozs7OztLQUN0Qjs7O1dBRXdCO1VBS25CLFlBQVksRUFFVixPQUFPLEVBT1AsU0FBUzs7Ozs7Ozs7QUFYZixnQ0FBSSxLQUFLLHdDQUFzQyxJQUFJLENBQUMsSUFBSSxDQUFHLENBQUM7O0FBRXhELHdCQUFZLDhCQUE0QixJQUFJLENBQUMsSUFBSTs7QUFFL0MsbUJBQU8sR0FBTSxZQUFZOzs2Q0FDdkIsd0JBQUssTUFBTSxFQUFFLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDOzs7Ozs7Ozs7O0FBRW5DLGdDQUFJLElBQUksd0NBQXNDLGVBQUksT0FBTyxDQUFHLENBQUM7QUFDN0QsZ0NBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7Ozs7QUFHN0IscUJBQVMsR0FBTSxZQUFZOzs2Q0FDekIsd0JBQUssTUFBTSxFQUFFLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDOzs7Ozs7Ozs7O0FBRXJDLGdDQUFJLElBQUksMENBQXdDLGVBQUksT0FBTyxDQUFHLENBQUM7QUFDL0QsZ0NBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7Ozs7OzZDQUkzQixnQ0FBaUI7eUJBQ2hCLE1BQU07Ozs7OztxREFBVSx3QkFBSyxNQUFNLEVBQUUsQ0FBQyxJQUFJLHFCQUNwQixJQUFJLENBQUMsSUFBSSwyRUFBc0UsQ0FBQzs7OztBQUQ5RiwwQkFBTSxTQUFOLE1BQU07d0RBRUosTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sS0FBSyxDQUFDOzs7Ozs7O2FBQ2xDLEVBQUUsRUFBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUMsQ0FBQzs7Ozs7Ozs7OztBQUVwQyxnQ0FBSSxJQUFJLHlDQUF1QyxJQUFJLENBQUMsSUFBSSxVQUFLLGVBQUksT0FBTyxDQUFHLENBQUM7QUFDNUUsZ0NBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7Ozs7Ozs7S0FFcEM7OztXQUVjOzs7Ozs2Q0FDUCxpQ0FBbUI7Ozs7Ozs7S0FDMUI7OztXQUVZOzs7Ozs2Q0FDTCxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7Ozs7Ozs7S0FDckM7OztXQUVvQix3QkFBQyxLQUFLLEVBQUUsT0FBTzs7Ozs7NkNBQ3JCLFFBQVEsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUM7Ozs7Ozs7Ozs7S0FDM0Q7OztXQUU0QixnQ0FBQyxRQUFRLEVBQUUsVUFBVTs7Ozs7NkNBQ25DLFFBQVEsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFVBQVUsQ0FBQzs7Ozs7Ozs7OztLQUN6RTs7O1dBRTBCLDhCQUFDLE9BQU87Ozs7OzZDQUMzQixRQUFRLENBQUMsd0JBQXdCLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQzs7Ozs2Q0FDaEQsUUFBUSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFLE9BQU8sQ0FBQzs7Ozs7OztLQUM3RDs7O1dBRWtCLHNCQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsY0FBYzs7Ozs7NkNBQ3JDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsY0FBYyxDQUFDOzs7Ozs7Ozs7O0tBQzNFOzs7V0FFa0I7VUFHYixJQUFJLEVBS0osRUFBRSxFQU1GLGNBQWMsdUZBQ1QsR0FBRzs7Ozs7QUFkWixnQ0FBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQzs7QUFFN0MsZ0JBQUksR0FBRyxFQUFFOzZCQUdiLElBQUk7OzZDQUFZLElBQUksQ0FBQyxTQUFTLENBQUMsd0JBQXdCLENBQUM7Ozs7MkJBQW5ELElBQUk7OzZDQUVNLElBQUksQ0FBQyxrQkFBa0IsRUFBRTs7O0FBQXBDLGNBQUU7O2tCQUNGLEVBQUUsSUFBSSxDQUFDLENBQUE7Ozs7OzZCQUVULElBQUk7OzZDQUFZLElBQUksQ0FBQyxTQUFTLENBQUMsd0JBQXdCLEVBQUUsUUFBUSxDQUFDOzs7OzJCQUE3RCxJQUFJOzs7QUFHUCwwQkFBYyxHQUFHLEVBQUU7Ozs7OztBQUN2QiwyQ0FBZ0Isb0JBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyx5R0FBRTtBQUF4QixpQkFBRzs7QUFDVixrQ0FBSSxLQUFLLDRCQUF5QixHQUFHLFFBQUksQ0FBQztBQUMxQyw0QkFBYyxDQUFDLElBQUksQ0FBQyxrQkFBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQzthQUNyQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzZDQUNLLHNCQUFFLEdBQUcsQ0FBQyxjQUFjLENBQUM7Ozs7Ozs7S0FDNUI7OztXQUVpQjtVQUFDLFNBQVMseURBQUcsSUFBSTs7VUFRN0IsVUFBVSxFQUNWLFVBQVUsRUFNVixnQkFBZ0IsRUFDaEIsYUFBYSxFQWlCYixjQUFjLHVGQUVULElBQUk7Ozs7O0FBbENiLGdDQUFJLEtBQUssQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDOzs2Q0FDckMsSUFBSSxDQUFDLE9BQU8sRUFBRTs7Ozs7Ozs7QUFDdEIsZ0NBQUksSUFBSSxDQUFDLDZEQUE2RCxHQUM3RCw4Q0FBOEMsQ0FBQyxDQUFDOzs7O0FBSXZELHNCQUFVLEdBQUcsa0JBQUssT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBRSxTQUFTLENBQUM7OzZDQUNoQyxJQUFJLENBQUMsU0FBUyxDQUFDLHdCQUF3QixDQUFDOzs7QUFBM0Qsc0JBQVU7O2dCQUNULFVBQVU7Ozs7O0FBQ2IsZ0NBQUksSUFBSSxDQUFDLDZEQUE2RCxHQUM3RCw4Q0FBOEMsQ0FBQyxDQUFDOzs7O0FBR3ZELDRCQUFnQixHQUFHLGtCQUFLLE9BQU8sQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDO0FBQ3RELHlCQUFhLEdBQUcsQ0FDbEIseUNBQXlDLEVBQ3pDLGlDQUFpQyxFQUNqQyxnQ0FBZ0MsRUFDaEMsc0NBQXNDLEVBQ3RDLHNDQUFzQyxFQUN0QyxlQUFlLEVBQ2YsaUNBQWlDLEVBQ2pDLCtCQUErQixFQUMvQix5QkFBeUIsRUFDekIsVUFBVSxFQUNWLHlCQUF5QixFQUN6QixnQ0FBZ0MsRUFDaEMscUNBQXFDLEVBQ3JDLHdDQUF3QyxFQUN4QyxpQ0FBaUMsQ0FDbEM7QUFDRywwQkFBYyxHQUFHLEVBQUU7Ozs7OztBQUV2QiwyQ0FBaUIsYUFBYSx5R0FBRTtBQUF2QixrQkFBSTs7QUFDWCw0QkFBYyxDQUFDLElBQUksQ0FBQyxrQkFBRyxNQUFNLENBQUMsa0JBQUssT0FBTyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDL0QsNEJBQWMsQ0FBQyxJQUFJLENBQUMsa0JBQUcsTUFBTSxDQUFDLGtCQUFLLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDdEU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVELGdCQUFJLENBQUMsU0FBUyxFQUFFO0FBQ2QsNEJBQWMsQ0FBQyxJQUFJLENBQUMsa0JBQUcsTUFBTSxDQUFDLGtCQUFLLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUN2Rjs7OzZDQUVLLHNCQUFFLEdBQUcsQ0FBQyxjQUFjLENBQUM7Ozs7Ozs7S0FDNUI7OztXQUVlLG1CQUFDLFFBQVE7Ozs7OzZDQUNqQixNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDOzs7Ozs7O0tBQzVDOzs7V0FFb0Isd0JBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVOzs7Ozs2Q0FDMUMseUJBQVcsVUFBVSxDQUFDOzs7OzZDQUN0QixrQkFBRyxRQUFRLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQzs7O0FBQ3RDLGdDQUFJLEtBQUssZUFBWSxPQUFPLGdCQUFTLFVBQVUsUUFBSSxDQUFDOzs7NkNBRTlDLGtCQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUM7OztBQUN4QixnQ0FBSSxLQUFLLDRDQUF5QyxPQUFPLFFBQUksQ0FBQzs7Z0RBRXZELENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQzs7Ozs7OztLQUM3Qjs7O1dBRWEsaUJBQUMsR0FBRztVQUNWLHVCQUF1QixFQUN2QixzQkFBc0IsRUFDdEIsa0JBQWtCOzs7O0FBRmxCLG1DQUF1QixHQUFHLGVBQWU7QUFDekMsa0NBQXNCLEdBQUcsRUFBRSxHQUFHLElBQUk7QUFDbEMsOEJBQWtCLEdBQUcsQ0FBQyxHQUFHLElBQUk7OzZDQUV6QixJQUFJLENBQUMsU0FBUyxFQUFFOzs7Ozs7Ozs7NkNBQ2xCLHFCQUFNLElBQUksRUFBRSxNQUFNLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDOzs7OzZDQUMzQyxJQUFJLENBQUMsYUFBYSxDQUFDLHVCQUF1QixFQUFFLHNCQUFzQixDQUFDOzs7O0FBRXpFLGdDQUFJLEtBQUssOEJBQTRCLGtCQUFrQiw4QkFBMkIsQ0FBQzs7NkNBQzdFLHNCQUFFLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQzs7O0FBQ2pDLGdDQUFJLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDOzs7O2tCQUcvQixJQUFJLEtBQUssQ0FBQyxzREFBc0QsQ0FBQzs7Ozs7OztLQUUxRTs7Ozs7O1dBSW1CLHVCQUFDLGVBQWUsRUFBRSxTQUFTO1VBQ3pDLE1BQU07Ozs7OztBQUFOLGtCQUFNLEdBQUcsa0JBQUssT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRSxZQUFZLENBQUM7OzZDQUduRCw2QkFBYyxHQUFHLEVBQUUsR0FBRyxFQUFFO2tCQUN4QixNQUFNOzs7OztxREFBUyxrQkFBRyxNQUFNLENBQUMsTUFBTSxDQUFDOzs7QUFBaEMsMEJBQU07O3dCQUNMLE1BQU07Ozs7OzBCQUNILElBQUksS0FBSyxzQ0FBbUMsTUFBTSxRQUFJOzs7Ozs7O2FBRS9ELENBQUM7Ozs7QUFFRixnQ0FBSSxJQUFJLHlCQUFzQixNQUFNLFFBQUksQ0FBQztBQUN6QyxnQ0FBSSxJQUFJLDREQUEwRCxlQUFlLE9BQUksQ0FBQztBQUN0RixnQ0FBSSxJQUFJLDZCQUEyQixTQUFTLFFBQUssQ0FBQzs7OzZDQUUxQyw0QkFBVSxNQUFNLEVBQUUsZUFBZSxFQUFFLFNBQVMsQ0FBQzs7Ozs7Ozs7OztBQUVuRCxnQ0FBSSxLQUFLLENBQUMsaURBQWlELENBQUMsQ0FBQzs7Ozs7OztLQUVoRTs7O1dBRTBCLDhCQUFDLFFBQVE7Ozs7OzZDQUM1QixJQUFJLENBQUMsUUFBUSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsQ0FBQzs7Ozs7OztLQUNuRDs7O1dBRTJCLCtCQUFDLFFBQVE7Ozs7OzZDQUM3QixJQUFJLENBQUMsUUFBUSxDQUFDLHFCQUFxQixDQUFDLFFBQVEsQ0FBQzs7Ozs7OztLQUNwRDs7O1dBRXVCLDJCQUFDLFFBQVE7Ozs7OzZDQUNsQixJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQzs7Ozs7Ozs7OztLQUN2RDs7O1dBRW1COzs7Ozs2Q0FDWix3QkFBSyxXQUFXLEVBQUUsQ0FBQyxJQUFJLDRMQUszQixDQUFDOzs7Ozs7O0tBQ0o7OztTQS9oQmtCLGVBQUc7QUFDcEIsYUFBTyxlQUFlLENBQUM7S0FDeEI7OztXQStoQjRDLHlDQUFDLGVBQWU7VUFDdkQsVUFBVTs7OztBQUFWLHNCQUFVLEdBQUcsZUFBZTs7Z0JBQzNCLFVBQVU7Ozs7Ozs2Q0FDTSx5QkFBTSxZQUFZLEVBQUU7OztBQUF2QyxzQkFBVTs7QUFDVixnQ0FBSSxJQUFJLHNEQUFvRCxVQUFVLENBQUcsQ0FBQzs7O0FBRzFFLGdCQUFJLENBQUMsb0JBQUUsUUFBUSxDQUFDLFVBQVUsQ0FBQyxFQUFFO0FBQzNCLHdCQUFVLEdBQUcsQUFBQyxVQUFVLEdBQUcsQ0FBQyxHQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBTSxVQUFVLE9BQUksQ0FBQzthQUN4RTs7O2dEQUVJLFVBQVU7Ozs7Ozs7S0FDbEI7Ozs7O1dBRzBDLHVDQUFDLGVBQWU7VUFDckQsVUFBVTs7Ozs7NkNBQVMsSUFBSSxDQUFDLCtCQUErQixDQUFDLGVBQWUsQ0FBQzs7O0FBQXhFLHNCQUFVO3NEQUVILFVBQVU7Ozs7Ozs7S0FDdEI7Ozs7O1dBR2dDLHFDQUFHOztBQUVsQyxhQUFPO0FBQ0wsd0NBQWdDLEVBQUUsd0JBQXdCO0FBQzFELHdDQUFnQyxFQUFFLHdCQUF3QjtBQUMxRCx3Q0FBZ0MsRUFBRSx3QkFBd0I7QUFDMUQsd0NBQWdDLEVBQUUsd0JBQXdCO0FBQzFELHdDQUFnQyxFQUFFLHdCQUF3QjtBQUMxRCx3Q0FBZ0MsRUFBRSx3QkFBd0I7QUFDMUQsMENBQWtDLEVBQUUsMkJBQTJCO0FBQy9ELDBDQUFrQyxFQUFFLDBCQUEwQjtBQUM5RCwwQ0FBa0MsRUFBRSwwQkFBMEI7QUFDOUQsMENBQWtDLEVBQUUsMEJBQTBCO0FBQzlELDBDQUFrQyxFQUFFLDBCQUEwQjtBQUM5RCwwQ0FBa0MsRUFBRSwwQkFBMEI7T0FDL0QsQ0FBQztLQUNIOzs7V0FFNEIseUJBQUMsSUFBSTtVQU81QixPQUFPLEVBYVAsUUFBUSxFQUdOLE1BQU0sRUFRUixlQUFlLEVBaUJmLFVBQVUsRUFFVixTQUFTOzs7O0FBakRiLGdCQUFJLEdBQUcsZUFBYyxFQUFFLEVBQUU7QUFDdkIsd0JBQVUsRUFBRSxJQUFJO0FBQ2hCLDZCQUFlLEVBQUUsSUFBSTtBQUNyQix5QkFBVyxFQUFFLEtBQUs7QUFDbEIsdUJBQVMsRUFBRSxLQUFLO2FBQ2pCLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDTCxtQkFBTyxHQUFHO0FBQ1osd0JBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtBQUMzQiw2QkFBZSxFQUFFLElBQUksQ0FBQyxlQUFlO0FBQ3JDLHlCQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7QUFDN0IsdUJBQVMsRUFBRSxJQUFJLENBQUMsU0FBUzthQUMxQjs7QUFDRCxnQ0FBSSxLQUFLLDBDQUF3QyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFHLENBQUM7Ozs7a0JBR3hFLENBQUMsSUFBSSxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUEsQ0FBRSxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUE7Ozs7O2dEQUM3QixJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7OztBQUdqQyxvQkFBUSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVM7O0FBRXBELGdCQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7QUFDZixvQkFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFOztBQUMxQyxrQkFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO0FBQ25DLHdCQUFRLEdBQUcsSUFBSSxDQUFDO2VBQ2pCLE1BQU0sSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO0FBQ3hDLHdCQUFRLEdBQUcsS0FBSyxDQUFDO2VBQ2xCO2FBQ0Y7O0FBRUcsMkJBQWUsR0FBRyxJQUFJLENBQUMsVUFBVSxLQUFLLFFBQVEsR0FBRyxrQkFBa0IsR0FBRyxnQkFBZ0IsQ0FBQSxBQUFDOzs7O0FBSTNGLGdCQUFJLGlCQUFpQixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRTtBQUMzQyw2QkFBZSxJQUFJLFlBQVksQ0FBQzthQUNqQzs7Ozs7O0FBTUQsZ0JBQUksNEJBQTRCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUFFO0FBQ3RELDZCQUFlLEdBQUcsZUFBZSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLENBQUM7YUFDN0Q7OzZDQUM0QixJQUFJLENBQUMsNkJBQTZCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQzs7OztBQUFyRiwyQkFBZTtBQUVYLHNCQUFVLEdBQUcsSUFBSSxDQUFDLHlCQUF5QixFQUFFO0FBRTdDLHFCQUFTLEdBQUcsVUFBVTs7QUFDMUIsZ0JBQUksU0FBUyxDQUFDLGVBQWUsQ0FBQyxFQUFFO0FBQzlCLDZCQUFlLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQzdDLGtDQUFJLEtBQUssQ0FBQyxtQ0FBZ0MsSUFBSSxDQUFDLFVBQVUsc0JBQ3JDLGVBQWUsUUFBRyxDQUFDLENBQUM7YUFDekM7O0FBRUQsZ0NBQUksS0FBSywrQkFBNEIsZUFBZSxRQUFJLENBQUM7Z0RBQ2xELGVBQWU7Ozs7Ozs7S0FDdkI7OztTQXhxQkcsZUFBZTtHQUFTLFlBQVk7Ozs7Ozs7O0FBMnFCMUMscUNBQXNCLG9CQUFFLE9BQU8sOEJBQVksaUhBQUU7OztRQUFuQyxHQUFHO1FBQUUsRUFBRTs7QUFDZixtQkFBZSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7R0FDckM7Ozs7Ozs7Ozs7Ozs7Ozs7cUJBRWMsZUFBZTtRQUNyQixlQUFlLEdBQWYsZUFBZTtRQUFFLG9CQUFvQixHQUFwQixvQkFBb0IiLCJmaWxlIjoibGliL3NpbXVsYXRvci14Y29kZS02LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBzaW1jdGwgZnJvbSAnbm9kZS1zaW1jdGwnO1xuaW1wb3J0IHsgZGVmYXVsdCBhcyB4Y29kZSwgZ2V0UGF0aCBhcyBnZXRYY29kZVBhdGggfSBmcm9tICdhcHBpdW0teGNvZGUnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBraWxsQWxsU2ltdWxhdG9ycywgc2FmZVJpbVJhZiB9IGZyb20gJy4vdXRpbHMuanMnO1xuaW1wb3J0IHsgc2V0VG91Y2hFbnJvbGxLZXkgfSBmcm9tICcuL3RvdWNoLWVucm9sbC5qcyc7XG5pbXBvcnQgeyBhc3luY21hcCwgd2FpdEZvckNvbmRpdGlvbiwgcmV0cnlJbnRlcnZhbCwgcmV0cnkgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgKiBhcyBzZXR0aW5ncyBmcm9tICcuL3NldHRpbmdzJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgdGFpbFVudGlsIH0gZnJvbSAnLi90YWlsLXVudGlsLmpzJztcbmltcG9ydCBleHRlbnNpb25zIGZyb20gJy4vZXh0ZW5zaW9ucy9pbmRleCc7XG5pbXBvcnQgZXZlbnRzIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgQ2FsZW5kYXIgZnJvbSAnLi9jYWxlbmRhcic7XG5jb25zdCB7IEV2ZW50RW1pdHRlciB9ID0gZXZlbnRzO1xuXG5jb25zdCBPUEVOX1RJTUVPVVQgPSAzMDAwO1xuY29uc3QgU1RBUlRVUF9USU1FT1VUID0gNjAgKiAxMDAwO1xuY29uc3QgRVhUUkFfU1RBUlRVUF9USU1FID0gMjAwMDtcbi8qXG4gKiBUaGlzIGV2ZW50IGlzIGVtaXR0ZWQgYXMgc29vbiBhcyBpT1MgU2ltdWxhdG9yXG4gKiBoYXMgZmluaXNoZWQgYm9vdGluZyBhbmQgaXQgaXMgcmVhZHkgdG8gYWNjZXB0IHhjcnVuIGNvbW1hbmRzLlxuICogVGhlIGV2ZW50IGhhbmRsZXIgaXMgY2FsbGVkIGFmdGVyICdydW4nIG1ldGhvZCBpcyBjb21wbGV0ZWRcbiAqIGZvciBYY29kZSA3IGFuZCBvbGRlciBhbmQgaXMgb25seSB1c2VmdWwgaW4gWGNvZGUgOCssXG4gKiBzaW5jZSBvbmUgY2FuIHN0YXJ0IGRvaW5nIHN0dWZmIChmb3IgZXhhbXBsZSBpbnN0YWxsL3VuaW5zdGFsbCBhbiBhcHApIGluIHBhcmFsbGVsXG4gKiB3aXRoIFNpbXVsYXRvciBVSSBzdGFydHVwLCB3aGljaCBzaG9ydGVucyBzZXNzaW9uIHN0YXJ0dXAgdGltZS5cbiAqL1xuY29uc3QgQk9PVF9DT01QTEVURURfRVZFTlQgPSAnYm9vdENvbXBsZXRlZCc7XG5cbmNsYXNzIFNpbXVsYXRvclhjb2RlNiBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gIGNvbnN0cnVjdG9yICh1ZGlkLCB4Y29kZVZlcnNpb24pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMudWRpZCA9IFN0cmluZyh1ZGlkKTtcbiAgICB0aGlzLnhjb2RlVmVyc2lvbiA9IHhjb2RlVmVyc2lvbjtcblxuICAgIC8vIHBsYXRmb3JtVmVyc2lvbiBjYW5ub3QgYmUgZm91bmQgaW5pdGlhbGx5LCBzaW5jZSBnZXR0aW5nIGl0IGhhcyBzaWRlIGVmZmVjdHMgZm9yXG4gICAgLy8gb3VyIGxvZ2ljIGZvciBmaWd1cmluZyBvdXQgaWYgYSBzaW0gaGFzIGJlZW4gcnVuXG4gICAgLy8gaXQgd2lsbCBiZSBzZXQgd2hlbiBpdCBpcyBuZWVkZWRcbiAgICB0aGlzLl9wbGF0Zm9ybVZlcnNpb24gPSBudWxsO1xuXG4gICAgdGhpcy5rZXljaGFpblBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5nZXREaXIoKSwgJ0xpYnJhcnknLCAnS2V5Y2hhaW5zJyk7XG4gICAgdGhpcy5zaW11bGF0b3JBcHAgPSAnaU9TIFNpbXVsYXRvci5hcHAnO1xuXG4gICAgdGhpcy5zY2FsZUZhY3RvciA9IG51bGw7XG4gICAgdGhpcy5jb25uZWN0SGFyZHdhcmVLZXlib2FyZCA9IG51bGw7XG5cbiAgICB0aGlzLmFwcERhdGFCdW5kbGVQYXRocyA9IHt9O1xuXG4gICAgLy8gbGlzdCBvZiBmaWxlcyB0byBjaGVjayBmb3Igd2hlbiBzZWVpbmcgaWYgYSBzaW11bGF0b3IgaXMgXCJmcmVzaFwiXG4gICAgLy8gKG1lYW5pbmcgaXQgaGFzIG5ldmVyIGJlZW4gYm9vdGVkKS5cbiAgICAvLyBJZiB0aGVzZSBmaWxlcyBhcmUgcHJlc2VudCwgd2UgYXNzdW1lIGl0J3MgYmVlbiBzdWNjZXNzZnVsbHkgYm9vdGVkXG4gICAgdGhpcy5pc0ZyZXNoRmlsZXMgPSBbXG4gICAgICAnTGlicmFyeS9Db25maWd1cmF0aW9uUHJvZmlsZXMnLFxuICAgICAgJ0xpYnJhcnkvQ29va2llcycsXG4gICAgICAnTGlicmFyeS9QcmVmZXJlbmNlcy8uR2xvYmFsUHJlZmVyZW5jZXMucGxpc3QnLFxuICAgICAgJ0xpYnJhcnkvUHJlZmVyZW5jZXMvY29tLmFwcGxlLnNwcmluZ2JvYXJkLnBsaXN0JyxcbiAgICAgICd2YXIvcnVuL3N5c2xvZy5waWQnXG4gICAgXTtcblxuICAgIC8vIGV4dHJhIHRpbWUgdG8gd2FpdCBmb3Igc2ltdWxhdG9yIHRvIGJlIGRlZW1lZCBib290ZWRcbiAgICB0aGlzLmV4dHJhU3RhcnR1cFRpbWUgPSBFWFRSQV9TVEFSVFVQX1RJTUU7XG5cbiAgICB0aGlzLmNhbGVuZGFyID0gbmV3IENhbGVuZGFyKHRoaXMuZ2V0RGlyKCkpO1xuICB9XG5cbiAgZ2V0IHN0YXJ0dXBUaW1lb3V0ICgpIHtcbiAgICByZXR1cm4gU1RBUlRVUF9USU1FT1VUO1xuICB9XG5cbiAgc2V0U2NhbGVGYWN0b3IgKG5ld1NjYWxlRmFjdG9yKSB7XG4gICAgbGV0IHN1cHBvcnRlZFNjYWxlcyA9IFsnMS4wJywgJzAuNzUnLCAnMC41JywgJzAuMzMnLCAnMC4yNSddO1xuICAgIGlmIChzdXBwb3J0ZWRTY2FsZXMuaW5kZXhPZihuZXdTY2FsZUZhY3RvcikgPCAwKSB7XG4gICAgICBsZXQgbXNnID0gYE9ubHkgXCIke3N1cHBvcnRlZFNjYWxlc31cIiB2YWx1ZXMgYXJlIHN1cHBvcnRlZCBhcyBzY2FsZSBmYWN0b3JzLiBcIiR7bmV3U2NhbGVGYWN0b3J9XCIgaXMgcGFzc2VkIGluc3RlYWQuYDtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgfVxuICAgIHRoaXMuc2NhbGVGYWN0b3IgPSBuZXdTY2FsZUZhY3RvcjtcbiAgfVxuXG4gIHNldENvbm5lY3RIYXJkd2FyZUtleWJvYXJkIChuZXdWYWx1ZSkge1xuICAgIHRoaXMuY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQgPSBuZXdWYWx1ZTtcbiAgfVxuXG4gIGFzeW5jIGdldFBsYXRmb3JtVmVyc2lvbiAoKSB7XG4gICAgaWYgKCF0aGlzLl9wbGF0Zm9ybVZlcnNpb24pIHtcbiAgICAgIGxldCB7c2RrfSA9IGF3YWl0IHRoaXMuc3RhdCgpO1xuICAgICAgdGhpcy5fcGxhdGZvcm1WZXJzaW9uID0gc2RrO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fcGxhdGZvcm1WZXJzaW9uO1xuICB9XG5cbiAgZ2V0Um9vdERpciAoKSB7XG4gICAgbGV0IGhvbWUgPSBwcm9jZXNzLmVudi5IT01FO1xuICAgIHJldHVybiBwYXRoLnJlc29sdmUoaG9tZSwgJ0xpYnJhcnknLCAnRGV2ZWxvcGVyJywgJ0NvcmVTaW11bGF0b3InLCAnRGV2aWNlcycpO1xuICB9XG5cbiAgZ2V0RGlyICgpIHtcbiAgICByZXR1cm4gcGF0aC5yZXNvbHZlKHRoaXMuZ2V0Um9vdERpcigpLCB0aGlzLnVkaWQsICdkYXRhJyk7XG4gIH1cblxuICBnZXRMb2dEaXIgKCkge1xuICAgIGxldCBob21lID0gcHJvY2Vzcy5lbnYuSE9NRTtcbiAgICByZXR1cm4gcGF0aC5yZXNvbHZlKGhvbWUsICdMaWJyYXJ5JywgJ0xvZ3MnLCAnQ29yZVNpbXVsYXRvcicsIHRoaXMudWRpZCk7XG4gIH1cblxuICBhc3luYyBpbnN0YWxsQXBwIChhcHApIHtcbiAgICByZXR1cm4gYXdhaXQgc2ltY3RsLmluc3RhbGxBcHAodGhpcy51ZGlkLCBhcHApO1xuICB9XG5cbiAgYXN5bmMgaXNBcHBJbnN0YWxsZWQgKGJ1bmRsZUlkLCBhcHBGaWxlID0gbnVsbCkge1xuICAgIC8vIGBhcHBGaWxlYCBhcmd1bWVudCBvbmx5IG5lY2Vzc2FyeSBmb3IgaU9TIGJlbG93IHZlcnNpb24gOFxuICAgIGxldCBhcHBEaXJzID0gYXdhaXQgdGhpcy5nZXRBcHBEaXJzKGFwcEZpbGUsIGJ1bmRsZUlkKTtcbiAgICByZXR1cm4gYXBwRGlycy5sZW5ndGggIT09IDA7XG4gIH1cblxuICAvKlxuICAgKiB0YWtlcyBhbiBgaWRgLCB3aGljaCBpcyBlaXRoZXIgYSBidW5kbGVJZCAoZS5nLiwgY29tLmFwcGxlLm1vYmlsZXNhZmFyaSlcbiAgICogb3IsIGZvciBpT1MgNy4xLCB0aGUgYXBwIG5hbWUgd2l0aG91dCBgLmFwcGAgKGUuZy4sIE1vYmlsZVNhZmFyaSlcbiAgICovXG4gIGFzeW5jIGdldEFwcERpciAoaWQsIHN1YkRpciA9ICdEYXRhJykge1xuICAgIHRoaXMuYXBwRGF0YUJ1bmRsZVBhdGhzW3N1YkRpcl0gPSB0aGlzLmFwcERhdGFCdW5kbGVQYXRoc1tzdWJEaXJdIHx8IHt9O1xuICAgIGlmIChfLmlzRW1wdHkodGhpcy5hcHBEYXRhQnVuZGxlUGF0aHNbc3ViRGlyXSkgJiYgIWF3YWl0IHRoaXMuaXNGcmVzaCgpKSB7XG4gICAgICB0aGlzLmFwcERhdGFCdW5kbGVQYXRoc1tzdWJEaXJdID0gYXdhaXQgdGhpcy5idWlsZEJ1bmRsZVBhdGhNYXAoc3ViRGlyKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuYXBwRGF0YUJ1bmRsZVBhdGhzW3N1YkRpcl1baWRdO1xuICB9XG5cbiAgLypcbiAgICogdGhlIHhjb2RlIDYgc2ltdWxhdG9ycyBhcmUgcmVhbGx5IGFubm95aW5nLCBhbmQgYnVyeSB0aGUgbWFpbiBhcHBcbiAgICogZGlyZWN0b3JpZXMgaW5zaWRlIGRpcmVjdG9yaWVzIGp1c3QgbmFtZWQgd2l0aCBIYXNoZXMuXG4gICAqIFRoaXMgZnVuY3Rpb24gZmluZHMgdGhlIHByb3BlciBkaXJlY3RvcnkgYnkgdHJhdmVyc2luZyBhbGwgb2YgdGhlbVxuICAgKiBhbmQgcmVhZGluZyBhIG1ldGFkYXRhIHBsaXN0IChNb2JpbGUgQ29udGFpbmVyIE1hbmFnZXIpIHRvIGdldCB0aGVcbiAgICogYnVuZGxlIGlkLlxuICAgKi9cbiAgYXN5bmMgYnVpbGRCdW5kbGVQYXRoTWFwIChzdWJEaXIgPSAnRGF0YScpIHtcbiAgICBsb2cuZGVidWcoJ0J1aWxkaW5nIGJ1bmRsZSBwYXRoIG1hcCcpO1xuICAgIGxldCBhcHBsaWNhdGlvbkxpc3Q7XG4gICAgbGV0IHBhdGhCdW5kbGVQYWlyO1xuICAgIGlmIChhd2FpdCB0aGlzLmdldFBsYXRmb3JtVmVyc2lvbigpID09PSAnNy4xJykge1xuICAgICAgLy8gYXBwcyBhdmFpbGFibGVcbiAgICAgIC8vICAgV2ViLmFwcCxcbiAgICAgIC8vICAgV2ViVmlld1NlcnZpY2UuYXBwLFxuICAgICAgLy8gICBNb2JpbGVTYWZhcmkuYXBwLFxuICAgICAgLy8gICBXZWJDb250ZW50QW5hbHlzaXNVSS5hcHAsXG4gICAgICAvLyAgIEREQWN0aW9uc1NlcnZpY2UuYXBwLFxuICAgICAgLy8gICBTdG9yZUtpdFVJU2VydmljZS5hcHBcbiAgICAgIGFwcGxpY2F0aW9uTGlzdCA9IHBhdGgucmVzb2x2ZSh0aGlzLmdldERpcigpLCAnQXBwbGljYXRpb25zJyk7XG4gICAgICBwYXRoQnVuZGxlUGFpciA9IGFzeW5jIChkaXIpID0+IHtcbiAgICAgICAgZGlyID0gcGF0aC5yZXNvbHZlKGFwcGxpY2F0aW9uTGlzdCwgZGlyKTtcbiAgICAgICAgbGV0IGFwcEZpbGVzID0gYXdhaXQgZnMuZ2xvYihgJHtkaXJ9LyouYXBwYCk7XG4gICAgICAgIGxldCBidW5kbGVJZCA9IGFwcEZpbGVzWzBdLm1hdGNoKC8uKlxcLyguKilcXC5hcHAvKVsxXTtcbiAgICAgICAgcmV0dXJuIHtwYXRoOiBkaXIsIGJ1bmRsZUlkfTtcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIGFwcGxpY2F0aW9uTGlzdCA9IHBhdGgucmVzb2x2ZSh0aGlzLmdldERpcigpLCAnQ29udGFpbmVycycsIHN1YkRpciwgJ0FwcGxpY2F0aW9uJyk7XG4gICAgICAvLyBnaXZlbiBhIGRpcmVjdG9yeSwgZmluZCB0aGUgcGxpc3QgZmlsZSBhbmQgcHVsbCB0aGUgYnVuZGxlIGlkIGZyb20gaXRcbiAgICAgIGxldCByZWFkQnVuZGxlSWQgPSBhc3luYyAoZGlyKSA9PiB7XG4gICAgICAgIGxldCBwbGlzdCA9IHBhdGgucmVzb2x2ZShkaXIsICcuY29tLmFwcGxlLm1vYmlsZV9jb250YWluZXJfbWFuYWdlci5tZXRhZGF0YS5wbGlzdCcpO1xuICAgICAgICBsZXQgbWV0YWRhdGEgPSBhd2FpdCBzZXR0aW5ncy5yZWFkKHBsaXN0KTtcbiAgICAgICAgcmV0dXJuIG1ldGFkYXRhLk1DTU1ldGFkYXRhSWRlbnRpZmllcjtcbiAgICAgIH07XG4gICAgICAvLyBnaXZlbiBhIGRpcmVjdG9yeSwgcmV0dXJuIHRoZSBwYXRoIGFuZCBidW5kbGUgaWQgYXNzb2NpYXRlZCB3aXRoIGl0XG4gICAgICBwYXRoQnVuZGxlUGFpciA9IGFzeW5jIChkaXIpID0+IHtcbiAgICAgICAgZGlyID0gcGF0aC5yZXNvbHZlKGFwcGxpY2F0aW9uTGlzdCwgZGlyKTtcbiAgICAgICAgbGV0IGJ1bmRsZUlkID0gYXdhaXQgcmVhZEJ1bmRsZUlkKGRpcik7XG4gICAgICAgIHJldHVybiB7cGF0aDogZGlyLCBidW5kbGVJZH07XG4gICAgICB9O1xuICAgIH1cblxuICAgIGxldCBidW5kbGVQYXRoRGlycyA9IGF3YWl0IGZzLnJlYWRkaXIoYXBwbGljYXRpb25MaXN0KTtcbiAgICBsZXQgYnVuZGxlUGF0aFBhaXJzID0gYXdhaXQgYXN5bmNtYXAoYnVuZGxlUGF0aERpcnMsIGFzeW5jIChkaXIpID0+IHtcbiAgICAgIHJldHVybiBhd2FpdCBwYXRoQnVuZGxlUGFpcihkaXIpO1xuICAgIH0sIGZhbHNlKTtcblxuICAgIC8vIHJlZHVjZSB0aGUgbGlzdCBvZiBwYXRoLWJ1bmRsZSBwYWlycyB0byBhbiBvYmplY3Qgd2hlcmUgYnVuZGxlSWRzIGFyZSBtYXBwZWQgdG8gcGF0aHNcbiAgICByZXR1cm4gYnVuZGxlUGF0aFBhaXJzLnJlZHVjZSgoYnVuZGxlTWFwLCBidW5kbGVQYXRoKSA9PiB7XG4gICAgICBidW5kbGVNYXBbYnVuZGxlUGF0aC5idW5kbGVJZF0gPSBidW5kbGVQYXRoLnBhdGg7XG4gICAgICByZXR1cm4gYnVuZGxlTWFwO1xuICAgIH0sIHt9KTtcbiAgfVxuXG4gIC8vIHJldHVybnMgc3RhdGUgYW5kIHNwZWNpZmljcyBvZiB0aGlzIHNpbS5cbiAgLy8geyBuYW1lOiAnaVBob25lIDRzJyxcbiAgLy8gICB1ZGlkOiAnQzA5QjM0RTUtN0RDQi00NDJFLUI3OUMtQUI2QkMwMzU3NDE3JyxcbiAgLy8gICBzdGF0ZTogJ1NodXRkb3duJyxcbiAgLy8gICBzZGs6ICc4LjMnXG4gIC8vIH1cbiAgYXN5bmMgc3RhdCAoKSB7XG4gICAgbGV0IGRldmljZXMgPSBhd2FpdCBzaW1jdGwuZ2V0RGV2aWNlcygpO1xuICAgIGxldCBub3JtYWxpemVkRGV2aWNlcyA9IFtdO1xuXG4gICAgLy8gYWRkIHNkayBhdHRyaWJ1dGUgdG8gYWxsIGVudHJpZXMsIGFkZCB0byBub3JtYWxpemVkRGV2aWNlc1xuICAgIGZvciAobGV0IFtzZGssIGRldmljZUFycl0gb2YgXy50b1BhaXJzKGRldmljZXMpKSB7XG4gICAgICBkZXZpY2VBcnIgPSBkZXZpY2VBcnIubWFwKChkZXZpY2UpID0+IHtcbiAgICAgICAgZGV2aWNlLnNkayA9IHNkaztcbiAgICAgICAgcmV0dXJuIGRldmljZTtcbiAgICAgIH0pO1xuICAgICAgbm9ybWFsaXplZERldmljZXMgPSBub3JtYWxpemVkRGV2aWNlcy5jb25jYXQoZGV2aWNlQXJyKTtcbiAgICB9XG5cbiAgICByZXR1cm4gXy5maW5kKG5vcm1hbGl6ZWREZXZpY2VzLCB7dWRpZDogdGhpcy51ZGlkfSk7XG4gIH1cblxuICBhc3luYyBpc0ZyZXNoICgpIHtcbiAgICAvLyB0aGlzIGlzIGEgYmVzdC1iZXQgaGV1cmlzdGljIGZvciB3aGV0aGVyIG9yIG5vdCBhIHNpbSBoYXMgYmVlbiBib290ZWRcbiAgICAvLyBiZWZvcmUuIFdlIHVzdWFsbHkgd2FudCB0byBzdGFydCBhIHNpbXVsYXRvciB0byBcIndhcm1cIiBpdCB1cCwgaGF2ZVxuICAgIC8vIFhjb2RlIHBvcHVsYXRlIGl0IHdpdGggcGxpc3RzIGZvciB1cyB0byBtYW5pcHVsYXRlIGJlZm9yZSBhIHJlYWxcbiAgICAvLyB0ZXN0IHJ1bi5cblxuICAgIC8vIGlmIHRoZSBmb2xsb3dpbmcgZmlsZXMgZG9uJ3QgZXhpc3QsIGl0IGhhc24ndCBiZWVuIGJvb3RlZC5cbiAgICAvLyBUSElTIElTIE5PVCBBTiBFWEhBVVNUSVZFIExJU1RcbiAgICBsb2cuZGVidWcoJ0NoZWNraW5nIHdoZXRoZXIgc2ltdWxhdG9yIGhhcyBiZWVuIHJ1biBiZWZvcmUnKTtcbiAgICBsZXQgZmlsZXMgPSB0aGlzLmlzRnJlc2hGaWxlcztcblxuICAgIGxldCBwdiA9IGF3YWl0IHRoaXMuZ2V0UGxhdGZvcm1WZXJzaW9uKCk7XG4gICAgaWYgKHB2ICE9PSAnNy4xJykge1xuICAgICAgZmlsZXMucHVzaCgnTGlicmFyeS9QcmVmZXJlbmNlcy9jb20uYXBwbGUuUHJlZmVyZW5jZXMucGxpc3QnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmlsZXMucHVzaCgnQXBwbGljYXRpb25zJyk7XG4gICAgfVxuXG4gICAgZmlsZXMgPSBmaWxlcy5tYXAoKHMpID0+IHtcbiAgICAgIHJldHVybiBwYXRoLnJlc29sdmUodGhpcy5nZXREaXIoKSwgcyk7XG4gICAgfSk7XG5cbiAgICBsZXQgZXhpc3RlbmNlcyA9IGF3YWl0IGFzeW5jbWFwKGZpbGVzLCBhc3luYyAoZikgPT4geyByZXR1cm4gYXdhaXQgZnMuaGFzQWNjZXNzKGYpOyB9KTtcbiAgICBsZXQgZnJlc2ggPSBfLmNvbXBhY3QoZXhpc3RlbmNlcykubGVuZ3RoICE9PSBmaWxlcy5sZW5ndGg7XG4gICAgbG9nLmRlYnVnKGBTaW11bGF0b3IgJHtmcmVzaCA/ICdoYXMgbm90JyA6ICdoYXMnfSBiZWVuIHJ1biBiZWZvcmVgKTtcbiAgICByZXR1cm4gZnJlc2g7XG4gIH1cblxuICBhc3luYyBpc1J1bm5pbmcgKCkge1xuICAgIGxldCBzdGF0ID0gYXdhaXQgdGhpcy5zdGF0KCk7XG4gICAgcmV0dXJuIHN0YXQuc3RhdGUgPT09ICdCb290ZWQnO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvckJvb3QgKHN0YXJ0dXBUaW1lb3V0KSB7XG4gICAgLy8gd2FpdCBmb3IgdGhlIHNpbXVsYXRvciB0byBib290XG4gICAgLy8gd2FpdGluZyBmb3IgdGhlIHNpbXVsYXRvciBzdGF0dXMgdG8gYmUgJ2Jvb3RlZCcgaXNuJ3QgZ29vZCBlbm91Z2hcbiAgICAvLyBpdCBjbGFpbXMgdG8gYmUgYm9vdGVkIHdheSBiZWZvcmUgZmluaXNoaW5nIGxvYWRpbmdcbiAgICAvLyBsZXQncyB0YWlsIHRoZSBzaW11bGF0b3Igc3lzdGVtIGxvZyB1bnRpbCB3ZSBzZWUgYSBtYWdpYyBsaW5lICh0aGlzLmJvb3RlZEluZGljYXRvcilcbiAgICBsZXQgYm9vdGVkSW5kaWNhdG9yID0gYXdhaXQgdGhpcy5nZXRCb290ZWRJbmRpY2F0b3JTdHJpbmcoKTtcbiAgICBhd2FpdCB0aGlzLnRhaWxMb2dzVW50aWwoYm9vdGVkSW5kaWNhdG9yLCBzdGFydHVwVGltZW91dCk7XG5cbiAgICAvLyBzbyBzb3JyeSwgYnV0IHdlIHNob3VsZCB3YWl0IGFub3RoZXIgdHdvIHNlY29uZHMsIGp1c3QgdG8gbWFrZSBzdXJlIHdlJ3ZlIHJlYWxseSBzdGFydGVkXG4gICAgLy8gd2UgY2FuJ3QgbG9vayBmb3IgYW5vdGhlciBtYWdpYyBsb2cgbGluZSwgYmVjYXVzZSB0aGV5IHNlZW0gdG8gYmUgYXBwLWRlcGVuZGVudCAobm90IHN5c3RlbSBkZXBlbmRlbnQpXG4gICAgbG9nLmRlYnVnKGBXYWl0aW5nIGFuIGV4dHJhICR7dGhpcy5leHRyYVN0YXJ0dXBUaW1lfW1zIGZvciB0aGUgc2ltdWxhdG9yIHRvIHJlYWxseSBmaW5pc2ggYm9vdGluZ2ApO1xuICAgIGF3YWl0IEIuZGVsYXkodGhpcy5leHRyYVN0YXJ0dXBUaW1lKTtcbiAgICBsb2cuZGVidWcoJ0RvbmUgd2FpdGluZyBleHRyYSB0aW1lIGZvciBzaW11bGF0b3InKTtcblxuICAgIHRoaXMuZW1pdChCT09UX0NPTVBMRVRFRF9FVkVOVCk7XG4gIH1cblxuICBhc3luYyBnZXRCb290ZWRJbmRpY2F0b3JTdHJpbmcgKCkge1xuICAgIGxldCBpbmRpY2F0b3I7XG4gICAgbGV0IHBsYXRmb3JtVmVyc2lvbiA9IGF3YWl0IHRoaXMuZ2V0UGxhdGZvcm1WZXJzaW9uKCk7XG4gICAgc3dpdGNoIChwbGF0Zm9ybVZlcnNpb24pIHtcbiAgICAgIGNhc2UgJzcuMSc6XG4gICAgICBjYXNlICc4LjEnOlxuICAgICAgY2FzZSAnOC4yJzpcbiAgICAgIGNhc2UgJzguMyc6XG4gICAgICBjYXNlICc4LjQnOlxuICAgICAgICBpbmRpY2F0b3IgPSAncHJvZmlsZWQ6IFNlcnZpY2Ugc3RhcnRpbmcuLi4nO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJzkuMCc6XG4gICAgICBjYXNlICc5LjEnOlxuICAgICAgY2FzZSAnOS4yJzpcbiAgICAgIGNhc2UgJzkuMyc6XG4gICAgICAgIGluZGljYXRvciA9ICdTeXN0ZW0gYXBwIFwiY29tLmFwcGxlLnNwcmluZ2JvYXJkXCIgZmluaXNoZWQgc3RhcnR1cCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnMTAuMCc6XG4gICAgICAgIGluZGljYXRvciA9ICdTd2l0Y2hpbmcgdG8ga2V5Ym9hcmQnO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGxvZy53YXJuKGBObyBib290IGluZGljYXRvciBjYXNlIGZvciBwbGF0Zm9ybSB2ZXJzaW9uICcke3BsYXRmb3JtVmVyc2lvbn0nYCk7XG4gICAgICAgIGluZGljYXRvciA9ICdubyBib290IGluZGljYXRvciBzdHJpbmcgYXZhaWxhYmxlJztcbiAgICB9XG4gICAgcmV0dXJuIGluZGljYXRvcjtcbiAgfVxuXG4gIGFzeW5jIHJ1biAoc3RhcnR1cFRpbWVvdXQgPSB0aGlzLnN0YXJ0dXBUaW1lb3V0LCBhbGxvd1RvdWNoRW5yb2xsID0gZmFsc2UpIHtcbiAgICBsZXQgc2ltdWxhdG9yQXBwID0gcGF0aC5yZXNvbHZlKGF3YWl0IGdldFhjb2RlUGF0aCgpLCAnQXBwbGljYXRpb25zJywgdGhpcy5zaW11bGF0b3JBcHApO1xuICAgIGxldCBhcmdzID0gWyctRm4nLCBzaW11bGF0b3JBcHAsICctLWFyZ3MnLCAnLUN1cnJlbnREZXZpY2VVRElEJywgdGhpcy51ZGlkXTtcbiAgICBpZiAodGhpcy5zY2FsZUZhY3Rvcikge1xuICAgICAgbGV0IHN0YXQgPSBhd2FpdCB0aGlzLnN0YXQoKTtcbiAgICAgIGxldCBmb3JtYXR0ZWREZXZpY2VOYW1lID0gc3RhdC5uYW1lLnJlcGxhY2UoL1xccysvZywgJy0nKTtcbiAgICAgIGxldCBhcmd1bWVudE5hbWUgPSBgLVNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZS1jb20uYXBwbGUuQ29yZVNpbXVsYXRvci5TaW1EZXZpY2VUeXBlLiR7Zm9ybWF0dGVkRGV2aWNlTmFtZX1gO1xuICAgICAgYXJncy5wdXNoKGFyZ3VtZW50TmFtZSwgdGhpcy5zY2FsZUZhY3Rvcik7XG4gICAgfVxuICAgIGlmICghdGhpcy5jb25uZWN0SGFyZHdhcmVLZXlib2FyZCkge1xuICAgICAgYXJncy5wdXNoKCctQ29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQnLCAnMCcpO1xuICAgIH1cblxuICAgIC8vIFNldCB0aGUgJ1RvdWNoIElEIEVucm9sbCcga2V5IGJpbmRpbmdzIGJlZm9yZSB0aGUgU2ltdWxhdG9yIHN0YXJ0c1xuICAgIGlmIChhbGxvd1RvdWNoRW5yb2xsKSB7XG4gICAgICBhd2FpdCBzZXRUb3VjaEVucm9sbEtleSgpO1xuICAgIH1cblxuICAgIGxvZy5pbmZvKGBTdGFydGluZyBzaW11bGF0b3Igd2l0aCBjb21tYW5kOiBvcGVuICR7YXJncy5qb2luKCcgJyl9YCk7XG4gICAgbGV0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgYXdhaXQgZXhlYygnb3BlbicsIGFyZ3MsIHt0aW1lb3V0OiBPUEVOX1RJTUVPVVR9KTtcblxuICAgIGF3YWl0IHRoaXMud2FpdEZvckJvb3Qoc3RhcnR1cFRpbWVvdXQpO1xuXG4gICAgbG9nLmluZm8oYFNpbXVsYXRvciBib290ZWQgaW4gJHtEYXRlLm5vdygpIC0gc3RhcnRUaW1lfW1zYCk7XG4gIH1cblxuICAvLyBUT0RPIGtlZXAga2V5Y2hhaW5zXG4gIGFzeW5jIGNsZWFuICgpIHtcbiAgICBhd2FpdCB0aGlzLmVuZFNpbXVsYXRvckRhZW1vbigpO1xuICAgIGxvZy5pbmZvKGBDbGVhbmluZyBzaW11bGF0b3IgJHt0aGlzLnVkaWR9YCk7XG4gICAgYXdhaXQgc2ltY3RsLmVyYXNlRGV2aWNlKHRoaXMudWRpZCwgMTAwMDApO1xuICB9XG5cbiAgYXN5bmMgc2NydWJDdXN0b21BcHAgKGFwcEZpbGUsIGFwcEJ1bmRsZUlkKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuY2xlYW5DdXN0b21BcHAgKGFwcEZpbGUsIGFwcEJ1bmRsZUlkLCB0cnVlKTtcbiAgfVxuXG4gIGFzeW5jIGNsZWFuQ3VzdG9tQXBwIChhcHBGaWxlLCBhcHBCdW5kbGVJZCwgc2NydWIgPSBmYWxzZSkge1xuICAgIC8vIGlmIGBzY3J1YmAgaXMgZmFsc2UsIHdlIHdhbnQgdG8gY2xlYW4gYnkgZGVsZXRpbmcgdGhlIGFwcCBhbmQgYWxsXG4gICAgLy8gZmlsZXMgYXNzb2NpYXRlZCB3aXRoIGl0XG4gICAgLy8gaWYgYHNjcnViYCBpcyB0cnVlLCB3ZSBqdXN0IHdhbnQgdG8gZGVsZXRlIHRoZSBwcmVmZXJlbmNlcyBhbmQgY2hhbmdlZFxuICAgIC8vIGZpbGVzXG5cbiAgICBsb2cuZGVidWcoYENsZWFuaW5nIGFwcCBkYXRhIGZpbGVzIGZvciAnJHthcHBGaWxlfScsICcke2FwcEJ1bmRsZUlkfSdgKTtcbiAgICBpZiAoIXNjcnViKSB7XG4gICAgICBsb2cuZGVidWcoYERlbGV0aW5nIGFwcCBhbHRvZ2V0aGVyYCk7XG4gICAgfVxuXG4gICAgLy8gZ2V0IHRoZSBkaXJlY3RvcmllcyB0byBiZSBkZWxldGVkXG4gICAgbGV0IGFwcERpcnMgPSBhd2FpdCB0aGlzLmdldEFwcERpcnMoYXBwRmlsZSwgYXBwQnVuZGxlSWQsIHNjcnViKTtcblxuICAgIGlmIChhcHBEaXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgbG9nLmRlYnVnKFwiQ291bGQgbm90IGZpbmQgYXBwIGRpcmVjdG9yaWVzIHRvIGRlbGV0ZS4gSXQgaXMgcHJvYmFibHkgbm90IGluc3RhbGxlZFwiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgZGVsZXRlUHJvbWlzZXMgPSBbXTtcblxuICAgIGZvciAobGV0IGRpciBvZiBhcHBEaXJzKSB7XG4gICAgICBsb2cuZGVidWcoYERlbGV0aW5nIGRpcmVjdG9yeTogJyR7ZGlyfSdgKTtcbiAgICAgIGRlbGV0ZVByb21pc2VzLnB1c2goZnMucmltcmFmKGRpcikpO1xuICAgIH1cblxuICAgIGlmIChhd2FpdCB0aGlzLmdldFBsYXRmb3JtVmVyc2lvbigpID49IDgpIHtcbiAgICAgIGxldCByZWxSbVBhdGggPSBgTGlicmFyeS9QcmVmZXJlbmNlcy8ke2FwcEJ1bmRsZUlkfS5wbGlzdGA7XG4gICAgICBsZXQgcm1QYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMuZ2V0Um9vdERpcigpLCByZWxSbVBhdGgpO1xuICAgICAgbG9nLmRlYnVnKGBEZWxldGluZyBmaWxlOiAnJHtybVBhdGh9J2ApO1xuICAgICAgZGVsZXRlUHJvbWlzZXMucHVzaChmcy5yaW1yYWYocm1QYXRoKSk7XG4gICAgfVxuXG4gICAgYXdhaXQgQi5hbGwoZGVsZXRlUHJvbWlzZXMpO1xuICB9XG5cbiAgYXN5bmMgZ2V0QXBwRGlycyAoYXBwRmlsZSwgYXBwQnVuZGxlSWQsIHNjcnViID0gZmFsc2UpIHtcbiAgICBsZXQgZGlycyA9IFtdO1xuICAgIC8vIGlPUyA4KyBzdG9yZXMgYXBwIGRhdGEgaW4gdHdvIHBsYWNlcyxcbiAgICAvLyBpT1MgNy4xIGhhcyBvbmx5IG9uZSBkaXJlY3RvcnlcbiAgICBpZiAoYXdhaXQgdGhpcy5nZXRQbGF0Zm9ybVZlcnNpb24oKSA+PSA4KSB7XG4gICAgICBsZXQgZGF0YSA9IGF3YWl0IHRoaXMuZ2V0QXBwRGlyKGFwcEJ1bmRsZUlkKTtcbiAgICAgIGlmICghZGF0YSkgcmV0dXJuIGRpcnM7XG5cbiAgICAgIC8vIHRoZSBgQnVuZGxlYCBkaXJlY3RvcnkgaGFzIHRoZSBhY3R1YWwgYXBwIGluIGl0LiBJZiB3ZSBhcmUganVzdCBzY3J1YmJpbmcsXG4gICAgICAvLyB3ZSB3YW50IHRoaXMgdG8gc3RheS4gSWYgd2UgYXJlIGNsZWFuaW5nIHdlIGRlbGV0ZVxuICAgICAgbGV0IGJ1bmRsZSA9ICFzY3J1YiA/IGF3YWl0IHRoaXMuZ2V0QXBwRGlyKGFwcEJ1bmRsZUlkLCAnQnVuZGxlJykgOiB1bmRlZmluZWQ7XG5cbiAgICAgIGZvciAobGV0IHNyYyBvZiBbZGF0YSwgYnVuZGxlXSkge1xuICAgICAgICBpZiAoc3JjKSB7XG4gICAgICAgICAgZGlycy5wdXNoKHNyYyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGRhdGEgPSBhd2FpdCB0aGlzLmdldEFwcERpcihhcHBGaWxlKTtcbiAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgIGRpcnMucHVzaChkYXRhKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGRpcnM7XG4gIH1cblxuICBhc3luYyBsYXVuY2hBbmRRdWl0IChzYWZhcmkgPSBmYWxzZSwgc3RhcnR1cFRpbWVvdXQgPSB0aGlzLnN0YXJ0dXBUaW1lb3V0KSB7XG4gICAgbG9nLmRlYnVnKCdBdHRlbXB0aW5nIHRvIGxhdW5jaCBhbmQgcXVpdCB0aGUgc2ltdWxhdG9yLCB0byBjcmVhdGUgZGlyZWN0b3J5IHN0cnVjdHVyZScpO1xuICAgIGxvZy5kZWJ1ZyhgV2lsbCBsYXVuY2ggd2l0aCBTYWZhcmk/ICR7c2FmYXJpfWApO1xuXG4gICAgYXdhaXQgdGhpcy5ydW4oc3RhcnR1cFRpbWVvdXQpO1xuXG4gICAgaWYgKHNhZmFyaSkge1xuICAgICAgYXdhaXQgdGhpcy5vcGVuVXJsKCdodHRwOi8vd3d3LmFwcGl1bS5pbycpO1xuICAgIH1cblxuICAgIC8vIHdhaXQgZm9yIHRoZSBzeXN0ZW0gdG8gY3JlYXRlIHRoZSBmaWxlcyB3ZSB3aWxsIG1hbmlwdWxhdGVcbiAgICAvLyBuZWVkIHF1aXRlIGEgaGlnaCByZXRyeSBudW1iZXIsIGluIG9yZGVyIHRvIGFjY29tbW9kYXRlIGlPUyA3LjFcbiAgICAvLyBsb2NhbGx5LCA3LjEgYXZlcmFnZXMgOC41IHJldHJpZXMgKGZyb20gNiAtIDEyKVxuICAgIC8vICAgICAgICAgIDggYXZlcmFnZXMgMC42IHJldHJpZXMgKGZyb20gMCAtIDIpXG4gICAgLy8gICAgICAgICAgOSBhdmVyYWdlcyAxNCByZXRyaWVzXG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgyMCwgMjUwLCBhc3luYyAoKSA9PiB7XG4gICAgICBpZiAoYXdhaXQgdGhpcy5pc0ZyZXNoKCkpIHtcbiAgICAgICAgbGV0IG1zZyA9ICdTaW11bGF0b3IgZmlsZXMgbm90IGZ1bGx5IGNyZWF0ZWQuIFdhaXRpbmcgYSBiaXQnO1xuICAgICAgICBsb2cuZGVidWcobXNnKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBhbmQgcXVpdFxuICAgIGF3YWl0IHRoaXMuc2h1dGRvd24oKTtcbiAgfVxuXG4gIGFzeW5jIGVuZFNpbXVsYXRvckRhZW1vbiAoKSB7XG4gICAgLy8gTG9va3MgZm9yIGxhdW5jaGQgZGFlbW9ucyBjb3JyZXNwb25kaW5nIHRvIHRoZSBzaW0gdWRpZCBhbmQgdHJpZXMgdG8gc3RvcCB0aGVtIGNsZWFubHlcbiAgICAvLyBUaGlzIHByZXZlbnRzIHhjcnVuIHNpbWN0bCBlcmFzZSBoYW5ncy5cbiAgICBsb2cuZGVidWcoYEtpbGxpbmcgYW55IHNpbXVsYXRvciBkYWVtb25zIGZvciAke3RoaXMudWRpZH1gKTtcblxuICAgIGxldCBsYXVuY2hjdGxDbWQgPSBgbGF1bmNoY3RsIGxpc3QgfCBncmVwICR7dGhpcy51ZGlkfSB8IGN1dCAtZiAzIHwgeGFyZ3MgLW4gMSBsYXVuY2hjdGxgO1xuICAgIHRyeSB7XG4gICAgICBsZXQgc3RvcENtZCA9IGAke2xhdW5jaGN0bENtZH0gc3RvcGA7XG4gICAgICBhd2FpdCBleGVjKCdiYXNoJywgWyctYycsIHN0b3BDbWRdKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBDb3VsZCBub3Qgc3RvcCBzaW11bGF0b3IgZGFlbW9uczogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIGxvZy5kZWJ1ZygnQ2Fycnlpbmcgb24gYW55d2F5IScpO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgbGV0IHJlbW92ZUNtZCA9IGAke2xhdW5jaGN0bENtZH0gcmVtb3ZlYDtcbiAgICAgIGF3YWl0IGV4ZWMoJ2Jhc2gnLCBbJy1jJywgcmVtb3ZlQ21kXSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgQ291bGQgbm90IHJlbW92ZSBzaW11bGF0b3IgZGFlbW9uczogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIGxvZy5kZWJ1ZygnQ2Fycnlpbmcgb24gYW55d2F5IScpO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgLy8gV2FpdHMgMTAgc2VjIGZvciB0aGUgc2ltdWxhdG9yIGxhdW5jaGQgc2VydmljZXMgdG8gc3RvcC5cbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKCdiYXNoJywgWyctYycsXG4gICAgICAgICAgYHBzIC1lICB8IGdyZXAgJHt0aGlzLnVkaWR9IHwgZ3JlcCBsYXVuY2hkX3NpbSB8IGdyZXAgLXYgYmFzaCB8IGdyZXAgLXYgZ3JlcCB8IGF3ayB7J3ByaW50JDEnfWBdKTtcbiAgICAgICAgcmV0dXJuIHN0ZG91dC50cmltKCkubGVuZ3RoID09PSAwO1xuICAgICAgfSwge3dhaXRNczogMTAwMDAsIGludGVydmFsTXM6IDUwMH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYENvdWxkIG5vdCBlbmQgc2ltdWxhdG9yIGRhZW1vbiBmb3IgJHt0aGlzLnVkaWR9OiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgbG9nLmRlYnVnKCdDYXJyeWluZyBvbiBhbnl3YXkhJyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2h1dGRvd24gKCkge1xuICAgIGF3YWl0IGtpbGxBbGxTaW11bGF0b3JzKCk7XG4gIH1cblxuICBhc3luYyBkZWxldGUgKCkge1xuICAgIGF3YWl0IHNpbWN0bC5kZWxldGVEZXZpY2UodGhpcy51ZGlkKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVNldHRpbmdzIChwbGlzdCwgdXBkYXRlcykge1xuICAgIHJldHVybiBhd2FpdCBzZXR0aW5ncy51cGRhdGVTZXR0aW5ncyh0aGlzLCBwbGlzdCwgdXBkYXRlcyk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVMb2NhdGlvblNldHRpbmdzIChidW5kbGVJZCwgYXV0aG9yaXplZCkge1xuICAgIHJldHVybiBhd2FpdCBzZXR0aW5ncy51cGRhdGVMb2NhdGlvblNldHRpbmdzKHRoaXMsIGJ1bmRsZUlkLCBhdXRob3JpemVkKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVNhZmFyaVNldHRpbmdzICh1cGRhdGVzKSB7XG4gICAgYXdhaXQgc2V0dGluZ3MudXBkYXRlU2FmYXJpVXNlclNldHRpbmdzKHRoaXMsIHVwZGF0ZXMpO1xuICAgIGF3YWl0IHNldHRpbmdzLnVwZGF0ZVNldHRpbmdzKHRoaXMsICdtb2JpbGVTYWZhcmknLCB1cGRhdGVzKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZUxvY2FsZSAobGFuZ3VhZ2UsIGxvY2FsZSwgY2FsZW5kYXJGb3JtYXQpIHtcbiAgICByZXR1cm4gYXdhaXQgc2V0dGluZ3MudXBkYXRlTG9jYWxlKHRoaXMsIGxhbmd1YWdlLCBsb2NhbGUsIGNhbGVuZGFyRm9ybWF0KTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNhZmFyaSAoKSB7XG4gICAgbG9nLmRlYnVnKCdEZWxldGluZyBTYWZhcmkgYXBwcyBmcm9tIHNpbXVsYXRvcicpO1xuXG4gICAgbGV0IGRpcnMgPSBbXTtcblxuICAgIC8vIGdldCB0aGUgZGF0YSBkaXJlY3RvcnlcbiAgICBkaXJzLnB1c2goYXdhaXQgdGhpcy5nZXRBcHBEaXIoJ2NvbS5hcHBsZS5tb2JpbGVzYWZhcmknKSk7XG5cbiAgICBsZXQgcHYgPSBhd2FpdCB0aGlzLmdldFBsYXRmb3JtVmVyc2lvbigpO1xuICAgIGlmIChwdiA+PSA4KSB7XG4gICAgICAvLyBnZXQgdGhlIGJ1bmRsZSBkaXJlY3RvcnlcbiAgICAgIGRpcnMucHVzaChhd2FpdCB0aGlzLmdldEFwcERpcignY29tLmFwcGxlLm1vYmlsZXNhZmFyaScsICdCdW5kbGUnKSk7XG4gICAgfVxuXG4gICAgbGV0IGRlbGV0ZVByb21pc2VzID0gW107XG4gICAgZm9yIChsZXQgZGlyIG9mIF8uY29tcGFjdChkaXJzKSkge1xuICAgICAgbG9nLmRlYnVnKGBEZWxldGluZyBkaXJlY3Rvcnk6ICcke2Rpcn0nYCk7XG4gICAgICBkZWxldGVQcm9taXNlcy5wdXNoKGZzLnJpbXJhZihkaXIpKTtcbiAgICB9XG4gICAgYXdhaXQgQi5hbGwoZGVsZXRlUHJvbWlzZXMpO1xuICB9XG5cbiAgYXN5bmMgY2xlYW5TYWZhcmkgKGtlZXBQcmVmcyA9IHRydWUpIHtcbiAgICBsb2cuZGVidWcoJ0NsZWFuaW5nIG1vYmlsZSBzYWZhcmkgZGF0YSBmaWxlcycpO1xuICAgIGlmIChhd2FpdCB0aGlzLmlzRnJlc2goKSkge1xuICAgICAgbG9nLmluZm8oJ0NvdWxkIG5vdCBmaW5kIFNhZmFyaSBzdXBwb3J0IGRpcmVjdG9yaWVzIHRvIGNsZWFuIG91dCBvbGQgJyArXG4gICAgICAgICAgICAgICAnZGF0YS4gUHJvYmFibHkgdGhlcmUgaXMgbm90aGluZyB0byBjbGVhbiBvdXQnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgbGlicmFyeURpciA9IHBhdGgucmVzb2x2ZSh0aGlzLmdldERpcigpLCAnTGlicmFyeScpO1xuICAgIGxldCBzYWZhcmlSb290ID0gYXdhaXQgdGhpcy5nZXRBcHBEaXIoJ2NvbS5hcHBsZS5tb2JpbGVzYWZhcmknKTtcbiAgICBpZiAoIXNhZmFyaVJvb3QpIHtcbiAgICAgIGxvZy5pbmZvKCdDb3VsZCBub3QgZmluZCBTYWZhcmkgc3VwcG9ydCBkaXJlY3RvcmllcyB0byBjbGVhbiBvdXQgb2xkICcgK1xuICAgICAgICAgICAgICAgJ2RhdGEuIFByb2JhYmx5IHRoZXJlIGlzIG5vdGhpbmcgdG8gY2xlYW4gb3V0Jyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCBzYWZhcmlMaWJyYXJ5RGlyID0gcGF0aC5yZXNvbHZlKHNhZmFyaVJvb3QsICdMaWJyYXJ5Jyk7XG4gICAgbGV0IGZpbGVzVG9EZWxldGUgPSBbXG4gICAgICAnQ2FjaGVzL1NuYXBzaG90cy9jb20uYXBwbGUubW9iaWxlc2FmYXJpJyxcbiAgICAgICdDYWNoZXMvY29tLmFwcGxlLm1vYmlsZXNhZmFyaS8qJyxcbiAgICAgICdDYWNoZXMvY29tLmFwcGxlLldlYkFwcENhY2hlLyonLFxuICAgICAgJ0NhY2hlcy9jb20uYXBwbGUuV2ViS2l0Lk5ldHdvcmtpbmcvKicsXG4gICAgICAnQ2FjaGVzL2NvbS5hcHBsZS5XZWJLaXQuV2ViQ29udGVudC8qJyxcbiAgICAgICdJbWFnZSBDYWNoZS8qJyxcbiAgICAgICdXZWJLaXQvY29tLmFwcGxlLm1vYmlsZXNhZmFyaS8qJyxcbiAgICAgICdXZWJLaXQvR2VvbG9jYXRpb25TaXRlcy5wbGlzdCcsXG4gICAgICAnV2ViS2l0L0xvY2FsU3RvcmFnZS8qLionLFxuICAgICAgJ1NhZmFyaS8qJyxcbiAgICAgICdDb29raWVzLyouYmluYXJ5Y29va2llcycsXG4gICAgICAnQ2FjaGVzL2NvbS5hcHBsZS5VSVN0YXR1c0Jhci8qJyxcbiAgICAgICdDYWNoZXMvY29tLmFwcGxlLmtleWJvYXJkcy9pbWFnZXMvKicsXG4gICAgICAnQ2FjaGVzL2NvbS5hcHBsZS5TYWZhcmkuU2FmZUJyb3dzaW5nLyonLFxuICAgICAgJy4uL3RtcC9jb20uYXBwbGUubW9iaWxlc2FmYXJpLyonXG4gICAgXTtcbiAgICBsZXQgZGVsZXRlUHJvbWlzZXMgPSBbXTtcblxuICAgIGZvciAobGV0IGZpbGUgb2YgZmlsZXNUb0RlbGV0ZSkge1xuICAgICAgZGVsZXRlUHJvbWlzZXMucHVzaChmcy5yaW1yYWYocGF0aC5yZXNvbHZlKGxpYnJhcnlEaXIsIGZpbGUpKSk7XG4gICAgICBkZWxldGVQcm9taXNlcy5wdXNoKGZzLnJpbXJhZihwYXRoLnJlc29sdmUoc2FmYXJpTGlicmFyeURpciwgZmlsZSkpKTtcbiAgICB9XG5cbiAgICBpZiAoIWtlZXBQcmVmcykge1xuICAgICAgZGVsZXRlUHJvbWlzZXMucHVzaChmcy5yaW1yYWYocGF0aC5yZXNvbHZlKHNhZmFyaUxpYnJhcnlEaXIsICdQcmVmZXJlbmNlcy8qLnBsaXN0JykpKTtcbiAgICB9XG5cbiAgICBhd2FpdCBCLmFsbChkZWxldGVQcm9taXNlcyk7XG4gIH1cblxuICBhc3luYyByZW1vdmVBcHAgKGJ1bmRsZUlkKSB7XG4gICAgYXdhaXQgc2ltY3RsLnJlbW92ZUFwcCh0aGlzLnVkaWQsIGJ1bmRsZUlkKTtcbiAgfVxuXG4gIGFzeW5jIG1vdmVCdWlsdEluQXBwIChhcHBOYW1lLCBhcHBQYXRoLCBuZXdBcHBQYXRoKSB7XG4gICAgYXdhaXQgc2FmZVJpbVJhZihuZXdBcHBQYXRoKTtcbiAgICBhd2FpdCBmcy5jb3B5RmlsZShhcHBQYXRoLCBuZXdBcHBQYXRoKTtcbiAgICBsb2cuZGVidWcoYENvcGllZCAnJHthcHBOYW1lfScgdG8gJyR7bmV3QXBwUGF0aH0nYCk7XG5cbiAgICBhd2FpdCBmcy5yaW1yYWYoYXBwUGF0aCk7XG4gICAgbG9nLmRlYnVnKGBUZW1wb3JhcmlseSBkZWxldGVkIG9yaWdpbmFsIGFwcCBhdCAnJHthcHBQYXRofSdgKTtcblxuICAgIHJldHVybiBbbmV3QXBwUGF0aCwgYXBwUGF0aF07XG4gIH1cblxuICBhc3luYyBvcGVuVXJsICh1cmwpIHtcbiAgICBjb25zdCBTQUZBUklfQk9PVEVEX0lORElDQVRPUiA9ICdNb2JpbGVTYWZhcmlbJztcbiAgICBjb25zdCBTQUZBUklfU1RBUlRVUF9USU1FT1VUID0gMTUgKiAxMDAwO1xuICAgIGNvbnN0IEVYVFJBX1NUQVJUVVBfVElNRSA9IDMgKiAxMDAwO1xuXG4gICAgaWYgKGF3YWl0IHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIGF3YWl0IHJldHJ5KDUwMDAsIHNpbWN0bC5vcGVuVXJsLCB0aGlzLnVkaWQsIHVybCk7XG4gICAgICBhd2FpdCB0aGlzLnRhaWxMb2dzVW50aWwoU0FGQVJJX0JPT1RFRF9JTkRJQ0FUT1IsIFNBRkFSSV9TVEFSVFVQX1RJTUVPVVQpO1xuICAgICAgLy8gU28gc29ycnksIGJ1dCB0aGUgbG9ncyBoYXZlIG5vdGhpbmcgZWxzZSBmb3IgU2FmYXJpIHN0YXJ0aW5nLi4ganVzdCBkZWxheSBhIGxpdHRsZSBiaXRcbiAgICAgIGxvZy5kZWJ1ZyhgU2FmYXJpIHN0YXJ0ZWQsIHdhaXRpbmcgJHtFWFRSQV9TVEFSVFVQX1RJTUV9bXMgZm9yIGl0IHRvIGZ1bGx5IHN0YXJ0YCk7XG4gICAgICBhd2FpdCBCLmRlbGF5KEVYVFJBX1NUQVJUVVBfVElNRSk7XG4gICAgICBsb2cuZGVidWcoJ0RvbmUgd2FpdGluZyBmb3IgU2FmYXJpJyk7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVHJpZWQgdG8gb3BlbiBhIHVybCwgYnV0IHRoZSBTaW11bGF0b3IgaXMgbm90IEJvb3RlZCcpO1xuICAgIH1cbiAgfVxuXG4gIC8vIHJldHVybnMgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2hlbiB0aGUgaW9zIHNpbXVsYXRvciBsb2dzIG91dHB1dCBhIGxpbmUgbWF0Y2hpbmcgYGJvb3RlZEluZGljYXRvcmBcbiAgLy8gdGltZXMgb3V0IGFmdGVyIHRpbWVvdXRNc1xuICBhc3luYyB0YWlsTG9nc1VudGlsIChib290ZWRJbmRpY2F0b3IsIHRpbWVvdXRNcykge1xuICAgIGxldCBzaW1Mb2cgPSBwYXRoLnJlc29sdmUodGhpcy5nZXRMb2dEaXIoKSwgJ3N5c3RlbS5sb2cnKTtcblxuICAgIC8vIHdlIG5lZWQgdG8gbWFrZSBzdXJlIGxvZyBmaWxlIGV4aXN0cyBiZWZvcmUgd2UgY2FuIHRhaWwgaXRcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDIwMCwgMjAwLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgZXhpc3RzID0gYXdhaXQgZnMuZXhpc3RzKHNpbUxvZyk7XG4gICAgICBpZiAoIWV4aXN0cykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIFNpbXVsYXRvciBsb2c6ICcke3NpbUxvZ30nYCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBsb2cuaW5mbyhgU2ltdWxhdG9yIGxvZyBhdCAnJHtzaW1Mb2d9J2ApO1xuICAgIGxvZy5pbmZvKGBUYWlsaW5nIHNpbXVsYXRvciBsb2dzIHVudGlsIHdlIGVuY291bnRlciB0aGUgc3RyaW5nIFwiJHtib290ZWRJbmRpY2F0b3J9XCJgKTtcbiAgICBsb2cuaW5mbyhgV2Ugd2lsbCB0aW1lIG91dCBhZnRlciAke3RpbWVvdXRNc31tc2ApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0YWlsVW50aWwoc2ltTG9nLCBib290ZWRJbmRpY2F0b3IsIHRpbWVvdXRNcyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZGVidWcoJ1NpbXVsYXRvciBzdGFydHVwIHRpbWVkIG91dC4gQ29udGludWluZyBhbnl3YXkuJyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZW5hYmxlQ2FsZW5kYXJBY2Nlc3MgKGJ1bmRsZUlEKSB7XG4gICAgYXdhaXQgdGhpcy5jYWxlbmRhci5lbmFibGVDYWxlbmRhckFjY2VzcyhidW5kbGVJRCk7XG4gIH1cblxuICBhc3luYyBkaXNhYmxlQ2FsZW5kYXJBY2Nlc3MgKGJ1bmRsZUlEKSB7XG4gICAgYXdhaXQgdGhpcy5jYWxlbmRhci5kaXNhYmxlQ2FsZW5kYXJBY2Nlc3MoYnVuZGxlSUQpO1xuICB9XG5cbiAgYXN5bmMgaGFzQ2FsZW5kYXJBY2Nlc3MgKGJ1bmRsZUlEKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuY2FsZW5kYXIuaGFzQ2FsZW5kYXJBY2Nlc3MoYnVuZGxlSUQpO1xuICB9XG5cbiAgYXN5bmMgZW5yb2xsVG91Y2hJRCAoKSB7XG4gICAgYXdhaXQgZXhlYygnb3Nhc2NyaXB0JywgWyctZScsIGBcbiAgICAgIGFjdGl2YXRlIGFwcGxpY2F0aW9uIFwiU2ltdWxhdG9yXCJcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAga2V5IGNvZGUgMTcgdXNpbmcge2NvbnRyb2wgZG93biwgc2hpZnQgZG93biwgb3B0aW9uIGRvd24sIGNvbW1hbmQgZG93bn1cbiAgICAgIGVuZCB0ZWxsXG4gICAgYF0pO1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIF9nZXREZXZpY2VTdHJpbmdQbGF0Zm9ybVZlcnNpb24gKHBsYXRmb3JtVmVyc2lvbikge1xuICAgIGxldCByZXFWZXJzaW9uID0gcGxhdGZvcm1WZXJzaW9uO1xuICAgIGlmICghcmVxVmVyc2lvbikge1xuICAgICAgcmVxVmVyc2lvbiA9IGF3YWl0IHhjb2RlLmdldE1heElPU1NESygpO1xuICAgICAgbG9nLndhcm4oYE5vIHBsYXRmb3JtIHZlcnNpb24gc2V0LiBVc2luZyBtYXggU0RLIHZlcnNpb246ICR7cmVxVmVyc2lvbn1gKTtcbiAgICAgIC8vIHRoaXMgd2lsbCBiZSBhIG51bWJlciwgYW5kIHBvc3NpYmx5IGFuIGludGVnZXIgKGUuZy4sIGlmIG1heCBpT1MgU0RLIGlzIDkpXG4gICAgICAvLyBzbyB0dXJuIGl0IGludG8gYSBzdHJpbmcgYW5kIGFkZCBhIC4wIGlmIG5lY2Vzc2FyeVxuICAgICAgaWYgKCFfLmlzU3RyaW5nKHJlcVZlcnNpb24pKSB7XG4gICAgICAgIHJlcVZlcnNpb24gPSAocmVxVmVyc2lvbiAlIDEpID8gU3RyaW5nKHJlcVZlcnNpb24pIDogYCR7cmVxVmVyc2lvbn0uMGA7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXFWZXJzaW9uO1xuICB9XG5cbiAgLy8gY2hhbmdlIHRoZSBmb3JtYXQgaW4gc3ViY2xhc3NlcywgYXMgbmVjZXNzYXJ5XG4gIHN0YXRpYyBhc3luYyBfZ2V0RGV2aWNlU3RyaW5nVmVyc2lvblN0cmluZyAocGxhdGZvcm1WZXJzaW9uKSB7XG4gICAgbGV0IHJlcVZlcnNpb24gPSBhd2FpdCB0aGlzLl9nZXREZXZpY2VTdHJpbmdQbGF0Zm9ybVZlcnNpb24ocGxhdGZvcm1WZXJzaW9uKTtcblxuICAgIHJldHVybiBgKCR7cmVxVmVyc2lvbn0gU2ltdWxhdG9yKWA7XG4gIH1cblxuICAvLyBjaGFuZ2UgdGhlIGZvcm1hdCBpbiBzdWJjbGFzc2VzLCBhcyBuZWNlc3NhcnlcbiAgc3RhdGljIF9nZXREZXZpY2VTdHJpbmdDb25maWdGaXggKCkge1xuICAgIC8vIHNvbWUgZGV2aWNlcyBuZWVkIHRvIGJlIHVwZGF0ZWRcbiAgICByZXR1cm4ge1xuICAgICAgJ2lQYWQgU2ltdWxhdG9yICg3LjEgU2ltdWxhdG9yKSc6ICdpUGFkIDIgKDcuMSBTaW11bGF0b3IpJyxcbiAgICAgICdpUGFkIFNpbXVsYXRvciAoOC4wIFNpbXVsYXRvciknOiAnaVBhZCAyICg4LjAgU2ltdWxhdG9yKScsXG4gICAgICAnaVBhZCBTaW11bGF0b3IgKDguMSBTaW11bGF0b3IpJzogJ2lQYWQgMiAoOC4xIFNpbXVsYXRvciknLFxuICAgICAgJ2lQYWQgU2ltdWxhdG9yICg4LjIgU2ltdWxhdG9yKSc6ICdpUGFkIDIgKDguMiBTaW11bGF0b3IpJyxcbiAgICAgICdpUGFkIFNpbXVsYXRvciAoOC4zIFNpbXVsYXRvciknOiAnaVBhZCAyICg4LjMgU2ltdWxhdG9yKScsXG4gICAgICAnaVBhZCBTaW11bGF0b3IgKDguNCBTaW11bGF0b3IpJzogJ2lQYWQgMiAoOC40IFNpbXVsYXRvciknLFxuICAgICAgJ2lQaG9uZSBTaW11bGF0b3IgKDcuMSBTaW11bGF0b3IpJzogJ2lQaG9uZSA1cyAoNy4xIFNpbXVsYXRvciknLFxuICAgICAgJ2lQaG9uZSBTaW11bGF0b3IgKDguNCBTaW11bGF0b3IpJzogJ2lQaG9uZSA2ICg4LjQgU2ltdWxhdG9yKScsXG4gICAgICAnaVBob25lIFNpbXVsYXRvciAoOC4zIFNpbXVsYXRvciknOiAnaVBob25lIDYgKDguMyBTaW11bGF0b3IpJyxcbiAgICAgICdpUGhvbmUgU2ltdWxhdG9yICg4LjIgU2ltdWxhdG9yKSc6ICdpUGhvbmUgNiAoOC4yIFNpbXVsYXRvciknLFxuICAgICAgJ2lQaG9uZSBTaW11bGF0b3IgKDguMSBTaW11bGF0b3IpJzogJ2lQaG9uZSA2ICg4LjEgU2ltdWxhdG9yKScsXG4gICAgICAnaVBob25lIFNpbXVsYXRvciAoOC4wIFNpbXVsYXRvciknOiAnaVBob25lIDYgKDguMCBTaW11bGF0b3IpJ1xuICAgIH07XG4gIH1cblxuICBzdGF0aWMgYXN5bmMgZ2V0RGV2aWNlU3RyaW5nIChvcHRzKSB7XG4gICAgb3B0cyA9IE9iamVjdC5hc3NpZ24oe30sIHtcbiAgICAgIGRldmljZU5hbWU6IG51bGwsXG4gICAgICBwbGF0Zm9ybVZlcnNpb246IG51bGwsXG4gICAgICBmb3JjZUlwaG9uZTogZmFsc2UsXG4gICAgICBmb3JjZUlwYWQ6IGZhbHNlXG4gICAgfSwgb3B0cyk7XG4gICAgbGV0IGxvZ09wdHMgPSB7XG4gICAgICBkZXZpY2VOYW1lOiBvcHRzLmRldmljZU5hbWUsXG4gICAgICBwbGF0Zm9ybVZlcnNpb246IG9wdHMucGxhdGZvcm1WZXJzaW9uLFxuICAgICAgZm9yY2VJcGhvbmU6IG9wdHMuZm9yY2VJcGhvbmUsXG4gICAgICBmb3JjZUlwYWQ6IG9wdHMuZm9yY2VJcGFkXG4gICAgfTtcbiAgICBsb2cuZGVidWcoYEdldHRpbmcgZGV2aWNlIHN0cmluZyBmcm9tIG9wdGlvbnM6ICR7SlNPTi5zdHJpbmdpZnkobG9nT3B0cyl9YCk7XG5cbiAgICAvLyBzaG9ydCBjaXJjdWl0IGlmIHdlIGFscmVhZHkgaGF2ZSBhIGRldmljZSBuYW1lXG4gICAgaWYgKChvcHRzLmRldmljZU5hbWUgfHwgJycpWzBdID09PSAnPScpIHtcbiAgICAgIHJldHVybiBvcHRzLmRldmljZU5hbWUuc3Vic3RyaW5nKDEpO1xuICAgIH1cblxuICAgIGxldCBpc2lQaG9uZSA9ICEhb3B0cy5mb3JjZUlwaG9uZSB8fCAhb3B0cy5mb3JjZUlwYWQ7XG5cbiAgICBpZiAob3B0cy5kZXZpY2VOYW1lKSB7XG4gICAgICBsZXQgZGV2aWNlID0gb3B0cy5kZXZpY2VOYW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgICBpZiAoZGV2aWNlLmluZGV4T2YoJ2lwaG9uZScpICE9PSAtMSkge1xuICAgICAgICBpc2lQaG9uZSA9IHRydWU7XG4gICAgICB9IGVsc2UgaWYgKGRldmljZS5pbmRleE9mKCdpcGFkJykgIT09IC0xKSB7XG4gICAgICAgIGlzaVBob25lID0gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGlvc0RldmljZVN0cmluZyA9IG9wdHMuZGV2aWNlTmFtZSB8fCAoaXNpUGhvbmUgPyAnaVBob25lIFNpbXVsYXRvcicgOiAnaVBhZCBTaW11bGF0b3InKTtcblxuICAgIC8vIGlmIHNvbWVvbmUgcGFzc2VzIGluIGp1c3QgXCJpUGhvbmVcIiwgbWFrZSB0aGF0IFwiaVBob25lIFNpbXVsYXRvclwiIHRvXG4gICAgLy8gY29uZm9ybSB0byBhbGwgdGhlIGxvZ2ljIGJlbG93XG4gICAgaWYgKC9eKGlQaG9uZXxpUGFkKSQvLnRlc3QoaW9zRGV2aWNlU3RyaW5nKSkge1xuICAgICAgaW9zRGV2aWNlU3RyaW5nICs9IFwiIFNpbXVsYXRvclwiO1xuICAgIH1cblxuICAgIC8vIHdlIHN1cHBvcnQgZGV2aWNlTmFtZTogXCJpUGhvbmUgU2ltdWxhdG9yXCIsIGFuZCBhbHNvIHdhbnQgdG8gc3VwcG9ydFxuICAgIC8vIFwiaVBob25lIFhZWiBTaW11bGF0b3JcIiwgYnV0IHRoZXNlIHN0cmluZ3MgYXJlbid0IGluIHRoZSBkZXZpY2UgbGlzdC5cbiAgICAvLyBTbywgaWYgc29tZW9uZSBzZW50IGluIFwiaVBob25lIFhZWiBTaW11bGF0b3JcIiwgc3RyaXAgb2ZmIFwiIFNpbXVsYXRvclwiXG4gICAgLy8gaW4gb3JkZXIgdG8gYWxsb3cgdGhlIGRlZmF1bHQgXCJpUGhvbmUgWFlaXCIgbWF0Y2hcbiAgICBpZiAoL1teKGlQaG9uZXxpUGFkKV0gU2ltdWxhdG9yLy50ZXN0KGlvc0RldmljZVN0cmluZykpIHtcbiAgICAgIGlvc0RldmljZVN0cmluZyA9IGlvc0RldmljZVN0cmluZy5yZXBsYWNlKFwiIFNpbXVsYXRvclwiLCBcIlwiKTtcbiAgICB9XG4gICAgaW9zRGV2aWNlU3RyaW5nICs9IGAgJHthd2FpdCB0aGlzLl9nZXREZXZpY2VTdHJpbmdWZXJzaW9uU3RyaW5nKG9wdHMucGxhdGZvcm1WZXJzaW9uKX1gO1xuXG4gICAgbGV0IENPTkZJR19GSVggPSB0aGlzLl9nZXREZXZpY2VTdHJpbmdDb25maWdGaXgoKTtcblxuICAgIGxldCBjb25maWdGaXggPSBDT05GSUdfRklYO1xuICAgIGlmIChjb25maWdGaXhbaW9zRGV2aWNlU3RyaW5nXSkge1xuICAgICAgaW9zRGV2aWNlU3RyaW5nID0gY29uZmlnRml4W2lvc0RldmljZVN0cmluZ107XG4gICAgICBsb2cuZGVidWcoYEZpeGluZyBkZXZpY2UuIENoYW5nZWQgZnJvbSAnJHtvcHRzLmRldmljZU5hbWV9JyBgK1xuICAgICAgICAgICAgICAgICAgIGB0byAnJHtpb3NEZXZpY2VTdHJpbmd9J2ApO1xuICAgIH1cblxuICAgIGxvZy5kZWJ1ZyhgRmluYWwgZGV2aWNlIHN0cmluZyBpcyAnJHtpb3NEZXZpY2VTdHJpbmd9J2ApO1xuICAgIHJldHVybiBpb3NEZXZpY2VTdHJpbmc7XG4gIH1cbn1cblxuZm9yIChsZXQgW2NtZCwgZm5dIG9mIF8udG9QYWlycyhleHRlbnNpb25zKSkge1xuICBTaW11bGF0b3JYY29kZTYucHJvdG90eXBlW2NtZF0gPSBmbjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgU2ltdWxhdG9yWGNvZGU2O1xuZXhwb3J0IHsgU2ltdWxhdG9yWGNvZGU2LCBCT09UX0NPTVBMRVRFRF9FVkVOVCB9O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
