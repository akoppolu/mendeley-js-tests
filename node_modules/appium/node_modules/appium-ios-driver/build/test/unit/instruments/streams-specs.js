require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _libInstrumentsStreams = require('../../../lib/instruments/streams');

var _stream = require('stream');

var _stream2 = _interopRequireDefault(_stream);

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('streams', function () {
  function runThroughStream(stream, text) {
    return _regeneratorRuntime.async(function runThroughStream$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve) {
            stream.on('data', function (data) {
              resolve(data);
            });
            stream.write(text);
          }));

        case 1:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  }

  describe('outputStream', function () {
    var stream = undefined;
    beforeEach(function () {
      stream = (0, _libInstrumentsStreams.outputStream)();
    });
    it('should return a stream', function () {
      stream.should.be.an['instanceof'](_stream2['default']);
    });
    it('should append [INST] to the output', function callee$2$0() {
      var text, output;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            text = 'Some output';
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(runThroughStream(stream, text));

          case 3:
            output = context$3$0.sent;

            output.should.include('[INST] Some output');

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should remove beginning * from output', function callee$2$0() {
      var text, output;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            text = '***Some output***';
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(runThroughStream(stream, text));

          case 3:
            output = context$3$0.sent;

            output.should.include('Some output***');

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should remove final newlines', function callee$2$0() {
      var text, output;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            text = 'Some output\n';
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(runThroughStream(stream, text));

          case 3:
            output = context$3$0.sent;

            output.should.not.include('\n');

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should indent internal newlines', function callee$2$0() {
      var text, output;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            text = 'Some output\non multiple lines';
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(runThroughStream(stream, text));

          case 3:
            output = context$3$0.sent;

            output.should.include('Some output\n       on multiple lines');

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });
  describe('errorStream', function () {
    var stream = undefined;
    beforeEach(function () {
      stream = (0, _libInstrumentsStreams.errorStream)();
    });
    it('should return a stream', function () {
      stream.should.be.an['instanceof'](_stream2['default']);
    });
    it('should append [INST STDERR] to the output', function callee$2$0() {
      var text, output;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            text = 'Some output';
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(runThroughStream(stream, text));

          case 3:
            output = context$3$0.sent;

            output.should.include('[INST STDERR] Some output');

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should remove beginning * from output', function callee$2$0() {
      var text, output;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            text = '***Some output***';
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(runThroughStream(stream, text));

          case 3:
            output = context$3$0.sent;

            output.should.include('Some output***');

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should remove final newlines', function callee$2$0() {
      var text, output;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            text = 'Some output\n';
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(runThroughStream(stream, text));

          case 3:
            output = context$3$0.sent;

            output.should.not.include('\n');

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });
  describe('webSocketAlertStream', function () {
    var webSocket = {
      sockets: {
        emit: function emit() {}
      }
    };
    var webSocketSpy = _sinon2['default'].spy(webSocket.sockets, 'emit');

    afterEach(function () {
      webSocketSpy.reset();
    });

    it('should return a stream', function () {
      (0, _libInstrumentsStreams.webSocketAlertStream)().should.be.an['instanceof'](_stream2['default']);
    });
    it('should queue data', function callee$2$0() {
      var text, output;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            text = 'Some output';
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(runThroughStream((0, _libInstrumentsStreams.webSocketAlertStream)(), text));

          case 3:
            output = context$3$0.sent;

            output.should.equal(text);

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should send data to websocket when appropriate', function callee$2$0() {
      var text;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            text = 'Call to onAlert returned \'YES\'\nSome output';
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(runThroughStream((0, _libInstrumentsStreams.webSocketAlertStream)(webSocket), text));

          case 3:

            webSocketSpy.calledWith('alert', { message: text });

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should not send data to websocket when inappropriate', function callee$2$0() {
      var text;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            text = 'Some output';
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(runThroughStream((0, _libInstrumentsStreams.webSocketAlertStream)(webSocket), text));

          case 3:

            webSocketSpy.called.should.be['false'];

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });
  describe('dumpStream', function () {
    var stream = undefined;
    beforeEach(function () {
      stream = (0, _libInstrumentsStreams.dumpStream)();
    });
    it('should return a stream', function () {
      stream.should.be.an['instanceof'](_stream2['default']);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9pbnN0cnVtZW50cy9zdHJlYW1zLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7cUNBRTRFLGtDQUFrQzs7c0JBQzNGLFFBQVE7Ozs7b0JBQ1YsTUFBTTs7Ozs4QkFDSSxrQkFBa0I7Ozs7d0JBQy9CLFVBQVU7Ozs7cUJBQ04sT0FBTzs7OztBQUd6QixrQkFBSyxNQUFNLEVBQUUsQ0FBQztBQUNkLGtCQUFLLEdBQUcsNkJBQWdCLENBQUM7O0FBRXpCLFFBQVEsQ0FBQyxTQUFTLEVBQUUsWUFBTTtBQUN4QixXQUFlLGdCQUFnQixDQUFFLE1BQU0sRUFBRSxJQUFJOzs7OzhDQUNwQywwQkFBTSxVQUFVLE9BQU8sRUFBRTtBQUM5QixrQkFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBQyxJQUFJLEVBQUs7QUFDMUIscUJBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNmLENBQUMsQ0FBQztBQUNILGtCQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1dBQ3BCLENBQUM7Ozs7Ozs7R0FDSDs7QUFFRCxVQUFRLENBQUMsY0FBYyxFQUFFLFlBQU07QUFDN0IsUUFBSSxNQUFNLFlBQUEsQ0FBQztBQUNYLGNBQVUsQ0FBQyxZQUFNO0FBQ2YsWUFBTSxHQUFHLDBDQUFjLENBQUM7S0FDekIsQ0FBQyxDQUFDO0FBQ0gsTUFBRSxDQUFDLHdCQUF3QixFQUFFLFlBQU07QUFDakMsWUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsRUFBRSxjQUFXLHFCQUFRLENBQUM7S0FDeEMsQ0FBQyxDQUFDO0FBQ0gsTUFBRSxDQUFDLG9DQUFvQyxFQUFFO1VBQ25DLElBQUksRUFDSixNQUFNOzs7O0FBRE4sZ0JBQUksR0FBRyxhQUFhOzs2Q0FDTCxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDOzs7QUFBN0Msa0JBQU07O0FBRVYsa0JBQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLG9CQUFvQixD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eEMsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6InRlc3QvdW5pdC9pbnN0cnVtZW50cy9zdHJlYW1zLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlOm1vY2hhXG5cbmltcG9ydCB7IG91dHB1dFN0cmVhbSwgZXJyb3JTdHJlYW0sIHdlYlNvY2tldEFsZXJ0U3RyZWFtLCBkdW1wU3RyZWFtIH0gZnJvbSAnLi4vLi4vLi4vbGliL2luc3RydW1lbnRzL3N0cmVhbXMnO1xuaW1wb3J0IFN0cmVhbSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgc2lub24gZnJvbSAnc2lub24nO1xuXG5cbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmRlc2NyaWJlKCdzdHJlYW1zJywgKCkgPT4ge1xuICBhc3luYyBmdW5jdGlvbiBydW5UaHJvdWdoU3RyZWFtIChzdHJlYW0sIHRleHQpIHtcbiAgICByZXR1cm4gbmV3IEIoZnVuY3Rpb24gKHJlc29sdmUpIHtcbiAgICAgIHN0cmVhbS5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgIHJlc29sdmUoZGF0YSk7XG4gICAgICB9KTtcbiAgICAgIHN0cmVhbS53cml0ZSh0ZXh0KTtcbiAgICB9KTtcbiAgfVxuXG4gIGRlc2NyaWJlKCdvdXRwdXRTdHJlYW0nLCAoKSA9PiB7XG4gICAgbGV0IHN0cmVhbTtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIHN0cmVhbSA9IG91dHB1dFN0cmVhbSgpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGEgc3RyZWFtJywgKCkgPT4ge1xuICAgICAgc3RyZWFtLnNob3VsZC5iZS5hbi5pbnN0YW5jZW9mKFN0cmVhbSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBhcHBlbmQgW0lOU1RdIHRvIHRoZSBvdXRwdXQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgdGV4dCA9ICdTb21lIG91dHB1dCc7XG4gICAgICBsZXQgb3V0cHV0ID0gYXdhaXQgcnVuVGhyb3VnaFN0cmVhbShzdHJlYW0sIHRleHQpO1xuXG4gICAgICBvdXRwdXQuc2hvdWxkLmluY2x1ZGUoJ1tJTlNUXSBTb21lIG91dHB1dCcpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcmVtb3ZlIGJlZ2lubmluZyAqIGZyb20gb3V0cHV0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHRleHQgPSAnKioqU29tZSBvdXRwdXQqKionO1xuICAgICAgbGV0IG91dHB1dCA9IGF3YWl0IHJ1blRocm91Z2hTdHJlYW0oc3RyZWFtLCB0ZXh0KTtcblxuICAgICAgb3V0cHV0LnNob3VsZC5pbmNsdWRlKCdTb21lIG91dHB1dCoqKicpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcmVtb3ZlIGZpbmFsIG5ld2xpbmVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHRleHQgPSAnU29tZSBvdXRwdXRcXG4nO1xuICAgICAgbGV0IG91dHB1dCA9IGF3YWl0IHJ1blRocm91Z2hTdHJlYW0oc3RyZWFtLCB0ZXh0KTtcblxuICAgICAgb3V0cHV0LnNob3VsZC5ub3QuaW5jbHVkZSgnXFxuJyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBpbmRlbnQgaW50ZXJuYWwgbmV3bGluZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgdGV4dCA9ICdTb21lIG91dHB1dFxcbm9uIG11bHRpcGxlIGxpbmVzJztcbiAgICAgIGxldCBvdXRwdXQgPSBhd2FpdCBydW5UaHJvdWdoU3RyZWFtKHN0cmVhbSwgdGV4dCk7XG5cbiAgICAgIG91dHB1dC5zaG91bGQuaW5jbHVkZSgnU29tZSBvdXRwdXRcXG4gICAgICAgb24gbXVsdGlwbGUgbGluZXMnKTtcbiAgICB9KTtcbiAgfSk7XG4gIGRlc2NyaWJlKCdlcnJvclN0cmVhbScsICgpID0+IHtcbiAgICBsZXQgc3RyZWFtO1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgc3RyZWFtID0gZXJyb3JTdHJlYW0oKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBhIHN0cmVhbScsICgpID0+IHtcbiAgICAgIHN0cmVhbS5zaG91bGQuYmUuYW4uaW5zdGFuY2VvZihTdHJlYW0pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgYXBwZW5kIFtJTlNUIFNUREVSUl0gdG8gdGhlIG91dHB1dCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCB0ZXh0ID0gJ1NvbWUgb3V0cHV0JztcbiAgICAgIGxldCBvdXRwdXQgPSBhd2FpdCBydW5UaHJvdWdoU3RyZWFtKHN0cmVhbSwgdGV4dCk7XG5cbiAgICAgIG91dHB1dC5zaG91bGQuaW5jbHVkZSgnW0lOU1QgU1RERVJSXSBTb21lIG91dHB1dCcpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcmVtb3ZlIGJlZ2lubmluZyAqIGZyb20gb3V0cHV0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHRleHQgPSAnKioqU29tZSBvdXRwdXQqKionO1xuICAgICAgbGV0IG91dHB1dCA9IGF3YWl0IHJ1blRocm91Z2hTdHJlYW0oc3RyZWFtLCB0ZXh0KTtcblxuICAgICAgb3V0cHV0LnNob3VsZC5pbmNsdWRlKCdTb21lIG91dHB1dCoqKicpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcmVtb3ZlIGZpbmFsIG5ld2xpbmVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHRleHQgPSAnU29tZSBvdXRwdXRcXG4nO1xuICAgICAgbGV0IG91dHB1dCA9IGF3YWl0IHJ1blRocm91Z2hTdHJlYW0oc3RyZWFtLCB0ZXh0KTtcblxuICAgICAgb3V0cHV0LnNob3VsZC5ub3QuaW5jbHVkZSgnXFxuJyk7XG4gICAgfSk7XG4gIH0pO1xuICBkZXNjcmliZSgnd2ViU29ja2V0QWxlcnRTdHJlYW0nLCAoKSA9PiB7XG4gICAgbGV0IHdlYlNvY2tldCA9IHtcbiAgICAgIHNvY2tldHM6IHtcbiAgICAgICAgZW1pdDogKCkgPT4ge31cbiAgICAgIH1cbiAgICB9O1xuICAgIGxldCB3ZWJTb2NrZXRTcHkgPSBzaW5vbi5zcHkod2ViU29ja2V0LnNvY2tldHMsICdlbWl0Jyk7XG5cbiAgICBhZnRlckVhY2goKCkgPT4ge1xuICAgICAgd2ViU29ja2V0U3B5LnJlc2V0KCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBhIHN0cmVhbScsICgpID0+IHtcbiAgICAgIHdlYlNvY2tldEFsZXJ0U3RyZWFtKCkuc2hvdWxkLmJlLmFuLmluc3RhbmNlb2YoU3RyZWFtKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHF1ZXVlIGRhdGEnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgdGV4dCA9ICdTb21lIG91dHB1dCc7XG4gICAgICBsZXQgb3V0cHV0ID0gYXdhaXQgcnVuVGhyb3VnaFN0cmVhbSh3ZWJTb2NrZXRBbGVydFN0cmVhbSgpLCB0ZXh0KTtcblxuICAgICAgb3V0cHV0LnNob3VsZC5lcXVhbCh0ZXh0KTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHNlbmQgZGF0YSB0byB3ZWJzb2NrZXQgd2hlbiBhcHByb3ByaWF0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCB0ZXh0ID0gJ0NhbGwgdG8gb25BbGVydCByZXR1cm5lZCBcXCdZRVNcXCdcXG5Tb21lIG91dHB1dCc7XG5cbiAgICAgIGF3YWl0IHJ1blRocm91Z2hTdHJlYW0od2ViU29ja2V0QWxlcnRTdHJlYW0od2ViU29ja2V0KSwgdGV4dCk7XG5cbiAgICAgIHdlYlNvY2tldFNweS5jYWxsZWRXaXRoKCdhbGVydCcsIHttZXNzYWdlOiB0ZXh0fSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBub3Qgc2VuZCBkYXRhIHRvIHdlYnNvY2tldCB3aGVuIGluYXBwcm9wcmlhdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgdGV4dCA9ICdTb21lIG91dHB1dCc7XG5cbiAgICAgIGF3YWl0IHJ1blRocm91Z2hTdHJlYW0od2ViU29ja2V0QWxlcnRTdHJlYW0od2ViU29ja2V0KSwgdGV4dCk7XG5cbiAgICAgIHdlYlNvY2tldFNweS5jYWxsZWQuc2hvdWxkLmJlLmZhbHNlO1xuICAgIH0pO1xuICB9KTtcbiAgZGVzY3JpYmUoJ2R1bXBTdHJlYW0nLCAoKSA9PiB7XG4gICAgbGV0IHN0cmVhbTtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIHN0cmVhbSA9IGR1bXBTdHJlYW0oKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBhIHN0cmVhbScsICgpID0+IHtcbiAgICAgIHN0cmVhbS5zaG91bGQuYmUuYW4uaW5zdGFuY2VvZihTdHJlYW0pO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9
