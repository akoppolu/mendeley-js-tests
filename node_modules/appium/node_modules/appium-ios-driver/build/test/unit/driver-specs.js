require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _interopRequireWildcard = require('babel-runtime/helpers/interop-require-wildcard')['default'];

var _this = this;

var _ = require('../..');

var _2 = _interopRequireDefault(_);

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _appiumTestSupport = require('appium-test-support');

var _teen_process = require('teen_process');

var teen_process = _interopRequireWildcard(_teen_process);

var _appiumSupport = require('appium-support');

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('driver', function () {
  it('should instantiate class', function () {
    var driver = new _2['default']();
    driver.should.exist;
  });

  describe('unsupported infrastructure', (0, _appiumTestSupport.withMocks)({ xcode: _appiumXcode2['default'] }, function (mocks) {
    var driver = undefined;
    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            driver = new _2['default']();

          case 1:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should throw an error for Xcode version 8+', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            mocks.xcode.expects('getVersion').once().returns({
              versionString: '8.0.0',
              versionFloat: 8.0,
              major: 8,
              minor: 0,
              patch: 0
            });
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(driver.createSession({
              platformName: 'iOS',
              deviceName: 'iPhone Simulator',
              app: '/path/to/app'
            }).should.eventually.be.rejectedWith(/Appium's IosDriver does not support xcode version 8.0.0/));

          case 3:
            mocks.xcode.verify();

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  }));

  describe('timeouts', function () {
    var driver = undefined;
    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            driver = new _2['default']();
            // await driver.createSession({});

          case 1:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    describe('command', function () {
      it('should exist by default', function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              driver.newCommandTimeoutMs.should.equal(60000);

            case 1:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
      it('should be settable through `timeouts`', function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap(driver.timeouts('command', 20));

            case 2:
              driver.newCommandTimeoutMs.should.equal(20);

            case 3:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
    });
    describe('implicit', function () {
      it('should not exist by default', function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              driver.implicitWaitMs.should.equal(0);

            case 1:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
      it('should be settable through `timeouts`', function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap(driver.timeouts('implicit', 20));

            case 2:
              driver.implicitWaitMs.should.equal(20);

            case 3:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
    });
    describe('page load', function () {
      it('should be settable through `timeouts`', function callee$3$0() {
        var to;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              to = driver.pageLoadMs;
              context$4$0.next = 3;
              return _regeneratorRuntime.awrap(driver.timeouts('page load', to + 20));

            case 3:
              driver.pageLoadMs.should.equal(to + 20);

            case 4:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
    });
    describe('script', function () {
      it('should be settable through `timeouts`', function callee$3$0() {
        var to;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              to = driver.asyncWaitMs;
              context$4$0.next = 3;
              return _regeneratorRuntime.awrap(driver.timeouts('script', to + 20));

            case 3:
              driver.asyncWaitMs.should.equal(to + 20);

            case 4:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
      it('should be settable through asyncScriptTimeout', function callee$3$0() {
        var to;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              to = driver.asyncWaitMs;
              context$4$0.next = 3;
              return _regeneratorRuntime.awrap(driver.asyncScriptTimeout(to + 20));

            case 3:
              driver.asyncWaitMs.should.equal(to + 20);

            case 4:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
    });
  });
});

describe('getDeviceTime', (0, _appiumTestSupport.withMocks)({ fs: _appiumSupport.fs, teen_process: teen_process }, function (mocks) {
  it('should call idevicedate on real device', function callee$1$0() {
    var udid, date, idevicedatePath, driver;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          udid = 'some-udid';
          date = new Date().toString();
          idevicedatePath = '/path/to/idevicedate';

          mocks.fs.expects('which').once().returns(idevicedatePath);
          mocks.teen_process.expects('exec').once().withExactArgs(idevicedatePath, ['-u', udid]).returns({ stdout: date });
          driver = new _2['default']();

          driver.opts = { udid: udid };

          context$2$0.next = 9;
          return _regeneratorRuntime.awrap(driver.getDeviceTime());

        case 9:
          context$2$0.t0 = date;
          context$2$0.sent.should.equal(context$2$0.t0);

          mocks.fs.verify();
          mocks.teen_process.verify();

        case 13:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('should throw an error when idevicedate cannot be found', function callee$1$0() {
    var udid, driver;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          udid = 'some-udid';

          mocks.fs.expects('which').once().throws();
          driver = new _2['default']();

          driver.opts = { udid: udid };
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(driver.getDeviceTime().should.eventually.be.rejectedWith("Could not capture device date and time"));

        case 6:

          mocks.fs.verify();

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('should throw an error when idevicedate fails', function callee$1$0() {
    var udid, idevicedatePath, driver;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          udid = 'some-udid';
          idevicedatePath = '/path/to/idevicedate';

          mocks.fs.expects('which').once().returns(idevicedatePath);
          mocks.teen_process.expects("exec").once().withExactArgs(idevicedatePath, ['-u', udid]).throws("ENOENT");
          driver = new _2['default']();

          driver.opts = { udid: udid };
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(driver.getDeviceTime().should.eventually.be.rejectedWith("Could not capture device date and time"));

        case 8:

          mocks.fs.verify();
          mocks.teen_process.verify();

        case 10:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('should return system date on simulator', function callee$1$0() {
    var driver;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          mocks.teen_process.expects("exec").never();
          driver = new _2['default']();
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(driver.getDeviceTime());

        case 4:
          context$2$0.t0 = context$2$0.sent.should.be.an;
          context$2$0.t1 = String;
          context$2$0.t0 instanceof context$2$0.t1;

          mocks.teen_process.verify();

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
}));
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9kcml2ZXItc3BlY3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O2dCQUVzQixPQUFPOzs7O29CQUNaLE1BQU07Ozs7OEJBQ0ksa0JBQWtCOzs7O2lDQUNuQixxQkFBcUI7OzRCQUNqQixjQUFjOztJQUFoQyxZQUFZOzs2QkFDTCxnQkFBZ0I7OzJCQUNqQixjQUFjOzs7O0FBRWhDLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQ2Qsa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQzs7QUFFekIsUUFBUSxDQUFDLFFBQVEsRUFBRSxZQUFNO0FBQ3ZCLElBQUUsQ0FBQywwQkFBMEIsRUFBRSxZQUFNO0FBQ25DLFFBQUksTUFBTSxHQUFHLG1CQUFlLENBQUM7QUFDN0IsVUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7R0FDckIsQ0FBQyxDQUFDOztBQUVILFVBQVEsQ0FBQyw0QkFBNEIsRUFBRSxrQ0FBVSxFQUFDLEtBQUssMEJBQUEsRUFBQyxFQUFFLFVBQUMsS0FBSyxFQUFLO0FBQ25FLFFBQUksTUFBTSxZQUFBLENBQUM7QUFDWCxVQUFNLENBQUM7Ozs7QUFDTCxrQkFBTSxHQUFHLG1CQUFlLENBQUM7Ozs7Ozs7S0FDMUIsQ0FBQyxDQUFDO0FBQ0gsTUFBRSxDQUFDLDRDQUE0QyxFQUFFOzs7O0FBQy9DLGlCQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FDOUIsSUFBSSxFQUFFLENBQUMsT0FBTyxDQUFDO0FBQ2QsMkJBQWEsRUFBRSxPQUFPO0FBQ3RCLDBCQUFZLEVBQUUsR0FBRztBQUNqQixtQkFBSyxFQUFFLENBQUM7QUFDUixtQkFBSyxFQUFFLENBQUM7QUFDUixtQkFBSyxFQUFFLENBQUM7YUFDVCxDQUFDLENBQUM7OzZDQUNDLE1BQU0sQ0FBQyxhQUFhLENBQUM7QUFDekIsMEJBQVksRUFBRSxLQUFLO0FBQ25CLHdCQUFVLEVBQUUsa0JBQWtCO0FBQzlCLGlCQUFHLEVBQUUsY0FBYzth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O0FBQ1AsZ0JBQU0sR0FBRyxtQkFBZTs7MkNBQ3JCLE1BQU0sQ0FBQyxhQUFhLEVBQUU7Ozs0Q0FBRSxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUU7MkJBQVksTUFBTTs7O0FBRTdELGVBQUssQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUM7Ozs7Ozs7R0FDN0IsQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoidGVzdC91bml0L2RyaXZlci1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptb2NoYVxuXG5pbXBvcnQgSW9zRHJpdmVyIGZyb20gJy4uLy4uJztcbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IHsgd2l0aE1vY2tzIH0gZnJvbSAnYXBwaXVtLXRlc3Qtc3VwcG9ydCc7XG5pbXBvcnQgKiBhcyB0ZWVuX3Byb2Nlc3MgZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHhjb2RlIGZyb20gJ2FwcGl1bS14Y29kZSc7XG5cbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmRlc2NyaWJlKCdkcml2ZXInLCAoKSA9PiB7XG4gIGl0KCdzaG91bGQgaW5zdGFudGlhdGUgY2xhc3MnLCAoKSA9PiB7XG4gICAgbGV0IGRyaXZlciA9IG5ldyBJb3NEcml2ZXIoKTtcbiAgICBkcml2ZXIuc2hvdWxkLmV4aXN0O1xuICB9KTtcblxuICBkZXNjcmliZSgndW5zdXBwb3J0ZWQgaW5mcmFzdHJ1Y3R1cmUnLCB3aXRoTW9ja3Moe3hjb2RlfSwgKG1vY2tzKSA9PiB7XG4gICAgbGV0IGRyaXZlcjtcbiAgICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgICAgZHJpdmVyID0gbmV3IElvc0RyaXZlcigpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgdGhyb3cgYW4gZXJyb3IgZm9yIFhjb2RlIHZlcnNpb24gOCsnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2Nrcy54Y29kZS5leHBlY3RzKCdnZXRWZXJzaW9uJylcbiAgICAgICAgLm9uY2UoKS5yZXR1cm5zKHtcbiAgICAgICAgICB2ZXJzaW9uU3RyaW5nOiAnOC4wLjAnLFxuICAgICAgICAgIHZlcnNpb25GbG9hdDogOC4wLFxuICAgICAgICAgIG1ham9yOiA4LFxuICAgICAgICAgIG1pbm9yOiAwLFxuICAgICAgICAgIHBhdGNoOiAwXG4gICAgICAgIH0pO1xuICAgICAgYXdhaXQgZHJpdmVyLmNyZWF0ZVNlc3Npb24oe1xuICAgICAgICBwbGF0Zm9ybU5hbWU6ICdpT1MnLFxuICAgICAgICBkZXZpY2VOYW1lOiAnaVBob25lIFNpbXVsYXRvcicsXG4gICAgICAgIGFwcDogJy9wYXRoL3RvL2FwcCdcbiAgICAgIH0pLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgvQXBwaXVtJ3MgSW9zRHJpdmVyIGRvZXMgbm90IHN1cHBvcnQgeGNvZGUgdmVyc2lvbiA4LjAuMC8pO1xuICAgICAgbW9ja3MueGNvZGUudmVyaWZ5KCk7XG4gICAgfSk7XG4gIH0pKTtcblxuICBkZXNjcmliZSgndGltZW91dHMnLCAoKSA9PiB7XG4gICAgbGV0IGRyaXZlcjtcbiAgICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgICAgZHJpdmVyID0gbmV3IElvc0RyaXZlcigpO1xuICAgICAgLy8gYXdhaXQgZHJpdmVyLmNyZWF0ZVNlc3Npb24oe30pO1xuICAgIH0pO1xuICAgIGRlc2NyaWJlKCdjb21tYW5kJywgKCkgPT4ge1xuICAgICAgaXQoJ3Nob3VsZCBleGlzdCBieSBkZWZhdWx0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBkcml2ZXIubmV3Q29tbWFuZFRpbWVvdXRNcy5zaG91bGQuZXF1YWwoNjAwMDApO1xuICAgICAgfSk7XG4gICAgICBpdCgnc2hvdWxkIGJlIHNldHRhYmxlIHRocm91Z2ggYHRpbWVvdXRzYCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgZHJpdmVyLnRpbWVvdXRzKCdjb21tYW5kJywgMjApO1xuICAgICAgICBkcml2ZXIubmV3Q29tbWFuZFRpbWVvdXRNcy5zaG91bGQuZXF1YWwoMjApO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgZGVzY3JpYmUoJ2ltcGxpY2l0JywgKCkgPT4ge1xuICAgICAgaXQoJ3Nob3VsZCBub3QgZXhpc3QgYnkgZGVmYXVsdCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgZHJpdmVyLmltcGxpY2l0V2FpdE1zLnNob3VsZC5lcXVhbCgwKTtcbiAgICAgIH0pO1xuICAgICAgaXQoJ3Nob3VsZCBiZSBzZXR0YWJsZSB0aHJvdWdoIGB0aW1lb3V0c2AnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IGRyaXZlci50aW1lb3V0cygnaW1wbGljaXQnLCAyMCk7XG4gICAgICAgIGRyaXZlci5pbXBsaWNpdFdhaXRNcy5zaG91bGQuZXF1YWwoMjApO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgZGVzY3JpYmUoJ3BhZ2UgbG9hZCcsICgpID0+IHtcbiAgICAgIGl0KCdzaG91bGQgYmUgc2V0dGFibGUgdGhyb3VnaCBgdGltZW91dHNgJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBsZXQgdG8gPSBkcml2ZXIucGFnZUxvYWRNcztcbiAgICAgICAgYXdhaXQgZHJpdmVyLnRpbWVvdXRzKCdwYWdlIGxvYWQnLCB0byArIDIwKTtcbiAgICAgICAgZHJpdmVyLnBhZ2VMb2FkTXMuc2hvdWxkLmVxdWFsKHRvICsgMjApO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgZGVzY3JpYmUoJ3NjcmlwdCcsICgpID0+IHtcbiAgICAgIGl0KCdzaG91bGQgYmUgc2V0dGFibGUgdGhyb3VnaCBgdGltZW91dHNgJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBsZXQgdG8gPSBkcml2ZXIuYXN5bmNXYWl0TXM7XG4gICAgICAgIGF3YWl0IGRyaXZlci50aW1lb3V0cygnc2NyaXB0JywgdG8gKyAyMCk7XG4gICAgICAgIGRyaXZlci5hc3luY1dhaXRNcy5zaG91bGQuZXF1YWwodG8gKyAyMCk7XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgYmUgc2V0dGFibGUgdGhyb3VnaCBhc3luY1NjcmlwdFRpbWVvdXQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGxldCB0byA9IGRyaXZlci5hc3luY1dhaXRNcztcbiAgICAgICAgYXdhaXQgZHJpdmVyLmFzeW5jU2NyaXB0VGltZW91dCh0byArIDIwKTtcbiAgICAgICAgZHJpdmVyLmFzeW5jV2FpdE1zLnNob3VsZC5lcXVhbCh0byArIDIwKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnZ2V0RGV2aWNlVGltZScsIHdpdGhNb2Nrcyh7ZnMsIHRlZW5fcHJvY2Vzc30sIChtb2NrcykgPT4ge1xuICBpdCgnc2hvdWxkIGNhbGwgaWRldmljZWRhdGUgb24gcmVhbCBkZXZpY2UnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IHVkaWQgPSAnc29tZS11ZGlkJztcbiAgICBsZXQgZGF0ZSA9IG5ldyBEYXRlKCkudG9TdHJpbmcoKTtcbiAgICBsZXQgaWRldmljZWRhdGVQYXRoID0gJy9wYXRoL3RvL2lkZXZpY2VkYXRlJztcbiAgICBtb2Nrcy5mcy5leHBlY3RzKCd3aGljaCcpXG4gICAgICAub25jZSgpLnJldHVybnMoaWRldmljZWRhdGVQYXRoKTtcbiAgICBtb2Nrcy50ZWVuX3Byb2Nlc3MuZXhwZWN0cygnZXhlYycpXG4gICAgICAub25jZSgpLndpdGhFeGFjdEFyZ3MoaWRldmljZWRhdGVQYXRoLCBbJy11JywgdWRpZF0pXG4gICAgICAucmV0dXJucyh7c3Rkb3V0OiBkYXRlfSk7XG4gICAgbGV0IGRyaXZlciA9IG5ldyBJb3NEcml2ZXIoKTtcbiAgICBkcml2ZXIub3B0cyA9IHt1ZGlkfTtcblxuICAgIChhd2FpdCBkcml2ZXIuZ2V0RGV2aWNlVGltZSgpKS5zaG91bGQuZXF1YWwoZGF0ZSk7XG5cbiAgICBtb2Nrcy5mcy52ZXJpZnkoKTtcbiAgICBtb2Nrcy50ZWVuX3Byb2Nlc3MudmVyaWZ5KCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgdGhyb3cgYW4gZXJyb3Igd2hlbiBpZGV2aWNlZGF0ZSBjYW5ub3QgYmUgZm91bmQnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IHVkaWQgPSAnc29tZS11ZGlkJztcbiAgICBtb2Nrcy5mcy5leHBlY3RzKCd3aGljaCcpXG4gICAgICAub25jZSgpLnRocm93cygpO1xuICAgIGxldCBkcml2ZXIgPSBuZXcgSW9zRHJpdmVyKCk7XG4gICAgZHJpdmVyLm9wdHMgPSB7dWRpZH07XG4gICAgYXdhaXQgZHJpdmVyLmdldERldmljZVRpbWUoKVxuICAgICAgLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aChcIkNvdWxkIG5vdCBjYXB0dXJlIGRldmljZSBkYXRlIGFuZCB0aW1lXCIpO1xuXG4gICAgbW9ja3MuZnMudmVyaWZ5KCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgdGhyb3cgYW4gZXJyb3Igd2hlbiBpZGV2aWNlZGF0ZSBmYWlscycsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgdWRpZCA9ICdzb21lLXVkaWQnO1xuICAgIGxldCBpZGV2aWNlZGF0ZVBhdGggPSAnL3BhdGgvdG8vaWRldmljZWRhdGUnO1xuICAgIG1vY2tzLmZzLmV4cGVjdHMoJ3doaWNoJylcbiAgICAgIC5vbmNlKCkucmV0dXJucyhpZGV2aWNlZGF0ZVBhdGgpO1xuICAgIG1vY2tzLnRlZW5fcHJvY2Vzcy5leHBlY3RzKFwiZXhlY1wiKVxuICAgICAgLm9uY2UoKS53aXRoRXhhY3RBcmdzKGlkZXZpY2VkYXRlUGF0aCwgWyctdScsIHVkaWRdKVxuICAgICAgLnRocm93cyhcIkVOT0VOVFwiKTtcbiAgICBsZXQgZHJpdmVyID0gbmV3IElvc0RyaXZlcigpO1xuICAgIGRyaXZlci5vcHRzID0ge3VkaWR9O1xuICAgIGF3YWl0IGRyaXZlci5nZXREZXZpY2VUaW1lKClcbiAgICAgIC5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoXCJDb3VsZCBub3QgY2FwdHVyZSBkZXZpY2UgZGF0ZSBhbmQgdGltZVwiKTtcblxuICAgIG1vY2tzLmZzLnZlcmlmeSgpO1xuICAgIG1vY2tzLnRlZW5fcHJvY2Vzcy52ZXJpZnkoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCByZXR1cm4gc3lzdGVtIGRhdGUgb24gc2ltdWxhdG9yJywgYXN5bmMgKCkgPT4ge1xuICAgIG1vY2tzLnRlZW5fcHJvY2Vzcy5leHBlY3RzKFwiZXhlY1wiKVxuICAgICAgLm5ldmVyKCk7XG4gICAgbGV0IGRyaXZlciA9IG5ldyBJb3NEcml2ZXIoKTtcbiAgICAoYXdhaXQgZHJpdmVyLmdldERldmljZVRpbWUoKSkuc2hvdWxkLmJlLmFuIGluc3RhbmNlb2YoU3RyaW5nKTtcblxuICAgIG1vY2tzLnRlZW5fcHJvY2Vzcy52ZXJpZnkoKTtcbiAgfSk7XG59KSk7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
