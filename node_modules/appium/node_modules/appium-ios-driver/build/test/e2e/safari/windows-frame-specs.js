'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _safariSetup = require('./safari-setup');

var _safariSetup2 = _interopRequireDefault(_safariSetup);

var _helpersEnv = require('../helpers/env');

var _helpersEnv2 = _interopRequireDefault(_helpersEnv);

var _helpersWebview = require("../helpers/webview");

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _helpersSession = require('../helpers/session');

describe('safari - windows and frames (' + _helpersEnv2['default'].DEVICE + ')', function () {
  this.timeout(_helpersSession.MOCHA_SAFARI_TIMEOUT);

  var driver = (0, _safariSetup2['default'])(this, {
    browserName: 'safari',
    nativeWebTap: true,
    safariAllowPopups: true,
    fullReset: true
  }).driver;

  describe('within webview', function () {
    var _this = this;

    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.implicitWait(1000));

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    beforeEach(function () {
      return (0, _helpersWebview.loadWebView)("safari", driver);
    });

    it("should throw nosuchwindow if there's not one", function () {
      return driver.setWindow('noexistman').should.be.rejectedWith(/window could not be found/);
    });

    // unfortunately, iOS8 doesn't respond to the close() method on window
    // the way iOS7 does
    it("should be able to open and close windows @skip-ios8", function callee$2$0() {
      var el;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'blanklink'));

          case 2:
            el = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.click(el));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am another page title", driver));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(2000));

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(driver.closeWindow());

          case 11:
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(3000));

          case 13:
            context$3$0.next = 15;
            return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am a page title", driver));

          case 15:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should be able to go back and forward', function callee$2$0() {
      var link;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElement('link text', 'i am a link'));

          case 2:
            link = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.click(link));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'only_on_page_2'));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(driver.back());

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'i_am_a_textbox'));

          case 11:
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap(driver.forward());

          case 13:
            context$3$0.next = 15;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'only_on_page_2'));

          case 15:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    // broken on real devices, see https://github.com/appium/appium/issues/5167
    it("should be able to open js popup windows with safariAllowPopups set to true @skip-real-device", function callee$2$0() {
      var link;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElement('link text', 'i am a new window link'));

          case 2:
            link = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.click(link));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am another page title", driver, 30));

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });
});

describe('safari - windows and frames (' + _helpersEnv2['default'].DEVICE + ') - without safariAllowPopups', function () {
  var _this2 = this;

  this.timeout(_helpersSession.MOCHA_SAFARI_TIMEOUT);

  var driver = (0, _safariSetup2['default'])(this, {
    browserName: 'safari',
    safariAllowPopups: false
  }).driver;

  before(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(driver.implicitWait(5000));

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this2);
  });
  beforeEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _helpersWebview.loadWebView)("safari", driver));

        case 2:
          return context$2$0.abrupt('return', context$2$0.sent);

        case 3:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this2);
  });

  it("should not be able to open js popup windows", function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(driver.execute("window.open('/test/guinea-pig2.html', null)"));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am another page title", driver, 5).should.eventually.be.rejected);

        case 4:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this2);
  });
});

// minimize waiting if something goes wrong

// minimize waiting if something goes wrong
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZTJlL3NhZmFyaS93aW5kb3dzLWZyYW1lLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OzsyQkFBa0IsZ0JBQWdCOzs7OzBCQUNsQixnQkFBZ0I7Ozs7OEJBQ08sb0JBQW9COzt3QkFDN0MsVUFBVTs7Ozs4QkFDYSxvQkFBb0I7O0FBR3pELFFBQVEsbUNBQWlDLHdCQUFJLE1BQU0sUUFBSyxZQUFZO0FBQ2xFLE1BQUksQ0FBQyxPQUFPLHNDQUFzQixDQUFDOztBQUVuQyxNQUFNLE1BQU0sR0FBRyw4QkFBTSxJQUFJLEVBQUU7QUFDekIsZUFBVyxFQUFFLFFBQVE7QUFDckIsZ0JBQVksRUFBRSxJQUFJO0FBQ2xCLHFCQUFpQixFQUFFLElBQUk7QUFDdkIsYUFBUyxFQUFFLElBQUk7R0FDaEIsQ0FBQyxDQUFDLE1BQU0sQ0FBQzs7QUFFVixVQUFRLENBQUMsZ0JBQWdCLEVBQUUsWUFBWTs7O0FBQ3JDLFVBQU0sQ0FBQzs7Ozs7NkNBRUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUM7Ozs7Ozs7S0FDaEMsQ0FBQyxDQUFDO0FBQ0gsY0FBVSxDQUFDO2FBQU0saUNBQVksUUFBUSxFQUFFLE1BQU0sQ0FBQztLQUFBLENBQUMsQ0FBQzs7QUFFaEQsTUFBRSxDQUFDLDhDQUE4QyxFQUFFLFlBQU07QUFDdkQsYUFBTyxNQUFNLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLDJCQUEyQixDQUFDLENBQUM7S0FDM0YsQ0FBQyxDQUFDOzs7O0FBSUgsTUFBRSxDQUFDLHFEQUFxRCxFQUFFO1VBQ3BELEVBQUU7Ozs7OzZDQUFTLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQzs7O0FBQWhELGNBQUU7OzZDQUNBLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDOzs7OzZDQUNoQiwrQkFBVSx5QkFBeUIsRUFBRSxNQUFNLENBQUM7Ozs7NkNBRTVDLHNCQUFFLEtBQUssQ0FBQyxJQUFJLENBQUM7Ozs7NkNBQ2IsTUFBTSxDQUFDLFdBQVcsRUFBRTs7Ozs2Q0FDcEIsc0JBQUUsS0FBSyxDQUFDLElBQUksQ0FBQzs7Ozs2Q0FDYiwrQkFBVSxtQkFBbUIsRUFBRSxNQUFNLENBQUM7Ozs7Ozs7S0FDN0MsQ0FBQyxDQUFDOztBQUVILE1BQUUsQ0FBQyx1Q0FBdUMsRUFBRTtVQUN0QyxJQUFJOzs7Ozs2Q0FBUyxNQUFNLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUM7OztBQUEzRCxnQkFBSTs7NkNBQ0YsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7Ozs7NkNBQ2xCLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLGdCQUFnQixDQUFDOzs7OzZDQUMxQyxNQUFNLENBQUMsSUFBSSxFQUFFOzs7OzZDQUNiLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLGdCQUFnQixDQUFDOzs7OzZDQUMxQyxNQUFNLENBQUMsT0FBTyxFQUFFOzs7OzZDQUNoQixNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQzs7Ozs7OztLQUNqRCxDQUFDLENBQUM7OztBQUdILE1BQUUsQ0FBQyw4RkFBOEYsRUFBRTtVQUM3RixJQUFJOzs7Ozs2Q0FBUyxNQUFNLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSx3QkFBd0IsQ0FBQzs7O0FBQXRFLGdCQUFJOzs2Q0FDRixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQzs7Ozs2Q0FDbEIsK0JBQVUseUJBQXlCLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQzs7Ozs7OztLQUN2RCxDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUM7O0FBRUgsUUFBUSxtQ0FBaUMsd0JBQUksTUFBTSxvQ0FBaUMsWUFBWTs7O0FBQzlGLE1BQUksQ0FBQyxPQUFPLHNDQUFzQixDQUFDOztBQUVuQyxNQUFNLE1BQU0sR0FBRyw4QkFBTSxJQUFJLEVBQUU7QUFDekIsZUFBVyxFQUFFLFFBQVE7QUFDckIscUJBQWlCLEVBQUUsS0FBSztHQUN6QixDQUFDLENBQUMsTUFBTSxDQUFDOztBQUVWLFFBQU0sQ0FBQzs7Ozs7MkNBRUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUM7Ozs7Ozs7R0FDaEMsQ0FBQyxDQUFDO0FBQ0gsWUFBVSxDQUFDOzs7OzsyQ0FBa0IsaUNBQVksUUFBUSxFQUFFLE1BQU0sQ0FBQzs7Ozs7Ozs7OztHQUFBLENBQUMsQ0FBQzs7QUFFNUQsSUFBRSxDQUFDLDZDQUE2QyxFQUFFOzs7OzsyQ0FDMUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQzs7OzsyQ0FDN0QsK0JBQVUseUJBQXlCLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLFFBQVE7Ozs7Ozs7R0FDcEYsQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6InRlc3QvZTJlL3NhZmFyaS93aW5kb3dzLWZyYW1lLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHNldHVwIGZyb20gJy4vc2FmYXJpLXNldHVwJztcbmltcG9ydCBlbnYgZnJvbSAnLi4vaGVscGVycy9lbnYnO1xuaW1wb3J0IHsgbG9hZFdlYlZpZXcsIHNwaW5UaXRsZSB9IGZyb20gXCIuLi9oZWxwZXJzL3dlYnZpZXdcIjtcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IE1PQ0hBX1NBRkFSSV9USU1FT1VUIH0gZnJvbSAnLi4vaGVscGVycy9zZXNzaW9uJztcblxuXG5kZXNjcmliZShgc2FmYXJpIC0gd2luZG93cyBhbmQgZnJhbWVzICgke2Vudi5ERVZJQ0V9KWAsIGZ1bmN0aW9uICgpIHtcbiAgdGhpcy50aW1lb3V0KE1PQ0hBX1NBRkFSSV9USU1FT1VUKTtcblxuICBjb25zdCBkcml2ZXIgPSBzZXR1cCh0aGlzLCB7XG4gICAgYnJvd3Nlck5hbWU6ICdzYWZhcmknLFxuICAgIG5hdGl2ZVdlYlRhcDogdHJ1ZSxcbiAgICBzYWZhcmlBbGxvd1BvcHVwczogdHJ1ZSxcbiAgICBmdWxsUmVzZXQ6IHRydWUsXG4gIH0pLmRyaXZlcjtcblxuICBkZXNjcmliZSgnd2l0aGluIHdlYnZpZXcnLCBmdW5jdGlvbiAoKSB7XG4gICAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICAgIC8vIG1pbmltaXplIHdhaXRpbmcgaWYgc29tZXRoaW5nIGdvZXMgd3JvbmdcbiAgICAgIGF3YWl0IGRyaXZlci5pbXBsaWNpdFdhaXQoMTAwMCk7XG4gICAgfSk7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiBsb2FkV2ViVmlldyhcInNhZmFyaVwiLCBkcml2ZXIpKTtcblxuICAgIGl0KFwic2hvdWxkIHRocm93IG5vc3VjaHdpbmRvdyBpZiB0aGVyZSdzIG5vdCBvbmVcIiwgKCkgPT4ge1xuICAgICAgcmV0dXJuIGRyaXZlci5zZXRXaW5kb3coJ25vZXhpc3RtYW4nKS5zaG91bGQuYmUucmVqZWN0ZWRXaXRoKC93aW5kb3cgY291bGQgbm90IGJlIGZvdW5kLyk7XG4gICAgfSk7XG5cbiAgICAvLyB1bmZvcnR1bmF0ZWx5LCBpT1M4IGRvZXNuJ3QgcmVzcG9uZCB0byB0aGUgY2xvc2UoKSBtZXRob2Qgb24gd2luZG93XG4gICAgLy8gdGhlIHdheSBpT1M3IGRvZXNcbiAgICBpdChcInNob3VsZCBiZSBhYmxlIHRvIG9wZW4gYW5kIGNsb3NlIHdpbmRvd3MgQHNraXAtaW9zOFwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgZWwgPSBhd2FpdCBkcml2ZXIuZmluZEVsZW1lbnQoJ2lkJywgJ2JsYW5rbGluaycpO1xuICAgICAgYXdhaXQgZHJpdmVyLmNsaWNrKGVsKTtcbiAgICAgIGF3YWl0IHNwaW5UaXRsZShcIkkgYW0gYW5vdGhlciBwYWdlIHRpdGxlXCIsIGRyaXZlcik7XG5cbiAgICAgIGF3YWl0IEIuZGVsYXkoMjAwMCk7XG4gICAgICBhd2FpdCBkcml2ZXIuY2xvc2VXaW5kb3coKTtcbiAgICAgIGF3YWl0IEIuZGVsYXkoMzAwMCk7XG4gICAgICBhd2FpdCBzcGluVGl0bGUoXCJJIGFtIGEgcGFnZSB0aXRsZVwiLCBkcml2ZXIpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBiZSBhYmxlIHRvIGdvIGJhY2sgYW5kIGZvcndhcmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgbGluayA9IGF3YWl0IGRyaXZlci5maW5kRWxlbWVudCgnbGluayB0ZXh0JywgJ2kgYW0gYSBsaW5rJyk7XG4gICAgICBhd2FpdCBkcml2ZXIuY2xpY2sobGluayk7XG4gICAgICBhd2FpdCBkcml2ZXIuZmluZEVsZW1lbnQoJ2lkJywgJ29ubHlfb25fcGFnZV8yJyk7XG4gICAgICBhd2FpdCBkcml2ZXIuYmFjaygpO1xuICAgICAgYXdhaXQgZHJpdmVyLmZpbmRFbGVtZW50KCdpZCcsICdpX2FtX2FfdGV4dGJveCcpO1xuICAgICAgYXdhaXQgZHJpdmVyLmZvcndhcmQoKTtcbiAgICAgIGF3YWl0IGRyaXZlci5maW5kRWxlbWVudCgnaWQnLCAnb25seV9vbl9wYWdlXzInKTtcbiAgICB9KTtcblxuICAgIC8vIGJyb2tlbiBvbiByZWFsIGRldmljZXMsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvNTE2N1xuICAgIGl0KFwic2hvdWxkIGJlIGFibGUgdG8gb3BlbiBqcyBwb3B1cCB3aW5kb3dzIHdpdGggc2FmYXJpQWxsb3dQb3B1cHMgc2V0IHRvIHRydWUgQHNraXAtcmVhbC1kZXZpY2VcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGxpbmsgPSBhd2FpdCBkcml2ZXIuZmluZEVsZW1lbnQoJ2xpbmsgdGV4dCcsICdpIGFtIGEgbmV3IHdpbmRvdyBsaW5rJyk7XG4gICAgICBhd2FpdCBkcml2ZXIuY2xpY2sobGluayk7XG4gICAgICBhd2FpdCBzcGluVGl0bGUoXCJJIGFtIGFub3RoZXIgcGFnZSB0aXRsZVwiLCBkcml2ZXIsIDMwKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoYHNhZmFyaSAtIHdpbmRvd3MgYW5kIGZyYW1lcyAoJHtlbnYuREVWSUNFfSkgLSB3aXRob3V0IHNhZmFyaUFsbG93UG9wdXBzYCwgZnVuY3Rpb24gKCkge1xuICB0aGlzLnRpbWVvdXQoTU9DSEFfU0FGQVJJX1RJTUVPVVQpO1xuXG4gIGNvbnN0IGRyaXZlciA9IHNldHVwKHRoaXMsIHtcbiAgICBicm93c2VyTmFtZTogJ3NhZmFyaScsXG4gICAgc2FmYXJpQWxsb3dQb3B1cHM6IGZhbHNlXG4gIH0pLmRyaXZlcjtcblxuICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgIC8vIG1pbmltaXplIHdhaXRpbmcgaWYgc29tZXRoaW5nIGdvZXMgd3JvbmdcbiAgICBhd2FpdCBkcml2ZXIuaW1wbGljaXRXYWl0KDUwMDApO1xuICB9KTtcbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiBhd2FpdCBsb2FkV2ViVmlldyhcInNhZmFyaVwiLCBkcml2ZXIpKTtcblxuICBpdChcInNob3VsZCBub3QgYmUgYWJsZSB0byBvcGVuIGpzIHBvcHVwIHdpbmRvd3NcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGRyaXZlci5leGVjdXRlKFwid2luZG93Lm9wZW4oJy90ZXN0L2d1aW5lYS1waWcyLmh0bWwnLCBudWxsKVwiKTtcbiAgICBhd2FpdCBzcGluVGl0bGUoXCJJIGFtIGFub3RoZXIgcGFnZSB0aXRsZVwiLCBkcml2ZXIsIDUpLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkO1xuICB9KTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9
