'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _setupBase = require("../setup-base");

var _setupBase2 = _interopRequireDefault(_setupBase);

var _desired = require('./desired');

var _desired2 = _interopRequireDefault(_desired);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _helpersEnv = require('../helpers/env');

var _helpersEnv2 = _interopRequireDefault(_helpersEnv);

var _unorm = require('unorm');

var _unorm2 = _interopRequireDefault(_unorm);

describe('testapp - keyboard', function () {
  this.timeout(_helpersEnv2['default'].MOCHA_INIT_TIMEOUT);

  var test = function test(strategy) {
    describe('typing with strategy: ' + (strategy || 'undefined'), function () {
      var _this = this;

      // TODO: when sending 'Appium Rocks', autocompletion kicks in and
      //       messes up the test, investigate.
      var text = 'good morning';

      var session = (0, _setupBase2['default'])(this, _lodash2['default'].defaults({ sendKeyStrategy: strategy }, _desired2['default']));
      var driver = session.driver;

      it("should send keys to a text field", function callee$3$0() {
        var env, el, text2;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap(driver.execute('env'));

            case 2:
              env = context$4$0.sent;

              if (strategy) {
                env.sendKeyStrategy.should.equal(strategy);
              } else {
                env.sendKeyStrategy.should.equal(process.env.REAL_DEVICE ? 'grouped' : 'oneByOne');
              }
              context$4$0.next = 6;
              return _regeneratorRuntime.awrap(driver.findElement('class name', 'UIATextField'));

            case 6:
              el = context$4$0.sent;
              context$4$0.next = 9;
              return _regeneratorRuntime.awrap(driver.clear(el));

            case 9:
              context$4$0.next = 11;
              return _regeneratorRuntime.awrap(driver.setValue(text, el));

            case 11:
              context$4$0.next = 13;
              return _regeneratorRuntime.awrap(driver.getText(el));

            case 13:
              text2 = context$4$0.sent;

              if (strategy === 'grouped') {
                text2.length.should.be.above(0);
              } else {
                text2.should.equal(text);
              }

            case 15:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
    });
  };

  _lodash2['default'].each([undefined, 'oneByOne', 'grouped', 'setValue'], test);

  describe("typing", function () {
    var _this3 = this;

    var session = (0, _setupBase2['default'])(this, _desired2['default']);
    var driver = session.driver;

    describe("stability @skip-ci", function () {
      var runs = 10,
          text = 'Delhi is New @@@ BREAKFAST-FOOD-0001';

      var test = function test() {
        var _this2 = this;

        it("should send keys to a text field", function callee$4$0() {
          var el;
          return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
            while (1) switch (context$5$0.prev = context$5$0.next) {
              case 0:
                context$5$0.next = 2;
                return _regeneratorRuntime.awrap(driver.findElement('class name', 'UIATextField'));

              case 2:
                el = context$5$0.sent;
                context$5$0.next = 5;
                return _regeneratorRuntime.awrap(driver.clear(el));

              case 5:
                driver.setValue(text, el);
                context$5$0.next = 8;
                return _regeneratorRuntime.awrap(driver.getText(el));

              case 8:
                context$5$0.t0 = text;
                context$5$0.sent.should.equal(context$5$0.t0);

              case 10:
              case 'end':
                return context$5$0.stop();
            }
          }, null, _this2);
        });
      };

      for (var n = 0; n < runs; n++) {
        describe('sendKeys test ' + (n + 1), test);
      }
    });

    it('should send accented text', function callee$2$0() {
      var testText, els, el;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            testText = _unorm2['default'].nfd("é Œ ù ḍ");
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(driver.findElements('class name', 'UIATextField'));

          case 3:
            els = context$3$0.sent;
            el = els[1];
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(driver.clear(el));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(driver.setValue(testText, el));

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(driver.getText(el));

          case 11:
            context$3$0.t0 = testText;
            context$3$0.sent.should.equal(context$3$0.t0);

          case 13:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this3);
    });

    it('should send backspace key', function callee$2$0() {
      var els, el;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElements('class name', 'UIATextField'));

          case 2:
            els = context$3$0.sent;
            el = els[1];
            context$3$0.next = 6;
            return _regeneratorRuntime.awrap(driver.clear(el));

          case 6:
            context$3$0.next = 8;
            return _regeneratorRuntime.awrap(driver.setValue('abcd', el));

          case 8:
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap(driver.getText(el));

          case 10:
            context$3$0.sent.should.equal('abcd');
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap(driver.setValue('', el));

          case 13:
            context$3$0.next = 15;
            return _regeneratorRuntime.awrap(driver.getText(el));

          case 15:
            context$3$0.sent.should.equal('ab');

          case 16:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this3);
    });

    it('should send delete key', function callee$2$0() {
      var els, el;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElements('class name', 'UIATextField'));

          case 2:
            els = context$3$0.sent;
            el = els[1];
            context$3$0.next = 6;
            return _regeneratorRuntime.awrap(driver.clear(el));

          case 6:
            context$3$0.next = 8;
            return _regeneratorRuntime.awrap(driver.setValue('abcd', el));

          case 8:
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap(driver.setValue('', el));

          case 10:
            context$3$0.next = 12;
            return _regeneratorRuntime.awrap(driver.getText(el));

          case 12:
            context$3$0.sent.should.equal('ab');

          case 13:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this3);
    });

    it('should send single quote text with setValue', function callee$2$0() {
      var testText, els, el;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            testText = "'";
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(driver.findElements('class name', 'UIATextField'));

          case 3:
            els = context$3$0.sent;
            el = els[1];
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(driver.clear(el));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(driver.setValue(testText, el));

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(driver.getText(el));

          case 11:
            context$3$0.t0 = testText;
            context$3$0.sent.should.equal(context$3$0.t0);

          case 13:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this3);
    });
    it('should send single quote text with keys', function callee$2$0() {
      var testText, els, el;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            testText = "'";
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(driver.findElements('class name', 'UIATextField'));

          case 3:
            els = context$3$0.sent;
            el = els[1];
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(driver.clear(el));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(driver.keys(testText));

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(driver.getText(el));

          case 11:
            context$3$0.t0 = testText;
            context$3$0.sent.should.equal(context$3$0.t0);

          case 13:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this3);
    });
    it('should send text with a newline', function callee$2$0() {
      var testText, els, el;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            testText = ['my string\n'];
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(driver.findElements('class name', 'UIATextField'));

          case 3:
            els = context$3$0.sent;
            el = els[1];
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(driver.clear(el));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(driver.keys(testText));

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(driver.getText(el));

          case 11:
            context$3$0.sent.should.equal('my string');

          case 12:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this3);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZTJlL3Rlc3RhcHAva2V5Ym9hcmQtc3BlY3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O3lCQUFrQixlQUFlOzs7O3VCQUNiLFdBQVc7Ozs7c0JBQ2pCLFFBQVE7Ozs7MEJBQ04sZ0JBQWdCOzs7O3FCQUNkLE9BQU87Ozs7QUFHekIsUUFBUSxDQUFDLG9CQUFvQixFQUFFLFlBQVk7QUFDekMsTUFBSSxDQUFDLE9BQU8sQ0FBQyx3QkFBSSxrQkFBa0IsQ0FBQyxDQUFDOztBQUVyQyxNQUFJLElBQUksR0FBRyxTQUFQLElBQUksQ0FBYSxRQUFRLEVBQUU7QUFDN0IsWUFBUSw2QkFBMEIsUUFBUSxJQUFJLFdBQVcsQ0FBQSxFQUFJLFlBQVk7Ozs7O0FBR3ZFLFVBQUksSUFBSSxHQUFHLGNBQWMsQ0FBQzs7QUFFMUIsVUFBSSxPQUFPLEdBQUcsNEJBQU0sSUFBSSxFQUFFLG9CQUFFLFFBQVEsQ0FBQyxFQUFDLGVBQWUsRUFBRSxRQUFRLEVBQUMsdUJBQVUsQ0FBQyxDQUFDO0FBQzVFLFVBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7O0FBRTVCLFFBQUUsQ0FBQyxrQ0FBa0MsRUFBRTtZQUNqQyxHQUFHLEVBT0gsRUFBRSxFQUdGLEtBQUs7Ozs7OytDQVZPLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDOzs7QUFBakMsaUJBQUc7O0FBQ1Asa0JBQUksUUFBUSxFQUFFO0FBQ1osbUJBQUcsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztlQUM1QyxNQUFNO0FBQ0wsbUJBQUcsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDOUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEdBQUcsU0FBUyxHQUFHLFVBQVUsQ0FBQyxDQUFDO2VBQ3JEOzsrQ0FDYyxNQUFNLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxjQUFjLENBQUM7OztBQUEzRCxnQkFBRTs7K0NBQ0EsTUFB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QUFDO0FBQ0gsTUFBRSxDQUFDLHlDQUF5QyxFQUFFO1VBQ3hDLFFBQVEsRUFDUixHQUFHLEVBQ0gsRUFBRTs7OztBQUZGLG9CQUFRLEdBQUcsR0FBRzs7NkNBQ0YsTUFBTSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsY0FBYyxDQUFDOzs7QUFBN0QsZUFBRztBQUNILGNBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDOzs2Q0FDVCxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQzs7Ozs2Q0FDaEIsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7Ozs7NkNBQ3BCLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDOzs7NkJBQWUsUUFBUTs2QkFBckIsTUFBTSxDQUFDLEtBQUs7Ozs7Ozs7S0FDeEMsQ0FBQyxDQUFDO0FBQ0gsTUFBRSxDQUFDLGlDQUFpQyxFQUFFO1VBQ2hDLFFBQVEsRUFDUixHQUFHLEVBQ0gsRUFBRTs7OztBQUZGLG9CQUFRLEdBQUcsQ0FBQyxhQUFhLENBQUM7OzZDQUNkLE1BQU0sQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLGNBQWMsQ0FBQzs7O0FBQTdELGVBQUc7QUFDSCxjQUFFLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQzs7NkNBQ1QsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7Ozs7NkNBQ2hCLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDOzs7OzZDQUNwQixNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQzs7OzZCQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVzs7Ozs7OztLQUNwRCxDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC9lMmUvdGVzdGFwcC9rZXlib2FyZC1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBzZXR1cCBmcm9tIFwiLi4vc2V0dXAtYmFzZVwiO1xuaW1wb3J0IGRlc2lyZWQgZnJvbSAnLi9kZXNpcmVkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgZW52IGZyb20gJy4uL2hlbHBlcnMvZW52JztcbmltcG9ydCB1bm9ybSBmcm9tICd1bm9ybSc7XG5cblxuZGVzY3JpYmUoJ3Rlc3RhcHAgLSBrZXlib2FyZCcsIGZ1bmN0aW9uICgpIHtcbiAgdGhpcy50aW1lb3V0KGVudi5NT0NIQV9JTklUX1RJTUVPVVQpO1xuXG4gIGxldCB0ZXN0ID0gZnVuY3Rpb24gKHN0cmF0ZWd5KSB7XG4gICAgZGVzY3JpYmUoYHR5cGluZyB3aXRoIHN0cmF0ZWd5OiAke3N0cmF0ZWd5IHx8ICd1bmRlZmluZWQnfWAsIGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vIFRPRE86IHdoZW4gc2VuZGluZyAnQXBwaXVtIFJvY2tzJywgYXV0b2NvbXBsZXRpb24ga2lja3MgaW4gYW5kXG4gICAgICAvLyAgICAgICBtZXNzZXMgdXAgdGhlIHRlc3QsIGludmVzdGlnYXRlLlxuICAgICAgbGV0IHRleHQgPSAnZ29vZCBtb3JuaW5nJztcblxuICAgICAgbGV0IHNlc3Npb24gPSBzZXR1cCh0aGlzLCBfLmRlZmF1bHRzKHtzZW5kS2V5U3RyYXRlZ3k6IHN0cmF0ZWd5fSwgZGVzaXJlZCkpO1xuICAgICAgbGV0IGRyaXZlciA9IHNlc3Npb24uZHJpdmVyO1xuXG4gICAgICBpdChcInNob3VsZCBzZW5kIGtleXMgdG8gYSB0ZXh0IGZpZWxkXCIsIGFzeW5jICgpID0+IHtcbiAgICAgICAgbGV0IGVudiA9IGF3YWl0IGRyaXZlci5leGVjdXRlKCdlbnYnKTtcbiAgICAgICAgaWYgKHN0cmF0ZWd5KSB7XG4gICAgICAgICAgZW52LnNlbmRLZXlTdHJhdGVneS5zaG91bGQuZXF1YWwoc3RyYXRlZ3kpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGVudi5zZW5kS2V5U3RyYXRlZ3kuc2hvdWxkLmVxdWFsKFxuICAgICAgICAgICAgcHJvY2Vzcy5lbnYuUkVBTF9ERVZJQ0UgPyAnZ3JvdXBlZCcgOiAnb25lQnlPbmUnKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgZWwgPSBhd2FpdCBkcml2ZXIuZmluZEVsZW1lbnQoJ2NsYXNzIG5hbWUnLCAnVUlBVGV4dEZpZWxkJyk7XG4gICAgICAgIGF3YWl0IGRyaXZlci5jbGVhcihlbCk7XG4gICAgICAgIGF3YWl0IGRyaXZlci5zZXRWYWx1ZSh0ZXh0LCBlbCk7XG4gICAgICAgIGxldCB0ZXh0MiA9IGF3YWl0IGRyaXZlci5nZXRUZXh0KGVsKTtcbiAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAnZ3JvdXBlZCcpIHtcbiAgICAgICAgICB0ZXh0Mi5sZW5ndGguc2hvdWxkLmJlLmFib3ZlKDApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRleHQyLnNob3VsZC5lcXVhbCh0ZXh0KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH07XG5cbiAgXy5lYWNoKFt1bmRlZmluZWQsICdvbmVCeU9uZScsICdncm91cGVkJywgJ3NldFZhbHVlJ10sIHRlc3QpO1xuXG4gIGRlc2NyaWJlKFwidHlwaW5nXCIsIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgc2Vzc2lvbiA9IHNldHVwKHRoaXMsIGRlc2lyZWQpO1xuICAgIGxldCBkcml2ZXIgPSBzZXNzaW9uLmRyaXZlcjtcblxuICAgIGRlc2NyaWJlKFwic3RhYmlsaXR5IEBza2lwLWNpXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBydW5zID0gMTBcbiAgICAgICAgLCB0ZXh0ID0gJ0RlbGhpIGlzIE5ldyBAQEAgQlJFQUtGQVNULUZPT0QtMDAwMSc7XG5cbiAgICAgIGxldCB0ZXN0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBpdChcInNob3VsZCBzZW5kIGtleXMgdG8gYSB0ZXh0IGZpZWxkXCIsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICBsZXQgZWwgPSBhd2FpdCBkcml2ZXIuZmluZEVsZW1lbnQoJ2NsYXNzIG5hbWUnLCAnVUlBVGV4dEZpZWxkJyk7XG4gICAgICAgICAgYXdhaXQgZHJpdmVyLmNsZWFyKGVsKTtcbiAgICAgICAgICBkcml2ZXIuc2V0VmFsdWUodGV4dCwgZWwpO1xuICAgICAgICAgIChhd2FpdCBkcml2ZXIuZ2V0VGV4dChlbCkpLnNob3VsZC5lcXVhbCh0ZXh0KTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuXG4gICAgICBmb3IgKGxldCBuID0gMDsgbiA8IHJ1bnM7IG4rKykge1xuICAgICAgICBkZXNjcmliZShgc2VuZEtleXMgdGVzdCAke24gKyAxfWAsIHRlc3QpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBzZW5kIGFjY2VudGVkIHRleHQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgdGVzdFRleHQgPSB1bm9ybS5uZmQoXCLDqSDFkiDDuSDhuI1cIik7XG4gICAgICBsZXQgZWxzID0gYXdhaXQgZHJpdmVyLmZpbmRFbGVtZW50cygnY2xhc3MgbmFtZScsICdVSUFUZXh0RmllbGQnKTtcbiAgICAgIGxldCBlbCA9IGVsc1sxXTtcbiAgICAgIGF3YWl0IGRyaXZlci5jbGVhcihlbCk7XG4gICAgICBhd2FpdCBkcml2ZXIuc2V0VmFsdWUodGVzdFRleHQsIGVsKTtcbiAgICAgIChhd2FpdCBkcml2ZXIuZ2V0VGV4dChlbCkpLnNob3VsZC5lcXVhbCh0ZXN0VGV4dCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNlbmQgYmFja3NwYWNlIGtleScsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBlbHMgPSBhd2FpdCBkcml2ZXIuZmluZEVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1VJQVRleHRGaWVsZCcpO1xuICAgICAgbGV0IGVsID0gZWxzWzFdO1xuICAgICAgYXdhaXQgZHJpdmVyLmNsZWFyKGVsKTtcbiAgICAgIGF3YWl0IGRyaXZlci5zZXRWYWx1ZSgnYWJjZCcsIGVsKTtcbiAgICAgIChhd2FpdCBkcml2ZXIuZ2V0VGV4dChlbCkpLnNob3VsZC5lcXVhbCgnYWJjZCcpO1xuICAgICAgYXdhaXQgZHJpdmVyLnNldFZhbHVlKCdcXHVFMDAzXFx1RTAwMycsIGVsKTtcbiAgICAgIChhd2FpdCBkcml2ZXIuZ2V0VGV4dChlbCkpLnNob3VsZC5lcXVhbCgnYWInKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc2VuZCBkZWxldGUga2V5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGVscyA9IGF3YWl0IGRyaXZlci5maW5kRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnVUlBVGV4dEZpZWxkJyk7XG4gICAgICBsZXQgZWwgPSBlbHNbMV07XG4gICAgICBhd2FpdCBkcml2ZXIuY2xlYXIoZWwpO1xuICAgICAgYXdhaXQgZHJpdmVyLnNldFZhbHVlKCdhYmNkJywgZWwpO1xuICAgICAgYXdhaXQgZHJpdmVyLnNldFZhbHVlKCdcXHVlMDE3XFx1ZTAxNycsIGVsKTtcbiAgICAgIChhd2FpdCBkcml2ZXIuZ2V0VGV4dChlbCkpLnNob3VsZC5lcXVhbCgnYWInKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc2VuZCBzaW5nbGUgcXVvdGUgdGV4dCB3aXRoIHNldFZhbHVlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHRlc3RUZXh0ID0gXCInXCI7XG4gICAgICBsZXQgZWxzID0gYXdhaXQgZHJpdmVyLmZpbmRFbGVtZW50cygnY2xhc3MgbmFtZScsICdVSUFUZXh0RmllbGQnKTtcbiAgICAgIGxldCBlbCA9IGVsc1sxXTtcbiAgICAgIGF3YWl0IGRyaXZlci5jbGVhcihlbCk7XG4gICAgICBhd2FpdCBkcml2ZXIuc2V0VmFsdWUodGVzdFRleHQsIGVsKTtcbiAgICAgIChhd2FpdCBkcml2ZXIuZ2V0VGV4dChlbCkpLnNob3VsZC5lcXVhbCh0ZXN0VGV4dCk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBzZW5kIHNpbmdsZSBxdW90ZSB0ZXh0IHdpdGgga2V5cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCB0ZXN0VGV4dCA9IFwiJ1wiO1xuICAgICAgbGV0IGVscyA9IGF3YWl0IGRyaXZlci5maW5kRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnVUlBVGV4dEZpZWxkJyk7XG4gICAgICBsZXQgZWwgPSBlbHNbMV07XG4gICAgICBhd2FpdCBkcml2ZXIuY2xlYXIoZWwpO1xuICAgICAgYXdhaXQgZHJpdmVyLmtleXModGVzdFRleHQpO1xuICAgICAgKGF3YWl0IGRyaXZlci5nZXRUZXh0KGVsKSkuc2hvdWxkLmVxdWFsKHRlc3RUZXh0KTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHNlbmQgdGV4dCB3aXRoIGEgbmV3bGluZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCB0ZXN0VGV4dCA9IFsnbXkgc3RyaW5nXFxuJ107XG4gICAgICBsZXQgZWxzID0gYXdhaXQgZHJpdmVyLmZpbmRFbGVtZW50cygnY2xhc3MgbmFtZScsICdVSUFUZXh0RmllbGQnKTtcbiAgICAgIGxldCBlbCA9IGVsc1sxXTtcbiAgICAgIGF3YWl0IGRyaXZlci5jbGVhcihlbCk7XG4gICAgICBhd2FpdCBkcml2ZXIua2V5cyh0ZXN0VGV4dCk7XG4gICAgICAoYXdhaXQgZHJpdmVyLmdldFRleHQoZWwpKS5zaG91bGQuZXF1YWwoJ215IHN0cmluZycpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9
