require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _2 = require('../../../..');

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumIosSimulator = require('appium-ios-simulator');

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _asyncbox = require('asyncbox');

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

var LAUNCH_HANDLER_TIMEOUT = 10000;
var TEMP_DIR = _path2['default'].resolve(__dirname, 'tmp');

describe('instruments tests', function () {
  this.timeout(90000);

  function newInstrument(opts) {
    return _regeneratorRuntime.async(function newInstrument$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          _lodash2['default'].extend(opts, {
            app: _path2['default'].resolve(__dirname, '..', '..', '..', 'assets', 'TestApp.app'),
            bootstrap: _path2['default'].resolve(__dirname, '..', 'assets', 'bootstrap.js'),
            simulatorSdkAndDevice: 'iPhone 6 (9.3)'
          });
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(_2.Instruments.quickInstruments(opts));

        case 3:
          return context$2$0.abrupt('return', context$2$0.sent);

        case 4:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  }

  function test(appendDesc, opts) {
    var _this = this;

    var checks = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

    checks = checks || {};
    var instruments = undefined;

    it('should launch' + appendDesc, function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.killAllSimulators)());

          case 2:
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(newInstrument(opts));

          case 4:
            instruments = context$3$0.sent;

            if (!checks.afterCreate) {
              context$3$0.next = 8;
              break;
            }

            context$3$0.next = 8;
            return _regeneratorRuntime.awrap(checks.afterCreate(instruments));

          case 8:
            setTimeout(function () {
              if (instruments.launchResultDeferred) {
                instruments.launchResultDeferred.resolve();
              }
            }, LAUNCH_HANDLER_TIMEOUT);
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(instruments.launch());

          case 11:
            if (!checks.afterLaunch) {
              context$3$0.next = 14;
              break;
            }

            context$3$0.next = 14;
            return _regeneratorRuntime.awrap(checks.afterLaunch(instruments));

          case 14:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should shutdown' + appendDesc, function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(instruments.shutdown());

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
  }

  describe('regular timeout', function () {
    test('', { launchTimeout: 60000 });
  });

  describe('smart timeout', function () {
    test('', { launchTimeout: { global: 60000, afterSimLaunch: 10000 } });
  });

  describe.skip("using different tmp dir", function () {
    var _this2 = this;

    var altTmpDir = _path2['default'].resolve(TEMP_DIR, 'abcd');

    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.prev = 0;
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(TEMP_DIR));

          case 3:
            context$3$0.next = 7;
            break;

          case 5:
            context$3$0.prev = 5;
            context$3$0.t0 = context$3$0['catch'](0);

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(altTmpDir));

          case 9:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this, [[0, 5]]);
    });

    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(TEMP_DIR));

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    test(" (1)", {
      launchTimeout: { global: 60000, afterSimLaunch: 10000 },
      tmpDir: altTmpDir
    }, {
      afterCreate: function afterCreate(instruments) {
        instruments.tmpDir.should.equal(altTmpDir);
      },
      afterLaunch: function afterLaunch() {
        return _regeneratorRuntime.async(function afterLaunch$(context$3$0) {
          while (1) switch (context$3$0.prev = context$3$0.next) {
            case 0:
              context$3$0.next = 2;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(altTmpDir));

            case 2:
              context$3$0.sent.should.be.ok;
              context$3$0.next = 5;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(_path2['default'].resolve(altTmpDir, 'instrumentscli0.trace')));

            case 5:
              context$3$0.sent.should.be.ok;

            case 6:
            case 'end':
              return context$3$0.stop();
          }
        }, null, _this2);
      }
    });

    //test(" (2)", {
    //launchTimeout: {global: 60000, afterSimLaunch: 10000},
    //tmpDir: altTmpDir
    //}, {
    //afterCreate: function (instruments) { instruments.tmpDir.should.equal(altTmpDir); },
    //afterLaunch: async function () {
    //(await fs.exists(altTmpDir)).should.be.ok;
    //// tmp dir is deleted at startup so trace file is not incremented
    //(await fs.exists(path.resolve(altTmpDir, 'instrumentscli0.trace'))).should.be.ok;
    //}
    //});
  });

  describe.skip("using different trace dir", function () {
    var _this3 = this;

    var altTraceDir = _path2['default'].resolve(TEMP_DIR, 'abcd');

    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.prev = 0;
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(TEMP_DIR));

          case 3:
            context$3$0.next = 7;
            break;

          case 5:
            context$3$0.prev = 5;
            context$3$0.t0 = context$3$0['catch'](0);

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(altTraceDir));

          case 9:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this, [[0, 5]]);
    });

    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(TEMP_DIR));

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    test(" (1)", {
      launchTimeout: { global: 60000, afterSimLaunch: 10000 },
      traceDir: altTraceDir
    }, {
      afterCreate: function afterCreate(instruments) {
        instruments.tmpDir.should.equal('/tmp/appium-instruments');
      },
      afterLaunch: function afterLaunch() {
        return _regeneratorRuntime.async(function afterLaunch$(context$3$0) {
          while (1) switch (context$3$0.prev = context$3$0.next) {
            case 0:
              context$3$0.next = 2;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(altTraceDir));

            case 2:
              context$3$0.sent.should.be.ok;
              context$3$0.next = 5;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(_path2['default'].resolve(altTraceDir, 'instrumentscli0.trace')));

            case 5:
              context$3$0.sent.should.be.ok;

            case 6:
            case 'end':
              return context$3$0.stop();
          }
        }, null, _this3);
      }
    });

    test(" (2)", {
      launchTimeout: { global: 60000, afterSimLaunch: 10000 },
      traceDir: altTraceDir
    }, {
      afterCreate: function afterCreate(instruments) {
        instruments.tmpDir.should.equal('/tmp/appium-instruments');
      },
      afterLaunch: function afterLaunch() {
        return _regeneratorRuntime.async(function afterLaunch$(context$3$0) {
          while (1) switch (context$3$0.prev = context$3$0.next) {
            case 0:
              context$3$0.next = 2;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(altTraceDir));

            case 2:
              context$3$0.sent.should.be.ok;
              context$3$0.next = 5;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(_path2['default'].resolve(altTraceDir, 'instrumentscli1.trace')));

            case 5:
              context$3$0.sent.should.be.ok;

            case 6:
            case 'end':
              return context$3$0.stop();
          }
        }, null, _this3);
      }
    });
  });

  describe("shutdown without startup", function () {
    it('should launch', function callee$2$0() {
      var instruments;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.killAllSimulators)());

          case 2:
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(newInstrument({ launchTimeout: 60000 }));

          case 4:
            instruments = context$3$0.sent;
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(instruments.shutdown());

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
  });

  describe('getting devices', function () {
    var _this4 = this;

    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.killAllSimulators)());

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this4);
    });

    it('should get all available devices', function callee$2$0() {
      var iosVer, _ref, stdout, devices;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            iosVer = undefined;
            context$3$0.prev = 1;
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', ['--sdk', 'iphonesimulator', '--show-sdk-version']));

          case 4:
            _ref = context$3$0.sent;
            stdout = _ref.stdout;

            iosVer = parseFloat(stdout);
            context$3$0.next = 11;
            break;

          case 9:
            context$3$0.prev = 9;
            context$3$0.t0 = context$3$0['catch'](1);

          case 11:
            if (_lodash2['default'].isNumber(iosVer) || isNaN(iosVer)) {
              console.warn('Could not get iOS sdk version, skipping test'); // eslint-disable-line no-console
              this.skip();
            }
            context$3$0.next = 14;
            return _regeneratorRuntime.awrap((0, _asyncbox.retry)(3, _2.instrumentsUtils.getAvailableDevices));

          case 14:
            devices = context$3$0.sent;

            if (iosVer >= 7.1) {
              devices.length.should.be.above(0);
              devices.join('\n').should.include('iPhone 6 (8.4');
            } else {
              devices.length.should.equal(0);
            }

          case 16:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this, [[1, 9]]);
    });
  });
});

// travis can't write to /tmp, so let's create a tmp directory

// travis can't write to /tmp, so let's create a tmp directory
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZTJlL2RyaXZlci9pbnN0cnVtZW50cy9iYXNpY3MtZTJlLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O2lCQUU4QyxhQUFhOztvQkFDMUMsTUFBTTs7Ozs4QkFDSSxrQkFBa0I7Ozs7b0JBQzVCLE1BQU07Ozs7c0JBQ1QsUUFBUTs7OztrQ0FDWSxzQkFBc0I7OzZCQUNyQyxnQkFBZ0I7OzRCQUNkLGNBQWM7O3dCQUNiLFVBQVU7O0FBRWhDLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQ2Qsa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQzs7QUFFekIsSUFBSSxzQkFBc0IsR0FBRyxLQUFLLENBQUM7QUFDbkMsSUFBSSxRQUFRLEdBQUcsa0JBQUssT0FBTyxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQzs7QUFFOUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFLFlBQVk7QUFDeEMsTUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQzs7QUFFcEIsV0FBZSxhQUFhLENBQUUsSUFBSTs7OztBQUNoQyw4QkFBRSxNQUFNLENBQUMsSUFBSSxFQUFFO0FBQ2IsZUFBRyxFQUFFLGtCQUFLLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLGFBQWEsQ0FBQztBQUN2RSxxQkFBUyxFQUFFLGtCQUFLLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxjQUFjLENBQUM7QUFDbEUsaUNBQXFCLEVBQUUsZ0JBQWdCO1dBQ3hDLENBQUMsQ0FBQzs7MkNBQ1UsZUFBWSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUM7Ozs7Ozs7Ozs7R0FDaEQ7O0FBRUQsV0FBUyxJQUFJLENBQUUsVUFBVSxFQUFFLElBQUksRUFBZTs7O1FBQWIsTUFBTSx5REFBRyxFQUFFOztBQUMxQyxVQUFNLEdBQUcsTUFBTSxJQUFJLEVBQUUsQ0FBQztBQUN0QixRQUFJLFdBQVcsWUFBQSxDQUFD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cEQsTUFBTTtBQUNMLHFCQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDaEM7Ozs7Ozs7S0FDRixDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC9lMmUvZHJpdmVyL2luc3RydW1lbnRzL2Jhc2ljcy1lMmUtc3BlY3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0cmFuc3BpbGU6bW9jaGFcblxuaW1wb3J0IHsgSW5zdHJ1bWVudHMsIGluc3RydW1lbnRzVXRpbHMgfSBmcm9tICcuLi8uLi8uLi8uLic7XG5pbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGtpbGxBbGxTaW11bGF0b3JzIH0gZnJvbSAnYXBwaXVtLWlvcy1zaW11bGF0b3InO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IHJldHJ5IH0gZnJvbSAnYXN5bmNib3gnO1xuXG5jaGFpLnNob3VsZCgpO1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG52YXIgTEFVTkNIX0hBTkRMRVJfVElNRU9VVCA9IDEwMDAwO1xudmFyIFRFTVBfRElSID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ3RtcCcpO1xuXG5kZXNjcmliZSgnaW5zdHJ1bWVudHMgdGVzdHMnLCBmdW5jdGlvbiAoKSB7XG4gIHRoaXMudGltZW91dCg5MDAwMCk7XG5cbiAgYXN5bmMgZnVuY3Rpb24gbmV3SW5zdHJ1bWVudCAob3B0cykge1xuICAgIF8uZXh0ZW5kKG9wdHMsIHtcbiAgICAgIGFwcDogcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJy4uJywgJ2Fzc2V0cycsICdUZXN0QXBwLmFwcCcpLFxuICAgICAgYm9vdHN0cmFwOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnYXNzZXRzJywgJ2Jvb3RzdHJhcC5qcycpLFxuICAgICAgc2ltdWxhdG9yU2RrQW5kRGV2aWNlOiAnaVBob25lIDYgKDkuMyknXG4gICAgfSk7XG4gICAgcmV0dXJuIGF3YWl0IEluc3RydW1lbnRzLnF1aWNrSW5zdHJ1bWVudHMob3B0cyk7XG4gIH1cblxuICBmdW5jdGlvbiB0ZXN0IChhcHBlbmREZXNjLCBvcHRzLCBjaGVja3MgPSB7fSkge1xuICAgIGNoZWNrcyA9IGNoZWNrcyB8fCB7fTtcbiAgICBsZXQgaW5zdHJ1bWVudHM7XG5cbiAgICBpdChgc2hvdWxkIGxhdW5jaCR7YXBwZW5kRGVzY31gLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBraWxsQWxsU2ltdWxhdG9ycygpO1xuICAgICAgaW5zdHJ1bWVudHMgPSBhd2FpdCBuZXdJbnN0cnVtZW50KG9wdHMpO1xuICAgICAgaWYgKGNoZWNrcy5hZnRlckNyZWF0ZSkge1xuICAgICAgICBhd2FpdCBjaGVja3MuYWZ0ZXJDcmVhdGUoaW5zdHJ1bWVudHMpO1xuICAgICAgfVxuICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmIChpbnN0cnVtZW50cy5sYXVuY2hSZXN1bHREZWZlcnJlZCkge1xuICAgICAgICAgIGluc3RydW1lbnRzLmxhdW5jaFJlc3VsdERlZmVycmVkLnJlc29sdmUoKTtcbiAgICAgICAgfVxuICAgICAgfSwgTEFVTkNIX0hBTkRMRVJfVElNRU9VVCk7XG4gICAgICBhd2FpdCBpbnN0cnVtZW50cy5sYXVuY2goKTtcbiAgICAgIGlmIChjaGVja3MuYWZ0ZXJMYXVuY2gpIHtcbiAgICAgICAgYXdhaXQgY2hlY2tzLmFmdGVyTGF1bmNoKGluc3RydW1lbnRzKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGl0KGBzaG91bGQgc2h1dGRvd24ke2FwcGVuZERlc2N9YCwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgYXdhaXQgaW5zdHJ1bWVudHMuc2h1dGRvd24oKTtcbiAgICB9KTtcbiAgfVxuXG4gIGRlc2NyaWJlKCdyZWd1bGFyIHRpbWVvdXQnLCBmdW5jdGlvbiAoKSB7XG4gICAgdGVzdCgnJywge2xhdW5jaFRpbWVvdXQ6IDYwMDAwfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzbWFydCB0aW1lb3V0JywgZnVuY3Rpb24gKCkge1xuICAgIHRlc3QoJycsIHtsYXVuY2hUaW1lb3V0OiB7Z2xvYmFsOiA2MDAwMCwgYWZ0ZXJTaW1MYXVuY2g6IDEwMDAwfX0pO1xuICB9KTtcblxuICBkZXNjcmliZS5za2lwKFwidXNpbmcgZGlmZmVyZW50IHRtcCBkaXJcIiwgZnVuY3Rpb24gKCkge1xuICAgIGxldCBhbHRUbXBEaXIgPSBwYXRoLnJlc29sdmUoVEVNUF9ESVIsICdhYmNkJyk7XG5cbiAgICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgLy8gdHJhdmlzIGNhbid0IHdyaXRlIHRvIC90bXAsIHNvIGxldCdzIGNyZWF0ZSBhIHRtcCBkaXJlY3RvcnlcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZzLm1rZGlyKFRFTVBfRElSKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHt9XG5cbiAgICAgIGF3YWl0IGZzLnJpbXJhZihhbHRUbXBEaXIpO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXIoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKFRFTVBfRElSKTtcbiAgICB9KTtcblxuICAgIHRlc3QoXCIgKDEpXCIsIHtcbiAgICAgIGxhdW5jaFRpbWVvdXQ6IHtnbG9iYWw6IDYwMDAwLCBhZnRlclNpbUxhdW5jaDogMTAwMDB9LFxuICAgICAgdG1wRGlyOiBhbHRUbXBEaXJcbiAgICB9LCB7XG4gICAgICBhZnRlckNyZWF0ZTogKGluc3RydW1lbnRzKSA9PiB7IGluc3RydW1lbnRzLnRtcERpci5zaG91bGQuZXF1YWwoYWx0VG1wRGlyKTsgfSxcbiAgICAgIGFmdGVyTGF1bmNoOiBhc3luYyAoKSA9PiB7XG4gICAgICAgIChhd2FpdCBmcy5leGlzdHMoYWx0VG1wRGlyKSkuc2hvdWxkLmJlLm9rO1xuICAgICAgICAoYXdhaXQgZnMuZXhpc3RzKHBhdGgucmVzb2x2ZShhbHRUbXBEaXIsICdpbnN0cnVtZW50c2NsaTAudHJhY2UnKSkpLnNob3VsZC5iZS5vaztcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vdGVzdChcIiAoMilcIiwge1xuICAgICAgLy9sYXVuY2hUaW1lb3V0OiB7Z2xvYmFsOiA2MDAwMCwgYWZ0ZXJTaW1MYXVuY2g6IDEwMDAwfSxcbiAgICAgIC8vdG1wRGlyOiBhbHRUbXBEaXJcbiAgICAvL30sIHtcbiAgICAgIC8vYWZ0ZXJDcmVhdGU6IGZ1bmN0aW9uIChpbnN0cnVtZW50cykgeyBpbnN0cnVtZW50cy50bXBEaXIuc2hvdWxkLmVxdWFsKGFsdFRtcERpcik7IH0sXG4gICAgICAvL2FmdGVyTGF1bmNoOiBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgIC8vKGF3YWl0IGZzLmV4aXN0cyhhbHRUbXBEaXIpKS5zaG91bGQuYmUub2s7XG4gICAgICAgIC8vLy8gdG1wIGRpciBpcyBkZWxldGVkIGF0IHN0YXJ0dXAgc28gdHJhY2UgZmlsZSBpcyBub3QgaW5jcmVtZW50ZWRcbiAgICAgICAgLy8oYXdhaXQgZnMuZXhpc3RzKHBhdGgucmVzb2x2ZShhbHRUbXBEaXIsICdpbnN0cnVtZW50c2NsaTAudHJhY2UnKSkpLnNob3VsZC5iZS5vaztcbiAgICAgIC8vfVxuICAgIC8vfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlLnNraXAoXCJ1c2luZyBkaWZmZXJlbnQgdHJhY2UgZGlyXCIsIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgYWx0VHJhY2VEaXIgPSBwYXRoLnJlc29sdmUoVEVNUF9ESVIsICdhYmNkJyk7XG5cbiAgICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgLy8gdHJhdmlzIGNhbid0IHdyaXRlIHRvIC90bXAsIHNvIGxldCdzIGNyZWF0ZSBhIHRtcCBkaXJlY3RvcnlcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZzLm1rZGlyKFRFTVBfRElSKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHt9XG5cbiAgICAgIGF3YWl0IGZzLnJpbXJhZihhbHRUcmFjZURpcik7XG4gICAgfSk7XG5cbiAgICBhZnRlcihhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYoVEVNUF9ESVIpO1xuICAgIH0pO1xuXG4gICAgdGVzdChcIiAoMSlcIiwge1xuICAgICAgbGF1bmNoVGltZW91dDoge2dsb2JhbDogNjAwMDAsIGFmdGVyU2ltTGF1bmNoOiAxMDAwMH0sXG4gICAgICB0cmFjZURpcjogYWx0VHJhY2VEaXJcbiAgICB9LCB7XG4gICAgICBhZnRlckNyZWF0ZTogKGluc3RydW1lbnRzKSA9PiB7XG4gICAgICAgIGluc3RydW1lbnRzLnRtcERpci5zaG91bGQuZXF1YWwoJy90bXAvYXBwaXVtLWluc3RydW1lbnRzJyk7XG4gICAgICB9LFxuICAgICAgYWZ0ZXJMYXVuY2g6IGFzeW5jICgpID0+IHtcbiAgICAgICAgKGF3YWl0IGZzLmV4aXN0cyhhbHRUcmFjZURpcikpLnNob3VsZC5iZS5vaztcbiAgICAgICAgKGF3YWl0IGZzLmV4aXN0cyhwYXRoLnJlc29sdmUoYWx0VHJhY2VEaXIsICdpbnN0cnVtZW50c2NsaTAudHJhY2UnKSkpXG4gICAgICAgICAgLnNob3VsZC5iZS5vaztcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRlc3QoXCIgKDIpXCIsIHtcbiAgICAgIGxhdW5jaFRpbWVvdXQ6IHtnbG9iYWw6IDYwMDAwLCBhZnRlclNpbUxhdW5jaDogMTAwMDB9LFxuICAgICAgdHJhY2VEaXI6IGFsdFRyYWNlRGlyXG4gICAgfSwge1xuICAgICAgYWZ0ZXJDcmVhdGU6IChpbnN0cnVtZW50cykgPT4ge1xuICAgICAgICBpbnN0cnVtZW50cy50bXBEaXIuc2hvdWxkLmVxdWFsKCcvdG1wL2FwcGl1bS1pbnN0cnVtZW50cycpO1xuICAgICAgfSxcbiAgICAgIGFmdGVyTGF1bmNoOiBhc3luYyAoKSA9PiB7XG4gICAgICAgIChhd2FpdCBmcy5leGlzdHMoYWx0VHJhY2VEaXIpKS5zaG91bGQuYmUub2s7XG4gICAgICAgIChhd2FpdCBmcy5leGlzdHMocGF0aC5yZXNvbHZlKGFsdFRyYWNlRGlyLCAnaW5zdHJ1bWVudHNjbGkxLnRyYWNlJykpKVxuICAgICAgICAgIC5zaG91bGQuYmUub2s7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKFwic2h1dGRvd24gd2l0aG91dCBzdGFydHVwXCIsIGZ1bmN0aW9uICgpIHtcbiAgICBpdCgnc2hvdWxkIGxhdW5jaCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGF3YWl0IGtpbGxBbGxTaW11bGF0b3JzKCk7XG4gICAgICBsZXQgaW5zdHJ1bWVudHMgPSBhd2FpdCBuZXdJbnN0cnVtZW50KHtsYXVuY2hUaW1lb3V0OiA2MDAwMH0pO1xuICAgICAgYXdhaXQgaW5zdHJ1bWVudHMuc2h1dGRvd24oKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dldHRpbmcgZGV2aWNlcycsIGZ1bmN0aW9uICgpIHtcbiAgICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQga2lsbEFsbFNpbXVsYXRvcnMoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZ2V0IGFsbCBhdmFpbGFibGUgZGV2aWNlcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpb3NWZXI7XG4gICAgICB0cnkge1xuICAgICAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKCd4Y3J1bicsIFsnLS1zZGsnLCAnaXBob25lc2ltdWxhdG9yJywgJy0tc2hvdy1zZGstdmVyc2lvbiddKTtcbiAgICAgICAgaW9zVmVyID0gcGFyc2VGbG9hdChzdGRvdXQpO1xuICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgICAgaWYgKF8uaXNOdW1iZXIoaW9zVmVyKSB8fCBpc05hTihpb3NWZXIpKSB7XG4gICAgICAgIGNvbnNvbGUud2FybignQ291bGQgbm90IGdldCBpT1Mgc2RrIHZlcnNpb24sIHNraXBwaW5nIHRlc3QnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlXG4gICAgICAgIHRoaXMuc2tpcCgpO1xuICAgICAgfVxuICAgICAgbGV0IGRldmljZXMgPSBhd2FpdCByZXRyeSgzLCBpbnN0cnVtZW50c1V0aWxzLmdldEF2YWlsYWJsZURldmljZXMpO1xuICAgICAgaWYgKGlvc1ZlciA+PSA3LjEpIHtcbiAgICAgICAgZGV2aWNlcy5sZW5ndGguc2hvdWxkLmJlLmFib3ZlKDApO1xuICAgICAgICBkZXZpY2VzLmpvaW4oJ1xcbicpLnNob3VsZC5pbmNsdWRlKCdpUGhvbmUgNiAoOC40Jyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkZXZpY2VzLmxlbmd0aC5zaG91bGQuZXF1YWwoMCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uLy4uIn0=
