'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _2 = require('../../../..');

var _3 = require('../../../../');

var _libUiautoLogger = require('../../../../lib/uiauto/logger');

var _libUiautoLogger2 = _interopRequireDefault(_libUiautoLogger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

_chai2['default'].use(_chaiAsPromised2['default']);
_chai2['default'].should();

process.env.APPIUM_BOOTSTRAP_DIR = '/tmp/appium-uiauto/test/functional/bootstrap';

var rootDir = _path2['default'].resolve(__dirname, '..', '..');
if (!__dirname.match(/build\/test\/unit\/uiauto$/)) {
  // we are not running tests in the `build` directory
  rootDir = _path2['default'].resolve(__dirname, '..', '..', '..', '..', '..');
}

function localPrepareBootstrap() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  var env, postImports, code, vars, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, key, value;

  return _regeneratorRuntime.async(function localPrepareBootstrap$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(opts.bootstrap === 'basic')) {
          context$1$0.next = 33;
          break;
        }

        env = _2.uiauto.getEnv();
        postImports = [];

        if (opts.imports && opts.imports.post) {
          postImports = opts.imports.post;
        }
        postImports = postImports.map(function (item) {
          return '#import "' + _path2['default'].resolve(rootDir, item) + '"';
        });
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(_path2['default'].resolve(rootDir, 'test', 'assets', 'base-bootstrap.js'), 'utf8'));

      case 7:
        code = context$1$0.sent;
        vars = {
          '<ROOT_DIR>': rootDir,
          '"<POST_IMPORTS>"': postImports.join('\n'),
          '<commandProxyClientPath>': env.commandProxyClientPath,
          '<nodePath>': env.nodePath,
          '<instrumentsSock>': env.instrumentsSock
        };
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 12;

        for (_iterator = _getIterator(_lodash2['default'].toPairs(vars)); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          _step$value = _slicedToArray(_step.value, 2);
          key = _step$value[0];
          value = _step$value[1];

          code = code.replace(new RegExp(key, 'g'), value);
        }
        context$1$0.next = 20;
        break;

      case 16:
        context$1$0.prev = 16;
        context$1$0.t0 = context$1$0['catch'](12);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 20:
        context$1$0.prev = 20;
        context$1$0.prev = 21;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 23:
        context$1$0.prev = 23;

        if (!_didIteratorError) {
          context$1$0.next = 26;
          break;
        }

        throw _iteratorError;

      case 26:
        return context$1$0.finish(23);

      case 27:
        return context$1$0.finish(20);

      case 28:
        context$1$0.next = 30;
        return _regeneratorRuntime.awrap(_2.uiauto.prepareBootstrap({
          code: code,
          isVerbose: true
        }));

      case 30:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 33:
        opts = _lodash2['default'].clone(opts);
        if (opts.chai) {
          opts.imports = {
            pre: [_path2['default'].resolve(rootDir, 'node_modules/chai/chai.js')]
          };
        }
        delete opts.chai;
        context$1$0.next = 38;
        return _regeneratorRuntime.awrap(_2.uiauto.prepareBootstrap(opts));

      case 38:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 39:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[12, 16, 20, 28], [21,, 23, 27]]);
}

function newInstruments(bootstrapFile) {
  return _regeneratorRuntime.async(function newInstruments$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_3.instrumentsUtils.quickInstruments({
          app: _path2['default'].resolve(rootDir, 'test', 'assets', 'UICatalog.app'),
          bootstrap: bootstrapFile,
          simulatorSdkAndDevice: 'iPhone 6 (9.3)',
          launchTries: 2,
          withoutDelay: false
        }));

      case 2:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function init(bootstrapFile, sock) {
  var proxy, instruments;
  return _regeneratorRuntime.async(function init$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        proxy = new _2.uiauto.UIAutoClient(sock);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(newInstruments(bootstrapFile));

      case 3:
        instruments = context$1$0.sent;

        instruments.onShutdown.then(function () {
          // expected shutdown, nothing to do
        })['catch'](function callee$1$0(err) {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                _libUiautoLogger2['default'].error(err);
                context$2$0.next = 3;
                return _regeneratorRuntime.awrap(proxy.safeShutdown());

              case 3:
                throw new Error('Unexpected shutdown of instruments');

              case 4:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        }).done();
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_bluebird2['default'].all([proxy.start().then(function () {
          // everything looks good, notify instruments.
          instruments.registerLaunch();
        }), instruments.launch()]));

      case 7:
        return context$1$0.abrupt('return', { proxy: proxy, instruments: instruments });

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function killAll(ctx) {
  return _regeneratorRuntime.async(function killAll$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(ctx.instruments.shutdown());

      case 3:
        context$1$0.next = 8;
        break;

      case 5:
        context$1$0.prev = 5;
        context$1$0.t0 = context$1$0['catch'](0);

        // pass
        _libUiautoLogger2['default'].error(context$1$0.t0);

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_3.instrumentsUtils.killAllInstruments());

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(ctx.proxy.safeShutdown());

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 5]]);
}

var bootstrapFile = undefined;

function globalInit(ctx, opts) {
  return _regeneratorRuntime.async(function globalInit$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        ctx.timeout(240000);
        before(function callee$1$0() {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(localPrepareBootstrap(opts));

              case 2:
                bootstrapFile = context$2$0.sent;

              case 3:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this2);
        });

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function instrumentsInstanceInit() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
  var ctx, cmd;
  return _regeneratorRuntime.async(function instrumentsInstanceInit$(context$1$0) {
    var _this3 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(init(bootstrapFile, opts.sock));

      case 2:
        ctx = context$1$0.sent;

        ctx.sendCommand = function callee$1$0(cmd) {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                return context$2$0.abrupt('return', ctx.proxy.sendCommand(cmd));

              case 1:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this3);
        };
        ctx.exec = ctx.sendCommand;

        ctx.execFunc = function callee$1$0(func, params) {
          var script;
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                params = params || [];
                script = '(function (){\n' + ('  var params = JSON.parse(\'' + JSON.stringify(params) + '\');\n') + ('  return (' + func.toString() + ').apply(null, params);\n') + '})();';
                return context$2$0.abrupt('return', ctx.exec(script));

              case 3:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this3);
        };

        cmd = '$.isVerbose = ' + (process.env.VERBOSE ? true : false) + ';\n';
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(ctx.exec(cmd));

      case 9:
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(ctx.execFunc(function () {
          /* global rootPage:true */
          rootPage = {};
          // click item in root page menu
          rootPage.clickMenuItem = function (partialText) {
            $.each($('tableview').children(), function (idx, child) {
              if (child.name().indexOf(partialText) >= 0) {
                $(child).tap();
                return false;
              }
            });
          };
        }));

      case 11:
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(ctx.execFunc(function () {
          /* global $ */
          $.delay(500);
          while (!$('tableview').isVisible()) {
            $.warn('waiting for page to load');
            $.delay(500);
          }
        }));

      case 13:
        return context$1$0.abrupt('return', ctx);

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.instrumentsInstanceInit = instrumentsInstanceInit;
exports.globalInit = globalInit;
exports.killAll = killAll;

// some uiauto helpers
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZTJlL2RyaXZlci91aWF1dG8vYmFzZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztvQkFBaUIsTUFBTTs7Ozs4QkFDSSxrQkFBa0I7Ozs7d0JBQy9CLFVBQVU7Ozs7aUJBQ0QsYUFBYTs7aUJBQ0gsY0FBYzs7K0JBQy9CLCtCQUErQjs7OztzQkFDakMsUUFBUTs7OztvQkFDTCxNQUFNOzs7OzZCQUNKLGdCQUFnQjs7QUFHbkMsa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQztBQUN6QixrQkFBSyxNQUFNLEVBQUUsQ0FBQzs7QUFFZCxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixHQUFHLDhDQUE4QyxDQUFDOztBQUVsRixJQUFJLE9BQU8sR0FBRyxrQkFBSyxPQUFPLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztBQUNsRCxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsQ0FBQyxFQUFFOztBQUVsRCxTQUFPLEdBQUcsa0JBQUssT0FBTyxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7Q0FDakU7O0FBRUQsU0FBZSxxQkFBcUI7TUFBRSxJQUFJLHlEQUFHLEVBQUU7O01BRXZDLEdBQUcsRUFDSCxXQUFXLEVBT1gsSUFBSSxFQUVKLElBQUksK0ZBT0UsR0FBRyxFQUFFLEtBQUs7Ozs7O2NBbEJsQixJQUFJLENBQUMsU0FBUyxLQUFLLE9BQU8sQ0FBQTs7Ozs7QUFDeEIsV0FBRyxHQUFHLFVBQU8sTUFBTSxFQUFFO0FBQ3JCLG1CQUFXLEdBQUcsRUFBRTs7QUFDcEIsWUFBSSxJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFO0FBQ3JDLHFCQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7U0FDakM7QUFDRCxtQkFBVyxHQUFHLFdBQVcsQ0FB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LENBQUMsR0FBRyxDQUFDLE9BQU8sR0FBRyxJQUFJLEdBQUcsS0FBSyxDQUFBOzt5Q0FDdkQsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7Ozs7eUNBR2IsR0FBRyxDQUFDLFFBQVEsQ0FBQyxZQUFZOztBQUU3QixrQkFBUSxHQUFHLEVBQUUsQ0FBQzs7QUFFZCxrQkFBUSxDQUFDLGFBQWEsR0FBRyxVQUFVLFdBQVcsRUFBRTtBQUM5QyxhQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxVQUFVLEdBQUcsRUFBRSxLQUFLLEVBQUU7QUFDdEQsa0JBQUksS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUU7QUFDMUMsaUJBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUNmLHVCQUFPLEtBQUssQ0FBQztlQUNkO2FBQ0YsQ0FBQyxDQUFDO1dBQ0osQ0FBQztTQUNILENBQUM7Ozs7eUNBRUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxZQUFZOztBQUU3QixXQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2IsaUJBQU8sQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUU7QUFDbEMsYUFBQyxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBQ25DLGFBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7V0FDZDtTQUNGLENBQUM7Ozs0Q0FFSyxHQUFHOzs7Ozs7O0NBQ1g7O1FBRVEsdUJBQXVCLEdBQXZCLHVCQUF1QjtRQUFFLFVBQVUsR0FBVixVQUFVO1FBQUUsT0FBTyxHQUFQLE9BQU8iLCJmaWxlIjoidGVzdC9lMmUvZHJpdmVyL3VpYXV0by9iYXNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyB1aWF1dG8gfSBmcm9tICcuLi8uLi8uLi8uLic7XG5pbXBvcnQgeyBpbnN0cnVtZW50c1V0aWxzIH0gZnJvbSAnLi4vLi4vLi4vLi4vJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vLi4vLi4vLi4vbGliL3VpYXV0by9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cblxuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuY2hhaS5zaG91bGQoKTtcblxucHJvY2Vzcy5lbnYuQVBQSVVNX0JPT1RTVFJBUF9ESVIgPSAnL3RtcC9hcHBpdW0tdWlhdXRvL3Rlc3QvZnVuY3Rpb25hbC9ib290c3RyYXAnO1xuXG5sZXQgcm9vdERpciA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicpO1xuaWYgKCFfX2Rpcm5hbWUubWF0Y2goL2J1aWxkXFwvdGVzdFxcL3VuaXRcXC91aWF1dG8kLykpIHtcbiAgLy8gd2UgYXJlIG5vdCBydW5uaW5nIHRlc3RzIGluIHRoZSBgYnVpbGRgIGRpcmVjdG9yeVxuICByb290RGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJy4uJywgJy4uJywgJy4uJyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvY2FsUHJlcGFyZUJvb3RzdHJhcCAob3B0cyA9IHt9KSB7XG4gIGlmIChvcHRzLmJvb3RzdHJhcCA9PT0gJ2Jhc2ljJykge1xuICAgIGxldCBlbnYgPSB1aWF1dG8uZ2V0RW52KCk7XG4gICAgbGV0IHBvc3RJbXBvcnRzID0gW107XG4gICAgaWYgKG9wdHMuaW1wb3J0cyAmJiBvcHRzLmltcG9ydHMucG9zdCkge1xuICAgICAgcG9zdEltcG9ydHMgPSBvcHRzLmltcG9ydHMucG9zdDtcbiAgICB9XG4gICAgcG9zdEltcG9ydHMgPSBwb3N0SW1wb3J0cy5tYXAoKGl0ZW0pID0+IHtcbiAgICAgIHJldHVybiBgI2ltcG9ydCBcIiR7cGF0aC5yZXNvbHZlKHJvb3REaXIgLCBpdGVtKX1cImA7XG4gICAgfSk7XG4gICAgbGV0IGNvZGUgPSBhd2FpdCBmcy5yZWFkRmlsZShwYXRoLnJlc29sdmUoXG4gICAgICByb290RGlyLCAndGVzdCcsICdhc3NldHMnLCAnYmFzZS1ib290c3RyYXAuanMnKSwgJ3V0ZjgnKTtcbiAgICBsZXQgdmFycyA9IHtcbiAgICAgICc8Uk9PVF9ESVI+Jzogcm9vdERpcixcbiAgICAgICdcIjxQT1NUX0lNUE9SVFM+XCInOiBwb3N0SW1wb3J0cy5qb2luKCdcXG4nKSxcbiAgICAgICc8Y29tbWFuZFByb3h5Q2xpZW50UGF0aD4nOiBlbnYuY29tbWFuZFByb3h5Q2xpZW50UGF0aCxcbiAgICAgICc8bm9kZVBhdGg+JzogZW52Lm5vZGVQYXRoLFxuICAgICAgJzxpbnN0cnVtZW50c1NvY2s+JzogZW52Lmluc3RydW1lbnRzU29ja1xuICAgIH07XG4gICAgZm9yIChsZXQgW2tleSwgdmFsdWVdIG9mIF8udG9QYWlycyh2YXJzKSkge1xuICAgICAgY29kZSA9IGNvZGUucmVwbGFjZShuZXcgUmVnRXhwKGtleSwgJ2cnKSwgdmFsdWUpO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgdWlhdXRvLnByZXBhcmVCb290c3RyYXAoe1xuICAgICAgY29kZTogY29kZSxcbiAgICAgIGlzVmVyYm9zZTogdHJ1ZVxuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIG9wdHMgPSBfLmNsb25lKG9wdHMpO1xuICAgIGlmIChvcHRzLmNoYWkpIHtcbiAgICAgIG9wdHMuaW1wb3J0cyA9IHtcbiAgICAgICAgcHJlOiBbcGF0aC5yZXNvbHZlKHJvb3REaXIsICdub2RlX21vZHVsZXMvY2hhaS9jaGFpLmpzJyldXG4gICAgICB9O1xuICAgIH1cbiAgICBkZWxldGUgb3B0cy5jaGFpO1xuICAgIHJldHVybiBhd2FpdCB1aWF1dG8ucHJlcGFyZUJvb3RzdHJhcChvcHRzKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBuZXdJbnN0cnVtZW50cyAoYm9vdHN0cmFwRmlsZSkge1xuICByZXR1cm4gYXdhaXQgaW5zdHJ1bWVudHNVdGlscy5xdWlja0luc3RydW1lbnRzKHtcbiAgICBhcHA6IHBhdGgucmVzb2x2ZShyb290RGlyLCAndGVzdCcsICdhc3NldHMnLCAnVUlDYXRhbG9nLmFwcCcpLFxuICAgIGJvb3RzdHJhcDogYm9vdHN0cmFwRmlsZSxcbiAgICBzaW11bGF0b3JTZGtBbmREZXZpY2U6ICdpUGhvbmUgNiAoOS4zKScsXG4gICAgbGF1bmNoVHJpZXM6IDIsXG4gICAgd2l0aG91dERlbGF5OiBmYWxzZSxcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXQgKGJvb3RzdHJhcEZpbGUsIHNvY2spIHtcbiAgbGV0IHByb3h5ID0gbmV3IHVpYXV0by5VSUF1dG9DbGllbnQoc29jayk7XG4gIGxldCBpbnN0cnVtZW50cyA9IGF3YWl0IG5ld0luc3RydW1lbnRzKGJvb3RzdHJhcEZpbGUpO1xuICBpbnN0cnVtZW50cy5vblNodXRkb3duXG4gICAgLnRoZW4oKCkgPT4ge1xuICAgICAgLy8gZXhwZWN0ZWQgc2h1dGRvd24sIG5vdGhpbmcgdG8gZG9cbiAgICB9KS5jYXRjaChhc3luYyAoZXJyKSA9PiB7XG4gICAgICBsb2cuZXJyb3IoZXJyKTtcbiAgICAgIGF3YWl0IHByb3h5LnNhZmVTaHV0ZG93bigpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmV4cGVjdGVkIHNodXRkb3duIG9mIGluc3RydW1lbnRzJyk7XG4gICAgfSkuZG9uZSgpO1xuICBhd2FpdCBCLmFsbChbXG4gICAgcHJveHkuc3RhcnQoKS50aGVuKCgpID0+IHtcbiAgICAgIC8vIGV2ZXJ5dGhpbmcgbG9va3MgZ29vZCwgbm90aWZ5IGluc3RydW1lbnRzLlxuICAgICAgaW5zdHJ1bWVudHMucmVnaXN0ZXJMYXVuY2goKTtcbiAgICB9KSxcbiAgICBpbnN0cnVtZW50cy5sYXVuY2goKVxuICBdKTtcbiAgcmV0dXJuIHtwcm94eSwgaW5zdHJ1bWVudHN9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBraWxsQWxsIChjdHgpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBjdHguaW5zdHJ1bWVudHMuc2h1dGRvd24oKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIHBhc3NcbiAgICBsb2cuZXJyb3IoZSk7XG4gIH1cbiAgYXdhaXQgaW5zdHJ1bWVudHNVdGlscy5raWxsQWxsSW5zdHJ1bWVudHMoKTtcbiAgYXdhaXQgY3R4LnByb3h5LnNhZmVTaHV0ZG93bigpO1xufVxuXG5sZXQgYm9vdHN0cmFwRmlsZTtcblxuYXN5bmMgZnVuY3Rpb24gZ2xvYmFsSW5pdCAoY3R4LCBvcHRzKSB7XG4gIGN0eC50aW1lb3V0KDI0MDAwMCk7XG4gIGJlZm9yZShhc3luYyAoKSA9PiB7XG4gICAgYm9vdHN0cmFwRmlsZSA9IGF3YWl0IGxvY2FsUHJlcGFyZUJvb3RzdHJhcChvcHRzKTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RydW1lbnRzSW5zdGFuY2VJbml0IChvcHRzID0ge30pIHtcbiAgbGV0IGN0eCA9IGF3YWl0IGluaXQoYm9vdHN0cmFwRmlsZSwgb3B0cy5zb2NrKTtcbiAgY3R4LnNlbmRDb21tYW5kID0gYXN5bmMgKGNtZCkgPT4ge1xuICAgIHJldHVybiBjdHgucHJveHkuc2VuZENvbW1hbmQoY21kKTtcbiAgfTtcbiAgY3R4LmV4ZWMgPSBjdHguc2VuZENvbW1hbmQ7XG5cbiAgY3R4LmV4ZWNGdW5jID0gYXN5bmMgKGZ1bmMsIHBhcmFtcykgPT4ge1xuICAgIHBhcmFtcyA9IHBhcmFtcyB8fCBbXTtcbiAgICBsZXQgc2NyaXB0ID1cbiAgICAgIGAoZnVuY3Rpb24gKCl7XFxuYCArXG4gICAgICBgICB2YXIgcGFyYW1zID0gSlNPTi5wYXJzZSgnJHtKU09OLnN0cmluZ2lmeShwYXJhbXMpfScpO1xcbmAgK1xuICAgICAgYCAgcmV0dXJuICgke2Z1bmMudG9TdHJpbmcoKX0pLmFwcGx5KG51bGwsIHBhcmFtcyk7XFxuYCArXG4gICAgICBgfSkoKTtgO1xuICAgIHJldHVybiBjdHguZXhlYyhzY3JpcHQpO1xuICB9O1xuXG4gIGxldCBjbWQgPSBgJC5pc1ZlcmJvc2UgPSAke3Byb2Nlc3MuZW52LlZFUkJPU0UgPyB0cnVlIDogZmFsc2V9O1xcbmA7XG4gIGF3YWl0IGN0eC5leGVjKGNtZCk7XG5cbiAgLy8gc29tZSB1aWF1dG8gaGVscGVyc1xuICBhd2FpdCBjdHguZXhlY0Z1bmMoZnVuY3Rpb24gKCkge1xuICAgIC8qIGdsb2JhbCByb290UGFnZTp0cnVlICovXG4gICAgcm9vdFBhZ2UgPSB7fTtcbiAgICAvLyBjbGljayBpdGVtIGluIHJvb3QgcGFnZSBtZW51XG4gICAgcm9vdFBhZ2UuY2xpY2tNZW51SXRlbSA9IGZ1bmN0aW9uIChwYXJ0aWFsVGV4dCkge1xuICAgICAgJC5lYWNoKCQoJ3RhYmxldmlldycpLmNoaWxkcmVuKCksIGZ1bmN0aW9uIChpZHgsIGNoaWxkKSB7XG4gICAgICAgIGlmIChjaGlsZC5uYW1lKCkuaW5kZXhPZihwYXJ0aWFsVGV4dCkgPj0gMCApe1xuICAgICAgICAgICQoY2hpbGQpLnRhcCgpO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfTtcbiAgfSk7XG5cbiAgYXdhaXQgY3R4LmV4ZWNGdW5jKGZ1bmN0aW9uICgpIHtcbiAgICAvKiBnbG9iYWwgJCAqL1xuICAgICQuZGVsYXkoNTAwKTtcbiAgICB3aGlsZSAoISQoJ3RhYmxldmlldycpLmlzVmlzaWJsZSgpKSB7XG4gICAgICAkLndhcm4oJ3dhaXRpbmcgZm9yIHBhZ2UgdG8gbG9hZCcpO1xuICAgICAgJC5kZWxheSg1MDApO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIGN0eDtcbn1cblxuZXhwb3J0IHsgaW5zdHJ1bWVudHNJbnN0YW5jZUluaXQsIGdsb2JhbEluaXQsIGtpbGxBbGwgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4vLi4ifQ==
