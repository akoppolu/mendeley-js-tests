'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _teen_process = require('teen_process');

var _appiumSupport = require('appium-support');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _instruments = require('./instruments');

var _instruments2 = _interopRequireDefault(_instruments);

var rootDir = _path2['default'].resolve(__dirname, '../..');
var INST_STALL_TIMEOUT = 12000;

function getInstrumentsPath() {
  var instrumentsPath, _ref, stdout;

  return _regeneratorRuntime.async(function getInstrumentsPath$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        instrumentsPath = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', ['-find', 'instruments']));

      case 4:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;

        instrumentsPath = (stdout || '').trim().replace('\n$', '');
        context$1$0.next = 12;
        break;

      case 9:
        context$1$0.prev = 9;
        context$1$0.t0 = context$1$0['catch'](1);

        if (context$1$0.t0) _logger2['default'].error(context$1$0.t0.message);

      case 12:
        if (!instrumentsPath) {
          _logger2['default'].errorAndThrow('Could not find the instruments binary. Please ensure ' + '`xcrun -find instruments` can locate it.');
        }
        _logger2['default'].debug('Instruments is at: ' + instrumentsPath);
        return context$1$0.abrupt('return', instrumentsPath);

      case 15:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 9]]);
}

function getAvailableDevices() {
  var timeout = arguments.length <= 0 || arguments[0] === undefined ? INST_STALL_TIMEOUT : arguments[0];

  var instrumentsPath, opts, lines, _ref2, stdout, devices;

  return _regeneratorRuntime.async(function getAvailableDevices$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Getting list of devices instruments supports');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(getInstrumentsPath());

      case 3:
        instrumentsPath = context$1$0.sent;
        opts = { timeout: timeout };
        lines = undefined;
        context$1$0.prev = 6;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(instrumentsPath, ['-s', 'devices'], opts));

      case 9:
        _ref2 = context$1$0.sent;
        stdout = _ref2.stdout;

        lines = stdout.split('\n');
        context$1$0.next = 17;
        break;

      case 14:
        context$1$0.prev = 14;
        context$1$0.t0 = context$1$0['catch'](6);

        _logger2['default'].errorAndThrow('Failed getting devices, err: ' + context$1$0.t0 + '.');

      case 17:
        devices = lines.filter(function (line) {
          // https://regex101.com/r/aE6aS3/6
          return (/^.+ \(\d+\.(\d+\.)?\d+( Simulator)?\) \[.+\]( \(Simulator\))?$/.test(line)
          );
        });

        _logger2['default'].debug('Available devices: ' + devices);
        return context$1$0.abrupt('return', devices);

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 14]]);
}

function killAllInstruments() {
  return _regeneratorRuntime.async(function killAllInstruments$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Killing all instruments');
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('pkill', ['-f', 'instruments']));

      case 4:
        context$1$0.next = 8;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](1);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 6]]);
}

function cleanAllTraces() {
  return _regeneratorRuntime.async(function cleanAllTraces$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!process.env.CLEAN_TRACES) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf('instrumentscli*.trace'));

      case 4:
        context$1$0.next = 8;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](1);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 6]]);
}

function parseLaunchTimeout(launchTimeout) {
  // number or object like { global: 40000, afterSimLaunch: 5000 }
  // may also parse JSON strings.
  if (_lodash2['default'].isString(launchTimeout)) {
    try {
      launchTimeout = JSON.parse(launchTimeout);
    } catch (err) {
      _logger2['default'].warn('Invalid launch timeout: ' + launchTimeout);
    }
  }
  if (_lodash2['default'].isNumber(launchTimeout)) {
    launchTimeout = {
      global: launchTimeout
    };
  }
  return launchTimeout;
}

function getIwdPath(xcodeMajorVersion) {
  var thirdpartyPath, iwdPath;
  return _regeneratorRuntime.async(function getIwdPath$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        thirdpartyPath = _path2['default'].resolve(rootDir, 'instruments-iwd');
        iwdPath = _path2['default'].resolve(thirdpartyPath, 'iwd' + xcodeMajorVersion);
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(iwdPath));

      case 4:
        if (context$1$0.sent) {
          context$1$0.next = 6;
          break;
        }

        iwdPath = _path2['default'].resolve(thirdpartyPath, 'iwd');

      case 6:
        _logger2['default'].debug('Found Insruments-Without-Delay: ' + iwdPath);
        return context$1$0.abrupt('return', iwdPath);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

// this function launches an instruments test with a default test
// that immediately passes. In this way we can start a simulator
// and be notified when it completely launches
function quickLaunch(udid) {
  var appPath = arguments.length <= 1 || arguments[1] === undefined ? _path2['default'].resolve(__dirname, '..', '..', 'assets', 'TestApp.app') : arguments[1];
  var traceTemplatePath, scriptPath, traceDocument, resultsPath, args;
  return _regeneratorRuntime.async(function quickLaunch$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getAutomationTraceTemplatePath());

      case 2:
        traceTemplatePath = context$1$0.sent;
        scriptPath = _path2['default'].resolve(__dirname, '..', '..', 'assets', 'blank_instruments_test.js');
        traceDocument = _path2['default'].resolve('/', 'tmp', 'testTrace.trace');
        resultsPath = _path2['default'].resolve('/', 'tmp');
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(traceDocument));

      case 8:
        args = ['instruments', '-D', traceDocument, '-t', traceTemplatePath, '-w', udid, appPath, '-e', 'UIASCRIPT', scriptPath, '-e', 'UIARESULTSPATH', resultsPath];

        _logger2['default'].debug('Running command: \'xcrun ' + args.join(' ') + '\'');
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', args));

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function quickInstruments() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
  var xcodeTraceTemplatePath;
  return _regeneratorRuntime.async(function quickInstruments$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        opts = _lodash2['default'].cloneDeep(opts);
        context$1$0.t0 = opts.xcodeTraceTemplatePath;

        if (context$1$0.t0) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getAutomationTraceTemplatePath());

      case 5:
        context$1$0.t0 = context$1$0.sent;

      case 6:
        xcodeTraceTemplatePath = context$1$0.t0;

        _lodash2['default'].defaults(opts, {
          launchTimeout: 60000,
          template: xcodeTraceTemplatePath,
          withoutDelay: true,
          xcodeVersion: '8.1',
          webSocket: null,
          flakeyRetries: true,
          logNoColors: false
        });
        return context$1$0.abrupt('return', new _instruments2['default'](opts));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.rootDir = rootDir;
exports.killAllInstruments = killAllInstruments;
exports.cleanAllTraces = cleanAllTraces;
exports.getInstrumentsPath = getInstrumentsPath;
exports.getAvailableDevices = getAvailableDevices;
exports.parseLaunchTimeout = parseLaunchTimeout;
exports.getIwdPath = getIwdPath;
exports.quickLaunch = quickLaunch;
exports.quickInstruments = quickInstruments;

// the trace document can be in a weird state
// but we never do anything with it, so delete
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0cnVtZW50cy91dGlscy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O29CQUFpQixNQUFNOzs7OzRCQUNGLGNBQWM7OzZCQUNoQixnQkFBZ0I7O3NCQUNuQixVQUFVOzs7OzJCQUNSLGNBQWM7Ozs7c0JBQ2xCLFFBQVE7Ozs7MkJBQ0UsZUFBZTs7OztBQUd2QyxJQUFNLE9BQU8sR0FBRyxrQkFBSyxPQUFPLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQ2pELElBQU0sa0JBQWtCLEdBQUcsS0FBSyxDQUFDOztBQUVqQyxTQUFlLGtCQUFrQjtNQUMzQixlQUFlLFFBRVosTUFBTTs7Ozs7QUFGVCx1QkFBZTs7O3lDQUVJLHdCQUFLLE9BQU8sRUFBRSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQzs7OztBQUF2RCxjQUFNLFFBQU4sTUFBTTs7QUFDWCx1QkFBZSxHQUFHLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQSxDQUFFLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7Ozs7Ozs7O0FBRTNELDRCQUFTLG9CQUFJLEtBQUssQ0FBQyxlQUFJLE9BQU8sQ0FBQyxDQUFDOzs7QUFFbEMsWUFBSSxDQUFDLGVBQWUsRUFBRTtBQUNwQiw4QkFBSSxhQUFhLENBQUMsdURBQXVELEdBQ3ZELDBDQUEwQyxDQUFDLENBQUM7U0FDL0Q7QUFDRCw0QkFBSSxLQUFLLHlCQUF1QixlQUFlLENBQUcsQ0FBQzs0Q0FDNUMsZUFBZTs7Ozs7OztDQUN2Qjs7QUFFRCxTQUFlLG1CQUFtQjtNQUFFLE9BQU8seURBQUcsa0JBQWtCOztNQUUxRCxlQUFlLEVBQ2YsSUFBSSxFQUNKLEtBQUssU0FFRixNQUFNLEVBS1QsT0FBTzs7Ozs7QUFWWCw0QkFBSSxLQUFLLENBQUMsOENBQThDLENBQUMsQ0FBQzs7eUNBQzlCLGtCQUFrQixFQUFFOzs7QUFBNUMsdUJBQWU7QUFDZixZQUFJLEdBQUcsRUFB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ZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgSW5zdHJ1bWVudHMgZnJvbSAnLi9pbnN0cnVtZW50cyc7XG5cblxuY29uc3Qgcm9vdERpciA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi8uLicpO1xuY29uc3QgSU5TVF9TVEFMTF9USU1FT1VUID0gMTIwMDA7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEluc3RydW1lbnRzUGF0aCAoKSB7XG4gIGxldCBpbnN0cnVtZW50c1BhdGg7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygneGNydW4nLCBbJy1maW5kJywgJ2luc3RydW1lbnRzJ10pO1xuICAgIGluc3RydW1lbnRzUGF0aCA9IChzdGRvdXQgfHwgJycpLnRyaW0oKS5yZXBsYWNlKCdcXG4kJywgJycpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyKSBsb2cuZXJyb3IoZXJyLm1lc3NhZ2UpO1xuICB9XG4gIGlmICghaW5zdHJ1bWVudHNQYXRoKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coJ0NvdWxkIG5vdCBmaW5kIHRoZSBpbnN0cnVtZW50cyBiaW5hcnkuIFBsZWFzZSBlbnN1cmUgJyArXG4gICAgICAgICAgICAgICAgICAgICAgJ2B4Y3J1biAtZmluZCBpbnN0cnVtZW50c2AgY2FuIGxvY2F0ZSBpdC4nKTtcbiAgfVxuICBsb2cuZGVidWcoYEluc3RydW1lbnRzIGlzIGF0OiAke2luc3RydW1lbnRzUGF0aH1gKTtcbiAgcmV0dXJuIGluc3RydW1lbnRzUGF0aDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QXZhaWxhYmxlRGV2aWNlcyAodGltZW91dCA9IElOU1RfU1RBTExfVElNRU9VVCkge1xuICBsb2cuZGVidWcoJ0dldHRpbmcgbGlzdCBvZiBkZXZpY2VzIGluc3RydW1lbnRzIHN1cHBvcnRzJyk7XG4gIGxldCBpbnN0cnVtZW50c1BhdGggPSBhd2FpdCBnZXRJbnN0cnVtZW50c1BhdGgoKTtcbiAgbGV0IG9wdHMgPSB7dGltZW91dH07XG4gIGxldCBsaW5lcztcbiAgdHJ5IHtcbiAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKGluc3RydW1lbnRzUGF0aCwgWyctcycsICdkZXZpY2VzJ10sIG9wdHMpO1xuICAgIGxpbmVzID0gc3Rkb3V0LnNwbGl0KCdcXG4nKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEZhaWxlZCBnZXR0aW5nIGRldmljZXMsIGVycjogJHtlcnJ9LmApO1xuICB9XG4gIGxldCBkZXZpY2VzID0gbGluZXMuZmlsdGVyKChsaW5lKSA9PiB7XG4gICAgLy8gaHR0cHM6Ly9yZWdleDEwMS5jb20vci9hRTZhUzMvNlxuICAgIHJldHVybiAvXi4rIFxcKFxcZCtcXC4oXFxkK1xcLik/XFxkKyggU2ltdWxhdG9yKT9cXCkgXFxbLitcXF0oIFxcKFNpbXVsYXRvclxcKSk/JC8udGVzdChsaW5lKTtcbiAgfSk7XG4gIGxvZy5kZWJ1ZyhgQXZhaWxhYmxlIGRldmljZXM6ICR7ZGV2aWNlc31gKTtcbiAgcmV0dXJuIGRldmljZXM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGtpbGxBbGxJbnN0cnVtZW50cyAoKSB7XG4gIGxvZy5kZWJ1ZygnS2lsbGluZyBhbGwgaW5zdHJ1bWVudHMnKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKCdwa2lsbCcsICBbJy1mJywgJ2luc3RydW1lbnRzJ10pO1xuICB9IGNhdGNoIChpZ24pIHt9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNsZWFuQWxsVHJhY2VzICgpIHtcbiAgaWYgKHByb2Nlc3MuZW52LkNMRUFOX1RSQUNFUykge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYoJ2luc3RydW1lbnRzY2xpKi50cmFjZScpO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZUxhdW5jaFRpbWVvdXQgKGxhdW5jaFRpbWVvdXQpIHtcbiAgLy8gbnVtYmVyIG9yIG9iamVjdCBsaWtlIHsgZ2xvYmFsOiA0MDAwMCwgYWZ0ZXJTaW1MYXVuY2g6IDUwMDAgfVxuICAvLyBtYXkgYWxzbyBwYXJzZSBKU09OIHN0cmluZ3MuXG4gIGlmIChfLmlzU3RyaW5nKGxhdW5jaFRpbWVvdXQpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxhdW5jaFRpbWVvdXQgPSBKU09OLnBhcnNlKGxhdW5jaFRpbWVvdXQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYEludmFsaWQgbGF1bmNoIHRpbWVvdXQ6ICR7bGF1bmNoVGltZW91dH1gKTtcbiAgICB9XG4gIH1cbiAgaWYgKF8uaXNOdW1iZXIobGF1bmNoVGltZW91dCkpIHtcbiAgICBsYXVuY2hUaW1lb3V0ID0ge1xuICAgICAgZ2xvYmFsOiBsYXVuY2hUaW1lb3V0XG4gICAgfTtcbiAgfVxuICByZXR1cm4gbGF1bmNoVGltZW91dDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0SXdkUGF0aCAoeGNvZGVNYWpvclZlcnNpb24pIHtcbiAgbGV0IHRoaXJkcGFydHlQYXRoID0gcGF0aC5yZXNvbHZlKHJvb3REaXIsICdpbnN0cnVtZW50cy1pd2QnKTtcbiAgbGV0IGl3ZFBhdGggPSBwYXRoLnJlc29sdmUodGhpcmRwYXJ0eVBhdGgsIGBpd2Qke3hjb2RlTWFqb3JWZXJzaW9ufWApO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhpd2RQYXRoKSkge1xuICAgIGl3ZFBhdGggPSBwYXRoLnJlc29sdmUodGhpcmRwYXJ0eVBhdGgsICdpd2QnKTtcbiAgfVxuICBsb2cuZGVidWcoYEZvdW5kIEluc3J1bWVudHMtV2l0aG91dC1EZWxheTogJHtpd2RQYXRofWApO1xuICByZXR1cm4gaXdkUGF0aDtcbn1cblxuLy8gdGhpcyBmdW5jdGlvbiBsYXVuY2hlcyBhbiBpbnN0cnVtZW50cyB0ZXN0IHdpdGggYSBkZWZhdWx0IHRlc3Rcbi8vIHRoYXQgaW1tZWRpYXRlbHkgcGFzc2VzLiBJbiB0aGlzIHdheSB3ZSBjYW4gc3RhcnQgYSBzaW11bGF0b3Jcbi8vIGFuZCBiZSBub3RpZmllZCB3aGVuIGl0IGNvbXBsZXRlbHkgbGF1bmNoZXNcbmFzeW5jIGZ1bmN0aW9uIHF1aWNrTGF1bmNoICh1ZGlkLCBhcHBQYXRoID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2Fzc2V0cycsICdUZXN0QXBwLmFwcCcpKSB7XG4gIGxldCB0cmFjZVRlbXBsYXRlUGF0aCA9IGF3YWl0IHhjb2RlLmdldEF1dG9tYXRpb25UcmFjZVRlbXBsYXRlUGF0aCgpO1xuICBsZXQgc2NyaXB0UGF0aCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdhc3NldHMnLCAnYmxhbmtfaW5zdHJ1bWVudHNfdGVzdC5qcycpO1xuICBsZXQgdHJhY2VEb2N1bWVudCA9IHBhdGgucmVzb2x2ZSgnLycsICd0bXAnLCAndGVzdFRyYWNlLnRyYWNlJyk7XG4gIGxldCByZXN1bHRzUGF0aCA9IHBhdGgucmVzb2x2ZSgnLycsICd0bXAnKTtcblxuICAvLyB0aGUgdHJhY2UgZG9jdW1lbnQgY2FuIGJlIGluIGEgd2VpcmQgc3RhdGVcbiAgLy8gYnV0IHdlIG5ldmVyIGRvIGFueXRoaW5nIHdpdGggaXQsIHNvIGRlbGV0ZVxuICBhd2FpdCBmcy5yaW1yYWYodHJhY2VEb2N1bWVudCk7XG5cbiAgbGV0IGFyZ3MgPSBbJ2luc3RydW1lbnRzJyxcbiAgICAgICAgICAgICAgJy1EJywgdHJhY2VEb2N1bWVudCxcbiAgICAgICAgICAgICAgICctdCcsIHRyYWNlVGVtcGxhdGVQYXRoLFxuICAgICAgICAgICAgICAgJy13JywgdWRpZCxcbiAgICAgICAgICAgICAgIGFwcFBhdGgsXG4gICAgICAgICAgICAgICAnLWUnLCAnVUlBU0NSSVBUJywgc2NyaXB0UGF0aCxcbiAgICAgICAgICAgICAgICctZScsICdVSUFSRVNVTFRTUEFUSCcsIHJlc3VsdHNQYXRoXTtcbiAgbG9nLmRlYnVnKGBSdW5uaW5nIGNvbW1hbmQ6ICd4Y3J1biAke2FyZ3Muam9pbignICcpfSdgKTtcbiAgYXdhaXQgZXhlYygneGNydW4nLCBhcmdzKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcXVpY2tJbnN0cnVtZW50cyAob3B0cyA9IHt9KSB7XG4gIG9wdHMgPSBfLmNsb25lRGVlcChvcHRzKTtcbiAgbGV0IHhjb2RlVHJhY2VUZW1wbGF0ZVBhdGggPSBvcHRzLnhjb2RlVHJhY2VUZW1wbGF0ZVBhdGggfHxcbiAgICAgIGF3YWl0IHhjb2RlLmdldEF1dG9tYXRpb25UcmFjZVRlbXBsYXRlUGF0aCgpO1xuICBfLmRlZmF1bHRzKG9wdHMsIHtcbiAgICBsYXVuY2hUaW1lb3V0OiA2MDAwMCxcbiAgICB0ZW1wbGF0ZTogeGNvZGVUcmFjZVRlbXBsYXRlUGF0aCxcbiAgICB3aXRob3V0RGVsYXk6IHRydWUsXG4gICAgeGNvZGVWZXJzaW9uOiAnOC4xJyxcbiAgICB3ZWJTb2NrZXQ6IG51bGwsXG4gICAgZmxha2V5UmV0cmllczogdHJ1ZSxcbiAgICBsb2dOb0NvbG9yczogZmFsc2UsXG4gIH0pO1xuICByZXR1cm4gbmV3IEluc3RydW1lbnRzKG9wdHMpO1xufVxuXG5leHBvcnQgeyByb290RGlyLCBraWxsQWxsSW5zdHJ1bWVudHMsIGNsZWFuQWxsVHJhY2VzLCBnZXRJbnN0cnVtZW50c1BhdGgsXG4gICAgICAgICBnZXRBdmFpbGFibGVEZXZpY2VzLCBwYXJzZUxhdW5jaFRpbWVvdXQsIGdldEl3ZFBhdGgsIHF1aWNrTGF1bmNoLFxuICAgICAgICAgcXVpY2tJbnN0cnVtZW50cyB9O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
