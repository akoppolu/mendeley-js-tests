'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _appiumSupport = require('appium-support');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumIosSimulator = require('appium-ios-simulator');

var _server = require('../server');

var commands = {},
    helpers = {},
    extensions = {};

commands.execute = function callee$0$0(script, args) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!script.match(/^mobile\:/)) {
          context$1$0.next = 7;
          break;
        }

        script = script.replace(/^mobile\:/, '').trim();
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.executeMobile(script, _lodash2['default'].isArray(args) ? args[0] : args));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        if (!this.isWebContext()) {
          context$1$0.next = 14;
          break;
        }

        args = this.convertElementsForAtoms(args);
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, args]));

      case 11:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(script));

      case 16:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.executeAsync = function callee$0$0(script, args, sessionId) {
  var address, port, protocol, currentUrl, responseUrl, defaultHost, urlObject;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(script));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 4:
        address = this.opts.callbackAddress || this.opts.address;
        port = this.opts.callbackPort || this.opts.port;

        sessionId = sessionId || this.sessionId;

        // https sites need to reply to an https endpoint, in Safari
        protocol = 'http:';
        context$1$0.prev = 8;
        context$1$0.t0 = _url2['default'];
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.getUrl());

      case 12:
        context$1$0.t1 = context$1$0.sent;
        currentUrl = context$1$0.t0.parse.call(context$1$0.t0, context$1$0.t1);

        protocol = currentUrl.protocol;
        if (protocol === 'https:' && this.opts.httpsCallbackPort && this.opts.httpsCallbackAddress) {
          port = this.opts.httpsCallbackPort;
          address = this.opts.httpsCallbackAddress;
        }
        context$1$0.next = 20;
        break;

      case 18:
        context$1$0.prev = 18;
        context$1$0.t2 = context$1$0['catch'](8);

      case 20:
        responseUrl = protocol + '//' + address + ':' + port + '/wd/hub/session/' + sessionId + '/receive_async_response';

        if (this.isRealDevice()) {
          defaultHost = this.opts.address;
          urlObject = _url2['default'].parse(responseUrl);

          if (urlObject.hostname === defaultHost) {
            _logger2['default'].debug('Real device safari test and no custom callback address ' + 'set, changing callback address to local ip.');
            urlObject.hostname = _appiumSupport.util.localIp();
            urlObject.host = null; // set to null, otherwise hostname is ignored
            responseUrl = _url2['default'].format(urlObject);
          } else {
            _logger2['default'].debug('Custom callback address set, leaving as is.');
          }
        }

        _logger2['default'].debug('Response url for executeAsync: ' + responseUrl);
        args = this.convertElementsForAtoms(args);
        this.asyncWaitMs = this.asyncWaitMs || 0;
        context$1$0.next = 27;
        return _regeneratorRuntime.awrap(this.executeAtomAsync('execute_async_script', [script, args, this.asyncWaitMs], responseUrl));

      case 27:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 28:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[8, 18]]);
};

commands.receiveAsyncResponse = function callee$0$0(status, value) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Received async response: ' + JSON.stringify(value));
        if (!_lodash2['default'].isNull(this.asyncPromise) && !_lodash2['default'].isUndefined(this.asyncPromise)) {
          if (status !== 0) {
            this.asyncPromise.reject((0, _appiumBaseDriver.errorFromCode)(status, value.message));
          } else {
            this.asyncPromise.resolve(value);
          }
        } else {
          _logger2['default'].warn('Received async response when we were not expecting one! ' + ('Response was: ' + JSON.stringify(value)));
        }

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.startHttpsAsyncServer = function callee$0$0() {
  var address, port, _ref, sslServer, pemCertificate, httpsPort, udid;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Starting https server for async responses');
        address = this.opts.callbackAddress || this.opts.address;
        port = this.opts.callbackPort || this.opts.port;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap((0, _server.startHttpsServer)(port, address));

      case 5:
        _ref = context$1$0.sent;
        sslServer = _ref.sslServer;
        pemCertificate = _ref.pemCertificate;
        httpsPort = _ref.httpsPort;

        this.opts.sslServer = sslServer;
        this.opts.httpsServerCertificate = pemCertificate;
        this.opts.httpsCallbackPort = httpsPort;
        this.opts.httpsCallbackAddress = 'localhost';
        udid = undefined;

        if (this.sim) {
          // ios driver
          udid = this.sim.udid;
        } else {
          // xcuitest driver
          udid = this.opts.udid;
        }
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap((0, _appiumIosSimulator.installSSLCert)(this.opts.httpsServerCertificate, udid));

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.stopHttpsAsyncServer = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Stopping https server for async responses');

        if (!this.opts.sslServer) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.opts.sslServer.close());

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap((0, _appiumIosSimulator.uninstallSSLCert)(this.opts.httpsServerCertificate, this.opts.udid));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.executeMobile = function callee$0$0(mobileCommand) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(mobileCommand === 'scroll')) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.mobileScroll(opts));

      case 3:
        context$1$0.next = 6;
        break;

      case 5:
        throw new _appiumBaseDriver.errors.UnknownCommandError('Unknown command, all the mobile commands except scroll have been removed.');

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// we only support mobile: scroll
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9leGVjdXRlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBc0Msb0JBQW9COztzQkFDNUMsUUFBUTs7OzttQkFDTixLQUFLOzs7OzZCQUNBLGdCQUFnQjs7c0JBQ2xCLFdBQVc7Ozs7a0NBQ21CLHNCQUFzQjs7c0JBQ3RDLFdBQVc7O0FBRzVDLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELFFBQVEsQ0FBQyxPQUFPLEdBQUcsb0JBQWdCLE1BQU0sRUFBRSxJQUFJOzs7O2FBQ3pDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDOzs7OztBQUMzQixjQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7O3lDQUNuQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxvQkFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQzs7Ozs7O2FBRXJFLElBQUksQ0FBQyxZQUFZLEVBQUU7Ozs7O0FBQ3JCLFlBQUksR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7O3lDQUM3QixJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDOzs7Ozs7O3lDQUVsRCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7Ozs7Ozs7Ozs7Q0FHdkQsQ0FBQzs7QUFFRixRQUFRLENBQUMsWUFBWSxHQUFHLG9CQUFnQixNQUFNLEVBQUUsSUFBSSxFQUFFLFNBQVM7TUFLekQsT0FBTyxFQUNQLElBQUksRUFJSixRQUFRLEVBRU4sVUFBVSxFQU9aLFdBQVcsRUFHVCxXQUFXLEVBQ1gsU0FBUzs7OztZQXRCVixJQUFJLENBQUMsWUFBWSxFQUFFOzs7Ozs7eUNBQ1QsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDOzs7Ozs7QUFHaEQsZUFBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTztBQUN4RCxZQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJOztBQUNuRCxpQkFBUyxHQUFHLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDOzs7QUFHcEMsZ0JBQVEsR0FBRyxPQUFPOzs7O3lDQUVhLElBQUksQ0FBQyxNQUFNLEVBQUU7Ozs7QUFBMUMsa0JBQVUsa0JBQU8sS0FBSzs7QUFDMUIsZ0JBQVEsR0FBRyxVQUFVLENBQUMsUUFBUSxDQUFDO0FBQy9CLFlBQUksUUFBUSxLQUFLLFFBQVEsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUU7QUFDMUYsY0FBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUM7QUFDbkMsaUJBQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDO1NBQzFDOzs7Ozs7Ozs7QUFFQyxtQkFBVyxHQUFNLFFBQVEsVUFBSyxPQUFPLFNBQUksSUFBSSx3QkFBbUIsU0FBUzs7QUFFN0UsWUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUU7QUFDbkIscUJBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU87QUFDL0IsbUJBQVMsR0FBRyxpQkFBSSxLQUFLLENBQUMsV0FBVyxDQUFDOztBQUN0QyxjQUFJLFNBQVMsQ0FBQyxRQUFRLEtBQUssV0FBVyxFQUFFO0FBQ3RDLGdDQUFPLEtBQUssQ0FBQyx5REFBeUQsR0FDekQsNkNBQTZDLENBQUMsQ0FBQztBQUM1RCxxQkFBUyxDQUFDLFFBQVEsR0FBRyxvQkFBSyxPQUFPLEVBQUUsQ0FBQztBQUNwQyxxQkFBUyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDdEIsdUJBQVcsR0FBRyxpQkFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7V0FDckMsTUFBTTtBQUNMLGdDQUFPLEtBQUssQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO1dBQzdEO1NBQ0Y7O0FBRUQsNEJBQU8sS0FBSyxxQ0FBbUMsV0FBVyxDQUFHLENBQUM7QUFDOUQsWUFBSSxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMxQyxZQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxXQUFXLElBQUksQ0FBQyxDQUFDOzt5Q0FDNUIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLHNCQUFzQixFQUFFLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsV0FBVyxDQUFDOzs7Ozs7Ozs7O0NBQzFHLENBQUM7O0FBRUYsUUFBUSxDQUFDLG9CQUFvQixHQUFHLG9CQUFnQixNQUFNLEVBQUUsS0FBSzs7OztBQUMzRCw0QkFBTyxLQUFLLCtCQUE2QixJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFHLENBQUM7QUFDbEUsWUFBSSxDQUFDLG9CQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxvQkFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFO0FBQ3JFLGNBQUksTUFBTSxLQUFLLENBQUMsRUFBRTtBQUNoQixnQkFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMscUNBQWMsTUFBTSxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1dBQ2hFLE1BQU07QUFDTCxnQkFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7V0FDbEM7U0FDRixNQUFNO0FBQ0wsOEJBQU8sSUFBSSxDQUFDLGlGQUNpQixJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFFLENBQUMsQ0FBQztTQUN2RDs7Ozs7OztDQUNGLENBQUM7O0FBRUYsT0FBTyxDQUFDLHFCQUFxQixHQUFHO01BRTFCLE9BQU8sRUFDUCxJQUFJLFFBQ0gsU0FBUyxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBS3JDLElBQUk7Ozs7O0FBUlIsNEJBQU8sS0FBSyxDQUFDLDJDQUEyQyxDQUFDLENBQUM7QUFDdEQsZUFBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTztBQUN4RCxZQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJOzt5Q0FDQSw4QkFBaUIsSUFBSSxFQUFFLE9BQU8sQ0FBQzs7OztBQUE3RSxpQkFBUyxRQUFULFNBQVM7QUFBRSxzQkFBYyxRQUFkLGNBQWM7QUFBRSxpQkFBUyxRQUFULFNBQVM7O0FBQ3pDLFlBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztBQUNoQyxZQUFJLENBQUMsSUFBSSxDQUFDLHNCQUFzQixHQUFHLGNBQWMsQ0FBQztBQUNsRCxZQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLFNBQVMsQ0FBQztBQUN4QyxZQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLFdBQVcsQ0FBQztBQUN6QyxZQUFJOztBQUNSLFlBQUksSUFBSSxDQUFDLEdBQUcsRUFBRTs7QUFFWixjQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7U0FDdEIsTUFBTTs7QUFFTCxjQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7U0FDdkI7O3lDQUNLLHdDQUFlLElBQUksQ0FBQyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsSUFBSSxDQUFDOzs7Ozs7O0NBQzdELENBQUM7O0FBRUYsT0FBTyxDQUFDLG9CQUFvQixHQUFHOzs7O0FBQzdCLDRCQUFPLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDOzthQUN0RCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVM7Ozs7Ozt5Q0FDZixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUU7Ozs7eUNBRTdCLDBDQUFpQixJQUFJLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDOzs7Ozs7O0NBQ3pFLENBQUM7O0FBRUYsUUFBUSxDQUFDLGFBQWEsR0FBRyxvQkFBZ0IsYUFBYTtNQUFFLElBQUkseURBQUMsRUFBRTs7OztjQUV6RCxhQUFhLEtBQUssUUFBUSxDQUFBOzs7Ozs7eUNBQ3RCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDOzs7Ozs7O2NBRXZCLElBQUkseUJBQU8sbUJBQW1CLENBQUMsMkVBQTJFLENBQUM7Ozs7Ozs7Q0FFcEgsQ0FBQzs7QUFFRixlQUFjLFVBQVUsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDcEMsUUFBUSxHQUFSLFFBQVE7UUFBRSxPQUFPLEdBQVAsT0FBTztxQkFDWCxVQUFVIiwiZmlsZSI6ImxpYi9jb21tYW5kcy9leGVjdXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXJyb3JzLCBlcnJvckZyb21Db2RlIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgaW5zdGFsbFNTTENlcnQsIHVuaW5zdGFsbFNTTENlcnQgfSBmcm9tICdhcHBpdW0taW9zLXNpbXVsYXRvcic7XG5pbXBvcnQgeyBzdGFydEh0dHBzU2VydmVyIH0gZnJvbSAnLi4vc2VydmVyJztcblxuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbW1hbmRzLmV4ZWN1dGUgPSBhc3luYyBmdW5jdGlvbiAoc2NyaXB0LCBhcmdzKSB7XG4gIGlmIChzY3JpcHQubWF0Y2goL15tb2JpbGVcXDovKSkge1xuICAgIHNjcmlwdCA9IHNjcmlwdC5yZXBsYWNlKC9ebW9iaWxlXFw6LywgJycpLnRyaW0oKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlTW9iaWxlKHNjcmlwdCwgXy5pc0FycmF5KGFyZ3MpID8gYXJnc1swXSA6IGFyZ3MpO1xuICB9IGVsc2Uge1xuICAgIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgICBhcmdzID0gdGhpcy5jb252ZXJ0RWxlbWVudHNGb3JBdG9tcyhhcmdzKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdleGVjdXRlX3NjcmlwdCcsIFtzY3JpcHQsIGFyZ3NdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKHNjcmlwdCk7XG4gICAgfVxuICB9XG59O1xuXG5jb21tYW5kcy5leGVjdXRlQXN5bmMgPSBhc3luYyBmdW5jdGlvbiAoc2NyaXB0LCBhcmdzLCBzZXNzaW9uSWQpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKHNjcmlwdCk7XG4gIH1cblxuICBsZXQgYWRkcmVzcyA9IHRoaXMub3B0cy5jYWxsYmFja0FkZHJlc3MgfHwgdGhpcy5vcHRzLmFkZHJlc3M7XG4gIGxldCBwb3J0ID0gdGhpcy5vcHRzLmNhbGxiYWNrUG9ydCB8fCB0aGlzLm9wdHMucG9ydDtcbiAgc2Vzc2lvbklkID0gc2Vzc2lvbklkIHx8IHRoaXMuc2Vzc2lvbklkO1xuXG4gIC8vIGh0dHBzIHNpdGVzIG5lZWQgdG8gcmVwbHkgdG8gYW4gaHR0cHMgZW5kcG9pbnQsIGluIFNhZmFyaVxuICBsZXQgcHJvdG9jb2wgPSAnaHR0cDonO1xuICB0cnkge1xuICAgIGxldCBjdXJyZW50VXJsID0gdXJsLnBhcnNlKGF3YWl0IHRoaXMuZ2V0VXJsKCkpO1xuICAgIHByb3RvY29sID0gY3VycmVudFVybC5wcm90b2NvbDtcbiAgICBpZiAocHJvdG9jb2wgPT09ICdodHRwczonICYmIHRoaXMub3B0cy5odHRwc0NhbGxiYWNrUG9ydCAmJiB0aGlzLm9wdHMuaHR0cHNDYWxsYmFja0FkZHJlc3MpIHtcbiAgICAgIHBvcnQgPSB0aGlzLm9wdHMuaHR0cHNDYWxsYmFja1BvcnQ7XG4gICAgICBhZGRyZXNzID0gdGhpcy5vcHRzLmh0dHBzQ2FsbGJhY2tBZGRyZXNzO1xuICAgIH1cbiAgfSBjYXRjaCAoaWduKSB7fVxuICBsZXQgcmVzcG9uc2VVcmwgPSBgJHtwcm90b2NvbH0vLyR7YWRkcmVzc306JHtwb3J0fS93ZC9odWIvc2Vzc2lvbi8ke3Nlc3Npb25JZH0vcmVjZWl2ZV9hc3luY19yZXNwb25zZWA7XG5cbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBsZXQgZGVmYXVsdEhvc3QgPSB0aGlzLm9wdHMuYWRkcmVzcztcbiAgICBsZXQgdXJsT2JqZWN0ID0gdXJsLnBhcnNlKHJlc3BvbnNlVXJsKTtcbiAgICBpZiAodXJsT2JqZWN0Lmhvc3RuYW1lID09PSBkZWZhdWx0SG9zdCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdSZWFsIGRldmljZSBzYWZhcmkgdGVzdCBhbmQgbm8gY3VzdG9tIGNhbGxiYWNrIGFkZHJlc3MgJyArXG4gICAgICAgICAgICAgICAgICAgJ3NldCwgY2hhbmdpbmcgY2FsbGJhY2sgYWRkcmVzcyB0byBsb2NhbCBpcC4nKTtcbiAgICAgIHVybE9iamVjdC5ob3N0bmFtZSA9IHV0aWwubG9jYWxJcCgpO1xuICAgICAgdXJsT2JqZWN0Lmhvc3QgPSBudWxsOyAvLyBzZXQgdG8gbnVsbCwgb3RoZXJ3aXNlIGhvc3RuYW1lIGlzIGlnbm9yZWRcbiAgICAgIHJlc3BvbnNlVXJsID0gdXJsLmZvcm1hdCh1cmxPYmplY3QpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0N1c3RvbSBjYWxsYmFjayBhZGRyZXNzIHNldCwgbGVhdmluZyBhcyBpcy4nKTtcbiAgICB9XG4gIH1cblxuICBsb2dnZXIuZGVidWcoYFJlc3BvbnNlIHVybCBmb3IgZXhlY3V0ZUFzeW5jOiAke3Jlc3BvbnNlVXJsfWApO1xuICBhcmdzID0gdGhpcy5jb252ZXJ0RWxlbWVudHNGb3JBdG9tcyhhcmdzKTtcbiAgdGhpcy5hc3luY1dhaXRNcyA9IHRoaXMuYXN5bmNXYWl0TXMgfHwgMDtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b21Bc3luYygnZXhlY3V0ZV9hc3luY19zY3JpcHQnLCBbc2NyaXB0LCBhcmdzLCB0aGlzLmFzeW5jV2FpdE1zXSwgcmVzcG9uc2VVcmwpO1xufTtcblxuY29tbWFuZHMucmVjZWl2ZUFzeW5jUmVzcG9uc2UgPSBhc3luYyBmdW5jdGlvbiAoc3RhdHVzLCB2YWx1ZSkge1xuICBsb2dnZXIuZGVidWcoYFJlY2VpdmVkIGFzeW5jIHJlc3BvbnNlOiAke0pTT04uc3RyaW5naWZ5KHZhbHVlKX1gKTtcbiAgaWYgKCFfLmlzTnVsbCh0aGlzLmFzeW5jUHJvbWlzZSkgJiYgIV8uaXNVbmRlZmluZWQodGhpcy5hc3luY1Byb21pc2UpKSB7XG4gICAgaWYgKHN0YXR1cyAhPT0gMCkge1xuICAgICAgdGhpcy5hc3luY1Byb21pc2UucmVqZWN0KGVycm9yRnJvbUNvZGUoc3RhdHVzLCB2YWx1ZS5tZXNzYWdlKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYXN5bmNQcm9taXNlLnJlc29sdmUodmFsdWUpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIud2FybihgUmVjZWl2ZWQgYXN5bmMgcmVzcG9uc2Ugd2hlbiB3ZSB3ZXJlIG5vdCBleHBlY3Rpbmcgb25lISBgICtcbiAgICAgICAgICAgICAgICBgUmVzcG9uc2Ugd2FzOiAke0pTT04uc3RyaW5naWZ5KHZhbHVlKX1gKTtcbiAgfVxufTtcblxuaGVscGVycy5zdGFydEh0dHBzQXN5bmNTZXJ2ZXIgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZ2dlci5kZWJ1ZygnU3RhcnRpbmcgaHR0cHMgc2VydmVyIGZvciBhc3luYyByZXNwb25zZXMnKTtcbiAgbGV0IGFkZHJlc3MgPSB0aGlzLm9wdHMuY2FsbGJhY2tBZGRyZXNzIHx8IHRoaXMub3B0cy5hZGRyZXNzO1xuICBsZXQgcG9ydCA9IHRoaXMub3B0cy5jYWxsYmFja1BvcnQgfHwgdGhpcy5vcHRzLnBvcnQ7XG4gIGxldCB7c3NsU2VydmVyLCBwZW1DZXJ0aWZpY2F0ZSwgaHR0cHNQb3J0fSA9IGF3YWl0IHN0YXJ0SHR0cHNTZXJ2ZXIocG9ydCwgYWRkcmVzcyk7XG4gIHRoaXMub3B0cy5zc2xTZXJ2ZXIgPSBzc2xTZXJ2ZXI7XG4gIHRoaXMub3B0cy5odHRwc1NlcnZlckNlcnRpZmljYXRlID0gcGVtQ2VydGlmaWNhdGU7XG4gIHRoaXMub3B0cy5odHRwc0NhbGxiYWNrUG9ydCA9IGh0dHBzUG9ydDtcbiAgdGhpcy5vcHRzLmh0dHBzQ2FsbGJhY2tBZGRyZXNzID0gJ2xvY2FsaG9zdCc7XG4gIGxldCB1ZGlkO1xuICBpZiAodGhpcy5zaW0pIHtcbiAgICAvLyBpb3MgZHJpdmVyXG4gICAgdWRpZCA9IHRoaXMuc2ltLnVkaWQ7XG4gIH0gZWxzZSB7XG4gICAgLy8geGN1aXRlc3QgZHJpdmVyXG4gICAgdWRpZCA9IHRoaXMub3B0cy51ZGlkO1xuICB9XG4gIGF3YWl0IGluc3RhbGxTU0xDZXJ0KHRoaXMub3B0cy5odHRwc1NlcnZlckNlcnRpZmljYXRlLCB1ZGlkKTtcbn07XG5cbmhlbHBlcnMuc3RvcEh0dHBzQXN5bmNTZXJ2ZXIgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZ2dlci5kZWJ1ZygnU3RvcHBpbmcgaHR0cHMgc2VydmVyIGZvciBhc3luYyByZXNwb25zZXMnKTtcbiAgaWYgKHRoaXMub3B0cy5zc2xTZXJ2ZXIpIHtcbiAgICBhd2FpdCB0aGlzLm9wdHMuc3NsU2VydmVyLmNsb3NlKCk7XG4gIH1cbiAgYXdhaXQgdW5pbnN0YWxsU1NMQ2VydCh0aGlzLm9wdHMuaHR0cHNTZXJ2ZXJDZXJ0aWZpY2F0ZSwgdGhpcy5vcHRzLnVkaWQpO1xufTtcblxuY29tbWFuZHMuZXhlY3V0ZU1vYmlsZSA9IGFzeW5jIGZ1bmN0aW9uIChtb2JpbGVDb21tYW5kLCBvcHRzPXt9KSB7XG4gIC8vIHdlIG9ubHkgc3VwcG9ydCBtb2JpbGU6IHNjcm9sbFxuICBpZiAobW9iaWxlQ29tbWFuZCA9PT0gJ3Njcm9sbCcpIHtcbiAgICBhd2FpdCB0aGlzLm1vYmlsZVNjcm9sbChvcHRzKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25Db21tYW5kRXJyb3IoJ1Vua25vd24gY29tbWFuZCwgYWxsIHRoZSBtb2JpbGUgY29tbWFuZHMgZXhjZXB0IHNjcm9sbCBoYXZlIGJlZW4gcmVtb3ZlZC4nKTtcbiAgfVxufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
