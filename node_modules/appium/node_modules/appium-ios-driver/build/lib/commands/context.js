'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _asyncbox = require('asyncbox');

var _appiumRemoteDebugger = require('appium-remote-debugger');

var _deviceLogIosPerformanceLog = require('../device-log/ios-performance-log');

var _appiumBaseDriver = require('appium-base-driver');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var NATIVE_WIN = 'NATIVE_APP';
var WEBVIEW_WIN = 'WEBVIEW';
var WEBVIEW_BASE = WEBVIEW_WIN + '_';

var commands = {},
    helpers = {},
    extensions = {};

commands.getCurrentContext = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(this.curContext && this.curContext !== NATIVE_WIN)) {
          context$1$0.next = 4;
          break;
        }

        return context$1$0.abrupt('return', '' + WEBVIEW_BASE + this.curContext);

      case 4:
        return context$1$0.abrupt('return', NATIVE_WIN);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getContexts = function callee$0$0() {
  var contexts;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Getting list of available contexts');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.getContextsAndViews(false));

      case 3:
        contexts = context$1$0.sent;
        return context$1$0.abrupt('return', contexts.map(function (context) {
          return context.id.toString();
        }));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setContext = function callee$0$0(name, callback, skipReadyCheck) {
  var alreadyInContext, contextId, _$map, _$map2, appIdKey, pageIdKey;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        alreadyInContext = function alreadyInContext(desired, current) {
          return desired === current || desired === null && current === NATIVE_WIN || desired === NATIVE_WIN && current === null;
        };

        _logger2['default'].debug('Attempting to set context to \'' + name + '\'');

        if (!alreadyInContext(name, this.curContext)) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 33;
        break;

      case 5:
        if (!(name === NATIVE_WIN || name === null)) {
          context$1$0.next = 10;
          break;
        }

        // switching into the native context
        this.curContext = null;
        if (this.isRealDevice()) {
          this.remote.disconnect();
        }
        context$1$0.next = 33;
        break;

      case 10:
        if (!_lodash2['default'].isUndefined(this.contexts)) {
          context$1$0.next = 13;
          break;
        }

        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.getContexts());

      case 13:
        contextId = name.replace(WEBVIEW_BASE, '');

        if (contextId === '') {
          // allow user to pass in "WEBVIEW" without an index
          // the second context will be the first webview as
          // the first is always NATIVE_APP
          contextId = this.contexts[1];
        }

        if (_lodash2['default'].includes(this.contexts, contextId)) {
          context$1$0.next = 17;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchContextError();

      case 17:
        if (!this.isRealDevice()) {
          context$1$0.next = 26;
          break;
        }

        if (!this.remote) {
          context$1$0.next = 21;
          break;
        }

        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(this.remote.disconnect());

      case 21:
        this.curContext = contextId;
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(this.remote.connect(contextId));

      case 24:
        context$1$0.next = 33;
        break;

      case 26:
        _$map = _lodash2['default'].map(contextId.split('.'), function (id) {
          return parseInt(id, 10);
        });
        _$map2 = _slicedToArray(_$map, 2);
        appIdKey = _$map2[0];
        pageIdKey = _$map2[1];
        context$1$0.next = 32;
        return _regeneratorRuntime.awrap(this.remote.selectPage(appIdKey, pageIdKey, skipReadyCheck));

      case 32:
        this.curContext = contextId;

      case 33:

        // attempt to start performance logging, if requested
        if (this.opts.enablePerformanceLogging && this.remote) {
          _logger2['default'].debug('Starting performance log on \'' + this.curContext + '\'');
          this.logs.performance = new _deviceLogIosPerformanceLog.IOSPerformanceLog(this.remote);
          this.logs.performance.startCapture();
        }

      case 34:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getWindowHandle = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        return context$1$0.abrupt('return', this.curContext.toString());

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getWindowHandles = function callee$0$0() {
  var pageArray, idArray;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.listWebFrames());

      case 4:
        pageArray = context$1$0.sent;

        this.windowHandleCache = _lodash2['default'].map(pageArray, this.massagePage);
        idArray = _lodash2['default'].map(this.windowHandleCache, 'id');

        // since we use this.contexts to manage selecting debugger pages, make
        // sure it gets populated even if someone did not use the
        // getContexts method
        if (!this.contexts) {
          this.contexts = idArray;
        }
        return context$1$0.abrupt('return', _lodash2['default'].map(idArray, function (id) {
          return id.toString();
        }));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setWindow = function callee$0$0(name, skipReadyCheck) {
  var pageIdKey;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        if (_lodash2['default'].includes(_lodash2['default'].map(this.windowHandleCache, 'id'), name)) {
          context$1$0.next = 4;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchWindowError();

      case 4:
        pageIdKey = parseInt(name, 10);

        if (this.isRealDevice()) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.remote.selectPage(pageIdKey, skipReadyCheck));

      case 8:
        this.curContext = this.curWindowHandle = name;
        context$1$0.next = 24;
        break;

      case 11:
        if (!(name === this.curWindowHandle)) {
          context$1$0.next = 15;
          break;
        }

        _logger2['default'].debug('Remote debugger is already connected to window \'' + name + '\'');
        context$1$0.next = 24;
        break;

      case 15:
        if (_lodash2['default'].includes(_lodash2['default'].map(this.windowHandleCache, 'id'), name)) {
          context$1$0.next = 19;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchWindowError();

      case 19:
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(this.remote.disconnect());

      case 21:
        this.curContext = this.curWindowHandle = name;
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(this.remote.connect(name));

      case 24:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.webContextIndex = function () {
  return this.curContext.replace(WEBVIEW_BASE, '') - 1;
};

extensions.initAutoWebview = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.opts.autoWebview) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].debug('Setting auto webview');
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.navToInitialWebview(this));

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.getContextsAndViews = function callee$0$0() {
  var useUrl = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];

  var webviews, ctxs, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, view;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Retrieving contexts and views');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.listWebFrames(useUrl));

      case 3:
        webviews = context$1$0.sent;
        ctxs = [{ id: NATIVE_WIN }];

        this.contexts = [NATIVE_WIN];
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 9;
        for (_iterator = _getIterator(webviews); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          view = _step.value;

          ctxs.push({ id: '' + WEBVIEW_BASE + view.id, view: view });
          this.contexts.push(view.id.toString());
        }
        context$1$0.next = 17;
        break;

      case 13:
        context$1$0.prev = 13;
        context$1$0.t0 = context$1$0['catch'](9);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 17:
        context$1$0.prev = 17;
        context$1$0.prev = 18;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 20:
        context$1$0.prev = 20;

        if (!_didIteratorError) {
          context$1$0.next = 23;
          break;
        }

        throw _iteratorError;

      case 23:
        return context$1$0.finish(20);

      case 24:
        return context$1$0.finish(17);

      case 25:
        return context$1$0.abrupt('return', ctxs);

      case 26:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[9, 13, 17, 25], [18,, 20, 24]]);
};

extensions.listWebFrames = function callee$0$0() {
  var useUrl = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
  var currentUrl, pageArray, appInfo, tryClosingAlert;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.opts.bundleId) {
          _logger2['default'].errorAndThrow('Cannot enter web frame without a bundle ID');
        }

        useUrl = useUrl && !!this.getCurrentUrl();
        /* jshint ignore:start */
        _logger2['default'].debug('Selecting by url: ' + useUrl + ' ' + (useUrl ? '(expected url: \'' + this.getCurrentUrl() + '\')' : ''));
        /* jshint ignore:end */

        currentUrl = useUrl ? this.getCurrentUrl() : undefined;
        pageArray = undefined;

        if (!(this.isRealDevice() && this.remote && this.opts.bundleId)) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.remote.pageArrayFromJson());

      case 8:
        pageArray = context$1$0.sent;
        context$1$0.next = 54;
        break;

      case 11:
        if (!(this.remote && this.remote.appIdKey)) {
          context$1$0.next = 17;
          break;
        }

        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(this.remote.selectApp(currentUrl, this.opts.webviewConnectRetries));

      case 14:
        pageArray = context$1$0.sent;
        context$1$0.next = 54;
        break;

      case 17:
        if (!this.isRealDevice()) {
          context$1$0.next = 34;
          break;
        }

        context$1$0.prev = 18;

        this.remote = new _appiumRemoteDebugger.WebKitRemoteDebugger({
          port: this.opts.webkitDebugProxyPort,
          webkitResponseTimeout: this.opts.webkitResponseTimeout
        });
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(this.remote.pageArrayFromJson());

      case 22:
        pageArray = context$1$0.sent;
        context$1$0.next = 32;
        break;

      case 25:
        context$1$0.prev = 25;
        context$1$0.t0 = context$1$0['catch'](18);

        if (_lodash2['default'].includes(context$1$0.t0.message, 'connect ECONNREFUSED')) {
          context$1$0.next = 29;
          break;
        }

        throw context$1$0.t0;

      case 29:

        _logger2['default'].warn('Attempted to get a list of webview contexts but could not connect to ' + 'ios-webkit-debug-proxy. If you expect to find webviews, please ensure ' + 'that the proxy is running and accessible');
        this.remote = null;
        pageArray = [];

      case 32:
        context$1$0.next = 54;
        break;

      case 34:
        // simulator, and not connected
        this.remote = new _appiumRemoteDebugger.RemoteDebugger({
          bundleId: this.opts.bundleId,
          useNewSafari: this.useNewSafari(),
          pageLoadMs: this.pageLoadMs,
          platformVersion: this.opts.platformVersion
        });

        context$1$0.next = 37;
        return _regeneratorRuntime.awrap(this.remote.connect());

      case 37:
        appInfo = context$1$0.sent;

        if (appInfo) {
          context$1$0.next = 41;
          break;
        }

        _logger2['default'].debug('Unable to connect to the remote debugger.');
        return context$1$0.abrupt('return', []);

      case 41:
        context$1$0.next = 43;
        return _regeneratorRuntime.awrap(this.remote.selectApp(currentUrl, this.opts.webviewConnectRetries));

      case 43:
        pageArray = context$1$0.sent;

        this.remote.on(_appiumRemoteDebugger.RemoteDebugger.EVENT_PAGE_CHANGE, this.onPageChange.bind(this));

        tryClosingAlert = function tryClosingAlert() {
          var didDismiss;
          return _regeneratorRuntime.async(function tryClosingAlert$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.closeAlertBeforeTest());

              case 2:
                didDismiss = context$2$0.sent;

                if (didDismiss) {
                  context$2$0.next = 5;
                  break;
                }

                throw new Error('Close alert failed. Retry.');

              case 5:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.prev = 46;
        context$1$0.next = 49;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(3, 4000, tryClosingAlert));

      case 49:
        context$1$0.next = 54;
        break;

      case 51:
        context$1$0.prev = 51;
        context$1$0.t1 = context$1$0['catch'](46);

        // if the loop to close alerts failed to dismiss, ignore,
        // otherwise log and throw the error
        if (context$1$0.t1.message !== 'Close alert failed. Retry.') {
          _logger2['default'].errorAndThrow(context$1$0.t1);
        }

      case 54:

        if (pageArray.length === 0) {
          // we have no web frames, but continue anyway
          _logger2['default'].debug('No web frames found.');
        }
        return context$1$0.abrupt('return', pageArray);

      case 56:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[18, 25], [46, 51]]);
};

extensions.onPageChange = function callee$0$0(pageChangeNotification) {
  var appIdKey, pageArray, newIds, newPages, keyId, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, page, id, contextId, newPage, _curContext$split, _curContext$split2, curAppIdKey, curPageIdKey, needsPageLoad;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Remote debugger notified us of a new page listing: ' + JSON.stringify(pageChangeNotification));

        if (!this.selectingNewPage) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].debug('We are in the middle of selecting a page, ignoring');
        return context$1$0.abrupt('return');

      case 4:
        if (this.remote.appIdKey) {
          context$1$0.next = 7;
          break;
        }

        _logger2['default'].debug('We have not yet connected, ignoring');
        return context$1$0.abrupt('return');

      case 7:
        appIdKey = pageChangeNotification.appIdKey;
        pageArray = pageChangeNotification.pageArray;
        newIds = [];
        newPages = [];
        keyId = null;
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 15;

        for (_iterator2 = _getIterator(pageArray); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          page = _step2.value;
          id = page.id.toString();

          newIds.push(id);
          if (page.isKey) {
            keyId = id;
          }
          contextId = appIdKey + '.' + id;

          if (!_lodash2['default'].includes(this.contexts, contextId)) {
            newPages.push(id);
            this.contexts.push(contextId);
          }
        }

        context$1$0.next = 23;
        break;

      case 19:
        context$1$0.prev = 19;
        context$1$0.t0 = context$1$0['catch'](15);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t0;

      case 23:
        context$1$0.prev = 23;
        context$1$0.prev = 24;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 26:
        context$1$0.prev = 26;

        if (!_didIteratorError2) {
          context$1$0.next = 29;
          break;
        }

        throw _iteratorError2;

      case 29:
        return context$1$0.finish(26);

      case 30:
        return context$1$0.finish(23);

      case 31:
        if (!keyId) {
          // if there is no key id, pull the first id from the page array and use that
          // as a stand in
          _logger2['default'].debug('No key id found. Choosing first id from page array');
          keyId = newIds[0] || null;
        }

        newPage = null;

        if (!(this.curContext === null)) {
          context$1$0.next = 37;
          break;
        }

        _logger2['default'].debug('We do not appear to have window set yet, ignoring');
        context$1$0.next = 69;
        break;

      case 37:
        _curContext$split = this.curContext.split('.');
        _curContext$split2 = _slicedToArray(_curContext$split, 2);
        curAppIdKey = _curContext$split2[0];
        curPageIdKey = _curContext$split2[1];

        if (!(curAppIdKey !== appIdKey)) {
          context$1$0.next = 44;
          break;
        }

        _logger2['default'].debug('Page change not referring to currently selected app, ignoring.');
        return context$1$0.abrupt('return');

      case 44:
        if (!newPages.length) {
          context$1$0.next = 49;
          break;
        }

        newPage = _lodash2['default'].last(newPages);
        _logger2['default'].debug('We have new pages, going to select page \'' + newPage + '\'');
        context$1$0.next = 69;
        break;

      case 49:
        if (_lodash2['default'].includes(newIds, curPageIdKey)) {
          context$1$0.next = 62;
          break;
        }

        _logger2['default'].debug('New page listing from remote debugger does not contain ' + 'current window; assuming it is closed');

        if (!(keyId !== null)) {
          context$1$0.next = 55;
          break;
        }

        _logger2['default'].debug('Debugger already selected page \'' + keyId + '\', ' + 'confirming that choice.');
        context$1$0.next = 58;
        break;

      case 55:
        _logger2['default'].error('Do not have our current window anymore, and there ' + 'are not any more to load! Doing nothing...');
        this.setCurrentUrl(undefined);
        return context$1$0.abrupt('return');

      case 58:
        this.curContext = appIdKey + '.' + keyId;
        newPage = keyId;
        context$1$0.next = 69;
        break;

      case 62:
        _logger2['default'].debug('Checking if page needs to load');
        // If a window navigates to an anchor it doesn't always fire a page
        // callback event. Let's check if we wound up in such a situation.

        needsPageLoad = (function () {
          var item = function item(arr) {
            return _lodash2['default'].filter(arr, function (obj) {
              return obj.id === _this2.curContext;
            })[0];
          };

          // need to map the page ids to context ids
          var contextArray = _lodash2['default'].map(pageArray, function (arr) {
            return { id: appIdKey + '.' + arr.id };
          });
          return !_lodash2['default'].isEqual(item(_this2.contexts), item(contextArray));
        })();

        if (!needsPageLoad) {
          context$1$0.next = 68;
          break;
        }

        _logger2['default'].debug('Page load needed. Loading.');
        context$1$0.next = 68;
        return _regeneratorRuntime.awrap(this.remote.pageLoad());

      case 68:

        _logger2['default'].debug('New page listing is same as old, doing nothing');

      case 69:

        // make sure that the page listing isn't indicating a redirect
        if (_appiumSupport.util.hasValue(this.curContext)) {
          (function () {
            var currentPageId = parseInt(_lodash2['default'].last(_this2.curContext.split('.')), 10);
            var page = _lodash2['default'].find(pageArray, function (p) {
              return parseInt(p.id, 10) === currentPageId;
            });
            if (page && page.url !== _this2.getCurrentUrl()) {
              _logger2['default'].debug('Redirected from \'' + _this2.getCurrentUrl() + '\' to \'' + page.url + '\'');
              _this2.setCurrentUrl(page.url);
            }
          })();
        }

        if (!_appiumSupport.util.hasValue(newPage)) {
          context$1$0.next = 76;
          break;
        }

        this.selectingNewPage = true;
        context$1$0.next = 74;
        return _regeneratorRuntime.awrap(this.remote.selectPage(appIdKey, parseInt(newPage, 10)));

      case 74:
        this.selectingNewPage = false;
        this.curContext = appIdKey + '.' + newPage;

      case 76:
        this.windowHandleCache = _lodash2['default'].map(pageArray, this.massagePage);

      case 77:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[15, 19, 23, 31], [24,, 26, 30]]);
};

extensions.getLatestWebviewContextForTitle = function callee$0$0(regExp) {
  var contexts, matchingCtx, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, ctx;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getContextsAndViews());

      case 2:
        contexts = context$1$0.sent;
        matchingCtx = undefined;
        _iteratorNormalCompletion3 = true;
        _didIteratorError3 = false;
        _iteratorError3 = undefined;
        context$1$0.prev = 7;
        _iterator3 = _getIterator(contexts);

      case 9:
        if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
          context$1$0.next = 17;
          break;
        }

        ctx = _step3.value;

        if (!(ctx.view && ((ctx.view.title || '').match(regExp) || (ctx.view.url || '').match(regExp)))) {
          context$1$0.next = 14;
          break;
        }

        if (ctx.view.url !== 'about:blank') {
          matchingCtx = ctx;
        } else {
          // in the cases of Xcode < 5 (i.e., iOS SDK Version less than 7)
          // iOS 7.1, iOS 9.0 & iOS 9.1 in a webview (not in Safari)
          // we can have the url be `about:blank`
          if (parseFloat(this.iosSdkVersion) < 7 || parseFloat(this.iosSdkVersion) >= 9 || this.opts.platformVersion === '7.1' && this.opts.app && this.opts.app.toLowerCase() !== 'safari') {
            matchingCtx = ctx;
          }
        }
        return context$1$0.abrupt('break', 17);

      case 14:
        _iteratorNormalCompletion3 = true;
        context$1$0.next = 9;
        break;

      case 17:
        context$1$0.next = 23;
        break;

      case 19:
        context$1$0.prev = 19;
        context$1$0.t0 = context$1$0['catch'](7);
        _didIteratorError3 = true;
        _iteratorError3 = context$1$0.t0;

      case 23:
        context$1$0.prev = 23;
        context$1$0.prev = 24;

        if (!_iteratorNormalCompletion3 && _iterator3['return']) {
          _iterator3['return']();
        }

      case 26:
        context$1$0.prev = 26;

        if (!_didIteratorError3) {
          context$1$0.next = 29;
          break;
        }

        throw _iteratorError3;

      case 29:
        return context$1$0.finish(26);

      case 30:
        return context$1$0.finish(23);

      case 31:
        return context$1$0.abrupt('return', matchingCtx ? matchingCtx.id : undefined);

      case 32:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[7, 19, 23, 31], [24,, 26, 30]]);
};

// Right now we don't necessarily wait for webview
// and frame to load, which leads to race conditions and flakiness,
// let's see if we can transition to something better
extensions.useNewSafari = function () {
  return parseFloat(this.iosSdkVersion) >= 8.1 && parseFloat(this.opts.platformVersion) >= 8.1 && !this.isRealDevice() && this.opts.safari;
};

extensions.navToInitialWebview = function callee$0$0() {
  var timeout;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        timeout = 0;

        if (this.isRealDevice()) {
          timeout = 3000;
          _logger2['default'].debug('Waiting for ' + timeout + ' ms before navigating to view.');
        }
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(timeout));

      case 4:
        if (!this.useNewSafari()) {
          context$1$0.next = 9;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.typeAndNavToUrl());

      case 7:
        context$1$0.next = 16;
        break;

      case 9:
        if (!(parseInt(this.iosSdkVersion, 10) >= 7 && !this.isRealDevice() && this.opts.safari)) {
          context$1$0.next = 14;
          break;
        }

        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.navToViewThroughFavorites());

      case 12:
        context$1$0.next = 16;
        break;

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/.*/));

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

function openNewPage() {
  var newPageButton;
  return _regeneratorRuntime.async(function openNewPage$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.findElement('xpath', "//UIAButton[contains(@name,'New page')]"));

      case 2:
        newPageButton = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.nativeTap(newPageButton.ELEMENT));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

extensions.typeAndNavToUrl = function callee$0$0() {
  var address, tries, MAX_TRIES, navigate;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this4 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        address = this.opts.address ? this.opts.address : '127.0.0.1';

        this.setCurrentUrl(this.caps.safariInitialUrl || 'http://' + address + ':' + this.opts.port + '/welcome');

        tries = 0;
        MAX_TRIES = 2;

        navigate = function navigate() {
          var oldImpWait, el, _el;

          return _regeneratorRuntime.async(function navigate$(context$2$0) {
            var _this3 = this;

            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                oldImpWait = this.implicitWaitMs;

                this.implicitWaitMs = 7000;

                // find the url bar, and tap on it. retry to make sure we don't try
                // too soon while the view is still loading
                context$2$0.next = 4;
                return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(3, 1000, function callee$2$0() {
                  return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                    while (1) switch (context$3$0.prev = context$3$0.next) {
                      case 0:
                        context$3$0.next = 2;
                        return _regeneratorRuntime.awrap(this.findElement('accessibility id', 'URL'));

                      case 2:
                        return context$3$0.abrupt('return', context$3$0.sent);

                      case 3:
                      case 'end':
                        return context$3$0.stop();
                    }
                  }, null, _this3);
                }));

              case 4:
                el = context$2$0.sent;

                this.implicitWaitMs = oldImpWait;

                context$2$0.prev = 6;
                context$2$0.next = 9;
                return _regeneratorRuntime.awrap(this.nativeTap(el.ELEMENT));

              case 9:
                context$2$0.next = 24;
                break;

              case 11:
                context$2$0.prev = 11;
                context$2$0.t0 = context$2$0['catch'](6);

                if (!_lodash2['default'].includes(context$2$0.t0.message, 'could not be tapped')) {
                  context$2$0.next = 23;
                  break;
                }

                if (!(tries++ >= MAX_TRIES)) {
                  context$2$0.next = 16;
                  break;
                }

                throw context$2$0.t0;

              case 16:
                context$2$0.next = 18;
                return _regeneratorRuntime.awrap(openNewPage());

              case 18:
                context$2$0.next = 20;
                return _regeneratorRuntime.awrap(navigate());

              case 20:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 23:
                throw context$2$0.t0;

              case 24:
                context$2$0.prev = 24;
                context$2$0.next = 27;
                return _regeneratorRuntime.awrap(this.findElement('class name', 'UIATextField'));

              case 27:
                _el = context$2$0.sent;
                context$2$0.next = 30;
                return _regeneratorRuntime.awrap(this.setValueImmediate(this.getCurrentUrl(), _el));

              case 30:
                context$2$0.next = 39;
                break;

              case 32:
                context$2$0.prev = 32;
                context$2$0.t1 = context$2$0['catch'](24);

                if (!(tries++ >= MAX_TRIES)) {
                  context$2$0.next = 36;
                  break;
                }

                throw context$2$0.t1;

              case 36:
                context$2$0.next = 38;
                return _regeneratorRuntime.awrap(navigate());

              case 38:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 39:
                context$2$0.prev = 39;
                context$2$0.next = 42;
                return _regeneratorRuntime.awrap(this.findElement('accessibility id', 'Go'));

              case 42:
                el = context$2$0.sent;
                context$2$0.next = 45;
                return _regeneratorRuntime.awrap(this.nativeTap(el.ELEMENT));

              case 45:
                context$2$0.next = 51;
                break;

              case 47:
                context$2$0.prev = 47;
                context$2$0.t2 = context$2$0['catch'](39);

                if (_lodash2['default'].includes(context$2$0.t2.message, 'could not be tapped')) {
                  _logger2['default'].error('Unable to submit URL because \'Go\' button could not be tapped. ' + 'Please make sure your keyboard is toggled on.');
                }
                throw context$2$0.t2;

              case 51:
                context$2$0.next = 53;
                return _regeneratorRuntime.awrap(this.navToViewWithTitle(undefined, new RegExp(this.getCurrentUrl(), 'i')));

              case 53:
                context$2$0.next = 55;
                return _regeneratorRuntime.awrap(this.remote.pageUnload());

              case 55:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this4, [[6, 11], [24, 32], [39, 47]]);
        };

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(navigate());

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.navToViewThroughFavorites = function callee$0$0() {
  var oldImpWait, el, msg;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('We are on iOS7+ simulator: clicking apple button to get into a webview');
        oldImpWait = this.implicitWaitMs;

        this.implicitWaitMs = 7000; // wait 7s for apple button to exist

        el = undefined;
        context$1$0.prev = 4;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.findElement('xpath', '//UIAScrollView[1]/UIAButton[1]'));

      case 7:
        el = context$1$0.sent;
        context$1$0.next = 18;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](4);
        msg = 'Could not find button to click to get into webview. ' + 'Proceeding on the assumption we have a working one.';

        _logger2['default'].error(msg);
        this.implicitWaitMs = oldImpWait;
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/.*/i));

      case 17:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 18:
        this.implicitWaitMs = oldImpWait;
        context$1$0.prev = 19;
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(this.nativeTap(el.ELEMENT));

      case 22:
        context$1$0.next = 28;
        break;

      case 24:
        context$1$0.prev = 24;
        context$1$0.t1 = context$1$0['catch'](19);
        msg = 'Could not click button to get into webview. ' + 'Proceeding on the assumption we have a working one.';

        _logger2['default'].error(msg);

      case 28:
        context$1$0.next = 30;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/apple/i));

      case 30:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[4, 10], [19, 24]]);
};

extensions.navToViewWithTitle = function callee$0$0(titleRegex, urlRegExp) {
  var start, spinTime, spinHandles;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this5 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Navigating to most recently opened webview');
        start = Date.now();
        spinTime = 500;

        spinHandles = function spinHandles() {
          var res, latestWindow, element;
          return _regeneratorRuntime.async(function spinHandles$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                res = undefined;
                context$2$0.prev = 1;
                context$2$0.next = 4;
                return _regeneratorRuntime.awrap(this.getLatestWebviewContextForTitle(titleRegex || urlRegExp));

              case 4:
                res = context$2$0.sent;
                context$2$0.next = 12;
                break;

              case 7:
                context$2$0.prev = 7;
                context$2$0.t0 = context$2$0['catch'](1);

                if (!(context$2$0.t0.message.indexOf('Could not connect to a valid app after') === -1)) {
                  context$2$0.next = 11;
                  break;
                }

                throw new Error('Could not navigate to webview! Err: ' + context$2$0.t0.message);

              case 11:
                _logger2['default'].debug('Could not navigate to webview. Retrying if possible.');

              case 12:
                if (!res) {
                  context$2$0.next = 20;
                  break;
                }

                latestWindow = res;

                _logger2['default'].debug('Picking webview \'' + latestWindow + '\'');
                context$2$0.next = 17;
                return _regeneratorRuntime.awrap(this.setContext(latestWindow));

              case 17:
                context$2$0.next = 19;
                return _regeneratorRuntime.awrap(this.remote.cancelPageLoad());

              case 19:
                return context$2$0.abrupt('return');

              case 20:
                if (!(Date.now() - start >= 90000)) {
                  context$2$0.next = 22;
                  break;
                }

                throw new Error('Could not navigate to webview; there are none!');

              case 22:

                _logger2['default'].warn("Could not find any webviews yet, refreshing/retrying");

                if (!(this.isRealDevice() || !this.opts.safari)) {
                  context$2$0.next = 29;
                  break;
                }

                context$2$0.next = 26;
                return _regeneratorRuntime.awrap(_bluebird2['default'].delay(spinTime));

              case 26:
                context$2$0.next = 28;
                return _regeneratorRuntime.awrap(spinHandles());

              case 28:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 29:
                element = undefined;
                context$2$0.prev = 30;

                _logger2['default'].debug('Finding and tapping reload button');
                context$2$0.next = 34;
                return _regeneratorRuntime.awrap(this.findUIElementOrElements('accessibility id', 'ReloadButton', '', false));

              case 34:
                element = context$2$0.sent;
                context$2$0.next = 37;
                return _regeneratorRuntime.awrap(this.nativeTap(element.ELEMENT));

              case 37:
                context$2$0.next = 45;
                break;

              case 39:
                context$2$0.prev = 39;
                context$2$0.t1 = context$2$0['catch'](30);

                _logger2['default'].warn('Error finding and tapping reload button: ' + context$2$0.t1.message);
                _logger2['default'].warn('Retrying.');
                context$2$0.next = 45;
                return _regeneratorRuntime.awrap(_bluebird2['default'].delay(spinTime));

              case 45:
                context$2$0.next = 47;
                return _regeneratorRuntime.awrap(spinHandles());

              case 47:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 48:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this5, [[1, 7], [30, 39]]);
        };

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(spinHandles());

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.closeAlertBeforeTest = function callee$0$0() {
  var present;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.alertIsPresent()'));

      case 2:
        present = context$1$0.sent;

        if (present) {
          context$1$0.next = 5;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 5:

        _logger2['default'].debug('Alert present before starting test, let us banish it');
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.dismissAlert()'));

      case 8:
        _logger2['default'].debug('Alert banished!');
        return context$1$0.abrupt('return', true);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.stopRemote = function callee$0$0() {
  var closeWindowBeforeDisconnecting = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.remote) {
          _logger2['default'].errorAndThrow('Tried to leave a web frame but were not in one');
        }

        if (!closeWindowBeforeDisconnecting) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.closeWindow());

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.remote.disconnect());

      case 6:
        this.curContext = null;
        this.curWebFrames = [];
        this.curWebCoords = null;
        this.remote = null;

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.isWebContext = function () {
  return !!this.curContext && this.curContext !== NATIVE_WIN;
};

helpers.setCurrentUrl = function (url) {
  this._currentUrl = url;
};

helpers.getCurrentUrl = function () {
  return this._currentUrl;
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports.NATIVE_WIN = NATIVE_WIN;
exports.WEBVIEW_WIN = WEBVIEW_WIN;
exports.WEBVIEW_BASE = WEBVIEW_BASE;
exports['default'] = extensions;

// already in the named context, no need to do anything

// switching into a webview context

// if contexts have not already been retrieved, get them

// `contextId` will be in the form of `appId.pageId` in this case

// real device, and already connected

// simulator, and already connected

// real device, and not connected

// it is reasonable to expect that this might be called when there is no
// webkit remote debugger to connect to

// generally this means that Safari is in page viewing mode
// so try to open a new page and then redo the navigation

// get the last address element and set the url

// this is flakey on certain systems so we retry until we get something
// ios sims: safari opens but the text field can't be found

// make it happen

// wait for page to finish loading.

// no webview was found

// too slow, get out

// on a real device, when not using Safari, we just want to try again

// find the reload button and tap it, if possible

// try it all again
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBQWMsUUFBUTs7Ozt3QkFDUixVQUFVOzs7O3dCQUNNLFVBQVU7O29DQUNhLHdCQUF3Qjs7MENBQzNDLG1DQUFtQzs7Z0NBQzlDLG9CQUFvQjs7c0JBQ3hCLFdBQVc7Ozs7NkJBQ1QsZ0JBQWdCOztBQUdyQyxJQUFNLFVBQVUsR0FBRyxZQUFZLENBQUM7QUFDaEMsSUFBTSxXQUFXLEdBQUcsU0FBUyxDQUFDO0FBQzlCLElBQU0sWUFBWSxHQUFNLFdBQVcsTUFBRyxDQUFDOztBQUV2QyxJQUFJLFFBQVEsR0FBRyxFQUFFO0lBQUUsT0FBTyxHQUFHLEVBQUU7SUFBRSxVQUFVLEdBQUcsRUFBRSxDQUFDOztBQUVqRCxRQUFRLENBQUMsaUJBQWlCLEdBQUc7Ozs7Y0FDdkIsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxLQUFLLFVBQVUsQ0FBQTs7Ozs7aURBQ3pDLFlBQVksR0FBRyxJQUFJLENBQUMsVUFBVTs7OzRDQUVqQyxVQUFVOzs7Ozs7O0NBRXBCLENBQUM7O0FBRUYsUUFBUSxDQUFDLFdBQVcsR0FBRztNQUVqQixRQUFROzs7O0FBRFosNEJBQU8sS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7O3lDQUM5QixJQUFJLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDOzs7QUFBaEQsZ0JBQVE7NENBQ0wsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFDLE9BQU87aUJBQUssT0FBTyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUU7U0FBQSxDQUFDOzs7Ozs7O0NBQ3hELENBQUM7O0FBRUYsUUFBUSxDQUFDLFVBQVUsR0FBRyxvQkFBZ0IsSUFBSSxFQUFFLFFBQVEsRUFBRSxjQUFjO01BQ3pELGdCQUFnQixFQXVCbkIsU0FBUyxpQkFtQk4sUUFBUSxFQUFFLFNBQVM7Ozs7O0FBMUNuQix3QkFBZ0IsWUFBaEIsZ0JBQWdCLENBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRTtBQUMzQyxpQkFBUSxPQUFPLEtBQUssT0FBTyxJQUNuQixPQUFPLEtBQUssSUFBSSxJQUFJLE9BQU8sS0FBSyxVQUFVLEFBQUMsSUFDM0MsT0FBTyxLQUFLLFVBQVUsSUFBSSxPQUFPLEtBQUssSUFBSSxBQUFDLENBQUU7U0FDdEQ7O0FBRUQsNEJBQU8sS0FBSyxxQ0FBa0MsSUFBSSxRQUFJLENBQUM7O2FBQ25ELGdCQUFnQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDOzs7Ozs7Ozs7Y0FFaEMsSUFBSSxLQUFLLFVBQVUsSUFBSSxJQUFJLEtBQUssSUFBSSxDQUFBOzs7Ozs7QUFFN0MsWUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7QUFDdkIsWUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUU7QUFDdkIsY0FBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUMxQjs7Ozs7YUFLRyxvQkFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQzs7Ozs7O3lDQUN4QixJQUFJLENBQUMsV0FBVyxFQUFFOzs7QUFHdEIsaUJBQVMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUM7O0FBQzlDLFlBQUksU0FBUyxLQUFLLEVBQUUsRUFBRTs7OztBQUlwQixtQkFBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDOUI7O1lBQ0ksb0JBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDOzs7OztjQUNqQyxJQUFJLHlCQUFPLGtCQUFrQixFQUFFOzs7YUFHbkMsSUFBSSxDQUFDLFlBQVksRUFBRTs7Ozs7YUFDakIsSUFBSSxDQUFDLE1BQU07Ozs7Ozt5Q0FDUCxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRTs7O0FBRWhDLFlBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDOzt5Q0FDdEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDOzs7Ozs7O2dCQUdSLG9CQUFFLEdBQUcsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLFVBQUMsRUFBRTtpQkFBSyxRQUFRLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQztTQUFBLENBQUM7O0FBQTVFLGdCQUFRO0FBQUUsaUJBQVM7O3lDQUNsQixJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLGNBQWMsQ0FBQzs7O0FBQ2pFLFlBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDOzs7OztBQUtoQyxZQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsd0JBQXdCLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtBQUNyRCw4QkFBTyxLQUFLLG9DQUFpQyxJQUFJLENBQUMsVUFBVSxRQUFJLENBQUM7QUFDakUsY0FBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsa0RBQXNCLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzRCxjQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztTQUN0Qzs7Ozs7OztDQUNGLENBQUM7O0FBRUYsUUFBUSxDQUFDLGVBQWUsR0FBRzs7OztZQUNwQixJQUFJLENBQUMsWUFBWSxFQUFFOzs7OztjQUNoQixJQUFJLHlCQUFPLG1CQUFtQixFQUFFOzs7NENBRWpDLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFOzs7Ozs7O0NBQ2xDLENBQUM7O0FBRUYsUUFBUSxDQUFDLGdCQUFnQixHQUFHO01BS3RCLFNBQVMsRUFFVCxPQUFPOzs7O1lBTk4sSUFBSSxDQUFDLFlBQVksRUFBRTs7Ozs7Y0FDaEIsSUFBSSx5QkFBTyxtQkFBbUIsRUFBRTs7Ozt5Q0FHbEIsSUFBSSxDQUFDLGFBQWEsRUFBRTs7O0FBQXRDLGlCQUFTOztBQUNiLFlBQUksQ0FBQyxpQkFBaUIsR0FBRyxvQkFBRSxHQUFHLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUN4RCxlQUFPLEdBQUcsb0JBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUM7Ozs7O0FBSWpELFlBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO0FBQ2xCLGNBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDO1NBQ3pCOzRDQUNNLG9CQUFFLEdBQUcsQ0FBQyxPQUFPLEVBQUUsVUFBQyxFQUFFO2lCQUFLLEVBQUUsQ0FBQyxRQUFRLEVBQUU7U0FBQSxDQUFDOzs7Ozs7O0NBQzdDLENBQUM7O0FBRUYsUUFBUSxDQUFDLFNBQVMsR0FBRyxvQkFBZ0IsSUFBSSxFQUFFLGNBQWM7TUFRbkQsU0FBUzs7OztZQVBSLElBQUksQ0FBQyxZQUFZLEVBQUU7Ozs7O2NBQ2hCLElBQUkseUJBQU8sbUJBQW1CLEVBQUU7OztZQUduQyxvQkFBRSxRQUFRLENBQUMsb0JBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUM7Ozs7O2NBQ2xELElBQUkseUJBQU8saUJBQWlCLEVBQUU7OztBQUVsQyxpQkFBUyxHQUFHLFFBQVEsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDOztZQUM3QixJQUFJLENBQUMsWUFBWSxFQUFFOzs7Ozs7eUNBQ2hCLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLFNBQVMsRUFBRSxjQUFjLENBQUM7OztBQUN2RCxZQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDOzs7OztjQUUxQyxJQUFJLEtBQUssSUFBSSxDQUFDLGVBQWUsQ0FBQTs7Ozs7QUFDL0IsNEJBQU8sS0FBSyx1REFBb0QsSUFBSSxRQUFJLENBQUM7Ozs7O1lBQy9ELG9CQUFFLFFBQVEsQ0FBQyxvQkFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQzs7Ozs7Y0FDekQsSUFBSSx5QkFBTyxpQkFBaUIsRUFBRTs7Ozt5Q0FFOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUU7OztBQUM5QixZQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDOzt5Q0FDeEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDOzs7Ozs7O0NBR3BDLENBQUM7O0FBRUYsT0FBTyxDQUFDLGVBQWUsR0FBRyxZQUFZO0FBQ3BDLFNBQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztDQUN0RCxDQUFDOztBQUVGLFVBQVUsQ0FBQyxlQUFlLEdBQUc7Ozs7YUFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXOzs7OztBQUN2Qiw0QkFBTyxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQzs7eUNBQy9CLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUM7Ozs7Ozs7Q0FFdkMsQ0FBQzs7QUFFRixVQUFVLENBQUMsbUJBQW1CLEdBQUc7TUFBZ0IsTUFBTSx5REFBRyxJQUFJOztNQUV4RCxRQUFRLEVBQ1IsSUFBSSxrRkFFQyxJQUFJOzs7OztBQUpiLDRCQUFPLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDOzt5Q0FDekIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUM7OztBQUEzQyxnQkFBUTtBQUNSLFlBQUksR0FBRyxDQUFDLEVBQUMsRUFBRSxFQUFFLFVBQVUsRUFBQyxDQUFDOztBQUM3QixZQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7Ozs7O0FBQzdCLHNDQUFpQixRQUFRLHFHQUFFO0FBQWxCLGNBQUk7O0FBQ1gsY0FBSSxDQUFDLElBQUksQ0FBQyxFQUFDLEVBQUUsT0FBSyxZQUFZLEdBQUcsSUFBSSxDQUFDLEVBQUUsQUFBRSxFQUFFLElBQUksRUFBSixJQUFJLEVBQUMsQ0FBQyxDQUFDO0FBQ25ELGNBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztTQUN4Qzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7NENBQ00sSUFBSTs7Ozs7OztDQUNaLENBQUM7O0FBRUYsVUFBVSxDQUFDLGFBQWEsR0FBRztNQUFnQixNQUFNLHlEQUFHLElBQUk7TUFVbEQsVUFBVSxFQUNWLFNBQVMsRUFtQ1AsT0FBTyxFQVFQLGVBQWU7Ozs7OztBQXJEckIsWUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO0FBQ3ZCLDhCQUFPLGFBQWEsQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO1NBQ3BFOztBQUVELGNBQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQzs7QUFFMUMsNEJBQU8sS0FBSyx3QkFBc0IsTUFBTSxVQUFJLE1BQU0seUJBQXNCLElBQUksQ0FBQyxhQUFhLEVBQUUsV0FBTyxFQUFFLENBQUEsQ0FBRyxDQUFDOzs7QUFHckcsa0JBQVUsR0FBRyxNQUFNLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxHQUFHLFNBQVM7QUFDdEQsaUJBQVM7O2NBQ1QsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUE7Ozs7Ozt5Q0FFeEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRTs7O0FBQWpELGlCQUFTOzs7OztjQUNBLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUE7Ozs7Ozt5Q0FFMUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUM7OztBQUFwRixpQkFBUzs7Ozs7YUFDQSxJQUFJLENBQUMsWUFBWSxFQUFFOzs7Ozs7O0FBRzFCLFlBQUksQ0FBQyxNQUFNLEdBQUcsK0NBQXlCO0FBQ3JDLGNBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQjtBQUNwQywrQkFBcUIsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQjtTQUN2RCxDQUFDLENBQUM7O3lDQUNlLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLEVBQUU7OztBQUFqRCxpQkFBUzs7Ozs7Ozs7WUFJSixvQkFBRSxRQUFRLENBQUMsZUFBSSxPQUFPLEVBQUUsc0JBQXNCLENBQUM7Ozs7Ozs7OztBQUVwRCw0QkFBTyxJQUFJLENBQUMsdUVBQXVFLEdBQ3ZFLHdFQUF3RSxHQUN4RSwwQ0FBMEMsQ0FBQyxDQUFDO0FBQ3hELFlBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO0FBQ25CLGlCQUFTLEdBQUcsRUFBRSxDQUFDOzs7Ozs7OztBQUlqQixZQUFJLENBQUMsTUFBTSxHQUFHLHlDQUFtQjtBQUMvQixrQkFBUSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUTtBQUM1QixzQkFBWSxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUU7QUFDakMsb0JBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtBQUMzQix5QkFBZSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZTtTQUMzQyxDQUFDLENBQUM7Ozt5Q0FFaUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUU7OztBQUFyQyxlQUFPOztZQUNOLE9BQU87Ozs7O0FBQ1YsNEJBQU8sS0FBSyxDQUFDLDJDQUEyQyxDQUFDLENBQUM7NENBQ25ELEVBQUU7Ozs7eUNBRU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUM7OztBQUFwRixpQkFBUzs7QUFDVCxZQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxxQ0FBZSxpQkFBaUIsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDOztBQUUzRSx1QkFBZSxHQUFHLFNBQWxCLGVBQWU7Y0FDYixVQUFVOzs7OztpREFBUyxJQUFJLENBQUMsb0JBQW9CLEVBQUU7OztBQUE5QywwQkFBVTs7b0JBQ1QsVUFBVTs7Ozs7c0JBQ1AsSUFBSSxLQUFLLENBQUMsNEJBQTRCLENBQUM7Ozs7Ozs7U0FFaEQ7Ozs7eUNBRU8sNkJBQWMsQ0FBQyxFQUFFLElBQUksRUFBRSxlQUFlLENBQUM7Ozs7Ozs7Ozs7OztBQUk3QyxZQUFJLGVBQUksT0FBTyxLQUFLLDRCQUE0QixFQUFFO0FBQ2hELDhCQUFPLGFBQWEsZ0JBQUssQ0FBQztTQUMzQjs7OztBQUlMLFlBQUksU0FBUyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7O0FBRTFCLDhCQUFPLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1NBQ3RDOzRDQUNNLFNBQVM7Ozs7Ozs7Q0FDakIsQ0FBQzs7QUFFRixVQUFVLENBQUMsWUFBWSxHQUFHLG9CQUFnQixzQkFBc0I7TUFXekQsUUFBUSxFQUFFLFNBQVMsRUFFcEIsTUFBTSxFQUNOLFFBQVEsRUFDUixLQUFLLHVGQUNBLElBQUksRUFDUCxFQUFFLEVBS0YsU0FBUyxFQWNYLE9BQU8seUNBSUosV0FBVyxFQUFFLFlBQVksRUE0QnhCLGFBQWE7Ozs7Ozs7QUFuRXJCLDRCQUFPLEtBQUsseURBQXVELElBQUksQ0FBQyxTQUFTLENBQUMsc0JBQXNCLENBQUMsQ0FBRyxDQUFDOzthQUN6RyxJQUFJLENBQUMsZ0JBQWdCOzs7OztBQUN2Qiw0QkFBTyxLQUFLLENBQUMsb0RBQW9ELENBQUMsQ0FBQzs7OztZQUdoRSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVE7Ozs7O0FBQ3ZCLDRCQUFPLEtBQUssQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDOzs7O0FBSWpELGdCQUFRLEdBQWUsc0JBQXNCLENBQTdDLFFBQVE7QUFBRSxpQkFBUyxHQUFJLHNCQUFzQixDQUFuQyxTQUFTO0FBRXBCLGNBQU0sR0FBRyxFQUFFO0FBQ1gsZ0JBQVEsR0FBRyxFQUFFO0FBQ2IsYUFBSyxHQUFHLElBQUk7Ozs7OztBQUNoQix1Q0FBaUIsU0FBUyx5R0FBRTtBQUFuQixjQUFJO0FBQ1AsWUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFOztBQUMzQixnQkFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNoQixjQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7QUFDZCxpQkFBSyxHQUFHLEVBQUUsQ0FBQztXQUNaO0FBQ0csbUJBQVMsR0FBTSxRQUFRLFNBQUksRUFBRTs7QUFDakMsY0FBSSxDQUFDLG9CQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxFQUFFO0FBQ3pDLG9CQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2xCLGdCQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztXQUMvQjtTQUNGOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFRCxZQUFJLENBQUMsS0FBSyxFQUFFOzs7QUFHViw4QkFBTyxLQUFLLENBQUMsb0RBQW9ELENBQUMsQ0FBQztBQUNuRSxlQUFLLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQztTQUMzQjs7QUFFRyxlQUFPLEdBQUcsSUFBSTs7Y0FDZCxJQUFJLENBQUMsVUFBVSxLQUFLLElBQUksQ0FBQTs7Ozs7QUFDMUIsNEJBQU8sS0FBSyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7Ozs7OzRCQUVoQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7O0FBQXZELG1CQUFXO0FBQUUsb0JBQVk7O2NBRTFCLFdBQVcsS0FBSyxRQUFRLENBQUE7Ozs7O0FBQzFCLDRCQUFPLEtBQUssQ0FBQyxnRUFBZ0UsQ0FBQyxDQUFDOzs7O2FBSTdFLFFBQVEsQ0FBQyxNQUFNOzs7OztBQUNqQixlQUFPLEdBQUcsb0JBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzNCLDRCQUFPLEtBQUssZ0RBQTZDLE9BQU8sUUFBSSxDQUFDOzs7OztZQUMzRCxvQkFBRSxRQUFRLENBQUMsTUFBTSxFQUFFLFlBQVksQ0FBQzs7Ozs7QUFDMUMsNEJBQU8sS0FBSyxDQUFDLHlEQUF5RCxHQUN6RCx1Q0FBdUMsQ0FBQyxDQUFDOztjQUNsRCxLQUFLLEtBQUssSUFBSSxDQUFBOzs7OztBQUNoQiw0QkFBTyxLQUFLLENBQUMsc0NBQW1DLEtBQUsscUNBQ2YsQ0FBQyxDQUFDOzs7OztBQUV4Qyw0QkFBTyxLQUFLLENBQUMsb0RBQW9ELEdBQ3BELDRDQUE0QyxDQUFDLENBQUM7QUFDM0QsWUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQzs7OztBQUdoQyxZQUFJLENBQUMsVUFBVSxHQUFNLFFBQVEsU0FBSSxLQUFLLEFBQUUsQ0FBQztBQUN6QyxlQUFPLEdBQUcsS0FBSyxDQUFDOzs7OztBQUVoQiw0QkFBTyxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQzs7OztBQUczQyxxQkFBYSxHQUFHLENBQUMsWUFBTTtBQUN6QixjQUFJLElBQUksR0FBRyxTQUFQLElBQUksQ0FBSSxHQUFHLEVBQUs7QUFDbEIsbUJBQU8sb0JBQUUsTUFBTSxDQUFDLEdBQUcsRUFBRSxVQUFDLEdBQUcsRUFBSztBQUM1QixxQkFBTyxHQUFHLENBQUMsRUFBRSxLQUFLLE9BQUssVUFBVSxDQUFDO2FBQ25DLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztXQUNQLENBQUM7OztBQUdGLGNBQUksWUFBWSxHQUFHLG9CQUFFLEdBQUcsQ0FBQyxTQUFTLEVBQUUsVUFBQyxHQUFHLEVBQUs7QUFDM0MsbUJBQU8sRUFBQyxFQUFFLEVBQUssUUFBUSxTQUFJLEdBQUcsQ0FBQyxFQUFFLEFBQUUsRUFBQyxDQUFDO1dBQ3RDLENBQUMsQ0FBQztBQUNILGlCQUFPLENBQUMsb0JBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFLLFFBQVEsQ0FBQyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1NBQzVELENBQUEsRUFBRzs7YUFFQSxhQUFhOzs7OztBQUNmLDRCQUFPLEtBQUssQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDOzt5Q0FDckMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUU7Ozs7QUFHOUIsNEJBQU8sS0FBSyxDQUFDLGdEQUFnRCxDQUFDLENBQUM7Ozs7O0FBS25FLFlBQUksb0JBQUssUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRTs7QUFDbEMsZ0JBQUksYUFBYSxHQUFHLFFBQVEsQ0FBQyxvQkFBRSxJQUFJLENBQUMsT0FBSyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDckUsZ0JBQUksSUFBSSxHQUFHLG9CQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsVUFBQyxDQUFDO3FCQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxLQUFLLGFBQWE7YUFBQSxDQUFDLENBQUM7QUFDMUUsZ0JBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxHQUFHLEtBQUssT0FBSyxhQUFhLEVBQUUsRUFBRTtBQUM3QyxrQ0FBTyxLQUFLLHdCQUFxQixPQUFLLGFBQWEsRUFBRSxnQkFBUyxJQUFJLENBQUMsR0FBRyxRQUFJLENBQUM7QUFDM0UscUJBQUssYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUM5Qjs7U0FDRjs7YUFFRyxvQkFBSyxRQUFRLENBQUMsT0FBTyxDQUFDOzs7OztBQUN4QixZQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDOzt5Q0FDdkIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUM7OztBQUM3RCxZQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO0FBQzlCLFlBQUksQ0FBQyxVQUFVLEdBQU0sUUFBUSxTQUFJLE9BQU8sQUFBRSxDQUFDOzs7QUFFN0MsWUFBSSxDQUFDLGlCQUFpQixHQUFHLG9CQUFFLEdBQUcsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDOzs7Ozs7O0NBQzdELENBQUM7O0FBRUYsVUFBVSxDQUFDLCtCQUErQixHQUFHLG9CQUFnQixNQUFNO01BQzdELFFBQVEsRUFDUixXQUFXLHVGQUNOLEdBQUc7Ozs7Ozt5Q0FGUyxJQUFJLENBQUMsbUJBQW1CLEVBQUU7OztBQUEzQyxnQkFBUTtBQUNSLG1CQUFXOzs7OztrQ0FDQyxRQUFROzs7Ozs7OztBQUFmLFdBQUc7O2NBQ04sR0FBRyxDQUFDLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQSxDQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQSxDQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQSxDQUFDOzs7OztBQUMxRixZQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLGFBQWEsRUFBRTtBQUNsQyxxQkFBVyxHQUFHLEdBQUcsQ0FBQztTQUNuQixNQUFNOzs7O0FBSUwsY0FBSSxVQUFVLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFDeEUsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEtBQUssS0FBSyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxLQUFLLFFBQVEsQUFBQyxFQUFFO0FBQ3RHLHVCQUFXLEdBQUcsR0FBRyxDQUFDO1dBQ25CO1NBQ0Y7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7NENBSUUsV0FBVyxHQUFHLFdBQVcsQ0FBQyxFQUFFLEdBQUcsU0FBUzs7Ozs7OztDQUNoRCxDQUFDOzs7OztBQUtGLFVBQVUsQ0FBQyxZQUFZLEdBQUcsWUFBWTtBQUNwQyxTQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksR0FBRyxJQUNyQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxHQUFHLElBQzVDLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUNwQixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztDQUN6QixDQUFDOztBQUVGLFVBQVUsQ0FBQyxtQkFBbUIsR0FBRztNQUMzQixPQUFPOzs7O0FBQVAsZUFBTyxHQUFHLENBQUM7O0FBQ2YsWUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUU7QUFDdkIsaUJBQU8sR0FBRyxJQUFJLENBQUM7QUFDZiw4QkFBTyxLQUFLLGtCQUFnQixPQUFPLG9DQUFpQyxDQUFDO1NBQ3RFOzt5Q0FDSyxzQkFBRSxLQUFLLENBQUMsT0FBTyxDQUFDOzs7YUFDbEIsSUFBSSxDQUFDLFlBQVksRUFBRTs7Ozs7O3lDQUNmLElBQUksQ0FBQyxlQUFlLEVBQUU7Ozs7Ozs7Y0FDbkIsUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFBOzs7Ozs7eUNBQ3BGLElBQUksQ0FBQyx5QkFBeUIsRUFBRTs7Ozs7Ozs7eUNBRWhDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUM7Ozs7Ozs7Q0FFdEMsQ0FBQzs7QUFFRixTQUFlLFdBQVc7TUFDcEIsYUFBYTs7Ozs7eUNBQVMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUseUNBQXlDLENBQUM7OztBQUExRixxQkFBYTs7eUNBQ1gsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDOzs7Ozs7O0NBQzVDOztBQUVELFVBQVUsQ0FBQyxlQUFlLEdBQUc7TUFDdkIsT0FBTyxFQUdQLEtBQUssRUFDSCxTQUFTLEVBQ1gsUUFBUTs7Ozs7O0FBTFIsZUFBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLFdBQVc7O0FBQ2pFLFlBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsZ0JBQWMsT0FBTyxTQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxhQUFVLENBQUMsQ0FBQzs7QUFFNUYsYUFBSyxHQUFHLENBQUM7QUFDUCxpQkFBUyxHQUFHLENBQUM7O0FBQ2YsZ0JBQVEsR0FBRyxTQUFYLFFBQVE7Y0FDTixVQUFVLEVBS1YsRUFBRSxFQXNCQSxHQUFFOzs7Ozs7O0FBM0JKLDBCQUFVLEdBQUcsSUFBSSxDQUFDLGNBQWM7O0FBQ3BDLG9CQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQzs7Ozs7aURBSVosNkJBQWMsQ0FBQyxFQUFFLElBQUksRUFBRTs7Ozs7eURBQ3ZCLElBQUksQ0FBQyxXQUFXLENBQUMsa0JBQWtCLEVBQUUsS0FBSyxDQUFDOzs7Ozs7Ozs7O2lCQUN6RCxDQUFDOzs7QUFGRSxrQkFBRTs7QUFHTixvQkFBSSxDQUFDLGNBQWMsR0FBRyxVQUFVLENBQUM7Ozs7aURBR3pCLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQzs7Ozs7Ozs7OztxQkFFNUIsb0JBQUUsUUFBUSxDQUFDLGVBQUksT0FBTyxFQUFFLHFCQUFxQixDQUFDOzs7OztzQkFDNUMsS0FBSyxFQUFFLElBQUksU0FBUyxDQUFBOzs7Ozs7Ozs7aURBSWxCLFdBQVcsRUFBRTs7OztpREFDTixRQUFRLEVBQUU7Ozs7Ozs7Ozs7O2lEQVFWLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFLGNBQWMsQ0FBQzs7O0FBQXpELG1CQUFFOztpREFDQSxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxFQUFFLEdBQUUsQ0FBQzs7Ozs7Ozs7OztzQkFJbEQsS0FBSyxFQUFFLElBQUksU0FBUyxDQUFBOzs7Ozs7Ozs7aURBQ1gsUUFBUSxFQUFFOzs7Ozs7OztpREFLWixJQUFJLENBQUMsV0FBVyxDQUFDLGtCQUFrQixFQUFFLElBQUksQ0FBQzs7O0FBQXJELGtCQUFFOztpREFDSSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUM7Ozs7Ozs7Ozs7QUFFaEMsb0JBQUksb0JBQUUsUUFBUSxDQUFDLGVBQUksT0FBTyxFQUFFLHFCQUFxQixDQUFDLEVBQUU7QUFDbEQsc0NBQU8sS0FBSyxDQUFDLGtFQUFrRSxHQUNsRSwrQ0FBK0MsQ0FBQyxDQUFDO2lCQUMvRDs7Ozs7aURBR0csSUFBSSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsRUFBRSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7Ozs7aURBR3pFLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFOzs7Ozs7O1NBQy9COzs7eUNBQ0ssUUFBUSxFQUFFOzs7Ozs7O0NBQ2pCLENBQUM7O0FBRUYsVUFBVSxDQUFDLHlCQUF5QixHQUFHO01BRWpDLFVBQVUsRUFHVixFQUFFLEVBY0EsR0FBRzs7OztBQWxCVCw0QkFBTyxLQUFLLENBQUMsd0VBQXdFLENBQUMsQ0FBQztBQUNuRixrQkFBVSxHQUFHLElBQUksQ0FBQyxjQUFjOztBQUNwQyxZQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQzs7QUFFdkIsVUFBRTs7O3lDQUVPLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLGlDQUFpQyxDQUFDOzs7QUFBdkUsVUFBRTs7Ozs7OztBQUVFLFdBQUcsR0FBRyxzREFBc0QsR0FDdEQscURBQXFEOztBQUMvRCw0QkFBTyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDbEIsWUFBSSxDQUFDLGNBQWMsR0FBRyxVQUFVLENBQUM7O3lDQUNwQixJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDOzs7Ozs7QUFFN0MsWUFBSSxDQUFDLGNBQWMsR0FBRyxVQUFVLENBQUM7Ozt5Q0FFekIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDOzs7Ozs7Ozs7QUFFNUIsV0FBRyxHQUFHLDhDQUE4QyxHQUM5QyxxREFBcUQ7O0FBQy9ELDRCQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQzs7Ozt5Q0FFZCxJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDOzs7Ozs7O0NBQ3hDLENBQUM7O0FBRUYsVUFBVSxDQUFDLGtCQUFrQixHQUFHLG9CQUFnQixVQUFVLEVBQUUsU0FBUztNQUUvRCxLQUFLLEVBQ0wsUUFBUSxFQUNSLFdBQVc7Ozs7OztBQUhmLDRCQUFPLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO0FBQ3ZELGFBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFO0FBQ2xCLGdCQUFRLEdBQUcsR0FBRzs7QUFDZCxtQkFBVyxHQUFHLFNBQWQsV0FBVztjQUNULEdBQUcsRUFVRCxZQUFZLEVBcUJkLE9BQU87Ozs7QUEvQlAsbUJBQUc7OztpREFFTyxJQUFJLENBQUMsK0JBQStCLENBQUMsVUFBVSxJQUFJLFNBQVMsQ0FBQzs7O0FBQXpFLG1CQUFHOzs7Ozs7OztzQkFFQyxlQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsd0NBQXdDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTs7Ozs7c0JBQ2hFLElBQUksS0FBSywwQ0FBd0MsZUFBSSxPQUFPLENBQUc7OztBQUV2RSxvQ0FBTyxLQUFLLENBQUMsc0RBQXNELENBQUMsQ0FBQzs7O3FCQUVuRSxHQUFHOzs7OztBQUNELDRCQUFZLEdBQUcsR0FBRzs7QUFDdEIsb0NBQU8sS0FBSyx3QkFBcUIsWUFBWSxRQUFJLENBQUM7O2lEQUM1QyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQzs7OztpREFDN0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUU7Ozs7OztzQkFLaEMsQUFBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsS0FBSyxJQUFLLEtBQUssQ0FBQTs7Ozs7c0JBRXpCLElBQUksS0FBSyxDQUFDLGdEQUFnRCxDQUFDOzs7O0FBR25FLG9DQUFPLElBQUksQ0FBQyxzREFBc0QsQ0FBQyxDQUFDOztzQkFDaEUsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUE7Ozs7OztpREFFcEMsc0JBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQzs7OztpREFDVixXQUFXLEVBQUU7Ozs7OztBQUl4Qix1QkFBTzs7O0FBRVQsb0NBQU8sS0FBSyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7O2lEQUNsQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsa0JBQWtCLEVBQUUsY0FBYyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUM7OztBQUEzRix1QkFBTzs7aURBQ0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDOzs7Ozs7Ozs7O0FBRXJDLG9DQUFPLElBQUksK0NBQTZDLGVBQUksT0FBTyxDQUFHLENBQUM7QUFDdkUsb0NBQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDOztpREFDbkIsc0JBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQzs7OztpREFJWixXQUFXLEVBQUU7Ozs7Ozs7Ozs7U0FDM0I7Ozt5Q0FDSyxXQUFXLEVBQUU7Ozs7Ozs7Q0FDcEIsQ0FBQzs7QUFFRixPQUFPLENBQUMsb0JBQW9CLEdBQUc7TUFDekIsT0FBTzs7Ozs7eUNBQVMsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMscUJBQXFCLENBQUM7OztBQUFwRSxlQUFPOztZQUNOLE9BQU87Ozs7OzRDQUNILEtBQUs7Ozs7QUFHZCw0QkFBTyxLQUFLLENBQUMsc0RBQXNELENBQUMsQ0FBQzs7eUNBQy9ELElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLG1CQUFtQixDQUFDOzs7QUFDeEQsNEJBQU8sS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7NENBQ3pCLElBQUk7Ozs7Ozs7Q0FDWixDQUFDOztBQUVGLE9BQU8sQ0FBQyxVQUFVLEdBQUc7TUFBZ0IsOEJBQThCLHlEQUFHLEtBQUs7Ozs7QUFDekUsWUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7QUFDaEIsOEJBQU8sYUFBYSxDQUFDLGdEQUFnRCxDQUFDLENBQUM7U0FDeEU7O2FBRUcsOEJBQThCOzs7Ozs7eUNBQzFCLElBQUksQ0FBQyxXQUFXLEVBQUU7Ozs7eUNBRXBCLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFOzs7QUFDOUIsWUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7QUFDdkIsWUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7QUFDdkIsWUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7QUFDekIsWUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7Ozs7Ozs7Q0FDcEIsQ0FBQzs7QUFFRixPQUFPLENBQUMsWUFBWSxHQUFHLFlBQVk7QUFDakMsU0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxLQUFLLFVBQVUsQ0FBQztDQUM1RCxDQUFDOztBQUVGLE9BQU8sQ0FBQyxhQUFhLEdBQUcsVUFBVSxHQUFHLEVBQUU7QUFDckMsTUFBSSxDQUFDLFdBQVcsR0FBRyxHQUFHLENBQUM7Q0FDeEIsQ0FBQzs7QUFFRixPQUFPLENBQUMsYUFBYSxHQUFHLFlBQVk7QUFDbEMsU0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO0NBQ3pCLENBQUM7O0FBR0YsZUFBYyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3BDLFFBQVEsR0FBUixRQUFRO1FBQUUsT0FBTyxHQUFQLE9BQU87UUFBRSxVQUFVLEdBQVYsVUFBVTtRQUFFLFdBQVcsR0FBWCxXQUFXO1FBQUUsWUFBWSxHQUFaLFlBQVk7cUJBQ2xELFVBQVUiLCJmaWxlIjoibGliL2NvbW1hbmRzL2NvbnRleHQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IFJlbW90ZURlYnVnZ2VyLCBXZWJLaXRSZW1vdGVEZWJ1Z2dlciB9IGZyb20gJ2FwcGl1bS1yZW1vdGUtZGVidWdnZXInO1xuaW1wb3J0IHsgSU9TUGVyZm9ybWFuY2VMb2cgfSBmcm9tICcuLi9kZXZpY2UtbG9nL2lvcy1wZXJmb3JtYW5jZS1sb2cnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cblxuY29uc3QgTkFUSVZFX1dJTiA9ICdOQVRJVkVfQVBQJztcbmNvbnN0IFdFQlZJRVdfV0lOID0gJ1dFQlZJRVcnO1xuY29uc3QgV0VCVklFV19CQVNFID0gYCR7V0VCVklFV19XSU59X2A7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29tbWFuZHMuZ2V0Q3VycmVudENvbnRleHQgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICh0aGlzLmN1ckNvbnRleHQgJiYgdGhpcy5jdXJDb250ZXh0ICE9PSBOQVRJVkVfV0lOKSB7XG4gICAgcmV0dXJuIGAke1dFQlZJRVdfQkFTRX0ke3RoaXMuY3VyQ29udGV4dH1gO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBOQVRJVkVfV0lOO1xuICB9XG59O1xuXG5jb21tYW5kcy5nZXRDb250ZXh0cyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbG9nZ2VyLmRlYnVnKCdHZXR0aW5nIGxpc3Qgb2YgYXZhaWxhYmxlIGNvbnRleHRzJyk7XG4gIGxldCBjb250ZXh0cyA9IGF3YWl0IHRoaXMuZ2V0Q29udGV4dHNBbmRWaWV3cyhmYWxzZSk7XG4gIHJldHVybiBjb250ZXh0cy5tYXAoKGNvbnRleHQpID0+IGNvbnRleHQuaWQudG9TdHJpbmcoKSk7XG59O1xuXG5jb21tYW5kcy5zZXRDb250ZXh0ID0gYXN5bmMgZnVuY3Rpb24gKG5hbWUsIGNhbGxiYWNrLCBza2lwUmVhZHlDaGVjaykge1xuICBmdW5jdGlvbiBhbHJlYWR5SW5Db250ZXh0IChkZXNpcmVkLCBjdXJyZW50KSB7XG4gICAgcmV0dXJuIChkZXNpcmVkID09PSBjdXJyZW50IHx8XG4gICAgICAgICAgIChkZXNpcmVkID09PSBudWxsICYmIGN1cnJlbnQgPT09IE5BVElWRV9XSU4pIHx8XG4gICAgICAgICAgIChkZXNpcmVkID09PSBOQVRJVkVfV0lOICYmIGN1cnJlbnQgPT09IG51bGwpKTtcbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBzZXQgY29udGV4dCB0byAnJHtuYW1lfSdgKTtcbiAgaWYgKGFscmVhZHlJbkNvbnRleHQobmFtZSwgdGhpcy5jdXJDb250ZXh0KSkge1xuICAgIC8vIGFscmVhZHkgaW4gdGhlIG5hbWVkIGNvbnRleHQsIG5vIG5lZWQgdG8gZG8gYW55dGhpbmdcbiAgfSBlbHNlIGlmIChuYW1lID09PSBOQVRJVkVfV0lOIHx8IG5hbWUgPT09IG51bGwpIHtcbiAgICAvLyBzd2l0Y2hpbmcgaW50byB0aGUgbmF0aXZlIGNvbnRleHRcbiAgICB0aGlzLmN1ckNvbnRleHQgPSBudWxsO1xuICAgIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICB0aGlzLnJlbW90ZS5kaXNjb25uZWN0KCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIC8vIHN3aXRjaGluZyBpbnRvIGEgd2VidmlldyBjb250ZXh0XG5cbiAgICAvLyBpZiBjb250ZXh0cyBoYXZlIG5vdCBhbHJlYWR5IGJlZW4gcmV0cmlldmVkLCBnZXQgdGhlbVxuICAgIGlmIChfLmlzVW5kZWZpbmVkKHRoaXMuY29udGV4dHMpKSB7XG4gICAgICBhd2FpdCB0aGlzLmdldENvbnRleHRzKCk7XG4gICAgfVxuXG4gICAgbGV0IGNvbnRleHRJZCA9IG5hbWUucmVwbGFjZShXRUJWSUVXX0JBU0UsICcnKTtcbiAgICBpZiAoY29udGV4dElkID09PSAnJykge1xuICAgICAgLy8gYWxsb3cgdXNlciB0byBwYXNzIGluIFwiV0VCVklFV1wiIHdpdGhvdXQgYW4gaW5kZXhcbiAgICAgIC8vIHRoZSBzZWNvbmQgY29udGV4dCB3aWxsIGJlIHRoZSBmaXJzdCB3ZWJ2aWV3IGFzXG4gICAgICAvLyB0aGUgZmlyc3QgaXMgYWx3YXlzIE5BVElWRV9BUFBcbiAgICAgIGNvbnRleHRJZCA9IHRoaXMuY29udGV4dHNbMV07XG4gICAgfVxuICAgIGlmICghXy5pbmNsdWRlcyh0aGlzLmNvbnRleHRzLCBjb250ZXh0SWQpKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaENvbnRleHRFcnJvcigpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICBpZiAodGhpcy5yZW1vdGUpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5yZW1vdGUuZGlzY29ubmVjdCgpO1xuICAgICAgfVxuICAgICAgdGhpcy5jdXJDb250ZXh0ID0gY29udGV4dElkO1xuICAgICAgYXdhaXQgdGhpcy5yZW1vdGUuY29ubmVjdChjb250ZXh0SWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBgY29udGV4dElkYCB3aWxsIGJlIGluIHRoZSBmb3JtIG9mIGBhcHBJZC5wYWdlSWRgIGluIHRoaXMgY2FzZVxuICAgICAgbGV0IFthcHBJZEtleSwgcGFnZUlkS2V5XSA9IF8ubWFwKGNvbnRleHRJZC5zcGxpdCgnLicpLCAoaWQpID0+IHBhcnNlSW50KGlkLCAxMCkpO1xuICAgICAgYXdhaXQgdGhpcy5yZW1vdGUuc2VsZWN0UGFnZShhcHBJZEtleSwgcGFnZUlkS2V5LCBza2lwUmVhZHlDaGVjayk7XG4gICAgICB0aGlzLmN1ckNvbnRleHQgPSBjb250ZXh0SWQ7XG4gICAgfVxuICB9XG5cbiAgLy8gYXR0ZW1wdCB0byBzdGFydCBwZXJmb3JtYW5jZSBsb2dnaW5nLCBpZiByZXF1ZXN0ZWRcbiAgaWYgKHRoaXMub3B0cy5lbmFibGVQZXJmb3JtYW5jZUxvZ2dpbmcgJiYgdGhpcy5yZW1vdGUpIHtcbiAgICBsb2dnZXIuZGVidWcoYFN0YXJ0aW5nIHBlcmZvcm1hbmNlIGxvZyBvbiAnJHt0aGlzLmN1ckNvbnRleHR9J2ApO1xuICAgIHRoaXMubG9ncy5wZXJmb3JtYW5jZSA9IG5ldyBJT1NQZXJmb3JtYW5jZUxvZyh0aGlzLnJlbW90ZSk7XG4gICAgdGhpcy5sb2dzLnBlcmZvcm1hbmNlLnN0YXJ0Q2FwdHVyZSgpO1xuICB9XG59O1xuXG5jb21tYW5kcy5nZXRXaW5kb3dIYW5kbGUgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG4gIHJldHVybiB0aGlzLmN1ckNvbnRleHQudG9TdHJpbmcoKTtcbn07XG5cbmNvbW1hbmRzLmdldFdpbmRvd0hhbmRsZXMgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG5cbiAgbGV0IHBhZ2VBcnJheSA9IGF3YWl0IHRoaXMubGlzdFdlYkZyYW1lcygpO1xuICB0aGlzLndpbmRvd0hhbmRsZUNhY2hlID0gXy5tYXAocGFnZUFycmF5LCB0aGlzLm1hc3NhZ2VQYWdlKTtcbiAgbGV0IGlkQXJyYXkgPSBfLm1hcCh0aGlzLndpbmRvd0hhbmRsZUNhY2hlLCAnaWQnKTtcbiAgLy8gc2luY2Ugd2UgdXNlIHRoaXMuY29udGV4dHMgdG8gbWFuYWdlIHNlbGVjdGluZyBkZWJ1Z2dlciBwYWdlcywgbWFrZVxuICAvLyBzdXJlIGl0IGdldHMgcG9wdWxhdGVkIGV2ZW4gaWYgc29tZW9uZSBkaWQgbm90IHVzZSB0aGVcbiAgLy8gZ2V0Q29udGV4dHMgbWV0aG9kXG4gIGlmICghdGhpcy5jb250ZXh0cykge1xuICAgIHRoaXMuY29udGV4dHMgPSBpZEFycmF5O1xuICB9XG4gIHJldHVybiBfLm1hcChpZEFycmF5LCAoaWQpID0+IGlkLnRvU3RyaW5nKCkpO1xufTtcblxuY29tbWFuZHMuc2V0V2luZG93ID0gYXN5bmMgZnVuY3Rpb24gKG5hbWUsIHNraXBSZWFkeUNoZWNrKSB7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG5cbiAgaWYgKCFfLmluY2x1ZGVzKF8ubWFwKHRoaXMud2luZG93SGFuZGxlQ2FjaGUsICdpZCcpLCBuYW1lKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoV2luZG93RXJyb3IoKTtcbiAgfVxuICBsZXQgcGFnZUlkS2V5ID0gcGFyc2VJbnQobmFtZSwgMTApO1xuICBpZiAoIXRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBhd2FpdCB0aGlzLnJlbW90ZS5zZWxlY3RQYWdlKHBhZ2VJZEtleSwgc2tpcFJlYWR5Q2hlY2spO1xuICAgIHRoaXMuY3VyQ29udGV4dCA9IHRoaXMuY3VyV2luZG93SGFuZGxlID0gbmFtZTtcbiAgfSBlbHNlIHtcbiAgICBpZiAobmFtZSA9PT0gdGhpcy5jdXJXaW5kb3dIYW5kbGUpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgUmVtb3RlIGRlYnVnZ2VyIGlzIGFscmVhZHkgY29ubmVjdGVkIHRvIHdpbmRvdyAnJHtuYW1lfSdgKTtcbiAgICB9IGVsc2UgaWYgKCFfLmluY2x1ZGVzKF8ubWFwKHRoaXMud2luZG93SGFuZGxlQ2FjaGUsICdpZCcpLCBuYW1lKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcigpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCB0aGlzLnJlbW90ZS5kaXNjb25uZWN0KCk7XG4gICAgICB0aGlzLmN1ckNvbnRleHQgPSB0aGlzLmN1cldpbmRvd0hhbmRsZSA9IG5hbWU7XG4gICAgICBhd2FpdCB0aGlzLnJlbW90ZS5jb25uZWN0KG5hbWUpO1xuICAgIH1cbiAgfVxufTtcblxuaGVscGVycy53ZWJDb250ZXh0SW5kZXggPSBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiB0aGlzLmN1ckNvbnRleHQucmVwbGFjZShXRUJWSUVXX0JBU0UsICcnKSAtIDE7XG59O1xuXG5leHRlbnNpb25zLmluaXRBdXRvV2VidmlldyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKHRoaXMub3B0cy5hdXRvV2Vidmlldykge1xuICAgIGxvZ2dlci5kZWJ1ZygnU2V0dGluZyBhdXRvIHdlYnZpZXcnKTtcbiAgICBhd2FpdCB0aGlzLm5hdlRvSW5pdGlhbFdlYnZpZXcodGhpcyk7XG4gIH1cbn07XG5cbmV4dGVuc2lvbnMuZ2V0Q29udGV4dHNBbmRWaWV3cyA9IGFzeW5jIGZ1bmN0aW9uICh1c2VVcmwgPSB0cnVlKSB7XG4gIGxvZ2dlci5kZWJ1ZygnUmV0cmlldmluZyBjb250ZXh0cyBhbmQgdmlld3MnKTtcbiAgbGV0IHdlYnZpZXdzID0gYXdhaXQgdGhpcy5saXN0V2ViRnJhbWVzKHVzZVVybCk7XG4gIGxldCBjdHhzID0gW3tpZDogTkFUSVZFX1dJTn1dO1xuICB0aGlzLmNvbnRleHRzID0gW05BVElWRV9XSU5dO1xuICBmb3IgKGxldCB2aWV3IG9mIHdlYnZpZXdzKSB7XG4gICAgY3R4cy5wdXNoKHtpZDogYCR7V0VCVklFV19CQVNFfSR7dmlldy5pZH1gLCB2aWV3fSk7XG4gICAgdGhpcy5jb250ZXh0cy5wdXNoKHZpZXcuaWQudG9TdHJpbmcoKSk7XG4gIH1cbiAgcmV0dXJuIGN0eHM7XG59O1xuXG5leHRlbnNpb25zLmxpc3RXZWJGcmFtZXMgPSBhc3luYyBmdW5jdGlvbiAodXNlVXJsID0gdHJ1ZSkge1xuICBpZiAoIXRoaXMub3B0cy5idW5kbGVJZCkge1xuICAgIGxvZ2dlci5lcnJvckFuZFRocm93KCdDYW5ub3QgZW50ZXIgd2ViIGZyYW1lIHdpdGhvdXQgYSBidW5kbGUgSUQnKTtcbiAgfVxuXG4gIHVzZVVybCA9IHVzZVVybCAmJiAhIXRoaXMuZ2V0Q3VycmVudFVybCgpO1xuICAvKiBqc2hpbnQgaWdub3JlOnN0YXJ0ICovXG4gIGxvZ2dlci5kZWJ1ZyhgU2VsZWN0aW5nIGJ5IHVybDogJHt1c2VVcmx9ICR7dXNlVXJsID8gYChleHBlY3RlZCB1cmw6ICcke3RoaXMuZ2V0Q3VycmVudFVybCgpfScpYCA6ICcnfWApO1xuICAvKiBqc2hpbnQgaWdub3JlOmVuZCAqL1xuXG4gIGxldCBjdXJyZW50VXJsID0gdXNlVXJsID8gdGhpcy5nZXRDdXJyZW50VXJsKCkgOiB1bmRlZmluZWQ7XG4gIGxldCBwYWdlQXJyYXk7XG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpICYmIHRoaXMucmVtb3RlICYmIHRoaXMub3B0cy5idW5kbGVJZCkge1xuICAgIC8vIHJlYWwgZGV2aWNlLCBhbmQgYWxyZWFkeSBjb25uZWN0ZWRcbiAgICBwYWdlQXJyYXkgPSBhd2FpdCB0aGlzLnJlbW90ZS5wYWdlQXJyYXlGcm9tSnNvbigpO1xuICB9IGVsc2UgaWYgKHRoaXMucmVtb3RlICYmIHRoaXMucmVtb3RlLmFwcElkS2V5KSB7XG4gICAgLy8gc2ltdWxhdG9yLCBhbmQgYWxyZWFkeSBjb25uZWN0ZWRcbiAgICBwYWdlQXJyYXkgPSBhd2FpdCB0aGlzLnJlbW90ZS5zZWxlY3RBcHAoY3VycmVudFVybCwgdGhpcy5vcHRzLndlYnZpZXdDb25uZWN0UmV0cmllcyk7XG4gIH0gZWxzZSBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIC8vIHJlYWwgZGV2aWNlLCBhbmQgbm90IGNvbm5lY3RlZFxuICAgIHRyeSB7XG4gICAgICB0aGlzLnJlbW90ZSA9IG5ldyBXZWJLaXRSZW1vdGVEZWJ1Z2dlcih7XG4gICAgICAgIHBvcnQ6IHRoaXMub3B0cy53ZWJraXREZWJ1Z1Byb3h5UG9ydCxcbiAgICAgICAgd2Via2l0UmVzcG9uc2VUaW1lb3V0OiB0aGlzLm9wdHMud2Via2l0UmVzcG9uc2VUaW1lb3V0LFxuICAgICAgfSk7XG4gICAgICBwYWdlQXJyYXkgPSBhd2FpdCB0aGlzLnJlbW90ZS5wYWdlQXJyYXlGcm9tSnNvbigpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gaXQgaXMgcmVhc29uYWJsZSB0byBleHBlY3QgdGhhdCB0aGlzIG1pZ2h0IGJlIGNhbGxlZCB3aGVuIHRoZXJlIGlzIG5vXG4gICAgICAvLyB3ZWJraXQgcmVtb3RlIGRlYnVnZ2VyIHRvIGNvbm5lY3QgdG9cbiAgICAgIGlmICghXy5pbmNsdWRlcyhlcnIubWVzc2FnZSwgJ2Nvbm5lY3QgRUNPTk5SRUZVU0VEJykpIHRocm93IGVycjtcblxuICAgICAgbG9nZ2VyLndhcm4oJ0F0dGVtcHRlZCB0byBnZXQgYSBsaXN0IG9mIHdlYnZpZXcgY29udGV4dHMgYnV0IGNvdWxkIG5vdCBjb25uZWN0IHRvICcgK1xuICAgICAgICAgICAgICAgICAgJ2lvcy13ZWJraXQtZGVidWctcHJveHkuIElmIHlvdSBleHBlY3QgdG8gZmluZCB3ZWJ2aWV3cywgcGxlYXNlIGVuc3VyZSAnICtcbiAgICAgICAgICAgICAgICAgICd0aGF0IHRoZSBwcm94eSBpcyBydW5uaW5nIGFuZCBhY2Nlc3NpYmxlJyk7XG4gICAgICB0aGlzLnJlbW90ZSA9IG51bGw7XG4gICAgICBwYWdlQXJyYXkgPSBbXTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgLy8gc2ltdWxhdG9yLCBhbmQgbm90IGNvbm5lY3RlZFxuICAgIHRoaXMucmVtb3RlID0gbmV3IFJlbW90ZURlYnVnZ2VyKHtcbiAgICAgIGJ1bmRsZUlkOiB0aGlzLm9wdHMuYnVuZGxlSWQsXG4gICAgICB1c2VOZXdTYWZhcmk6IHRoaXMudXNlTmV3U2FmYXJpKCksXG4gICAgICBwYWdlTG9hZE1zOiB0aGlzLnBhZ2VMb2FkTXMsXG4gICAgICBwbGF0Zm9ybVZlcnNpb246IHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb25cbiAgICB9KTtcblxuICAgIGxldCBhcHBJbmZvID0gYXdhaXQgdGhpcy5yZW1vdGUuY29ubmVjdCgpO1xuICAgIGlmICghYXBwSW5mbykge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdVbmFibGUgdG8gY29ubmVjdCB0byB0aGUgcmVtb3RlIGRlYnVnZ2VyLicpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBwYWdlQXJyYXkgPSBhd2FpdCB0aGlzLnJlbW90ZS5zZWxlY3RBcHAoY3VycmVudFVybCwgdGhpcy5vcHRzLndlYnZpZXdDb25uZWN0UmV0cmllcyk7XG4gICAgdGhpcy5yZW1vdGUub24oUmVtb3RlRGVidWdnZXIuRVZFTlRfUEFHRV9DSEFOR0UsIHRoaXMub25QYWdlQ2hhbmdlLmJpbmQodGhpcykpO1xuXG4gICAgbGV0IHRyeUNsb3NpbmdBbGVydCA9IGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBkaWREaXNtaXNzID0gYXdhaXQgdGhpcy5jbG9zZUFsZXJ0QmVmb3JlVGVzdCgpO1xuICAgICAgaWYgKCFkaWREaXNtaXNzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ2xvc2UgYWxlcnQgZmFpbGVkLiBSZXRyeS4nKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKDMsIDQwMDAsIHRyeUNsb3NpbmdBbGVydCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBpZiB0aGUgbG9vcCB0byBjbG9zZSBhbGVydHMgZmFpbGVkIHRvIGRpc21pc3MsIGlnbm9yZSxcbiAgICAgIC8vIG90aGVyd2lzZSBsb2cgYW5kIHRocm93IHRoZSBlcnJvclxuICAgICAgaWYgKGVyci5tZXNzYWdlICE9PSAnQ2xvc2UgYWxlcnQgZmFpbGVkLiBSZXRyeS4nKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGVycik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKHBhZ2VBcnJheS5sZW5ndGggPT09IDApIHtcbiAgICAvLyB3ZSBoYXZlIG5vIHdlYiBmcmFtZXMsIGJ1dCBjb250aW51ZSBhbnl3YXlcbiAgICBsb2dnZXIuZGVidWcoJ05vIHdlYiBmcmFtZXMgZm91bmQuJyk7XG4gIH1cbiAgcmV0dXJuIHBhZ2VBcnJheTtcbn07XG5cbmV4dGVuc2lvbnMub25QYWdlQ2hhbmdlID0gYXN5bmMgZnVuY3Rpb24gKHBhZ2VDaGFuZ2VOb3RpZmljYXRpb24pIHtcbiAgbG9nZ2VyLmRlYnVnKGBSZW1vdGUgZGVidWdnZXIgbm90aWZpZWQgdXMgb2YgYSBuZXcgcGFnZSBsaXN0aW5nOiAke0pTT04uc3RyaW5naWZ5KHBhZ2VDaGFuZ2VOb3RpZmljYXRpb24pfWApO1xuICBpZiAodGhpcy5zZWxlY3RpbmdOZXdQYWdlKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdXZSBhcmUgaW4gdGhlIG1pZGRsZSBvZiBzZWxlY3RpbmcgYSBwYWdlLCBpZ25vcmluZycpO1xuICAgIHJldHVybjtcbiAgfVxuICBpZiAoIXRoaXMucmVtb3RlLmFwcElkS2V5KSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdXZSBoYXZlIG5vdCB5ZXQgY29ubmVjdGVkLCBpZ25vcmluZycpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxldCB7YXBwSWRLZXksIHBhZ2VBcnJheX0gPSBwYWdlQ2hhbmdlTm90aWZpY2F0aW9uO1xuXG4gIGxldCBuZXdJZHMgPSBbXTtcbiAgbGV0IG5ld1BhZ2VzID0gW107XG4gIGxldCBrZXlJZCA9IG51bGw7XG4gIGZvciAobGV0IHBhZ2Ugb2YgcGFnZUFycmF5KSB7XG4gICAgbGV0IGlkID0gcGFnZS5pZC50b1N0cmluZygpO1xuICAgIG5ld0lkcy5wdXNoKGlkKTtcbiAgICBpZiAocGFnZS5pc0tleSkge1xuICAgICAga2V5SWQgPSBpZDtcbiAgICB9XG4gICAgbGV0IGNvbnRleHRJZCA9IGAke2FwcElkS2V5fS4ke2lkfWA7XG4gICAgaWYgKCFfLmluY2x1ZGVzKHRoaXMuY29udGV4dHMsIGNvbnRleHRJZCkpIHtcbiAgICAgIG5ld1BhZ2VzLnB1c2goaWQpO1xuICAgICAgdGhpcy5jb250ZXh0cy5wdXNoKGNvbnRleHRJZCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKCFrZXlJZCkge1xuICAgIC8vIGlmIHRoZXJlIGlzIG5vIGtleSBpZCwgcHVsbCB0aGUgZmlyc3QgaWQgZnJvbSB0aGUgcGFnZSBhcnJheSBhbmQgdXNlIHRoYXRcbiAgICAvLyBhcyBhIHN0YW5kIGluXG4gICAgbG9nZ2VyLmRlYnVnKCdObyBrZXkgaWQgZm91bmQuIENob29zaW5nIGZpcnN0IGlkIGZyb20gcGFnZSBhcnJheScpO1xuICAgIGtleUlkID0gbmV3SWRzWzBdIHx8IG51bGw7XG4gIH1cblxuICBsZXQgbmV3UGFnZSA9IG51bGw7XG4gIGlmICh0aGlzLmN1ckNvbnRleHQgPT09IG51bGwpIHtcbiAgICBsb2dnZXIuZGVidWcoJ1dlIGRvIG5vdCBhcHBlYXIgdG8gaGF2ZSB3aW5kb3cgc2V0IHlldCwgaWdub3JpbmcnKTtcbiAgfSBlbHNlIHtcbiAgICBsZXQgW2N1ckFwcElkS2V5LCBjdXJQYWdlSWRLZXldID0gdGhpcy5jdXJDb250ZXh0LnNwbGl0KCcuJyk7XG5cbiAgICBpZiAoY3VyQXBwSWRLZXkgIT09IGFwcElkS2V5KSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ1BhZ2UgY2hhbmdlIG5vdCByZWZlcnJpbmcgdG8gY3VycmVudGx5IHNlbGVjdGVkIGFwcCwgaWdub3JpbmcuJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKG5ld1BhZ2VzLmxlbmd0aCkge1xuICAgICAgbmV3UGFnZSA9IF8ubGFzdChuZXdQYWdlcyk7XG4gICAgICBsb2dnZXIuZGVidWcoYFdlIGhhdmUgbmV3IHBhZ2VzLCBnb2luZyB0byBzZWxlY3QgcGFnZSAnJHtuZXdQYWdlfSdgKTtcbiAgICB9IGVsc2UgaWYgKCFfLmluY2x1ZGVzKG5ld0lkcywgY3VyUGFnZUlkS2V5KSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdOZXcgcGFnZSBsaXN0aW5nIGZyb20gcmVtb3RlIGRlYnVnZ2VyIGRvZXMgbm90IGNvbnRhaW4gJyArXG4gICAgICAgICAgICAgICAgICAgJ2N1cnJlbnQgd2luZG93OyBhc3N1bWluZyBpdCBpcyBjbG9zZWQnKTtcbiAgICAgIGlmIChrZXlJZCAhPT0gbnVsbCkge1xuICAgICAgICBsb2dnZXIuZGVidWcoYERlYnVnZ2VyIGFscmVhZHkgc2VsZWN0ZWQgcGFnZSAnJHtrZXlJZH0nLCBgICtcbiAgICAgICAgICAgICAgICAgICAgIGBjb25maXJtaW5nIHRoYXQgY2hvaWNlLmApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdEbyBub3QgaGF2ZSBvdXIgY3VycmVudCB3aW5kb3cgYW55bW9yZSwgYW5kIHRoZXJlICcgK1xuICAgICAgICAgICAgICAgICAgICAgJ2FyZSBub3QgYW55IG1vcmUgdG8gbG9hZCEgRG9pbmcgbm90aGluZy4uLicpO1xuICAgICAgICB0aGlzLnNldEN1cnJlbnRVcmwodW5kZWZpbmVkKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5jdXJDb250ZXh0ID0gYCR7YXBwSWRLZXl9LiR7a2V5SWR9YDtcbiAgICAgIG5ld1BhZ2UgPSBrZXlJZDtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdDaGVja2luZyBpZiBwYWdlIG5lZWRzIHRvIGxvYWQnKTtcbiAgICAgIC8vIElmIGEgd2luZG93IG5hdmlnYXRlcyB0byBhbiBhbmNob3IgaXQgZG9lc24ndCBhbHdheXMgZmlyZSBhIHBhZ2VcbiAgICAgIC8vIGNhbGxiYWNrIGV2ZW50LiBMZXQncyBjaGVjayBpZiB3ZSB3b3VuZCB1cCBpbiBzdWNoIGEgc2l0dWF0aW9uLlxuICAgICAgbGV0IG5lZWRzUGFnZUxvYWQgPSAoKCkgPT4ge1xuICAgICAgICBsZXQgaXRlbSA9IChhcnIpID0+IHtcbiAgICAgICAgICByZXR1cm4gXy5maWx0ZXIoYXJyLCAob2JqKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gb2JqLmlkID09PSB0aGlzLmN1ckNvbnRleHQ7XG4gICAgICAgICAgfSlbMF07XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gbmVlZCB0byBtYXAgdGhlIHBhZ2UgaWRzIHRvIGNvbnRleHQgaWRzXG4gICAgICAgIGxldCBjb250ZXh0QXJyYXkgPSBfLm1hcChwYWdlQXJyYXksIChhcnIpID0+IHtcbiAgICAgICAgICByZXR1cm4ge2lkOiBgJHthcHBJZEtleX0uJHthcnIuaWR9YH07XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gIV8uaXNFcXVhbChpdGVtKHRoaXMuY29udGV4dHMpLCBpdGVtKGNvbnRleHRBcnJheSkpO1xuICAgICAgfSkoKTtcblxuICAgICAgaWYgKG5lZWRzUGFnZUxvYWQpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdQYWdlIGxvYWQgbmVlZGVkLiBMb2FkaW5nLicpO1xuICAgICAgICBhd2FpdCB0aGlzLnJlbW90ZS5wYWdlTG9hZCgpO1xuICAgICAgfVxuXG4gICAgICBsb2dnZXIuZGVidWcoJ05ldyBwYWdlIGxpc3RpbmcgaXMgc2FtZSBhcyBvbGQsIGRvaW5nIG5vdGhpbmcnKTtcbiAgICB9XG4gIH1cblxuICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgcGFnZSBsaXN0aW5nIGlzbid0IGluZGljYXRpbmcgYSByZWRpcmVjdFxuICBpZiAodXRpbC5oYXNWYWx1ZSh0aGlzLmN1ckNvbnRleHQpKSB7XG4gICAgbGV0IGN1cnJlbnRQYWdlSWQgPSBwYXJzZUludChfLmxhc3QodGhpcy5jdXJDb250ZXh0LnNwbGl0KCcuJykpLCAxMCk7XG4gICAgbGV0IHBhZ2UgPSBfLmZpbmQocGFnZUFycmF5LCAocCkgPT4gcGFyc2VJbnQocC5pZCwgMTApID09PSBjdXJyZW50UGFnZUlkKTtcbiAgICBpZiAocGFnZSAmJiBwYWdlLnVybCAhPT0gdGhpcy5nZXRDdXJyZW50VXJsKCkpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgUmVkaXJlY3RlZCBmcm9tICcke3RoaXMuZ2V0Q3VycmVudFVybCgpfScgdG8gJyR7cGFnZS51cmx9J2ApO1xuICAgICAgdGhpcy5zZXRDdXJyZW50VXJsKHBhZ2UudXJsKTtcbiAgICB9XG4gIH1cblxuICBpZiAodXRpbC5oYXNWYWx1ZShuZXdQYWdlKSkge1xuICAgIHRoaXMuc2VsZWN0aW5nTmV3UGFnZSA9IHRydWU7XG4gICAgYXdhaXQgdGhpcy5yZW1vdGUuc2VsZWN0UGFnZShhcHBJZEtleSwgcGFyc2VJbnQobmV3UGFnZSwgMTApKTtcbiAgICB0aGlzLnNlbGVjdGluZ05ld1BhZ2UgPSBmYWxzZTtcbiAgICB0aGlzLmN1ckNvbnRleHQgPSBgJHthcHBJZEtleX0uJHtuZXdQYWdlfWA7XG4gIH1cbiAgdGhpcy53aW5kb3dIYW5kbGVDYWNoZSA9IF8ubWFwKHBhZ2VBcnJheSwgdGhpcy5tYXNzYWdlUGFnZSk7XG59O1xuXG5leHRlbnNpb25zLmdldExhdGVzdFdlYnZpZXdDb250ZXh0Rm9yVGl0bGUgPSBhc3luYyBmdW5jdGlvbiAocmVnRXhwKSB7XG4gIGxldCBjb250ZXh0cyA9IGF3YWl0IHRoaXMuZ2V0Q29udGV4dHNBbmRWaWV3cygpO1xuICBsZXQgbWF0Y2hpbmdDdHg7XG4gIGZvciAobGV0IGN0eCBvZiBjb250ZXh0cykge1xuICAgIGlmIChjdHgudmlldyAmJiAoKGN0eC52aWV3LnRpdGxlIHx8ICcnKS5tYXRjaChyZWdFeHApIHx8IChjdHgudmlldy51cmwgfHwgJycpLm1hdGNoKHJlZ0V4cCkpKSB7XG4gICAgICBpZiAoY3R4LnZpZXcudXJsICE9PSAnYWJvdXQ6YmxhbmsnKSB7XG4gICAgICAgIG1hdGNoaW5nQ3R4ID0gY3R4O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gaW4gdGhlIGNhc2VzIG9mIFhjb2RlIDwgNSAoaS5lLiwgaU9TIFNESyBWZXJzaW9uIGxlc3MgdGhhbiA3KVxuICAgICAgICAvLyBpT1MgNy4xLCBpT1MgOS4wICYgaU9TIDkuMSBpbiBhIHdlYnZpZXcgKG5vdCBpbiBTYWZhcmkpXG4gICAgICAgIC8vIHdlIGNhbiBoYXZlIHRoZSB1cmwgYmUgYGFib3V0OmJsYW5rYFxuICAgICAgICBpZiAocGFyc2VGbG9hdCh0aGlzLmlvc1Nka1ZlcnNpb24pIDwgNyB8fCBwYXJzZUZsb2F0KHRoaXMuaW9zU2RrVmVyc2lvbikgPj0gOSB8fFxuICAgICAgICAgICAgKHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24gPT09ICc3LjEnICYmIHRoaXMub3B0cy5hcHAgJiYgdGhpcy5vcHRzLmFwcC50b0xvd2VyQ2FzZSgpICE9PSAnc2FmYXJpJykpIHtcbiAgICAgICAgICBtYXRjaGluZ0N0eCA9IGN0eDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG4gIHJldHVybiBtYXRjaGluZ0N0eCA/IG1hdGNoaW5nQ3R4LmlkIDogdW5kZWZpbmVkO1xufTtcblxuLy8gUmlnaHQgbm93IHdlIGRvbid0IG5lY2Vzc2FyaWx5IHdhaXQgZm9yIHdlYnZpZXdcbi8vIGFuZCBmcmFtZSB0byBsb2FkLCB3aGljaCBsZWFkcyB0byByYWNlIGNvbmRpdGlvbnMgYW5kIGZsYWtpbmVzcyxcbi8vIGxldCdzIHNlZSBpZiB3ZSBjYW4gdHJhbnNpdGlvbiB0byBzb21ldGhpbmcgYmV0dGVyXG5leHRlbnNpb25zLnVzZU5ld1NhZmFyaSA9IGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIHBhcnNlRmxvYXQodGhpcy5pb3NTZGtWZXJzaW9uKSA+PSA4LjEgJiZcbiAgICAgICAgIHBhcnNlRmxvYXQodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbikgPj0gOC4xICYmXG4gICAgICAgICAhdGhpcy5pc1JlYWxEZXZpY2UoKSAmJlxuICAgICAgICAgdGhpcy5vcHRzLnNhZmFyaTtcbn07XG5cbmV4dGVuc2lvbnMubmF2VG9Jbml0aWFsV2VidmlldyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IHRpbWVvdXQgPSAwO1xuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIHRpbWVvdXQgPSAzMDAwO1xuICAgIGxvZ2dlci5kZWJ1ZyhgV2FpdGluZyBmb3IgJHt0aW1lb3V0fSBtcyBiZWZvcmUgbmF2aWdhdGluZyB0byB2aWV3LmApO1xuICB9XG4gIGF3YWl0IEIuZGVsYXkodGltZW91dCk7XG4gIGlmICh0aGlzLnVzZU5ld1NhZmFyaSgpKSB7XG4gICAgYXdhaXQgdGhpcy50eXBlQW5kTmF2VG9VcmwoKTtcbiAgfSBlbHNlIGlmIChwYXJzZUludCh0aGlzLmlvc1Nka1ZlcnNpb24sIDEwKSA+PSA3ICYmICF0aGlzLmlzUmVhbERldmljZSgpICYmIHRoaXMub3B0cy5zYWZhcmkpIHtcbiAgICBhd2FpdCB0aGlzLm5hdlRvVmlld1Rocm91Z2hGYXZvcml0ZXMoKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCB0aGlzLm5hdlRvVmlld1dpdGhUaXRsZSgvLiovKTtcbiAgfVxufTtcblxuYXN5bmMgZnVuY3Rpb24gb3Blbk5ld1BhZ2UgKCkge1xuICBsZXQgbmV3UGFnZUJ1dHRvbiA9IGF3YWl0IHRoaXMuZmluZEVsZW1lbnQoJ3hwYXRoJywgXCIvL1VJQUJ1dHRvbltjb250YWlucyhAbmFtZSwnTmV3IHBhZ2UnKV1cIik7XG4gIGF3YWl0IHRoaXMubmF0aXZlVGFwKG5ld1BhZ2VCdXR0b24uRUxFTUVOVCk7XG59XG5cbmV4dGVuc2lvbnMudHlwZUFuZE5hdlRvVXJsID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgYWRkcmVzcyA9IHRoaXMub3B0cy5hZGRyZXNzID8gdGhpcy5vcHRzLmFkZHJlc3MgOiAnMTI3LjAuMC4xJztcbiAgdGhpcy5zZXRDdXJyZW50VXJsKHRoaXMuY2Fwcy5zYWZhcmlJbml0aWFsVXJsIHx8IGBodHRwOi8vJHthZGRyZXNzfToke3RoaXMub3B0cy5wb3J0fS93ZWxjb21lYCk7XG5cbiAgbGV0IHRyaWVzID0gMDtcbiAgY29uc3QgTUFYX1RSSUVTID0gMjtcbiAgbGV0IG5hdmlnYXRlID0gYXN5bmMgKCkgPT4ge1xuICAgIGxldCBvbGRJbXBXYWl0ID0gdGhpcy5pbXBsaWNpdFdhaXRNcztcbiAgICB0aGlzLmltcGxpY2l0V2FpdE1zID0gNzAwMDtcblxuICAgIC8vIGZpbmQgdGhlIHVybCBiYXIsIGFuZCB0YXAgb24gaXQuIHJldHJ5IHRvIG1ha2Ugc3VyZSB3ZSBkb24ndCB0cnlcbiAgICAvLyB0b28gc29vbiB3aGlsZSB0aGUgdmlldyBpcyBzdGlsbCBsb2FkaW5nXG4gICAgbGV0IGVsID0gYXdhaXQgcmV0cnlJbnRlcnZhbCgzLCAxMDAwLCBhc3luYyAoKSA9PiB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kRWxlbWVudCgnYWNjZXNzaWJpbGl0eSBpZCcsICdVUkwnKTtcbiAgICB9KTtcbiAgICB0aGlzLmltcGxpY2l0V2FpdE1zID0gb2xkSW1wV2FpdDtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLm5hdGl2ZVRhcChlbC5FTEVNRU5UKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChfLmluY2x1ZGVzKGVyci5tZXNzYWdlLCAnY291bGQgbm90IGJlIHRhcHBlZCcpKSB7XG4gICAgICAgIGlmICh0cmllcysrID49IE1BWF9UUklFUykgdGhyb3cgZXJyO1xuXG4gICAgICAgIC8vIGdlbmVyYWxseSB0aGlzIG1lYW5zIHRoYXQgU2FmYXJpIGlzIGluIHBhZ2Ugdmlld2luZyBtb2RlXG4gICAgICAgIC8vIHNvIHRyeSB0byBvcGVuIGEgbmV3IHBhZ2UgYW5kIHRoZW4gcmVkbyB0aGUgbmF2aWdhdGlvblxuICAgICAgICBhd2FpdCBvcGVuTmV3UGFnZSgpO1xuICAgICAgICByZXR1cm4gYXdhaXQgbmF2aWdhdGUoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBnZXQgdGhlIGxhc3QgYWRkcmVzcyBlbGVtZW50IGFuZCBzZXQgdGhlIHVybFxuICAgIHRyeSB7XG4gICAgICBsZXQgZWwgPSBhd2FpdCB0aGlzLmZpbmRFbGVtZW50KCdjbGFzcyBuYW1lJywgJ1VJQVRleHRGaWVsZCcpO1xuICAgICAgYXdhaXQgdGhpcy5zZXRWYWx1ZUltbWVkaWF0ZSh0aGlzLmdldEN1cnJlbnRVcmwoKSwgZWwpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gdGhpcyBpcyBmbGFrZXkgb24gY2VydGFpbiBzeXN0ZW1zIHNvIHdlIHJldHJ5IHVudGlsIHdlIGdldCBzb21ldGhpbmdcbiAgICAgIC8vIGlvcyBzaW1zOiBzYWZhcmkgb3BlbnMgYnV0IHRoZSB0ZXh0IGZpZWxkIGNhbid0IGJlIGZvdW5kXG4gICAgICBpZiAodHJpZXMrKyA+PSBNQVhfVFJJRVMpIHRocm93IGVycjtcbiAgICAgIHJldHVybiBhd2FpdCBuYXZpZ2F0ZSgpO1xuICAgIH1cblxuICAgIC8vIG1ha2UgaXQgaGFwcGVuXG4gICAgdHJ5IHtcbiAgICAgIGVsID0gYXdhaXQgdGhpcy5maW5kRWxlbWVudCgnYWNjZXNzaWJpbGl0eSBpZCcsICdHbycpO1xuICAgICAgYXdhaXQgdGhpcy5uYXRpdmVUYXAoZWwuRUxFTUVOVCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoXy5pbmNsdWRlcyhlcnIubWVzc2FnZSwgJ2NvdWxkIG5vdCBiZSB0YXBwZWQnKSkge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ1VuYWJsZSB0byBzdWJtaXQgVVJMIGJlY2F1c2UgXFwnR29cXCcgYnV0dG9uIGNvdWxkIG5vdCBiZSB0YXBwZWQuICcgK1xuICAgICAgICAgICAgICAgICAgICAgJ1BsZWFzZSBtYWtlIHN1cmUgeW91ciBrZXlib2FyZCBpcyB0b2dnbGVkIG9uLicpO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLm5hdlRvVmlld1dpdGhUaXRsZSh1bmRlZmluZWQsIG5ldyBSZWdFeHAodGhpcy5nZXRDdXJyZW50VXJsKCksICdpJykpO1xuXG4gICAgLy8gd2FpdCBmb3IgcGFnZSB0byBmaW5pc2ggbG9hZGluZy5cbiAgICBhd2FpdCB0aGlzLnJlbW90ZS5wYWdlVW5sb2FkKCk7XG4gIH07XG4gIGF3YWl0IG5hdmlnYXRlKCk7XG59O1xuXG5leHRlbnNpb25zLm5hdlRvVmlld1Rocm91Z2hGYXZvcml0ZXMgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZ2dlci5kZWJ1ZygnV2UgYXJlIG9uIGlPUzcrIHNpbXVsYXRvcjogY2xpY2tpbmcgYXBwbGUgYnV0dG9uIHRvIGdldCBpbnRvIGEgd2VidmlldycpO1xuICBsZXQgb2xkSW1wV2FpdCA9IHRoaXMuaW1wbGljaXRXYWl0TXM7XG4gIHRoaXMuaW1wbGljaXRXYWl0TXMgPSA3MDAwOyAvLyB3YWl0IDdzIGZvciBhcHBsZSBidXR0b24gdG8gZXhpc3RcblxuICBsZXQgZWw7XG4gIHRyeSB7XG4gICAgZWwgPSBhd2FpdCB0aGlzLmZpbmRFbGVtZW50KCd4cGF0aCcsICcvL1VJQVNjcm9sbFZpZXdbMV0vVUlBQnV0dG9uWzFdJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxldCBtc2cgPSAnQ291bGQgbm90IGZpbmQgYnV0dG9uIHRvIGNsaWNrIHRvIGdldCBpbnRvIHdlYnZpZXcuICcgK1xuICAgICAgICAgICAgICAnUHJvY2VlZGluZyBvbiB0aGUgYXNzdW1wdGlvbiB3ZSBoYXZlIGEgd29ya2luZyBvbmUuJztcbiAgICBsb2dnZXIuZXJyb3IobXNnKTtcbiAgICB0aGlzLmltcGxpY2l0V2FpdE1zID0gb2xkSW1wV2FpdDtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5uYXZUb1ZpZXdXaXRoVGl0bGUoLy4qL2kpO1xuICB9XG4gIHRoaXMuaW1wbGljaXRXYWl0TXMgPSBvbGRJbXBXYWl0O1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMubmF0aXZlVGFwKGVsLkVMRU1FTlQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsZXQgbXNnID0gJ0NvdWxkIG5vdCBjbGljayBidXR0b24gdG8gZ2V0IGludG8gd2Vidmlldy4gJyArXG4gICAgICAgICAgICAgICdQcm9jZWVkaW5nIG9uIHRoZSBhc3N1bXB0aW9uIHdlIGhhdmUgYSB3b3JraW5nIG9uZS4nO1xuICAgIGxvZ2dlci5lcnJvcihtc2cpO1xuICB9XG4gIGF3YWl0IHRoaXMubmF2VG9WaWV3V2l0aFRpdGxlKC9hcHBsZS9pKTtcbn07XG5cbmV4dGVuc2lvbnMubmF2VG9WaWV3V2l0aFRpdGxlID0gYXN5bmMgZnVuY3Rpb24gKHRpdGxlUmVnZXgsIHVybFJlZ0V4cCkge1xuICBsb2dnZXIuZGVidWcoJ05hdmlnYXRpbmcgdG8gbW9zdCByZWNlbnRseSBvcGVuZWQgd2VidmlldycpO1xuICBsZXQgc3RhcnQgPSBEYXRlLm5vdygpO1xuICBsZXQgc3BpblRpbWUgPSA1MDA7XG4gIGxldCBzcGluSGFuZGxlcyA9IGFzeW5jICgpID0+IHtcbiAgICBsZXQgcmVzO1xuICAgIHRyeSB7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLmdldExhdGVzdFdlYnZpZXdDb250ZXh0Rm9yVGl0bGUodGl0bGVSZWdleCB8fCB1cmxSZWdFeHApO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGVyci5tZXNzYWdlLmluZGV4T2YoJ0NvdWxkIG5vdCBjb25uZWN0IHRvIGEgdmFsaWQgYXBwIGFmdGVyJykgPT09IC0xKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IG5hdmlnYXRlIHRvIHdlYnZpZXchIEVycjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICAgIGxvZ2dlci5kZWJ1ZygnQ291bGQgbm90IG5hdmlnYXRlIHRvIHdlYnZpZXcuIFJldHJ5aW5nIGlmIHBvc3NpYmxlLicpO1xuICAgIH1cbiAgICBpZiAocmVzKSB7XG4gICAgICBsZXQgbGF0ZXN0V2luZG93ID0gcmVzO1xuICAgICAgbG9nZ2VyLmRlYnVnKGBQaWNraW5nIHdlYnZpZXcgJyR7bGF0ZXN0V2luZG93fSdgKTtcbiAgICAgIGF3YWl0IHRoaXMuc2V0Q29udGV4dChsYXRlc3RXaW5kb3cpO1xuICAgICAgYXdhaXQgdGhpcy5yZW1vdGUuY2FuY2VsUGFnZUxvYWQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBubyB3ZWJ2aWV3IHdhcyBmb3VuZFxuICAgIGlmICgoRGF0ZS5ub3coKSAtIHN0YXJ0KSA+PSA5MDAwMCkge1xuICAgICAgLy8gdG9vIHNsb3csIGdldCBvdXRcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IG5hdmlnYXRlIHRvIHdlYnZpZXc7IHRoZXJlIGFyZSBub25lIScpO1xuICAgIH1cblxuICAgIGxvZ2dlci53YXJuKFwiQ291bGQgbm90IGZpbmQgYW55IHdlYnZpZXdzIHlldCwgcmVmcmVzaGluZy9yZXRyeWluZ1wiKTtcbiAgICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSB8fCAhdGhpcy5vcHRzLnNhZmFyaSkge1xuICAgICAgLy8gb24gYSByZWFsIGRldmljZSwgd2hlbiBub3QgdXNpbmcgU2FmYXJpLCB3ZSBqdXN0IHdhbnQgdG8gdHJ5IGFnYWluXG4gICAgICBhd2FpdCBCLmRlbGF5KHNwaW5UaW1lKTtcbiAgICAgIHJldHVybiBhd2FpdCBzcGluSGFuZGxlcygpO1xuICAgIH1cblxuICAgIC8vIGZpbmQgdGhlIHJlbG9hZCBidXR0b24gYW5kIHRhcCBpdCwgaWYgcG9zc2libGVcbiAgICBsZXQgZWxlbWVudDtcbiAgICB0cnkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdGaW5kaW5nIGFuZCB0YXBwaW5nIHJlbG9hZCBidXR0b24nKTtcbiAgICAgIGVsZW1lbnQgPSBhd2FpdCB0aGlzLmZpbmRVSUVsZW1lbnRPckVsZW1lbnRzKCdhY2Nlc3NpYmlsaXR5IGlkJywgJ1JlbG9hZEJ1dHRvbicsICcnLCBmYWxzZSk7XG4gICAgICBhd2FpdCB0aGlzLm5hdGl2ZVRhcChlbGVtZW50LkVMRU1FTlQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLndhcm4oYEVycm9yIGZpbmRpbmcgYW5kIHRhcHBpbmcgcmVsb2FkIGJ1dHRvbjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIGxvZ2dlci53YXJuKCdSZXRyeWluZy4nKTtcbiAgICAgIGF3YWl0IEIuZGVsYXkoc3BpblRpbWUpO1xuICAgIH1cblxuICAgIC8vIHRyeSBpdCBhbGwgYWdhaW5cbiAgICByZXR1cm4gYXdhaXQgc3BpbkhhbmRsZXMoKTtcbiAgfTtcbiAgYXdhaXQgc3BpbkhhbmRsZXMoKTtcbn07XG5cbmhlbHBlcnMuY2xvc2VBbGVydEJlZm9yZVRlc3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBwcmVzZW50ID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoJ2F1LmFsZXJ0SXNQcmVzZW50KCknKTtcbiAgaWYgKCFwcmVzZW50KSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKCdBbGVydCBwcmVzZW50IGJlZm9yZSBzdGFydGluZyB0ZXN0LCBsZXQgdXMgYmFuaXNoIGl0Jyk7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKCdhdS5kaXNtaXNzQWxlcnQoKScpO1xuICBsb2dnZXIuZGVidWcoJ0FsZXJ0IGJhbmlzaGVkIScpO1xuICByZXR1cm4gdHJ1ZTtcbn07XG5cbmhlbHBlcnMuc3RvcFJlbW90ZSA9IGFzeW5jIGZ1bmN0aW9uIChjbG9zZVdpbmRvd0JlZm9yZURpc2Nvbm5lY3RpbmcgPSBmYWxzZSkge1xuICBpZiAoIXRoaXMucmVtb3RlKSB7XG4gICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coJ1RyaWVkIHRvIGxlYXZlIGEgd2ViIGZyYW1lIGJ1dCB3ZXJlIG5vdCBpbiBvbmUnKTtcbiAgfVxuXG4gIGlmIChjbG9zZVdpbmRvd0JlZm9yZURpc2Nvbm5lY3RpbmcpIHtcbiAgICBhd2FpdCB0aGlzLmNsb3NlV2luZG93KCk7XG4gIH1cbiAgYXdhaXQgdGhpcy5yZW1vdGUuZGlzY29ubmVjdCgpO1xuICB0aGlzLmN1ckNvbnRleHQgPSBudWxsO1xuICB0aGlzLmN1cldlYkZyYW1lcyA9IFtdO1xuICB0aGlzLmN1cldlYkNvb3JkcyA9IG51bGw7XG4gIHRoaXMucmVtb3RlID0gbnVsbDtcbn07XG5cbmhlbHBlcnMuaXNXZWJDb250ZXh0ID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gISF0aGlzLmN1ckNvbnRleHQgJiYgdGhpcy5jdXJDb250ZXh0ICE9PSBOQVRJVkVfV0lOO1xufTtcblxuaGVscGVycy5zZXRDdXJyZW50VXJsID0gZnVuY3Rpb24gKHVybCkge1xuICB0aGlzLl9jdXJyZW50VXJsID0gdXJsO1xufTtcblxuaGVscGVycy5nZXRDdXJyZW50VXJsID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gdGhpcy5fY3VycmVudFVybDtcbn07XG5cblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycywgTkFUSVZFX1dJTiwgV0VCVklFV19XSU4sIFdFQlZJRVdfQkFTRSB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
