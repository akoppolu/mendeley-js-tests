'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _device = require('./device');

var SETTINGS_CAPS = ['locationServicesEnabled', 'locationServicesAuthorized'];
var SAFARI_SETTINGS_CAPS = ['safariAllowPopups', 'safariIgnoreFraudWarning', 'safariOpenLinksInBackground'];

function launchAndQuitSimulator(sim, safari) {
  return _regeneratorRuntime.async(function launchAndQuitSimulator$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('No simulator directories found.');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(sim.launchAndQuit(safari));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function checkPreferences(settings) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(settings), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var setting = _step.value;

      if (_lodash2['default'].has(opts, setting)) {
        return true;
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return false;
}

// pass in the simulator so that other systems that use the function can supply
// whatever they have
function setLocale(sim, opts) {
  var localeConfig = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];
  var safari = arguments.length <= 3 || arguments[3] === undefined ? false : arguments[3];
  var updated;
  return _regeneratorRuntime.async(function setLocale$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(!opts.language && !opts.locale && !opts.calendarFormat)) {
          context$1$0.next = 3;
          break;
        }

        _logger2['default'].debug("No reason to set locale");
        return context$1$0.abrupt('return');

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(sim.isFresh());

      case 5:
        if (!context$1$0.sent) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(launchAndQuitSimulator(sim, safari));

      case 8:

        _logger2['default'].debug('Setting locale information');
        localeConfig = {
          language: opts.language || localeConfig.language,
          locale: opts.locale || localeConfig.locale,
          calendarFormat: opts.calendarFormat || localeConfig.calendarFormat
        };

        context$1$0.prev = 10;
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(sim.updateLocale(opts.language, opts.locale, opts.calendarFormat));

      case 13:
        updated = context$1$0.sent;

        if (!updated) {
          context$1$0.next = 18;
          break;
        }

        _logger2['default'].debug('Locale was updated. Stopping simulator.');
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap((0, _device.endSimulator)(sim));

      case 18:
        context$1$0.next = 23;
        break;

      case 20:
        context$1$0.prev = 20;
        context$1$0.t0 = context$1$0['catch'](10);

        _logger2['default'].errorAndThrow('Appium was unable to set locale info: ' + context$1$0.t0);

      case 23:
        return context$1$0.abrupt('return', localeConfig);

      case 24:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[10, 20]]);
}

function setPreferences(sim, opts) {
  var safari = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
  var needToSetPrefs, needToSetSafariPrefs;
  return _regeneratorRuntime.async(function setPreferences$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        needToSetPrefs = checkPreferences(SETTINGS_CAPS, opts);
        needToSetSafariPrefs = checkPreferences(SAFARI_SETTINGS_CAPS, opts);

        if (!(!needToSetPrefs && !needToSetSafariPrefs)) {
          context$1$0.next = 5;
          break;
        }

        _logger2['default'].debug("No iOS / app preferences to set");
        return context$1$0.abrupt('return');

      case 5:

        _logger2['default'].debug("Setting iOS and app preferences");

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(sim.isFresh());

      case 8:
        if (!context$1$0.sent) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(launchAndQuitSimulator(sim, safari));

      case 11:
        context$1$0.prev = 11;

        if (!needToSetPrefs) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(setLocServicesPrefs(sim, opts));

      case 15:
        context$1$0.next = 21;
        break;

      case 17:
        context$1$0.prev = 17;
        context$1$0.t0 = context$1$0['catch'](11);

        _logger2['default'].error("Error setting location services preferences, prefs will not work");
        _logger2['default'].error(context$1$0.t0);

      case 21:
        context$1$0.prev = 21;

        if (!needToSetSafariPrefs) {
          context$1$0.next = 25;
          break;
        }

        context$1$0.next = 25;
        return _regeneratorRuntime.awrap(setSafariPrefs(sim, opts));

      case 25:
        context$1$0.next = 31;
        break;

      case 27:
        context$1$0.prev = 27;
        context$1$0.t1 = context$1$0['catch'](21);

        _logger2['default'].error("Error setting safari preferences, prefs will not work");
        _logger2['default'].error(context$1$0.t1);

      case 31:

        _logger2['default'].debug("Updated plist files, rebooting the simulator if it's already open");
        context$1$0.next = 34;
        return _regeneratorRuntime.awrap((0, _device.endSimulator)(sim));

      case 34:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[11, 17], [21, 27]]);
}

function setLocServicesPrefs(sim) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var locServ, msg, locAuth;
  return _regeneratorRuntime.async(function setLocServicesPrefs$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        locServ = _lodash2['default'].find([opts.locationServicesEnabled, opts.locationServicesAuthorized], function (c) {
          return !_lodash2['default'].isUndefined(c);
        });

        if (_lodash2['default'].isUndefined(locServ)) {
          context$1$0.next = 6;
          break;
        }

        locServ = locServ ? 1 : 0;
        _logger2['default'].debug('Setting location services to ' + locServ);
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(sim.updateSettings('locationServices', {
          LocationServicesEnabled: locServ,
          'LocationServicesEnabledIn7.0': locServ,
          'LocationServicesEnabledIn8.0': locServ
        }));

      case 6:
        if (_lodash2['default'].isUndefined(opts.locationServicesAuthorized)) {
          context$1$0.next = 12;
          break;
        }

        if (!opts.bundleId) {
          msg = "Can't set location services for app without bundle ID";

          _logger2['default'].errorAndThrow(msg);
        }
        locAuth = !!opts.locationServicesAuthorized;

        if (locAuth) {
          _logger2['default'].debug("Authorizing location services for app");
        } else {
          _logger2['default'].debug("De-authorizing location services for app");
        }
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(sim.updateLocationSettings(opts.bundleId, locAuth));

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function setSafariPrefs(sim) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var safariSettings, val;
  return _regeneratorRuntime.async(function setSafariPrefs$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        safariSettings = {};

        if (_lodash2['default'].has(opts, 'safariAllowPopups')) {
          val = !!opts.safariAllowPopups;

          _logger2['default'].debug('Setting javascript window opening to \'' + val + '\'');
          safariSettings.WebKitJavaScriptCanOpenWindowsAutomatically = val;
          safariSettings.JavaScriptCanOpenWindowsAutomatically = val;
        }
        if (_lodash2['default'].has(opts, 'safariIgnoreFraudWarning')) {
          val = !opts.safariIgnoreFraudWarning;

          _logger2['default'].debug('Setting fraudulent website warning to \'' + val + '\'');
          safariSettings.WarnAboutFraudulentWebsites = val;
        }
        if (_lodash2['default'].has(opts, 'safariOpenLinksInBackground')) {
          val = opts.safariOpenLinksInBackground ? 1 : 0;

          _logger2['default'].debug('Setting opening links in background to \'' + !!val + '\'');
          safariSettings.OpenLinksInBackground = val;
        }

        if (!(_lodash2['default'].size(safariSettings) > 0)) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(sim.updateSafariSettings(safariSettings));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.setLocale = setLocale;
exports.setPreferences = setPreferences;

// we need the simulator to have its directories in place
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXR0aW5ncy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7c0JBQWMsUUFBUTs7OztzQkFDSCxVQUFVOzs7O3NCQUNBLFVBQVU7O0FBR3ZDLElBQU0sYUFBYSxHQUFHLENBQ3BCLHlCQUF5QixFQUN6Qiw0QkFBNEIsQ0FDN0IsQ0FBQztBQUNGLElBQU0sb0JBQW9CLEdBQUcsQ0FDM0IsbUJBQW1CLEVBQ25CLDBCQUEwQixFQUMxQiw2QkFBNkIsQ0FDOUIsQ0FBQzs7QUFFRixTQUFlLHNCQUFzQixDQUFFLEdBQUcsRUFBRSxNQUFNOzs7O0FBQ2hELDRCQUFPLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDOzt5Q0FDbkMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUM7Ozs7Ozs7Ozs7Q0FDdkM7O0FBRUQsU0FBUyxnQkFBZ0IsQ0FBRSxRQUFRLEVBQWE7TUFBWCxJQUFJLHlEQUFHLEVBQUU7Ozs7OztBQUM1QyxzQ0FBb0IsUUFBUSw0R0FBRTtVQUFyQixPQUFPOztBQUNkLFVBQUksb0JBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsRUFBRTtBQUN4QixlQUFPLElBQUksQ0FBQztPQUNiO0tBQ0Y7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDRCxTQUFPLEtBQUssQ0FBQztDQUNkOzs7O0FBSUQsU0FBZSxTQUFTLENBQUUsR0FBRyxFQUFFLElBQUk7TUFBRSxZQUFZLHlEQUFHLEVBQUU7TUFBRSxNQUFNLHlEQUFHLEtBQUs7TUFtQjlELE9BQU87Ozs7Y0FsQlQsQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUE7Ozs7O0FBQ3hELDRCQUFPLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDOzs7Ozt5Q0FLaEMsR0FBRyxDQUFDLE9BQU8sRUFBRTs7Ozs7Ozs7O3lDQUNmLHNCQUFzQixDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUM7Ozs7QUFHM0MsNEJBQU8sS0FBSyxDQUFDLDRCQUE0QixDQUFDLENBQUM7QUFDM0Msb0JBQVksR0FBRztBQUNiLGtCQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVEsSUFBSSxZQUFZLENBQUMsUUFBUTtBQUNoRCxnQkFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLElBQUksWUFBWSxDQUFDLE1BQU07QUFDMUMsd0JBQWMsRUFBRSxJQUFJLENBQUMsY0FBYyxJQUFJLFlBQVksQ0FBQyxjQUFjO1NBQ25FLENBQUM7Ozs7eUNBR29CLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUM7OztBQUFqRixlQUFPOzthQUNQLE9BQU87Ozs7O0FBQ1QsNEJBQU8sS0FBSyxDQUFDLHlDQUF5QyxDQUFDLENBQUM7O3lDQUNsRCwwQkFBYSxHQUFHLENBQUM7Ozs7Ozs7Ozs7QUFHekIsNEJBQU8sYUFBYSwyREFBOEMsQ0FBQzs7OzRDQUc5RCxZQUFZOzs7Ozs7O0NBQ3BCOztBQUVELFNBQWUsY0FBYyxDQUFFLEdBQUcsRUFBRSxJQUFJO01BQUUsTUFBTSx5REFBRyxLQUFLO01BQ2xELGNBQWMsRUFDZCxvQkFBb0I7Ozs7QUFEcEIsc0JBQWMsR0FBRyxnQkFBZ0IsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDO0FBQ3RELDRCQUFvQixHQUFHLGdCQUFnQixDQUFDLG9CQUFvQixFQUFFLElBQUksQ0FBQzs7Y0FDbkUsQ0FBQyxjQUFjLElBQUksQ0FBQyxvQkFBb0IsQ0FBQTs7Ozs7QUFDMUMsNEJBQU8sS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7Ozs7O0FBSWxELDRCQUFPLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDOzs7eUNBRXRDLEdBQUcsQ0FBQyxPQUFPLEVBQUU7Ozs7Ozs7Ozt5Q0FDZixzQkFBc0IsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDOzs7OzthQUlyQyxjQUFjOzs7Ozs7eUNBQ1YsbUJBQW1CLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQzs7Ozs7Ozs7OztBQUd0Qyw0QkFBTyxLQUFLLENBQUMsa0VBQWtFLENBQUMsQ0FBQztBQUNqRiw0QkFBTyxLQUFLLGdCQUFHLENBQUM7Ozs7O2FBSVosb0JBQW9COzs7Ozs7eUNBQ2hCLGNBQWMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDOzs7Ozs7Ozs7O0FBR2pDLDRCQUFPLEtBQUssQ0FBQyx1REFBdUQsQ0FBQyxDQUFDO0FBQ3RFLDRCQUFPLEtBQUssZ0JBQUcsQ0FBQzs7OztBQUdsQiw0QkFBTyxLQUFLLENBQUMsbUVBQW1FLENBQUMsQ0FBQzs7eUNBQzVFLDBCQUFhLEdBQUcsQ0FBQzs7Ozs7OztDQUN4Qjs7QUFFRCxTQUFlLG1CQUFtQixDQUFFLEdBQUc7TUFBRSxJQUFJLHlEQUFHLEVBQUU7TUFDNUMsT0FBTyxFQWNILEdBQUcsRUFHTCxPQUFPOzs7O0FBakJULGVBQU8sR0FBRyxvQkFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsSUFBSSxDQUFDLDBCQUEwQixDQUFDLEVBQUUsVUFBQyxDQUFDLEVBQUs7QUFDM0YsaUJBQU8sQ0FBQyxvQkFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDMUIsQ0FBQzs7WUFDRyxvQkFBRSxXQUFXLENBQUMsT0FBTyxDQUFDOzs7OztBQUN6QixlQUFPLEdBQUcsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDMUIsNEJBQU8sS0FBSyxtQ0FBaUMsT0FBTyxDQUFHLENBQUM7O3lDQUNsRCxHQUFHLENBQUMsY0FBYyxDQUFDLGtCQUFrQixFQUFFO0FBQzNDLGlDQUF1QixFQUFFLE9BQU87QUFDaEMsd0NBQThCLEVBQUUsT0FBTztBQUN2Qyx3Q0FBOEIsRUFBRSxPQUFPO1NBQ3hDLENBQUM7OztZQUVDLG9CQUFFLFdBQVcsQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUM7Ozs7O0FBQ2pELFlBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO0FBQ2QsYUFBRyxHQUFHLHVEQUF1RDs7QUFDakUsOEJBQU8sYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzNCO0FBQ0csZUFBTyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsMEJBQTBCOztBQUMvQyxZQUFJLE9BQU8sRUFBRTtBQUNYLDhCQUFPLEtBQUssQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO1NBQ3ZELE1BQU07QUFDTCw4QkFBTyxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQztTQUMxRDs7eUNBQ0ssR0FBRyxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDOzs7Ozs7O0NBRTNEOztBQUVELFNBQWUsY0FBYyxDQUFFLEdBQUc7TUFBRSxJQUFJLHlEQUFHLEVBQUU7TUFDdkMsY0FBYyxFQWNaLEdBQUc7Ozs7QUFkTCxzQkFBYyxHQUFHLEVBQUU7O0FBRXZCLFlBQUksb0JBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxtQkFBbUIsQ0FBQyxFQUFFO0FBQ2hDLGFBQUcsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQjs7QUFDbEMsOEJBQU8sS0FBSyw2Q0FBMEMsR0FBRyxRQUFJLENBQUM7QUFDOUQsd0JBQWMsQ0FBQywyQ0FBMkMsR0FBRyxHQUFHLENBQUM7QUFDakUsd0JBQWMsQ0FBQyxxQ0FBcUMsR0FBRyxHQUFHLENBQUM7U0FDNUQ7QUFDRCxZQUFJLG9CQUFFLEdBQUcsQ0FBQyxJQUFJLEVBQUUsMEJBQTBCLENBQUMsRUFBRTtBQUN2QyxhQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCOztBQUN4Qyw4QkFBTyxLQUFLLDhDQUEyQyxHQUFHLFFBQUksQ0FBQztBQUMvRCx3QkFBYyxDQUFDLDJCQUEyQixHQUFHLEdBQUcsQ0FBQztTQUNsRDtBQUNELFlBQUksb0JBQUUsR0FBRyxDQUFDLElBQUksRUFBRSw2QkFBNkIsQ0FBQyxFQUFFO0FBQzFDLGFBQUcsR0FBRyxJQUFJLENBQUMsMkJBQTJCLEdBQUcsQ0FBQyxHQUFHLENBQUM7O0FBQ2xELDhCQUFPLEtBQUssK0NBQTRDLENBQUMsQ0FBQyxHQUFHLFFBQUksQ0FBQztBQUNsRSx3QkFBYyxDQUFDLHFCQUFxQixHQUFHLEdBQUcsQ0FBQztTQUM1Qzs7Y0FDRyxvQkFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFBOzs7Ozs7eUNBQ3RCLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxjQUFjLENBQUM7Ozs7Ozs7Q0FFakQ7O1FBRVEsU0FBUyxHQUFULFNBQVM7UUFBRSxjQUFjLEdBQWQsY0FBYyIsImZpbGUiOiJsaWIvc2V0dGluZ3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBlbmRTaW11bGF0b3IgfSBmcm9tICcuL2RldmljZSc7XG5cblxuY29uc3QgU0VUVElOR1NfQ0FQUyA9IFtcbiAgJ2xvY2F0aW9uU2VydmljZXNFbmFibGVkJyxcbiAgJ2xvY2F0aW9uU2VydmljZXNBdXRob3JpemVkJyxcbl07XG5jb25zdCBTQUZBUklfU0VUVElOR1NfQ0FQUyA9IFtcbiAgJ3NhZmFyaUFsbG93UG9wdXBzJyxcbiAgJ3NhZmFyaUlnbm9yZUZyYXVkV2FybmluZycsXG4gICdzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQnLFxuXTtcblxuYXN5bmMgZnVuY3Rpb24gbGF1bmNoQW5kUXVpdFNpbXVsYXRvciAoc2ltLCBzYWZhcmkpIHtcbiAgbG9nZ2VyLmRlYnVnKCdObyBzaW11bGF0b3IgZGlyZWN0b3JpZXMgZm91bmQuJyk7XG4gIHJldHVybiBhd2FpdCBzaW0ubGF1bmNoQW5kUXVpdChzYWZhcmkpO1xufVxuXG5mdW5jdGlvbiBjaGVja1ByZWZlcmVuY2VzIChzZXR0aW5ncywgb3B0cyA9IHt9KSB7XG4gIGZvciAobGV0IHNldHRpbmcgb2Ygc2V0dGluZ3MpIHtcbiAgICBpZiAoXy5oYXMob3B0cywgc2V0dGluZykpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbi8vIHBhc3MgaW4gdGhlIHNpbXVsYXRvciBzbyB0aGF0IG90aGVyIHN5c3RlbXMgdGhhdCB1c2UgdGhlIGZ1bmN0aW9uIGNhbiBzdXBwbHlcbi8vIHdoYXRldmVyIHRoZXkgaGF2ZVxuYXN5bmMgZnVuY3Rpb24gc2V0TG9jYWxlIChzaW0sIG9wdHMsIGxvY2FsZUNvbmZpZyA9IHt9LCBzYWZhcmkgPSBmYWxzZSkge1xuICBpZiAoIW9wdHMubGFuZ3VhZ2UgJiYgIW9wdHMubG9jYWxlICYmICFvcHRzLmNhbGVuZGFyRm9ybWF0KSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiTm8gcmVhc29uIHRvIHNldCBsb2NhbGVcIik7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gd2UgbmVlZCB0aGUgc2ltdWxhdG9yIHRvIGhhdmUgaXRzIGRpcmVjdG9yaWVzIGluIHBsYWNlXG4gIGlmIChhd2FpdCBzaW0uaXNGcmVzaCgpKSB7XG4gICAgYXdhaXQgbGF1bmNoQW5kUXVpdFNpbXVsYXRvcihzaW0sIHNhZmFyaSk7XG4gIH1cblxuICBsb2dnZXIuZGVidWcoJ1NldHRpbmcgbG9jYWxlIGluZm9ybWF0aW9uJyk7XG4gIGxvY2FsZUNvbmZpZyA9IHtcbiAgICBsYW5ndWFnZTogb3B0cy5sYW5ndWFnZSB8fCBsb2NhbGVDb25maWcubGFuZ3VhZ2UsXG4gICAgbG9jYWxlOiBvcHRzLmxvY2FsZSB8fCBsb2NhbGVDb25maWcubG9jYWxlLFxuICAgIGNhbGVuZGFyRm9ybWF0OiBvcHRzLmNhbGVuZGFyRm9ybWF0IHx8IGxvY2FsZUNvbmZpZy5jYWxlbmRhckZvcm1hdFxuICB9O1xuXG4gIHRyeSB7XG4gICAgbGV0IHVwZGF0ZWQgPSBhd2FpdCBzaW0udXBkYXRlTG9jYWxlKG9wdHMubGFuZ3VhZ2UsIG9wdHMubG9jYWxlLCBvcHRzLmNhbGVuZGFyRm9ybWF0KTtcbiAgICBpZiAodXBkYXRlZCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdMb2NhbGUgd2FzIHVwZGF0ZWQuIFN0b3BwaW5nIHNpbXVsYXRvci4nKTtcbiAgICAgIGF3YWl0IGVuZFNpbXVsYXRvcihzaW0pO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBBcHBpdW0gd2FzIHVuYWJsZSB0byBzZXQgbG9jYWxlIGluZm86ICR7ZX1gKTtcbiAgfVxuXG4gIHJldHVybiBsb2NhbGVDb25maWc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFByZWZlcmVuY2VzIChzaW0sIG9wdHMsIHNhZmFyaSA9IGZhbHNlKSB7XG4gIGxldCBuZWVkVG9TZXRQcmVmcyA9IGNoZWNrUHJlZmVyZW5jZXMoU0VUVElOR1NfQ0FQUywgb3B0cyk7XG4gIGxldCBuZWVkVG9TZXRTYWZhcmlQcmVmcyA9IGNoZWNrUHJlZmVyZW5jZXMoU0FGQVJJX1NFVFRJTkdTX0NBUFMsIG9wdHMpO1xuICBpZiAoIW5lZWRUb1NldFByZWZzICYmICFuZWVkVG9TZXRTYWZhcmlQcmVmcykge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIk5vIGlPUyAvIGFwcCBwcmVmZXJlbmNlcyB0byBzZXRcIik7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKFwiU2V0dGluZyBpT1MgYW5kIGFwcCBwcmVmZXJlbmNlc1wiKTtcblxuICBpZiAoYXdhaXQgc2ltLmlzRnJlc2goKSkge1xuICAgIGF3YWl0IGxhdW5jaEFuZFF1aXRTaW11bGF0b3Ioc2ltLCBzYWZhcmkpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBpZiAobmVlZFRvU2V0UHJlZnMpIHtcbiAgICAgIGF3YWl0IHNldExvY1NlcnZpY2VzUHJlZnMoc2ltLCBvcHRzKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIuZXJyb3IoXCJFcnJvciBzZXR0aW5nIGxvY2F0aW9uIHNlcnZpY2VzIHByZWZlcmVuY2VzLCBwcmVmcyB3aWxsIG5vdCB3b3JrXCIpO1xuICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgaWYgKG5lZWRUb1NldFNhZmFyaVByZWZzKSB7XG4gICAgICBhd2FpdCBzZXRTYWZhcmlQcmVmcyhzaW0sIG9wdHMpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZ2dlci5lcnJvcihcIkVycm9yIHNldHRpbmcgc2FmYXJpIHByZWZlcmVuY2VzLCBwcmVmcyB3aWxsIG5vdCB3b3JrXCIpO1xuICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZyhcIlVwZGF0ZWQgcGxpc3QgZmlsZXMsIHJlYm9vdGluZyB0aGUgc2ltdWxhdG9yIGlmIGl0J3MgYWxyZWFkeSBvcGVuXCIpO1xuICBhd2FpdCBlbmRTaW11bGF0b3Ioc2ltKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0TG9jU2VydmljZXNQcmVmcyAoc2ltLCBvcHRzID0ge30pIHtcbiAgbGV0IGxvY1NlcnYgPSBfLmZpbmQoW29wdHMubG9jYXRpb25TZXJ2aWNlc0VuYWJsZWQsIG9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWRdLCAoYykgPT4ge1xuICAgIHJldHVybiAhXy5pc1VuZGVmaW5lZChjKTtcbiAgfSk7XG4gIGlmICghXy5pc1VuZGVmaW5lZChsb2NTZXJ2KSkge1xuICAgIGxvY1NlcnYgPSBsb2NTZXJ2ID8gMSA6IDA7XG4gICAgbG9nZ2VyLmRlYnVnKGBTZXR0aW5nIGxvY2F0aW9uIHNlcnZpY2VzIHRvICR7bG9jU2Vydn1gKTtcbiAgICBhd2FpdCBzaW0udXBkYXRlU2V0dGluZ3MoJ2xvY2F0aW9uU2VydmljZXMnLCB7XG4gICAgICBMb2NhdGlvblNlcnZpY2VzRW5hYmxlZDogbG9jU2VydixcbiAgICAgICdMb2NhdGlvblNlcnZpY2VzRW5hYmxlZEluNy4wJzogbG9jU2VydixcbiAgICAgICdMb2NhdGlvblNlcnZpY2VzRW5hYmxlZEluOC4wJzogbG9jU2VydlxuICAgIH0pO1xuICB9XG4gIGlmICghXy5pc1VuZGVmaW5lZChvcHRzLmxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkKSkge1xuICAgIGlmICghb3B0cy5idW5kbGVJZCkge1xuICAgICAgbGV0IG1zZyA9IFwiQ2FuJ3Qgc2V0IGxvY2F0aW9uIHNlcnZpY2VzIGZvciBhcHAgd2l0aG91dCBidW5kbGUgSURcIjtcbiAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgfVxuICAgIGxldCBsb2NBdXRoID0gISFvcHRzLmxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkO1xuICAgIGlmIChsb2NBdXRoKSB7XG4gICAgICBsb2dnZXIuZGVidWcoXCJBdXRob3JpemluZyBsb2NhdGlvbiBzZXJ2aWNlcyBmb3IgYXBwXCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuZGVidWcoXCJEZS1hdXRob3JpemluZyBsb2NhdGlvbiBzZXJ2aWNlcyBmb3IgYXBwXCIpO1xuICAgIH1cbiAgICBhd2FpdCBzaW0udXBkYXRlTG9jYXRpb25TZXR0aW5ncyhvcHRzLmJ1bmRsZUlkLCBsb2NBdXRoKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRTYWZhcmlQcmVmcyAoc2ltLCBvcHRzID0ge30pIHtcbiAgbGV0IHNhZmFyaVNldHRpbmdzID0ge307XG5cbiAgaWYgKF8uaGFzKG9wdHMsICdzYWZhcmlBbGxvd1BvcHVwcycpKSB7XG4gICAgbGV0IHZhbCA9ICEhb3B0cy5zYWZhcmlBbGxvd1BvcHVwcztcbiAgICBsb2dnZXIuZGVidWcoYFNldHRpbmcgamF2YXNjcmlwdCB3aW5kb3cgb3BlbmluZyB0byAnJHt2YWx9J2ApO1xuICAgIHNhZmFyaVNldHRpbmdzLldlYktpdEphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkgPSB2YWw7XG4gICAgc2FmYXJpU2V0dGluZ3MuSmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSA9IHZhbDtcbiAgfVxuICBpZiAoXy5oYXMob3B0cywgJ3NhZmFyaUlnbm9yZUZyYXVkV2FybmluZycpKSB7XG4gICAgbGV0IHZhbCA9ICFvcHRzLnNhZmFyaUlnbm9yZUZyYXVkV2FybmluZztcbiAgICBsb2dnZXIuZGVidWcoYFNldHRpbmcgZnJhdWR1bGVudCB3ZWJzaXRlIHdhcm5pbmcgdG8gJyR7dmFsfSdgKTtcbiAgICBzYWZhcmlTZXR0aW5ncy5XYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMgPSB2YWw7XG4gIH1cbiAgaWYgKF8uaGFzKG9wdHMsICdzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQnKSkge1xuICAgIGxldCB2YWwgPSBvcHRzLnNhZmFyaU9wZW5MaW5rc0luQmFja2dyb3VuZCA/IDEgOiAwO1xuICAgIGxvZ2dlci5kZWJ1ZyhgU2V0dGluZyBvcGVuaW5nIGxpbmtzIGluIGJhY2tncm91bmQgdG8gJyR7ISF2YWx9J2ApO1xuICAgIHNhZmFyaVNldHRpbmdzLk9wZW5MaW5rc0luQmFja2dyb3VuZCA9IHZhbDtcbiAgfVxuICBpZiAoXy5zaXplKHNhZmFyaVNldHRpbmdzKSA+IDApIHtcbiAgICBhd2FpdCBzaW0udXBkYXRlU2FmYXJpU2V0dGluZ3Moc2FmYXJpU2V0dGluZ3MpO1xuICB9XG59XG5cbmV4cG9ydCB7IHNldExvY2FsZSwgc2V0UHJlZmVyZW5jZXMgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
