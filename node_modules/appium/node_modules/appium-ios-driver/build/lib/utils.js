'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumSupport = require('appium-support');

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _appUtils = require('./app-utils');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _teen_process = require('teen_process');

var _commandsSafari = require('./commands/safari');

var _safariLauncher = require('./safari-launcher');

var rootDir = _path2['default'].resolve(__dirname, '..', '..');

function prepareIosOpts(opts) {
  var pv;
  return _regeneratorRuntime.async(function prepareIosOpts$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        opts.backendRetries = 4;
        opts.withoutDelay = !opts.nativeInstrumentsLib;
        opts.reset = !opts.noReset;
        opts.initialOrientation = opts.deviceOrientation || opts.orientation || "PORTRAIT";
        opts.useRobot = opts.robotPort > 0;
        opts.robotUrl = opts.useRobot ? 'http://' + opts.robotAddress + ':' + opts.robotPort : null;

        if (!(opts.locationServicesAuthorized && !opts.bundleId)) {
          context$1$0.next = 8;
          break;
        }

        throw new Error("You must set the bundleId cap if using locationServicesEnabled");

      case 8:
        context$1$0.t0 = opts.platformVersion;

        if (context$1$0.t0) {
          context$1$0.next = 13;
          break;
        }

        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getMaxIOSSDK());

      case 12:
        context$1$0.t0 = context$1$0.sent;

      case 13:
        opts.platformVersion = context$1$0.t0;
        pv = parseFloat(opts.platformVersion);

        if (pv < 8) {
          _logger2['default'].warn('iOS version ' + opts.platformVersion + ' support has been ' + 'deprecated and will be removed in a future version of ' + 'Appium.');
        }
        opts.localizableStringsDir = opts.localizableStringsDir || 'en.lproj';
        opts.autoAcceptAlerts = _lodash2['default'].isNull(opts.autoAcceptAlerts) || _lodash2['default'].isUndefined(opts.autoAcceptAlerts) ? false : opts.autoAcceptAlerts;
        opts.autoDismissAlerts = _lodash2['default'].isNull(opts.autoDismissAlerts) || _lodash2['default'].isUndefined(opts.autoDismissAlerts) ? false : opts.autoDismissAlerts;

        if ((opts.browserName || '').toLowerCase() === 'safari' || (opts.app || '').toLowerCase() === 'safari' || (opts.bundleId || '').toLowerCase() === _commandsSafari.SAFARI_BUNDLE) {
          // preparing a safari session
          if (opts.udid) {
            // on a real device
            opts.app = opts.app || _safariLauncher.SAFARI_LAUNCHER_APP_FILE;
            opts.bundleId = opts.bundleId || _safariLauncher.SAFARI_LAUNCHER_BUNDLE;
          } else {
            if (parseFloat(opts.platformVersion) <= 8) {
              // make sure args.app has something in it so we get to the right spots
              // in moveBuiltInApp()
              opts.app = 'safari';
              opts.bundleId = null;
            } else {
              opts.app = null;
              opts.bundleId = _commandsSafari.SAFARI_BUNDLE;
            }
          }
          opts.safari = true;
        }

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function appIsPackageOrBundle(app) {
  return (/^([a-zA-Z0-9\-_]+\.[a-zA-Z0-9\-_]+)+$/.test(app)
  );
}

function removeInstrumentsSocket(sock) {
  return _regeneratorRuntime.async(function removeInstrumentsSocket$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug("Removing any remaining instruments sockets");
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(sock));

      case 3:
        _logger2['default'].debug('Cleaned up instruments socket ' + sock);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getAndCheckXcodeVersion(caps) {
  var version, minorVersion, pv;
  return _regeneratorRuntime.async(function getAndCheckXcodeVersion$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        version = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getVersion(true));

      case 4:
        version = context$1$0.sent;
        context$1$0.next = 12;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].debug(context$1$0.t0);
        _logger2['default'].error('Could not determine Xcode version: ' + context$1$0.t0.message);
        throw context$1$0.t0;

      case 12:
        minorVersion = version.versionFloat;
        pv = parseFloat(caps.platformVersion);

        // we deprecate Xcodes < 6.3, except for iOS 8.0 in which case we
        // support Xcode 6.0 as well
        if (minorVersion < 6.3 && !(minorVersion === 6.0 && pv === 8.0)) {
          _logger2['default'].warn('Xcode version \'' + version.versionString + '\'. Support for Xcode ' + (version.versionString + ' has been deprecated and will be removed ') + 'in a future version. Please upgrade to version 6.3 or ' + 'higher (or version 6.0.1 for iOS 8.0)');
        }
        return context$1$0.abrupt('return', version);

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
}

function getAndCheckIosSdkVersion() {
  var versionNumber;
  return _regeneratorRuntime.async(function getAndCheckIosSdkVersion$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        versionNumber = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getMaxIOSSDK());

      case 4:
        versionNumber = context$1$0.sent;
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].error("Could not determine iOS SDK version");
        throw context$1$0.t0;

      case 11:
        return context$1$0.abrupt('return', versionNumber);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
}

function getSimForDeviceString(dString, availDevices) {
  var matchedDevice = null;
  var matchedUdid = null;
  _lodash2['default'].each(availDevices, function (device) {
    if (device.indexOf(dString) !== -1) {
      matchedDevice = device;
      try {
        matchedUdid = /.+\[([^\]]+)\]/.exec(device)[1];
      } catch (e) {
        matchedUdid = null;
      }
    }
  });
  return [matchedDevice, matchedUdid];
}

function detectUdid(caps) {
  var cmd, args, udid, _ref, stdout;

  return _regeneratorRuntime.async(function detectUdid$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(caps.udid !== null && caps.udid === "auto")) {
          context$1$0.next = 34;
          break;
        }

        _logger2['default'].debug("Auto-detecting iOS udid...");
        cmd = undefined, args = [];
        context$1$0.prev = 3;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('idevice_id'));

      case 6:
        cmd = context$1$0.sent;

        args.push('-l');
        context$1$0.next = 13;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](3);

        cmd = require.resolve('udidetect');

      case 13:
        udid = undefined;
        context$1$0.prev = 14;
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(cmd, args, { timeout: 3000 }));

      case 17:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;

        udid = stdout.split("\n")[0];
        context$1$0.next = 26;
        break;

      case 22:
        context$1$0.prev = 22;
        context$1$0.t1 = context$1$0['catch'](14);

        _logger2['default'].error("Error detecting udid");
        throw context$1$0.t1;

      case 26:
        if (!(udid && udid.length > 2)) {
          context$1$0.next = 31;
          break;
        }

        caps.udid = udid;
        _logger2['default'].debug('Detected udid as \'' + caps.udid + '\'');
        context$1$0.next = 32;
        break;

      case 31:
        throw new Error("Could not detect udid.");

      case 32:
        context$1$0.next = 35;
        break;

      case 34:
        _logger2['default'].debug("Not auto-detecting udid.");

      case 35:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 10], [14, 22]]);
}

function parseLocalizableStrings(opts) {
  var language, stringFile, strings, obj;
  return _regeneratorRuntime.async(function parseLocalizableStrings$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(_lodash2['default'].isNull(opts.app) || _lodash2['default'].isUndefined(opts.app))) {
          context$1$0.next = 3;
          break;
        }

        _logger2['default'].debug("Localizable.strings is not currently supported when using real devices.");
        return context$1$0.abrupt('return');

      case 3:
        language = opts.language;
        stringFile = opts.stringFile || "Localizable.strings";
        strings = null;

        if (!language) {
          context$1$0.next = 15;
          break;
        }

        strings = _path2['default'].resolve(opts.app, language + '.lproj', stringFile);
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(strings));

      case 10:
        if (context$1$0.sent) {
          context$1$0.next = 13;
          break;
        }

        _logger2['default'].debug('No strings file \'' + stringFile + '\' for language \'' + language + '\', getting default strings');
        strings = _path2['default'].resolve(opts.app, stringFile);

      case 13:
        context$1$0.next = 17;
        break;

      case 15:
        _logger2['default'].debug('No language specified. Using default strings');
        strings = _path2['default'].resolve(opts.app, stringFile);

      case 17:
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(strings));

      case 19:
        if (context$1$0.sent) {
          context$1$0.next = 21;
          break;
        }

        if (opts.localizableStringsDir) {
          _logger2['default'].debug('Strings file not found. Looking in \'' + opts.localizableStringsDir + '\' directory');
          strings = _path2['default'].resolve(opts.app, opts.localizableStringsDir, stringFile);
        } else {
          strings = null;
        }

      case 21:
        context$1$0.t0 = !strings;

        if (context$1$0.t0) {
          context$1$0.next = 26;
          break;
        }

        context$1$0.next = 25;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(strings));

      case 25:
        context$1$0.t0 = !context$1$0.sent;

      case 26:
        if (!context$1$0.t0) {
          context$1$0.next = 29;
          break;
        }

        _logger2['default'].warn('Could not file localizable strings file \'' + stringFile + '\'!');
        return context$1$0.abrupt('return');

      case 29:
        obj = undefined;
        context$1$0.prev = 30;
        context$1$0.next = 33;
        return _regeneratorRuntime.awrap(_appiumSupport.plist.parsePlistFile(strings));

      case 33:
        obj = context$1$0.sent;

        _logger2['default'].debug('Parsed app \'' + stringFile + '\'');
        opts.localizableStrings = obj;
        return context$1$0.abrupt('return', obj);

      case 39:
        context$1$0.prev = 39;
        context$1$0.t1 = context$1$0['catch'](30);

        _logger2['default'].warn('Could not parse app \'' + stringFile + '\' assuming it does not exist');

      case 42:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[30, 39]]);
}

function setBundleIdFromApp(caps) {
  return _regeneratorRuntime.async(function setBundleIdFromApp$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (caps.bundleId) {
          context$1$0.next = 12;
          break;
        }

        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _appUtils.extractBundleId)(caps.app));

      case 4:
        caps.bundleId = context$1$0.sent;

        _logger2['default'].info('Extracted bundleID: ' + caps.bundleId + ' from app: ' + caps.app);
        context$1$0.next = 12;
        break;

      case 8:
        context$1$0.prev = 8;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].error("Could not set the bundleId from app.");
        throw context$1$0.t0;

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 8]]);
}

function shouldPrelaunchSimulator(caps, iosSdkVersion) {
  var shouldPrelaunch = false;

  if (caps.defaultDevice || iosSdkVersion >= 7.1) {
    if (this.iosSdkVersion >= 7.1) {
      _logger2['default'].debug("We're on iOS7.1+ so forcing defaultDevice on");
    } else {
      _logger2['default'].debug("User specified default device, letting instruments launch it");
    }
  } else {
    shouldPrelaunch = true;
  }
  return shouldPrelaunch;
}

function setDeviceTypeInInfoPlist(app, deviceString) {
  var plistFile, isiPhone, deviceTypeCode;
  return _regeneratorRuntime.async(function setDeviceTypeInInfoPlist$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(_lodash2['default'].isNull(app) || _lodash2['default'].isUndefined(app))) {
          context$1$0.next = 2;
          break;
        }

        return context$1$0.abrupt('return');

      case 2:
        plistFile = _path2['default'].resolve(app, "Info.plist");
        isiPhone = deviceString.toLowerCase().indexOf("ipad") === -1;
        deviceTypeCode = isiPhone ? 1 : 2;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.plist.updatePlistFile(plistFile, { UIDeviceFamily: [deviceTypeCode] }));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function unwrapEl(el) {
  if (typeof el === 'object' && el.ELEMENT) {
    return el.ELEMENT;
  }
  return el;
}

function clearLogs(locations) {
  var _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _location, size, _ref2, stdout;

  return _regeneratorRuntime.async(function clearLogs$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Clearing log files');
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 4;
        _iterator = _getIterator(locations);

      case 6:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 34;
          break;
        }

        _location = _step.value;
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(_location));

      case 10:
        if (!context$1$0.sent) {
          context$1$0.next = 31;
          break;
        }

        size = undefined;
        context$1$0.prev = 12;
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('du', ['-sh', _location]));

      case 15:
        _ref2 = context$1$0.sent;
        stdout = _ref2.stdout;

        size = stdout.trim().split(/\s+/)[0];
        context$1$0.next = 22;
        break;

      case 20:
        context$1$0.prev = 20;
        context$1$0.t0 = context$1$0['catch'](12);

      case 22:
        context$1$0.prev = 22;

        /* jshint ignore:start */
        _logger2['default'].debug('Deleting \'' + _location + '\'. ' + (size ? 'Freeing ' + size + '.' : ''));
        /* jshint ignore:end */
        context$1$0.next = 26;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(_location));

      case 26:
        context$1$0.next = 31;
        break;

      case 28:
        context$1$0.prev = 28;
        context$1$0.t1 = context$1$0['catch'](22);

        _logger2['default'].warn('Unable to delete \'' + _location + '\': ' + context$1$0.t1.message);

      case 31:
        _iteratorNormalCompletion = true;
        context$1$0.next = 6;
        break;

      case 34:
        context$1$0.next = 40;
        break;

      case 36:
        context$1$0.prev = 36;
        context$1$0.t2 = context$1$0['catch'](4);
        _didIteratorError = true;
        _iteratorError = context$1$0.t2;

      case 40:
        context$1$0.prev = 40;
        context$1$0.prev = 41;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 43:
        context$1$0.prev = 43;

        if (!_didIteratorError) {
          context$1$0.next = 46;
          break;
        }

        throw _iteratorError;

      case 46:
        return context$1$0.finish(43);

      case 47:
        return context$1$0.finish(40);

      case 48:
        _logger2['default'].debug('Finished clearing log files');

      case 49:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[4, 36, 40, 48], [12, 20], [22, 28], [41,, 43, 47]]);
}

exports['default'] = { rootDir: rootDir, removeInstrumentsSocket: removeInstrumentsSocket, getAndCheckXcodeVersion: getAndCheckXcodeVersion, prepareIosOpts: prepareIosOpts,
  appIsPackageOrBundle: appIsPackageOrBundle, getAndCheckIosSdkVersion: getAndCheckIosSdkVersion, detectUdid: detectUdid, parseLocalizableStrings: parseLocalizableStrings,
  setBundleIdFromApp: setBundleIdFromApp, shouldPrelaunchSimulator: shouldPrelaunchSimulator, setDeviceTypeInInfoPlist: setDeviceTypeInInfoPlist,
  getSimForDeviceString: getSimForDeviceString, unwrapEl: unwrapEl, clearLogs: clearLogs };
module.exports = exports['default'];

// This method will try to extract the bundleId from the app
//# sourceMappingURL=data:application/json;charset=utf8;base64,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RSxjQUFjLEVBQWQsY0FBYztBQUN4RixzQkFBb0IsRUFBcEIsb0JBQW9CLEVBQUUsd0JBQXdCLEVBQXhCLHdCQUF3QixFQUFHLFVBQVUsRUFBVixVQUFVLEVBQUUsdUJBQXVCLEVBQXZCLHVCQUF1QjtBQUNwRixvQkFBa0IsRUFBbEIsa0JBQWtCLEVBQUUsd0JBQXdCLEVBQXhCLHdCQUF3QixFQUFFLHdCQUF3QixFQUF4Qix3QkFBd0I7QUFDdEUsdUJBQXFCLEVBQXJCLHFCQUFxQixFQUFFLFFBQVEsRUFBUixRQUFRLEVBQUUsU0FBUyxFQUFULFNBQVMsRUFBRSIsImZpbGUiOiJsaWIvdXRpbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcywgcGxpc3QgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCB7IGV4dHJhY3RCdW5kbGVJZCB9IGZyb20gJy4vYXBwLXV0aWxzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBTQUZBUklfQlVORExFIH0gZnJvbSAnLi9jb21tYW5kcy9zYWZhcmknO1xuaW1wb3J0IHsgU0FGQVJJX0xBVU5DSEVSX0FQUF9GSUxFLCBTQUZBUklfTEFVTkNIRVJfQlVORExFIH0gZnJvbSAnLi9zYWZhcmktbGF1bmNoZXInO1xuXG5cbmNvbnN0IHJvb3REaXIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nKTtcblxuYXN5bmMgZnVuY3Rpb24gcHJlcGFyZUlvc09wdHMgKG9wdHMpIHtcbiAgb3B0cy5iYWNrZW5kUmV0cmllcyA9IDQ7XG4gIG9wdHMud2l0aG91dERlbGF5ID0gIW9wdHMubmF0aXZlSW5zdHJ1bWVudHNMaWI7XG4gIG9wdHMucmVzZXQgPSAhb3B0cy5ub1Jlc2V0O1xuICBvcHRzLmluaXRpYWxPcmllbnRhdGlvbiA9IG9wdHMuZGV2aWNlT3JpZW50YXRpb24gfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRzLm9yaWVudGF0aW9uIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJQT1JUUkFJVFwiO1xuICBvcHRzLnVzZVJvYm90ID0gb3B0cy5yb2JvdFBvcnQgPiAwO1xuICBvcHRzLnJvYm90VXJsID0gb3B0cy51c2VSb2JvdCA/XG4gICAgYGh0dHA6Ly8ke29wdHMucm9ib3RBZGRyZXNzfToke29wdHMucm9ib3RQb3J0fWAgOiBudWxsO1xuICBpZiAob3B0cy5sb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZCAmJiAhb3B0cy5idW5kbGVJZCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIllvdSBtdXN0IHNldCB0aGUgYnVuZGxlSWQgY2FwIGlmIHVzaW5nIGxvY2F0aW9uU2VydmljZXNFbmFibGVkXCIpO1xuICB9XG5cbiAgb3B0cy5wbGF0Zm9ybVZlcnNpb24gPSBvcHRzLnBsYXRmb3JtVmVyc2lvbiB8fCBhd2FpdCB4Y29kZS5nZXRNYXhJT1NTREsoKTtcbiAgbGV0IHB2ID0gcGFyc2VGbG9hdChvcHRzLnBsYXRmb3JtVmVyc2lvbik7XG4gIGlmIChwdiA8IDgpIHtcbiAgICBsb2dnZXIud2FybihgaU9TIHZlcnNpb24gJHtvcHRzLnBsYXRmb3JtVmVyc2lvbn0gc3VwcG9ydCBoYXMgYmVlbiBgICtcbiAgICAgICAgICAgICAgICBgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHZlcnNpb24gb2YgYCArXG4gICAgICAgICAgICAgICAgYEFwcGl1bS5gKTtcbiAgfVxuICBvcHRzLmxvY2FsaXphYmxlU3RyaW5nc0RpciA9IG9wdHMubG9jYWxpemFibGVTdHJpbmdzRGlyIHx8ICdlbi5scHJvaic7XG4gIG9wdHMuYXV0b0FjY2VwdEFsZXJ0cyA9IF8uaXNOdWxsKG9wdHMuYXV0b0FjY2VwdEFsZXJ0cykgfHwgXy5pc1VuZGVmaW5lZChvcHRzLmF1dG9BY2NlcHRBbGVydHMpID8gZmFsc2UgOiBvcHRzLmF1dG9BY2NlcHRBbGVydHM7XG4gIG9wdHMuYXV0b0Rpc21pc3NBbGVydHMgPSBfLmlzTnVsbChvcHRzLmF1dG9EaXNtaXNzQWxlcnRzKSB8fCBfLmlzVW5kZWZpbmVkKG9wdHMuYXV0b0Rpc21pc3NBbGVydHMpID8gZmFsc2UgOiBvcHRzLmF1dG9EaXNtaXNzQWxlcnRzO1xuXG4gIGlmICgob3B0cy5icm93c2VyTmFtZSB8fCAnJykudG9Mb3dlckNhc2UoKSA9PT0gJ3NhZmFyaScgfHxcbiAgICAgIChvcHRzLmFwcCB8fCAnJykudG9Mb3dlckNhc2UoKSA9PT0gJ3NhZmFyaScgfHxcbiAgICAgIChvcHRzLmJ1bmRsZUlkIHx8ICcnKS50b0xvd2VyQ2FzZSgpID09PSBTQUZBUklfQlVORExFKSB7XG4gICAgLy8gcHJlcGFyaW5nIGEgc2FmYXJpIHNlc3Npb25cbiAgICBpZiAob3B0cy51ZGlkKSB7XG4gICAgICAvLyBvbiBhIHJlYWwgZGV2aWNlXG4gICAgICBvcHRzLmFwcCA9IG9wdHMuYXBwIHx8IFNBRkFSSV9MQVVOQ0hFUl9BUFBfRklMRTtcbiAgICAgIG9wdHMuYnVuZGxlSWQgPSBvcHRzLmJ1bmRsZUlkIHx8IFNBRkFSSV9MQVVOQ0hFUl9CVU5ETEU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChwYXJzZUZsb2F0KG9wdHMucGxhdGZvcm1WZXJzaW9uKSA8PSA4KSB7XG4gICAgICAgIC8vIG1ha2Ugc3VyZSBhcmdzLmFwcCBoYXMgc29tZXRoaW5nIGluIGl0IHNvIHdlIGdldCB0byB0aGUgcmlnaHQgc3BvdHNcbiAgICAgICAgLy8gaW4gbW92ZUJ1aWx0SW5BcHAoKVxuICAgICAgICBvcHRzLmFwcCA9ICdzYWZhcmknO1xuICAgICAgICBvcHRzLmJ1bmRsZUlkID0gbnVsbDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9wdHMuYXBwID0gbnVsbDtcbiAgICAgICAgb3B0cy5idW5kbGVJZCA9IFNBRkFSSV9CVU5ETEU7XG4gICAgICB9XG4gICAgfVxuICAgIG9wdHMuc2FmYXJpID0gdHJ1ZTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhcHBJc1BhY2thZ2VPckJ1bmRsZSAoYXBwKSB7XG4gIHJldHVybiAoL14oW2EtekEtWjAtOVxcLV9dK1xcLlthLXpBLVowLTlcXC1fXSspKyQvKS50ZXN0KGFwcCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlbW92ZUluc3RydW1lbnRzU29ja2V0IChzb2NrKSB7XG4gIGxvZ2dlci5kZWJ1ZyhcIlJlbW92aW5nIGFueSByZW1haW5pbmcgaW5zdHJ1bWVudHMgc29ja2V0c1wiKTtcbiAgYXdhaXQgZnMucmltcmFmKHNvY2spO1xuICBsb2dnZXIuZGVidWcoYENsZWFuZWQgdXAgaW5zdHJ1bWVudHMgc29ja2V0ICR7c29ja31gKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QW5kQ2hlY2tYY29kZVZlcnNpb24gKGNhcHMpIHtcbiAgbGV0IHZlcnNpb247XG4gIHRyeSB7XG4gICAgdmVyc2lvbiA9IGF3YWl0IHhjb2RlLmdldFZlcnNpb24odHJ1ZSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZ2dlci5kZWJ1ZyhlcnIpO1xuICAgIGxvZ2dlci5lcnJvcihgQ291bGQgbm90IGRldGVybWluZSBYY29kZSB2ZXJzaW9uOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIHRocm93IGVycjtcbiAgfVxuICBsZXQgbWlub3JWZXJzaW9uID0gdmVyc2lvbi52ZXJzaW9uRmxvYXQ7XG4gIGxldCBwdiA9IHBhcnNlRmxvYXQoY2Fwcy5wbGF0Zm9ybVZlcnNpb24pO1xuICAvLyB3ZSBkZXByZWNhdGUgWGNvZGVzIDwgNi4zLCBleGNlcHQgZm9yIGlPUyA4LjAgaW4gd2hpY2ggY2FzZSB3ZVxuICAvLyBzdXBwb3J0IFhjb2RlIDYuMCBhcyB3ZWxsXG4gIGlmIChtaW5vclZlcnNpb24gPCA2LjMgJiYgKCEobWlub3JWZXJzaW9uID09PSA2LjAgJiYgcHYgPT09IDguMCkpKSB7XG4gICAgbG9nZ2VyLndhcm4oYFhjb2RlIHZlcnNpb24gJyR7dmVyc2lvbi52ZXJzaW9uU3RyaW5nfScuIFN1cHBvcnQgZm9yIFhjb2RlIGAgK1xuICAgICAgICAgICAgICAgIGAke3ZlcnNpb24udmVyc2lvblN0cmluZ30gaGFzIGJlZW4gZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGAgK1xuICAgICAgICAgICAgICAgIGBpbiBhIGZ1dHVyZSB2ZXJzaW9uLiBQbGVhc2UgdXBncmFkZSB0byB2ZXJzaW9uIDYuMyBvciBgICtcbiAgICAgICAgICAgICAgICBgaGlnaGVyIChvciB2ZXJzaW9uIDYuMC4xIGZvciBpT1MgOC4wKWApO1xuICB9XG4gIHJldHVybiB2ZXJzaW9uO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBbmRDaGVja0lvc1Nka1ZlcnNpb24gKCkge1xuICBsZXQgdmVyc2lvbk51bWJlcjtcbiAgdHJ5IHtcbiAgICB2ZXJzaW9uTnVtYmVyID0gYXdhaXQgeGNvZGUuZ2V0TWF4SU9TU0RLKCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZ2dlci5lcnJvcihcIkNvdWxkIG5vdCBkZXRlcm1pbmUgaU9TIFNESyB2ZXJzaW9uXCIpO1xuICAgIHRocm93IGVycjtcbiAgfVxuICByZXR1cm4gdmVyc2lvbk51bWJlcjtcbn1cblxuZnVuY3Rpb24gZ2V0U2ltRm9yRGV2aWNlU3RyaW5nIChkU3RyaW5nLCBhdmFpbERldmljZXMpIHtcbiAgbGV0IG1hdGNoZWREZXZpY2UgPSBudWxsO1xuICBsZXQgbWF0Y2hlZFVkaWQgPSBudWxsO1xuICBfLmVhY2goYXZhaWxEZXZpY2VzLCBmdW5jdGlvbiAoZGV2aWNlKSB7XG4gICAgaWYgKGRldmljZS5pbmRleE9mKGRTdHJpbmcpICE9PSAtMSkge1xuICAgICAgbWF0Y2hlZERldmljZSA9IGRldmljZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIG1hdGNoZWRVZGlkID0gLy4rXFxbKFteXFxdXSspXFxdLy5leGVjKGRldmljZSlbMV07XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIG1hdGNoZWRVZGlkID0gbnVsbDtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuICByZXR1cm4gW21hdGNoZWREZXZpY2UsIG1hdGNoZWRVZGlkXTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZGV0ZWN0VWRpZCAoY2Fwcykge1xuICBpZiAoY2Fwcy51ZGlkICE9PSBudWxsICYmIGNhcHMudWRpZCA9PT0gXCJhdXRvXCIpIHtcbiAgICBsb2dnZXIuZGVidWcoXCJBdXRvLWRldGVjdGluZyBpT1MgdWRpZC4uLlwiKTtcbiAgICBsZXQgIGNtZCwgYXJncyA9IFtdO1xuICAgIHRyeSB7XG4gICAgICBjbWQgPSBhd2FpdCBmcy53aGljaCgnaWRldmljZV9pZCcpO1xuICAgICAgYXJncy5wdXNoKCctbCcpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY21kID0gcmVxdWlyZS5yZXNvbHZlKCd1ZGlkZXRlY3QnKTtcbiAgICB9XG4gICAgbGV0IHVkaWQ7XG4gICAgdHJ5IHtcbiAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoY21kLCBhcmdzLCB7dGltZW91dDogMzAwMH0pO1xuICAgICAgdWRpZCA9IHN0ZG91dC5zcGxpdChcIlxcblwiKVswXTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcIkVycm9yIGRldGVjdGluZyB1ZGlkXCIpO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgICBpZiAodWRpZCAmJiB1ZGlkLmxlbmd0aCA+IDIpIHtcbiAgICAgIGNhcHMudWRpZCA9IHVkaWQ7XG4gICAgICBsb2dnZXIuZGVidWcoYERldGVjdGVkIHVkaWQgYXMgJyR7Y2Fwcy51ZGlkfSdgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ291bGQgbm90IGRldGVjdCB1ZGlkLlwiKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiTm90IGF1dG8tZGV0ZWN0aW5nIHVkaWQuXCIpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhcnNlTG9jYWxpemFibGVTdHJpbmdzIChvcHRzKSB7XG4gIGlmIChfLmlzTnVsbChvcHRzLmFwcCkgfHwgXy5pc1VuZGVmaW5lZChvcHRzLmFwcCkpIHtcbiAgICBsb2dnZXIuZGVidWcoXCJMb2NhbGl6YWJsZS5zdHJpbmdzIGlzIG5vdCBjdXJyZW50bHkgc3VwcG9ydGVkIHdoZW4gdXNpbmcgcmVhbCBkZXZpY2VzLlwiKTtcbiAgICByZXR1cm47XG4gIH1cbiAgbGV0IGxhbmd1YWdlID0gb3B0cy5sYW5ndWFnZTtcbiAgbGV0IHN0cmluZ0ZpbGUgPSBvcHRzLnN0cmluZ0ZpbGUgfHwgXCJMb2NhbGl6YWJsZS5zdHJpbmdzXCI7XG4gIGxldCBzdHJpbmdzID0gbnVsbDtcblxuICBpZiAobGFuZ3VhZ2UpIHtcbiAgICBzdHJpbmdzID0gcGF0aC5yZXNvbHZlKG9wdHMuYXBwLCBgJHtsYW5ndWFnZX0ubHByb2pgLCBzdHJpbmdGaWxlKTtcbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhzdHJpbmdzKSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBObyBzdHJpbmdzIGZpbGUgJyR7c3RyaW5nRmlsZX0nIGZvciBsYW5ndWFnZSAnJHtsYW5ndWFnZX0nLCBnZXR0aW5nIGRlZmF1bHQgc3RyaW5nc2ApO1xuICAgICAgc3RyaW5ncyA9IHBhdGgucmVzb2x2ZShvcHRzLmFwcCwgc3RyaW5nRmlsZSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxvZ2dlci5kZWJ1ZygnTm8gbGFuZ3VhZ2Ugc3BlY2lmaWVkLiBVc2luZyBkZWZhdWx0IHN0cmluZ3MnKTtcbiAgICBzdHJpbmdzID0gcGF0aC5yZXNvbHZlKG9wdHMuYXBwLCBzdHJpbmdGaWxlKTtcbiAgfVxuXG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKHN0cmluZ3MpKSB7XG4gICAgaWYgKG9wdHMubG9jYWxpemFibGVTdHJpbmdzRGlyKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYFN0cmluZ3MgZmlsZSBub3QgZm91bmQuIExvb2tpbmcgaW4gJyR7b3B0cy5sb2NhbGl6YWJsZVN0cmluZ3NEaXJ9JyBkaXJlY3RvcnlgKTtcbiAgICAgIHN0cmluZ3MgPSBwYXRoLnJlc29sdmUob3B0cy5hcHAsIG9wdHMubG9jYWxpemFibGVTdHJpbmdzRGlyLCBzdHJpbmdGaWxlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3RyaW5ncyA9IG51bGw7XG4gICAgfVxuICB9XG4gIGlmICghc3RyaW5ncyB8fCAhYXdhaXQgZnMuZXhpc3RzKHN0cmluZ3MpKSB7XG4gICAgbG9nZ2VyLndhcm4oYENvdWxkIG5vdCBmaWxlIGxvY2FsaXphYmxlIHN0cmluZ3MgZmlsZSAnJHtzdHJpbmdGaWxlfSchYCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IG9iajtcbiAgdHJ5IHtcbiAgICBvYmogPSBhd2FpdCBwbGlzdC5wYXJzZVBsaXN0RmlsZShzdHJpbmdzKTtcbiAgICBsb2dnZXIuZGVidWcoYFBhcnNlZCBhcHAgJyR7c3RyaW5nRmlsZX0nYCk7XG4gICAgb3B0cy5sb2NhbGl6YWJsZVN0cmluZ3MgPSBvYmo7XG4gICAgcmV0dXJuIG9iajtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLndhcm4oYENvdWxkIG5vdCBwYXJzZSBhcHAgJyR7c3RyaW5nRmlsZX0nIGFzc3VtaW5nIGl0IGRvZXMgbm90IGV4aXN0YCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0QnVuZGxlSWRGcm9tQXBwIChjYXBzKSB7XG4gIC8vIFRoaXMgbWV0aG9kIHdpbGwgdHJ5IHRvIGV4dHJhY3QgdGhlIGJ1bmRsZUlkIGZyb20gdGhlIGFwcFxuICBpZiAoIWNhcHMuYnVuZGxlSWQpIHtcbiAgICB0cnkge1xuICAgICAgY2Fwcy5idW5kbGVJZCA9IGF3YWl0IGV4dHJhY3RCdW5kbGVJZChjYXBzLmFwcCk7XG4gICAgICBsb2dnZXIuaW5mbyhgRXh0cmFjdGVkIGJ1bmRsZUlEOiAke2NhcHMuYnVuZGxlSWR9IGZyb20gYXBwOiAke2NhcHMuYXBwfWApO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmVycm9yKFwiQ291bGQgbm90IHNldCB0aGUgYnVuZGxlSWQgZnJvbSBhcHAuXCIpO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBzaG91bGRQcmVsYXVuY2hTaW11bGF0b3IgKGNhcHMsIGlvc1Nka1ZlcnNpb24pIHtcbiAgbGV0IHNob3VsZFByZWxhdW5jaCA9IGZhbHNlO1xuXG4gIGlmIChjYXBzLmRlZmF1bHREZXZpY2UgfHwgaW9zU2RrVmVyc2lvbiA+PSA3LjEpIHtcbiAgICBpZiAodGhpcy5pb3NTZGtWZXJzaW9uID49IDcuMSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKFwiV2UncmUgb24gaU9TNy4xKyBzbyBmb3JjaW5nIGRlZmF1bHREZXZpY2Ugb25cIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIlVzZXIgc3BlY2lmaWVkIGRlZmF1bHQgZGV2aWNlLCBsZXR0aW5nIGluc3RydW1lbnRzIGxhdW5jaCBpdFwiKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgc2hvdWxkUHJlbGF1bmNoID0gdHJ1ZTtcbiAgfVxuICByZXR1cm4gc2hvdWxkUHJlbGF1bmNoO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXREZXZpY2VUeXBlSW5JbmZvUGxpc3QgKGFwcCwgZGV2aWNlU3RyaW5nKSB7XG4gIGlmIChfLmlzTnVsbChhcHApIHx8IF8uaXNVbmRlZmluZWQoYXBwKSkgeyByZXR1cm47IH1cbiAgbGV0IHBsaXN0RmlsZSA9IHBhdGgucmVzb2x2ZShhcHAsIFwiSW5mby5wbGlzdFwiKTtcbiAgbGV0IGlzaVBob25lID0gZGV2aWNlU3RyaW5nLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihcImlwYWRcIikgPT09IC0xO1xuICBsZXQgZGV2aWNlVHlwZUNvZGUgPSBpc2lQaG9uZSA/IDEgOiAyO1xuICBhd2FpdCBwbGlzdC51cGRhdGVQbGlzdEZpbGUocGxpc3RGaWxlLCB7VUlEZXZpY2VGYW1pbHk6IFtkZXZpY2VUeXBlQ29kZV19KTtcbn1cblxuZnVuY3Rpb24gdW53cmFwRWwgKGVsKSB7XG4gIGlmICh0eXBlb2YgZWwgPT09ICdvYmplY3QnICYmIGVsLkVMRU1FTlQpIHtcbiAgICByZXR1cm4gZWwuRUxFTUVOVDtcbiAgfVxuICByZXR1cm4gZWw7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNsZWFyTG9ncyAobG9jYXRpb25zKSB7XG4gIGxvZ2dlci5kZWJ1ZygnQ2xlYXJpbmcgbG9nIGZpbGVzJyk7XG4gIGZvciAobGV0IGxvY2F0aW9uIG9mIGxvY2F0aW9ucykge1xuICAgIGlmIChhd2FpdCBmcy5leGlzdHMobG9jYXRpb24pKSB7XG4gICAgICBsZXQgc2l6ZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ2R1JywgWyctc2gnLCBsb2NhdGlvbl0pO1xuICAgICAgICBzaXplID0gc3Rkb3V0LnRyaW0oKS5zcGxpdCgvXFxzKy8pWzBdO1xuICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgICAgdHJ5IHtcbiAgICAgICAgLyoganNoaW50IGlnbm9yZTpzdGFydCAqL1xuICAgICAgICBsb2dnZXIuZGVidWcoYERlbGV0aW5nICcke2xvY2F0aW9ufScuICR7c2l6ZSA/IGBGcmVlaW5nICR7c2l6ZX0uYCA6ICcnfWApO1xuICAgICAgICAvKiBqc2hpbnQgaWdub3JlOmVuZCAqL1xuICAgICAgICBhd2FpdCBmcy5yaW1yYWYobG9jYXRpb24pO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKGBVbmFibGUgdG8gZGVsZXRlICcke2xvY2F0aW9ufSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGxvZ2dlci5kZWJ1ZygnRmluaXNoZWQgY2xlYXJpbmcgbG9nIGZpbGVzJyk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IHsgcm9vdERpciwgcmVtb3ZlSW5zdHJ1bWVudHNTb2NrZXQsIGdldEFuZENoZWNrWGNvZGVWZXJzaW9uLCBwcmVwYXJlSW9zT3B0cyxcbiAgYXBwSXNQYWNrYWdlT3JCdW5kbGUsIGdldEFuZENoZWNrSW9zU2RrVmVyc2lvbiwgIGRldGVjdFVkaWQsIHBhcnNlTG9jYWxpemFibGVTdHJpbmdzLFxuICBzZXRCdW5kbGVJZEZyb21BcHAsIHNob3VsZFByZWxhdW5jaFNpbXVsYXRvciwgc2V0RGV2aWNlVHlwZUluSW5mb1BsaXN0LFxuICBnZXRTaW1Gb3JEZXZpY2VTdHJpbmcsIHVud3JhcEVsLCBjbGVhckxvZ3MgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
