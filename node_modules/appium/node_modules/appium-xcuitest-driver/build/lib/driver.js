'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _nodeSimctl = require('node-simctl');

var _webdriveragent = require('./webdriveragent');

var _webdriveragent2 = _interopRequireDefault(_webdriveragent);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _simulatorManagement = require('./simulator-management');

var _appiumIosSimulator = require('appium-ios-simulator');

var _asyncbox = require('asyncbox');

var _appiumIosDriver = require('appium-ios-driver');

var _desiredCaps = require('./desired-caps');

var _desiredCaps2 = _interopRequireDefault(_desiredCaps);

var _commandsIndex = require('./commands/index');

var _commandsIndex2 = _interopRequireDefault(_commandsIndex);

var _utils = require('./utils');

var _realDeviceManagement = require('./real-device-management');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _packageJson = require('../../package.json');

// eslint-disable-line import/no-unresolved

var SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';
var WDA_STARTUP_RETRIES = 2;
var DEFAULT_TIMEOUT_KEY = 'default';
var WDA_STARTUP_RETRY_INTERVAL = 10000;

var NO_PROXY_NATIVE_LIST = [['GET', /^\/session\/[^\/]+$/], ['GET', /context/], ['POST', /context/], ['GET', /window/], ['POST', /window/], ['DELETE', /window/], ['POST', /execute/], ['POST', /element$/], ['POST', /elements$/], ['POST', /timeouts/], ['GET', /alert_text/], ['POST', /alert_text/], ['POST', /accept_alert/], ['POST', /dismiss_alert/], ['GET', /source/], ['GET', /screenshot/], ['POST', /appium/], ['GET', /appium/], ['POST', /touch/], ['GET', /log/], ['POST', /log/], ['POST', /moveto/], ['POST', /receive_async_response/], // always, in case context switches while waiting
['GET', /location/], ['GET', /size/], ['POST', /value/], ['POST', /keys/], ['POST', /back/], ['POST', /session\/[^\/]+\/location/], // geo location, but not element location
['POST', /appium\/device\/lock/], ['POST', /shake/], ['POST', /clear/]];
var NO_PROXY_WEB_LIST = [['GET', /title/], ['GET', /url/], ['POST', /url/], ['POST', /element/], ['POST', /forward/], ['GET', /attribute/], ['GET', /text/], ['POST', /clear/], ['GET', /element/], ['POST', /click/], ['POST', /refresh/], ['GET', /cookie/], ['POST', /cookie/], ['DELETE', /cookie/], ['POST', /frame/], ['POST', /keys/]].concat(NO_PROXY_NATIVE_LIST);

function normalizeCommandTimeouts(value) {
  // The value is normalized already
  if (typeof value !== 'string') {
    return value;
  }

  var result = {};
  // Use as default timeout for all commands if a single integer value is provided
  if (!isNaN(value)) {
    result[DEFAULT_TIMEOUT_KEY] = _lodash2['default'].toInteger(value);
    return result;
  }

  // JSON object has been provided. Let's parse it
  try {
    result = JSON.parse(value);
    if (!_lodash2['default'].isPlainObject(result)) {
      throw new Error();
    }
  } catch (err) {
    _logger2['default'].errorAndThrow('"commandTimeouts" capability should be a valid JSON object. "' + value + '" was given instead');
  }
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(_lodash2['default'].toPairs(result)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var _step$value = _slicedToArray(_step.value, 2);

      var cmd = _step$value[0];
      var timeout = _step$value[1];

      if (!_lodash2['default'].isInteger(timeout) || timeout <= 0) {
        _logger2['default'].errorAndThrow('The timeout for "' + cmd + '" should be a valid natural number of milliseconds. "' + timeout + '" was given instead');
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return result;
}

var XCUITestDriver = (function (_BaseDriver) {
  _inherits(XCUITestDriver, _BaseDriver);

  function XCUITestDriver() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
    var shouldValidateCaps = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

    _classCallCheck(this, XCUITestDriver);

    _get(Object.getPrototypeOf(XCUITestDriver.prototype), 'constructor', this).call(this, opts, shouldValidateCaps);

    _logger2['default'].debug('XCUITestDriver version: ' + _packageJson.version);

    this.desiredCapConstraints = _desiredCaps2['default'];

    this.locatorStrategies = ['xpath', 'id', 'name', 'class name', '-ios predicate string', '-ios class chain', 'accessibility id'];
    this.webLocatorStrategies = ['link text', 'css selector', 'tag name', 'link text', 'partial link text'];

    this.resetIos();
  }

  _createClass(XCUITestDriver, [{
    key: 'resetIos',
    value: function resetIos() {
      this.opts = this.opts || {};
      this.wda = null;
      this.opts.device = null;
      this.jwpProxyActive = false;
      this.proxyReqRes = null;
      this.jwpProxyAvoid = [];
      this.safari = false;
      this.cachedWdaStatus = null;

      // some things that commands imported from appium-ios-driver need
      this.curWebFrames = [];
      this.webElementIds = [];
      this._currentUrl = null;
      this.curContext = null;
      this.xcodeVersion = null;
      this.iosSdkVersion = null;
      this.contexts = [];
      this.implicitWaitMs = 0;
      this.asynclibWaitMs = 0;
      this.pageLoadMs = 6000;
    }
  }, {
    key: 'getStatus',
    value: function getStatus() {
      var status;
      return _regeneratorRuntime.async(function getStatus$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(typeof this.driverInfo === 'undefined')) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _utils.getDriverInfo)());

          case 3:
            this.driverInfo = context$2$0.sent;

          case 4:
            status = { build: { version: this.driverInfo.version } };

            if (this.cachedWdaStatus) {
              status.wda = this.cachedWdaStatus;
            }
            return context$2$0.abrupt('return', status);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createSession',
    value: function createSession(caps) {
      var _ref, _ref2, sessionId;

      return _regeneratorRuntime.async(function createSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.lifecycleData = {}; // this is used for keeping track of the state we start so when we delete the session we can put things back
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(XCUITestDriver.prototype), 'createSession', this).call(this, caps));

          case 4:
            _ref = context$2$0.sent;
            _ref2 = _slicedToArray(_ref, 1);
            sessionId = _ref2[0];

            this.opts.sessionId = sessionId;

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.start());

          case 10:

            // merge server capabilities + desired capabilities
            caps = _Object$assign({}, _appiumIosDriver.defaultServerCaps, caps);
            // update the udid with what is actually used
            caps.udid = this.opts.udid;
            return context$2$0.abrupt('return', [sessionId, caps]);

          case 15:
            context$2$0.prev = 15;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].error(context$2$0.t0);
            context$2$0.next = 20;
            return _regeneratorRuntime.awrap(this.deleteSession());

          case 20:
            throw context$2$0.t0;

          case 21:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 15]]);
    }
  }, {
    key: 'start',
    value: function start() {
      var tools, _ref3, device, udid, realDevice, msg, installAppPromise;

      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.opts.noReset = !!this.opts.noReset;
            this.opts.fullReset = !!this.opts.fullReset;

            if (this.xcodeVersion) {
              context$2$0.next = 8;
              break;
            }

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _utils.getAndCheckXcodeVersion)());

          case 5:
            this.xcodeVersion = context$2$0.sent;
            tools = !this.xcodeVersion.toolsVersion ? '' : '(tools v' + this.xcodeVersion.toolsVersion + ')';

            _logger2['default'].debug('Xcode version set to \'' + this.xcodeVersion.versionString + '\' ' + tools);

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap((0, _utils.getAndCheckIosSdkVersion)());

          case 10:
            this.iosSdkVersion = context$2$0.sent;

            _logger2['default'].debug('iOS SDK Version set to \'' + this.iosSdkVersion + '\'');

            if (!(this.opts.platformVersion && parseFloat(this.opts.platformVersion) < 9.3)) {
              context$2$0.next = 14;
              break;
            }

            throw Error('Platform version must be 9.3 or above. \'' + this.opts.platformVersion + '\' is not supported.');

          case 14:

            this.logEvent('xcodeDetailsRetrieved');

            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(this.determineDevice());

          case 17:
            _ref3 = context$2$0.sent;
            device = _ref3.device;
            udid = _ref3.udid;
            realDevice = _ref3.realDevice;

            _logger2['default'].info('Determining device to run tests on: udid: \'' + udid + '\', real device: ' + realDevice);
            this.opts.device = device;
            this.opts.udid = udid;
            this.opts.realDevice = realDevice;

            if (!(this.isSimulator() && this.opts.customSSLCert)) {
              context$2$0.next = 29;
              break;
            }

            context$2$0.next = 28;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.installSSLCert)(this.opts.customSSLCert, this.opts.udid));

          case 28:
            this.logEvent('customCertInstalled');

          case 29:
            if (!(this.opts.enableAsyncExecuteFromHttps && !this.isRealDevice())) {
              context$2$0.next = 34;
              break;
            }

            context$2$0.next = 32;
            return _regeneratorRuntime.awrap(this.opts.device.shutdown());

          case 32:
            context$2$0.next = 34;
            return _regeneratorRuntime.awrap(this.startHttpsAsyncServer());

          case 34:
            if (this.opts.platformVersion) {
              context$2$0.next = 42;
              break;
            }

            if (!(this.opts.device && _lodash2['default'].isFunction(this.opts.device.getPlatformVersion))) {
              context$2$0.next = 42;
              break;
            }

            context$2$0.next = 38;
            return _regeneratorRuntime.awrap(this.opts.device.getPlatformVersion());

          case 38:
            this.opts.platformVersion = context$2$0.sent;

            _logger2['default'].info('No platformVersion specified. Using device version: \'' + this.opts.platformVersion + '\'');
            context$2$0.next = 42;
            break;

          case 42:
            // TODO: this is when it is a real device. when we have a real object wire it in

            // make sure that the xcode we are using can handle the platform
            if (parseFloat(this.opts.platformVersion) > parseFloat(this.iosSdkVersion)) {
              msg = 'Xcode ' + this.xcodeVersion.versionString + ' has a maximum SDK version of ' + this.iosSdkVersion + '. ' + ('It does not support iOS version ' + this.opts.platformVersion);

              _logger2['default'].errorAndThrow(msg);
            }

            if (!((this.opts.browserName || '').toLowerCase() === 'safari')) {
              context$2$0.next = 53;
              break;
            }

            _logger2['default'].info('Safari test requested');
            this.safari = true;
            this.opts.app = undefined;
            this.opts.processArguments = this.opts.processArguments || {};
            this.opts.bundleId = SAFARI_BUNDLE_ID;
            this._currentUrl = this.opts.safariInitialUrl || (this.isRealDevice() ? 'http://appium.io' : 'http://' + this.opts.address + ':' + this.opts.port + '/welcome');
            this.opts.processArguments.args = ['-u', this._currentUrl];
            context$2$0.next = 55;
            break;

          case 53:
            context$2$0.next = 55;
            return _regeneratorRuntime.awrap(this.configureApp());

          case 55:
            this.logEvent('appConfigured');

            // fail very early if the app doesn't actually exist
            // or if bundle id doesn't point to an installed app

            if (!this.opts.app) {
              context$2$0.next = 61;
              break;
            }

            context$2$0.next = 59;
            return _regeneratorRuntime.awrap((0, _utils.checkAppPresent)(this.opts.app));

          case 59:
            context$2$0.next = 66;
            break;

          case 61:
            if (!(this.opts.bundleId && !this.safari)) {
              context$2$0.next = 66;
              break;
            }

            context$2$0.next = 64;
            return _regeneratorRuntime.awrap(this.opts.device.isAppInstalled(this.opts.bundleId));

          case 64:
            if (context$2$0.sent) {
              context$2$0.next = 66;
              break;
            }

            _logger2['default'].errorAndThrow('App with bundle identifier \'' + this.opts.bundleId + '\' unknown');

          case 66:
            if (this.opts.bundleId) {
              context$2$0.next = 70;
              break;
            }

            context$2$0.next = 69;
            return _regeneratorRuntime.awrap(this.extractBundleId(this.opts.app));

          case 69:
            this.opts.bundleId = context$2$0.sent;

          case 70:

            if (!this.opts.realDevice) {
              if (typeof this.opts.scaleFactor !== 'undefined') {
                _logger2['default'].info('Setting non-default Simulator scale factor to \'' + this.opts.scaleFactor + '\'');
                device.setScaleFactor(this.opts.scaleFactor);
              }
              if (typeof this.opts.connectHardwareKeyboard !== 'undefined') {
                _logger2['default'].info('Setting \'connectHardwareKeyboard\' Simulator option to \'' + (this.opts.connectHardwareKeyboard ? 'on' : 'off') + '\'');
                device.setConnectHardwareKeyboard(this.opts.connectHardwareKeyboard);
              }
            }

            context$2$0.next = 73;
            return _regeneratorRuntime.awrap(this.runReset());

          case 73:
            context$2$0.next = 75;
            return _regeneratorRuntime.awrap(this.startLogCapture());

          case 75:
            this.logEvent('logCaptureStarted');

            _logger2['default'].info('Setting up ' + (this.isRealDevice() ? 'real device' : 'simulator'));

            if (!this.isRealDevice()) {
              context$2$0.next = 84;
              break;
            }

            if (!this.opts.app) {
              context$2$0.next = 82;
              break;
            }

            context$2$0.next = 81;
            return _regeneratorRuntime.awrap(this.installApp());

          case 81:
            this.logEvent('appInstalled');

          case 82:
            context$2$0.next = 104;
            break;

          case 84:
            context$2$0.next = 86;
            return _regeneratorRuntime.awrap(_appiumIosDriver.settings.setLocale(this.opts.device, this.opts, {}, this.isSafari()));

          case 86:
            this.localeConfig = context$2$0.sent;
            context$2$0.next = 89;
            return _regeneratorRuntime.awrap(_appiumIosDriver.settings.setPreferences(this.opts.device, this.opts, this.isSafari()));

          case 89:
            installAppPromise = null;

            if (!this.opts.app) {
              context$2$0.next = 98;
              break;
            }

            context$2$0.next = 93;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.simBooted)(this.opts.device));

          case 93:
            if (!context$2$0.sent) {
              context$2$0.next = 97;
              break;
            }

            installAppPromise = this.installApp();
            context$2$0.next = 98;
            break;

          case 97:
            installAppPromise = new _bluebird2['default'](function callee$2$0(resolve, reject) {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    this.opts.device.on(_appiumIosSimulator.BOOT_COMPLETED_EVENT, function callee$3$0() {
                      return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                        while (1) switch (context$4$0.prev = context$4$0.next) {
                          case 0:
                            context$4$0.prev = 0;
                            context$4$0.next = 3;
                            return _regeneratorRuntime.awrap(this.installApp());

                          case 3:
                            resolve();
                            context$4$0.next = 9;
                            break;

                          case 6:
                            context$4$0.prev = 6;
                            context$4$0.t0 = context$4$0['catch'](0);

                            reject(context$4$0.t0);

                          case 9:
                          case 'end':
                            return context$4$0.stop();
                        }
                      }, null, _this, [[0, 6]]);
                    });

                  case 1:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            });

          case 98:
            context$2$0.next = 100;
            return _regeneratorRuntime.awrap(this.startSim());

          case 100:
            this.logEvent('simStarted');
            context$2$0.next = 103;
            return _regeneratorRuntime.awrap(installAppPromise);

          case 103:
            this.logEvent('appInstalled');

          case 104:
            context$2$0.next = 106;
            return _regeneratorRuntime.awrap(this.startWda(this.opts.sessionId, realDevice));

          case 106:
            context$2$0.next = 108;
            return _regeneratorRuntime.awrap(this.setInitialOrientation(this.opts.orientation));

          case 108:
            this.logEvent('orientationSet');

            if (!(this.isRealDevice() && this.opts.startIWDP)) {
              context$2$0.next = 119;
              break;
            }

            context$2$0.prev = 110;
            context$2$0.next = 113;
            return _regeneratorRuntime.awrap(this.startIWDP());

          case 113:
            _logger2['default'].debug('Started ios_webkit_debug proxy server at: ' + this.iwdpServer.endpoint);
            context$2$0.next = 119;
            break;

          case 116:
            context$2$0.prev = 116;
            context$2$0.t0 = context$2$0['catch'](110);

            _logger2['default'].errorAndThrow('Could not start ios_webkit_debug_proxy server: ' + context$2$0.t0.message);

          case 119:
            if (!(this.isSafari() || this.opts.autoWebview)) {
              context$2$0.next = 124;
              break;
            }

            _logger2['default'].debug('Waiting for initial webview');
            context$2$0.next = 123;
            return _regeneratorRuntime.awrap(this.navToInitialWebview());

          case 123:
            this.logEvent('initialWebviewNavigated');

          case 124:
            if (this.isRealDevice()) {
              context$2$0.next = 133;
              break;
            }

            if (!this.opts.calendarAccessAuthorized) {
              context$2$0.next = 130;
              break;
            }

            context$2$0.next = 128;
            return _regeneratorRuntime.awrap(this.opts.device.enableCalendarAccess(this.opts.bundleId));

          case 128:
            context$2$0.next = 133;
            break;

          case 130:
            if (!(this.opts.calendarAccessAuthorized === false)) {
              context$2$0.next = 133;
              break;
            }

            context$2$0.next = 133;
            return _regeneratorRuntime.awrap(this.opts.device.disableCalendarAccess(this.opts.bundleId));

          case 133:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[110, 116]]);
    }
  }, {
    key: 'startWda',
    value: function startWda(sessionId, realDevice) {
      var startupRetries, startupRetryInterval;
      return _regeneratorRuntime.async(function startWda$(context$2$0) {
        var _this4 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            startupRetries = this.opts.wdaStartupRetries || WDA_STARTUP_RETRIES;
            startupRetryInterval = this.opts.wdaStartupRetryInterval || WDA_STARTUP_RETRY_INTERVAL;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(startupRetries, startupRetryInterval, function callee$2$0() {
              var quitAndUninstall, wdaStatus;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this3 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    this.logEvent('wdaStartAttempted');
                    this.wda = new _webdriveragent2['default'](this.xcodeVersion, this.opts);

                    if (!this.opts.useNewWDA) {
                      context$3$0.next = 7;
                      break;
                    }

                    _logger2['default'].debug('Capability \'useNewWDA\' set, so uninstalling WDA before proceeding');
                    context$3$0.next = 6;
                    return _regeneratorRuntime.awrap(this.wda.uninstall());

                  case 6:
                    this.logEvent('wdaUninstalled');

                  case 7:
                    quitAndUninstall = function quitAndUninstall(msg) {
                      return _regeneratorRuntime.async(function quitAndUninstall$(context$4$0) {
                        while (1) switch (context$4$0.prev = context$4$0.next) {
                          case 0:
                            _logger2['default'].debug(msg);
                            _logger2['default'].debug('Quitting and uninstalling WebDriverAgent, then retrying');
                            context$4$0.next = 4;
                            return _regeneratorRuntime.awrap(this.wda.quit());

                          case 4:
                            context$4$0.next = 6;
                            return _regeneratorRuntime.awrap(this.wda.uninstall());

                          case 6:
                            throw new Error(msg);

                          case 7:
                          case 'end':
                            return context$4$0.stop();
                        }
                      }, null, _this3);
                    };

                    wdaStatus = null;
                    context$3$0.prev = 9;
                    context$3$0.next = 12;
                    return _regeneratorRuntime.awrap(this.wda.launch(sessionId, realDevice));

                  case 12:
                    wdaStatus = context$3$0.sent;
                    context$3$0.next = 20;
                    break;

                  case 15:
                    context$3$0.prev = 15;
                    context$3$0.t0 = context$3$0['catch'](9);

                    this.logEvent('wdaStartFailed');
                    context$3$0.next = 20;
                    return _regeneratorRuntime.awrap(quitAndUninstall('Unable to launch WebDriverAgent because of xcodebuild failure: ' + context$3$0.t0.message));

                  case 20:

                    this.proxyReqRes = this.wda.proxyReqRes.bind(this.wda);
                    this.jwpProxyActive = true;

                    context$3$0.prev = 22;
                    context$3$0.next = 25;
                    return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(15, 1000, function callee$3$0() {
                      return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                        while (1) switch (context$4$0.prev = context$4$0.next) {
                          case 0:
                            this.logEvent('wdaSessionAttempted');
                            _logger2['default'].debug('Sending createSession command to WDA');
                            context$4$0.prev = 2;

                            if (!wdaStatus) {
                              context$4$0.next = 7;
                              break;
                            }

                            this.cachedWdaStatus = wdaStatus;
                            context$4$0.next = 9;
                            break;

                          case 7:
                            context$4$0.next = 9;
                            return _regeneratorRuntime.awrap(this.proxyCommand('/status', 'GET'));

                          case 9:
                            context$4$0.next = 11;
                            return _regeneratorRuntime.awrap(this.startWdaSession(this.opts.bundleId, this.opts.processArguments));

                          case 11:
                            context$4$0.next = 17;
                            break;

                          case 13:
                            context$4$0.prev = 13;
                            context$4$0.t0 = context$4$0['catch'](2);

                            _logger2['default'].debug('Failed to create WDA session. Retrying...');
                            throw context$4$0.t0;

                          case 17:
                          case 'end':
                            return context$4$0.stop();
                        }
                      }, null, _this3, [[2, 13]]);
                    }));

                  case 25:
                    this.logEvent('wdaSessionStarted');
                    context$3$0.next = 33;
                    break;

                  case 28:
                    context$3$0.prev = 28;
                    context$3$0.t1 = context$3$0['catch'](22);
                    context$3$0.next = 32;
                    return _regeneratorRuntime.awrap(quitAndUninstall('Unable to start WebDriverAgent session: ' + context$3$0.t1.message));

                  case 32:
                    return context$3$0.abrupt('return', context$3$0.sent);

                  case 33:

                    this.opts.preventWDAAttachments = !_appiumSupport.util.hasValue(this.opts.preventWDAAttachments) || this.opts.preventWDAAttachments;
                    context$3$0.next = 36;
                    return _regeneratorRuntime.awrap((0, _utils.adjustWDAAttachmentsPermissions)(this.opts.preventWDAAttachments ? '555' : '755'));

                  case 36:
                    this.logEvent('wdaPermsAdjusted');

                    // we expect certain socket errors until this point, but now
                    // mark things as fully working
                    this.wda.fullyStarted = true;
                    this.logEvent('wdaStarted');

                  case 39:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this4, [[9, 15], [22, 28]]);
            }));

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // create an alias so we can actually unit test createSession by stubbing
    // this
  }, {
    key: 'extractBundleId',
    value: function extractBundleId(app) {
      return _regeneratorRuntime.async(function extractBundleId$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(_appiumIosDriver.appUtils.extractBundleId(app));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'runReset',
    value: function runReset() {
      var opts = arguments.length <= 0 || arguments[0] === undefined ? null : arguments[0];
      return _regeneratorRuntime.async(function runReset$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.logEvent('resetStarted');

            if (!this.isRealDevice()) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((0, _realDeviceManagement.runRealDeviceReset)(this.opts.device, opts || this.opts));

          case 4:
            context$2$0.next = 8;
            break;

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.runSimulatorReset)(this.opts.device, opts || this.opts));

          case 8:
            this.logEvent('resetComplete');

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.stop());

          case 2:
            if (!this.opts.preventWDAAttachments) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _utils.adjustWDAAttachmentsPermissions)('755'));

          case 5:
            if (!this.opts.clearSystemFiles) {
              context$2$0.next = 10;
              break;
            }

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _utils.clearSystemFiles)(this.wda, !!this.opts.showXcodeLog));

          case 8:
            context$2$0.next = 11;
            break;

          case 10:
            _logger2['default'].debug('Not clearing log files. Use `clearSystemFiles` capability to turn on.');

          case 11:
            if (!this.isWebContext()) {
              context$2$0.next = 15;
              break;
            }

            _logger2['default'].debug('In a web session. Removing remote debugger');
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.stopRemote());

          case 15:
            if (!(this.opts.resetOnSessionStartOnly === false)) {
              context$2$0.next = 18;
              break;
            }

            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(this.runReset());

          case 18:
            if (!(this.isSimulator() && this.opts.udid && this.opts.customSSLCert)) {
              context$2$0.next = 21;
              break;
            }

            context$2$0.next = 21;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.uninstallSSLCert)(this.opts.customSSLCert, this.opts.udid));

          case 21:
            if (!(this.isSimulator() && !this.opts.noReset && !!this.opts.device)) {
              context$2$0.next = 28;
              break;
            }

            if (!this.lifecycleData.createSim) {
              context$2$0.next = 28;
              break;
            }

            _logger2['default'].debug('Deleting simulator created for this run');
            context$2$0.next = 26;
            return _regeneratorRuntime.awrap(this.opts.device.shutdown());

          case 26:
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(this.opts.device['delete']());

          case 28:

            if (!_lodash2['default'].isEmpty(this.logs)) {
              this.logs.syslog.stopCapture();
              this.logs = {};
            }

            if (this.iwdpServer) {
              this.stopIWDP();
            }

            if (!(this.opts.enableAsyncExecuteFromHttps && !this.isRealDevice())) {
              context$2$0.next = 33;
              break;
            }

            context$2$0.next = 33;
            return _regeneratorRuntime.awrap(this.stopHttpsAsyncServer());

          case 33:

            this.resetIos();

            context$2$0.next = 36;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(XCUITestDriver.prototype), 'deleteSession', this).call(this));

          case 36:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.jwpProxyActive = false;
            this.proxyReqRes = null;

            if (!(this.wda && this.wda.fullyStarted)) {
              context$2$0.next = 14;
              break;
            }

            if (!this.wda.jwproxy) {
              context$2$0.next = 12;
              break;
            }

            context$2$0.prev = 4;
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.proxyCommand('/session/' + this.sessionId, 'DELETE'));

          case 7:
            context$2$0.next = 12;
            break;

          case 9:
            context$2$0.prev = 9;
            context$2$0.t0 = context$2$0['catch'](4);

            // an error here should not short-circuit the rest of clean up
            _logger2['default'].debug('Unable to DELETE session on WDA: \'' + context$2$0.t0.message + '\'. Continuing shutdown.');

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.wda.quit());

          case 14:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[4, 9]]);
    }
  }, {
    key: 'executeCommand',
    value: function executeCommand(cmd) {
      var _get2;

      for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        args[_key - 1] = arguments[_key];
      }

      return _regeneratorRuntime.async(function executeCommand$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Executing command \'' + cmd + '\'');

            if (!(cmd === 'receiveAsyncResponse')) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.receiveAsyncResponse.apply(this, args));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
            if (!(cmd === 'getStatus')) {
              context$2$0.next = 9;
              break;
            }

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.getStatus());

          case 8:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap((_get2 = _get(Object.getPrototypeOf(XCUITestDriver.prototype), 'executeCommand', this)).call.apply(_get2, [this, cmd].concat(args)));

          case 11:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'configureApp',
    value: function configureApp() {
      var appIsPackageOrBundle;
      return _regeneratorRuntime.async(function configureApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            appIsPackageOrBundle = function appIsPackageOrBundle(app) {
              return (/^([a-zA-Z0-9\-_]+\.[a-zA-Z0-9\-_]+)+$/.test(app)
              );
            };

            // the app name is a bundleId assign it to the bundleId property
            if (!this.opts.bundleId && appIsPackageOrBundle(this.opts.app)) {
              this.opts.bundleId = this.opts.app;
              this.opts.app = '';
            }
            // we have a bundle ID, but no app, or app is also a bundle

            if (!(this.opts.bundleId && appIsPackageOrBundle(this.opts.bundleId) && (this.opts.app === '' || appIsPackageOrBundle(this.opts.app)))) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].debug('App is an iOS bundle, will attempt to run as pre-existing');
            return context$2$0.abrupt('return');

          case 5:
            if (!(this.opts.app && this.opts.app.toLowerCase() === 'settings')) {
              context$2$0.next = 11;
              break;
            }

            this.opts.bundleId = 'com.apple.Preferences';
            this.opts.app = null;
            return context$2$0.abrupt('return');

          case 11:
            if (!(this.opts.app && this.opts.app.toLowerCase() === 'calendar')) {
              context$2$0.next = 15;
              break;
            }

            this.opts.bundleId = 'com.apple.mobilecal';
            this.opts.app = null;
            return context$2$0.abrupt('return');

          case 15:
            context$2$0.prev = 15;
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(this.helpers.configureApp(this.opts.app, '.app', this.opts.mountRoot, this.opts.windowsShareUserName, this.opts.windowsSharePassword));

          case 18:
            this.opts.app = context$2$0.sent;
            context$2$0.next = 25;
            break;

          case 21:
            context$2$0.prev = 21;
            context$2$0.t0 = context$2$0['catch'](15);

            _logger2['default'].error(context$2$0.t0);
            throw new Error('Bad app: ' + this.opts.app + '. App paths need to be absolute, or relative to the appium ' + 'server install dir, or a URL to compressed file, or a special app name.');

          case 25:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[15, 21]]);
    }
  }, {
    key: 'determineDevice',
    value: function determineDevice() {
      var _device, devices, _device2, device;

      return _regeneratorRuntime.async(function determineDevice$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // in the one case where we create a sim, we will set this state
            this.lifecycleData.createSim = false;

            // if we get generic names, translate them
            this.opts.deviceName = (function translateDeviceName() {
              var dn = arguments.length <= 0 || arguments[0] === undefined ? '' : arguments[0];

              var deviceName = dn;
              if (dn.toLowerCase() === 'iphone simulator') {
                deviceName = 'iPhone 6';
              } else if (dn.toLowerCase() === 'ipad simulator') {
                deviceName = 'iPad Retina';
              }
              if (deviceName !== dn) {
                _logger2['default'].debug('Changing deviceName from \'' + dn + '\' to \'' + deviceName + '\'');
              }
              return deviceName;
            })(this.opts.deviceName);

            // check for a particular simulator
            context$2$0.t0 = this.opts.udid;

            if (!context$2$0.t0) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.simExists)(this.opts.udid));

          case 6:
            context$2$0.t0 = context$2$0.sent;

          case 7:
            if (!context$2$0.t0) {
              context$2$0.next = 12;
              break;
            }

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.getSimulator)(this.opts.udid));

          case 10:
            _device = context$2$0.sent;
            return context$2$0.abrupt('return', { device: _device, realDevice: false, udid: this.opts.udid });

          case 12:
            if (!this.opts.udid) {
              context$2$0.next = 29;
              break;
            }

            if (!(this.opts.udid.toLowerCase() === 'auto')) {
              context$2$0.next = 19;
              break;
            }

            context$2$0.next = 16;
            return _regeneratorRuntime.awrap((0, _utils.detectUdid)());

          case 16:
            this.opts.udid = context$2$0.sent;
            context$2$0.next = 25;
            break;

          case 19:
            context$2$0.next = 21;
            return _regeneratorRuntime.awrap((0, _realDeviceManagement.getConnectedDevices)());

          case 21:
            devices = context$2$0.sent;

            _logger2['default'].debug('Available devices: ' + devices.join(', '));

            if (!(devices.indexOf(this.opts.udid) === -1)) {
              context$2$0.next = 25;
              break;
            }

            throw new Error('Unknown device or simulator UDID: \'' + this.opts.udid + '\'');

          case 25:
            context$2$0.next = 27;
            return _regeneratorRuntime.awrap((0, _realDeviceManagement.getRealDeviceObj)(this.opts.udid));

          case 27:
            _device2 = context$2$0.sent;
            return context$2$0.abrupt('return', { device: _device2, realDevice: true, udid: this.opts.udid });

          case 29:
            context$2$0.next = 31;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.getExistingSim)(this.opts.deviceName, this.opts.platformVersion));

          case 31:
            device = context$2$0.sent;

            if (!device) {
              context$2$0.next = 34;
              break;
            }

            return context$2$0.abrupt('return', { device: device, realDevice: false, udid: device.udid });

          case 34:

            // no device of this type exists, so create one
            _logger2['default'].info('Simulator udid not provided, using desired caps to create a new simulator');
            if (!this.opts.platformVersion) {
              _logger2['default'].info('No platformVersion specified. Using latest version Xcode supports: \'' + this.iosSdkVersion + '\' ' + 'This may cause problems if a simulator does not exist for this platform version.');
              this.opts.platformVersion = this.iosSdkVersion;
            }
            context$2$0.next = 38;
            return _regeneratorRuntime.awrap(this.createSim());

          case 38:
            device = context$2$0.sent;
            return context$2$0.abrupt('return', { device: device, realDevice: false, udid: device.udid });

          case 40:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSim',
    value: function startSim() {
      return _regeneratorRuntime.async(function startSim$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.simBooted)(this.opts.device));

          case 2:
            if (!context$2$0.sent) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].info('Simulator with udid \'' + this.opts.udid + '\' already booted');
            return context$2$0.abrupt('return');

          case 5:
            _logger2['default'].info('Simulator with udid \'' + this.opts.udid + '\' not booted. Booting up now');
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.killAllSimulators)());

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.opts.device.run(undefined, this.opts.allowTouchIdEnroll));

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createSim',
    value: function createSim() {
      var sim;
      return _regeneratorRuntime.async(function createSim$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.lifecycleData.createSim = true;

            // create sim for caps
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.createSim)(this.opts, this.sessionId));

          case 3:
            sim = context$2$0.sent;

            _logger2['default'].info('Created simulator with udid \'' + sim.udid + '\'.');

            return context$2$0.abrupt('return', sim);

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'launchApp',
    value: function launchApp() {
      var APP_LAUNCH_TIMEOUT, checkStatus, retries;
      return _regeneratorRuntime.async(function launchApp$(context$2$0) {
        var _this5 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            APP_LAUNCH_TIMEOUT = 20 * 1000;

            this.logEvent('appLaunchAttempted');
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.launch)(this.opts.device.udid, this.opts.bundleId));

          case 4:
            checkStatus = function checkStatus() {
              var response, currentApp;
              return _regeneratorRuntime.async(function checkStatus$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.proxyCommand('/status', 'GET'));

                  case 2:
                    response = context$3$0.sent;
                    currentApp = response.currentApp.bundleID;

                    if (!(currentApp !== this.opts.bundleId)) {
                      context$3$0.next = 6;
                      break;
                    }

                    throw new Error(this.opts.bundleId + ' not in foreground. ' + currentApp + ' is in foreground');

                  case 6:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this5);
            };

            _logger2['default'].info('Waiting for \'' + this.opts.bundleId + '\' to be in foreground');
            retries = parseInt(APP_LAUNCH_TIMEOUT / 200, 10);
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(retries, 200, checkStatus));

          case 9:
            _logger2['default'].info(this.opts.bundleId + ' is in foreground');
            this.logEvent('appLaunched');

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startWdaSession',
    value: function startWdaSession(bundleId, processArguments) {
      var args, env, shouldWaitForQuiescence, maxTypingFrequency, shouldUseSingletonTestManager, shouldUseTestManagerForVisibilityDetection, desired;
      return _regeneratorRuntime.async(function startWdaSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = processArguments ? processArguments.args : [];
            env = processArguments ? processArguments.env : {};
            shouldWaitForQuiescence = _appiumSupport.util.hasValue(this.opts.waitForQuiescence) ? this.opts.waitForQuiescence : true;
            maxTypingFrequency = _appiumSupport.util.hasValue(this.opts.maxTypingFrequency) ? this.opts.maxTypingFrequency : 60;
            shouldUseSingletonTestManager = _appiumSupport.util.hasValue(this.opts.shouldUseSingletonTestManager) ? this.opts.shouldUseSingletonTestManager : true;
            shouldUseTestManagerForVisibilityDetection = false;

            if (_appiumSupport.util.hasValue(this.opts.simpleIsVisibleCheck)) {
              shouldUseTestManagerForVisibilityDetection = this.opts.simpleIsVisibleCheck;
            }
            if (!isNaN(parseFloat(this.opts.platformVersion)) && parseFloat(this.opts.platformVersion).toFixed(1) === '9.3') {
              _logger2['default'].info('Forcing shouldUseSingletonTestManager capability value to true, because of known XCTest issues under 9.3 platform version');
              shouldUseTestManagerForVisibilityDetection = true;
            }

            desired = {
              desiredCapabilities: {
                bundleId: bundleId,
                arguments: args,
                environment: env,
                shouldWaitForQuiescence: shouldWaitForQuiescence,
                shouldUseTestManagerForVisibilityDetection: shouldUseTestManagerForVisibilityDetection,
                maxTypingFrequency: maxTypingFrequency,
                shouldUseSingletonTestManager: shouldUseSingletonTestManager
              }
            };
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.proxyCommand('/session', 'POST', desired));

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // Override Proxy methods from BaseDriver
  }, {
    key: 'proxyActive',
    value: function proxyActive() {
      return this.jwpProxyActive;
    }
  }, {
    key: 'getProxyAvoidList',
    value: function getProxyAvoidList() {
      if (this.isWebview()) {
        return NO_PROXY_WEB_LIST;
      }
      return NO_PROXY_NATIVE_LIST;
    }
  }, {
    key: 'canProxy',
    value: function canProxy() {
      return true;
    }
  }, {
    key: 'isSafari',
    value: function isSafari() {
      return !!this.safari;
    }
  }, {
    key: 'isRealDevice',
    value: function isRealDevice() {
      return this.opts.realDevice;
    }
  }, {
    key: 'isSimulator',
    value: function isSimulator() {
      return !this.opts.realDevice;
    }
  }, {
    key: 'isWebview',
    value: function isWebview() {
      return this.isSafari() || this.isWebContext();
    }
  }, {
    key: 'validateLocatorStrategy',
    value: function validateLocatorStrategy(strategy) {
      _get(Object.getPrototypeOf(XCUITestDriver.prototype), 'validateLocatorStrategy', this).call(this, strategy, this.isWebContext());
    }
  }, {
    key: 'validateDesiredCaps',
    value: function validateDesiredCaps(caps) {
      // check with the base class, and return if it fails
      var res = _get(Object.getPrototypeOf(XCUITestDriver.prototype), 'validateDesiredCaps', this).call(this, caps);
      if (!res) {
        return res;
      }

      // make sure that the capabilities have one of `app` or `bundleId`
      if ((caps.browserName || '').toLowerCase() !== 'safari' && !caps.app && !caps.bundleId) {
        var msg = 'The desired capabilities must include either an app or a bundleId for iOS';
        _logger2['default'].errorAndThrow(msg);
      }

      var verifyProcessArgument = function verifyProcessArgument(processArguments) {
        if (!_lodash2['default'].isNil(processArguments.args) && !_lodash2['default'].isArray(processArguments.args)) {
          _logger2['default'].errorAndThrow('processArguments.args must be an array of string');
        }

        if (!_lodash2['default'].isNil(processArguments.env) && !_lodash2['default'].isObject(caps.processArguments.env)) {
          _logger2['default'].errorAndThrow('processArguments.env must be an object <key,value> pair {a:b, c:d}');
        }
      };

      // `processArguments` should be JSON string or an object with arguments and/ environment details
      if (caps.processArguments) {
        if (_lodash2['default'].isString(caps.processArguments)) {
          try {
            // try to parse the string as JSON
            caps.processArguments = JSON.parse(caps.processArguments);
            verifyProcessArgument(caps.processArguments);
          } catch (err) {
            _logger2['default'].errorAndThrow('processArguments must be a json format or an object with format {args : [], env : {a:b, c:d}}. Both environment and argument can be null. Error: ' + err);
          }
        } else if (_lodash2['default'].isObject(caps.processArguments)) {
          verifyProcessArgument(caps.processArguments);
        } else {
          _logger2['default'].errorAndThrow('processArguments must be an object, or a string JSON object with format {args : [], env : {a:b, c:d}}. Both environment and argument can be null.');
        }
      }

      // there is no point in having `keychainPath` without `keychainPassword`
      if (caps.keychainPath && !caps.keychainPassword || !caps.keychainPath && caps.keychainPassword) {
        _logger2['default'].errorAndThrow('If \'keychainPath\' is set, \'keychainPassword\' must also be set (and vice versa).');
      }

      if (caps.autoAcceptAlerts || caps.autoDismissAlerts) {
        _logger2['default'].warn('The capabilities \'autoAcceptAlerts\' and \'autoDismissAlerts\' ' + 'do not work for XCUITest-based tests. Please adjust your ' + 'alert handling accordingly.');
      }

      // `resetOnSessionStartOnly` should be set to true by default
      this.opts.resetOnSessionStartOnly = !_appiumSupport.util.hasValue(this.opts.resetOnSessionStartOnly) || this.opts.resetOnSessionStartOnly;

      // finally, return true since the superclass check passed, as did this
      return true;
    }
  }, {
    key: 'installApp',
    value: function installApp() {
      var pause;
      return _regeneratorRuntime.async(function installApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.isSafari()) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return');

          case 2:
            if (!(this.opts.autoLaunch === false)) {
              context$2$0.next = 4;
              break;
            }

            return context$2$0.abrupt('return');

          case 4:
            if (!this.isRealDevice()) {
              context$2$0.next = 9;
              break;
            }

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _realDeviceManagement.installToRealDevice)(this.opts.device, this.opts.app, this.opts.bundleId, this.opts.noReset));

          case 7:
            context$2$0.next = 11;
            break;

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.installToSimulator)(this.opts.device, this.opts.app, this.opts.bundleId, this.opts.noReset));

          case 11:
            if (!_appiumSupport.util.hasValue(this.opts.iosInstallPause)) {
              context$2$0.next = 16;
              break;
            }

            pause = parseInt(this.opts.iosInstallPause, 10);

            _logger2['default'].debug('iosInstallPause set. Pausing ' + pause + ' ms before continuing');
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(pause));

          case 16:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setInitialOrientation',
    value: function setInitialOrientation(orientation) {
      return _regeneratorRuntime.async(function setInitialOrientation$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (typeof orientation !== 'string') {
              orientation = 'PORTRAIT';
            }
            orientation = orientation.toUpperCase();

            if (_lodash2['default'].includes(['LANDSCAPE', 'PORTRAIT'], orientation)) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].debug('Unable to set initial orientation to \'' + orientation + '\'');
            return context$2$0.abrupt('return');

          case 5:
            _logger2['default'].debug('Setting initial orientation to \'' + orientation + '\'');
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.proxyCommand('/orientation', 'POST', { orientation: orientation }));

          case 9:
            this.opts.curOrientation = orientation;
            context$2$0.next = 15;
            break;

          case 12:
            context$2$0.prev = 12;
            context$2$0.t0 = context$2$0['catch'](6);

            _logger2['default'].warn('Setting initial orientation failed with: ' + context$2$0.t0);

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 12]]);
    }
  }, {
    key: '_getCommandTimeout',
    value: function _getCommandTimeout(cmdName) {
      this.opts.commandTimeouts = normalizeCommandTimeouts(this.opts.commandTimeouts);
      if (this.opts.commandTimeouts) {
        if (cmdName && _lodash2['default'].has(this.opts.commandTimeouts, cmdName)) {
          return this.opts.commandTimeouts[cmdName];
        }
        return this.opts.commandTimeouts[DEFAULT_TIMEOUT_KEY];
      }
    }

    /**
     * Get session capabilities merged with what WDA reports
     * This is a library command but needs to call 'super' so can't be on
     * a helper object
     */
  }, {
    key: 'getSession',
    value: function getSession() {
      var driverSession, wdaCaps;
      return _regeneratorRuntime.async(function getSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(XCUITestDriver.prototype), 'getSession', this).call(this));

          case 2:
            driverSession = context$2$0.sent;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.proxyCommand('/', 'GET'));

          case 5:
            wdaCaps = context$2$0.sent;

            _logger2['default'].info("Merging WDA caps over Appium caps for session detail response");
            return context$2$0.abrupt('return', _Object$assign({ udid: this.opts.udid }, driverSession, wdaCaps.capabilities));

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startIWDP',
    value: function startIWDP() {
      return _regeneratorRuntime.async(function startIWDP$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.logEvent('iwdpStarting');
            this.iwdpServer = new _appiumIosDriver.IWDP(this.opts.webkitDebugProxyPort, this.opts.udid);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.iwdpServer.start());

          case 4:
            this.logEvent('iwdpStarted');

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stopIWDP',
    value: function stopIWDP() {
      return _regeneratorRuntime.async(function stopIWDP$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.iwdpServer) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.iwdpServer.stop());

          case 3:
            delete this.iwdpServer;

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'reset',
    value: function reset() {
      var opts, shutdownHandler;
      return _regeneratorRuntime.async(function reset$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.opts.noReset) {
              context$2$0.next = 12;
              break;
            }

            opts = _lodash2['default'].cloneDeep(this.opts);

            opts.noReset = false;
            opts.fullReset = false;
            shutdownHandler = this.resetOnUnexpectedShutdown;

            this.resetOnUnexpectedShutdown = function () {};
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.runReset(opts));

          case 9:
            context$2$0.prev = 9;

            this.resetOnUnexpectedShutdown = shutdownHandler;
            return context$2$0.finish(9);

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(XCUITestDriver.prototype), 'reset', this).call(this));

          case 14:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6,, 9, 12]]);
    }
  }, {
    key: 'driverData',
    get: function get() {
      // TODO fill out resource info here
      return {};
    }
  }]);

  return XCUITestDriver;
})(_appiumBaseDriver.BaseDriver);

var _iteratorNormalCompletion2 = true;
var _didIteratorError2 = false;
var _iteratorError2 = undefined;

try {

  for (var _iterator2 = _getIterator(_lodash2['default'].toPairs(_commandsIndex2['default'])), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
    var _step2$value = _slicedToArray(_step2.value, 2);

    var cmd = _step2$value[0];
    var fn = _step2$value[1];

    XCUITestDriver.prototype[cmd] = fn;
  }
} catch (err) {
  _didIteratorError2 = true;
  _iteratorError2 = err;
} finally {
  try {
    if (!_iteratorNormalCompletion2 && _iterator2['return']) {
      _iterator2['return']();
    }
  } finally {
    if (_didIteratorError2) {
      throw _iteratorError2;
    }
  }
}

exports['default'] = XCUITestDriver;
exports.XCUITestDriver = XCUITestDriver;

// TODO add validation on caps
// TODO handle otherSessionData for multiple sessions

// shutdown the simulator so that the ssl cert is recognized

// at this point if there is no platformVersion, get it from the device

// handle logging

// local helper for the two places we need to uninstall wda and re-start it

// This will put the '/status' output into the cache

// reset the permissions on the derived data folder, if necessary

// TODO: once this fix gets into base driver remove from here

// check for supported build-in apps

// download if necessary

// check for a particular real device

// make sure it is a connected device. If not, the udid passed in is invalid

// figure out the correct simulator to use, given the desired capabilities

// check for an existing simulator

// TODO for now just kill all sims unless specified udid is booted.
// if booted, use it. if not booted, start it up
// if no udid, well lets see if we can start one up based on desired caps
// if we support multiple sims we need to change this

// if user has passed in desiredCaps.autoLaunch = false
// meaning they will manage app install / launching

// https://github.com/appium/appium/issues/6889

// call super to get event timings, etc...

// This is to make sure reset happens even if noReset is set to true
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFlLEdBQUcsSUFBSSxDQUFDLHlCQUF5Qjs7QUFDdEQsZ0JBQUksQ0FBQyx5QkFBeUIsR0FBRyxZQUFNLEVBQUUsQ0FBQzs7OzZDQUVsQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQzs7Ozs7QUFFekIsZ0JBQUksQ0FBQyx5QkFBeUIsR0FBRyxlQUFlLENBQUM7Ozs7O3dFQTV3Qm5ELGNBQWM7Ozs7Ozs7S0FneEJqQjs7O1NBN3RCYyxlQUFHOztBQUVoQixhQUFPLEVBQUUsQ0FBQztLQUNYOzs7U0F0REcsY0FBYzs7Ozs7Ozs7O0FBb3hCcEIscUNBQXNCLG9CQUFFLE9BQU8sNEJBQVUsaUhBQUU7OztRQUFqQyxHQUFHO1FBQUUsRUFBRTs7QUFDZixrQkFBYyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7R0FDcEM7Ozs7Ozs7Ozs7Ozs7Ozs7cUJBR2MsY0FBYztRQUNwQixjQUFjLEdBQWQsY0FBYyIsImZpbGUiOiJsaWIvZHJpdmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFzZURyaXZlciB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGxhdW5jaCB9IGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCBXZWJEcml2ZXJBZ2VudCBmcm9tICcuL3dlYmRyaXZlcmFnZW50JztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgc2ltQm9vdGVkLCBjcmVhdGVTaW0sIGdldEV4aXN0aW5nU2ltLCBydW5TaW11bGF0b3JSZXNldCxcbiAgICAgICAgIGluc3RhbGxUb1NpbXVsYXRvciB9IGZyb20gJy4vc2ltdWxhdG9yLW1hbmFnZW1lbnQnO1xuaW1wb3J0IHsga2lsbEFsbFNpbXVsYXRvcnMsIHNpbUV4aXN0cywgZ2V0U2ltdWxhdG9yLCBpbnN0YWxsU1NMQ2VydCxcbiAgICAgICAgIHVuaW5zdGFsbFNTTENlcnQsIEJPT1RfQ09NUExFVEVEX0VWRU5UIH0gZnJvbSAnYXBwaXVtLWlvcy1zaW11bGF0b3InO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IHNldHRpbmdzIGFzIGlvc1NldHRpbmdzLCBkZWZhdWx0U2VydmVyQ2FwcywgYXBwVXRpbHMsIElXRFAgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgZGVzaXJlZENhcENvbnN0cmFpbnRzIGZyb20gJy4vZGVzaXJlZC1jYXBzJztcbmltcG9ydCBjb21tYW5kcyBmcm9tICcuL2NvbW1hbmRzL2luZGV4JztcbmltcG9ydCB7IGRldGVjdFVkaWQsIGdldEFuZENoZWNrWGNvZGVWZXJzaW9uLCBnZXRBbmRDaGVja0lvc1Nka1ZlcnNpb24sXG4gICAgICAgICBhZGp1c3RXREFBdHRhY2htZW50c1Blcm1pc3Npb25zLCBjaGVja0FwcFByZXNlbnQsIGdldERyaXZlckluZm8sXG4gICAgICAgICBjbGVhclN5c3RlbUZpbGVzIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyBnZXRDb25uZWN0ZWREZXZpY2VzLCBydW5SZWFsRGV2aWNlUmVzZXQsIGluc3RhbGxUb1JlYWxEZXZpY2UsXG4gICAgICAgICBnZXRSZWFsRGV2aWNlT2JqIH0gZnJvbSAnLi9yZWFsLWRldmljZS1tYW5hZ2VtZW50JztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHZlcnNpb24gfSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGltcG9ydC9uby11bnJlc29sdmVkXG5cblxuY29uc3QgU0FGQVJJX0JVTkRMRV9JRCA9ICdjb20uYXBwbGUubW9iaWxlc2FmYXJpJztcbmNvbnN0IFdEQV9TVEFSVFVQX1JFVFJJRVMgPSAyO1xuY29uc3QgREVGQVVMVF9USU1FT1VUX0tFWSA9ICdkZWZhdWx0JztcbmNvbnN0IFdEQV9TVEFSVFVQX1JFVFJZX0lOVEVSVkFMID0gMTAwMDA7XG5cbmNvbnN0IE5PX1BST1hZX05BVElWRV9MSVNUID0gW1xuICBbJ0dFVCcsIC9eXFwvc2Vzc2lvblxcL1teXFwvXSskL10sXG4gIFsnR0VUJywgL2NvbnRleHQvXSxcbiAgWydQT1NUJywgL2NvbnRleHQvXSxcbiAgWydHRVQnLCAvd2luZG93L10sXG4gIFsnUE9TVCcsIC93aW5kb3cvXSxcbiAgWydERUxFVEUnLCAvd2luZG93L10sXG4gIFsnUE9TVCcsIC9leGVjdXRlL10sXG4gIFsnUE9TVCcsIC9lbGVtZW50JC9dLFxuICBbJ1BPU1QnLCAvZWxlbWVudHMkL10sXG4gIFsnUE9TVCcsIC90aW1lb3V0cy9dLFxuICBbJ0dFVCcsIC9hbGVydF90ZXh0L10sXG4gIFsnUE9TVCcsIC9hbGVydF90ZXh0L10sXG4gIFsnUE9TVCcsIC9hY2NlcHRfYWxlcnQvXSxcbiAgWydQT1NUJywgL2Rpc21pc3NfYWxlcnQvXSxcbiAgWydHRVQnLCAvc291cmNlL10sXG4gIFsnR0VUJywgL3NjcmVlbnNob3QvXSxcbiAgWydQT1NUJywgL2FwcGl1bS9dLFxuICBbJ0dFVCcsIC9hcHBpdW0vXSxcbiAgWydQT1NUJywgL3RvdWNoL10sXG4gIFsnR0VUJywgL2xvZy9dLFxuICBbJ1BPU1QnLCAvbG9nL10sXG4gIFsnUE9TVCcsIC9tb3ZldG8vXSxcbiAgWydQT1NUJywgL3JlY2VpdmVfYXN5bmNfcmVzcG9uc2UvXSwgLy8gYWx3YXlzLCBpbiBjYXNlIGNvbnRleHQgc3dpdGNoZXMgd2hpbGUgd2FpdGluZ1xuICBbJ0dFVCcsIC9sb2NhdGlvbi9dLFxuICBbJ0dFVCcsIC9zaXplL10sXG4gIFsnUE9TVCcsIC92YWx1ZS9dLFxuICBbJ1BPU1QnLCAva2V5cy9dLFxuICBbJ1BPU1QnLCAvYmFjay9dLFxuICBbJ1BPU1QnLCAvc2Vzc2lvblxcL1teXFwvXStcXC9sb2NhdGlvbi9dLCAvLyBnZW8gbG9jYXRpb24sIGJ1dCBub3QgZWxlbWVudCBsb2NhdGlvblxuICBbJ1BPU1QnLCAvYXBwaXVtXFwvZGV2aWNlXFwvbG9jay9dLFxuICBbJ1BPU1QnLCAvc2hha2UvXSxcbiAgWydQT1NUJywgL2NsZWFyL10sXG5dO1xuY29uc3QgTk9fUFJPWFlfV0VCX0xJU1QgPSBbXG4gIFsnR0VUJywgL3RpdGxlL10sXG4gIFsnR0VUJywgL3VybC9dLFxuICBbJ1BPU1QnLCAvdXJsL10sXG4gIFsnUE9TVCcsIC9lbGVtZW50L10sXG4gIFsnUE9TVCcsIC9mb3J3YXJkL10sXG4gIFsnR0VUJywgL2F0dHJpYnV0ZS9dLFxuICBbJ0dFVCcsIC90ZXh0L10sXG4gIFsnUE9TVCcsIC9jbGVhci9dLFxuICBbJ0dFVCcsIC9lbGVtZW50L10sXG4gIFsnUE9TVCcsIC9jbGljay9dLFxuICBbJ1BPU1QnLCAvcmVmcmVzaC9dLFxuICBbJ0dFVCcsIC9jb29raWUvXSxcbiAgWydQT1NUJywgL2Nvb2tpZS9dLFxuICBbJ0RFTEVURScsIC9jb29raWUvXSxcbiAgWydQT1NUJywgL2ZyYW1lL10sXG4gIFsnUE9TVCcsIC9rZXlzL10sXG5dLmNvbmNhdChOT19QUk9YWV9OQVRJVkVfTElTVCk7XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZUNvbW1hbmRUaW1lb3V0cyAodmFsdWUpIHtcbiAgLy8gVGhlIHZhbHVlIGlzIG5vcm1hbGl6ZWQgYWxyZWFkeVxuICBpZiAodHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJykge1xuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIGxldCByZXN1bHQgPSB7fTtcbiAgLy8gVXNlIGFzIGRlZmF1bHQgdGltZW91dCBmb3IgYWxsIGNvbW1hbmRzIGlmIGEgc2luZ2xlIGludGVnZXIgdmFsdWUgaXMgcHJvdmlkZWRcbiAgaWYgKCFpc05hTih2YWx1ZSkpIHtcbiAgICByZXN1bHRbREVGQVVMVF9USU1FT1VUX0tFWV0gPSBfLnRvSW50ZWdlcih2YWx1ZSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8vIEpTT04gb2JqZWN0IGhhcyBiZWVuIHByb3ZpZGVkLiBMZXQncyBwYXJzZSBpdFxuICB0cnkge1xuICAgIHJlc3VsdCA9IEpTT04ucGFyc2UodmFsdWUpO1xuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KHJlc3VsdCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigpO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFwiY29tbWFuZFRpbWVvdXRzXCIgY2FwYWJpbGl0eSBzaG91bGQgYmUgYSB2YWxpZCBKU09OIG9iamVjdC4gXCIke3ZhbHVlfVwiIHdhcyBnaXZlbiBpbnN0ZWFkYCk7XG4gIH1cbiAgZm9yIChsZXQgW2NtZCwgdGltZW91dF0gb2YgXy50b1BhaXJzKHJlc3VsdCkpIHtcbiAgICBpZiAoIV8uaXNJbnRlZ2VyKHRpbWVvdXQpIHx8IHRpbWVvdXQgPD0gMCkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSB0aW1lb3V0IGZvciBcIiR7Y21kfVwiIHNob3VsZCBiZSBhIHZhbGlkIG5hdHVyYWwgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcy4gXCIke3RpbWVvdXR9XCIgd2FzIGdpdmVuIGluc3RlYWRgKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuXG5jbGFzcyBYQ1VJVGVzdERyaXZlciBleHRlbmRzIEJhc2VEcml2ZXIge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9LCBzaG91bGRWYWxpZGF0ZUNhcHMgPSB0cnVlKSB7XG4gICAgc3VwZXIob3B0cywgc2hvdWxkVmFsaWRhdGVDYXBzKTtcblxuICAgIGxvZy5kZWJ1ZyhgWENVSVRlc3REcml2ZXIgdmVyc2lvbjogJHt2ZXJzaW9ufWApO1xuXG4gICAgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMgPSBkZXNpcmVkQ2FwQ29uc3RyYWludHM7XG5cbiAgICB0aGlzLmxvY2F0b3JTdHJhdGVnaWVzID0gW1xuICAgICAgJ3hwYXRoJyxcbiAgICAgICdpZCcsXG4gICAgICAnbmFtZScsXG4gICAgICAnY2xhc3MgbmFtZScsXG4gICAgICAnLWlvcyBwcmVkaWNhdGUgc3RyaW5nJyxcbiAgICAgICctaW9zIGNsYXNzIGNoYWluJyxcbiAgICAgICdhY2Nlc3NpYmlsaXR5IGlkJ1xuICAgIF07XG4gICAgdGhpcy53ZWJMb2NhdG9yU3RyYXRlZ2llcyA9IFtcbiAgICAgICdsaW5rIHRleHQnLFxuICAgICAgJ2NzcyBzZWxlY3RvcicsXG4gICAgICAndGFnIG5hbWUnLFxuICAgICAgJ2xpbmsgdGV4dCcsXG4gICAgICAncGFydGlhbCBsaW5rIHRleHQnXG4gICAgXTtcblxuICAgIHRoaXMucmVzZXRJb3MoKTtcbiAgfVxuXG4gIHJlc2V0SW9zICgpIHtcbiAgICB0aGlzLm9wdHMgPSB0aGlzLm9wdHMgfHwge307XG4gICAgdGhpcy53ZGEgPSBudWxsO1xuICAgIHRoaXMub3B0cy5kZXZpY2UgPSBudWxsO1xuICAgIHRoaXMuandwUHJveHlBY3RpdmUgPSBmYWxzZTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gbnVsbDtcbiAgICB0aGlzLmp3cFByb3h5QXZvaWQgPSBbXTtcbiAgICB0aGlzLnNhZmFyaSA9IGZhbHNlO1xuICAgIHRoaXMuY2FjaGVkV2RhU3RhdHVzID0gbnVsbDtcblxuICAgIC8vIHNvbWUgdGhpbmdzIHRoYXQgY29tbWFuZHMgaW1wb3J0ZWQgZnJvbSBhcHBpdW0taW9zLWRyaXZlciBuZWVkXG4gICAgdGhpcy5jdXJXZWJGcmFtZXMgPSBbXTtcbiAgICB0aGlzLndlYkVsZW1lbnRJZHMgPSBbXTtcbiAgICB0aGlzLl9jdXJyZW50VXJsID0gbnVsbDtcbiAgICB0aGlzLmN1ckNvbnRleHQgPSBudWxsO1xuICAgIHRoaXMueGNvZGVWZXJzaW9uID0gbnVsbDtcbiAgICB0aGlzLmlvc1Nka1ZlcnNpb24gPSBudWxsO1xuICAgIHRoaXMuY29udGV4dHMgPSBbXTtcbiAgICB0aGlzLmltcGxpY2l0V2FpdE1zID0gMDtcbiAgICB0aGlzLmFzeW5jbGliV2FpdE1zID0gMDtcbiAgICB0aGlzLnBhZ2VMb2FkTXMgPSA2MDAwO1xuICB9XG5cbiAgZ2V0IGRyaXZlckRhdGEgKCkge1xuICAgIC8vIFRPRE8gZmlsbCBvdXQgcmVzb3VyY2UgaW5mbyBoZXJlXG4gICAgcmV0dXJuIHt9O1xuICB9XG5cbiAgYXN5bmMgZ2V0U3RhdHVzICgpIHtcbiAgICBpZiAodHlwZW9mIHRoaXMuZHJpdmVySW5mbyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRoaXMuZHJpdmVySW5mbyA9IGF3YWl0IGdldERyaXZlckluZm8oKTtcbiAgICB9XG4gICAgbGV0IHN0YXR1cyA9IHtidWlsZDoge3ZlcnNpb246IHRoaXMuZHJpdmVySW5mby52ZXJzaW9ufX07XG4gICAgaWYgKHRoaXMuY2FjaGVkV2RhU3RhdHVzKSB7XG4gICAgICBzdGF0dXMud2RhID0gdGhpcy5jYWNoZWRXZGFTdGF0dXM7XG4gICAgfVxuICAgIHJldHVybiBzdGF0dXM7XG4gIH1cblxuICBhc3luYyBjcmVhdGVTZXNzaW9uIChjYXBzKSB7XG4gICAgdGhpcy5saWZlY3ljbGVEYXRhID0ge307IC8vIHRoaXMgaXMgdXNlZCBmb3Iga2VlcGluZyB0cmFjayBvZiB0aGUgc3RhdGUgd2Ugc3RhcnQgc28gd2hlbiB3ZSBkZWxldGUgdGhlIHNlc3Npb24gd2UgY2FuIHB1dCB0aGluZ3MgYmFja1xuICAgIHRyeSB7XG4gICAgICAvLyBUT0RPIGFkZCB2YWxpZGF0aW9uIG9uIGNhcHNcbiAgICAgIC8vIFRPRE8gaGFuZGxlIG90aGVyU2Vzc2lvbkRhdGEgZm9yIG11bHRpcGxlIHNlc3Npb25zXG4gICAgICBsZXQgW3Nlc3Npb25JZF0gPSBhd2FpdCBzdXBlci5jcmVhdGVTZXNzaW9uKGNhcHMpO1xuICAgICAgdGhpcy5vcHRzLnNlc3Npb25JZCA9IHNlc3Npb25JZDtcblxuICAgICAgYXdhaXQgdGhpcy5zdGFydCgpO1xuXG4gICAgICAvLyBtZXJnZSBzZXJ2ZXIgY2FwYWJpbGl0aWVzICsgZGVzaXJlZCBjYXBhYmlsaXRpZXNcbiAgICAgIGNhcHMgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0U2VydmVyQ2FwcywgY2Fwcyk7XG4gICAgICAvLyB1cGRhdGUgdGhlIHVkaWQgd2l0aCB3aGF0IGlzIGFjdHVhbGx5IHVzZWRcbiAgICAgIGNhcHMudWRpZCA9IHRoaXMub3B0cy51ZGlkO1xuICAgICAgcmV0dXJuIFtzZXNzaW9uSWQsIGNhcHNdO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy5lcnJvcihlKTtcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzdGFydCAoKSB7XG4gICAgdGhpcy5vcHRzLm5vUmVzZXQgPSAhIXRoaXMub3B0cy5ub1Jlc2V0O1xuICAgIHRoaXMub3B0cy5mdWxsUmVzZXQgPSAhIXRoaXMub3B0cy5mdWxsUmVzZXQ7XG5cbiAgICBpZiAoIXRoaXMueGNvZGVWZXJzaW9uKSB7XG4gICAgICB0aGlzLnhjb2RlVmVyc2lvbiA9IGF3YWl0IGdldEFuZENoZWNrWGNvZGVWZXJzaW9uKCk7XG4gICAgICBsZXQgdG9vbHMgPSAhdGhpcy54Y29kZVZlcnNpb24udG9vbHNWZXJzaW9uID8gJycgOiBgKHRvb2xzIHYke3RoaXMueGNvZGVWZXJzaW9uLnRvb2xzVmVyc2lvbn0pYDtcbiAgICAgIGxvZy5kZWJ1ZyhgWGNvZGUgdmVyc2lvbiBzZXQgdG8gJyR7dGhpcy54Y29kZVZlcnNpb24udmVyc2lvblN0cmluZ30nICR7dG9vbHN9YCk7XG4gICAgfVxuXG4gICAgdGhpcy5pb3NTZGtWZXJzaW9uID0gYXdhaXQgZ2V0QW5kQ2hlY2tJb3NTZGtWZXJzaW9uKCk7XG4gICAgbG9nLmRlYnVnKGBpT1MgU0RLIFZlcnNpb24gc2V0IHRvICcke3RoaXMuaW9zU2RrVmVyc2lvbn0nYCk7XG5cbiAgICBpZiAodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiAmJiBwYXJzZUZsb2F0KHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24pIDwgOS4zKSB7XG4gICAgICB0aHJvdyBFcnJvcihgUGxhdGZvcm0gdmVyc2lvbiBtdXN0IGJlIDkuMyBvciBhYm92ZS4gJyR7dGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbn0nIGlzIG5vdCBzdXBwb3J0ZWQuYCk7XG4gICAgfVxuXG4gICAgdGhpcy5sb2dFdmVudCgneGNvZGVEZXRhaWxzUmV0cmlldmVkJyk7XG5cbiAgICBsZXQge2RldmljZSwgdWRpZCwgcmVhbERldmljZX0gPSBhd2FpdCB0aGlzLmRldGVybWluZURldmljZSgpO1xuICAgIGxvZy5pbmZvKGBEZXRlcm1pbmluZyBkZXZpY2UgdG8gcnVuIHRlc3RzIG9uOiB1ZGlkOiAnJHt1ZGlkfScsIHJlYWwgZGV2aWNlOiAke3JlYWxEZXZpY2V9YCk7XG4gICAgdGhpcy5vcHRzLmRldmljZSA9IGRldmljZTtcbiAgICB0aGlzLm9wdHMudWRpZCA9IHVkaWQ7XG4gICAgdGhpcy5vcHRzLnJlYWxEZXZpY2UgPSByZWFsRGV2aWNlO1xuXG4gICAgaWYgKHRoaXMuaXNTaW11bGF0b3IoKSAmJiB0aGlzLm9wdHMuY3VzdG9tU1NMQ2VydCkge1xuICAgICAgYXdhaXQgaW5zdGFsbFNTTENlcnQodGhpcy5vcHRzLmN1c3RvbVNTTENlcnQsIHRoaXMub3B0cy51ZGlkKTtcbiAgICAgIHRoaXMubG9nRXZlbnQoJ2N1c3RvbUNlcnRJbnN0YWxsZWQnKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcHRzLmVuYWJsZUFzeW5jRXhlY3V0ZUZyb21IdHRwcyAmJiAhdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgICAgLy8gc2h1dGRvd24gdGhlIHNpbXVsYXRvciBzbyB0aGF0IHRoZSBzc2wgY2VydCBpcyByZWNvZ25pemVkXG4gICAgICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLnNodXRkb3duKCk7XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0SHR0cHNBc3luY1NlcnZlcigpO1xuICAgIH1cblxuXG4gICAgLy8gYXQgdGhpcyBwb2ludCBpZiB0aGVyZSBpcyBubyBwbGF0Zm9ybVZlcnNpb24sIGdldCBpdCBmcm9tIHRoZSBkZXZpY2VcbiAgICBpZiAoIXRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24pIHtcbiAgICAgIGlmICh0aGlzLm9wdHMuZGV2aWNlICYmIF8uaXNGdW5jdGlvbih0aGlzLm9wdHMuZGV2aWNlLmdldFBsYXRmb3JtVmVyc2lvbikpIHtcbiAgICAgICAgdGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiA9IGF3YWl0IHRoaXMub3B0cy5kZXZpY2UuZ2V0UGxhdGZvcm1WZXJzaW9uKCk7XG4gICAgICAgIGxvZy5pbmZvKGBObyBwbGF0Zm9ybVZlcnNpb24gc3BlY2lmaWVkLiBVc2luZyBkZXZpY2UgdmVyc2lvbjogJyR7dGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbn0nYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBUT0RPOiB0aGlzIGlzIHdoZW4gaXQgaXMgYSByZWFsIGRldmljZS4gd2hlbiB3ZSBoYXZlIGEgcmVhbCBvYmplY3Qgd2lyZSBpdCBpblxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSB4Y29kZSB3ZSBhcmUgdXNpbmcgY2FuIGhhbmRsZSB0aGUgcGxhdGZvcm1cbiAgICBpZiAocGFyc2VGbG9hdCh0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uKSA+IHBhcnNlRmxvYXQodGhpcy5pb3NTZGtWZXJzaW9uKSkge1xuICAgICAgbGV0IG1zZyA9IGBYY29kZSAke3RoaXMueGNvZGVWZXJzaW9uLnZlcnNpb25TdHJpbmd9IGhhcyBhIG1heGltdW0gU0RLIHZlcnNpb24gb2YgJHt0aGlzLmlvc1Nka1ZlcnNpb259LiBgICtcbiAgICAgICAgICAgICAgICBgSXQgZG9lcyBub3Qgc3VwcG9ydCBpT1MgdmVyc2lvbiAke3RoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb259YDtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgfVxuXG4gICAgaWYgKCh0aGlzLm9wdHMuYnJvd3Nlck5hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCkgPT09ICdzYWZhcmknKSB7XG4gICAgICBsb2cuaW5mbygnU2FmYXJpIHRlc3QgcmVxdWVzdGVkJyk7XG4gICAgICB0aGlzLnNhZmFyaSA9IHRydWU7XG4gICAgICB0aGlzLm9wdHMuYXBwID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5vcHRzLnByb2Nlc3NBcmd1bWVudHMgPSB0aGlzLm9wdHMucHJvY2Vzc0FyZ3VtZW50cyB8fCB7fTtcbiAgICAgIHRoaXMub3B0cy5idW5kbGVJZCA9IFNBRkFSSV9CVU5ETEVfSUQ7XG4gICAgICB0aGlzLl9jdXJyZW50VXJsID0gdGhpcy5vcHRzLnNhZmFyaUluaXRpYWxVcmwgfHwgKFxuICAgICAgICB0aGlzLmlzUmVhbERldmljZSgpID9cbiAgICAgICAgJ2h0dHA6Ly9hcHBpdW0uaW8nIDpcbiAgICAgICAgYGh0dHA6Ly8ke3RoaXMub3B0cy5hZGRyZXNzfToke3RoaXMub3B0cy5wb3J0fS93ZWxjb21lYFxuICAgICAgKTtcbiAgICAgIHRoaXMub3B0cy5wcm9jZXNzQXJndW1lbnRzLmFyZ3MgPSBbJy11JywgdGhpcy5fY3VycmVudFVybF07XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMuY29uZmlndXJlQXBwKCk7XG4gICAgfVxuICAgIHRoaXMubG9nRXZlbnQoJ2FwcENvbmZpZ3VyZWQnKTtcblxuICAgIC8vIGZhaWwgdmVyeSBlYXJseSBpZiB0aGUgYXBwIGRvZXNuJ3QgYWN0dWFsbHkgZXhpc3RcbiAgICAvLyBvciBpZiBidW5kbGUgaWQgZG9lc24ndCBwb2ludCB0byBhbiBpbnN0YWxsZWQgYXBwXG4gICAgaWYgKHRoaXMub3B0cy5hcHApIHtcbiAgICAgIGF3YWl0IGNoZWNrQXBwUHJlc2VudCh0aGlzLm9wdHMuYXBwKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMub3B0cy5idW5kbGVJZCAmJiAhdGhpcy5zYWZhcmkpIHtcbiAgICAgIGlmICghYXdhaXQgdGhpcy5vcHRzLmRldmljZS5pc0FwcEluc3RhbGxlZCh0aGlzLm9wdHMuYnVuZGxlSWQpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBBcHAgd2l0aCBidW5kbGUgaWRlbnRpZmllciAnJHt0aGlzLm9wdHMuYnVuZGxlSWR9JyB1bmtub3duYCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLm9wdHMuYnVuZGxlSWQpIHtcbiAgICAgIHRoaXMub3B0cy5idW5kbGVJZCA9IGF3YWl0IHRoaXMuZXh0cmFjdEJ1bmRsZUlkKHRoaXMub3B0cy5hcHApO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5vcHRzLnJlYWxEZXZpY2UpIHtcbiAgICAgIGlmICh0eXBlb2YgdGhpcy5vcHRzLnNjYWxlRmFjdG9yICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICBsb2cuaW5mbyhgU2V0dGluZyBub24tZGVmYXVsdCBTaW11bGF0b3Igc2NhbGUgZmFjdG9yIHRvICcke3RoaXMub3B0cy5zY2FsZUZhY3Rvcn0nYCk7XG4gICAgICAgIGRldmljZS5zZXRTY2FsZUZhY3Rvcih0aGlzLm9wdHMuc2NhbGVGYWN0b3IpO1xuICAgICAgfVxuICAgICAgaWYgKHR5cGVvZiB0aGlzLm9wdHMuY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIGxvZy5pbmZvKGBTZXR0aW5nICdjb25uZWN0SGFyZHdhcmVLZXlib2FyZCcgU2ltdWxhdG9yIG9wdGlvbiB0byAnJHt0aGlzLm9wdHMuY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQgPyAnb24nIDogJ29mZid9J2ApO1xuICAgICAgICBkZXZpY2Uuc2V0Q29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQodGhpcy5vcHRzLmNvbm5lY3RIYXJkd2FyZUtleWJvYXJkKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnJ1blJlc2V0KCk7XG5cbiAgICAvLyBoYW5kbGUgbG9nZ2luZ1xuICAgIGF3YWl0IHRoaXMuc3RhcnRMb2dDYXB0dXJlKCk7XG4gICAgdGhpcy5sb2dFdmVudCgnbG9nQ2FwdHVyZVN0YXJ0ZWQnKTtcblxuICAgIGxvZy5pbmZvKGBTZXR0aW5nIHVwICR7dGhpcy5pc1JlYWxEZXZpY2UoKSA/ICdyZWFsIGRldmljZScgOiAnc2ltdWxhdG9yJ31gKTtcblxuICAgIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICBpZiAodGhpcy5vcHRzLmFwcCkge1xuICAgICAgICBhd2FpdCB0aGlzLmluc3RhbGxBcHAoKTtcbiAgICAgICAgdGhpcy5sb2dFdmVudCgnYXBwSW5zdGFsbGVkJyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubG9jYWxlQ29uZmlnID0gYXdhaXQgaW9zU2V0dGluZ3Muc2V0TG9jYWxlKHRoaXMub3B0cy5kZXZpY2UsIHRoaXMub3B0cywge30sIHRoaXMuaXNTYWZhcmkoKSk7XG4gICAgICBhd2FpdCBpb3NTZXR0aW5ncy5zZXRQcmVmZXJlbmNlcyh0aGlzLm9wdHMuZGV2aWNlLCB0aGlzLm9wdHMsIHRoaXMuaXNTYWZhcmkoKSk7XG4gICAgICBsZXQgaW5zdGFsbEFwcFByb21pc2UgPSBudWxsO1xuICAgICAgaWYgKHRoaXMub3B0cy5hcHApIHtcbiAgICAgICAgaWYgKGF3YWl0IHNpbUJvb3RlZCh0aGlzLm9wdHMuZGV2aWNlKSkge1xuICAgICAgICAgIGluc3RhbGxBcHBQcm9taXNlID0gdGhpcy5pbnN0YWxsQXBwKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaW5zdGFsbEFwcFByb21pc2UgPSBuZXcgQihhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLm9wdHMuZGV2aWNlLm9uKEJPT1RfQ09NUExFVEVEX0VWRU5ULCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5pbnN0YWxsQXBwKCk7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGF3YWl0IHRoaXMuc3RhcnRTaW0oKTtcbiAgICAgIHRoaXMubG9nRXZlbnQoJ3NpbVN0YXJ0ZWQnKTtcbiAgICAgIGF3YWl0IGluc3RhbGxBcHBQcm9taXNlO1xuICAgICAgdGhpcy5sb2dFdmVudCgnYXBwSW5zdGFsbGVkJyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5zdGFydFdkYSh0aGlzLm9wdHMuc2Vzc2lvbklkLCByZWFsRGV2aWNlKTtcblxuICAgIGF3YWl0IHRoaXMuc2V0SW5pdGlhbE9yaWVudGF0aW9uKHRoaXMub3B0cy5vcmllbnRhdGlvbik7XG4gICAgdGhpcy5sb2dFdmVudCgnb3JpZW50YXRpb25TZXQnKTtcblxuXG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkgJiYgdGhpcy5vcHRzLnN0YXJ0SVdEUCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5zdGFydElXRFAoKTtcbiAgICAgICAgbG9nLmRlYnVnKGBTdGFydGVkIGlvc193ZWJraXRfZGVidWcgcHJveHkgc2VydmVyIGF0OiAke3RoaXMuaXdkcFNlcnZlci5lbmRwb2ludH1gKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ291bGQgbm90IHN0YXJ0IGlvc193ZWJraXRfZGVidWdfcHJveHkgc2VydmVyOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLmlzU2FmYXJpKCkgfHwgdGhpcy5vcHRzLmF1dG9XZWJ2aWV3KSB7XG4gICAgICBsb2cuZGVidWcoJ1dhaXRpbmcgZm9yIGluaXRpYWwgd2VidmlldycpO1xuICAgICAgYXdhaXQgdGhpcy5uYXZUb0luaXRpYWxXZWJ2aWV3KCk7XG4gICAgICB0aGlzLmxvZ0V2ZW50KCdpbml0aWFsV2Vidmlld05hdmlnYXRlZCcpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgICAgaWYgKHRoaXMub3B0cy5jYWxlbmRhckFjY2Vzc0F1dGhvcml6ZWQpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5vcHRzLmRldmljZS5lbmFibGVDYWxlbmRhckFjY2Vzcyh0aGlzLm9wdHMuYnVuZGxlSWQpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLm9wdHMuY2FsZW5kYXJBY2Nlc3NBdXRob3JpemVkID09PSBmYWxzZSkge1xuICAgICAgICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLmRpc2FibGVDYWxlbmRhckFjY2Vzcyh0aGlzLm9wdHMuYnVuZGxlSWQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0YXJ0V2RhIChzZXNzaW9uSWQsIHJlYWxEZXZpY2UpIHtcbiAgICBsZXQgc3RhcnR1cFJldHJpZXMgPSB0aGlzLm9wdHMud2RhU3RhcnR1cFJldHJpZXMgfHwgV0RBX1NUQVJUVVBfUkVUUklFUztcbiAgICBsZXQgc3RhcnR1cFJldHJ5SW50ZXJ2YWwgPSB0aGlzLm9wdHMud2RhU3RhcnR1cFJldHJ5SW50ZXJ2YWwgfHwgV0RBX1NUQVJUVVBfUkVUUllfSU5URVJWQUw7XG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbChzdGFydHVwUmV0cmllcywgc3RhcnR1cFJldHJ5SW50ZXJ2YWwsIGFzeW5jICgpID0+IHtcbiAgICAgIHRoaXMubG9nRXZlbnQoJ3dkYVN0YXJ0QXR0ZW1wdGVkJyk7XG4gICAgICB0aGlzLndkYSA9IG5ldyBXZWJEcml2ZXJBZ2VudCh0aGlzLnhjb2RlVmVyc2lvbiwgdGhpcy5vcHRzKTtcblxuICAgICAgaWYgKHRoaXMub3B0cy51c2VOZXdXREEpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBDYXBhYmlsaXR5ICd1c2VOZXdXREEnIHNldCwgc28gdW5pbnN0YWxsaW5nIFdEQSBiZWZvcmUgcHJvY2VlZGluZ2ApO1xuICAgICAgICBhd2FpdCB0aGlzLndkYS51bmluc3RhbGwoKTtcbiAgICAgICAgdGhpcy5sb2dFdmVudCgnd2RhVW5pbnN0YWxsZWQnKTtcbiAgICAgIH1cblxuICAgICAgLy8gbG9jYWwgaGVscGVyIGZvciB0aGUgdHdvIHBsYWNlcyB3ZSBuZWVkIHRvIHVuaW5zdGFsbCB3ZGEgYW5kIHJlLXN0YXJ0IGl0XG4gICAgICBsZXQgcXVpdEFuZFVuaW5zdGFsbCA9IGFzeW5jIChtc2cpID0+IHtcbiAgICAgICAgbG9nLmRlYnVnKG1zZyk7XG4gICAgICAgIGxvZy5kZWJ1ZygnUXVpdHRpbmcgYW5kIHVuaW5zdGFsbGluZyBXZWJEcml2ZXJBZ2VudCwgdGhlbiByZXRyeWluZycpO1xuICAgICAgICBhd2FpdCB0aGlzLndkYS5xdWl0KCk7XG4gICAgICAgIGF3YWl0IHRoaXMud2RhLnVuaW5zdGFsbCgpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTtcbiAgICAgIH07XG5cbiAgICAgIGxldCB3ZGFTdGF0dXMgPSBudWxsO1xuICAgICAgdHJ5IHtcbiAgICAgICAgd2RhU3RhdHVzID0gYXdhaXQgdGhpcy53ZGEubGF1bmNoKHNlc3Npb25JZCwgcmVhbERldmljZSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhpcy5sb2dFdmVudCgnd2RhU3RhcnRGYWlsZWQnKTtcbiAgICAgICAgYXdhaXQgcXVpdEFuZFVuaW5zdGFsbChgVW5hYmxlIHRvIGxhdW5jaCBXZWJEcml2ZXJBZ2VudCBiZWNhdXNlIG9mIHhjb2RlYnVpbGQgZmFpbHVyZTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMud2RhLnByb3h5UmVxUmVzLmJpbmQodGhpcy53ZGEpO1xuICAgICAgdGhpcy5qd3BQcm94eUFjdGl2ZSA9IHRydWU7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMTUsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICB0aGlzLmxvZ0V2ZW50KCd3ZGFTZXNzaW9uQXR0ZW1wdGVkJyk7XG4gICAgICAgICAgbG9nLmRlYnVnKCdTZW5kaW5nIGNyZWF0ZVNlc3Npb24gY29tbWFuZCB0byBXREEnKTtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKHdkYVN0YXR1cykge1xuICAgICAgICAgICAgICB0aGlzLmNhY2hlZFdkYVN0YXR1cyA9IHdkYVN0YXR1cztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIC8vIFRoaXMgd2lsbCBwdXQgdGhlICcvc3RhdHVzJyBvdXRwdXQgaW50byB0aGUgY2FjaGVcbiAgICAgICAgICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0V2RhU2Vzc2lvbih0aGlzLm9wdHMuYnVuZGxlSWQsIHRoaXMub3B0cy5wcm9jZXNzQXJndW1lbnRzKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnRmFpbGVkIHRvIGNyZWF0ZSBXREEgc2Vzc2lvbi4gUmV0cnlpbmcuLi4nKTtcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmxvZ0V2ZW50KCd3ZGFTZXNzaW9uU3RhcnRlZCcpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBxdWl0QW5kVW5pbnN0YWxsKGBVbmFibGUgdG8gc3RhcnQgV2ViRHJpdmVyQWdlbnQgc2Vzc2lvbjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5vcHRzLnByZXZlbnRXREFBdHRhY2htZW50cyA9ICF1dGlsLmhhc1ZhbHVlKHRoaXMub3B0cy5wcmV2ZW50V0RBQXR0YWNobWVudHMpIHx8IHRoaXMub3B0cy5wcmV2ZW50V0RBQXR0YWNobWVudHM7XG4gICAgICBhd2FpdCBhZGp1c3RXREFBdHRhY2htZW50c1Blcm1pc3Npb25zKHRoaXMub3B0cy5wcmV2ZW50V0RBQXR0YWNobWVudHMgPyAnNTU1JyA6ICc3NTUnKTtcbiAgICAgIHRoaXMubG9nRXZlbnQoJ3dkYVBlcm1zQWRqdXN0ZWQnKTtcblxuICAgICAgLy8gd2UgZXhwZWN0IGNlcnRhaW4gc29ja2V0IGVycm9ycyB1bnRpbCB0aGlzIHBvaW50LCBidXQgbm93XG4gICAgICAvLyBtYXJrIHRoaW5ncyBhcyBmdWxseSB3b3JraW5nXG4gICAgICB0aGlzLndkYS5mdWxseVN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgdGhpcy5sb2dFdmVudCgnd2RhU3RhcnRlZCcpO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gY3JlYXRlIGFuIGFsaWFzIHNvIHdlIGNhbiBhY3R1YWxseSB1bml0IHRlc3QgY3JlYXRlU2Vzc2lvbiBieSBzdHViYmluZ1xuICAvLyB0aGlzXG4gIGFzeW5jIGV4dHJhY3RCdW5kbGVJZCAoYXBwKSB7XG4gICAgcmV0dXJuIGF3YWl0IGFwcFV0aWxzLmV4dHJhY3RCdW5kbGVJZChhcHApO1xuICB9XG5cbiAgYXN5bmMgcnVuUmVzZXQgKG9wdHMgPSBudWxsKSB7XG4gICAgdGhpcy5sb2dFdmVudCgncmVzZXRTdGFydGVkJyk7XG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIGF3YWl0IHJ1blJlYWxEZXZpY2VSZXNldCh0aGlzLm9wdHMuZGV2aWNlLCBvcHRzIHx8IHRoaXMub3B0cyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHJ1blNpbXVsYXRvclJlc2V0KHRoaXMub3B0cy5kZXZpY2UsIG9wdHMgfHwgdGhpcy5vcHRzKTtcbiAgICB9XG4gICAgdGhpcy5sb2dFdmVudCgncmVzZXRDb21wbGV0ZScpO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgYXdhaXQgdGhpcy5zdG9wKCk7XG5cbiAgICAvLyByZXNldCB0aGUgcGVybWlzc2lvbnMgb24gdGhlIGRlcml2ZWQgZGF0YSBmb2xkZXIsIGlmIG5lY2Vzc2FyeVxuICAgIGlmICh0aGlzLm9wdHMucHJldmVudFdEQUF0dGFjaG1lbnRzKSB7XG4gICAgICBhd2FpdCBhZGp1c3RXREFBdHRhY2htZW50c1Blcm1pc3Npb25zKCc3NTUnKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcHRzLmNsZWFyU3lzdGVtRmlsZXMpIHtcbiAgICAgIGF3YWl0IGNsZWFyU3lzdGVtRmlsZXModGhpcy53ZGEsICEhdGhpcy5vcHRzLnNob3dYY29kZUxvZyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZygnTm90IGNsZWFyaW5nIGxvZyBmaWxlcy4gVXNlIGBjbGVhclN5c3RlbUZpbGVzYCBjYXBhYmlsaXR5IHRvIHR1cm4gb24uJyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnSW4gYSB3ZWIgc2Vzc2lvbi4gUmVtb3ZpbmcgcmVtb3RlIGRlYnVnZ2VyJyk7XG4gICAgICBhd2FpdCB0aGlzLnN0b3BSZW1vdGUoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcHRzLnJlc2V0T25TZXNzaW9uU3RhcnRPbmx5ID09PSBmYWxzZSkge1xuICAgICAgYXdhaXQgdGhpcy5ydW5SZXNldCgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzU2ltdWxhdG9yKCkgJiYgdGhpcy5vcHRzLnVkaWQgJiYgdGhpcy5vcHRzLmN1c3RvbVNTTENlcnQpIHtcbiAgICAgIGF3YWl0IHVuaW5zdGFsbFNTTENlcnQodGhpcy5vcHRzLmN1c3RvbVNTTENlcnQsIHRoaXMub3B0cy51ZGlkKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc1NpbXVsYXRvcigpICYmICF0aGlzLm9wdHMubm9SZXNldCAmJiAhIXRoaXMub3B0cy5kZXZpY2UpIHtcbiAgICAgIGlmICh0aGlzLmxpZmVjeWNsZURhdGEuY3JlYXRlU2ltKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnRGVsZXRpbmcgc2ltdWxhdG9yIGNyZWF0ZWQgZm9yIHRoaXMgcnVuJyk7XG4gICAgICAgIGF3YWl0IHRoaXMub3B0cy5kZXZpY2Uuc2h1dGRvd24oKTtcbiAgICAgICAgYXdhaXQgdGhpcy5vcHRzLmRldmljZS5kZWxldGUoKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmxvZ3MpKSB7XG4gICAgICB0aGlzLmxvZ3Muc3lzbG9nLnN0b3BDYXB0dXJlKCk7XG4gICAgICB0aGlzLmxvZ3MgPSB7fTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pd2RwU2VydmVyKSB7XG4gICAgICB0aGlzLnN0b3BJV0RQKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0cy5lbmFibGVBc3luY0V4ZWN1dGVGcm9tSHR0cHMgJiYgIXRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIGF3YWl0IHRoaXMuc3RvcEh0dHBzQXN5bmNTZXJ2ZXIoKTtcbiAgICB9XG5cbiAgICB0aGlzLnJlc2V0SW9zKCk7XG5cbiAgICBhd2FpdCBzdXBlci5kZWxldGVTZXNzaW9uKCk7XG4gIH1cblxuICBhc3luYyBzdG9wICgpIHtcbiAgICB0aGlzLmp3cFByb3h5QWN0aXZlID0gZmFsc2U7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IG51bGw7XG5cbiAgICBpZiAodGhpcy53ZGEgJiYgdGhpcy53ZGEuZnVsbHlTdGFydGVkKSB7XG4gICAgICBpZiAodGhpcy53ZGEuandwcm94eSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvc2Vzc2lvbi8ke3RoaXMuc2Vzc2lvbklkfWAsICdERUxFVEUnKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgLy8gYW4gZXJyb3IgaGVyZSBzaG91bGQgbm90IHNob3J0LWNpcmN1aXQgdGhlIHJlc3Qgb2YgY2xlYW4gdXBcbiAgICAgICAgICBsb2cuZGVidWcoYFVuYWJsZSB0byBERUxFVEUgc2Vzc2lvbiBvbiBXREE6ICcke2Vyci5tZXNzYWdlfScuIENvbnRpbnVpbmcgc2h1dGRvd24uYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGF3YWl0IHRoaXMud2RhLnF1aXQoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBleGVjdXRlQ29tbWFuZCAoY21kLCAuLi5hcmdzKSB7XG4gICAgbG9nLmRlYnVnKGBFeGVjdXRpbmcgY29tbWFuZCAnJHtjbWR9J2ApO1xuXG4gICAgaWYgKGNtZCA9PT0gJ3JlY2VpdmVBc3luY1Jlc3BvbnNlJykge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucmVjZWl2ZUFzeW5jUmVzcG9uc2UoLi4uYXJncyk7XG4gICAgfVxuICAgIC8vIFRPRE86IG9uY2UgdGhpcyBmaXggZ2V0cyBpbnRvIGJhc2UgZHJpdmVyIHJlbW92ZSBmcm9tIGhlcmVcbiAgICBpZiAoY21kID09PSAnZ2V0U3RhdHVzJykge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0U3RhdHVzKCk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCBzdXBlci5leGVjdXRlQ29tbWFuZChjbWQsIC4uLmFyZ3MpO1xuICB9XG5cbiAgYXN5bmMgY29uZmlndXJlQXBwICgpIHtcbiAgICBmdW5jdGlvbiBhcHBJc1BhY2thZ2VPckJ1bmRsZSAoYXBwKSB7XG4gICAgICByZXR1cm4gKC9eKFthLXpBLVowLTlcXC1fXStcXC5bYS16QS1aMC05XFwtX10rKSskLykudGVzdChhcHApO1xuICAgIH1cblxuICAgIC8vIHRoZSBhcHAgbmFtZSBpcyBhIGJ1bmRsZUlkIGFzc2lnbiBpdCB0byB0aGUgYnVuZGxlSWQgcHJvcGVydHlcbiAgICBpZiAoIXRoaXMub3B0cy5idW5kbGVJZCAmJiBhcHBJc1BhY2thZ2VPckJ1bmRsZSh0aGlzLm9wdHMuYXBwKSkge1xuICAgICAgdGhpcy5vcHRzLmJ1bmRsZUlkID0gdGhpcy5vcHRzLmFwcDtcbiAgICAgIHRoaXMub3B0cy5hcHAgPSAnJztcbiAgICB9XG4gICAgLy8gd2UgaGF2ZSBhIGJ1bmRsZSBJRCwgYnV0IG5vIGFwcCwgb3IgYXBwIGlzIGFsc28gYSBidW5kbGVcbiAgICBpZiAoKHRoaXMub3B0cy5idW5kbGVJZCAmJiBhcHBJc1BhY2thZ2VPckJ1bmRsZSh0aGlzLm9wdHMuYnVuZGxlSWQpKSAmJlxuICAgICAgICAodGhpcy5vcHRzLmFwcCA9PT0gJycgfHwgYXBwSXNQYWNrYWdlT3JCdW5kbGUodGhpcy5vcHRzLmFwcCkpKSB7XG4gICAgICBsb2cuZGVidWcoJ0FwcCBpcyBhbiBpT1MgYnVuZGxlLCB3aWxsIGF0dGVtcHQgdG8gcnVuIGFzIHByZS1leGlzdGluZycpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGNoZWNrIGZvciBzdXBwb3J0ZWQgYnVpbGQtaW4gYXBwc1xuICAgIGlmICh0aGlzLm9wdHMuYXBwICYmIHRoaXMub3B0cy5hcHAudG9Mb3dlckNhc2UoKSA9PT0gJ3NldHRpbmdzJykge1xuICAgICAgdGhpcy5vcHRzLmJ1bmRsZUlkID0gJ2NvbS5hcHBsZS5QcmVmZXJlbmNlcyc7XG4gICAgICB0aGlzLm9wdHMuYXBwID0gbnVsbDtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKHRoaXMub3B0cy5hcHAgJiYgdGhpcy5vcHRzLmFwcC50b0xvd2VyQ2FzZSgpID09PSAnY2FsZW5kYXInKSB7XG4gICAgICB0aGlzLm9wdHMuYnVuZGxlSWQgPSAnY29tLmFwcGxlLm1vYmlsZWNhbCc7XG4gICAgICB0aGlzLm9wdHMuYXBwID0gbnVsbDtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gZG93bmxvYWQgaWYgbmVjZXNzYXJ5XG4gICAgICB0aGlzLm9wdHMuYXBwID0gYXdhaXQgdGhpcy5oZWxwZXJzLmNvbmZpZ3VyZUFwcCh0aGlzLm9wdHMuYXBwLCAnLmFwcCcsIHRoaXMub3B0cy5tb3VudFJvb3QsIHRoaXMub3B0cy53aW5kb3dzU2hhcmVVc2VyTmFtZSwgdGhpcy5vcHRzLndpbmRvd3NTaGFyZVBhc3N3b3JkKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvcihlcnIpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQmFkIGFwcDogJHt0aGlzLm9wdHMuYXBwfS4gQXBwIHBhdGhzIG5lZWQgdG8gYmUgYWJzb2x1dGUsIG9yIHJlbGF0aXZlIHRvIHRoZSBhcHBpdW0gYCArXG4gICAgICAgICdzZXJ2ZXIgaW5zdGFsbCBkaXIsIG9yIGEgVVJMIHRvIGNvbXByZXNzZWQgZmlsZSwgb3IgYSBzcGVjaWFsIGFwcCBuYW1lLicpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRldGVybWluZURldmljZSAoKSB7XG4gICAgLy8gaW4gdGhlIG9uZSBjYXNlIHdoZXJlIHdlIGNyZWF0ZSBhIHNpbSwgd2Ugd2lsbCBzZXQgdGhpcyBzdGF0ZVxuICAgIHRoaXMubGlmZWN5Y2xlRGF0YS5jcmVhdGVTaW0gPSBmYWxzZTtcblxuICAgIC8vIGlmIHdlIGdldCBnZW5lcmljIG5hbWVzLCB0cmFuc2xhdGUgdGhlbVxuICAgIHRoaXMub3B0cy5kZXZpY2VOYW1lID0gKGZ1bmN0aW9uIHRyYW5zbGF0ZURldmljZU5hbWUgKGRuID0gJycpIHtcbiAgICAgIGxldCBkZXZpY2VOYW1lID0gZG47XG4gICAgICBpZiAoZG4udG9Mb3dlckNhc2UoKSA9PT0gJ2lwaG9uZSBzaW11bGF0b3InKSB7XG4gICAgICAgIGRldmljZU5hbWUgPSAnaVBob25lIDYnO1xuICAgICAgfSBlbHNlIGlmIChkbi50b0xvd2VyQ2FzZSgpID09PSAnaXBhZCBzaW11bGF0b3InKSB7XG4gICAgICAgIGRldmljZU5hbWUgPSAnaVBhZCBSZXRpbmEnO1xuICAgICAgfVxuICAgICAgaWYgKGRldmljZU5hbWUgIT09IGRuKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQ2hhbmdpbmcgZGV2aWNlTmFtZSBmcm9tICcke2RufScgdG8gJyR7ZGV2aWNlTmFtZX0nYCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZGV2aWNlTmFtZTtcbiAgICB9KSh0aGlzLm9wdHMuZGV2aWNlTmFtZSk7XG5cbiAgICAvLyBjaGVjayBmb3IgYSBwYXJ0aWN1bGFyIHNpbXVsYXRvclxuICAgIGlmICh0aGlzLm9wdHMudWRpZCAmJiAoYXdhaXQgc2ltRXhpc3RzKHRoaXMub3B0cy51ZGlkKSkpIHtcbiAgICAgIGxldCBkZXZpY2UgPSBhd2FpdCBnZXRTaW11bGF0b3IodGhpcy5vcHRzLnVkaWQpO1xuICAgICAgcmV0dXJuIHtkZXZpY2UsIHJlYWxEZXZpY2U6IGZhbHNlLCB1ZGlkOiB0aGlzLm9wdHMudWRpZH07XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgZm9yIGEgcGFydGljdWxhciByZWFsIGRldmljZVxuICAgIGlmICh0aGlzLm9wdHMudWRpZCkge1xuICAgICAgaWYgKHRoaXMub3B0cy51ZGlkLnRvTG93ZXJDYXNlKCkgPT09ICdhdXRvJykge1xuICAgICAgICB0aGlzLm9wdHMudWRpZCA9IGF3YWl0IGRldGVjdFVkaWQoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIG1ha2Ugc3VyZSBpdCBpcyBhIGNvbm5lY3RlZCBkZXZpY2UuIElmIG5vdCwgdGhlIHVkaWQgcGFzc2VkIGluIGlzIGludmFsaWRcbiAgICAgICAgbGV0IGRldmljZXMgPSBhd2FpdCBnZXRDb25uZWN0ZWREZXZpY2VzKCk7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQXZhaWxhYmxlIGRldmljZXM6ICR7ZGV2aWNlcy5qb2luKCcsICcpfWApO1xuICAgICAgICBpZiAoZGV2aWNlcy5pbmRleE9mKHRoaXMub3B0cy51ZGlkKSA9PT0gLTEpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gZGV2aWNlIG9yIHNpbXVsYXRvciBVRElEOiAnJHt0aGlzLm9wdHMudWRpZH0nYCk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgbGV0IGRldmljZSA9IGF3YWl0IGdldFJlYWxEZXZpY2VPYmoodGhpcy5vcHRzLnVkaWQpO1xuICAgICAgcmV0dXJuIHtkZXZpY2UsIHJlYWxEZXZpY2U6IHRydWUsIHVkaWQ6IHRoaXMub3B0cy51ZGlkfTtcbiAgICB9XG5cbiAgICAvLyBmaWd1cmUgb3V0IHRoZSBjb3JyZWN0IHNpbXVsYXRvciB0byB1c2UsIGdpdmVuIHRoZSBkZXNpcmVkIGNhcGFiaWxpdGllc1xuICAgIGxldCBkZXZpY2UgPSBhd2FpdCBnZXRFeGlzdGluZ1NpbSh0aGlzLm9wdHMuZGV2aWNlTmFtZSwgdGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbik7XG5cbiAgICAvLyBjaGVjayBmb3IgYW4gZXhpc3Rpbmcgc2ltdWxhdG9yXG4gICAgaWYgKGRldmljZSkge1xuICAgICAgcmV0dXJuIHtkZXZpY2UsIHJlYWxEZXZpY2U6IGZhbHNlLCB1ZGlkOiBkZXZpY2UudWRpZH07XG4gICAgfVxuXG4gICAgLy8gbm8gZGV2aWNlIG9mIHRoaXMgdHlwZSBleGlzdHMsIHNvIGNyZWF0ZSBvbmVcbiAgICBsb2cuaW5mbygnU2ltdWxhdG9yIHVkaWQgbm90IHByb3ZpZGVkLCB1c2luZyBkZXNpcmVkIGNhcHMgdG8gY3JlYXRlIGEgbmV3IHNpbXVsYXRvcicpO1xuICAgIGlmICghdGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbikge1xuICAgICAgbG9nLmluZm8oYE5vIHBsYXRmb3JtVmVyc2lvbiBzcGVjaWZpZWQuIFVzaW5nIGxhdGVzdCB2ZXJzaW9uIFhjb2RlIHN1cHBvcnRzOiAnJHt0aGlzLmlvc1Nka1ZlcnNpb259JyBgICtcbiAgICAgICAgICAgICAgIGBUaGlzIG1heSBjYXVzZSBwcm9ibGVtcyBpZiBhIHNpbXVsYXRvciBkb2VzIG5vdCBleGlzdCBmb3IgdGhpcyBwbGF0Zm9ybSB2ZXJzaW9uLmApO1xuICAgICAgdGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiA9IHRoaXMuaW9zU2RrVmVyc2lvbjtcbiAgICB9XG4gICAgZGV2aWNlID0gYXdhaXQgdGhpcy5jcmVhdGVTaW0oKTtcbiAgICByZXR1cm4ge2RldmljZSwgcmVhbERldmljZTogZmFsc2UsIHVkaWQ6IGRldmljZS51ZGlkfTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2ltICgpIHtcbiAgICAvLyBUT0RPIGZvciBub3cganVzdCBraWxsIGFsbCBzaW1zIHVubGVzcyBzcGVjaWZpZWQgdWRpZCBpcyBib290ZWQuXG4gICAgLy8gaWYgYm9vdGVkLCB1c2UgaXQuIGlmIG5vdCBib290ZWQsIHN0YXJ0IGl0IHVwXG4gICAgLy8gaWYgbm8gdWRpZCwgd2VsbCBsZXRzIHNlZSBpZiB3ZSBjYW4gc3RhcnQgb25lIHVwIGJhc2VkIG9uIGRlc2lyZWQgY2Fwc1xuICAgIC8vIGlmIHdlIHN1cHBvcnQgbXVsdGlwbGUgc2ltcyB3ZSBuZWVkIHRvIGNoYW5nZSB0aGlzXG5cbiAgICBpZiAoYXdhaXQgc2ltQm9vdGVkKHRoaXMub3B0cy5kZXZpY2UpKSB7XG4gICAgICBsb2cuaW5mbyhgU2ltdWxhdG9yIHdpdGggdWRpZCAnJHt0aGlzLm9wdHMudWRpZH0nIGFscmVhZHkgYm9vdGVkYCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxvZy5pbmZvKGBTaW11bGF0b3Igd2l0aCB1ZGlkICcke3RoaXMub3B0cy51ZGlkfScgbm90IGJvb3RlZC4gQm9vdGluZyB1cCBub3dgKTtcbiAgICBhd2FpdCBraWxsQWxsU2ltdWxhdG9ycygpO1xuICAgIGF3YWl0IHRoaXMub3B0cy5kZXZpY2UucnVuKHVuZGVmaW5lZCwgdGhpcy5vcHRzLmFsbG93VG91Y2hJZEVucm9sbCk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVTaW0gKCkge1xuICAgIHRoaXMubGlmZWN5Y2xlRGF0YS5jcmVhdGVTaW0gPSB0cnVlO1xuXG4gICAgLy8gY3JlYXRlIHNpbSBmb3IgY2Fwc1xuICAgIGxldCBzaW0gPSBhd2FpdCBjcmVhdGVTaW0odGhpcy5vcHRzLCB0aGlzLnNlc3Npb25JZCk7XG4gICAgbG9nLmluZm8oYENyZWF0ZWQgc2ltdWxhdG9yIHdpdGggdWRpZCAnJHtzaW0udWRpZH0nLmApO1xuXG4gICAgcmV0dXJuIHNpbTtcbiAgfVxuXG4gIGFzeW5jIGxhdW5jaEFwcCAoKSB7XG4gICAgY29uc3QgQVBQX0xBVU5DSF9USU1FT1VUID0gMjAgKiAxMDAwO1xuXG4gICAgdGhpcy5sb2dFdmVudCgnYXBwTGF1bmNoQXR0ZW1wdGVkJyk7XG4gICAgYXdhaXQgbGF1bmNoKHRoaXMub3B0cy5kZXZpY2UudWRpZCwgdGhpcy5vcHRzLmJ1bmRsZUlkKTtcblxuICAgIGxldCBjaGVja1N0YXR1cyA9IGFzeW5jICgpID0+IHtcbiAgICAgIGxldCByZXNwb25zZSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgICAgbGV0IGN1cnJlbnRBcHAgPSByZXNwb25zZS5jdXJyZW50QXBwLmJ1bmRsZUlEO1xuICAgICAgaWYgKGN1cnJlbnRBcHAgIT09IHRoaXMub3B0cy5idW5kbGVJZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7dGhpcy5vcHRzLmJ1bmRsZUlkfSBub3QgaW4gZm9yZWdyb3VuZC4gJHtjdXJyZW50QXBwfSBpcyBpbiBmb3JlZ3JvdW5kYCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIGxvZy5pbmZvKGBXYWl0aW5nIGZvciAnJHt0aGlzLm9wdHMuYnVuZGxlSWR9JyB0byBiZSBpbiBmb3JlZ3JvdW5kYCk7XG4gICAgbGV0IHJldHJpZXMgPSBwYXJzZUludChBUFBfTEFVTkNIX1RJTUVPVVQgLyAyMDAsIDEwKTtcbiAgICBhd2FpdCByZXRyeUludGVydmFsKHJldHJpZXMsIDIwMCwgY2hlY2tTdGF0dXMpO1xuICAgIGxvZy5pbmZvKGAke3RoaXMub3B0cy5idW5kbGVJZH0gaXMgaW4gZm9yZWdyb3VuZGApO1xuICAgIHRoaXMubG9nRXZlbnQoJ2FwcExhdW5jaGVkJyk7XG4gIH1cblxuICBhc3luYyBzdGFydFdkYVNlc3Npb24gKGJ1bmRsZUlkLCBwcm9jZXNzQXJndW1lbnRzKSB7XG4gICAgbGV0IGFyZ3MgPSBwcm9jZXNzQXJndW1lbnRzID8gcHJvY2Vzc0FyZ3VtZW50cy5hcmdzIDogW107XG4gICAgbGV0IGVudiA9IHByb2Nlc3NBcmd1bWVudHMgPyBwcm9jZXNzQXJndW1lbnRzLmVudiA6IHt9O1xuXG4gICAgbGV0IHNob3VsZFdhaXRGb3JRdWllc2NlbmNlID0gdXRpbC5oYXNWYWx1ZSh0aGlzLm9wdHMud2FpdEZvclF1aWVzY2VuY2UpID8gdGhpcy5vcHRzLndhaXRGb3JRdWllc2NlbmNlIDogdHJ1ZTtcbiAgICBsZXQgbWF4VHlwaW5nRnJlcXVlbmN5ID0gdXRpbC5oYXNWYWx1ZSh0aGlzLm9wdHMubWF4VHlwaW5nRnJlcXVlbmN5KSA/IHRoaXMub3B0cy5tYXhUeXBpbmdGcmVxdWVuY3kgOiA2MDtcbiAgICBsZXQgc2hvdWxkVXNlU2luZ2xldG9uVGVzdE1hbmFnZXIgPSB1dGlsLmhhc1ZhbHVlKHRoaXMub3B0cy5zaG91bGRVc2VTaW5nbGV0b25UZXN0TWFuYWdlcikgPyB0aGlzLm9wdHMuc2hvdWxkVXNlU2luZ2xldG9uVGVzdE1hbmFnZXIgOiB0cnVlO1xuICAgIGxldCBzaG91bGRVc2VUZXN0TWFuYWdlckZvclZpc2liaWxpdHlEZXRlY3Rpb24gPSBmYWxzZTtcbiAgICBpZiAodXRpbC5oYXNWYWx1ZSh0aGlzLm9wdHMuc2ltcGxlSXNWaXNpYmxlQ2hlY2spKSB7XG4gICAgICBzaG91bGRVc2VUZXN0TWFuYWdlckZvclZpc2liaWxpdHlEZXRlY3Rpb24gPSB0aGlzLm9wdHMuc2ltcGxlSXNWaXNpYmxlQ2hlY2s7XG4gICAgfVxuICAgIGlmICghaXNOYU4ocGFyc2VGbG9hdCh0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uKSkgJiYgcGFyc2VGbG9hdCh0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uKS50b0ZpeGVkKDEpID09PSAnOS4zJykge1xuICAgICAgbG9nLmluZm8oYEZvcmNpbmcgc2hvdWxkVXNlU2luZ2xldG9uVGVzdE1hbmFnZXIgY2FwYWJpbGl0eSB2YWx1ZSB0byB0cnVlLCBiZWNhdXNlIG9mIGtub3duIFhDVGVzdCBpc3N1ZXMgdW5kZXIgOS4zIHBsYXRmb3JtIHZlcnNpb25gKTtcbiAgICAgIHNob3VsZFVzZVRlc3RNYW5hZ2VyRm9yVmlzaWJpbGl0eURldGVjdGlvbiA9IHRydWU7XG4gICAgfVxuXG4gICAgbGV0IGRlc2lyZWQgPSB7XG4gICAgICBkZXNpcmVkQ2FwYWJpbGl0aWVzOiB7XG4gICAgICAgIGJ1bmRsZUlkLFxuICAgICAgICBhcmd1bWVudHM6IGFyZ3MsXG4gICAgICAgIGVudmlyb25tZW50OiBlbnYsXG4gICAgICAgIHNob3VsZFdhaXRGb3JRdWllc2NlbmNlLFxuICAgICAgICBzaG91bGRVc2VUZXN0TWFuYWdlckZvclZpc2liaWxpdHlEZXRlY3Rpb24sXG4gICAgICAgIG1heFR5cGluZ0ZyZXF1ZW5jeSxcbiAgICAgICAgc2hvdWxkVXNlU2luZ2xldG9uVGVzdE1hbmFnZXIsXG4gICAgICB9XG4gICAgfTtcblxuICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywgZGVzaXJlZCk7XG4gIH1cblxuICAvLyBPdmVycmlkZSBQcm94eSBtZXRob2RzIGZyb20gQmFzZURyaXZlclxuICBwcm94eUFjdGl2ZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuandwUHJveHlBY3RpdmU7XG4gIH1cblxuICBnZXRQcm94eUF2b2lkTGlzdCAoKSB7XG4gICAgaWYgKHRoaXMuaXNXZWJ2aWV3KCkpIHtcbiAgICAgIHJldHVybiBOT19QUk9YWV9XRUJfTElTVDtcbiAgICB9XG4gICAgcmV0dXJuIE5PX1BST1hZX05BVElWRV9MSVNUO1xuICB9XG5cbiAgY2FuUHJveHkgKCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgaXNTYWZhcmkgKCkge1xuICAgIHJldHVybiAhIXRoaXMuc2FmYXJpO1xuICB9XG5cbiAgaXNSZWFsRGV2aWNlICgpIHtcbiAgICByZXR1cm4gdGhpcy5vcHRzLnJlYWxEZXZpY2U7XG4gIH1cblxuICBpc1NpbXVsYXRvciAoKSB7XG4gICAgcmV0dXJuICF0aGlzLm9wdHMucmVhbERldmljZTtcbiAgfVxuXG4gIGlzV2VidmlldyAoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNTYWZhcmkoKSB8fCB0aGlzLmlzV2ViQ29udGV4dCgpO1xuICB9XG5cbiAgdmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3kgKHN0cmF0ZWd5KSB7XG4gICAgc3VwZXIudmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3koc3RyYXRlZ3ksIHRoaXMuaXNXZWJDb250ZXh0KCkpO1xuICB9XG5cbiAgdmFsaWRhdGVEZXNpcmVkQ2FwcyAoY2Fwcykge1xuICAgIC8vIGNoZWNrIHdpdGggdGhlIGJhc2UgY2xhc3MsIGFuZCByZXR1cm4gaWYgaXQgZmFpbHNcbiAgICBsZXQgcmVzID0gc3VwZXIudmFsaWRhdGVEZXNpcmVkQ2FwcyhjYXBzKTtcbiAgICBpZiAoIXJlcykge1xuICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG5cbiAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgY2FwYWJpbGl0aWVzIGhhdmUgb25lIG9mIGBhcHBgIG9yIGBidW5kbGVJZGBcbiAgICBpZiAoKGNhcHMuYnJvd3Nlck5hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCkgIT09ICdzYWZhcmknICYmXG4gICAgICAgICFjYXBzLmFwcCAmJiAhY2Fwcy5idW5kbGVJZCkge1xuICAgICAgbGV0IG1zZyA9ICdUaGUgZGVzaXJlZCBjYXBhYmlsaXRpZXMgbXVzdCBpbmNsdWRlIGVpdGhlciBhbiBhcHAgb3IgYSBidW5kbGVJZCBmb3IgaU9TJztcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgfVxuXG4gICAgbGV0IHZlcmlmeVByb2Nlc3NBcmd1bWVudCA9IChwcm9jZXNzQXJndW1lbnRzKSA9PiB7XG4gICAgICBpZiAoIV8uaXNOaWwocHJvY2Vzc0FyZ3VtZW50cy5hcmdzKSAmJiAhXy5pc0FycmF5KHByb2Nlc3NBcmd1bWVudHMuYXJncykpIHtcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coJ3Byb2Nlc3NBcmd1bWVudHMuYXJncyBtdXN0IGJlIGFuIGFycmF5IG9mIHN0cmluZycpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIV8uaXNOaWwocHJvY2Vzc0FyZ3VtZW50cy5lbnYpICYmICFfLmlzT2JqZWN0KGNhcHMucHJvY2Vzc0FyZ3VtZW50cy5lbnYpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KCdwcm9jZXNzQXJndW1lbnRzLmVudiBtdXN0IGJlIGFuIG9iamVjdCA8a2V5LHZhbHVlPiBwYWlyIHthOmIsIGM6ZH0nKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgLy8gYHByb2Nlc3NBcmd1bWVudHNgIHNob3VsZCBiZSBKU09OIHN0cmluZyBvciBhbiBvYmplY3Qgd2l0aCBhcmd1bWVudHMgYW5kLyBlbnZpcm9ubWVudCBkZXRhaWxzXG4gICAgaWYgKGNhcHMucHJvY2Vzc0FyZ3VtZW50cykge1xuICAgICAgaWYgKF8uaXNTdHJpbmcoY2Fwcy5wcm9jZXNzQXJndW1lbnRzKSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIC8vIHRyeSB0byBwYXJzZSB0aGUgc3RyaW5nIGFzIEpTT05cbiAgICAgICAgICBjYXBzLnByb2Nlc3NBcmd1bWVudHMgPSBKU09OLnBhcnNlKGNhcHMucHJvY2Vzc0FyZ3VtZW50cyk7XG4gICAgICAgICAgdmVyaWZ5UHJvY2Vzc0FyZ3VtZW50KGNhcHMucHJvY2Vzc0FyZ3VtZW50cyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBwcm9jZXNzQXJndW1lbnRzIG11c3QgYmUgYSBqc29uIGZvcm1hdCBvciBhbiBvYmplY3Qgd2l0aCBmb3JtYXQge2FyZ3MgOiBbXSwgZW52IDoge2E6YiwgYzpkfX0uIEJvdGggZW52aXJvbm1lbnQgYW5kIGFyZ3VtZW50IGNhbiBiZSBudWxsLiBFcnJvcjogJHtlcnJ9YCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoXy5pc09iamVjdChjYXBzLnByb2Nlc3NBcmd1bWVudHMpKSB7XG4gICAgICAgIHZlcmlmeVByb2Nlc3NBcmd1bWVudChjYXBzLnByb2Nlc3NBcmd1bWVudHMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coJ3Byb2Nlc3NBcmd1bWVudHMgbXVzdCBiZSBhbiBvYmplY3QsIG9yIGEgc3RyaW5nIEpTT04gb2JqZWN0IHdpdGggZm9ybWF0IHthcmdzIDogW10sIGVudiA6IHthOmIsIGM6ZH19LiBCb3RoIGVudmlyb25tZW50IGFuZCBhcmd1bWVudCBjYW4gYmUgbnVsbC4nKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB0aGVyZSBpcyBubyBwb2ludCBpbiBoYXZpbmcgYGtleWNoYWluUGF0aGAgd2l0aG91dCBga2V5Y2hhaW5QYXNzd29yZGBcbiAgICBpZiAoKGNhcHMua2V5Y2hhaW5QYXRoICYmICFjYXBzLmtleWNoYWluUGFzc3dvcmQpIHx8ICghY2Fwcy5rZXljaGFpblBhdGggJiYgY2Fwcy5rZXljaGFpblBhc3N3b3JkKSkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYElmICdrZXljaGFpblBhdGgnIGlzIHNldCwgJ2tleWNoYWluUGFzc3dvcmQnIG11c3QgYWxzbyBiZSBzZXQgKGFuZCB2aWNlIHZlcnNhKS5gKTtcbiAgICB9XG5cbiAgICBpZiAoY2Fwcy5hdXRvQWNjZXB0QWxlcnRzIHx8IGNhcHMuYXV0b0Rpc21pc3NBbGVydHMpIHtcbiAgICAgIGxvZy53YXJuKGBUaGUgY2FwYWJpbGl0aWVzICdhdXRvQWNjZXB0QWxlcnRzJyBhbmQgJ2F1dG9EaXNtaXNzQWxlcnRzJyBgICtcbiAgICAgICAgICAgICAgIGBkbyBub3Qgd29yayBmb3IgWENVSVRlc3QtYmFzZWQgdGVzdHMuIFBsZWFzZSBhZGp1c3QgeW91ciBgICtcbiAgICAgICAgICAgICAgIGBhbGVydCBoYW5kbGluZyBhY2NvcmRpbmdseS5gKTtcbiAgICB9XG5cbiAgICAvLyBgcmVzZXRPblNlc3Npb25TdGFydE9ubHlgIHNob3VsZCBiZSBzZXQgdG8gdHJ1ZSBieSBkZWZhdWx0XG4gICAgdGhpcy5vcHRzLnJlc2V0T25TZXNzaW9uU3RhcnRPbmx5ID0gIXV0aWwuaGFzVmFsdWUodGhpcy5vcHRzLnJlc2V0T25TZXNzaW9uU3RhcnRPbmx5KSB8fCB0aGlzLm9wdHMucmVzZXRPblNlc3Npb25TdGFydE9ubHk7XG5cbiAgICAvLyBmaW5hbGx5LCByZXR1cm4gdHJ1ZSBzaW5jZSB0aGUgc3VwZXJjbGFzcyBjaGVjayBwYXNzZWQsIGFzIGRpZCB0aGlzXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBhc3luYyBpbnN0YWxsQXBwICgpIHtcbiAgICBpZiAodGhpcy5pc1NhZmFyaSgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIGlmIHVzZXIgaGFzIHBhc3NlZCBpbiBkZXNpcmVkQ2Fwcy5hdXRvTGF1bmNoID0gZmFsc2VcbiAgICAvLyBtZWFuaW5nIHRoZXkgd2lsbCBtYW5hZ2UgYXBwIGluc3RhbGwgLyBsYXVuY2hpbmdcbiAgICBpZiAodGhpcy5vcHRzLmF1dG9MYXVuY2ggPT09IGZhbHNlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIGF3YWl0IGluc3RhbGxUb1JlYWxEZXZpY2UgKHRoaXMub3B0cy5kZXZpY2UsIHRoaXMub3B0cy5hcHAsIHRoaXMub3B0cy5idW5kbGVJZCwgdGhpcy5vcHRzLm5vUmVzZXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCBpbnN0YWxsVG9TaW11bGF0b3IodGhpcy5vcHRzLmRldmljZSwgdGhpcy5vcHRzLmFwcCwgdGhpcy5vcHRzLmJ1bmRsZUlkLCB0aGlzLm9wdHMubm9SZXNldCk7XG4gICAgfVxuXG4gICAgaWYgKHV0aWwuaGFzVmFsdWUodGhpcy5vcHRzLmlvc0luc3RhbGxQYXVzZSkpIHtcbiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy82ODg5XG4gICAgICBsZXQgcGF1c2UgPSBwYXJzZUludCh0aGlzLm9wdHMuaW9zSW5zdGFsbFBhdXNlLCAxMCk7XG4gICAgICBsb2cuZGVidWcoYGlvc0luc3RhbGxQYXVzZSBzZXQuIFBhdXNpbmcgJHtwYXVzZX0gbXMgYmVmb3JlIGNvbnRpbnVpbmdgKTtcbiAgICAgIGF3YWl0IEIuZGVsYXkocGF1c2UpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNldEluaXRpYWxPcmllbnRhdGlvbiAob3JpZW50YXRpb24pIHtcbiAgICBpZiAodHlwZW9mIG9yaWVudGF0aW9uICE9PSAnc3RyaW5nJykge1xuICAgICAgb3JpZW50YXRpb24gPSAnUE9SVFJBSVQnO1xuICAgIH1cbiAgICBvcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uLnRvVXBwZXJDYXNlKCk7XG4gICAgaWYgKCFfLmluY2x1ZGVzKFsnTEFORFNDQVBFJywgJ1BPUlRSQUlUJ10sIG9yaWVudGF0aW9uKSkge1xuICAgICAgbG9nLmRlYnVnKGBVbmFibGUgdG8gc2V0IGluaXRpYWwgb3JpZW50YXRpb24gdG8gJyR7b3JpZW50YXRpb259J2ApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFNldHRpbmcgaW5pdGlhbCBvcmllbnRhdGlvbiB0byAnJHtvcmllbnRhdGlvbn0nYCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvb3JpZW50YXRpb24nLCAnUE9TVCcsIHtvcmllbnRhdGlvbn0pO1xuICAgICAgdGhpcy5vcHRzLmN1ck9yaWVudGF0aW9uID0gb3JpZW50YXRpb247XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgU2V0dGluZyBpbml0aWFsIG9yaWVudGF0aW9uIGZhaWxlZCB3aXRoOiAke2Vycn1gKTtcbiAgICB9XG4gIH1cblxuICBfZ2V0Q29tbWFuZFRpbWVvdXQgKGNtZE5hbWUpIHtcbiAgICB0aGlzLm9wdHMuY29tbWFuZFRpbWVvdXRzID0gbm9ybWFsaXplQ29tbWFuZFRpbWVvdXRzKHRoaXMub3B0cy5jb21tYW5kVGltZW91dHMpO1xuICAgIGlmICh0aGlzLm9wdHMuY29tbWFuZFRpbWVvdXRzKSB7XG4gICAgICBpZiAoY21kTmFtZSAmJiBfLmhhcyh0aGlzLm9wdHMuY29tbWFuZFRpbWVvdXRzLCBjbWROYW1lKSkge1xuICAgICAgICByZXR1cm4gdGhpcy5vcHRzLmNvbW1hbmRUaW1lb3V0c1tjbWROYW1lXTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLm9wdHMuY29tbWFuZFRpbWVvdXRzW0RFRkFVTFRfVElNRU9VVF9LRVldO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgc2Vzc2lvbiBjYXBhYmlsaXRpZXMgbWVyZ2VkIHdpdGggd2hhdCBXREEgcmVwb3J0c1xuICAgKiBUaGlzIGlzIGEgbGlicmFyeSBjb21tYW5kIGJ1dCBuZWVkcyB0byBjYWxsICdzdXBlcicgc28gY2FuJ3QgYmUgb25cbiAgICogYSBoZWxwZXIgb2JqZWN0XG4gICAqL1xuICBhc3luYyBnZXRTZXNzaW9uICgpIHtcbiAgICAvLyBjYWxsIHN1cGVyIHRvIGdldCBldmVudCB0aW1pbmdzLCBldGMuLi5cbiAgICBsZXQgZHJpdmVyU2Vzc2lvbiA9IGF3YWl0IHN1cGVyLmdldFNlc3Npb24oKTtcbiAgICBsZXQgd2RhQ2FwcyA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvJywgJ0dFVCcpO1xuICAgIGxvZy5pbmZvKFwiTWVyZ2luZyBXREEgY2FwcyBvdmVyIEFwcGl1bSBjYXBzIGZvciBzZXNzaW9uIGRldGFpbCByZXNwb25zZVwiKTtcbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7dWRpZDogdGhpcy5vcHRzLnVkaWR9LCBkcml2ZXJTZXNzaW9uLCB3ZGFDYXBzLmNhcGFiaWxpdGllcyk7XG4gIH1cblxuICBhc3luYyBzdGFydElXRFAgKCkge1xuICAgIHRoaXMubG9nRXZlbnQoJ2l3ZHBTdGFydGluZycpO1xuICAgIHRoaXMuaXdkcFNlcnZlciA9IG5ldyBJV0RQKHRoaXMub3B0cy53ZWJraXREZWJ1Z1Byb3h5UG9ydCwgdGhpcy5vcHRzLnVkaWQpO1xuICAgIGF3YWl0IHRoaXMuaXdkcFNlcnZlci5zdGFydCgpO1xuICAgIHRoaXMubG9nRXZlbnQoJ2l3ZHBTdGFydGVkJyk7XG4gIH1cblxuICBhc3luYyBzdG9wSVdEUCAoKSB7XG4gICAgaWYgKHRoaXMuaXdkcFNlcnZlcikge1xuICAgICAgYXdhaXQgdGhpcy5pd2RwU2VydmVyLnN0b3AoKTtcbiAgICAgIGRlbGV0ZSB0aGlzLml3ZHBTZXJ2ZXI7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVzZXQgKCkge1xuICAgIGlmICh0aGlzLm9wdHMubm9SZXNldCkge1xuICAgICAgLy8gVGhpcyBpcyB0byBtYWtlIHN1cmUgcmVzZXQgaGFwcGVucyBldmVuIGlmIG5vUmVzZXQgaXMgc2V0IHRvIHRydWVcbiAgICAgIGxldCBvcHRzID0gXy5jbG9uZURlZXAodGhpcy5vcHRzKTtcbiAgICAgIG9wdHMubm9SZXNldCA9IGZhbHNlO1xuICAgICAgb3B0cy5mdWxsUmVzZXQgPSBmYWxzZTtcbiAgICAgIGNvbnN0IHNodXRkb3duSGFuZGxlciA9IHRoaXMucmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93bjtcbiAgICAgIHRoaXMucmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93biA9ICgpID0+IHt9O1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5ydW5SZXNldChvcHRzKTtcbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIHRoaXMucmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93biA9IHNodXRkb3duSGFuZGxlcjtcbiAgICAgIH1cbiAgICB9XG4gICAgYXdhaXQgc3VwZXIucmVzZXQoKTtcbiAgfVxuXG59XG5cbmZvciAobGV0IFtjbWQsIGZuXSBvZiBfLnRvUGFpcnMoY29tbWFuZHMpKSB7XG4gIFhDVUlUZXN0RHJpdmVyLnByb3RvdHlwZVtjbWRdID0gZm47XG59XG5cblxuZXhwb3J0IGRlZmF1bHQgWENVSVRlc3REcml2ZXI7XG5leHBvcnQgeyBYQ1VJVGVzdERyaXZlciB9O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
