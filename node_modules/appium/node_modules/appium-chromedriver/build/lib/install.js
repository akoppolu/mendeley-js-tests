'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _asyncbox = require('asyncbox');

var _appiumSupport = require('appium-support');

var log = _appiumSupport.logger.getLogger('Chromedriver Install');

var CD_VER = process.env.npm_config_chromedriver_version || process.env.CHROMEDRIVER_VERSION || '2.28';
var CD_CDN = process.env.npm_config_chromedriver_cdnurl || process.env.CHROMEDRIVER_CDNURL || 'https://chromedriver.storage.googleapis.com';
var CD_BASE_DIR = _path2['default'].resolve(__dirname, "..", "..", "chromedriver");
var CD_PLATS = ["linux", "win", "mac"];
var CD_ARCHS = ["32", "64"];

function getCurPlatform() {
  return _appiumSupport.system.isWindows() ? "win" : _appiumSupport.system.isMac() ? "mac" : "linux";
}

function getChromedriverDir() {
  var platform = arguments.length <= 0 || arguments[0] === undefined ? null : arguments[0];

  if (!platform) {
    platform = getCurPlatform();
  }
  return _path2['default'].resolve(CD_BASE_DIR, platform);
}

function getArchAndPlatform() {
  var arch, platform;
  return _regeneratorRuntime.async(function getArchAndPlatform$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.system.arch());

      case 2:
        arch = context$1$0.sent;
        platform = getCurPlatform();

        if (platform !== 'linux' && platform !== 'mac' && arch === '64') {
          arch = '32';
        }
        if (platform === 'mac' && parseFloat(CD_VER) < 2.23) {
          arch = '32';
        }
        return context$1$0.abrupt('return', { arch: arch, platform: platform });

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getChromedriverBinaryPath() {
  var platform = arguments.length <= 0 || arguments[0] === undefined ? null : arguments[0];
  var arch = arguments.length <= 1 || arguments[1] === undefined ? null : arguments[1];
  var baseDir, ext;
  return _regeneratorRuntime.async(function getChromedriverBinaryPath$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!platform) {
          platform = getCurPlatform();
        }
        baseDir = getChromedriverDir(platform);
        ext = "";

        if (!(platform === "win")) {
          context$1$0.next = 7;
          break;
        }

        ext = ".exe";
        context$1$0.next = 13;
        break;

      case 7:
        if (!(platform === "linux")) {
          context$1$0.next = 13;
          break;
        }

        if (arch) {
          context$1$0.next = 12;
          break;
        }

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(_appiumSupport.system.arch());

      case 11:
        arch = context$1$0.sent;

      case 12:
        ext = "_" + arch;

      case 13:
        return context$1$0.abrupt('return', _path2['default'].resolve(baseDir, 'chromedriver' + ext));

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getDownloadUrl(version, platform, arch) {
  return CD_CDN + '/' + version + '/chromedriver_' + platform + arch + '.zip';
}

function validatePlatform(platform, arch) {
  if (!_lodash2['default'].contains(CD_PLATS, platform)) {
    throw new Error('Invalid platform: ' + platform);
  }
  if (!_lodash2['default'].contains(CD_ARCHS, arch)) {
    throw new Error('Invalid arch: ' + arch);
  }
  if (arch === "64" && platform !== "linux" && platform !== 'mac') {
    throw new Error("Only linux has a 64-bit version of Chromedriver");
  }
}

function installForPlatform(version, platform, arch) {
  var url, binarySpec, tempFile, body, tempUnzipped, extractedBin, newBin, binContents;
  return _regeneratorRuntime.async(function installForPlatform$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(version === 'LATEST')) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.t0 = JSON;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ uri: CD_CDN + '/LATEST_RELEASE' }));

      case 4:
        context$1$0.t1 = context$1$0.sent;
        version = context$1$0.t0.parse.call(context$1$0.t0, context$1$0.t1);

      case 6:
        validatePlatform(platform, arch);

        url = getDownloadUrl(version, platform, arch);

        log.info('Installing Chromedriver version \'' + version + '\' for platform \'' + platform + '\' and architecture \'' + arch + '\'');

        // set up a temp file to download the chromedriver zipfile to
        binarySpec = 'chromedriver_' + platform + arch;

        log.info('Opening temp file to write ' + binarySpec + ' to...');
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.open({
          prefix: binarySpec,
          suffix: '.zip'
        }));

      case 13:
        tempFile = context$1$0.sent;

        // actually download the zipfile and write it with appropriate perms
        log.info('Downloading ' + url + '...');
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: url, encoding: 'binary' }));

      case 17:
        body = context$1$0.sent;

        log.info('Writing binary content to ' + tempFile.path + '...');
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(tempFile.path, body, { encoding: 'binary' }));

      case 21:
        context$1$0.next = 23;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.chmod(tempFile.path, 420));

      case 23:
        tempUnzipped = _path2['default'].resolve(_path2['default'].dirname(tempFile.path), binarySpec);

        log.info('Extracting ' + tempFile.path + ' to ' + tempUnzipped);
        context$1$0.next = 27;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(tempUnzipped));

      case 27:
        context$1$0.next = 29;
        return _regeneratorRuntime.awrap(_appiumSupport.zip.extractAllTo(tempFile.path, tempUnzipped));

      case 29:
        extractedBin = _path2['default'].resolve(tempUnzipped, "chromedriver");

        if (platform === "win") {
          extractedBin += ".exe";
        }

        // make build dirs that will hold the chromedriver binary
        log.info('Creating ' + _path2['default'].resolve(CD_BASE_DIR, platform) + '...');
        context$1$0.next = 34;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(CD_BASE_DIR));

      case 34:
        context$1$0.next = 36;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(_path2['default'].resolve(CD_BASE_DIR, platform)));

      case 36:
        context$1$0.next = 38;
        return _regeneratorRuntime.awrap(getChromedriverBinaryPath(platform, arch));

      case 38:
        newBin = context$1$0.sent;

        log.info('Copying unzipped binary, reading from ' + extractedBin + '...');
        context$1$0.next = 42;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(extractedBin, { encoding: 'binary' }));

      case 42:
        binContents = context$1$0.sent;

        log.info('Writing to ' + newBin + '...');
        context$1$0.next = 46;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(newBin, binContents, { encoding: 'binary', mode: 493 }));

      case 46:
        log.info(newBin + ' successfully put in place');

      case 47:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function install() {
  var _ref, arch, platform;

  return _regeneratorRuntime.async(function install$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(getArchAndPlatform());

      case 2:
        _ref = context$1$0.sent;
        arch = _ref.arch;
        platform = _ref.platform;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(installForPlatform(CD_VER, platform, arch));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function conditionalInstall() {
  var _ref2, arch, platform, binPath;

  return _regeneratorRuntime.async(function conditionalInstall$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(getArchAndPlatform());

      case 2:
        _ref2 = context$1$0.sent;
        arch = _ref2.arch;
        platform = _ref2.platform;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(getChromedriverBinaryPath(platform, arch));

      case 7:
        binPath = context$1$0.sent;
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(binPath));

      case 10:
        if (context$1$0.sent) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(installForPlatform(CD_VER, platform, arch));

      case 13:
        context$1$0.next = 16;
        break;

      case 15:
        log.info('No need to install chromedriver, ' + binPath + ' exists');

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function installAll() {
  var plats, downloads, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, platform, arch;

  return _regeneratorRuntime.async(function installAll$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        plats = [['linux', '32'], ['linux', '64'], ['win', '32']];

        // before 2.23 Mac version was 32 bit. After it is 64.
        plats.push(parseFloat(CD_VER) < 2.23 ? ['mac', '32'] : ['mac', '64']);
        downloads = [];
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 6;

        for (_iterator = _getIterator(plats); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          _step$value = _slicedToArray(_step.value, 2);
          platform = _step$value[0];
          arch = _step$value[1];

          downloads.push(installForPlatform(CD_VER, platform, arch));
        }
        context$1$0.next = 14;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](6);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 14:
        context$1$0.prev = 14;
        context$1$0.prev = 15;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 17:
        context$1$0.prev = 17;

        if (!_didIteratorError) {
          context$1$0.next = 20;
          break;
        }

        throw _iteratorError;

      case 20:
        return context$1$0.finish(17);

      case 21:
        return context$1$0.finish(14);

      case 22:
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap((0, _asyncbox.parallel)(downloads));

      case 24:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 10, 14, 22], [15,, 17, 21]]);
}

function doInstall() {
  return _regeneratorRuntime.async(function doInstall$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(_lodash2['default'].contains(process.argv, '--all') || process.env.npm_config_chromedriver_install_all)) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(installAll());

      case 3:
        context$1$0.next = 12;
        break;

      case 5:
        if (!_lodash2['default'].contains(process.argv, '--conditional')) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(conditionalInstall());

      case 8:
        context$1$0.next = 12;
        break;

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(install());

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.getChromedriverBinaryPath = getChromedriverBinaryPath;
exports.install = install;
exports.installAll = installAll;
exports.CD_BASE_DIR = CD_BASE_DIR;
exports.getCurPlatform = getCurPlatform;
exports.conditionalInstall = conditionalInstall;
exports.doInstall = doInstall;

// extract downloaded zipfile to tempdir

// copy the extracted binary to the correct build dir
//# sourceMappingURL=data:application/json;charset=utf8;base64,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UyxHQUFULFNBQVMiLCJmaWxlIjoibGliL2luc3RhbGwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHsgcGFyYWxsZWwgYXMgbGwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBzeXN0ZW0sIHRlbXBEaXIsIGZzLCBsb2dnZXIsIHppcCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuXG5jb25zdCBsb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdDaHJvbWVkcml2ZXIgSW5zdGFsbCcpO1xuXG5jb25zdCBDRF9WRVIgPSBwcm9jZXNzLmVudi5ucG1fY29uZmlnX2Nocm9tZWRyaXZlcl92ZXJzaW9uIHx8IHByb2Nlc3MuZW52LkNIUk9NRURSSVZFUl9WRVJTSU9OIHx8ICcyLjI4JztcbmNvbnN0IENEX0NETiA9IHByb2Nlc3MuZW52Lm5wbV9jb25maWdfY2hyb21lZHJpdmVyX2NkbnVybCB8fFxuICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnYuQ0hST01FRFJJVkVSX0NETlVSTCB8fFxuICAgICAgICAgICAgICAgJ2h0dHBzOi8vY2hyb21lZHJpdmVyLnN0b3JhZ2UuZ29vZ2xlYXBpcy5jb20nO1xuY29uc3QgQ0RfQkFTRV9ESVIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBcIi4uXCIsIFwiLi5cIiwgXCJjaHJvbWVkcml2ZXJcIik7XG5jb25zdCBDRF9QTEFUUyA9IFtcImxpbnV4XCIsIFwid2luXCIsIFwibWFjXCJdO1xuY29uc3QgQ0RfQVJDSFMgPSBbXCIzMlwiLCBcIjY0XCJdO1xuXG5mdW5jdGlvbiBnZXRDdXJQbGF0Zm9ybSAoKSB7XG4gIHJldHVybiBzeXN0ZW0uaXNXaW5kb3dzKCkgPyBcIndpblwiIDogKHN5c3RlbS5pc01hYygpID8gXCJtYWNcIiA6IFwibGludXhcIik7XG59XG5cbmZ1bmN0aW9uIGdldENocm9tZWRyaXZlckRpciAocGxhdGZvcm0gPSBudWxsKSB7XG4gIGlmICghcGxhdGZvcm0pIHtcbiAgICBwbGF0Zm9ybSA9IGdldEN1clBsYXRmb3JtKCk7XG4gIH1cbiAgcmV0dXJuIHBhdGgucmVzb2x2ZShDRF9CQVNFX0RJUiwgcGxhdGZvcm0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBcmNoQW5kUGxhdGZvcm0gKCkge1xuICBsZXQgYXJjaCA9IGF3YWl0IHN5c3RlbS5hcmNoKCk7XG4gIGxldCBwbGF0Zm9ybSA9IGdldEN1clBsYXRmb3JtKCk7XG4gIGlmIChwbGF0Zm9ybSAhPT0gJ2xpbnV4JyAmJiBwbGF0Zm9ybSAhPT0gJ21hYycgJiYgYXJjaCA9PT0gJzY0Jykge1xuICAgIGFyY2ggPSAnMzInO1xuICB9XG4gIGlmIChwbGF0Zm9ybSA9PT0gJ21hYycgJiYgcGFyc2VGbG9hdChDRF9WRVIpIDwgMi4yMykge1xuICAgIGFyY2ggPSAnMzInO1xuICB9XG4gIHJldHVybiB7YXJjaCwgcGxhdGZvcm19O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoIChwbGF0Zm9ybSA9IG51bGwsIGFyY2ggPSBudWxsKSB7XG4gIGlmICghcGxhdGZvcm0pIHtcbiAgICBwbGF0Zm9ybSA9IGdldEN1clBsYXRmb3JtKCk7XG4gIH1cbiAgY29uc3QgYmFzZURpciA9IGdldENocm9tZWRyaXZlckRpcihwbGF0Zm9ybSk7XG4gIGxldCBleHQgPSBcIlwiO1xuICBpZiAocGxhdGZvcm0gPT09IFwid2luXCIpIHtcbiAgICBleHQgPSBcIi5leGVcIjtcbiAgfSBlbHNlIGlmIChwbGF0Zm9ybSA9PT0gXCJsaW51eFwiKSB7XG4gICAgaWYgKCFhcmNoKSB7XG4gICAgICBhcmNoID0gYXdhaXQgc3lzdGVtLmFyY2goKTtcbiAgICB9XG4gICAgZXh0ID0gXCJfXCIgKyBhcmNoO1xuICB9XG4gIHJldHVybiBwYXRoLnJlc29sdmUoYmFzZURpciwgYGNocm9tZWRyaXZlciR7ZXh0fWApO1xufVxuXG5mdW5jdGlvbiBnZXREb3dubG9hZFVybCAodmVyc2lvbiwgcGxhdGZvcm0sIGFyY2gpIHtcbiAgcmV0dXJuIGAke0NEX0NETn0vJHt2ZXJzaW9ufS9jaHJvbWVkcml2ZXJfJHtwbGF0Zm9ybX0ke2FyY2h9LnppcGA7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlUGxhdGZvcm0gKHBsYXRmb3JtLCBhcmNoKSB7XG4gIGlmICghXy5jb250YWlucyhDRF9QTEFUUywgcGxhdGZvcm0pKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHBsYXRmb3JtOiAke3BsYXRmb3JtfWApO1xuICB9XG4gIGlmICghXy5jb250YWlucyhDRF9BUkNIUywgYXJjaCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYXJjaDogJHthcmNofWApO1xuICB9XG4gIGlmIChhcmNoID09PSBcIjY0XCIgJiYgcGxhdGZvcm0gIT09IFwibGludXhcIiAmJiBwbGF0Zm9ybSAhPT0gJ21hYycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJPbmx5IGxpbnV4IGhhcyBhIDY0LWJpdCB2ZXJzaW9uIG9mIENocm9tZWRyaXZlclwiKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsRm9yUGxhdGZvcm0gKHZlcnNpb24sIHBsYXRmb3JtLCBhcmNoKSB7XG4gIGlmICh2ZXJzaW9uID09PSAnTEFURVNUJykge1xuICAgIHZlcnNpb24gPSBKU09OLnBhcnNlKGF3YWl0IHJlcXVlc3QuZ2V0KHt1cmk6IENEX0NETiArICcvTEFURVNUX1JFTEVBU0UnfSkpO1xuICB9XG4gIHZhbGlkYXRlUGxhdGZvcm0ocGxhdGZvcm0sIGFyY2gpO1xuXG4gIGNvbnN0IHVybCA9IGdldERvd25sb2FkVXJsKHZlcnNpb24sIHBsYXRmb3JtLCBhcmNoKTtcblxuICBsb2cuaW5mbyhgSW5zdGFsbGluZyBDaHJvbWVkcml2ZXIgdmVyc2lvbiAnJHt2ZXJzaW9ufScgZm9yIHBsYXRmb3JtICcke3BsYXRmb3JtfScgYW5kIGFyY2hpdGVjdHVyZSAnJHthcmNofSdgKTtcblxuICAvLyBzZXQgdXAgYSB0ZW1wIGZpbGUgdG8gZG93bmxvYWQgdGhlIGNocm9tZWRyaXZlciB6aXBmaWxlIHRvXG4gIGxldCBiaW5hcnlTcGVjID0gYGNocm9tZWRyaXZlcl8ke3BsYXRmb3JtfSR7YXJjaH1gO1xuICBsb2cuaW5mbyhgT3BlbmluZyB0ZW1wIGZpbGUgdG8gd3JpdGUgJHtiaW5hcnlTcGVjfSB0by4uLmApO1xuICBsZXQgdGVtcEZpbGUgPSBhd2FpdCB0ZW1wRGlyLm9wZW4oe1xuICAgIHByZWZpeDogYmluYXJ5U3BlYyxcbiAgICBzdWZmaXg6ICcuemlwJ1xuICB9KTtcblxuICAvLyBhY3R1YWxseSBkb3dubG9hZCB0aGUgemlwZmlsZSBhbmQgd3JpdGUgaXQgd2l0aCBhcHByb3ByaWF0ZSBwZXJtc1xuICBsb2cuaW5mbyhgRG93bmxvYWRpbmcgJHt1cmx9Li4uYCk7XG4gIGxldCBib2R5ID0gYXdhaXQgcmVxdWVzdC5nZXQoe3VybCwgZW5jb2Rpbmc6ICdiaW5hcnknfSk7XG4gIGxvZy5pbmZvKGBXcml0aW5nIGJpbmFyeSBjb250ZW50IHRvICR7dGVtcEZpbGUucGF0aH0uLi5gKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKHRlbXBGaWxlLnBhdGgsIGJvZHksIHtlbmNvZGluZzogJ2JpbmFyeSd9KTtcbiAgYXdhaXQgZnMuY2htb2QodGVtcEZpbGUucGF0aCwgMG8wNjQ0KTtcblxuICAvLyBleHRyYWN0IGRvd25sb2FkZWQgemlwZmlsZSB0byB0ZW1wZGlyXG4gIGxldCB0ZW1wVW56aXBwZWQgPSBwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKHRlbXBGaWxlLnBhdGgpLCBiaW5hcnlTcGVjKTtcbiAgbG9nLmluZm8oYEV4dHJhY3RpbmcgJHt0ZW1wRmlsZS5wYXRofSB0byAke3RlbXBVbnppcHBlZH1gKTtcbiAgYXdhaXQgZnMubWtkaXIodGVtcFVuemlwcGVkKTtcbiAgYXdhaXQgemlwLmV4dHJhY3RBbGxUbyh0ZW1wRmlsZS5wYXRoLCB0ZW1wVW56aXBwZWQpO1xuICBsZXQgZXh0cmFjdGVkQmluID0gcGF0aC5yZXNvbHZlKHRlbXBVbnppcHBlZCwgXCJjaHJvbWVkcml2ZXJcIik7XG4gIGlmIChwbGF0Zm9ybSA9PT0gXCJ3aW5cIikge1xuICAgIGV4dHJhY3RlZEJpbiArPSBcIi5leGVcIjtcbiAgfVxuXG4gIC8vIG1ha2UgYnVpbGQgZGlycyB0aGF0IHdpbGwgaG9sZCB0aGUgY2hyb21lZHJpdmVyIGJpbmFyeVxuICBsb2cuaW5mbyhgQ3JlYXRpbmcgJHtwYXRoLnJlc29sdmUoQ0RfQkFTRV9ESVIsIHBsYXRmb3JtKX0uLi5gKTtcbiAgYXdhaXQgZnMubWtkaXIoQ0RfQkFTRV9ESVIpO1xuICBhd2FpdCBmcy5ta2RpcihwYXRoLnJlc29sdmUoQ0RfQkFTRV9ESVIsIHBsYXRmb3JtKSk7XG5cbiAgLy8gY29weSB0aGUgZXh0cmFjdGVkIGJpbmFyeSB0byB0aGUgY29ycmVjdCBidWlsZCBkaXJcbiAgbGV0IG5ld0JpbiA9IGF3YWl0IGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgocGxhdGZvcm0sIGFyY2gpO1xuICBsb2cuaW5mbyhgQ29weWluZyB1bnppcHBlZCBiaW5hcnksIHJlYWRpbmcgZnJvbSAke2V4dHJhY3RlZEJpbn0uLi5gKTtcbiAgbGV0IGJpbkNvbnRlbnRzID0gYXdhaXQgZnMucmVhZEZpbGUoZXh0cmFjdGVkQmluLCB7ZW5jb2Rpbmc6ICdiaW5hcnknfSk7XG4gIGxvZy5pbmZvKGBXcml0aW5nIHRvICR7bmV3QmlufS4uLmApO1xuICBhd2FpdCBmcy53cml0ZUZpbGUobmV3QmluLCBiaW5Db250ZW50cywge2VuY29kaW5nOiAnYmluYXJ5JywgbW9kZTogMG83NTV9KTtcbiAgbG9nLmluZm8oYCR7bmV3QmlufSBzdWNjZXNzZnVsbHkgcHV0IGluIHBsYWNlYCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGwgKCkge1xuICBsZXQge2FyY2gsIHBsYXRmb3JtfSA9IGF3YWl0IGdldEFyY2hBbmRQbGF0Zm9ybSgpO1xuICBhd2FpdCBpbnN0YWxsRm9yUGxhdGZvcm0oQ0RfVkVSLCBwbGF0Zm9ybSwgYXJjaCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbmRpdGlvbmFsSW5zdGFsbCAoKSB7XG4gIGxldCB7YXJjaCwgcGxhdGZvcm19ID0gYXdhaXQgZ2V0QXJjaEFuZFBsYXRmb3JtKCk7XG4gIGxldCBiaW5QYXRoID0gYXdhaXQgZ2V0Q2hyb21lZHJpdmVyQmluYXJ5UGF0aChwbGF0Zm9ybSwgYXJjaCk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGJpblBhdGgpKSB7XG4gICAgYXdhaXQgaW5zdGFsbEZvclBsYXRmb3JtKENEX1ZFUiwgcGxhdGZvcm0sIGFyY2gpO1xuICB9IGVsc2Uge1xuICAgIGxvZy5pbmZvKGBObyBuZWVkIHRvIGluc3RhbGwgY2hyb21lZHJpdmVyLCAke2JpblBhdGh9IGV4aXN0c2ApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxBbGwgKCkge1xuICBjb25zdCBwbGF0cyA9IFtcbiAgICBbJ2xpbnV4JywgJzMyJ10sXG4gICAgWydsaW51eCcsICc2NCddLFxuICAgIFsnd2luJywgJzMyJ10sXG4gIF07XG4gIC8vIGJlZm9yZSAyLjIzIE1hYyB2ZXJzaW9uIHdhcyAzMiBiaXQuIEFmdGVyIGl0IGlzIDY0LlxuICBwbGF0cy5wdXNoKHBhcnNlRmxvYXQoQ0RfVkVSKSA8IDIuMjMgPyBbJ21hYycsICczMiddIDogWydtYWMnLCAnNjQnXSk7XG4gIGxldCBkb3dubG9hZHMgPSBbXTtcbiAgZm9yIChsZXQgW3BsYXRmb3JtLCBhcmNoXSBvZiBwbGF0cykge1xuICAgIGRvd25sb2Fkcy5wdXNoKGluc3RhbGxGb3JQbGF0Zm9ybShDRF9WRVIsIHBsYXRmb3JtLCBhcmNoKSk7XG4gIH1cbiAgYXdhaXQgbGwoZG93bmxvYWRzKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZG9JbnN0YWxsICgpIHtcbiAgaWYgKF8uY29udGFpbnMocHJvY2Vzcy5hcmd2LCAnLS1hbGwnKSB8fFxuICAgICAgcHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19jaHJvbWVkcml2ZXJfaW5zdGFsbF9hbGwpIHtcbiAgICBhd2FpdCBpbnN0YWxsQWxsKCk7XG4gIH0gZWxzZSBpZiAoXy5jb250YWlucyhwcm9jZXNzLmFyZ3YsICctLWNvbmRpdGlvbmFsJykpIHtcbiAgICBhd2FpdCBjb25kaXRpb25hbEluc3RhbGwoKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCBpbnN0YWxsKCk7XG4gIH1cbn1cblxuZXhwb3J0IHsgZ2V0Q2hyb21lZHJpdmVyQmluYXJ5UGF0aCwgaW5zdGFsbCwgaW5zdGFsbEFsbCwgQ0RfQkFTRV9ESVIsXG4gICAgICAgICBnZXRDdXJQbGF0Zm9ybSwgY29uZGl0aW9uYWxJbnN0YWxsLCBkb0luc3RhbGwgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
