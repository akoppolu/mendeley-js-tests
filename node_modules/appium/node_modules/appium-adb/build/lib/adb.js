'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _toolsIndexJs = require('./tools/index.js');

var _toolsIndexJs2 = _interopRequireDefault(_toolsIndexJs);

var _helpers = require('./helpers');

var DEFAULT_ADB_PORT = 5037;
var JAR_PATH = _path2['default'].resolve(_helpers.rootDir, 'jars');
var DEFAULT_OPTS = {
  sdkRoot: null,
  udid: null,
  appDeviceReadyTimeout: null,
  useKeystore: null,
  keystorePath: null,
  keystorePassword: null,
  keyAlias: null,
  keyPassword: null,
  executable: { path: "adb", defaultArgs: [] },
  tmpDir: _os2['default'].tmpdir(),
  curDeviceId: null,
  emulatorPort: null,
  logcat: null,
  binaries: {},
  instrumentProc: null,
  javaVersion: null,
  suppressKillServer: null,
  jars: {},
  helperJarPath: JAR_PATH,
  adbPort: DEFAULT_ADB_PORT
};

var ADB = (function () {
  function ADB() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, ADB);

    if (typeof opts.sdkRoot === "undefined") {
      opts.sdkRoot = process.env.ANDROID_HOME || '';
    }

    _Object$assign(this, opts);
    _lodash2['default'].defaultsDeep(this, _lodash2['default'].cloneDeep(DEFAULT_OPTS));

    if (opts.remoteAdbHost) {
      this.executable.defaultArgs.push("-H", opts.remoteAdbHost);
    }
    // TODO figure out why we have this option as it does not appear to be
    // used anywhere. Probably deprecate in favor of simple opts.adbPort
    if (opts.remoteAdbPort) {
      this.adbPort = opts.remoteAdbPort;
    }
    this.executable.defaultArgs.push("-P", this.adbPort);

    this.initJars();
  }

  _createClass(ADB, [{
    key: 'initJars',
    value: function initJars() {
      var tempJars = ['move_manifest.jar', 'sign.jar', 'appium_apk_tools.jar', 'unsign.jar', 'verify.jar'];
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = _getIterator(tempJars), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var jarName = _step.value;

          this.jars[jarName] = _path2['default'].resolve(JAR_PATH, jarName);
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      if (!this.javaVersion || parseFloat(this.javaVersion) < 1.7) {
        this.jars['appium_apk_tools.jar'] = _path2['default'].resolve(JAR_PATH, 'appium_apk_tools_1.6.jar');
      }
    }
  }]);

  return ADB;
})();

ADB.createADB = function callee$0$0(opts) {
  var adb;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        adb = new ADB(opts);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(adb.getAdbWithCorrectAdbPath());

      case 3:
        return context$1$0.abrupt('return', adb);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// add all the methods to the ADB prototype
var _iteratorNormalCompletion2 = true;
var _didIteratorError2 = false;
var _iteratorError2 = undefined;

try {
  for (var _iterator2 = _getIterator(_lodash2['default'].pairs(_toolsIndexJs2['default'])), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
    var _step2$value = _slicedToArray(_step2.value, 2);

    var fnName = _step2$value[0];
    var fn = _step2$value[1];

    ADB.prototype[fnName] = fn;
  }
} catch (err) {
  _didIteratorError2 = true;
  _iteratorError2 = err;
} finally {
  try {
    if (!_iteratorNormalCompletion2 && _iterator2['return']) {
      _iterator2['return']();
    }
  } finally {
    if (_didIteratorError2) {
      throw _iteratorError2;
    }
  }
}

exports['default'] = ADB;
exports.DEFAULT_ADB_PORT = DEFAULT_ADB_PORT;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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bUNULEdBQUcsQ0FBQyxTQUFTLEdBQUcsb0JBQWdCLElBQUk7TUFDOUIsR0FBRzs7OztBQUFILFdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUM7O3lDQUNqQixHQUFHLENBQUMsd0JBQXdCLEVBQUU7Ozs0Q0FDN0IsR0FBRzs7Ozs7OztDQUNYLENBQUM7Ozs7Ozs7O0FBR0YscUNBQXlCLG9CQUFFLEtBQUssMkJBQVMsaUhBQUU7OztRQUFqQyxNQUFNO1FBQUUsRUFBRTs7QUFDbEIsT0FBRyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7R0FDNUI7Ozs7Ozs7Ozs7Ozs7Ozs7cUJBRWMsR0FBRztRQUNULGdCQUFnQixHQUFoQixnQkFBZ0IiLCJmaWxlIjoibGliL2FkYi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgbWV0aG9kcyBmcm9tICcuL3Rvb2xzL2luZGV4LmpzJztcbmltcG9ydCB7IHJvb3REaXJ9IGZyb20gJy4vaGVscGVycyc7XG5cbmNvbnN0IERFRkFVTFRfQURCX1BPUlQgPSA1MDM3O1xuY29uc3QgSkFSX1BBVEggPSBwYXRoLnJlc29sdmUocm9vdERpciwgJ2phcnMnKTtcbmNvbnN0IERFRkFVTFRfT1BUUyA9IHtcbiAgc2RrUm9vdDogbnVsbCxcbiAgdWRpZDogbnVsbCxcbiAgYXBwRGV2aWNlUmVhZHlUaW1lb3V0OiBudWxsLFxuICB1c2VLZXlzdG9yZTogbnVsbCxcbiAga2V5c3RvcmVQYXRoOiBudWxsLFxuICBrZXlzdG9yZVBhc3N3b3JkOiBudWxsLFxuICBrZXlBbGlhczogbnVsbCxcbiAga2V5UGFzc3dvcmQ6IG51bGwsXG4gIGV4ZWN1dGFibGU6IHtwYXRoOiBcImFkYlwiLCBkZWZhdWx0QXJnczogW119LFxuICB0bXBEaXI6IG9zLnRtcGRpcigpLFxuICBjdXJEZXZpY2VJZDogbnVsbCxcbiAgZW11bGF0b3JQb3J0IDogbnVsbCxcbiAgbG9nY2F0OiBudWxsLFxuICBiaW5hcmllczoge30sXG4gIGluc3RydW1lbnRQcm9jOiBudWxsLFxuICBqYXZhVmVyc2lvbjogbnVsbCxcbiAgc3VwcHJlc3NLaWxsU2VydmVyOiBudWxsLFxuICBqYXJzOiB7fSxcbiAgaGVscGVySmFyUGF0aDogSkFSX1BBVEgsXG4gIGFkYlBvcnQ6IERFRkFVTFRfQURCX1BPUlRcbn07XG5cbmNsYXNzIEFEQiB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBpZiAodHlwZW9mIG9wdHMuc2RrUm9vdCA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgb3B0cy5zZGtSb290ID0gcHJvY2Vzcy5lbnYuQU5EUk9JRF9IT01FIHx8ICcnO1xuICAgIH1cblxuICAgIE9iamVjdC5hc3NpZ24odGhpcywgb3B0cyk7XG4gICAgXy5kZWZhdWx0c0RlZXAodGhpcywgXy5jbG9uZURlZXAoREVGQVVMVF9PUFRTKSk7XG5cbiAgICBpZiAob3B0cy5yZW1vdGVBZGJIb3N0KSB7XG4gICAgICB0aGlzLmV4ZWN1dGFibGUuZGVmYXVsdEFyZ3MucHVzaChcIi1IXCIsIG9wdHMucmVtb3RlQWRiSG9zdCk7XG4gICAgfVxuICAgIC8vIFRPRE8gZmlndXJlIG91dCB3aHkgd2UgaGF2ZSB0aGlzIG9wdGlvbiBhcyBpdCBkb2VzIG5vdCBhcHBlYXIgdG8gYmVcbiAgICAvLyB1c2VkIGFueXdoZXJlLiBQcm9iYWJseSBkZXByZWNhdGUgaW4gZmF2b3Igb2Ygc2ltcGxlIG9wdHMuYWRiUG9ydFxuICAgIGlmIChvcHRzLnJlbW90ZUFkYlBvcnQpIHtcbiAgICAgIHRoaXMuYWRiUG9ydCA9IG9wdHMucmVtb3RlQWRiUG9ydDtcbiAgICB9XG4gICAgdGhpcy5leGVjdXRhYmxlLmRlZmF1bHRBcmdzLnB1c2goXCItUFwiLCB0aGlzLmFkYlBvcnQpO1xuXG4gICAgdGhpcy5pbml0SmFycygpO1xuICB9XG5cbiAgaW5pdEphcnMgKCkge1xuICAgIGxldCB0ZW1wSmFycyA9IFsnbW92ZV9tYW5pZmVzdC5qYXInLCAnc2lnbi5qYXInLCAnYXBwaXVtX2Fwa190b29scy5qYXInLFxuICAgICAgICAgICAgICAgICAgICAndW5zaWduLmphcicsICd2ZXJpZnkuamFyJ107XG4gICAgZm9yIChsZXQgamFyTmFtZSBvZiB0ZW1wSmFycykge1xuICAgICAgdGhpcy5qYXJzW2phck5hbWVdID0gcGF0aC5yZXNvbHZlKEpBUl9QQVRILCBqYXJOYW1lKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmphdmFWZXJzaW9uIHx8IHBhcnNlRmxvYXQodGhpcy5qYXZhVmVyc2lvbikgPCAxLjcpIHtcbiAgICAgIHRoaXMuamFyc1snYXBwaXVtX2Fwa190b29scy5qYXInXSA9IHBhdGgucmVzb2x2ZShKQVJfUEFUSCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXBwaXVtX2Fwa190b29sc18xLjYuamFyJyk7XG4gICAgfVxuICB9XG59XG5cbkFEQi5jcmVhdGVBREIgPSBhc3luYyBmdW5jdGlvbiAob3B0cykge1xuICBsZXQgYWRiID0gbmV3IEFEQihvcHRzKTtcbiAgYXdhaXQgYWRiLmdldEFkYldpdGhDb3JyZWN0QWRiUGF0aCgpO1xuICByZXR1cm4gYWRiO1xufTtcblxuLy8gYWRkIGFsbCB0aGUgbWV0aG9kcyB0byB0aGUgQURCIHByb3RvdHlwZVxuZm9yIChsZXQgW2ZuTmFtZSwgZm5dIG9mIF8ucGFpcnMobWV0aG9kcykpIHtcbiAgQURCLnByb3RvdHlwZVtmbk5hbWVdID0gZm47XG59XG5cbmV4cG9ydCBkZWZhdWx0IEFEQjtcbmV4cG9ydCB7IERFRkFVTFRfQURCX1BPUlQgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
