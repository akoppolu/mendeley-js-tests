'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _2 = require('../../..');

var _3 = _interopRequireDefault(_2);

var _libCommandsPerformance = require('../../../lib/commands/performance');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _desired = require('../desired');

var _desired2 = _interopRequireDefault(_desired);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

var driver = undefined;
var caps = _lodash2['default'].defaults({
  appPackage: 'io.appium.android.apis',
  appActivity: '.view.TextFields'
}, _desired2['default']);

describe('performance', function () {
  before(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          driver = new _3['default']();
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(driver.createSession(caps));

        case 3:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  after(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(driver.deleteSession());

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  describe('getPerformanceData', function () {
    it('should get the performancedata', function callee$2$0() {
      var capability;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.getPerformanceDataTypes());

          case 2:
            capability = context$3$0.sent;

            capability.should.eql(_lodash2['default'].keys(_libCommandsPerformance.SUPPORTED_PERFORMANCE_DATA_TYPES));

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should throw an Error for unsupported capability data type ', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.getPerformanceData(caps.appPackage, 'randominfo', 2).should.be.rejected);

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should get the amount of cpu by user and kernel process', function callee$2$0() {
      var apiLevel, cpu, i;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.adb.getApiLevel());

          case 2:
            apiLevel = context$3$0.sent;

            if (!(apiLevel === '25' || apiLevel === '24' || apiLevel === '21')) {
              context$3$0.next = 5;
              break;
            }

            return context$3$0.abrupt('return', this.skip());

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(driver.getPerformanceData(caps.appPackage, 'cpuinfo', 50));

          case 7:
            cpu = context$3$0.sent;

            Array.isArray(cpu).should.be['true'];
            cpu.length.should.be.above(1);
            cpu[0].should.eql(_libCommandsPerformance.CPU_KEYS);
            if (cpu.length > 1) {
              for (i = 1; i < cpu.length; i++) {
                cpu[0].length.should.equal(cpu[i].length);
              }
            }

          case 12:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
    it('should get the amount of memory used by the process', function callee$2$0() {
      var memory, i;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.getPerformanceData(caps.appPackage, 'memoryinfo', 2));

          case 2:
            memory = context$3$0.sent;

            Array.isArray(memory).should.be['true'];
            memory.length.should.be.above(1);
            memory[0].should.eql(_libCommandsPerformance.MEMORY_KEYS);
            if (memory.length > 1) {
              for (i = 1; i < memory.length; i++) {
                memory[0].length.should.equal(memory[i].length);
              }
            }

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should get the remaining battery power', function callee$2$0() {
      var battery, i;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.getPerformanceData(caps.appPackage, 'batteryinfo', 2));

          case 2:
            battery = context$3$0.sent;

            Array.isArray(battery).should.be['true'];
            battery.length.should.be.above(1);
            battery[0].should.eql(_libCommandsPerformance.BATTERY_KEYS);
            if (battery.length > 1) {
              for (i = 1; i < battery.length; i++) {
                battery[0].length.should.equal(battery[i].length);
              }
            }

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should get the network statistics', function callee$2$0() {
      var network, compare, j, i;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.adb.getApiLevel());

          case 2:
            context$3$0.t0 = context$3$0.sent;

            if (!(context$3$0.t0 === '22')) {
              context$3$0.next = 5;
              break;
            }

            return context$3$0.abrupt('return', this.skip());

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(driver.getPerformanceData(caps.appPackage, 'networkinfo', 2));

          case 7:
            network = context$3$0.sent;

            Array.isArray(network).should.be['true'];
            network.length.should.be.above(1);

            compare = false;

            for (j = 0; j < _libCommandsPerformance.NETWORK_KEYS.length; ++j) {
              if (_lodash2['default'].isEqual(_libCommandsPerformance.NETWORK_KEYS[j], network[0])) {
                compare = true;
              }
            }

            compare.should.equal(true);

            if (network.length > 1) {
              for (i = 1; i < network.length; ++i) {
                network[0].length.should.equal(network[i].length);
              }
            }

          case 14:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
  });
});

// TODO: why does this fail?

// TODO: why does adb fail with a null pointer exception on 5.1
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZnVuY3Rpb25hbC9jb21tYW5kcy9wZXJmb3JtYW5jZS1lMmUtc3BlY3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7b0JBQWlCLE1BQU07Ozs7OEJBQ0ksa0JBQWtCOzs7O2lCQUNuQixVQUFVOzs7O3NDQUNnRSxtQ0FBbUM7O3NCQUN6SCxRQUFROzs7O3VCQUNHLFlBQVk7Ozs7QUFHckMsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDZCxrQkFBSyxHQUFHLDZCQUFnQixDQUFDOztBQUV6QixJQUFJLE1BQU0sWUFBQSxDQUFDO0FBQ1gsSUFBSSxJQUFJLEdBQUcsb0JBQUUsUUFBUSxDQUFDO0FBQ3BCLFlBQVUsRUFBRSx3QkFBd0I7QUFDcEMsYUFBVyxFQUFFLGtCQUFrQjtDQUNoQyx1QkFBZSxDQUFDOztBQUVqQixRQUFRLENBQUMsYUFBYSxFQUFFLFlBQU07QUFDNUIsUUFBTSxDQUFDOzs7O0FBQ0wsZ0JBQU0sR0FBRyxtQkFBbUIsQ0FBQzs7MkNBQ3ZCLE1BQU0sQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDOzs7Ozs7O0dBQ2pDLENBQUMsQ0FBQztBQUNILE9BQUssQ0FBQzs7Ozs7MkNBQ0UsTUFBTSxDQUFDLGFBQWEsRUFBRTs7Ozs7OztHQUM3QixDQUFDLENBQUM7O0FBRUgsVUFBUSxDQUFDLG9CQUFvQixFQUFFLFlBQU07QUFDbkMsTUFBRSxDQUFDLGdDQUFnQyxFQUFFO1VBQy9CLFVBQVU7Ozs7OzZDQUFTLE1BQU0sQ0FBQyx1QkFBdUIsRUFBRTs7O0FBQW5ELHNCQUFVOztBQUNkLHNCQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxvQkFBRSxJQUFJLDBEQUFrQyxDQUFDLENBQUM7Ozs7Ozs7S0FDakUsQ0FBQyxDQUFDOztBQUVILE1BQUUsQ0FBQyw2REFBNkQsRUFBRTs7Ozs7NkNBQzFELE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFN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QUFFLEVBQUUsQ0FBQyxFQUFFO0FBQ3ZDLHVCQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2VBQ25EO2FBQ0Y7Ozs7Ozs7S0FDRixDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC9mdW5jdGlvbmFsL2NvbW1hbmRzL3BlcmZvcm1hbmNlLWUyZS1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IEFuZHJvaWREcml2ZXIgZnJvbSAnLi4vLi4vLi4nO1xuaW1wb3J0IHsgU1VQUE9SVEVEX1BFUkZPUk1BTkNFX0RBVEFfVFlQRVMsIENQVV9LRVlTLCBNRU1PUllfS0VZUywgQkFUVEVSWV9LRVlTLCBORVRXT1JLX0tFWVMgfSBmcm9tICcuLi8uLi8uLi9saWIvY29tbWFuZHMvcGVyZm9ybWFuY2UnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBERUZBVUxUX0NBUFMgZnJvbSAnLi4vZGVzaXJlZCc7XG5cblxuY2hhaS5zaG91bGQoKTtcbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcblxubGV0IGRyaXZlcjtcbmxldCBjYXBzID0gXy5kZWZhdWx0cyh7XG4gIGFwcFBhY2thZ2U6ICdpby5hcHBpdW0uYW5kcm9pZC5hcGlzJyxcbiAgYXBwQWN0aXZpdHk6ICcudmlldy5UZXh0RmllbGRzJ1xufSwgREVGQVVMVF9DQVBTKTtcblxuZGVzY3JpYmUoJ3BlcmZvcm1hbmNlJywgKCkgPT4ge1xuICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgIGRyaXZlciA9IG5ldyBBbmRyb2lkRHJpdmVyKCk7XG4gICAgYXdhaXQgZHJpdmVyLmNyZWF0ZVNlc3Npb24oY2Fwcyk7XG4gIH0pO1xuICBhZnRlcihhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgZHJpdmVyLmRlbGV0ZVNlc3Npb24oKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dldFBlcmZvcm1hbmNlRGF0YScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGdldCB0aGUgcGVyZm9ybWFuY2VkYXRhJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGNhcGFiaWxpdHkgPSBhd2FpdCBkcml2ZXIuZ2V0UGVyZm9ybWFuY2VEYXRhVHlwZXMoKTtcbiAgICAgIGNhcGFiaWxpdHkuc2hvdWxkLmVxbChfLmtleXMoU1VQUE9SVEVEX1BFUkZPUk1BTkNFX0RBVEFfVFlQRVMpKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgYW4gRXJyb3IgZm9yIHVuc3VwcG9ydGVkIGNhcGFiaWxpdHkgZGF0YSB0eXBlICcsIGFzeW5jICAoKSA9PiB7XG4gICAgICBhd2FpdCBkcml2ZXIuZ2V0UGVyZm9ybWFuY2VEYXRhKGNhcHMuYXBwUGFja2FnZSwgJ3JhbmRvbWluZm8nLCAyKS5zaG91bGQuYmUucmVqZWN0ZWQ7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGdldCB0aGUgYW1vdW50IG9mIGNwdSBieSB1c2VyIGFuZCBrZXJuZWwgcHJvY2VzcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vIFRPRE86IHdoeSBkb2VzIHRoaXMgZmFpbD9cbiAgICAgIGxldCBhcGlMZXZlbCA9IGF3YWl0IGRyaXZlci5hZGIuZ2V0QXBpTGV2ZWwoKTtcbiAgICAgIGlmIChhcGlMZXZlbCA9PT0gJzI1JyB8fCBhcGlMZXZlbCA9PT0gJzI0JyB8fCBhcGlMZXZlbCA9PT0gJzIxJykge1xuICAgICAgICByZXR1cm4gdGhpcy5za2lwKCk7XG4gICAgICB9XG4gICAgICBsZXQgY3B1ID0gYXdhaXQgZHJpdmVyLmdldFBlcmZvcm1hbmNlRGF0YShjYXBzLmFwcFBhY2thZ2UsICdjcHVpbmZvJywgNTApO1xuXG4gICAgICBBcnJheS5pc0FycmF5KGNwdSkuc2hvdWxkLmJlLnRydWU7XG4gICAgICBjcHUubGVuZ3RoLnNob3VsZC5iZS5hYm92ZSgxKTtcbiAgICAgIGNwdVswXS5zaG91bGQuZXFsKENQVV9LRVlTKTtcbiAgICAgIGlmIChjcHUubGVuZ3RoID4gMSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGNwdS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGNwdVswXS5sZW5ndGguc2hvdWxkLmVxdWFsKGNwdVtpXS5sZW5ndGgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBnZXQgdGhlIGFtb3VudCBvZiBtZW1vcnkgdXNlZCBieSB0aGUgcHJvY2VzcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBtZW1vcnkgPSBhd2FpdCBkcml2ZXIuZ2V0UGVyZm9ybWFuY2VEYXRhKGNhcHMuYXBwUGFja2FnZSwgJ21lbW9yeWluZm8nLCAyKTtcblxuICAgICAgQXJyYXkuaXNBcnJheShtZW1vcnkpLnNob3VsZC5iZS50cnVlO1xuICAgICAgbWVtb3J5Lmxlbmd0aC5zaG91bGQuYmUuYWJvdmUoMSk7XG4gICAgICBtZW1vcnlbMF0uc2hvdWxkLmVxbChNRU1PUllfS0VZUyk7XG4gICAgICBpZiAobWVtb3J5Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBtZW1vcnkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBtZW1vcnlbMF0ubGVuZ3RoLnNob3VsZC5lcXVhbChtZW1vcnlbaV0ubGVuZ3RoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgZ2V0IHRoZSByZW1haW5pbmcgYmF0dGVyeSBwb3dlcicsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBiYXR0ZXJ5ID0gYXdhaXQgZHJpdmVyLmdldFBlcmZvcm1hbmNlRGF0YShjYXBzLmFwcFBhY2thZ2UsICdiYXR0ZXJ5aW5mbycsIDIpO1xuXG4gICAgICBBcnJheS5pc0FycmF5KGJhdHRlcnkpLnNob3VsZC5iZS50cnVlO1xuICAgICAgYmF0dGVyeS5sZW5ndGguc2hvdWxkLmJlLmFib3ZlKDEpO1xuICAgICAgYmF0dGVyeVswXS5zaG91bGQuZXFsKEJBVFRFUllfS0VZUyk7XG4gICAgICBpZiAoYmF0dGVyeS5sZW5ndGggPiAxKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgYmF0dGVyeS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGJhdHRlcnlbMF0ubGVuZ3RoLnNob3VsZC5lcXVhbChiYXR0ZXJ5W2ldLmxlbmd0aCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGdldCB0aGUgbmV0d29yayBzdGF0aXN0aWNzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgLy8gVE9ETzogd2h5IGRvZXMgYWRiIGZhaWwgd2l0aCBhIG51bGwgcG9pbnRlciBleGNlcHRpb24gb24gNS4xXG4gICAgICBpZiAoYXdhaXQgZHJpdmVyLmFkYi5nZXRBcGlMZXZlbCgpID09PSAnMjInKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNraXAoKTtcbiAgICAgIH1cbiAgICAgIGxldCBuZXR3b3JrID0gYXdhaXQgZHJpdmVyLmdldFBlcmZvcm1hbmNlRGF0YShjYXBzLmFwcFBhY2thZ2UsICduZXR3b3JraW5mbycsIDIpO1xuXG4gICAgICBBcnJheS5pc0FycmF5KG5ldHdvcmspLnNob3VsZC5iZS50cnVlO1xuICAgICAgbmV0d29yay5sZW5ndGguc2hvdWxkLmJlLmFib3ZlKDEpO1xuXG4gICAgICBsZXQgY29tcGFyZSA9IGZhbHNlO1xuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBORVRXT1JLX0tFWVMubGVuZ3RoOyArK2opIHtcbiAgICAgICAgaWYgKF8uaXNFcXVhbChORVRXT1JLX0tFWVNbal0sIG5ldHdvcmtbMF0pKSB7XG4gICAgICAgICAgY29tcGFyZSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29tcGFyZS5zaG91bGQuZXF1YWwodHJ1ZSk7XG5cbiAgICAgIGlmIChuZXR3b3JrLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBuZXR3b3JrLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgbmV0d29ya1swXS5sZW5ndGguc2hvdWxkLmVxdWFsKG5ldHdvcmtbaV0ubGVuZ3RoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9
