'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _2 = require('../..');

var _helpers = require('./helpers');

var _desired = require('./desired');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

var AVD_ANDROID_24_WITHOUT_GMS = process.env.ANDROID_24_NO_GMS_AVD || 'Nexus_5_API_24';
var CHROMEDRIVER_2_20_EXECUTABLE = process.env.CHROME_2_20_EXECUTABLE;

// for reasons that remain unclear, this particular webview-based browser
// will not connect to localhost/loopback, even on emulators
var HOST = _appiumSupport.util.localIp();
var PORT = 4723;

describe('Android 7 Webview Browser tester', function () {
  var _this = this;

  var driver = undefined;
  var server = undefined;

  before(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          if (!process.env.REAL_DEVICE) {
            context$2$0.next = 2;
            break;
          }

          return context$2$0.abrupt('return', this.skip());

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _helpers.ensureAVDExists)(this, AVD_ANDROID_24_WITHOUT_GMS));

        case 4:
          if (context$2$0.sent) {
            context$2$0.next = 6;
            break;
          }

          return context$2$0.abrupt('return');

        case 6:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });
  beforeEach(function callee$1$0() {
    var capabilities;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.t0 = _lodash2['default'];
          context$2$0.t1 = AVD_ANDROID_24_WITHOUT_GMS;
          context$2$0.t2 = CHROMEDRIVER_2_20_EXECUTABLE;

          if (context$2$0.t2) {
            context$2$0.next = 7;
            break;
          }

          context$2$0.next = 6;
          return _regeneratorRuntime.awrap((0, _helpers.getChromedriver220Asset)());

        case 6:
          context$2$0.t2 = context$2$0.sent;

        case 7:
          context$2$0.t3 = context$2$0.t2;
          context$2$0.t4 = {
            browserName: 'chromium-webview',
            avd: context$2$0.t1,
            platformVersion: '7.0',
            chromedriverExecutable: context$2$0.t3
          };
          context$2$0.t5 = _desired.CHROME_CAPS;
          capabilities = context$2$0.t0.defaults.call(context$2$0.t0, context$2$0.t4, context$2$0.t5);

          driver = new _2.AndroidDriver();
          context$2$0.next = 14;
          return _regeneratorRuntime.awrap(driver.createSession(capabilities));

        case 14:
          context$2$0.next = 16;
          return _regeneratorRuntime.awrap((0, _2.startServer)(PORT, HOST));

        case 16:
          server = context$2$0.sent;

        case 17:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  afterEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          if (!driver) {
            context$2$0.next = 3;
            break;
          }

          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(driver.deleteSession());

        case 3:
          if (!server) {
            context$2$0.next = 6;
            break;
          }

          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(server.close());

        case 6:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('should start android session using webview browser tester', function callee$1$0() {
    var el;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(driver.setUrl('http://' + HOST + ':' + PORT + '/test/guinea-pig'));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(driver.getCurrentContext().should.eventually.eql("CHROMIUM"));

        case 4:
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(driver.findElOrEls('id', 'i am a link', false));

        case 6:
          el = context$2$0.sent;
          context$2$0.next = 9;
          return _regeneratorRuntime.awrap(driver.click(el.ELEMENT));

        case 9:
          context$2$0.next = 11;
          return _regeneratorRuntime.awrap(driver.findElOrEls('id', 'I am another page title', false));

        case 11:
          el = context$2$0.sent;

          el.should.exist;

        case 13:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});

// await driver.setUrl('http://google.com');

// make sure we are in the right context
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZnVuY3Rpb25hbC93ZWJ2aWV3LWJyb3dzZXItdGVzdGVyLWUyZS1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7b0JBQWlCLE1BQU07Ozs7OEJBQ0ksa0JBQWtCOzs7O2lCQUNGLE9BQU87O3VCQUNPLFdBQVc7O3VCQUN4QyxXQUFXOztzQkFDekIsUUFBUTs7Ozs2QkFDRCxnQkFBZ0I7O0FBR3JDLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQ2Qsa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQzs7QUFFekIsSUFBTSwwQkFBMEIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixJQUFJLGdCQUFnQixDQUFDO0FBQ3pGLElBQU0sNEJBQTRCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQzs7OztBQUl4RSxJQUFNLElBQUksR0FBRyxvQkFBSyxPQUFPLEVBQUUsQ0FBQztBQUM1QixJQUFNLElBQUksR0FBRyxJQUFJLENBQUM7O0FBRWxCLFFBQVEsQ0FBQyxrQ0FBa0MsRUFBRSxZQUFZOzs7QUFDdkQsTUFBSSxNQUFNLFlBQUEsQ0FBQztBQUNYLE1BQUksTUFBTSxZQUFBLENBQUM7O0FBRVgsUUFBTSxDQUFDOzs7O2VBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXOzs7Ozs4Q0FDbEIsSUFBSSxDQUFDLElBQUksRUFBRTs7OzsyQ0FFVCw4QkFBZ0IsSUFBSSxFQUFFLDBCQUEwQixDQUFDOzs7Ozs7Ozs7Ozs7Ozs7R0FHN0QsQ0FBQyxDQUFDO0FBQ0gsWUFBVSxDQUFDO1FBQ0gsWUFBWTs7Ozs7MkJBRVgsMEJBQTBCOzJCQUVQLDRCQUE0Qjs7Ozs7Ozs7MkNBQVUsdUNBQXlCOzs7Ozs7OztBQUh2Rix1QkFBVyxFQUFFLGtCQUFrQjtBQUMvQixlQUFHO0FBQ0gsMkJBQWUsRUFBRSxLQUFLO0FBQ3RCLGtDQUFzQjs7O0FBSmxCLHNCQUFZLGtCQUFLLFFBQVE7O0FBTy9CLGdCQUFNLEdBQUcsc0JBQW1CLENBQUM7OzJDQUN2QixNQUFNLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQzs7OzsyQ0FDekIsb0JBQVksSUFBSSxFQUFFLElBQUksQ0FBQzs7O0FBQXRDLGdCQUFNOzs7Ozs7O0dBQ1AsQ0FBQyxDQUFDO0FBQ0gsV0FBUyxDQUFDOzs7O2VBQ0osTUFBTTs7Ozs7OzJDQUNGLE1BQU0sQ0FBQyxhQUFhLEVBQUU7OztlQUUxQixNQUFNOzs7Ozs7MkNBQ0YsTUFBTSxDQUFDLEtBQUssRUFBRTs7Ozs7OztHQUV2QixDQUFDLENBQUM7O0FBRUgsSUFBRSxDQUFDLDJEQUEyRCxFQUFFO1FBTzFELEVBQUU7Ozs7OzJDQUxBLE1BQU0sQ0FBQyxNQUFNLGFBQVcsSUFBSSxTQUFJLElBQUksc0JBQW1COzs7OzJDQUd2RCxNQUFNLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7Ozs7MkNBRW5ELE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRSxLQUFLLENBQUM7OztBQUF6RCxZQUFFOzsyQ0FDQSxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUM7Ozs7MkNBRW5CLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLHlCQUF5QixFQUFFLEtBQUssQ0FBQzs7O0FBQXJFLFlBQUU7O0FBQ0YsWUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7Ozs7Ozs7R0FDakIsQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6InRlc3QvZnVuY3Rpb25hbC93ZWJ2aWV3LWJyb3dzZXItdGVzdGVyLWUyZS1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IHsgQW5kcm9pZERyaXZlciwgc3RhcnRTZXJ2ZXIgfSBmcm9tICcuLi8uLic7XG5pbXBvcnQgeyBlbnN1cmVBVkRFeGlzdHMsIGdldENocm9tZWRyaXZlcjIyMEFzc2V0IH0gZnJvbSAnLi9oZWxwZXJzJztcbmltcG9ydCB7IENIUk9NRV9DQVBTIH0gZnJvbSAnLi9kZXNpcmVkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuXG5cbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmNvbnN0IEFWRF9BTkRST0lEXzI0X1dJVEhPVVRfR01TID0gcHJvY2Vzcy5lbnYuQU5EUk9JRF8yNF9OT19HTVNfQVZEIHx8ICdOZXh1c181X0FQSV8yNCc7XG5jb25zdCBDSFJPTUVEUklWRVJfMl8yMF9FWEVDVVRBQkxFID0gcHJvY2Vzcy5lbnYuQ0hST01FXzJfMjBfRVhFQ1VUQUJMRTtcblxuLy8gZm9yIHJlYXNvbnMgdGhhdCByZW1haW4gdW5jbGVhciwgdGhpcyBwYXJ0aWN1bGFyIHdlYnZpZXctYmFzZWQgYnJvd3NlclxuLy8gd2lsbCBub3QgY29ubmVjdCB0byBsb2NhbGhvc3QvbG9vcGJhY2ssIGV2ZW4gb24gZW11bGF0b3JzXG5jb25zdCBIT1NUID0gdXRpbC5sb2NhbElwKCk7XG5jb25zdCBQT1JUID0gNDcyMztcblxuZGVzY3JpYmUoJ0FuZHJvaWQgNyBXZWJ2aWV3IEJyb3dzZXIgdGVzdGVyJywgZnVuY3Rpb24gKCkge1xuICBsZXQgZHJpdmVyO1xuICBsZXQgc2VydmVyO1xuXG4gIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHByb2Nlc3MuZW52LlJFQUxfREVWSUNFKSB7XG4gICAgICByZXR1cm4gdGhpcy5za2lwKCk7XG4gICAgfVxuICAgIGlmICghYXdhaXQgZW5zdXJlQVZERXhpc3RzKHRoaXMsIEFWRF9BTkRST0lEXzI0X1dJVEhPVVRfR01TKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfSk7XG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGNhcGFiaWxpdGllcyA9IF8uZGVmYXVsdHMoe1xuICAgICAgYnJvd3Nlck5hbWU6ICdjaHJvbWl1bS13ZWJ2aWV3JyxcbiAgICAgIGF2ZDogQVZEX0FORFJPSURfMjRfV0lUSE9VVF9HTVMsXG4gICAgICBwbGF0Zm9ybVZlcnNpb246ICc3LjAnLFxuICAgICAgY2hyb21lZHJpdmVyRXhlY3V0YWJsZTogQ0hST01FRFJJVkVSXzJfMjBfRVhFQ1VUQUJMRSB8fCBhd2FpdCBnZXRDaHJvbWVkcml2ZXIyMjBBc3NldCgpLFxuICAgIH0sIENIUk9NRV9DQVBTKTtcblxuICAgIGRyaXZlciA9IG5ldyBBbmRyb2lkRHJpdmVyKCk7XG4gICAgYXdhaXQgZHJpdmVyLmNyZWF0ZVNlc3Npb24oY2FwYWJpbGl0aWVzKTtcbiAgICBzZXJ2ZXIgPSBhd2FpdCBzdGFydFNlcnZlcihQT1JULCBIT1NUKTtcbiAgfSk7XG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgaWYgKGRyaXZlcikge1xuICAgICAgYXdhaXQgZHJpdmVyLmRlbGV0ZVNlc3Npb24oKTtcbiAgICB9XG4gICAgaWYgKHNlcnZlcikge1xuICAgICAgYXdhaXQgc2VydmVyLmNsb3NlKCk7XG4gICAgfVxuICB9KTtcblxuICBpdCgnc2hvdWxkIHN0YXJ0IGFuZHJvaWQgc2Vzc2lvbiB1c2luZyB3ZWJ2aWV3IGJyb3dzZXIgdGVzdGVyJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIGF3YWl0IGRyaXZlci5zZXRVcmwoJ2h0dHA6Ly9nb29nbGUuY29tJyk7XG4gICAgYXdhaXQgZHJpdmVyLnNldFVybChgaHR0cDovLyR7SE9TVH06JHtQT1JUfS90ZXN0L2d1aW5lYS1waWdgKTtcblxuICAgIC8vIG1ha2Ugc3VyZSB3ZSBhcmUgaW4gdGhlIHJpZ2h0IGNvbnRleHRcbiAgICBhd2FpdCBkcml2ZXIuZ2V0Q3VycmVudENvbnRleHQoKS5zaG91bGQuZXZlbnR1YWxseS5lcWwoXCJDSFJPTUlVTVwiKTtcblxuICAgIGxldCBlbCA9IGF3YWl0IGRyaXZlci5maW5kRWxPckVscygnaWQnLCAnaSBhbSBhIGxpbmsnLCBmYWxzZSk7XG4gICAgYXdhaXQgZHJpdmVyLmNsaWNrKGVsLkVMRU1FTlQpO1xuXG4gICAgZWwgPSBhd2FpdCBkcml2ZXIuZmluZEVsT3JFbHMoJ2lkJywgJ0kgYW0gYW5vdGhlciBwYWdlIHRpdGxlJywgZmFsc2UpO1xuICAgIGVsLnNob3VsZC5leGlzdDtcbiAgfSk7XG59KTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
