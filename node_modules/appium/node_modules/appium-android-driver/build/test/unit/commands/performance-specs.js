'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _2 = require('../../..');

var _3 = _interopRequireDefault(_2);

var _libCommandsPerformanceJs = require('../../../lib/commands/performance.js');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumTestSupport = require('appium-test-support');

var _appiumAdb = require('appium-adb');

var _appiumAdb2 = _interopRequireDefault(_appiumAdb);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

var PACKAGE_NAME = 'io.appium.android.apis';

var adb = new _appiumAdb2['default']();
var driver = new _3['default']();
driver.adb = adb;

describe('getperformancedata', (0, _appiumTestSupport.withMocks)({ adb: adb, driver: driver }, function (mocks) {
  it('should get the list of available getPerformance data type', function () {
    var types = driver.getPerformanceDataTypes();
    types.should.eql(_lodash2['default'].keys(_libCommandsPerformanceJs.SUPPORTED_PERFORMANCE_DATA_TYPES));
  });

  function runTest(type, expectedKeys, expectedData) {
    var data;
    return _regeneratorRuntime.async(function runTest$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(driver.getPerformanceData(PACKAGE_NAME, type));

        case 2:
          data = context$2$0.sent;

          // make sure we got something
          Array.isArray(data).should.be['true'];
          data.length.should.eql(2);

          data[0].should.eql(expectedKeys);
          data[1].should.eql(expectedData);

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  }

  var types = [{
    cmd: 'cpuinfo',
    description: 'the amount of cpu by user and kernel process',
    args: ['dumpsys', 'cpuinfo', '|', 'grep', '\'' + PACKAGE_NAME + '\''],
    dumpsysData: ' +0% 2209/io.appium.android.apis: 14% user + 23% kernel',
    keys: _libCommandsPerformanceJs.CPU_KEYS,
    data: ['14', '23']
  }, {
    cmd: 'memoryinfo',
    description: 'the amount of memory used by the process (API level 19)',
    args: ['dumpsys', 'meminfo', '\'' + PACKAGE_NAME + '\'', '|', 'grep', '-E', "'Native|Dalvik|EGL|GL|TOTAL'"],
    dumpsysData: '  Native Heap     2469     2332        0        0    20480    13920     6559\n   Dalvik Heap      873      808        0        0     1526      578      948\n  Dalvik Other      148      148        0        0\n         TOTAL     7757     4012      976        0    22006    14498     7507',
    keys: _libCommandsPerformanceJs.MEMORY_KEYS,
    data: ['4012', '2332', '808', undefined, undefined, '7757', '2469', '873', undefined, undefined, '13920', '20480'],
    apiLevel: '19'
  }, {
    cmd: 'memoryinfo',
    description: 'the amount of memory used by the process (API level 19)',
    args: ['dumpsys', 'meminfo', '\'' + PACKAGE_NAME + '\'', '|', 'grep', '-E', "'Native|Dalvik|EGL|GL|TOTAL'"],
    dumpsysData: 'Native|Dalvik|EGL|GL|TOTAL\'\n       Native     1050     1236      968     7580     7428       31\n       Dalvik     2637     5592     2288     3960     3453      507\n        TOTAL     6796    11688     4288    11540    10881      538',
    keys: _libCommandsPerformanceJs.MEMORY_KEYS,
    data: ['4288', '968', '2288', undefined, undefined, '6796', '1050', '2637', undefined, undefined, '7428', '7580'],
    apiLevel: '18'
  }, {
    cmd: 'batteryinfo',
    description: 'the remaining battery power',
    args: ['dumpsys', 'battery', '|', 'grep', 'level'],
    dumpsysData: '  level: 47',
    keys: _libCommandsPerformanceJs.BATTERY_KEYS,
    data: ['47']
  }];
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    var _loop = function () {
      var type = _step.value;

      describe(type.cmd, function () {
        afterEach(function () {
          mocks.adb.verify();
        });
        it('should get ' + type.description, function callee$3$0() {
          return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
            while (1) switch (context$4$0.prev = context$4$0.next) {
              case 0:
                if (type.apiLevel) {
                  mocks.adb.expects('getApiLevel').returns(type.apiLevel);
                }
                mocks.adb.expects('shell').withExactArgs(type.args).returns(type.dumpsysData);
                context$4$0.next = 4;
                return _regeneratorRuntime.awrap(runTest(type.cmd, type.keys, type.data));

              case 4:
              case 'end':
                return context$4$0.stop();
            }
          }, null, _this);
        });
        it('should retry if the data is not initially found', function callee$3$0() {
          return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
            while (1) switch (context$4$0.prev = context$4$0.next) {
              case 0:
                if (type.apiLevel) {
                  mocks.adb.expects('getApiLevel').returns(type.apiLevel);
                }
                mocks.adb.expects('shell').twice().withExactArgs(type.args).onCall(0).returns().onCall(1).returns(type.dumpsysData);
                context$4$0.next = 4;
                return _regeneratorRuntime.awrap(runTest(type.cmd, type.keys, type.data));

              case 4:
              case 'end':
                return context$4$0.stop();
            }
          }, null, _this);
        });
        it('should error out if too many failures', function callee$3$0() {
          return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
            while (1) switch (context$4$0.prev = context$4$0.next) {
              case 0:
                mocks.adb.expects('shell').twice().withExactArgs(type.args).onCall(0).returns().onCall(1).returns();
                context$4$0.next = 3;
                return _regeneratorRuntime.awrap(runTest(type.cmd, type.keys, type.data).should.be.rejected);

              case 3:
              case 'end':
                return context$4$0.stop();
            }
          }, null, _this);
        });
      });
    };

    for (var _iterator = _getIterator(types), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      _loop();
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  describe('networkinfo', function () {
    it('should get the network statistics', function () {
      var returnValue = [['bucketStart', 'activeTime', 'rxBytes', 'rxPackets', 'txBytes', 'txPackets', 'operations', 'bucketDuration'], [1478091600000, 1099075, 610947, 928, 114362, 769, 0, 3600000], [1478095200000, 1306300, 405997, 509, 46359, 370, 0, 3600000]];
      mocks.driver.expects('getPerformanceData').withExactArgs('io.appium.android.apis', 'networkinfo', 1000).returns(returnValue);
      var network = driver.getPerformanceData('io.appium.android.apis', 'networkinfo', 1000);
      network.length.should.eql(3);
      var compare = false;

      for (var j = 0; j < _libCommandsPerformanceJs.NETWORK_KEYS.length; ++j) {
        if (_lodash2['default'].isEqual(_libCommandsPerformanceJs.NETWORK_KEYS[j], network[0])) {
          compare = true;
        }
      }

      compare.should.equal(true);

      if (network.length > 1) {
        for (var i = 1; i < network.length; ++i) {
          network[0].length.should.equal(network[i].length);
        }
      }
      mocks.driver.verify();
    });
  });
}));
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9jb21tYW5kcy9wZXJmb3JtYW5jZS1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O29CQUFpQixNQUFNOzs7OzhCQUNJLGtCQUFrQjs7OztpQkFDbkIsVUFBVTs7Ozt3Q0FFVCxzQ0FBc0M7O3NCQUNuRCxRQUFROzs7O2lDQUNJLHFCQUFxQjs7eUJBQy9CLFlBQVk7Ozs7QUFHNUIsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDZCxrQkFBSyxHQUFHLDZCQUFnQixDQUFDOztBQUV6QixJQUFNLFlBQVksR0FBRyx3QkFBd0IsQ0FBQzs7QUFFOUMsSUFBSSxHQUFHLEdBQUcsNEJBQVMsQ0FBQztBQUNwQixJQUFJLE1BQU0sR0FBRyxtQkFBbUIsQ0FBQztBQUNqQyxNQUFNLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQzs7QUFFakIsUUFBUSxDQUFDLG9CQUFvQixFQUFFLGtDQUFVLEVBQUMsR0FBRyxFQUFILEdBQUcsRUFBRSxNQUFNLEVBQU4sTUFBTSxFQUFDLEVBQUUsVUFBQyxLQUFLLEVBQUs7QUFDakUsSUFBRSxDQUFDLDJEQUEyRCxFQUFFLFlBQU07QUFDcEUsUUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLHVCQUF1QixFQUFFLENBQUM7QUFDN0MsU0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsb0JBQUUsSUFBSSw0REFBa0MsQ0FBQyxDQUFDO0dBQzVELENBQUMsQ0FBQzs7QUFFSCxXQUFlLE9BQU8sQ0FBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLFlBQVk7UUFDbEQsSUFBSTs7Ozs7MkNBQVMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFlBQVksRUFBRSxJQUFJLENBQUM7OztBQUExRCxjQUFJOzs7QUFHUixlQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLFFBQUssQ0FBQztBQUNuQyxjQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFD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QUMsRUFBRTtBQUN0QixhQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBQztBQUN0QyxpQkFBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNuRDtPQUNGO0FBQ0QsV0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztLQUN2QixDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMsQ0FBQyIsImZpbGUiOiJ0ZXN0L3VuaXQvY29tbWFuZHMvcGVyZm9ybWFuY2Utc3BlY3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCBBbmRyb2lkRHJpdmVyIGZyb20gJy4uLy4uLy4uJztcbmltcG9ydCB7IFNVUFBPUlRFRF9QRVJGT1JNQU5DRV9EQVRBX1RZUEVTLCBORVRXT1JLX0tFWVMsIENQVV9LRVlTLCBCQVRURVJZX0tFWVMsXG4gICAgICAgICBNRU1PUllfS0VZU30gZnJvbSAnLi4vLi4vLi4vbGliL2NvbW1hbmRzL3BlcmZvcm1hbmNlLmpzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyB3aXRoTW9ja3MgfSBmcm9tICdhcHBpdW0tdGVzdC1zdXBwb3J0JztcbmltcG9ydCBBREIgZnJvbSAnYXBwaXVtLWFkYic7XG5cblxuY2hhaS5zaG91bGQoKTtcbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcblxuY29uc3QgUEFDS0FHRV9OQU1FID0gJ2lvLmFwcGl1bS5hbmRyb2lkLmFwaXMnO1xuXG5sZXQgYWRiID0gbmV3IEFEQigpO1xubGV0IGRyaXZlciA9IG5ldyBBbmRyb2lkRHJpdmVyKCk7XG5kcml2ZXIuYWRiID0gYWRiO1xuXG5kZXNjcmliZSgnZ2V0cGVyZm9ybWFuY2VkYXRhJywgd2l0aE1vY2tzKHthZGIsIGRyaXZlcn0sIChtb2NrcykgPT4ge1xuICBpdCgnc2hvdWxkIGdldCB0aGUgbGlzdCBvZiBhdmFpbGFibGUgZ2V0UGVyZm9ybWFuY2UgZGF0YSB0eXBlJywgKCkgPT4ge1xuICAgIGxldCB0eXBlcyA9IGRyaXZlci5nZXRQZXJmb3JtYW5jZURhdGFUeXBlcygpO1xuICAgIHR5cGVzLnNob3VsZC5lcWwoXy5rZXlzKFNVUFBPUlRFRF9QRVJGT1JNQU5DRV9EQVRBX1RZUEVTKSk7XG4gIH0pO1xuXG4gIGFzeW5jIGZ1bmN0aW9uIHJ1blRlc3QgKHR5cGUsIGV4cGVjdGVkS2V5cywgZXhwZWN0ZWREYXRhKSB7XG4gICAgbGV0IGRhdGEgPSBhd2FpdCBkcml2ZXIuZ2V0UGVyZm9ybWFuY2VEYXRhKFBBQ0tBR0VfTkFNRSwgdHlwZSk7XG5cbiAgICAvLyBtYWtlIHN1cmUgd2UgZ290IHNvbWV0aGluZ1xuICAgIEFycmF5LmlzQXJyYXkoZGF0YSkuc2hvdWxkLmJlLnRydWU7XG4gICAgZGF0YS5sZW5ndGguc2hvdWxkLmVxbCgyKTtcblxuICAgIGRhdGFbMF0uc2hvdWxkLmVxbChleHBlY3RlZEtleXMpO1xuICAgIGRhdGFbMV0uc2hvdWxkLmVxbChleHBlY3RlZERhdGEpO1xuICB9XG5cbiAgbGV0IHR5cGVzID0gW1xuICAgIHtcbiAgICAgIGNtZDogJ2NwdWluZm8nLFxuICAgICAgZGVzY3JpcHRpb246ICd0aGUgYW1vdW50IG9mIGNwdSBieSB1c2VyIGFuZCBrZXJuZWwgcHJvY2VzcycsXG4gICAgICBhcmdzOiBbJ2R1bXBzeXMnLCAnY3B1aW5mbycsICd8JywgJ2dyZXAnLCBgJyR7UEFDS0FHRV9OQU1FfSdgXSxcbiAgICAgIGR1bXBzeXNEYXRhOiBgICswJSAyMjA5L2lvLmFwcGl1bS5hbmRyb2lkLmFwaXM6IDE0JSB1c2VyICsgMjMlIGtlcm5lbGAsXG4gICAgICBrZXlzOiBDUFVfS0VZUyxcbiAgICAgIGRhdGE6IFsnMTQnLCAnMjMnXSxcbiAgICB9LFxuICAgIHtcbiAgICAgIGNtZDogJ21lbW9yeWluZm8nLFxuICAgICAgZGVzY3JpcHRpb246ICd0aGUgYW1vdW50IG9mIG1lbW9yeSB1c2VkIGJ5IHRoZSBwcm9jZXNzIChBUEkgbGV2ZWwgMTkpJyxcbiAgICAgIGFyZ3M6IFsnZHVtcHN5cycsICdtZW1pbmZvJywgYCcke1BBQ0tBR0VfTkFNRX0nYCwgJ3wnLCAnZ3JlcCcsICctRScsIFwiJ05hdGl2ZXxEYWx2aWt8RUdMfEdMfFRPVEFMJ1wiXSxcbiAgICAgIGR1bXBzeXNEYXRhOiBgICBOYXRpdmUgSGVhcCAgICAgMjQ2OSAgICAgMjMzMiAgICAgICAgMCAgICAgICAgMCAgICAyMDQ4MCAgICAxMzkyMCAgICAgNjU1OVxuICAgRGFsdmlrIEhlYXAgICAgICA4NzMgICAgICA4MDggICAgICAgIDAgICAgICAgIDAgICAgIDE1MjYgICAgICA1NzggICAgICA5NDhcbiAgRGFsdmlrIE90aGVyICAgICAgMTQ4ICAgICAgMTQ4ICAgICAgICAwICAgICAgICAwXG4gICAgICAgICBUT1RBTCAgICAgNzc1NyAgICAgNDAxMiAgICAgIDk3NiAgICAgICAgMCAgICAyMjAwNiAgICAxNDQ5OCAgICAgNzUwN2AsXG4gICAgICBrZXlzOiBNRU1PUllfS0VZUyxcbiAgICAgIGRhdGE6IFsnNDAxMicsICcyMzMyJywgJzgwOCcsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICc3NzU3JywgJzI0NjknLCAnODczJywgdW5kZWZpbmVkLCB1bmRlZmluZWQsXG4gICAgICAgICAgICAgJzEzOTIwJywgJzIwNDgwJ10sXG4gICAgICBhcGlMZXZlbDogJzE5JyxcbiAgICB9LFxuICAgIHtcbiAgICAgIGNtZDogJ21lbW9yeWluZm8nLFxuICAgICAgZGVzY3JpcHRpb246ICd0aGUgYW1vdW50IG9mIG1lbW9yeSB1c2VkIGJ5IHRoZSBwcm9jZXNzIChBUEkgbGV2ZWwgMTkpJyxcbiAgICAgIGFyZ3M6IFsnZHVtcHN5cycsICdtZW1pbmZvJywgYCcke1BBQ0tBR0VfTkFNRX0nYCwgJ3wnLCAnZ3JlcCcsICctRScsIFwiJ05hdGl2ZXxEYWx2aWt8RUdMfEdMfFRPVEFMJ1wiXSxcbiAgICAgIGR1bXBzeXNEYXRhOiBgTmF0aXZlfERhbHZpa3xFR0x8R0x8VE9UQUwnXG4gICAgICAgTmF0aXZlICAgICAxMDUwICAgICAxMjM2ICAgICAgOTY4ICAgICA3NTgwICAgICA3NDI4ICAgICAgIDMxXG4gICAgICAgRGFsdmlrICAgICAyNjM3ICAgICA1NTkyICAgICAyMjg4ICAgICAzOTYwICAgICAzNDUzICAgICAgNTA3XG4gICAgICAgIFRPVEFMICAgICA2Nzk2ICAgIDExNjg4ICAgICA0Mjg4ICAgIDExNTQwICAgIDEwODgxICAgICAgNTM4YCxcbiAgICAgIGtleXM6IE1FTU9SWV9LRVlTLFxuICAgICAgZGF0YTogWyc0Mjg4JywgJzk2OCcsICcyMjg4JywgdW5kZWZpbmVkLCB1bmRlZmluZWQsXG4gICAgICAgICAgICAgJzY3OTYnLCAnMTA1MCcsICcyNjM3JywgdW5kZWZpbmVkLCB1bmRlZmluZWQsXG4gICAgICAgICAgICAgJzc0MjgnLCAnNzU4MCddLFxuICAgICAgYXBpTGV2ZWw6ICcxOCcsXG4gICAgfSxcbiAgICB7XG4gICAgICBjbWQ6ICdiYXR0ZXJ5aW5mbycsXG4gICAgICBkZXNjcmlwdGlvbjogJ3RoZSByZW1haW5pbmcgYmF0dGVyeSBwb3dlcicsXG4gICAgICBhcmdzOiBbJ2R1bXBzeXMnLCAnYmF0dGVyeScsICd8JywgJ2dyZXAnLCAnbGV2ZWwnXSxcbiAgICAgIGR1bXBzeXNEYXRhOiAnICBsZXZlbDogNDcnLFxuICAgICAga2V5czogQkFUVEVSWV9LRVlTLFxuICAgICAgZGF0YTogWyc0NyddLFxuICAgIH0sXG4gIF07XG4gIGZvciAobGV0IHR5cGUgb2YgdHlwZXMpIHtcbiAgICBkZXNjcmliZSh0eXBlLmNtZCwgKCkgPT4ge1xuICAgICAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICAgICAgbW9ja3MuYWRiLnZlcmlmeSgpO1xuICAgICAgfSk7XG4gICAgICBpdChgc2hvdWxkIGdldCAke3R5cGUuZGVzY3JpcHRpb259YCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAodHlwZS5hcGlMZXZlbCkge1xuICAgICAgICAgIG1vY2tzLmFkYlxuICAgICAgICAgICAgLmV4cGVjdHMoJ2dldEFwaUxldmVsJylcbiAgICAgICAgICAgIC5yZXR1cm5zKHR5cGUuYXBpTGV2ZWwpO1xuICAgICAgICB9XG4gICAgICAgIG1vY2tzLmFkYlxuICAgICAgICAgIC5leHBlY3RzKCdzaGVsbCcpXG4gICAgICAgICAgLndpdGhFeGFjdEFyZ3ModHlwZS5hcmdzKVxuICAgICAgICAgIC5yZXR1cm5zKHR5cGUuZHVtcHN5c0RhdGEpO1xuICAgICAgICBhd2FpdCBydW5UZXN0KHR5cGUuY21kLCB0eXBlLmtleXMsIHR5cGUuZGF0YSk7XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgcmV0cnkgaWYgdGhlIGRhdGEgaXMgbm90IGluaXRpYWxseSBmb3VuZCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgaWYgKHR5cGUuYXBpTGV2ZWwpIHtcbiAgICAgICAgICBtb2Nrcy5hZGJcbiAgICAgICAgICAgIC5leHBlY3RzKCdnZXRBcGlMZXZlbCcpXG4gICAgICAgICAgICAucmV0dXJucyh0eXBlLmFwaUxldmVsKTtcbiAgICAgICAgfVxuICAgICAgICBtb2Nrcy5hZGJcbiAgICAgICAgICAuZXhwZWN0cygnc2hlbGwnKVxuICAgICAgICAgIC50d2ljZSgpXG4gICAgICAgICAgLndpdGhFeGFjdEFyZ3ModHlwZS5hcmdzKVxuICAgICAgICAgIC5vbkNhbGwoMClcbiAgICAgICAgICAgIC5yZXR1cm5zKClcbiAgICAgICAgICAub25DYWxsKDEpXG4gICAgICAgICAgICAucmV0dXJucyh0eXBlLmR1bXBzeXNEYXRhKTtcbiAgICAgICAgYXdhaXQgcnVuVGVzdCh0eXBlLmNtZCwgdHlwZS5rZXlzLCB0eXBlLmRhdGEpO1xuICAgICAgfSk7XG4gICAgICBpdCgnc2hvdWxkIGVycm9yIG91dCBpZiB0b28gbWFueSBmYWlsdXJlcycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgbW9ja3MuYWRiXG4gICAgICAgICAgLmV4cGVjdHMoJ3NoZWxsJylcbiAgICAgICAgICAudHdpY2UoKVxuICAgICAgICAgIC53aXRoRXhhY3RBcmdzKHR5cGUuYXJncylcbiAgICAgICAgICAub25DYWxsKDApXG4gICAgICAgICAgICAucmV0dXJucygpXG4gICAgICAgICAgLm9uQ2FsbCgxKVxuICAgICAgICAgICAgLnJldHVybnMoKTtcbiAgICAgICAgYXdhaXQgcnVuVGVzdCh0eXBlLmNtZCwgdHlwZS5rZXlzLCB0eXBlLmRhdGEpLnNob3VsZC5iZS5yZWplY3RlZDtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgZGVzY3JpYmUoJ25ldHdvcmtpbmZvJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZ2V0IHRoZSBuZXR3b3JrIHN0YXRpc3RpY3MnLCAoKSA9PiB7XG4gICAgICBsZXQgcmV0dXJuVmFsdWUgPSBbXG4gICAgICAgIFsnYnVja2V0U3RhcnQnLCAnYWN0aXZlVGltZScsICdyeEJ5dGVzJywgJ3J4UGFja2V0cycsICd0eEJ5dGVzJywgJ3R4UGFja2V0cycsICdvcGVyYXRpb25zJywgJ2J1Y2tldER1cmF0aW9uJ10sXG4gICAgICAgIFsxNDc4MDkxNjAwMDAwLCAxMDk5MDc1LCA2MTA5NDcsIDkyOCwgMTE0MzYyLCA3NjksIDAsIDM2MDAwMDBdLFxuICAgICAgICBbMTQ3ODA5NTIwMDAwMCwgMTMwNjMwMCwgNDA1OTk3LCA1MDksIDQ2MzU5LCAzNzAsIDAsIDM2MDAwMDBdLFxuICAgICAgXTtcbiAgICAgIG1vY2tzLmRyaXZlci5leHBlY3RzKCdnZXRQZXJmb3JtYW5jZURhdGEnKS53aXRoRXhhY3RBcmdzKCdpby5hcHBpdW0uYW5kcm9pZC5hcGlzJywgJ25ldHdvcmtpbmZvJywgMTAwMCkucmV0dXJucyhyZXR1cm5WYWx1ZSk7XG4gICAgICBsZXQgbmV0d29yayA9IGRyaXZlci5nZXRQZXJmb3JtYW5jZURhdGEoJ2lvLmFwcGl1bS5hbmRyb2lkLmFwaXMnLCAnbmV0d29ya2luZm8nLCAxMDAwKTtcbiAgICAgIG5ldHdvcmsubGVuZ3RoLnNob3VsZC5lcWwoMyk7XG4gICAgICBsZXQgY29tcGFyZSA9IGZhbHNlO1xuXG4gICAgICBmb3IgKCBsZXQgaj0gMCA7IGogPCBORVRXT1JLX0tFWVMubGVuZ3RoIDsgKysgail7XG4gICAgICAgIGlmIChfLmlzRXF1YWwoIE5FVFdPUktfS0VZU1tqXSwgbmV0d29ya1swXSkpe1xuICAgICAgICAgIGNvbXBhcmUgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNvbXBhcmUuc2hvdWxkLmVxdWFsKHRydWUpO1xuXG4gICAgICBpZiAobmV0d29yay5sZW5ndGggPiAxKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbmV0d29yay5sZW5ndGg7ICsraSl7XG4gICAgICAgICAgbmV0d29ya1swXS5sZW5ndGguc2hvdWxkLmVxdWFsKG5ldHdvcmtbaV0ubGVuZ3RoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgbW9ja3MuZHJpdmVyLnZlcmlmeSgpO1xuICAgIH0pO1xuICB9KTtcbn0pKTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4ifQ==
