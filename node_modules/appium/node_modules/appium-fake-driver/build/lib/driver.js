'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumBaseDriver = require('appium-base-driver');

var _fakeApp = require('./fake-app');

var _commands = require('./commands');

var _commands2 = _interopRequireDefault(_commands);

var FakeDriver = (function (_BaseDriver) {
  _inherits(FakeDriver, _BaseDriver);

  function FakeDriver() {
    _classCallCheck(this, FakeDriver);

    _get(Object.getPrototypeOf(FakeDriver.prototype), 'constructor', this).call(this);
    this.appModel = null;
    this.curContext = 'NATIVE_APP';
    this.elMap = {};
    this.focusedElId = null;
    this.maxElId = 0;
    this.caps = {};

    this.desiredCapConstraints = {
      app: {
        presence: true,
        isString: true
      }
    };
  }

  _createClass(FakeDriver, [{
    key: 'createSession',
    value: function createSession(caps, reqCaps) {
      var otherSessionData = arguments.length <= 2 || arguments[2] === undefined ? [] : arguments[2];

      var _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, d, _ref, _ref2, sessionId;

      return _regeneratorRuntime.async(function createSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            context$2$0.prev = 3;
            _iterator = _getIterator(otherSessionData);

          case 5:
            if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
              context$2$0.next = 12;
              break;
            }

            d = _step.value;

            if (!d.isUnique) {
              context$2$0.next = 9;
              break;
            }

            throw new _appiumBaseDriver.errors.SessionNotCreatedError("Cannot start session; another " + "unique session is in progress that requires all resources");

          case 9:
            _iteratorNormalCompletion = true;
            context$2$0.next = 5;
            break;

          case 12:
            context$2$0.next = 18;
            break;

          case 14:
            context$2$0.prev = 14;
            context$2$0.t0 = context$2$0['catch'](3);
            _didIteratorError = true;
            _iteratorError = context$2$0.t0;

          case 18:
            context$2$0.prev = 18;
            context$2$0.prev = 19;

            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }

          case 21:
            context$2$0.prev = 21;

            if (!_didIteratorError) {
              context$2$0.next = 24;
              break;
            }

            throw _iteratorError;

          case 24:
            return context$2$0.finish(21);

          case 25:
            return context$2$0.finish(18);

          case 26:
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(FakeDriver.prototype), 'createSession', this).call(this, caps, reqCaps));

          case 28:
            _ref = context$2$0.sent;
            _ref2 = _slicedToArray(_ref, 1);
            sessionId = _ref2[0];

            this.appModel = new _fakeApp.FakeApp();
            context$2$0.next = 34;
            return _regeneratorRuntime.awrap(this.appModel.loadApp(caps.app));

          case 34:
            this.caps = caps;
            return context$2$0.abrupt('return', [sessionId, caps]);

          case 36:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[3, 14, 18, 26], [19,, 21, 25]]);
    }
  }, {
    key: 'driverData',
    get: function get() {
      return {
        isUnique: !!this.caps.uniqueApp
      };
    }
  }]);

  return FakeDriver;
})(_appiumBaseDriver.BaseDriver);

var _iteratorNormalCompletion2 = true;
var _didIteratorError2 = false;
var _iteratorError2 = undefined;

try {

  for (var _iterator2 = _getIterator(_lodash2['default'].pairs(_commands2['default'])), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
    var _step2$value = _slicedToArray(_step2.value, 2);

    var cmd = _step2$value[0];
    var fn = _step2$value[1];

    FakeDriver.prototype[cmd] = fn;
  }
} catch (err) {
  _didIteratorError2 = true;
  _iteratorError2 = err;
} finally {
  try {
    if (!_iteratorNormalCompletion2 && _iterator2['return']) {
      _iterator2['return']();
    }
  } finally {
    if (_didIteratorError2) {
      throw _iteratorError2;
    }
  }
}

exports.FakeDriver = FakeDriver;

// TODO add validation on caps.app that we will get for free from
// BaseDriver

// check to see if any other sessions have set uniqueApp. If so, emulate
// not being able to start a session because of system resources
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztzQkFBYyxRQUFROzs7O2dDQUNhLG9CQUFvQjs7dUJBQy9CLFlBQVk7O3dCQUNmLFlBQVk7Ozs7SUFFM0IsVUFBVTtZQUFWLFVBQVU7O0FBRUYsV0FGUixVQUFVLEdBRUM7MEJBRlgsVUFBVTs7QUFHWiwrQkFIRSxVQUFVLDZDQUdKO0FBQ1IsUUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7QUFDckIsUUFBSSxDQUFDLFVBQVUsR0FBRyxZQUFZLENBQUM7QUFDL0IsUUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7QUFDaEIsUUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7QUFDeEIsUUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUM7QUFDakIsUUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7O0FBRWYsUUFBSSxDQUFDLHFCQUFxQixHQUFHO0FBQzNCLFNBQUcsRUFBRTtBQUNILGdCQUFRLEVBQUUsSUFBSTtBQUNkLGdCQUFRLEVBQUUsSUFBSTtPQUNmO0tBQ0YsQ0FBQztHQUNIOztlQWpCRyxVQUFVOztXQW1CTSx1QkFBQyxJQUFJLEVBQUUsT0FBTztVQUFFLGdCQUFnQix5REFBRyxFQUFFOzswRkFNOUMsQ0FBQyxlQU9MLFNBQVM7Ozs7Ozs7OztxQ0FQQSxnQkFBZ0I7Ozs7Ozs7O0FBQXJCLGFBQUM7O2lCQUNKLENBQUMsQ0FBQyxRQUFROzs7OztrQkFDTixJQUFJLHlCQUFPLHNCQUFzQixDQUFDLGdDQUFnQyxHQUNwRSwyREFBMkQsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozt3RUE1QmxFLFVBQVUsK0NBZ0NnQyxJQUFJLEVBQUUsT0FBTzs7Ozs7QUFBcEQscUJBQVM7O0FBQ2QsZ0JBQUksQ0FBQyxRQUFRLEdBQUcsc0JBQWEsQ0FBQzs7NkNBQ3hCLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7OztBQUNyQyxnQkFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7Z0RBQ1YsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDOzs7Ozs7O0tBQ3pCOzs7U0FFYyxlQUFHO0FBQ2hCLGFBQU87QUFDTCxnQkFBUSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVM7T0FDaEMsQ0FBQztLQUNIOzs7U0EzQ0csVUFBVTs7Ozs7Ozs7O0FBOENoQixxQ0FBc0Isb0JBQUUsS0FBSyx1QkFBVSxpSEFBRTs7O1FBQS9CLEdBQUc7UUFBRSxFQUFFOztBQUNmLGNBQVUsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0dBQ2hDOzs7Ozs7Ozs7Ozs7Ozs7O1FBRVEsVUFBVSxHQUFWLFVBQVUiLCJmaWxlIjoibGliL2RyaXZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBCYXNlRHJpdmVyLCBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgRmFrZUFwcCB9IGZyb20gJy4vZmFrZS1hcHAnO1xuaW1wb3J0IGNvbW1hbmRzIGZyb20gJy4vY29tbWFuZHMnO1xuXG5jbGFzcyBGYWtlRHJpdmVyIGV4dGVuZHMgQmFzZURyaXZlciB7XG5cbiAgY29uc3RydWN0b3IgKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5hcHBNb2RlbCA9IG51bGw7XG4gICAgdGhpcy5jdXJDb250ZXh0ID0gJ05BVElWRV9BUFAnO1xuICAgIHRoaXMuZWxNYXAgPSB7fTtcbiAgICB0aGlzLmZvY3VzZWRFbElkID0gbnVsbDtcbiAgICB0aGlzLm1heEVsSWQgPSAwO1xuICAgIHRoaXMuY2FwcyA9IHt9O1xuXG4gICAgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMgPSB7XG4gICAgICBhcHA6IHtcbiAgICAgICAgcHJlc2VuY2U6IHRydWUsXG4gICAgICAgIGlzU3RyaW5nOiB0cnVlXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNlc3Npb24gKGNhcHMsIHJlcUNhcHMsIG90aGVyU2Vzc2lvbkRhdGEgPSBbXSkge1xuICAgIC8vIFRPRE8gYWRkIHZhbGlkYXRpb24gb24gY2Fwcy5hcHAgdGhhdCB3ZSB3aWxsIGdldCBmb3IgZnJlZSBmcm9tXG4gICAgLy8gQmFzZURyaXZlclxuXG4gICAgLy8gY2hlY2sgdG8gc2VlIGlmIGFueSBvdGhlciBzZXNzaW9ucyBoYXZlIHNldCB1bmlxdWVBcHAuIElmIHNvLCBlbXVsYXRlXG4gICAgLy8gbm90IGJlaW5nIGFibGUgdG8gc3RhcnQgYSBzZXNzaW9uIGJlY2F1c2Ugb2Ygc3lzdGVtIHJlc291cmNlc1xuICAgIGZvciAobGV0IGQgb2Ygb3RoZXJTZXNzaW9uRGF0YSkge1xuICAgICAgaWYgKGQuaXNVbmlxdWUpIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5TZXNzaW9uTm90Q3JlYXRlZEVycm9yKFwiQ2Fubm90IHN0YXJ0IHNlc3Npb247IGFub3RoZXIgXCIgK1xuICAgICAgICAgICAgXCJ1bmlxdWUgc2Vzc2lvbiBpcyBpbiBwcm9ncmVzcyB0aGF0IHJlcXVpcmVzIGFsbCByZXNvdXJjZXNcIik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IFtzZXNzaW9uSWRdID0gYXdhaXQgc3VwZXIuY3JlYXRlU2Vzc2lvbihjYXBzLCByZXFDYXBzKTtcbiAgICB0aGlzLmFwcE1vZGVsID0gbmV3IEZha2VBcHAoKTtcbiAgICBhd2FpdCB0aGlzLmFwcE1vZGVsLmxvYWRBcHAoY2Fwcy5hcHApO1xuICAgIHRoaXMuY2FwcyA9IGNhcHM7XG4gICAgcmV0dXJuIFtzZXNzaW9uSWQsIGNhcHNdO1xuICB9XG5cbiAgZ2V0IGRyaXZlckRhdGEgKCkge1xuICAgIHJldHVybiB7XG4gICAgICBpc1VuaXF1ZTogISF0aGlzLmNhcHMudW5pcXVlQXBwXG4gICAgfTtcbiAgfVxufVxuXG5mb3IgKGxldCBbY21kLCBmbl0gb2YgXy5wYWlycyhjb21tYW5kcykpIHtcbiAgRmFrZURyaXZlci5wcm90b3R5cGVbY21kXSA9IGZuO1xufVxuXG5leHBvcnQgeyBGYWtlRHJpdmVyIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
